<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="GPU-accelerated 2D/3D MERFISH data processing"><meta name=author content="Quantitative Imaging and Inference Lab"><link href=https://qi2lab.github.io/merfish3d-analysis/reference/classes/qi2labDataStore/ rel=canonical><link href=../PixelDecoder/ rel=prev><link href=../../modules/dataio/ rel=next><link rel=icon href=../../../assets/images/favicon.png><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.5.49"><title>qi2labDataStore - merfish3d-analysis</title><link rel=stylesheet href=../../../assets/stylesheets/main.6f8fc17f.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../../assets/_mkdocstrings.css><script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#datastore-class class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--shadow" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../../.. title=merfish3d-analysis class="md-header__button md-logo" aria-label=merfish3d-analysis data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> merfish3d-analysis </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> qi2labDataStore </span> </div> </div> </div> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../.. title=merfish3d-analysis class="md-nav__button md-logo" aria-label=merfish3d-analysis data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg> </a> merfish3d-analysis </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../.. class=md-nav__link> <span class=md-ellipsis> Home </span> </a> </li> <li class=md-nav__item> <a href=../../../installation/ class=md-nav__link> <span class=md-ellipsis> Installation </span> </a> </li> <li class=md-nav__item> <a href=../../../datastore/ class=md-nav__link> <span class=md-ellipsis> DataStore </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4> <label class=md-nav__link for=__nav_4 id=__nav_4_label tabindex=0> <span class=md-ellipsis> Examples </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=false> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Examples </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../examples/statphysbio_synthetic/ class=md-nav__link> <span class=md-ellipsis> Synthetic data </span> </a> </li> <li class=md-nav__item> <a href=../../../examples/zhuang_lab_mouse_brain/ class=md-nav__link> <span class=md-ellipsis> Zhuang laboratory mouse brain </span> </a> </li> <li class=md-nav__item> <a href=../../../examples/qi2lab_human_olfactory_bulb/ class=md-nav__link> <span class=md-ellipsis> qi2lab human olfactory bulb </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5 checked> <label class=md-nav__link for=__nav_5 id=__nav_5_label tabindex=0> <span class=md-ellipsis> Reference </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_5_label aria-expanded=true> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> Reference </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../ class=md-nav__link> <span class=md-ellipsis> Overview </span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5_2 checked> <label class=md-nav__link for=__nav_5_2 id=__nav_5_2_label tabindex=0> <span class=md-ellipsis> Classes </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_2_label aria-expanded=true> <label class=md-nav__title for=__nav_5_2> <span class="md-nav__icon md-icon"></span> Classes </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../DataRegistration/ class=md-nav__link> <span class=md-ellipsis> DataRegistration </span> </a> </li> <li class=md-nav__item> <a href=../PixelDecoder/ class=md-nav__link> <span class=md-ellipsis> PixelDecoder </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> qi2labDataStore </span> <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> qi2labDataStore </span> </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore class=md-nav__link> <span class=md-ellipsis> qi2labDataStore </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore class=md-nav__link> <span class=md-ellipsis> qi2labDataStore </span> </a> <nav class=md-nav aria-label=qi2labDataStore> <ul class=md-nav__list> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.baysor_options class=md-nav__link> <span class=md-ellipsis> baysor_options </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.baysor_path class=md-nav__link> <span class=md-ellipsis> baysor_path </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.binning class=md-nav__link> <span class=md-ellipsis> binning </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.bit_ids class=md-nav__link> <span class=md-ellipsis> bit_ids </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.camera_model class=md-nav__link> <span class=md-ellipsis> camera_model </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.channel_psfs class=md-nav__link> <span class=md-ellipsis> channel_psfs </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.channel_shading_maps class=md-nav__link> <span class=md-ellipsis> channel_shading_maps </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.channels_in_data class=md-nav__link> <span class=md-ellipsis> channels_in_data </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.codebook class=md-nav__link> <span class=md-ellipsis> codebook </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.datastore_state class=md-nav__link> <span class=md-ellipsis> datastore_state </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.e_per_ADU class=md-nav__link> <span class=md-ellipsis> e_per_ADU </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.experiment_order class=md-nav__link> <span class=md-ellipsis> experiment_order </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.global_background_vector class=md-nav__link> <span class=md-ellipsis> global_background_vector </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.global_normalization_vector class=md-nav__link> <span class=md-ellipsis> global_normalization_vector </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.iterative_background_vector class=md-nav__link> <span class=md-ellipsis> iterative_background_vector </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.iterative_normalization_vector class=md-nav__link> <span class=md-ellipsis> iterative_normalization_vector </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.julia_threads class=md-nav__link> <span class=md-ellipsis> julia_threads </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.microscope_type class=md-nav__link> <span class=md-ellipsis> microscope_type </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.na class=md-nav__link> <span class=md-ellipsis> na </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.noise_map class=md-nav__link> <span class=md-ellipsis> noise_map </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.num_bits class=md-nav__link> <span class=md-ellipsis> num_bits </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.num_rounds class=md-nav__link> <span class=md-ellipsis> num_rounds </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.num_tiles class=md-nav__link> <span class=md-ellipsis> num_tiles </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.ri class=md-nav__link> <span class=md-ellipsis> ri </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.round_ids class=md-nav__link> <span class=md-ellipsis> round_ids </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.tile_ids class=md-nav__link> <span class=md-ellipsis> tile_ids </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.tile_overlap class=md-nav__link> <span class=md-ellipsis> tile_overlap </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.voxel_size_zyx_um class=md-nav__link> <span class=md-ellipsis> voxel_size_zyx_um </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore._check_for_zarr_array class=md-nav__link> <span class=md-ellipsis> _check_for_zarr_array </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore._get_kvstore_key class=md-nav__link> <span class=md-ellipsis> _get_kvstore_key </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore._init_datastore class=md-nav__link> <span class=md-ellipsis> _init_datastore </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore._load_from_json class=md-nav__link> <span class=md-ellipsis> _load_from_json </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore._load_from_microjson class=md-nav__link> <span class=md-ellipsis> _load_from_microjson </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore._load_from_parquet class=md-nav__link> <span class=md-ellipsis> _load_from_parquet </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore._load_from_zarr_array class=md-nav__link> <span class=md-ellipsis> _load_from_zarr_array </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore._parse_datastore class=md-nav__link> <span class=md-ellipsis> _parse_datastore </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore._save_to_json class=md-nav__link> <span class=md-ellipsis> _save_to_json </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore._save_to_parquet class=md-nav__link> <span class=md-ellipsis> _save_to_parquet </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore._save_to_zarr_array class=md-nav__link> <span class=md-ellipsis> _save_to_zarr_array </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.initialize_tile class=md-nav__link> <span class=md-ellipsis> initialize_tile </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.load_codebook_parsed class=md-nav__link> <span class=md-ellipsis> load_codebook_parsed </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.load_coord_of_xform_px class=md-nav__link> <span class=md-ellipsis> load_coord_of_xform_px </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.load_global_baysor_filtered_spots class=md-nav__link> <span class=md-ellipsis> load_global_baysor_filtered_spots </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.load_global_baysor_outlines class=md-nav__link> <span class=md-ellipsis> load_global_baysor_outlines </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.load_global_cellpose_outlines class=md-nav__link> <span class=md-ellipsis> load_global_cellpose_outlines </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.load_global_cellpose_segmentation_image class=md-nav__link> <span class=md-ellipsis> load_global_cellpose_segmentation_image </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.load_global_coord_xforms_um class=md-nav__link> <span class=md-ellipsis> load_global_coord_xforms_um </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.load_global_fidicual_image class=md-nav__link> <span class=md-ellipsis> load_global_fidicual_image </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.load_global_filtered_decoded_spots class=md-nav__link> <span class=md-ellipsis> load_global_filtered_decoded_spots </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.load_local_bit_linker class=md-nav__link> <span class=md-ellipsis> load_local_bit_linker </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.load_local_corrected_image class=md-nav__link> <span class=md-ellipsis> load_local_corrected_image </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.load_local_decoded_spots class=md-nav__link> <span class=md-ellipsis> load_local_decoded_spots </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.load_local_registered_image class=md-nav__link> <span class=md-ellipsis> load_local_registered_image </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.load_local_rigid_xform_xyz_px class=md-nav__link> <span class=md-ellipsis> load_local_rigid_xform_xyz_px </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.load_local_round_linker class=md-nav__link> <span class=md-ellipsis> load_local_round_linker </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.load_local_stage_position_zyx_um class=md-nav__link> <span class=md-ellipsis> load_local_stage_position_zyx_um </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.load_local_ufish_image class=md-nav__link> <span class=md-ellipsis> load_local_ufish_image </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.load_local_ufish_spots class=md-nav__link> <span class=md-ellipsis> load_local_ufish_spots </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.load_local_wavelengths_um class=md-nav__link> <span class=md-ellipsis> load_local_wavelengths_um </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.reformat_baysor_3D_oultines class=md-nav__link> <span class=md-ellipsis> reformat_baysor_3D_oultines </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.reprocess_and_save_filtered_spots_with_baysor_outlines class=md-nav__link> <span class=md-ellipsis> reprocess_and_save_filtered_spots_with_baysor_outlines </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.run_baysor class=md-nav__link> <span class=md-ellipsis> run_baysor </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.save_coord_of_xform_px class=md-nav__link> <span class=md-ellipsis> save_coord_of_xform_px </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.save_global_cellpose_segmentation_image class=md-nav__link> <span class=md-ellipsis> save_global_cellpose_segmentation_image </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.save_global_coord_xforms_um class=md-nav__link> <span class=md-ellipsis> save_global_coord_xforms_um </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.save_global_fidicual_image class=md-nav__link> <span class=md-ellipsis> save_global_fidicual_image </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.save_global_filtered_decoded_spots class=md-nav__link> <span class=md-ellipsis> save_global_filtered_decoded_spots </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.save_local_bit_linker class=md-nav__link> <span class=md-ellipsis> save_local_bit_linker </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.save_local_corrected_image class=md-nav__link> <span class=md-ellipsis> save_local_corrected_image </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.save_local_decoded_spots class=md-nav__link> <span class=md-ellipsis> save_local_decoded_spots </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.save_local_registered_image class=md-nav__link> <span class=md-ellipsis> save_local_registered_image </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.save_local_rigid_xform_xyz_px class=md-nav__link> <span class=md-ellipsis> save_local_rigid_xform_xyz_px </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.save_local_round_linker class=md-nav__link> <span class=md-ellipsis> save_local_round_linker </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.save_local_stage_position_zyx_um class=md-nav__link> <span class=md-ellipsis> save_local_stage_position_zyx_um </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.save_local_ufish_image class=md-nav__link> <span class=md-ellipsis> save_local_ufish_image </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.save_local_ufish_spots class=md-nav__link> <span class=md-ellipsis> save_local_ufish_spots </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.save_local_wavelengths_um class=md-nav__link> <span class=md-ellipsis> save_local_wavelengths_um </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.save_mtx class=md-nav__link> <span class=md-ellipsis> save_mtx </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.save_spots_prepped_for_baysor class=md-nav__link> <span class=md-ellipsis> save_spots_prepped_for_baysor </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5_3> <label class=md-nav__link for=__nav_5_3 id=__nav_5_3_label tabindex=0> <span class=md-ellipsis> Modules </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_3_label aria-expanded=false> <label class=md-nav__title for=__nav_5_3> <span class="md-nav__icon md-icon"></span> Modules </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../modules/dataio/ class=md-nav__link> <span class=md-ellipsis> dataio </span> </a> </li> <li class=md-nav__item> <a href=../../modules/imageprocessing/ class=md-nav__link> <span class=md-ellipsis> imageprocessing </span> </a> </li> <li class=md-nav__item> <a href=../../modules/registration/ class=md-nav__link> <span class=md-ellipsis> registration </span> </a> </li> <li class=md-nav__item> <a href=../../modules/opmtools/ class=md-nav__link> <span class=md-ellipsis> opmtools </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../../contributing/ class=md-nav__link> <span class=md-ellipsis> Contributing </span> </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore class=md-nav__link> <span class=md-ellipsis> qi2labDataStore </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore class=md-nav__link> <span class=md-ellipsis> qi2labDataStore </span> </a> <nav class=md-nav aria-label=qi2labDataStore> <ul class=md-nav__list> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.baysor_options class=md-nav__link> <span class=md-ellipsis> baysor_options </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.baysor_path class=md-nav__link> <span class=md-ellipsis> baysor_path </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.binning class=md-nav__link> <span class=md-ellipsis> binning </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.bit_ids class=md-nav__link> <span class=md-ellipsis> bit_ids </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.camera_model class=md-nav__link> <span class=md-ellipsis> camera_model </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.channel_psfs class=md-nav__link> <span class=md-ellipsis> channel_psfs </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.channel_shading_maps class=md-nav__link> <span class=md-ellipsis> channel_shading_maps </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.channels_in_data class=md-nav__link> <span class=md-ellipsis> channels_in_data </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.codebook class=md-nav__link> <span class=md-ellipsis> codebook </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.datastore_state class=md-nav__link> <span class=md-ellipsis> datastore_state </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.e_per_ADU class=md-nav__link> <span class=md-ellipsis> e_per_ADU </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.experiment_order class=md-nav__link> <span class=md-ellipsis> experiment_order </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.global_background_vector class=md-nav__link> <span class=md-ellipsis> global_background_vector </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.global_normalization_vector class=md-nav__link> <span class=md-ellipsis> global_normalization_vector </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.iterative_background_vector class=md-nav__link> <span class=md-ellipsis> iterative_background_vector </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.iterative_normalization_vector class=md-nav__link> <span class=md-ellipsis> iterative_normalization_vector </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.julia_threads class=md-nav__link> <span class=md-ellipsis> julia_threads </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.microscope_type class=md-nav__link> <span class=md-ellipsis> microscope_type </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.na class=md-nav__link> <span class=md-ellipsis> na </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.noise_map class=md-nav__link> <span class=md-ellipsis> noise_map </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.num_bits class=md-nav__link> <span class=md-ellipsis> num_bits </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.num_rounds class=md-nav__link> <span class=md-ellipsis> num_rounds </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.num_tiles class=md-nav__link> <span class=md-ellipsis> num_tiles </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.ri class=md-nav__link> <span class=md-ellipsis> ri </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.round_ids class=md-nav__link> <span class=md-ellipsis> round_ids </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.tile_ids class=md-nav__link> <span class=md-ellipsis> tile_ids </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.tile_overlap class=md-nav__link> <span class=md-ellipsis> tile_overlap </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.voxel_size_zyx_um class=md-nav__link> <span class=md-ellipsis> voxel_size_zyx_um </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore._check_for_zarr_array class=md-nav__link> <span class=md-ellipsis> _check_for_zarr_array </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore._get_kvstore_key class=md-nav__link> <span class=md-ellipsis> _get_kvstore_key </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore._init_datastore class=md-nav__link> <span class=md-ellipsis> _init_datastore </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore._load_from_json class=md-nav__link> <span class=md-ellipsis> _load_from_json </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore._load_from_microjson class=md-nav__link> <span class=md-ellipsis> _load_from_microjson </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore._load_from_parquet class=md-nav__link> <span class=md-ellipsis> _load_from_parquet </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore._load_from_zarr_array class=md-nav__link> <span class=md-ellipsis> _load_from_zarr_array </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore._parse_datastore class=md-nav__link> <span class=md-ellipsis> _parse_datastore </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore._save_to_json class=md-nav__link> <span class=md-ellipsis> _save_to_json </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore._save_to_parquet class=md-nav__link> <span class=md-ellipsis> _save_to_parquet </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore._save_to_zarr_array class=md-nav__link> <span class=md-ellipsis> _save_to_zarr_array </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.initialize_tile class=md-nav__link> <span class=md-ellipsis> initialize_tile </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.load_codebook_parsed class=md-nav__link> <span class=md-ellipsis> load_codebook_parsed </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.load_coord_of_xform_px class=md-nav__link> <span class=md-ellipsis> load_coord_of_xform_px </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.load_global_baysor_filtered_spots class=md-nav__link> <span class=md-ellipsis> load_global_baysor_filtered_spots </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.load_global_baysor_outlines class=md-nav__link> <span class=md-ellipsis> load_global_baysor_outlines </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.load_global_cellpose_outlines class=md-nav__link> <span class=md-ellipsis> load_global_cellpose_outlines </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.load_global_cellpose_segmentation_image class=md-nav__link> <span class=md-ellipsis> load_global_cellpose_segmentation_image </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.load_global_coord_xforms_um class=md-nav__link> <span class=md-ellipsis> load_global_coord_xforms_um </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.load_global_fidicual_image class=md-nav__link> <span class=md-ellipsis> load_global_fidicual_image </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.load_global_filtered_decoded_spots class=md-nav__link> <span class=md-ellipsis> load_global_filtered_decoded_spots </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.load_local_bit_linker class=md-nav__link> <span class=md-ellipsis> load_local_bit_linker </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.load_local_corrected_image class=md-nav__link> <span class=md-ellipsis> load_local_corrected_image </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.load_local_decoded_spots class=md-nav__link> <span class=md-ellipsis> load_local_decoded_spots </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.load_local_registered_image class=md-nav__link> <span class=md-ellipsis> load_local_registered_image </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.load_local_rigid_xform_xyz_px class=md-nav__link> <span class=md-ellipsis> load_local_rigid_xform_xyz_px </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.load_local_round_linker class=md-nav__link> <span class=md-ellipsis> load_local_round_linker </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.load_local_stage_position_zyx_um class=md-nav__link> <span class=md-ellipsis> load_local_stage_position_zyx_um </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.load_local_ufish_image class=md-nav__link> <span class=md-ellipsis> load_local_ufish_image </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.load_local_ufish_spots class=md-nav__link> <span class=md-ellipsis> load_local_ufish_spots </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.load_local_wavelengths_um class=md-nav__link> <span class=md-ellipsis> load_local_wavelengths_um </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.reformat_baysor_3D_oultines class=md-nav__link> <span class=md-ellipsis> reformat_baysor_3D_oultines </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.reprocess_and_save_filtered_spots_with_baysor_outlines class=md-nav__link> <span class=md-ellipsis> reprocess_and_save_filtered_spots_with_baysor_outlines </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.run_baysor class=md-nav__link> <span class=md-ellipsis> run_baysor </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.save_coord_of_xform_px class=md-nav__link> <span class=md-ellipsis> save_coord_of_xform_px </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.save_global_cellpose_segmentation_image class=md-nav__link> <span class=md-ellipsis> save_global_cellpose_segmentation_image </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.save_global_coord_xforms_um class=md-nav__link> <span class=md-ellipsis> save_global_coord_xforms_um </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.save_global_fidicual_image class=md-nav__link> <span class=md-ellipsis> save_global_fidicual_image </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.save_global_filtered_decoded_spots class=md-nav__link> <span class=md-ellipsis> save_global_filtered_decoded_spots </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.save_local_bit_linker class=md-nav__link> <span class=md-ellipsis> save_local_bit_linker </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.save_local_corrected_image class=md-nav__link> <span class=md-ellipsis> save_local_corrected_image </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.save_local_decoded_spots class=md-nav__link> <span class=md-ellipsis> save_local_decoded_spots </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.save_local_registered_image class=md-nav__link> <span class=md-ellipsis> save_local_registered_image </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.save_local_rigid_xform_xyz_px class=md-nav__link> <span class=md-ellipsis> save_local_rigid_xform_xyz_px </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.save_local_round_linker class=md-nav__link> <span class=md-ellipsis> save_local_round_linker </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.save_local_stage_position_zyx_um class=md-nav__link> <span class=md-ellipsis> save_local_stage_position_zyx_um </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.save_local_ufish_image class=md-nav__link> <span class=md-ellipsis> save_local_ufish_image </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.save_local_ufish_spots class=md-nav__link> <span class=md-ellipsis> save_local_ufish_spots </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.save_local_wavelengths_um class=md-nav__link> <span class=md-ellipsis> save_local_wavelengths_um </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.save_mtx class=md-nav__link> <span class=md-ellipsis> save_mtx </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.save_spots_prepped_for_baysor class=md-nav__link> <span class=md-ellipsis> save_spots_prepped_for_baysor </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=datastore-class>DataStore Class<a class=headerlink href=#datastore-class title="Permanent link">&para;</a></h1> <div class="doc doc-object doc-module"> <a id=merfish3danalysis.qi2labDataStore></a> <div class="doc doc-contents first"> <p>Interface to qi2lab MERFISH datastore.</p> <p>This module provides methods and attributes to create or interact with the qi2lab MERFISH datastore. The filestore structure is further described in the merfish3d-analysis documentation.</p> <details class=history: open> <summary>History:</summary> <ul> <li><strong>2024/12</strong>: Refactored repo structure.</li> <li><strong>2024/12</strong>: Updated docstrings and exception types.</li> <li><strong>2024/07</strong>: Initial commit.</li> </ul> </details> <p><span class=doc-section-title>Classes:</span></p> <table> <thead> <tr> <th>Name</th> <th>Description</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td><code><a class="autorefs autorefs-internal" title="merfish3danalysis.qi2labDataStore.qi2labDataStore" href="#merfish3danalysis.qi2labDataStore.qi2labDataStore">qi2labDataStore</a></code></td> <td> <div class=doc-md-description> <p>API to qi2lab MERFISH store.</p> </div> </td> </tr> </tbody> </table> <div class="doc doc-children"> <div class="doc doc-object doc-class"> <h2 id=merfish3danalysis.qi2labDataStore.qi2labDataStore class="doc doc-heading"> <code>qi2labDataStore</code> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore class=headerlink title="Permanent link">&para;</a></h2> <div class="doc doc-contents "> <p>API to qi2lab MERFISH store.</p> <p><span class=doc-section-title>Parameters:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> <th>Default</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td> <code>datastore_path</code> </td> <td> <code><span title="typing.Union">Union</span>[str, <span title="pathlib.Path">Path</span>]</code> </td> <td> <div class=doc-md-description> <p>Path to qi2lab MERFISH store</p> </div> </td> <td> <em>required</em> </td> </tr> </tbody> </table> <p><span class=doc-section-title>Methods:</span></p> <table> <thead> <tr> <th>Name</th> <th>Description</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td><code><a class="autorefs autorefs-internal" title="merfish3danalysis.qi2labDataStore.qi2labDataStore.initialize_tile" href="#merfish3danalysis.qi2labDataStore.qi2labDataStore.initialize_tile">initialize_tile</a></code></td> <td> <div class=doc-md-description> <p>Initialize directory structure for a tile.</p> </div> </td> </tr> <tr class=doc-section-item> <td><code><a class="autorefs autorefs-internal" title="merfish3danalysis.qi2labDataStore.qi2labDataStore.load_codebook_parsed" href="#merfish3danalysis.qi2labDataStore.qi2labDataStore.load_codebook_parsed">load_codebook_parsed</a></code></td> <td> <div class=doc-md-description> <p>Load and split codebook into gene_ids and codebook matrix.</p> </div> </td> </tr> <tr class=doc-section-item> <td><code><a class="autorefs autorefs-internal" title="merfish3danalysis.qi2labDataStore.qi2labDataStore.load_coord_of_xform_px" href="#merfish3danalysis.qi2labDataStore.qi2labDataStore.load_coord_of_xform_px">load_coord_of_xform_px</a></code></td> <td> <div class=doc-md-description> <p>Local fidicual optical flow matrix for one round and tile.</p> </div> </td> </tr> <tr class=doc-section-item> <td><code><a class="autorefs autorefs-internal" title="merfish3danalysis.qi2labDataStore.qi2labDataStore.load_global_baysor_filtered_spots" href="#merfish3danalysis.qi2labDataStore.qi2labDataStore.load_global_baysor_filtered_spots">load_global_baysor_filtered_spots</a></code></td> <td> <div class=doc-md-description> <p>Load Baysor re-assigned decoded RNA.</p> </div> </td> </tr> <tr class=doc-section-item> <td><code><a class="autorefs autorefs-internal" title="merfish3danalysis.qi2labDataStore.qi2labDataStore.load_global_baysor_outlines" href="#merfish3danalysis.qi2labDataStore.qi2labDataStore.load_global_baysor_outlines">load_global_baysor_outlines</a></code></td> <td> <div class=doc-md-description> <p>Load Baysor cell outlines.</p> </div> </td> </tr> <tr class=doc-section-item> <td><code><a class="autorefs autorefs-internal" title="merfish3danalysis.qi2labDataStore.qi2labDataStore.load_global_cellpose_outlines" href="#merfish3danalysis.qi2labDataStore.qi2labDataStore.load_global_cellpose_outlines">load_global_cellpose_outlines</a></code></td> <td> <div class=doc-md-description> <p>Load Cellpose max projection cell outlines.</p> </div> </td> </tr> <tr class=doc-section-item> <td><code><a class="autorefs autorefs-internal" title="merfish3danalysis.qi2labDataStore.qi2labDataStore.load_global_cellpose_segmentation_image" href="#merfish3danalysis.qi2labDataStore.qi2labDataStore.load_global_cellpose_segmentation_image">load_global_cellpose_segmentation_image</a></code></td> <td> <div class=doc-md-description> <p>Load Cellpose max projection, downsampled segmentation image.</p> </div> </td> </tr> <tr class=doc-section-item> <td><code><a class="autorefs autorefs-internal" title="merfish3danalysis.qi2labDataStore.qi2labDataStore.load_global_coord_xforms_um" href="#merfish3danalysis.qi2labDataStore.qi2labDataStore.load_global_coord_xforms_um">load_global_coord_xforms_um</a></code></td> <td> <div class=doc-md-description> <p>Load global registration transform for one tile.</p> </div> </td> </tr> <tr class=doc-section-item> <td><code><a class="autorefs autorefs-internal" title="merfish3danalysis.qi2labDataStore.qi2labDataStore.load_global_fidicual_image" href="#merfish3danalysis.qi2labDataStore.qi2labDataStore.load_global_fidicual_image">load_global_fidicual_image</a></code></td> <td> <div class=doc-md-description> <p>Load downsampled, fused fidicual image.</p> </div> </td> </tr> <tr class=doc-section-item> <td><code><a class="autorefs autorefs-internal" title="merfish3danalysis.qi2labDataStore.qi2labDataStore.load_global_filtered_decoded_spots" href="#merfish3danalysis.qi2labDataStore.qi2labDataStore.load_global_filtered_decoded_spots">load_global_filtered_decoded_spots</a></code></td> <td> <div class=doc-md-description> <p>Load all decoded and filtered spots.</p> </div> </td> </tr> <tr class=doc-section-item> <td><code><a class="autorefs autorefs-internal" title="merfish3danalysis.qi2labDataStore.qi2labDataStore.load_local_bit_linker" href="#merfish3danalysis.qi2labDataStore.qi2labDataStore.load_local_bit_linker">load_local_bit_linker</a></code></td> <td> <div class=doc-md-description> <p>Load readout bits linked to fidicual round for one tile.</p> </div> </td> </tr> <tr class=doc-section-item> <td><code><a class="autorefs autorefs-internal" title="merfish3danalysis.qi2labDataStore.qi2labDataStore.load_local_corrected_image" href="#merfish3danalysis.qi2labDataStore.qi2labDataStore.load_local_corrected_image">load_local_corrected_image</a></code></td> <td> <div class=doc-md-description> <p>Load gain and offset corrected image for fiducial OR readout bit for one tile.</p> </div> </td> </tr> <tr class=doc-section-item> <td><code><a class="autorefs autorefs-internal" title="merfish3danalysis.qi2labDataStore.qi2labDataStore.load_local_decoded_spots" href="#merfish3danalysis.qi2labDataStore.qi2labDataStore.load_local_decoded_spots">load_local_decoded_spots</a></code></td> <td> <div class=doc-md-description> <p>Load decoded spots and features for one tile.</p> </div> </td> </tr> <tr class=doc-section-item> <td><code><a class="autorefs autorefs-internal" title="merfish3danalysis.qi2labDataStore.qi2labDataStore.load_local_registered_image" href="#merfish3danalysis.qi2labDataStore.qi2labDataStore.load_local_registered_image">load_local_registered_image</a></code></td> <td> <div class=doc-md-description> <p>Local registered, deconvolved image for fidiculial OR readout bit for one tile.</p> </div> </td> </tr> <tr class=doc-section-item> <td><code><a class="autorefs autorefs-internal" title="merfish3danalysis.qi2labDataStore.qi2labDataStore.load_local_rigid_xform_xyz_px" href="#merfish3danalysis.qi2labDataStore.qi2labDataStore.load_local_rigid_xform_xyz_px">load_local_rigid_xform_xyz_px</a></code></td> <td> <div class=doc-md-description> <p>Load calculated rigid registration transform for one round and tile.</p> </div> </td> </tr> <tr class=doc-section-item> <td><code><a class="autorefs autorefs-internal" title="merfish3danalysis.qi2labDataStore.qi2labDataStore.load_local_round_linker" href="#merfish3danalysis.qi2labDataStore.qi2labDataStore.load_local_round_linker">load_local_round_linker</a></code></td> <td> <div class=doc-md-description> <p>Load fidicual round linked to readout bit for one tile.</p> </div> </td> </tr> <tr class=doc-section-item> <td><code><a class="autorefs autorefs-internal" title="merfish3danalysis.qi2labDataStore.qi2labDataStore.load_local_stage_position_zyx_um" href="#merfish3danalysis.qi2labDataStore.qi2labDataStore.load_local_stage_position_zyx_um">load_local_stage_position_zyx_um</a></code></td> <td> <div class=doc-md-description> <p>Load tile stage position for one tile.</p> </div> </td> </tr> <tr class=doc-section-item> <td><code><a class="autorefs autorefs-internal" title="merfish3danalysis.qi2labDataStore.qi2labDataStore.load_local_ufish_image" href="#merfish3danalysis.qi2labDataStore.qi2labDataStore.load_local_ufish_image">load_local_ufish_image</a></code></td> <td> <div class=doc-md-description> <p>Load readout bit U-FISH prediction image for one tile.</p> </div> </td> </tr> <tr class=doc-section-item> <td><code><a class="autorefs autorefs-internal" title="merfish3danalysis.qi2labDataStore.qi2labDataStore.load_local_ufish_spots" href="#merfish3danalysis.qi2labDataStore.qi2labDataStore.load_local_ufish_spots">load_local_ufish_spots</a></code></td> <td> <div class=doc-md-description> <p>Load U-FISH spot localizations and features for one tile.</p> </div> </td> </tr> <tr class=doc-section-item> <td><code><a class="autorefs autorefs-internal" title="merfish3danalysis.qi2labDataStore.qi2labDataStore.load_local_wavelengths_um" href="#merfish3danalysis.qi2labDataStore.qi2labDataStore.load_local_wavelengths_um">load_local_wavelengths_um</a></code></td> <td> <div class=doc-md-description> <p>Load wavelengths for fidicual OR readout bit for one tile.</p> </div> </td> </tr> <tr class=doc-section-item> <td><code><a class="autorefs autorefs-internal" title="merfish3danalysis.qi2labDataStore.qi2labDataStore.reformat_baysor_3D_oultines" href="#merfish3danalysis.qi2labDataStore.qi2labDataStore.reformat_baysor_3D_oultines">reformat_baysor_3D_oultines</a></code></td> <td> <div class=doc-md-description> <p>Reformat baysor 3D json file into ImageJ ROIs.</p> </div> </td> </tr> <tr class=doc-section-item> <td><code><a class="autorefs autorefs-internal" title="merfish3danalysis.qi2labDataStore.qi2labDataStore.reprocess_and_save_filtered_spots_with_baysor_outlines" href="#merfish3danalysis.qi2labDataStore.qi2labDataStore.reprocess_and_save_filtered_spots_with_baysor_outlines">reprocess_and_save_filtered_spots_with_baysor_outlines</a></code></td> <td> <div class=doc-md-description> <p>Reprocess filtered spots using baysor cell outlines, then save.</p> </div> </td> </tr> <tr class=doc-section-item> <td><code><a class="autorefs autorefs-internal" title="merfish3danalysis.qi2labDataStore.qi2labDataStore.run_baysor" href="#merfish3danalysis.qi2labDataStore.qi2labDataStore.run_baysor">run_baysor</a></code></td> <td> <div class=doc-md-description> <p>Run Baysor"</p> </div> </td> </tr> <tr class=doc-section-item> <td><code><a class="autorefs autorefs-internal" title="merfish3danalysis.qi2labDataStore.qi2labDataStore.save_coord_of_xform_px" href="#merfish3danalysis.qi2labDataStore.qi2labDataStore.save_coord_of_xform_px">save_coord_of_xform_px</a></code></td> <td> <div class=doc-md-description> <p>Save fidicual optical flow matrix for one round and tile.</p> </div> </td> </tr> <tr class=doc-section-item> <td><code><a class="autorefs autorefs-internal" title="merfish3danalysis.qi2labDataStore.qi2labDataStore.save_global_cellpose_segmentation_image" href="#merfish3danalysis.qi2labDataStore.qi2labDataStore.save_global_cellpose_segmentation_image">save_global_cellpose_segmentation_image</a></code></td> <td> <div class=doc-md-description> <p>Save Cellpose max projection, downsampled segmentation image.</p> </div> </td> </tr> <tr class=doc-section-item> <td><code><a class="autorefs autorefs-internal" title="merfish3danalysis.qi2labDataStore.qi2labDataStore.save_global_coord_xforms_um" href="#merfish3danalysis.qi2labDataStore.qi2labDataStore.save_global_coord_xforms_um">save_global_coord_xforms_um</a></code></td> <td> <div class=doc-md-description> <p>Save global registration transform for one tile.</p> </div> </td> </tr> <tr class=doc-section-item> <td><code><a class="autorefs autorefs-internal" title="merfish3danalysis.qi2labDataStore.qi2labDataStore.save_global_fidicual_image" href="#merfish3danalysis.qi2labDataStore.qi2labDataStore.save_global_fidicual_image">save_global_fidicual_image</a></code></td> <td> <div class=doc-md-description> <p>Save downsampled, fused fidicual image.</p> </div> </td> </tr> <tr class=doc-section-item> <td><code><a class="autorefs autorefs-internal" title="merfish3danalysis.qi2labDataStore.qi2labDataStore.save_global_filtered_decoded_spots" href="#merfish3danalysis.qi2labDataStore.qi2labDataStore.save_global_filtered_decoded_spots">save_global_filtered_decoded_spots</a></code></td> <td> <div class=doc-md-description> <p>Save all decoded and filtered spots.</p> </div> </td> </tr> <tr class=doc-section-item> <td><code><a class="autorefs autorefs-internal" title="merfish3danalysis.qi2labDataStore.qi2labDataStore.save_local_bit_linker" href="#merfish3danalysis.qi2labDataStore.qi2labDataStore.save_local_bit_linker">save_local_bit_linker</a></code></td> <td> <div class=doc-md-description> <p>Save readout bits linked to fidicual round for one tile.</p> </div> </td> </tr> <tr class=doc-section-item> <td><code><a class="autorefs autorefs-internal" title="merfish3danalysis.qi2labDataStore.qi2labDataStore.save_local_corrected_image" href="#merfish3danalysis.qi2labDataStore.qi2labDataStore.save_local_corrected_image">save_local_corrected_image</a></code></td> <td> <div class=doc-md-description> <p>Save gain and offset corrected image.</p> </div> </td> </tr> <tr class=doc-section-item> <td><code><a class="autorefs autorefs-internal" title="merfish3danalysis.qi2labDataStore.qi2labDataStore.save_local_decoded_spots" href="#merfish3danalysis.qi2labDataStore.qi2labDataStore.save_local_decoded_spots">save_local_decoded_spots</a></code></td> <td> <div class=doc-md-description> <p>Save decoded spots and features for one tile.</p> </div> </td> </tr> <tr class=doc-section-item> <td><code><a class="autorefs autorefs-internal" title="merfish3danalysis.qi2labDataStore.qi2labDataStore.save_local_registered_image" href="#merfish3danalysis.qi2labDataStore.qi2labDataStore.save_local_registered_image">save_local_registered_image</a></code></td> <td> <div class=doc-md-description> <p>Save registered, deconvolved image.</p> </div> </td> </tr> <tr class=doc-section-item> <td><code><a class="autorefs autorefs-internal" title="merfish3danalysis.qi2labDataStore.qi2labDataStore.save_local_rigid_xform_xyz_px" href="#merfish3danalysis.qi2labDataStore.qi2labDataStore.save_local_rigid_xform_xyz_px">save_local_rigid_xform_xyz_px</a></code></td> <td> <div class=doc-md-description> <p>Save calculated rigid registration transform for one round and tile.</p> </div> </td> </tr> <tr class=doc-section-item> <td><code><a class="autorefs autorefs-internal" title="merfish3danalysis.qi2labDataStore.qi2labDataStore.save_local_round_linker" href="#merfish3danalysis.qi2labDataStore.qi2labDataStore.save_local_round_linker">save_local_round_linker</a></code></td> <td> <div class=doc-md-description> <p>Save fidicual round linker attribute to readout bit for one tile.</p> </div> </td> </tr> <tr class=doc-section-item> <td><code><a class="autorefs autorefs-internal" title="merfish3danalysis.qi2labDataStore.qi2labDataStore.save_local_stage_position_zyx_um" href="#merfish3danalysis.qi2labDataStore.qi2labDataStore.save_local_stage_position_zyx_um">save_local_stage_position_zyx_um</a></code></td> <td> <div class=doc-md-description> <p>Save tile stage position for one tile.</p> </div> </td> </tr> <tr class=doc-section-item> <td><code><a class="autorefs autorefs-internal" title="merfish3danalysis.qi2labDataStore.qi2labDataStore.save_local_ufish_image" href="#merfish3danalysis.qi2labDataStore.qi2labDataStore.save_local_ufish_image">save_local_ufish_image</a></code></td> <td> <div class=doc-md-description> <p>Save U-FISH prediction image.</p> </div> </td> </tr> <tr class=doc-section-item> <td><code><a class="autorefs autorefs-internal" title="merfish3danalysis.qi2labDataStore.qi2labDataStore.save_local_ufish_spots" href="#merfish3danalysis.qi2labDataStore.qi2labDataStore.save_local_ufish_spots">save_local_ufish_spots</a></code></td> <td> <div class=doc-md-description> <p>Save U-FISH localizations and features.</p> </div> </td> </tr> <tr class=doc-section-item> <td><code><a class="autorefs autorefs-internal" title="merfish3danalysis.qi2labDataStore.qi2labDataStore.save_local_wavelengths_um" href="#merfish3danalysis.qi2labDataStore.qi2labDataStore.save_local_wavelengths_um">save_local_wavelengths_um</a></code></td> <td> <div class=doc-md-description> <p>Save wavelengths for fidicual OR readout bit for one tile.</p> </div> </td> </tr> <tr class=doc-section-item> <td><code><a class="autorefs autorefs-internal" title="merfish3danalysis.qi2labDataStore.qi2labDataStore.save_mtx" href="#merfish3danalysis.qi2labDataStore.qi2labDataStore.save_mtx">save_mtx</a></code></td> <td> <div class=doc-md-description> <p>Save mtx file for downstream analysis. Assumes Baysor has been run.</p> </div> </td> </tr> <tr class=doc-section-item> <td><code><a class="autorefs autorefs-internal" title="merfish3danalysis.qi2labDataStore.qi2labDataStore.save_spots_prepped_for_baysor" href="#merfish3danalysis.qi2labDataStore.qi2labDataStore.save_spots_prepped_for_baysor">save_spots_prepped_for_baysor</a></code></td> <td> <div class=doc-md-description> <p>Save spots prepped for Baysor.</p> </div> </td> </tr> </tbody> </table> <p><span class=doc-section-title>Attributes:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td><code><a class="autorefs autorefs-internal" title="merfish3danalysis.qi2labDataStore.qi2labDataStore.baysor_options" href="#merfish3danalysis.qi2labDataStore.qi2labDataStore.baysor_options">baysor_options</a></code></td> <td> <code><span title="typing.Union">Union</span>[<span title="pathlib.Path">Path</span>, str]</code> </td> <td> <div class=doc-md-description> <p>Baysor options</p> </div> </td> </tr> <tr class=doc-section-item> <td><code><a class="autorefs autorefs-internal" title="merfish3danalysis.qi2labDataStore.qi2labDataStore.baysor_path" href="#merfish3danalysis.qi2labDataStore.qi2labDataStore.baysor_path">baysor_path</a></code></td> <td> <code><span title="typing.Union">Union</span>[<span title="pathlib.Path">Path</span>, str]</code> </td> <td> <div class=doc-md-description> <p>Baysor path</p> </div> </td> </tr> <tr class=doc-section-item> <td><code><a class="autorefs autorefs-internal" title="merfish3danalysis.qi2labDataStore.qi2labDataStore.binning" href="#merfish3danalysis.qi2labDataStore.qi2labDataStore.binning">binning</a></code></td> <td> <code><span title="typing.Optional">Optional</span>[int]</code> </td> <td> <div class=doc-md-description> <p>Camera binning.</p> </div> </td> </tr> <tr class=doc-section-item> <td><code><a class="autorefs autorefs-internal" title="merfish3danalysis.qi2labDataStore.qi2labDataStore.bit_ids" href="#merfish3danalysis.qi2labDataStore.qi2labDataStore.bit_ids">bit_ids</a></code></td> <td> <code><span title="typing.Optional">Optional</span>[<span title="typing.Collection">Collection</span>[str]]</code> </td> <td> <div class=doc-md-description> <p>Bit IDs.</p> </div> </td> </tr> <tr class=doc-section-item> <td><code><a class="autorefs autorefs-internal" title="merfish3danalysis.qi2labDataStore.qi2labDataStore.camera_model" href="#merfish3danalysis.qi2labDataStore.qi2labDataStore.camera_model">camera_model</a></code></td> <td> <code><span title="typing.Optional">Optional</span>[str]</code> </td> <td> <div class=doc-md-description> <p>Camera model.</p> </div> </td> </tr> <tr class=doc-section-item> <td><code><a class="autorefs autorefs-internal" title="merfish3danalysis.qi2labDataStore.qi2labDataStore.channel_psfs" href="#merfish3danalysis.qi2labDataStore.qi2labDataStore.channel_psfs">channel_psfs</a></code></td> <td> <code><span title="typing.Optional">Optional</span>[<span title="numpy.typing.ArrayLike">ArrayLike</span>]</code> </td> <td> <div class=doc-md-description> <p>Channel point spread functions (PSF).</p> </div> </td> </tr> <tr class=doc-section-item> <td><code><a class="autorefs autorefs-internal" title="merfish3danalysis.qi2labDataStore.qi2labDataStore.channel_shading_maps" href="#merfish3danalysis.qi2labDataStore.qi2labDataStore.channel_shading_maps">channel_shading_maps</a></code></td> <td> <code><span title="typing.Optional">Optional</span>[<span title="numpy.typing.ArrayLike">ArrayLike</span>]</code> </td> <td> <div class=doc-md-description> <p>Channel shaiding images.</p> </div> </td> </tr> <tr class=doc-section-item> <td><code><a class="autorefs autorefs-internal" title="merfish3danalysis.qi2labDataStore.qi2labDataStore.channels_in_data" href="#merfish3danalysis.qi2labDataStore.qi2labDataStore.channels_in_data">channels_in_data</a></code></td> <td> <code><span title="typing.Optional">Optional</span>[<span title="typing.Collection">Collection</span>[int]]</code> </td> <td> <div class=doc-md-description> <p>Channel indices.</p> </div> </td> </tr> <tr class=doc-section-item> <td><code><a class="autorefs autorefs-internal" title="merfish3danalysis.qi2labDataStore.qi2labDataStore.codebook" href="#merfish3danalysis.qi2labDataStore.qi2labDataStore.codebook">codebook</a></code></td> <td> <code><span title="typing.Optional">Optional</span>[<span title="pandas.DataFrame">DataFrame</span>]</code> </td> <td> <div class=doc-md-description> <p>Codebook.</p> </div> </td> </tr> <tr class=doc-section-item> <td><code><a class="autorefs autorefs-internal" title="merfish3danalysis.qi2labDataStore.qi2labDataStore.datastore_state" href="#merfish3danalysis.qi2labDataStore.qi2labDataStore.datastore_state">datastore_state</a></code></td> <td> <code><span title="typing.Optional">Optional</span>[dict]</code> </td> <td> <div class=doc-md-description> <p>Datastore state.</p> </div> </td> </tr> <tr class=doc-section-item> <td><code><a class="autorefs autorefs-internal" title="merfish3danalysis.qi2labDataStore.qi2labDataStore.e_per_ADU" href="#merfish3danalysis.qi2labDataStore.qi2labDataStore.e_per_ADU">e_per_ADU</a></code></td> <td> <code><span title="typing.Optional">Optional</span>[float]</code> </td> <td> <div class=doc-md-description> <p>Electrons per camera ADU.</p> </div> </td> </tr> <tr class=doc-section-item> <td><code><a class="autorefs autorefs-internal" title="merfish3danalysis.qi2labDataStore.qi2labDataStore.experiment_order" href="#merfish3danalysis.qi2labDataStore.qi2labDataStore.experiment_order">experiment_order</a></code></td> <td> <code><span title="typing.Optional">Optional</span>[<span title="pandas.DataFrame">DataFrame</span>]</code> </td> <td> <div class=doc-md-description> <p>Round and bit order.</p> </div> </td> </tr> <tr class=doc-section-item> <td><code><a class="autorefs autorefs-internal" title="merfish3danalysis.qi2labDataStore.qi2labDataStore.global_background_vector" href="#merfish3danalysis.qi2labDataStore.qi2labDataStore.global_background_vector">global_background_vector</a></code></td> <td> <code><span title="typing.Optional">Optional</span>[<span title="numpy.typing.ArrayLike">ArrayLike</span>]</code> </td> <td> <div class=doc-md-description> <p>Global background vector.</p> </div> </td> </tr> <tr class=doc-section-item> <td><code><a class="autorefs autorefs-internal" title="merfish3danalysis.qi2labDataStore.qi2labDataStore.global_normalization_vector" href="#merfish3danalysis.qi2labDataStore.qi2labDataStore.global_normalization_vector">global_normalization_vector</a></code></td> <td> <code><span title="typing.Optional">Optional</span>[<span title="numpy.typing.ArrayLike">ArrayLike</span>]</code> </td> <td> <div class=doc-md-description> <p>Global normalization vector.</p> </div> </td> </tr> <tr class=doc-section-item> <td><code><a class="autorefs autorefs-internal" title="merfish3danalysis.qi2labDataStore.qi2labDataStore.iterative_background_vector" href="#merfish3danalysis.qi2labDataStore.qi2labDataStore.iterative_background_vector">iterative_background_vector</a></code></td> <td> <code><span title="typing.Optional">Optional</span>[<span title="numpy.typing.ArrayLike">ArrayLike</span>]</code> </td> <td> <div class=doc-md-description> <p>Iterative background vector.</p> </div> </td> </tr> <tr class=doc-section-item> <td><code><a class="autorefs autorefs-internal" title="merfish3danalysis.qi2labDataStore.qi2labDataStore.iterative_normalization_vector" href="#merfish3danalysis.qi2labDataStore.qi2labDataStore.iterative_normalization_vector">iterative_normalization_vector</a></code></td> <td> <code><span title="typing.Optional">Optional</span>[<span title="numpy.typing.ArrayLike">ArrayLike</span>]</code> </td> <td> <div class=doc-md-description> <p>Iterative normalization vector.</p> </div> </td> </tr> <tr class=doc-section-item> <td><code><a class="autorefs autorefs-internal" title="merfish3danalysis.qi2labDataStore.qi2labDataStore.julia_threads" href="#merfish3danalysis.qi2labDataStore.qi2labDataStore.julia_threads">julia_threads</a></code></td> <td> <code>int</code> </td> <td> <div class=doc-md-description> <p>Julia thread number</p> </div> </td> </tr> <tr class=doc-section-item> <td><code><a class="autorefs autorefs-internal" title="merfish3danalysis.qi2labDataStore.qi2labDataStore.microscope_type" href="#merfish3danalysis.qi2labDataStore.qi2labDataStore.microscope_type">microscope_type</a></code></td> <td> <code><span title="typing.Optional">Optional</span>[str]</code> </td> <td> <div class=doc-md-description> <p>Microscope type.</p> </div> </td> </tr> <tr class=doc-section-item> <td><code><a class="autorefs autorefs-internal" title="merfish3danalysis.qi2labDataStore.qi2labDataStore.na" href="#merfish3danalysis.qi2labDataStore.qi2labDataStore.na">na</a></code></td> <td> <code><span title="typing.Optional">Optional</span>[float]</code> </td> <td> <div class=doc-md-description> <p>Detection objective numerical aperture (NA).</p> </div> </td> </tr> <tr class=doc-section-item> <td><code><a class="autorefs autorefs-internal" title="merfish3danalysis.qi2labDataStore.qi2labDataStore.noise_map" href="#merfish3danalysis.qi2labDataStore.qi2labDataStore.noise_map">noise_map</a></code></td> <td> <code><span title="typing.Optional">Optional</span>[<span title="numpy.typing.ArrayLike">ArrayLike</span>]</code> </td> <td> <div class=doc-md-description> <p>Camera noise image.</p> </div> </td> </tr> <tr class=doc-section-item> <td><code><a class="autorefs autorefs-internal" title="merfish3danalysis.qi2labDataStore.qi2labDataStore.num_bits" href="#merfish3danalysis.qi2labDataStore.qi2labDataStore.num_bits">num_bits</a></code></td> <td> <code>int</code> </td> <td> <div class=doc-md-description> <p>Number of bits.</p> </div> </td> </tr> <tr class=doc-section-item> <td><code><a class="autorefs autorefs-internal" title="merfish3danalysis.qi2labDataStore.qi2labDataStore.num_rounds" href="#merfish3danalysis.qi2labDataStore.qi2labDataStore.num_rounds">num_rounds</a></code></td> <td> <code><span title="typing.Optional">Optional</span>[int]</code> </td> <td> <div class=doc-md-description> <p>Number of rounds.</p> </div> </td> </tr> <tr class=doc-section-item> <td><code><a class="autorefs autorefs-internal" title="merfish3danalysis.qi2labDataStore.qi2labDataStore.num_tiles" href="#merfish3danalysis.qi2labDataStore.qi2labDataStore.num_tiles">num_tiles</a></code></td> <td> <code><span title="typing.Optional">Optional</span>[int]</code> </td> <td> <div class=doc-md-description> <p>Number of tiles.</p> </div> </td> </tr> <tr class=doc-section-item> <td><code><a class="autorefs autorefs-internal" title="merfish3danalysis.qi2labDataStore.qi2labDataStore.ri" href="#merfish3danalysis.qi2labDataStore.qi2labDataStore.ri">ri</a></code></td> <td> <code><span title="typing.Optional">Optional</span>[float]</code> </td> <td> <div class=doc-md-description> <p>Detection objective refractive index (RI).</p> </div> </td> </tr> <tr class=doc-section-item> <td><code><a class="autorefs autorefs-internal" title="merfish3danalysis.qi2labDataStore.qi2labDataStore.round_ids" href="#merfish3danalysis.qi2labDataStore.qi2labDataStore.round_ids">round_ids</a></code></td> <td> <code><span title="typing.Optional">Optional</span>[<span title="typing.Collection">Collection</span>[str]]</code> </td> <td> <div class=doc-md-description> <p>Round IDs.</p> </div> </td> </tr> <tr class=doc-section-item> <td><code><a class="autorefs autorefs-internal" title="merfish3danalysis.qi2labDataStore.qi2labDataStore.tile_ids" href="#merfish3danalysis.qi2labDataStore.qi2labDataStore.tile_ids">tile_ids</a></code></td> <td> <code><span title="typing.Optional">Optional</span>[<span title="typing.Collection">Collection</span>[str]]</code> </td> <td> <div class=doc-md-description> <p>Tile IDs.</p> </div> </td> </tr> <tr class=doc-section-item> <td><code><a class="autorefs autorefs-internal" title="merfish3danalysis.qi2labDataStore.qi2labDataStore.tile_overlap" href="#merfish3danalysis.qi2labDataStore.qi2labDataStore.tile_overlap">tile_overlap</a></code></td> <td> <code><span title="typing.Optional">Optional</span>[float]</code> </td> <td> <div class=doc-md-description> <p>XY tile overlap.</p> </div> </td> </tr> <tr class=doc-section-item> <td><code><a class="autorefs autorefs-internal" title="merfish3danalysis.qi2labDataStore.qi2labDataStore.voxel_size_zyx_um" href="#merfish3danalysis.qi2labDataStore.qi2labDataStore.voxel_size_zyx_um">voxel_size_zyx_um</a></code></td> <td> <code><span title="typing.Optional">Optional</span>[<span title="numpy.typing.ArrayLike">ArrayLike</span>]</code> </td> <td> <div class=doc-md-description> <p>Voxel size, zyx order (microns).</p> </div> </td> </tr> </tbody> </table> <details class=quote> <summary>Source code in <code>src/merfish3danalysis/qi2labDataStore.py</code></summary> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>  33</span>
<span class=normal>  34</span>
<span class=normal>  35</span>
<span class=normal>  36</span>
<span class=normal>  37</span>
<span class=normal>  38</span>
<span class=normal>  39</span>
<span class=normal>  40</span>
<span class=normal>  41</span>
<span class=normal>  42</span>
<span class=normal>  43</span>
<span class=normal>  44</span>
<span class=normal>  45</span>
<span class=normal>  46</span>
<span class=normal>  47</span>
<span class=normal>  48</span>
<span class=normal>  49</span>
<span class=normal>  50</span>
<span class=normal>  51</span>
<span class=normal>  52</span>
<span class=normal>  53</span>
<span class=normal>  54</span>
<span class=normal>  55</span>
<span class=normal>  56</span>
<span class=normal>  57</span>
<span class=normal>  58</span>
<span class=normal>  59</span>
<span class=normal>  60</span>
<span class=normal>  61</span>
<span class=normal>  62</span>
<span class=normal>  63</span>
<span class=normal>  64</span>
<span class=normal>  65</span>
<span class=normal>  66</span>
<span class=normal>  67</span>
<span class=normal>  68</span>
<span class=normal>  69</span>
<span class=normal>  70</span>
<span class=normal>  71</span>
<span class=normal>  72</span>
<span class=normal>  73</span>
<span class=normal>  74</span>
<span class=normal>  75</span>
<span class=normal>  76</span>
<span class=normal>  77</span>
<span class=normal>  78</span>
<span class=normal>  79</span>
<span class=normal>  80</span>
<span class=normal>  81</span>
<span class=normal>  82</span>
<span class=normal>  83</span>
<span class=normal>  84</span>
<span class=normal>  85</span>
<span class=normal>  86</span>
<span class=normal>  87</span>
<span class=normal>  88</span>
<span class=normal>  89</span>
<span class=normal>  90</span>
<span class=normal>  91</span>
<span class=normal>  92</span>
<span class=normal>  93</span>
<span class=normal>  94</span>
<span class=normal>  95</span>
<span class=normal>  96</span>
<span class=normal>  97</span>
<span class=normal>  98</span>
<span class=normal>  99</span>
<span class=normal> 100</span>
<span class=normal> 101</span>
<span class=normal> 102</span>
<span class=normal> 103</span>
<span class=normal> 104</span>
<span class=normal> 105</span>
<span class=normal> 106</span>
<span class=normal> 107</span>
<span class=normal> 108</span>
<span class=normal> 109</span>
<span class=normal> 110</span>
<span class=normal> 111</span>
<span class=normal> 112</span>
<span class=normal> 113</span>
<span class=normal> 114</span>
<span class=normal> 115</span>
<span class=normal> 116</span>
<span class=normal> 117</span>
<span class=normal> 118</span>
<span class=normal> 119</span>
<span class=normal> 120</span>
<span class=normal> 121</span>
<span class=normal> 122</span>
<span class=normal> 123</span>
<span class=normal> 124</span>
<span class=normal> 125</span>
<span class=normal> 126</span>
<span class=normal> 127</span>
<span class=normal> 128</span>
<span class=normal> 129</span>
<span class=normal> 130</span>
<span class=normal> 131</span>
<span class=normal> 132</span>
<span class=normal> 133</span>
<span class=normal> 134</span>
<span class=normal> 135</span>
<span class=normal> 136</span>
<span class=normal> 137</span>
<span class=normal> 138</span>
<span class=normal> 139</span>
<span class=normal> 140</span>
<span class=normal> 141</span>
<span class=normal> 142</span>
<span class=normal> 143</span>
<span class=normal> 144</span>
<span class=normal> 145</span>
<span class=normal> 146</span>
<span class=normal> 147</span>
<span class=normal> 148</span>
<span class=normal> 149</span>
<span class=normal> 150</span>
<span class=normal> 151</span>
<span class=normal> 152</span>
<span class=normal> 153</span>
<span class=normal> 154</span>
<span class=normal> 155</span>
<span class=normal> 156</span>
<span class=normal> 157</span>
<span class=normal> 158</span>
<span class=normal> 159</span>
<span class=normal> 160</span>
<span class=normal> 161</span>
<span class=normal> 162</span>
<span class=normal> 163</span>
<span class=normal> 164</span>
<span class=normal> 165</span>
<span class=normal> 166</span>
<span class=normal> 167</span>
<span class=normal> 168</span>
<span class=normal> 169</span>
<span class=normal> 170</span>
<span class=normal> 171</span>
<span class=normal> 172</span>
<span class=normal> 173</span>
<span class=normal> 174</span>
<span class=normal> 175</span>
<span class=normal> 176</span>
<span class=normal> 177</span>
<span class=normal> 178</span>
<span class=normal> 179</span>
<span class=normal> 180</span>
<span class=normal> 181</span>
<span class=normal> 182</span>
<span class=normal> 183</span>
<span class=normal> 184</span>
<span class=normal> 185</span>
<span class=normal> 186</span>
<span class=normal> 187</span>
<span class=normal> 188</span>
<span class=normal> 189</span>
<span class=normal> 190</span>
<span class=normal> 191</span>
<span class=normal> 192</span>
<span class=normal> 193</span>
<span class=normal> 194</span>
<span class=normal> 195</span>
<span class=normal> 196</span>
<span class=normal> 197</span>
<span class=normal> 198</span>
<span class=normal> 199</span>
<span class=normal> 200</span>
<span class=normal> 201</span>
<span class=normal> 202</span>
<span class=normal> 203</span>
<span class=normal> 204</span>
<span class=normal> 205</span>
<span class=normal> 206</span>
<span class=normal> 207</span>
<span class=normal> 208</span>
<span class=normal> 209</span>
<span class=normal> 210</span>
<span class=normal> 211</span>
<span class=normal> 212</span>
<span class=normal> 213</span>
<span class=normal> 214</span>
<span class=normal> 215</span>
<span class=normal> 216</span>
<span class=normal> 217</span>
<span class=normal> 218</span>
<span class=normal> 219</span>
<span class=normal> 220</span>
<span class=normal> 221</span>
<span class=normal> 222</span>
<span class=normal> 223</span>
<span class=normal> 224</span>
<span class=normal> 225</span>
<span class=normal> 226</span>
<span class=normal> 227</span>
<span class=normal> 228</span>
<span class=normal> 229</span>
<span class=normal> 230</span>
<span class=normal> 231</span>
<span class=normal> 232</span>
<span class=normal> 233</span>
<span class=normal> 234</span>
<span class=normal> 235</span>
<span class=normal> 236</span>
<span class=normal> 237</span>
<span class=normal> 238</span>
<span class=normal> 239</span>
<span class=normal> 240</span>
<span class=normal> 241</span>
<span class=normal> 242</span>
<span class=normal> 243</span>
<span class=normal> 244</span>
<span class=normal> 245</span>
<span class=normal> 246</span>
<span class=normal> 247</span>
<span class=normal> 248</span>
<span class=normal> 249</span>
<span class=normal> 250</span>
<span class=normal> 251</span>
<span class=normal> 252</span>
<span class=normal> 253</span>
<span class=normal> 254</span>
<span class=normal> 255</span>
<span class=normal> 256</span>
<span class=normal> 257</span>
<span class=normal> 258</span>
<span class=normal> 259</span>
<span class=normal> 260</span>
<span class=normal> 261</span>
<span class=normal> 262</span>
<span class=normal> 263</span>
<span class=normal> 264</span>
<span class=normal> 265</span>
<span class=normal> 266</span>
<span class=normal> 267</span>
<span class=normal> 268</span>
<span class=normal> 269</span>
<span class=normal> 270</span>
<span class=normal> 271</span>
<span class=normal> 272</span>
<span class=normal> 273</span>
<span class=normal> 274</span>
<span class=normal> 275</span>
<span class=normal> 276</span>
<span class=normal> 277</span>
<span class=normal> 278</span>
<span class=normal> 279</span>
<span class=normal> 280</span>
<span class=normal> 281</span>
<span class=normal> 282</span>
<span class=normal> 283</span>
<span class=normal> 284</span>
<span class=normal> 285</span>
<span class=normal> 286</span>
<span class=normal> 287</span>
<span class=normal> 288</span>
<span class=normal> 289</span>
<span class=normal> 290</span>
<span class=normal> 291</span>
<span class=normal> 292</span>
<span class=normal> 293</span>
<span class=normal> 294</span>
<span class=normal> 295</span>
<span class=normal> 296</span>
<span class=normal> 297</span>
<span class=normal> 298</span>
<span class=normal> 299</span>
<span class=normal> 300</span>
<span class=normal> 301</span>
<span class=normal> 302</span>
<span class=normal> 303</span>
<span class=normal> 304</span>
<span class=normal> 305</span>
<span class=normal> 306</span>
<span class=normal> 307</span>
<span class=normal> 308</span>
<span class=normal> 309</span>
<span class=normal> 310</span>
<span class=normal> 311</span>
<span class=normal> 312</span>
<span class=normal> 313</span>
<span class=normal> 314</span>
<span class=normal> 315</span>
<span class=normal> 316</span>
<span class=normal> 317</span>
<span class=normal> 318</span>
<span class=normal> 319</span>
<span class=normal> 320</span>
<span class=normal> 321</span>
<span class=normal> 322</span>
<span class=normal> 323</span>
<span class=normal> 324</span>
<span class=normal> 325</span>
<span class=normal> 326</span>
<span class=normal> 327</span>
<span class=normal> 328</span>
<span class=normal> 329</span>
<span class=normal> 330</span>
<span class=normal> 331</span>
<span class=normal> 332</span>
<span class=normal> 333</span>
<span class=normal> 334</span>
<span class=normal> 335</span>
<span class=normal> 336</span>
<span class=normal> 337</span>
<span class=normal> 338</span>
<span class=normal> 339</span>
<span class=normal> 340</span>
<span class=normal> 341</span>
<span class=normal> 342</span>
<span class=normal> 343</span>
<span class=normal> 344</span>
<span class=normal> 345</span>
<span class=normal> 346</span>
<span class=normal> 347</span>
<span class=normal> 348</span>
<span class=normal> 349</span>
<span class=normal> 350</span>
<span class=normal> 351</span>
<span class=normal> 352</span>
<span class=normal> 353</span>
<span class=normal> 354</span>
<span class=normal> 355</span>
<span class=normal> 356</span>
<span class=normal> 357</span>
<span class=normal> 358</span>
<span class=normal> 359</span>
<span class=normal> 360</span>
<span class=normal> 361</span>
<span class=normal> 362</span>
<span class=normal> 363</span>
<span class=normal> 364</span>
<span class=normal> 365</span>
<span class=normal> 366</span>
<span class=normal> 367</span>
<span class=normal> 368</span>
<span class=normal> 369</span>
<span class=normal> 370</span>
<span class=normal> 371</span>
<span class=normal> 372</span>
<span class=normal> 373</span>
<span class=normal> 374</span>
<span class=normal> 375</span>
<span class=normal> 376</span>
<span class=normal> 377</span>
<span class=normal> 378</span>
<span class=normal> 379</span>
<span class=normal> 380</span>
<span class=normal> 381</span>
<span class=normal> 382</span>
<span class=normal> 383</span>
<span class=normal> 384</span>
<span class=normal> 385</span>
<span class=normal> 386</span>
<span class=normal> 387</span>
<span class=normal> 388</span>
<span class=normal> 389</span>
<span class=normal> 390</span>
<span class=normal> 391</span>
<span class=normal> 392</span>
<span class=normal> 393</span>
<span class=normal> 394</span>
<span class=normal> 395</span>
<span class=normal> 396</span>
<span class=normal> 397</span>
<span class=normal> 398</span>
<span class=normal> 399</span>
<span class=normal> 400</span>
<span class=normal> 401</span>
<span class=normal> 402</span>
<span class=normal> 403</span>
<span class=normal> 404</span>
<span class=normal> 405</span>
<span class=normal> 406</span>
<span class=normal> 407</span>
<span class=normal> 408</span>
<span class=normal> 409</span>
<span class=normal> 410</span>
<span class=normal> 411</span>
<span class=normal> 412</span>
<span class=normal> 413</span>
<span class=normal> 414</span>
<span class=normal> 415</span>
<span class=normal> 416</span>
<span class=normal> 417</span>
<span class=normal> 418</span>
<span class=normal> 419</span>
<span class=normal> 420</span>
<span class=normal> 421</span>
<span class=normal> 422</span>
<span class=normal> 423</span>
<span class=normal> 424</span>
<span class=normal> 425</span>
<span class=normal> 426</span>
<span class=normal> 427</span>
<span class=normal> 428</span>
<span class=normal> 429</span>
<span class=normal> 430</span>
<span class=normal> 431</span>
<span class=normal> 432</span>
<span class=normal> 433</span>
<span class=normal> 434</span>
<span class=normal> 435</span>
<span class=normal> 436</span>
<span class=normal> 437</span>
<span class=normal> 438</span>
<span class=normal> 439</span>
<span class=normal> 440</span>
<span class=normal> 441</span>
<span class=normal> 442</span>
<span class=normal> 443</span>
<span class=normal> 444</span>
<span class=normal> 445</span>
<span class=normal> 446</span>
<span class=normal> 447</span>
<span class=normal> 448</span>
<span class=normal> 449</span>
<span class=normal> 450</span>
<span class=normal> 451</span>
<span class=normal> 452</span>
<span class=normal> 453</span>
<span class=normal> 454</span>
<span class=normal> 455</span>
<span class=normal> 456</span>
<span class=normal> 457</span>
<span class=normal> 458</span>
<span class=normal> 459</span>
<span class=normal> 460</span>
<span class=normal> 461</span>
<span class=normal> 462</span>
<span class=normal> 463</span>
<span class=normal> 464</span>
<span class=normal> 465</span>
<span class=normal> 466</span>
<span class=normal> 467</span>
<span class=normal> 468</span>
<span class=normal> 469</span>
<span class=normal> 470</span>
<span class=normal> 471</span>
<span class=normal> 472</span>
<span class=normal> 473</span>
<span class=normal> 474</span>
<span class=normal> 475</span>
<span class=normal> 476</span>
<span class=normal> 477</span>
<span class=normal> 478</span>
<span class=normal> 479</span>
<span class=normal> 480</span>
<span class=normal> 481</span>
<span class=normal> 482</span>
<span class=normal> 483</span>
<span class=normal> 484</span>
<span class=normal> 485</span>
<span class=normal> 486</span>
<span class=normal> 487</span>
<span class=normal> 488</span>
<span class=normal> 489</span>
<span class=normal> 490</span>
<span class=normal> 491</span>
<span class=normal> 492</span>
<span class=normal> 493</span>
<span class=normal> 494</span>
<span class=normal> 495</span>
<span class=normal> 496</span>
<span class=normal> 497</span>
<span class=normal> 498</span>
<span class=normal> 499</span>
<span class=normal> 500</span>
<span class=normal> 501</span>
<span class=normal> 502</span>
<span class=normal> 503</span>
<span class=normal> 504</span>
<span class=normal> 505</span>
<span class=normal> 506</span>
<span class=normal> 507</span>
<span class=normal> 508</span>
<span class=normal> 509</span>
<span class=normal> 510</span>
<span class=normal> 511</span>
<span class=normal> 512</span>
<span class=normal> 513</span>
<span class=normal> 514</span>
<span class=normal> 515</span>
<span class=normal> 516</span>
<span class=normal> 517</span>
<span class=normal> 518</span>
<span class=normal> 519</span>
<span class=normal> 520</span>
<span class=normal> 521</span>
<span class=normal> 522</span>
<span class=normal> 523</span>
<span class=normal> 524</span>
<span class=normal> 525</span>
<span class=normal> 526</span>
<span class=normal> 527</span>
<span class=normal> 528</span>
<span class=normal> 529</span>
<span class=normal> 530</span>
<span class=normal> 531</span>
<span class=normal> 532</span>
<span class=normal> 533</span>
<span class=normal> 534</span>
<span class=normal> 535</span>
<span class=normal> 536</span>
<span class=normal> 537</span>
<span class=normal> 538</span>
<span class=normal> 539</span>
<span class=normal> 540</span>
<span class=normal> 541</span>
<span class=normal> 542</span>
<span class=normal> 543</span>
<span class=normal> 544</span>
<span class=normal> 545</span>
<span class=normal> 546</span>
<span class=normal> 547</span>
<span class=normal> 548</span>
<span class=normal> 549</span>
<span class=normal> 550</span>
<span class=normal> 551</span>
<span class=normal> 552</span>
<span class=normal> 553</span>
<span class=normal> 554</span>
<span class=normal> 555</span>
<span class=normal> 556</span>
<span class=normal> 557</span>
<span class=normal> 558</span>
<span class=normal> 559</span>
<span class=normal> 560</span>
<span class=normal> 561</span>
<span class=normal> 562</span>
<span class=normal> 563</span>
<span class=normal> 564</span>
<span class=normal> 565</span>
<span class=normal> 566</span>
<span class=normal> 567</span>
<span class=normal> 568</span>
<span class=normal> 569</span>
<span class=normal> 570</span>
<span class=normal> 571</span>
<span class=normal> 572</span>
<span class=normal> 573</span>
<span class=normal> 574</span>
<span class=normal> 575</span>
<span class=normal> 576</span>
<span class=normal> 577</span>
<span class=normal> 578</span>
<span class=normal> 579</span>
<span class=normal> 580</span>
<span class=normal> 581</span>
<span class=normal> 582</span>
<span class=normal> 583</span>
<span class=normal> 584</span>
<span class=normal> 585</span>
<span class=normal> 586</span>
<span class=normal> 587</span>
<span class=normal> 588</span>
<span class=normal> 589</span>
<span class=normal> 590</span>
<span class=normal> 591</span>
<span class=normal> 592</span>
<span class=normal> 593</span>
<span class=normal> 594</span>
<span class=normal> 595</span>
<span class=normal> 596</span>
<span class=normal> 597</span>
<span class=normal> 598</span>
<span class=normal> 599</span>
<span class=normal> 600</span>
<span class=normal> 601</span>
<span class=normal> 602</span>
<span class=normal> 603</span>
<span class=normal> 604</span>
<span class=normal> 605</span>
<span class=normal> 606</span>
<span class=normal> 607</span>
<span class=normal> 608</span>
<span class=normal> 609</span>
<span class=normal> 610</span>
<span class=normal> 611</span>
<span class=normal> 612</span>
<span class=normal> 613</span>
<span class=normal> 614</span>
<span class=normal> 615</span>
<span class=normal> 616</span>
<span class=normal> 617</span>
<span class=normal> 618</span>
<span class=normal> 619</span>
<span class=normal> 620</span>
<span class=normal> 621</span>
<span class=normal> 622</span>
<span class=normal> 623</span>
<span class=normal> 624</span>
<span class=normal> 625</span>
<span class=normal> 626</span>
<span class=normal> 627</span>
<span class=normal> 628</span>
<span class=normal> 629</span>
<span class=normal> 630</span>
<span class=normal> 631</span>
<span class=normal> 632</span>
<span class=normal> 633</span>
<span class=normal> 634</span>
<span class=normal> 635</span>
<span class=normal> 636</span>
<span class=normal> 637</span>
<span class=normal> 638</span>
<span class=normal> 639</span>
<span class=normal> 640</span>
<span class=normal> 641</span>
<span class=normal> 642</span>
<span class=normal> 643</span>
<span class=normal> 644</span>
<span class=normal> 645</span>
<span class=normal> 646</span>
<span class=normal> 647</span>
<span class=normal> 648</span>
<span class=normal> 649</span>
<span class=normal> 650</span>
<span class=normal> 651</span>
<span class=normal> 652</span>
<span class=normal> 653</span>
<span class=normal> 654</span>
<span class=normal> 655</span>
<span class=normal> 656</span>
<span class=normal> 657</span>
<span class=normal> 658</span>
<span class=normal> 659</span>
<span class=normal> 660</span>
<span class=normal> 661</span>
<span class=normal> 662</span>
<span class=normal> 663</span>
<span class=normal> 664</span>
<span class=normal> 665</span>
<span class=normal> 666</span>
<span class=normal> 667</span>
<span class=normal> 668</span>
<span class=normal> 669</span>
<span class=normal> 670</span>
<span class=normal> 671</span>
<span class=normal> 672</span>
<span class=normal> 673</span>
<span class=normal> 674</span>
<span class=normal> 675</span>
<span class=normal> 676</span>
<span class=normal> 677</span>
<span class=normal> 678</span>
<span class=normal> 679</span>
<span class=normal> 680</span>
<span class=normal> 681</span>
<span class=normal> 682</span>
<span class=normal> 683</span>
<span class=normal> 684</span>
<span class=normal> 685</span>
<span class=normal> 686</span>
<span class=normal> 687</span>
<span class=normal> 688</span>
<span class=normal> 689</span>
<span class=normal> 690</span>
<span class=normal> 691</span>
<span class=normal> 692</span>
<span class=normal> 693</span>
<span class=normal> 694</span>
<span class=normal> 695</span>
<span class=normal> 696</span>
<span class=normal> 697</span>
<span class=normal> 698</span>
<span class=normal> 699</span>
<span class=normal> 700</span>
<span class=normal> 701</span>
<span class=normal> 702</span>
<span class=normal> 703</span>
<span class=normal> 704</span>
<span class=normal> 705</span>
<span class=normal> 706</span>
<span class=normal> 707</span>
<span class=normal> 708</span>
<span class=normal> 709</span>
<span class=normal> 710</span>
<span class=normal> 711</span>
<span class=normal> 712</span>
<span class=normal> 713</span>
<span class=normal> 714</span>
<span class=normal> 715</span>
<span class=normal> 716</span>
<span class=normal> 717</span>
<span class=normal> 718</span>
<span class=normal> 719</span>
<span class=normal> 720</span>
<span class=normal> 721</span>
<span class=normal> 722</span>
<span class=normal> 723</span>
<span class=normal> 724</span>
<span class=normal> 725</span>
<span class=normal> 726</span>
<span class=normal> 727</span>
<span class=normal> 728</span>
<span class=normal> 729</span>
<span class=normal> 730</span>
<span class=normal> 731</span>
<span class=normal> 732</span>
<span class=normal> 733</span>
<span class=normal> 734</span>
<span class=normal> 735</span>
<span class=normal> 736</span>
<span class=normal> 737</span>
<span class=normal> 738</span>
<span class=normal> 739</span>
<span class=normal> 740</span>
<span class=normal> 741</span>
<span class=normal> 742</span>
<span class=normal> 743</span>
<span class=normal> 744</span>
<span class=normal> 745</span>
<span class=normal> 746</span>
<span class=normal> 747</span>
<span class=normal> 748</span>
<span class=normal> 749</span>
<span class=normal> 750</span>
<span class=normal> 751</span>
<span class=normal> 752</span>
<span class=normal> 753</span>
<span class=normal> 754</span>
<span class=normal> 755</span>
<span class=normal> 756</span>
<span class=normal> 757</span>
<span class=normal> 758</span>
<span class=normal> 759</span>
<span class=normal> 760</span>
<span class=normal> 761</span>
<span class=normal> 762</span>
<span class=normal> 763</span>
<span class=normal> 764</span>
<span class=normal> 765</span>
<span class=normal> 766</span>
<span class=normal> 767</span>
<span class=normal> 768</span>
<span class=normal> 769</span>
<span class=normal> 770</span>
<span class=normal> 771</span>
<span class=normal> 772</span>
<span class=normal> 773</span>
<span class=normal> 774</span>
<span class=normal> 775</span>
<span class=normal> 776</span>
<span class=normal> 777</span>
<span class=normal> 778</span>
<span class=normal> 779</span>
<span class=normal> 780</span>
<span class=normal> 781</span>
<span class=normal> 782</span>
<span class=normal> 783</span>
<span class=normal> 784</span>
<span class=normal> 785</span>
<span class=normal> 786</span>
<span class=normal> 787</span>
<span class=normal> 788</span>
<span class=normal> 789</span>
<span class=normal> 790</span>
<span class=normal> 791</span>
<span class=normal> 792</span>
<span class=normal> 793</span>
<span class=normal> 794</span>
<span class=normal> 795</span>
<span class=normal> 796</span>
<span class=normal> 797</span>
<span class=normal> 798</span>
<span class=normal> 799</span>
<span class=normal> 800</span>
<span class=normal> 801</span>
<span class=normal> 802</span>
<span class=normal> 803</span>
<span class=normal> 804</span>
<span class=normal> 805</span>
<span class=normal> 806</span>
<span class=normal> 807</span>
<span class=normal> 808</span>
<span class=normal> 809</span>
<span class=normal> 810</span>
<span class=normal> 811</span>
<span class=normal> 812</span>
<span class=normal> 813</span>
<span class=normal> 814</span>
<span class=normal> 815</span>
<span class=normal> 816</span>
<span class=normal> 817</span>
<span class=normal> 818</span>
<span class=normal> 819</span>
<span class=normal> 820</span>
<span class=normal> 821</span>
<span class=normal> 822</span>
<span class=normal> 823</span>
<span class=normal> 824</span>
<span class=normal> 825</span>
<span class=normal> 826</span>
<span class=normal> 827</span>
<span class=normal> 828</span>
<span class=normal> 829</span>
<span class=normal> 830</span>
<span class=normal> 831</span>
<span class=normal> 832</span>
<span class=normal> 833</span>
<span class=normal> 834</span>
<span class=normal> 835</span>
<span class=normal> 836</span>
<span class=normal> 837</span>
<span class=normal> 838</span>
<span class=normal> 839</span>
<span class=normal> 840</span>
<span class=normal> 841</span>
<span class=normal> 842</span>
<span class=normal> 843</span>
<span class=normal> 844</span>
<span class=normal> 845</span>
<span class=normal> 846</span>
<span class=normal> 847</span>
<span class=normal> 848</span>
<span class=normal> 849</span>
<span class=normal> 850</span>
<span class=normal> 851</span>
<span class=normal> 852</span>
<span class=normal> 853</span>
<span class=normal> 854</span>
<span class=normal> 855</span>
<span class=normal> 856</span>
<span class=normal> 857</span>
<span class=normal> 858</span>
<span class=normal> 859</span>
<span class=normal> 860</span>
<span class=normal> 861</span>
<span class=normal> 862</span>
<span class=normal> 863</span>
<span class=normal> 864</span>
<span class=normal> 865</span>
<span class=normal> 866</span>
<span class=normal> 867</span>
<span class=normal> 868</span>
<span class=normal> 869</span>
<span class=normal> 870</span>
<span class=normal> 871</span>
<span class=normal> 872</span>
<span class=normal> 873</span>
<span class=normal> 874</span>
<span class=normal> 875</span>
<span class=normal> 876</span>
<span class=normal> 877</span>
<span class=normal> 878</span>
<span class=normal> 879</span>
<span class=normal> 880</span>
<span class=normal> 881</span>
<span class=normal> 882</span>
<span class=normal> 883</span>
<span class=normal> 884</span>
<span class=normal> 885</span>
<span class=normal> 886</span>
<span class=normal> 887</span>
<span class=normal> 888</span>
<span class=normal> 889</span>
<span class=normal> 890</span>
<span class=normal> 891</span>
<span class=normal> 892</span>
<span class=normal> 893</span>
<span class=normal> 894</span>
<span class=normal> 895</span>
<span class=normal> 896</span>
<span class=normal> 897</span>
<span class=normal> 898</span>
<span class=normal> 899</span>
<span class=normal> 900</span>
<span class=normal> 901</span>
<span class=normal> 902</span>
<span class=normal> 903</span>
<span class=normal> 904</span>
<span class=normal> 905</span>
<span class=normal> 906</span>
<span class=normal> 907</span>
<span class=normal> 908</span>
<span class=normal> 909</span>
<span class=normal> 910</span>
<span class=normal> 911</span>
<span class=normal> 912</span>
<span class=normal> 913</span>
<span class=normal> 914</span>
<span class=normal> 915</span>
<span class=normal> 916</span>
<span class=normal> 917</span>
<span class=normal> 918</span>
<span class=normal> 919</span>
<span class=normal> 920</span>
<span class=normal> 921</span>
<span class=normal> 922</span>
<span class=normal> 923</span>
<span class=normal> 924</span>
<span class=normal> 925</span>
<span class=normal> 926</span>
<span class=normal> 927</span>
<span class=normal> 928</span>
<span class=normal> 929</span>
<span class=normal> 930</span>
<span class=normal> 931</span>
<span class=normal> 932</span>
<span class=normal> 933</span>
<span class=normal> 934</span>
<span class=normal> 935</span>
<span class=normal> 936</span>
<span class=normal> 937</span>
<span class=normal> 938</span>
<span class=normal> 939</span>
<span class=normal> 940</span>
<span class=normal> 941</span>
<span class=normal> 942</span>
<span class=normal> 943</span>
<span class=normal> 944</span>
<span class=normal> 945</span>
<span class=normal> 946</span>
<span class=normal> 947</span>
<span class=normal> 948</span>
<span class=normal> 949</span>
<span class=normal> 950</span>
<span class=normal> 951</span>
<span class=normal> 952</span>
<span class=normal> 953</span>
<span class=normal> 954</span>
<span class=normal> 955</span>
<span class=normal> 956</span>
<span class=normal> 957</span>
<span class=normal> 958</span>
<span class=normal> 959</span>
<span class=normal> 960</span>
<span class=normal> 961</span>
<span class=normal> 962</span>
<span class=normal> 963</span>
<span class=normal> 964</span>
<span class=normal> 965</span>
<span class=normal> 966</span>
<span class=normal> 967</span>
<span class=normal> 968</span>
<span class=normal> 969</span>
<span class=normal> 970</span>
<span class=normal> 971</span>
<span class=normal> 972</span>
<span class=normal> 973</span>
<span class=normal> 974</span>
<span class=normal> 975</span>
<span class=normal> 976</span>
<span class=normal> 977</span>
<span class=normal> 978</span>
<span class=normal> 979</span>
<span class=normal> 980</span>
<span class=normal> 981</span>
<span class=normal> 982</span>
<span class=normal> 983</span>
<span class=normal> 984</span>
<span class=normal> 985</span>
<span class=normal> 986</span>
<span class=normal> 987</span>
<span class=normal> 988</span>
<span class=normal> 989</span>
<span class=normal> 990</span>
<span class=normal> 991</span>
<span class=normal> 992</span>
<span class=normal> 993</span>
<span class=normal> 994</span>
<span class=normal> 995</span>
<span class=normal> 996</span>
<span class=normal> 997</span>
<span class=normal> 998</span>
<span class=normal> 999</span>
<span class=normal>1000</span>
<span class=normal>1001</span>
<span class=normal>1002</span>
<span class=normal>1003</span>
<span class=normal>1004</span>
<span class=normal>1005</span>
<span class=normal>1006</span>
<span class=normal>1007</span>
<span class=normal>1008</span>
<span class=normal>1009</span>
<span class=normal>1010</span>
<span class=normal>1011</span>
<span class=normal>1012</span>
<span class=normal>1013</span>
<span class=normal>1014</span>
<span class=normal>1015</span>
<span class=normal>1016</span>
<span class=normal>1017</span>
<span class=normal>1018</span>
<span class=normal>1019</span>
<span class=normal>1020</span>
<span class=normal>1021</span>
<span class=normal>1022</span>
<span class=normal>1023</span>
<span class=normal>1024</span>
<span class=normal>1025</span>
<span class=normal>1026</span>
<span class=normal>1027</span>
<span class=normal>1028</span>
<span class=normal>1029</span>
<span class=normal>1030</span>
<span class=normal>1031</span>
<span class=normal>1032</span>
<span class=normal>1033</span>
<span class=normal>1034</span>
<span class=normal>1035</span>
<span class=normal>1036</span>
<span class=normal>1037</span>
<span class=normal>1038</span>
<span class=normal>1039</span>
<span class=normal>1040</span>
<span class=normal>1041</span>
<span class=normal>1042</span>
<span class=normal>1043</span>
<span class=normal>1044</span>
<span class=normal>1045</span>
<span class=normal>1046</span>
<span class=normal>1047</span>
<span class=normal>1048</span>
<span class=normal>1049</span>
<span class=normal>1050</span>
<span class=normal>1051</span>
<span class=normal>1052</span>
<span class=normal>1053</span>
<span class=normal>1054</span>
<span class=normal>1055</span>
<span class=normal>1056</span>
<span class=normal>1057</span>
<span class=normal>1058</span>
<span class=normal>1059</span>
<span class=normal>1060</span>
<span class=normal>1061</span>
<span class=normal>1062</span>
<span class=normal>1063</span>
<span class=normal>1064</span>
<span class=normal>1065</span>
<span class=normal>1066</span>
<span class=normal>1067</span>
<span class=normal>1068</span>
<span class=normal>1069</span>
<span class=normal>1070</span>
<span class=normal>1071</span>
<span class=normal>1072</span>
<span class=normal>1073</span>
<span class=normal>1074</span>
<span class=normal>1075</span>
<span class=normal>1076</span>
<span class=normal>1077</span>
<span class=normal>1078</span>
<span class=normal>1079</span>
<span class=normal>1080</span>
<span class=normal>1081</span>
<span class=normal>1082</span>
<span class=normal>1083</span>
<span class=normal>1084</span>
<span class=normal>1085</span>
<span class=normal>1086</span>
<span class=normal>1087</span>
<span class=normal>1088</span>
<span class=normal>1089</span>
<span class=normal>1090</span>
<span class=normal>1091</span>
<span class=normal>1092</span>
<span class=normal>1093</span>
<span class=normal>1094</span>
<span class=normal>1095</span>
<span class=normal>1096</span>
<span class=normal>1097</span>
<span class=normal>1098</span>
<span class=normal>1099</span>
<span class=normal>1100</span>
<span class=normal>1101</span>
<span class=normal>1102</span>
<span class=normal>1103</span>
<span class=normal>1104</span>
<span class=normal>1105</span>
<span class=normal>1106</span>
<span class=normal>1107</span>
<span class=normal>1108</span>
<span class=normal>1109</span>
<span class=normal>1110</span>
<span class=normal>1111</span>
<span class=normal>1112</span>
<span class=normal>1113</span>
<span class=normal>1114</span>
<span class=normal>1115</span>
<span class=normal>1116</span>
<span class=normal>1117</span>
<span class=normal>1118</span>
<span class=normal>1119</span>
<span class=normal>1120</span>
<span class=normal>1121</span>
<span class=normal>1122</span>
<span class=normal>1123</span>
<span class=normal>1124</span>
<span class=normal>1125</span>
<span class=normal>1126</span>
<span class=normal>1127</span>
<span class=normal>1128</span>
<span class=normal>1129</span>
<span class=normal>1130</span>
<span class=normal>1131</span>
<span class=normal>1132</span>
<span class=normal>1133</span>
<span class=normal>1134</span>
<span class=normal>1135</span>
<span class=normal>1136</span>
<span class=normal>1137</span>
<span class=normal>1138</span>
<span class=normal>1139</span>
<span class=normal>1140</span>
<span class=normal>1141</span>
<span class=normal>1142</span>
<span class=normal>1143</span>
<span class=normal>1144</span>
<span class=normal>1145</span>
<span class=normal>1146</span>
<span class=normal>1147</span>
<span class=normal>1148</span>
<span class=normal>1149</span>
<span class=normal>1150</span>
<span class=normal>1151</span>
<span class=normal>1152</span>
<span class=normal>1153</span>
<span class=normal>1154</span>
<span class=normal>1155</span>
<span class=normal>1156</span>
<span class=normal>1157</span>
<span class=normal>1158</span>
<span class=normal>1159</span>
<span class=normal>1160</span>
<span class=normal>1161</span>
<span class=normal>1162</span>
<span class=normal>1163</span>
<span class=normal>1164</span>
<span class=normal>1165</span>
<span class=normal>1166</span>
<span class=normal>1167</span>
<span class=normal>1168</span>
<span class=normal>1169</span>
<span class=normal>1170</span>
<span class=normal>1171</span>
<span class=normal>1172</span>
<span class=normal>1173</span>
<span class=normal>1174</span>
<span class=normal>1175</span>
<span class=normal>1176</span>
<span class=normal>1177</span>
<span class=normal>1178</span>
<span class=normal>1179</span>
<span class=normal>1180</span>
<span class=normal>1181</span>
<span class=normal>1182</span>
<span class=normal>1183</span>
<span class=normal>1184</span>
<span class=normal>1185</span>
<span class=normal>1186</span>
<span class=normal>1187</span>
<span class=normal>1188</span>
<span class=normal>1189</span>
<span class=normal>1190</span>
<span class=normal>1191</span>
<span class=normal>1192</span>
<span class=normal>1193</span>
<span class=normal>1194</span>
<span class=normal>1195</span>
<span class=normal>1196</span>
<span class=normal>1197</span>
<span class=normal>1198</span>
<span class=normal>1199</span>
<span class=normal>1200</span>
<span class=normal>1201</span>
<span class=normal>1202</span>
<span class=normal>1203</span>
<span class=normal>1204</span>
<span class=normal>1205</span>
<span class=normal>1206</span>
<span class=normal>1207</span>
<span class=normal>1208</span>
<span class=normal>1209</span>
<span class=normal>1210</span>
<span class=normal>1211</span>
<span class=normal>1212</span>
<span class=normal>1213</span>
<span class=normal>1214</span>
<span class=normal>1215</span>
<span class=normal>1216</span>
<span class=normal>1217</span>
<span class=normal>1218</span>
<span class=normal>1219</span>
<span class=normal>1220</span>
<span class=normal>1221</span>
<span class=normal>1222</span>
<span class=normal>1223</span>
<span class=normal>1224</span>
<span class=normal>1225</span>
<span class=normal>1226</span>
<span class=normal>1227</span>
<span class=normal>1228</span>
<span class=normal>1229</span>
<span class=normal>1230</span>
<span class=normal>1231</span>
<span class=normal>1232</span>
<span class=normal>1233</span>
<span class=normal>1234</span>
<span class=normal>1235</span>
<span class=normal>1236</span>
<span class=normal>1237</span>
<span class=normal>1238</span>
<span class=normal>1239</span>
<span class=normal>1240</span>
<span class=normal>1241</span>
<span class=normal>1242</span>
<span class=normal>1243</span>
<span class=normal>1244</span>
<span class=normal>1245</span>
<span class=normal>1246</span>
<span class=normal>1247</span>
<span class=normal>1248</span>
<span class=normal>1249</span>
<span class=normal>1250</span>
<span class=normal>1251</span>
<span class=normal>1252</span>
<span class=normal>1253</span>
<span class=normal>1254</span>
<span class=normal>1255</span>
<span class=normal>1256</span>
<span class=normal>1257</span>
<span class=normal>1258</span>
<span class=normal>1259</span>
<span class=normal>1260</span>
<span class=normal>1261</span>
<span class=normal>1262</span>
<span class=normal>1263</span>
<span class=normal>1264</span>
<span class=normal>1265</span>
<span class=normal>1266</span>
<span class=normal>1267</span>
<span class=normal>1268</span>
<span class=normal>1269</span>
<span class=normal>1270</span>
<span class=normal>1271</span>
<span class=normal>1272</span>
<span class=normal>1273</span>
<span class=normal>1274</span>
<span class=normal>1275</span>
<span class=normal>1276</span>
<span class=normal>1277</span>
<span class=normal>1278</span>
<span class=normal>1279</span>
<span class=normal>1280</span>
<span class=normal>1281</span>
<span class=normal>1282</span>
<span class=normal>1283</span>
<span class=normal>1284</span>
<span class=normal>1285</span>
<span class=normal>1286</span>
<span class=normal>1287</span>
<span class=normal>1288</span>
<span class=normal>1289</span>
<span class=normal>1290</span>
<span class=normal>1291</span>
<span class=normal>1292</span>
<span class=normal>1293</span>
<span class=normal>1294</span>
<span class=normal>1295</span>
<span class=normal>1296</span>
<span class=normal>1297</span>
<span class=normal>1298</span>
<span class=normal>1299</span>
<span class=normal>1300</span>
<span class=normal>1301</span>
<span class=normal>1302</span>
<span class=normal>1303</span>
<span class=normal>1304</span>
<span class=normal>1305</span>
<span class=normal>1306</span>
<span class=normal>1307</span>
<span class=normal>1308</span>
<span class=normal>1309</span>
<span class=normal>1310</span>
<span class=normal>1311</span>
<span class=normal>1312</span>
<span class=normal>1313</span>
<span class=normal>1314</span>
<span class=normal>1315</span>
<span class=normal>1316</span>
<span class=normal>1317</span>
<span class=normal>1318</span>
<span class=normal>1319</span>
<span class=normal>1320</span>
<span class=normal>1321</span>
<span class=normal>1322</span>
<span class=normal>1323</span>
<span class=normal>1324</span>
<span class=normal>1325</span>
<span class=normal>1326</span>
<span class=normal>1327</span>
<span class=normal>1328</span>
<span class=normal>1329</span>
<span class=normal>1330</span>
<span class=normal>1331</span>
<span class=normal>1332</span>
<span class=normal>1333</span>
<span class=normal>1334</span>
<span class=normal>1335</span>
<span class=normal>1336</span>
<span class=normal>1337</span>
<span class=normal>1338</span>
<span class=normal>1339</span>
<span class=normal>1340</span>
<span class=normal>1341</span>
<span class=normal>1342</span>
<span class=normal>1343</span>
<span class=normal>1344</span>
<span class=normal>1345</span>
<span class=normal>1346</span>
<span class=normal>1347</span>
<span class=normal>1348</span>
<span class=normal>1349</span>
<span class=normal>1350</span>
<span class=normal>1351</span>
<span class=normal>1352</span>
<span class=normal>1353</span>
<span class=normal>1354</span>
<span class=normal>1355</span>
<span class=normal>1356</span>
<span class=normal>1357</span>
<span class=normal>1358</span>
<span class=normal>1359</span>
<span class=normal>1360</span>
<span class=normal>1361</span>
<span class=normal>1362</span>
<span class=normal>1363</span>
<span class=normal>1364</span>
<span class=normal>1365</span>
<span class=normal>1366</span>
<span class=normal>1367</span>
<span class=normal>1368</span>
<span class=normal>1369</span>
<span class=normal>1370</span>
<span class=normal>1371</span>
<span class=normal>1372</span>
<span class=normal>1373</span>
<span class=normal>1374</span>
<span class=normal>1375</span>
<span class=normal>1376</span>
<span class=normal>1377</span>
<span class=normal>1378</span>
<span class=normal>1379</span>
<span class=normal>1380</span>
<span class=normal>1381</span>
<span class=normal>1382</span>
<span class=normal>1383</span>
<span class=normal>1384</span>
<span class=normal>1385</span>
<span class=normal>1386</span>
<span class=normal>1387</span>
<span class=normal>1388</span>
<span class=normal>1389</span>
<span class=normal>1390</span>
<span class=normal>1391</span>
<span class=normal>1392</span>
<span class=normal>1393</span>
<span class=normal>1394</span>
<span class=normal>1395</span>
<span class=normal>1396</span>
<span class=normal>1397</span>
<span class=normal>1398</span>
<span class=normal>1399</span>
<span class=normal>1400</span>
<span class=normal>1401</span>
<span class=normal>1402</span>
<span class=normal>1403</span>
<span class=normal>1404</span>
<span class=normal>1405</span>
<span class=normal>1406</span>
<span class=normal>1407</span>
<span class=normal>1408</span>
<span class=normal>1409</span>
<span class=normal>1410</span>
<span class=normal>1411</span>
<span class=normal>1412</span>
<span class=normal>1413</span>
<span class=normal>1414</span>
<span class=normal>1415</span>
<span class=normal>1416</span>
<span class=normal>1417</span>
<span class=normal>1418</span>
<span class=normal>1419</span>
<span class=normal>1420</span>
<span class=normal>1421</span>
<span class=normal>1422</span>
<span class=normal>1423</span>
<span class=normal>1424</span>
<span class=normal>1425</span>
<span class=normal>1426</span>
<span class=normal>1427</span>
<span class=normal>1428</span>
<span class=normal>1429</span>
<span class=normal>1430</span>
<span class=normal>1431</span>
<span class=normal>1432</span>
<span class=normal>1433</span>
<span class=normal>1434</span>
<span class=normal>1435</span>
<span class=normal>1436</span>
<span class=normal>1437</span>
<span class=normal>1438</span>
<span class=normal>1439</span>
<span class=normal>1440</span>
<span class=normal>1441</span>
<span class=normal>1442</span>
<span class=normal>1443</span>
<span class=normal>1444</span>
<span class=normal>1445</span>
<span class=normal>1446</span>
<span class=normal>1447</span>
<span class=normal>1448</span>
<span class=normal>1449</span>
<span class=normal>1450</span>
<span class=normal>1451</span>
<span class=normal>1452</span>
<span class=normal>1453</span>
<span class=normal>1454</span>
<span class=normal>1455</span>
<span class=normal>1456</span>
<span class=normal>1457</span>
<span class=normal>1458</span>
<span class=normal>1459</span>
<span class=normal>1460</span>
<span class=normal>1461</span>
<span class=normal>1462</span>
<span class=normal>1463</span>
<span class=normal>1464</span>
<span class=normal>1465</span>
<span class=normal>1466</span>
<span class=normal>1467</span>
<span class=normal>1468</span>
<span class=normal>1469</span>
<span class=normal>1470</span>
<span class=normal>1471</span>
<span class=normal>1472</span>
<span class=normal>1473</span>
<span class=normal>1474</span>
<span class=normal>1475</span>
<span class=normal>1476</span>
<span class=normal>1477</span>
<span class=normal>1478</span>
<span class=normal>1479</span>
<span class=normal>1480</span>
<span class=normal>1481</span>
<span class=normal>1482</span>
<span class=normal>1483</span>
<span class=normal>1484</span>
<span class=normal>1485</span>
<span class=normal>1486</span>
<span class=normal>1487</span>
<span class=normal>1488</span>
<span class=normal>1489</span>
<span class=normal>1490</span>
<span class=normal>1491</span>
<span class=normal>1492</span>
<span class=normal>1493</span>
<span class=normal>1494</span>
<span class=normal>1495</span>
<span class=normal>1496</span>
<span class=normal>1497</span>
<span class=normal>1498</span>
<span class=normal>1499</span>
<span class=normal>1500</span>
<span class=normal>1501</span>
<span class=normal>1502</span>
<span class=normal>1503</span>
<span class=normal>1504</span>
<span class=normal>1505</span>
<span class=normal>1506</span>
<span class=normal>1507</span>
<span class=normal>1508</span>
<span class=normal>1509</span>
<span class=normal>1510</span>
<span class=normal>1511</span>
<span class=normal>1512</span>
<span class=normal>1513</span>
<span class=normal>1514</span>
<span class=normal>1515</span>
<span class=normal>1516</span>
<span class=normal>1517</span>
<span class=normal>1518</span>
<span class=normal>1519</span>
<span class=normal>1520</span>
<span class=normal>1521</span>
<span class=normal>1522</span>
<span class=normal>1523</span>
<span class=normal>1524</span>
<span class=normal>1525</span>
<span class=normal>1526</span>
<span class=normal>1527</span>
<span class=normal>1528</span>
<span class=normal>1529</span>
<span class=normal>1530</span>
<span class=normal>1531</span>
<span class=normal>1532</span>
<span class=normal>1533</span>
<span class=normal>1534</span>
<span class=normal>1535</span>
<span class=normal>1536</span>
<span class=normal>1537</span>
<span class=normal>1538</span>
<span class=normal>1539</span>
<span class=normal>1540</span>
<span class=normal>1541</span>
<span class=normal>1542</span>
<span class=normal>1543</span>
<span class=normal>1544</span>
<span class=normal>1545</span>
<span class=normal>1546</span>
<span class=normal>1547</span>
<span class=normal>1548</span>
<span class=normal>1549</span>
<span class=normal>1550</span>
<span class=normal>1551</span>
<span class=normal>1552</span>
<span class=normal>1553</span>
<span class=normal>1554</span>
<span class=normal>1555</span>
<span class=normal>1556</span>
<span class=normal>1557</span>
<span class=normal>1558</span>
<span class=normal>1559</span>
<span class=normal>1560</span>
<span class=normal>1561</span>
<span class=normal>1562</span>
<span class=normal>1563</span>
<span class=normal>1564</span>
<span class=normal>1565</span>
<span class=normal>1566</span>
<span class=normal>1567</span>
<span class=normal>1568</span>
<span class=normal>1569</span>
<span class=normal>1570</span>
<span class=normal>1571</span>
<span class=normal>1572</span>
<span class=normal>1573</span>
<span class=normal>1574</span>
<span class=normal>1575</span>
<span class=normal>1576</span>
<span class=normal>1577</span>
<span class=normal>1578</span>
<span class=normal>1579</span>
<span class=normal>1580</span>
<span class=normal>1581</span>
<span class=normal>1582</span>
<span class=normal>1583</span>
<span class=normal>1584</span>
<span class=normal>1585</span>
<span class=normal>1586</span>
<span class=normal>1587</span>
<span class=normal>1588</span>
<span class=normal>1589</span>
<span class=normal>1590</span>
<span class=normal>1591</span>
<span class=normal>1592</span>
<span class=normal>1593</span>
<span class=normal>1594</span>
<span class=normal>1595</span>
<span class=normal>1596</span>
<span class=normal>1597</span>
<span class=normal>1598</span>
<span class=normal>1599</span>
<span class=normal>1600</span>
<span class=normal>1601</span>
<span class=normal>1602</span>
<span class=normal>1603</span>
<span class=normal>1604</span>
<span class=normal>1605</span>
<span class=normal>1606</span>
<span class=normal>1607</span>
<span class=normal>1608</span>
<span class=normal>1609</span>
<span class=normal>1610</span>
<span class=normal>1611</span>
<span class=normal>1612</span>
<span class=normal>1613</span>
<span class=normal>1614</span>
<span class=normal>1615</span>
<span class=normal>1616</span>
<span class=normal>1617</span>
<span class=normal>1618</span>
<span class=normal>1619</span>
<span class=normal>1620</span>
<span class=normal>1621</span>
<span class=normal>1622</span>
<span class=normal>1623</span>
<span class=normal>1624</span>
<span class=normal>1625</span>
<span class=normal>1626</span>
<span class=normal>1627</span>
<span class=normal>1628</span>
<span class=normal>1629</span>
<span class=normal>1630</span>
<span class=normal>1631</span>
<span class=normal>1632</span>
<span class=normal>1633</span>
<span class=normal>1634</span>
<span class=normal>1635</span>
<span class=normal>1636</span>
<span class=normal>1637</span>
<span class=normal>1638</span>
<span class=normal>1639</span>
<span class=normal>1640</span>
<span class=normal>1641</span>
<span class=normal>1642</span>
<span class=normal>1643</span>
<span class=normal>1644</span>
<span class=normal>1645</span>
<span class=normal>1646</span>
<span class=normal>1647</span>
<span class=normal>1648</span>
<span class=normal>1649</span>
<span class=normal>1650</span>
<span class=normal>1651</span>
<span class=normal>1652</span>
<span class=normal>1653</span>
<span class=normal>1654</span>
<span class=normal>1655</span>
<span class=normal>1656</span>
<span class=normal>1657</span>
<span class=normal>1658</span>
<span class=normal>1659</span>
<span class=normal>1660</span>
<span class=normal>1661</span>
<span class=normal>1662</span>
<span class=normal>1663</span>
<span class=normal>1664</span>
<span class=normal>1665</span>
<span class=normal>1666</span>
<span class=normal>1667</span>
<span class=normal>1668</span>
<span class=normal>1669</span>
<span class=normal>1670</span>
<span class=normal>1671</span>
<span class=normal>1672</span>
<span class=normal>1673</span>
<span class=normal>1674</span>
<span class=normal>1675</span>
<span class=normal>1676</span>
<span class=normal>1677</span>
<span class=normal>1678</span>
<span class=normal>1679</span>
<span class=normal>1680</span>
<span class=normal>1681</span>
<span class=normal>1682</span>
<span class=normal>1683</span>
<span class=normal>1684</span>
<span class=normal>1685</span>
<span class=normal>1686</span>
<span class=normal>1687</span>
<span class=normal>1688</span>
<span class=normal>1689</span>
<span class=normal>1690</span>
<span class=normal>1691</span>
<span class=normal>1692</span>
<span class=normal>1693</span>
<span class=normal>1694</span>
<span class=normal>1695</span>
<span class=normal>1696</span>
<span class=normal>1697</span>
<span class=normal>1698</span>
<span class=normal>1699</span>
<span class=normal>1700</span>
<span class=normal>1701</span>
<span class=normal>1702</span>
<span class=normal>1703</span>
<span class=normal>1704</span>
<span class=normal>1705</span>
<span class=normal>1706</span>
<span class=normal>1707</span>
<span class=normal>1708</span>
<span class=normal>1709</span>
<span class=normal>1710</span>
<span class=normal>1711</span>
<span class=normal>1712</span>
<span class=normal>1713</span>
<span class=normal>1714</span>
<span class=normal>1715</span>
<span class=normal>1716</span>
<span class=normal>1717</span>
<span class=normal>1718</span>
<span class=normal>1719</span>
<span class=normal>1720</span>
<span class=normal>1721</span>
<span class=normal>1722</span>
<span class=normal>1723</span>
<span class=normal>1724</span>
<span class=normal>1725</span>
<span class=normal>1726</span>
<span class=normal>1727</span>
<span class=normal>1728</span>
<span class=normal>1729</span>
<span class=normal>1730</span>
<span class=normal>1731</span>
<span class=normal>1732</span>
<span class=normal>1733</span>
<span class=normal>1734</span>
<span class=normal>1735</span>
<span class=normal>1736</span>
<span class=normal>1737</span>
<span class=normal>1738</span>
<span class=normal>1739</span>
<span class=normal>1740</span>
<span class=normal>1741</span>
<span class=normal>1742</span>
<span class=normal>1743</span>
<span class=normal>1744</span>
<span class=normal>1745</span>
<span class=normal>1746</span>
<span class=normal>1747</span>
<span class=normal>1748</span>
<span class=normal>1749</span>
<span class=normal>1750</span>
<span class=normal>1751</span>
<span class=normal>1752</span>
<span class=normal>1753</span>
<span class=normal>1754</span>
<span class=normal>1755</span>
<span class=normal>1756</span>
<span class=normal>1757</span>
<span class=normal>1758</span>
<span class=normal>1759</span>
<span class=normal>1760</span>
<span class=normal>1761</span>
<span class=normal>1762</span>
<span class=normal>1763</span>
<span class=normal>1764</span>
<span class=normal>1765</span>
<span class=normal>1766</span>
<span class=normal>1767</span>
<span class=normal>1768</span>
<span class=normal>1769</span>
<span class=normal>1770</span>
<span class=normal>1771</span>
<span class=normal>1772</span>
<span class=normal>1773</span>
<span class=normal>1774</span>
<span class=normal>1775</span>
<span class=normal>1776</span>
<span class=normal>1777</span>
<span class=normal>1778</span>
<span class=normal>1779</span>
<span class=normal>1780</span>
<span class=normal>1781</span>
<span class=normal>1782</span>
<span class=normal>1783</span>
<span class=normal>1784</span>
<span class=normal>1785</span>
<span class=normal>1786</span>
<span class=normal>1787</span>
<span class=normal>1788</span>
<span class=normal>1789</span>
<span class=normal>1790</span>
<span class=normal>1791</span>
<span class=normal>1792</span>
<span class=normal>1793</span>
<span class=normal>1794</span>
<span class=normal>1795</span>
<span class=normal>1796</span>
<span class=normal>1797</span>
<span class=normal>1798</span>
<span class=normal>1799</span>
<span class=normal>1800</span>
<span class=normal>1801</span>
<span class=normal>1802</span>
<span class=normal>1803</span>
<span class=normal>1804</span>
<span class=normal>1805</span>
<span class=normal>1806</span>
<span class=normal>1807</span>
<span class=normal>1808</span>
<span class=normal>1809</span>
<span class=normal>1810</span>
<span class=normal>1811</span>
<span class=normal>1812</span>
<span class=normal>1813</span>
<span class=normal>1814</span>
<span class=normal>1815</span>
<span class=normal>1816</span>
<span class=normal>1817</span>
<span class=normal>1818</span>
<span class=normal>1819</span>
<span class=normal>1820</span>
<span class=normal>1821</span>
<span class=normal>1822</span>
<span class=normal>1823</span>
<span class=normal>1824</span>
<span class=normal>1825</span>
<span class=normal>1826</span>
<span class=normal>1827</span>
<span class=normal>1828</span>
<span class=normal>1829</span>
<span class=normal>1830</span>
<span class=normal>1831</span>
<span class=normal>1832</span>
<span class=normal>1833</span>
<span class=normal>1834</span>
<span class=normal>1835</span>
<span class=normal>1836</span>
<span class=normal>1837</span>
<span class=normal>1838</span>
<span class=normal>1839</span>
<span class=normal>1840</span>
<span class=normal>1841</span>
<span class=normal>1842</span>
<span class=normal>1843</span>
<span class=normal>1844</span>
<span class=normal>1845</span>
<span class=normal>1846</span>
<span class=normal>1847</span>
<span class=normal>1848</span>
<span class=normal>1849</span>
<span class=normal>1850</span>
<span class=normal>1851</span>
<span class=normal>1852</span>
<span class=normal>1853</span>
<span class=normal>1854</span>
<span class=normal>1855</span>
<span class=normal>1856</span>
<span class=normal>1857</span>
<span class=normal>1858</span>
<span class=normal>1859</span>
<span class=normal>1860</span>
<span class=normal>1861</span>
<span class=normal>1862</span>
<span class=normal>1863</span>
<span class=normal>1864</span>
<span class=normal>1865</span>
<span class=normal>1866</span>
<span class=normal>1867</span>
<span class=normal>1868</span>
<span class=normal>1869</span>
<span class=normal>1870</span>
<span class=normal>1871</span>
<span class=normal>1872</span>
<span class=normal>1873</span>
<span class=normal>1874</span>
<span class=normal>1875</span>
<span class=normal>1876</span>
<span class=normal>1877</span>
<span class=normal>1878</span>
<span class=normal>1879</span>
<span class=normal>1880</span>
<span class=normal>1881</span>
<span class=normal>1882</span>
<span class=normal>1883</span>
<span class=normal>1884</span>
<span class=normal>1885</span>
<span class=normal>1886</span>
<span class=normal>1887</span>
<span class=normal>1888</span>
<span class=normal>1889</span>
<span class=normal>1890</span>
<span class=normal>1891</span>
<span class=normal>1892</span>
<span class=normal>1893</span>
<span class=normal>1894</span>
<span class=normal>1895</span>
<span class=normal>1896</span>
<span class=normal>1897</span>
<span class=normal>1898</span>
<span class=normal>1899</span>
<span class=normal>1900</span>
<span class=normal>1901</span>
<span class=normal>1902</span>
<span class=normal>1903</span>
<span class=normal>1904</span>
<span class=normal>1905</span>
<span class=normal>1906</span>
<span class=normal>1907</span>
<span class=normal>1908</span>
<span class=normal>1909</span>
<span class=normal>1910</span>
<span class=normal>1911</span>
<span class=normal>1912</span>
<span class=normal>1913</span>
<span class=normal>1914</span>
<span class=normal>1915</span>
<span class=normal>1916</span>
<span class=normal>1917</span>
<span class=normal>1918</span>
<span class=normal>1919</span>
<span class=normal>1920</span>
<span class=normal>1921</span>
<span class=normal>1922</span>
<span class=normal>1923</span>
<span class=normal>1924</span>
<span class=normal>1925</span>
<span class=normal>1926</span>
<span class=normal>1927</span>
<span class=normal>1928</span>
<span class=normal>1929</span>
<span class=normal>1930</span>
<span class=normal>1931</span>
<span class=normal>1932</span>
<span class=normal>1933</span>
<span class=normal>1934</span>
<span class=normal>1935</span>
<span class=normal>1936</span>
<span class=normal>1937</span>
<span class=normal>1938</span>
<span class=normal>1939</span>
<span class=normal>1940</span>
<span class=normal>1941</span>
<span class=normal>1942</span>
<span class=normal>1943</span>
<span class=normal>1944</span>
<span class=normal>1945</span>
<span class=normal>1946</span>
<span class=normal>1947</span>
<span class=normal>1948</span>
<span class=normal>1949</span>
<span class=normal>1950</span>
<span class=normal>1951</span>
<span class=normal>1952</span>
<span class=normal>1953</span>
<span class=normal>1954</span>
<span class=normal>1955</span>
<span class=normal>1956</span>
<span class=normal>1957</span>
<span class=normal>1958</span>
<span class=normal>1959</span>
<span class=normal>1960</span>
<span class=normal>1961</span>
<span class=normal>1962</span>
<span class=normal>1963</span>
<span class=normal>1964</span>
<span class=normal>1965</span>
<span class=normal>1966</span>
<span class=normal>1967</span>
<span class=normal>1968</span>
<span class=normal>1969</span>
<span class=normal>1970</span>
<span class=normal>1971</span>
<span class=normal>1972</span>
<span class=normal>1973</span>
<span class=normal>1974</span>
<span class=normal>1975</span>
<span class=normal>1976</span>
<span class=normal>1977</span>
<span class=normal>1978</span>
<span class=normal>1979</span>
<span class=normal>1980</span>
<span class=normal>1981</span>
<span class=normal>1982</span>
<span class=normal>1983</span>
<span class=normal>1984</span>
<span class=normal>1985</span>
<span class=normal>1986</span>
<span class=normal>1987</span>
<span class=normal>1988</span>
<span class=normal>1989</span>
<span class=normal>1990</span>
<span class=normal>1991</span>
<span class=normal>1992</span>
<span class=normal>1993</span>
<span class=normal>1994</span>
<span class=normal>1995</span>
<span class=normal>1996</span>
<span class=normal>1997</span>
<span class=normal>1998</span>
<span class=normal>1999</span>
<span class=normal>2000</span>
<span class=normal>2001</span>
<span class=normal>2002</span>
<span class=normal>2003</span>
<span class=normal>2004</span>
<span class=normal>2005</span>
<span class=normal>2006</span>
<span class=normal>2007</span>
<span class=normal>2008</span>
<span class=normal>2009</span>
<span class=normal>2010</span>
<span class=normal>2011</span>
<span class=normal>2012</span>
<span class=normal>2013</span>
<span class=normal>2014</span>
<span class=normal>2015</span>
<span class=normal>2016</span>
<span class=normal>2017</span>
<span class=normal>2018</span>
<span class=normal>2019</span>
<span class=normal>2020</span>
<span class=normal>2021</span>
<span class=normal>2022</span>
<span class=normal>2023</span>
<span class=normal>2024</span>
<span class=normal>2025</span>
<span class=normal>2026</span>
<span class=normal>2027</span>
<span class=normal>2028</span>
<span class=normal>2029</span>
<span class=normal>2030</span>
<span class=normal>2031</span>
<span class=normal>2032</span>
<span class=normal>2033</span>
<span class=normal>2034</span>
<span class=normal>2035</span>
<span class=normal>2036</span>
<span class=normal>2037</span>
<span class=normal>2038</span>
<span class=normal>2039</span>
<span class=normal>2040</span>
<span class=normal>2041</span>
<span class=normal>2042</span>
<span class=normal>2043</span>
<span class=normal>2044</span>
<span class=normal>2045</span>
<span class=normal>2046</span>
<span class=normal>2047</span>
<span class=normal>2048</span>
<span class=normal>2049</span>
<span class=normal>2050</span>
<span class=normal>2051</span>
<span class=normal>2052</span>
<span class=normal>2053</span>
<span class=normal>2054</span>
<span class=normal>2055</span>
<span class=normal>2056</span>
<span class=normal>2057</span>
<span class=normal>2058</span>
<span class=normal>2059</span>
<span class=normal>2060</span>
<span class=normal>2061</span>
<span class=normal>2062</span>
<span class=normal>2063</span>
<span class=normal>2064</span>
<span class=normal>2065</span>
<span class=normal>2066</span>
<span class=normal>2067</span>
<span class=normal>2068</span>
<span class=normal>2069</span>
<span class=normal>2070</span>
<span class=normal>2071</span>
<span class=normal>2072</span>
<span class=normal>2073</span>
<span class=normal>2074</span>
<span class=normal>2075</span>
<span class=normal>2076</span>
<span class=normal>2077</span>
<span class=normal>2078</span>
<span class=normal>2079</span>
<span class=normal>2080</span>
<span class=normal>2081</span>
<span class=normal>2082</span>
<span class=normal>2083</span>
<span class=normal>2084</span>
<span class=normal>2085</span>
<span class=normal>2086</span>
<span class=normal>2087</span>
<span class=normal>2088</span>
<span class=normal>2089</span>
<span class=normal>2090</span>
<span class=normal>2091</span>
<span class=normal>2092</span>
<span class=normal>2093</span>
<span class=normal>2094</span>
<span class=normal>2095</span>
<span class=normal>2096</span>
<span class=normal>2097</span>
<span class=normal>2098</span>
<span class=normal>2099</span>
<span class=normal>2100</span>
<span class=normal>2101</span>
<span class=normal>2102</span>
<span class=normal>2103</span>
<span class=normal>2104</span>
<span class=normal>2105</span>
<span class=normal>2106</span>
<span class=normal>2107</span>
<span class=normal>2108</span>
<span class=normal>2109</span>
<span class=normal>2110</span>
<span class=normal>2111</span>
<span class=normal>2112</span>
<span class=normal>2113</span>
<span class=normal>2114</span>
<span class=normal>2115</span>
<span class=normal>2116</span>
<span class=normal>2117</span>
<span class=normal>2118</span>
<span class=normal>2119</span>
<span class=normal>2120</span>
<span class=normal>2121</span>
<span class=normal>2122</span>
<span class=normal>2123</span>
<span class=normal>2124</span>
<span class=normal>2125</span>
<span class=normal>2126</span>
<span class=normal>2127</span>
<span class=normal>2128</span>
<span class=normal>2129</span>
<span class=normal>2130</span>
<span class=normal>2131</span>
<span class=normal>2132</span>
<span class=normal>2133</span>
<span class=normal>2134</span>
<span class=normal>2135</span>
<span class=normal>2136</span>
<span class=normal>2137</span>
<span class=normal>2138</span>
<span class=normal>2139</span>
<span class=normal>2140</span>
<span class=normal>2141</span>
<span class=normal>2142</span>
<span class=normal>2143</span>
<span class=normal>2144</span>
<span class=normal>2145</span>
<span class=normal>2146</span>
<span class=normal>2147</span>
<span class=normal>2148</span>
<span class=normal>2149</span>
<span class=normal>2150</span>
<span class=normal>2151</span>
<span class=normal>2152</span>
<span class=normal>2153</span>
<span class=normal>2154</span>
<span class=normal>2155</span>
<span class=normal>2156</span>
<span class=normal>2157</span>
<span class=normal>2158</span>
<span class=normal>2159</span>
<span class=normal>2160</span>
<span class=normal>2161</span>
<span class=normal>2162</span>
<span class=normal>2163</span>
<span class=normal>2164</span>
<span class=normal>2165</span>
<span class=normal>2166</span>
<span class=normal>2167</span>
<span class=normal>2168</span>
<span class=normal>2169</span>
<span class=normal>2170</span>
<span class=normal>2171</span>
<span class=normal>2172</span>
<span class=normal>2173</span>
<span class=normal>2174</span>
<span class=normal>2175</span>
<span class=normal>2176</span>
<span class=normal>2177</span>
<span class=normal>2178</span>
<span class=normal>2179</span>
<span class=normal>2180</span>
<span class=normal>2181</span>
<span class=normal>2182</span>
<span class=normal>2183</span>
<span class=normal>2184</span>
<span class=normal>2185</span>
<span class=normal>2186</span>
<span class=normal>2187</span>
<span class=normal>2188</span>
<span class=normal>2189</span>
<span class=normal>2190</span>
<span class=normal>2191</span>
<span class=normal>2192</span>
<span class=normal>2193</span>
<span class=normal>2194</span>
<span class=normal>2195</span>
<span class=normal>2196</span>
<span class=normal>2197</span>
<span class=normal>2198</span>
<span class=normal>2199</span>
<span class=normal>2200</span>
<span class=normal>2201</span>
<span class=normal>2202</span>
<span class=normal>2203</span>
<span class=normal>2204</span>
<span class=normal>2205</span>
<span class=normal>2206</span>
<span class=normal>2207</span>
<span class=normal>2208</span>
<span class=normal>2209</span>
<span class=normal>2210</span>
<span class=normal>2211</span>
<span class=normal>2212</span>
<span class=normal>2213</span>
<span class=normal>2214</span>
<span class=normal>2215</span>
<span class=normal>2216</span>
<span class=normal>2217</span>
<span class=normal>2218</span>
<span class=normal>2219</span>
<span class=normal>2220</span>
<span class=normal>2221</span>
<span class=normal>2222</span>
<span class=normal>2223</span>
<span class=normal>2224</span>
<span class=normal>2225</span>
<span class=normal>2226</span>
<span class=normal>2227</span>
<span class=normal>2228</span>
<span class=normal>2229</span>
<span class=normal>2230</span>
<span class=normal>2231</span>
<span class=normal>2232</span>
<span class=normal>2233</span>
<span class=normal>2234</span>
<span class=normal>2235</span>
<span class=normal>2236</span>
<span class=normal>2237</span>
<span class=normal>2238</span>
<span class=normal>2239</span>
<span class=normal>2240</span>
<span class=normal>2241</span>
<span class=normal>2242</span>
<span class=normal>2243</span>
<span class=normal>2244</span>
<span class=normal>2245</span>
<span class=normal>2246</span>
<span class=normal>2247</span>
<span class=normal>2248</span>
<span class=normal>2249</span>
<span class=normal>2250</span>
<span class=normal>2251</span>
<span class=normal>2252</span>
<span class=normal>2253</span>
<span class=normal>2254</span>
<span class=normal>2255</span>
<span class=normal>2256</span>
<span class=normal>2257</span>
<span class=normal>2258</span>
<span class=normal>2259</span>
<span class=normal>2260</span>
<span class=normal>2261</span>
<span class=normal>2262</span>
<span class=normal>2263</span>
<span class=normal>2264</span>
<span class=normal>2265</span>
<span class=normal>2266</span>
<span class=normal>2267</span>
<span class=normal>2268</span>
<span class=normal>2269</span>
<span class=normal>2270</span>
<span class=normal>2271</span>
<span class=normal>2272</span>
<span class=normal>2273</span>
<span class=normal>2274</span>
<span class=normal>2275</span>
<span class=normal>2276</span>
<span class=normal>2277</span>
<span class=normal>2278</span>
<span class=normal>2279</span>
<span class=normal>2280</span>
<span class=normal>2281</span>
<span class=normal>2282</span>
<span class=normal>2283</span>
<span class=normal>2284</span>
<span class=normal>2285</span>
<span class=normal>2286</span>
<span class=normal>2287</span>
<span class=normal>2288</span>
<span class=normal>2289</span>
<span class=normal>2290</span>
<span class=normal>2291</span>
<span class=normal>2292</span>
<span class=normal>2293</span>
<span class=normal>2294</span>
<span class=normal>2295</span>
<span class=normal>2296</span>
<span class=normal>2297</span>
<span class=normal>2298</span>
<span class=normal>2299</span>
<span class=normal>2300</span>
<span class=normal>2301</span>
<span class=normal>2302</span>
<span class=normal>2303</span>
<span class=normal>2304</span>
<span class=normal>2305</span>
<span class=normal>2306</span>
<span class=normal>2307</span>
<span class=normal>2308</span>
<span class=normal>2309</span>
<span class=normal>2310</span>
<span class=normal>2311</span>
<span class=normal>2312</span>
<span class=normal>2313</span>
<span class=normal>2314</span>
<span class=normal>2315</span>
<span class=normal>2316</span>
<span class=normal>2317</span>
<span class=normal>2318</span>
<span class=normal>2319</span>
<span class=normal>2320</span>
<span class=normal>2321</span>
<span class=normal>2322</span>
<span class=normal>2323</span>
<span class=normal>2324</span>
<span class=normal>2325</span>
<span class=normal>2326</span>
<span class=normal>2327</span>
<span class=normal>2328</span>
<span class=normal>2329</span>
<span class=normal>2330</span>
<span class=normal>2331</span>
<span class=normal>2332</span>
<span class=normal>2333</span>
<span class=normal>2334</span>
<span class=normal>2335</span>
<span class=normal>2336</span>
<span class=normal>2337</span>
<span class=normal>2338</span>
<span class=normal>2339</span>
<span class=normal>2340</span>
<span class=normal>2341</span>
<span class=normal>2342</span>
<span class=normal>2343</span>
<span class=normal>2344</span>
<span class=normal>2345</span>
<span class=normal>2346</span>
<span class=normal>2347</span>
<span class=normal>2348</span>
<span class=normal>2349</span>
<span class=normal>2350</span>
<span class=normal>2351</span>
<span class=normal>2352</span>
<span class=normal>2353</span>
<span class=normal>2354</span>
<span class=normal>2355</span>
<span class=normal>2356</span>
<span class=normal>2357</span>
<span class=normal>2358</span>
<span class=normal>2359</span>
<span class=normal>2360</span>
<span class=normal>2361</span>
<span class=normal>2362</span>
<span class=normal>2363</span>
<span class=normal>2364</span>
<span class=normal>2365</span>
<span class=normal>2366</span>
<span class=normal>2367</span>
<span class=normal>2368</span>
<span class=normal>2369</span>
<span class=normal>2370</span>
<span class=normal>2371</span>
<span class=normal>2372</span>
<span class=normal>2373</span>
<span class=normal>2374</span>
<span class=normal>2375</span>
<span class=normal>2376</span>
<span class=normal>2377</span>
<span class=normal>2378</span>
<span class=normal>2379</span>
<span class=normal>2380</span>
<span class=normal>2381</span>
<span class=normal>2382</span>
<span class=normal>2383</span>
<span class=normal>2384</span>
<span class=normal>2385</span>
<span class=normal>2386</span>
<span class=normal>2387</span>
<span class=normal>2388</span>
<span class=normal>2389</span>
<span class=normal>2390</span>
<span class=normal>2391</span>
<span class=normal>2392</span>
<span class=normal>2393</span>
<span class=normal>2394</span>
<span class=normal>2395</span>
<span class=normal>2396</span>
<span class=normal>2397</span>
<span class=normal>2398</span>
<span class=normal>2399</span>
<span class=normal>2400</span>
<span class=normal>2401</span>
<span class=normal>2402</span>
<span class=normal>2403</span>
<span class=normal>2404</span>
<span class=normal>2405</span>
<span class=normal>2406</span>
<span class=normal>2407</span>
<span class=normal>2408</span>
<span class=normal>2409</span>
<span class=normal>2410</span>
<span class=normal>2411</span>
<span class=normal>2412</span>
<span class=normal>2413</span>
<span class=normal>2414</span>
<span class=normal>2415</span>
<span class=normal>2416</span>
<span class=normal>2417</span>
<span class=normal>2418</span>
<span class=normal>2419</span>
<span class=normal>2420</span>
<span class=normal>2421</span>
<span class=normal>2422</span>
<span class=normal>2423</span>
<span class=normal>2424</span>
<span class=normal>2425</span>
<span class=normal>2426</span>
<span class=normal>2427</span>
<span class=normal>2428</span>
<span class=normal>2429</span>
<span class=normal>2430</span>
<span class=normal>2431</span>
<span class=normal>2432</span>
<span class=normal>2433</span>
<span class=normal>2434</span>
<span class=normal>2435</span>
<span class=normal>2436</span>
<span class=normal>2437</span>
<span class=normal>2438</span>
<span class=normal>2439</span>
<span class=normal>2440</span>
<span class=normal>2441</span>
<span class=normal>2442</span>
<span class=normal>2443</span>
<span class=normal>2444</span>
<span class=normal>2445</span>
<span class=normal>2446</span>
<span class=normal>2447</span>
<span class=normal>2448</span>
<span class=normal>2449</span>
<span class=normal>2450</span>
<span class=normal>2451</span>
<span class=normal>2452</span>
<span class=normal>2453</span>
<span class=normal>2454</span>
<span class=normal>2455</span>
<span class=normal>2456</span>
<span class=normal>2457</span>
<span class=normal>2458</span>
<span class=normal>2459</span>
<span class=normal>2460</span>
<span class=normal>2461</span>
<span class=normal>2462</span>
<span class=normal>2463</span>
<span class=normal>2464</span>
<span class=normal>2465</span>
<span class=normal>2466</span>
<span class=normal>2467</span>
<span class=normal>2468</span>
<span class=normal>2469</span>
<span class=normal>2470</span>
<span class=normal>2471</span>
<span class=normal>2472</span>
<span class=normal>2473</span>
<span class=normal>2474</span>
<span class=normal>2475</span>
<span class=normal>2476</span>
<span class=normal>2477</span>
<span class=normal>2478</span>
<span class=normal>2479</span>
<span class=normal>2480</span>
<span class=normal>2481</span>
<span class=normal>2482</span>
<span class=normal>2483</span>
<span class=normal>2484</span>
<span class=normal>2485</span>
<span class=normal>2486</span>
<span class=normal>2487</span>
<span class=normal>2488</span>
<span class=normal>2489</span>
<span class=normal>2490</span>
<span class=normal>2491</span>
<span class=normal>2492</span>
<span class=normal>2493</span>
<span class=normal>2494</span>
<span class=normal>2495</span>
<span class=normal>2496</span>
<span class=normal>2497</span>
<span class=normal>2498</span>
<span class=normal>2499</span>
<span class=normal>2500</span>
<span class=normal>2501</span>
<span class=normal>2502</span>
<span class=normal>2503</span>
<span class=normal>2504</span>
<span class=normal>2505</span>
<span class=normal>2506</span>
<span class=normal>2507</span>
<span class=normal>2508</span>
<span class=normal>2509</span>
<span class=normal>2510</span>
<span class=normal>2511</span>
<span class=normal>2512</span>
<span class=normal>2513</span>
<span class=normal>2514</span>
<span class=normal>2515</span>
<span class=normal>2516</span>
<span class=normal>2517</span>
<span class=normal>2518</span>
<span class=normal>2519</span>
<span class=normal>2520</span>
<span class=normal>2521</span>
<span class=normal>2522</span>
<span class=normal>2523</span>
<span class=normal>2524</span>
<span class=normal>2525</span>
<span class=normal>2526</span>
<span class=normal>2527</span>
<span class=normal>2528</span>
<span class=normal>2529</span>
<span class=normal>2530</span>
<span class=normal>2531</span>
<span class=normal>2532</span>
<span class=normal>2533</span>
<span class=normal>2534</span>
<span class=normal>2535</span>
<span class=normal>2536</span>
<span class=normal>2537</span>
<span class=normal>2538</span>
<span class=normal>2539</span>
<span class=normal>2540</span>
<span class=normal>2541</span>
<span class=normal>2542</span>
<span class=normal>2543</span>
<span class=normal>2544</span>
<span class=normal>2545</span>
<span class=normal>2546</span>
<span class=normal>2547</span>
<span class=normal>2548</span>
<span class=normal>2549</span>
<span class=normal>2550</span>
<span class=normal>2551</span>
<span class=normal>2552</span>
<span class=normal>2553</span>
<span class=normal>2554</span>
<span class=normal>2555</span>
<span class=normal>2556</span>
<span class=normal>2557</span>
<span class=normal>2558</span>
<span class=normal>2559</span>
<span class=normal>2560</span>
<span class=normal>2561</span>
<span class=normal>2562</span>
<span class=normal>2563</span>
<span class=normal>2564</span>
<span class=normal>2565</span>
<span class=normal>2566</span>
<span class=normal>2567</span>
<span class=normal>2568</span>
<span class=normal>2569</span>
<span class=normal>2570</span>
<span class=normal>2571</span>
<span class=normal>2572</span>
<span class=normal>2573</span>
<span class=normal>2574</span>
<span class=normal>2575</span>
<span class=normal>2576</span>
<span class=normal>2577</span>
<span class=normal>2578</span>
<span class=normal>2579</span>
<span class=normal>2580</span>
<span class=normal>2581</span>
<span class=normal>2582</span>
<span class=normal>2583</span>
<span class=normal>2584</span>
<span class=normal>2585</span>
<span class=normal>2586</span>
<span class=normal>2587</span>
<span class=normal>2588</span>
<span class=normal>2589</span>
<span class=normal>2590</span>
<span class=normal>2591</span>
<span class=normal>2592</span>
<span class=normal>2593</span>
<span class=normal>2594</span>
<span class=normal>2595</span>
<span class=normal>2596</span>
<span class=normal>2597</span>
<span class=normal>2598</span>
<span class=normal>2599</span>
<span class=normal>2600</span>
<span class=normal>2601</span>
<span class=normal>2602</span>
<span class=normal>2603</span>
<span class=normal>2604</span>
<span class=normal>2605</span>
<span class=normal>2606</span>
<span class=normal>2607</span>
<span class=normal>2608</span>
<span class=normal>2609</span>
<span class=normal>2610</span>
<span class=normal>2611</span>
<span class=normal>2612</span>
<span class=normal>2613</span>
<span class=normal>2614</span>
<span class=normal>2615</span>
<span class=normal>2616</span>
<span class=normal>2617</span>
<span class=normal>2618</span>
<span class=normal>2619</span>
<span class=normal>2620</span>
<span class=normal>2621</span>
<span class=normal>2622</span>
<span class=normal>2623</span>
<span class=normal>2624</span>
<span class=normal>2625</span>
<span class=normal>2626</span>
<span class=normal>2627</span>
<span class=normal>2628</span>
<span class=normal>2629</span>
<span class=normal>2630</span>
<span class=normal>2631</span>
<span class=normal>2632</span>
<span class=normal>2633</span>
<span class=normal>2634</span>
<span class=normal>2635</span>
<span class=normal>2636</span>
<span class=normal>2637</span>
<span class=normal>2638</span>
<span class=normal>2639</span>
<span class=normal>2640</span>
<span class=normal>2641</span>
<span class=normal>2642</span>
<span class=normal>2643</span>
<span class=normal>2644</span>
<span class=normal>2645</span>
<span class=normal>2646</span>
<span class=normal>2647</span>
<span class=normal>2648</span>
<span class=normal>2649</span>
<span class=normal>2650</span>
<span class=normal>2651</span>
<span class=normal>2652</span>
<span class=normal>2653</span>
<span class=normal>2654</span>
<span class=normal>2655</span>
<span class=normal>2656</span>
<span class=normal>2657</span>
<span class=normal>2658</span>
<span class=normal>2659</span>
<span class=normal>2660</span>
<span class=normal>2661</span>
<span class=normal>2662</span>
<span class=normal>2663</span>
<span class=normal>2664</span>
<span class=normal>2665</span>
<span class=normal>2666</span>
<span class=normal>2667</span>
<span class=normal>2668</span>
<span class=normal>2669</span>
<span class=normal>2670</span>
<span class=normal>2671</span>
<span class=normal>2672</span>
<span class=normal>2673</span>
<span class=normal>2674</span>
<span class=normal>2675</span>
<span class=normal>2676</span>
<span class=normal>2677</span>
<span class=normal>2678</span>
<span class=normal>2679</span>
<span class=normal>2680</span>
<span class=normal>2681</span>
<span class=normal>2682</span>
<span class=normal>2683</span>
<span class=normal>2684</span>
<span class=normal>2685</span>
<span class=normal>2686</span>
<span class=normal>2687</span>
<span class=normal>2688</span>
<span class=normal>2689</span>
<span class=normal>2690</span>
<span class=normal>2691</span>
<span class=normal>2692</span>
<span class=normal>2693</span>
<span class=normal>2694</span>
<span class=normal>2695</span>
<span class=normal>2696</span>
<span class=normal>2697</span>
<span class=normal>2698</span>
<span class=normal>2699</span>
<span class=normal>2700</span>
<span class=normal>2701</span>
<span class=normal>2702</span>
<span class=normal>2703</span>
<span class=normal>2704</span>
<span class=normal>2705</span>
<span class=normal>2706</span>
<span class=normal>2707</span>
<span class=normal>2708</span>
<span class=normal>2709</span>
<span class=normal>2710</span>
<span class=normal>2711</span>
<span class=normal>2712</span>
<span class=normal>2713</span>
<span class=normal>2714</span>
<span class=normal>2715</span>
<span class=normal>2716</span>
<span class=normal>2717</span>
<span class=normal>2718</span>
<span class=normal>2719</span>
<span class=normal>2720</span>
<span class=normal>2721</span>
<span class=normal>2722</span>
<span class=normal>2723</span>
<span class=normal>2724</span>
<span class=normal>2725</span>
<span class=normal>2726</span>
<span class=normal>2727</span>
<span class=normal>2728</span>
<span class=normal>2729</span>
<span class=normal>2730</span>
<span class=normal>2731</span>
<span class=normal>2732</span>
<span class=normal>2733</span>
<span class=normal>2734</span>
<span class=normal>2735</span>
<span class=normal>2736</span>
<span class=normal>2737</span>
<span class=normal>2738</span>
<span class=normal>2739</span>
<span class=normal>2740</span>
<span class=normal>2741</span>
<span class=normal>2742</span>
<span class=normal>2743</span>
<span class=normal>2744</span>
<span class=normal>2745</span>
<span class=normal>2746</span>
<span class=normal>2747</span>
<span class=normal>2748</span>
<span class=normal>2749</span>
<span class=normal>2750</span>
<span class=normal>2751</span>
<span class=normal>2752</span>
<span class=normal>2753</span>
<span class=normal>2754</span>
<span class=normal>2755</span>
<span class=normal>2756</span>
<span class=normal>2757</span>
<span class=normal>2758</span>
<span class=normal>2759</span>
<span class=normal>2760</span>
<span class=normal>2761</span>
<span class=normal>2762</span>
<span class=normal>2763</span>
<span class=normal>2764</span>
<span class=normal>2765</span>
<span class=normal>2766</span>
<span class=normal>2767</span>
<span class=normal>2768</span>
<span class=normal>2769</span>
<span class=normal>2770</span>
<span class=normal>2771</span>
<span class=normal>2772</span>
<span class=normal>2773</span>
<span class=normal>2774</span>
<span class=normal>2775</span>
<span class=normal>2776</span>
<span class=normal>2777</span>
<span class=normal>2778</span>
<span class=normal>2779</span>
<span class=normal>2780</span>
<span class=normal>2781</span>
<span class=normal>2782</span>
<span class=normal>2783</span>
<span class=normal>2784</span>
<span class=normal>2785</span>
<span class=normal>2786</span>
<span class=normal>2787</span>
<span class=normal>2788</span>
<span class=normal>2789</span>
<span class=normal>2790</span>
<span class=normal>2791</span>
<span class=normal>2792</span>
<span class=normal>2793</span>
<span class=normal>2794</span>
<span class=normal>2795</span>
<span class=normal>2796</span>
<span class=normal>2797</span>
<span class=normal>2798</span>
<span class=normal>2799</span>
<span class=normal>2800</span>
<span class=normal>2801</span>
<span class=normal>2802</span>
<span class=normal>2803</span>
<span class=normal>2804</span>
<span class=normal>2805</span>
<span class=normal>2806</span>
<span class=normal>2807</span>
<span class=normal>2808</span>
<span class=normal>2809</span>
<span class=normal>2810</span>
<span class=normal>2811</span>
<span class=normal>2812</span>
<span class=normal>2813</span>
<span class=normal>2814</span>
<span class=normal>2815</span>
<span class=normal>2816</span>
<span class=normal>2817</span>
<span class=normal>2818</span>
<span class=normal>2819</span>
<span class=normal>2820</span>
<span class=normal>2821</span>
<span class=normal>2822</span>
<span class=normal>2823</span>
<span class=normal>2824</span>
<span class=normal>2825</span>
<span class=normal>2826</span>
<span class=normal>2827</span>
<span class=normal>2828</span>
<span class=normal>2829</span>
<span class=normal>2830</span>
<span class=normal>2831</span>
<span class=normal>2832</span>
<span class=normal>2833</span>
<span class=normal>2834</span>
<span class=normal>2835</span>
<span class=normal>2836</span>
<span class=normal>2837</span>
<span class=normal>2838</span>
<span class=normal>2839</span>
<span class=normal>2840</span>
<span class=normal>2841</span>
<span class=normal>2842</span>
<span class=normal>2843</span>
<span class=normal>2844</span>
<span class=normal>2845</span>
<span class=normal>2846</span>
<span class=normal>2847</span>
<span class=normal>2848</span>
<span class=normal>2849</span>
<span class=normal>2850</span>
<span class=normal>2851</span>
<span class=normal>2852</span>
<span class=normal>2853</span>
<span class=normal>2854</span>
<span class=normal>2855</span>
<span class=normal>2856</span>
<span class=normal>2857</span>
<span class=normal>2858</span>
<span class=normal>2859</span>
<span class=normal>2860</span>
<span class=normal>2861</span>
<span class=normal>2862</span>
<span class=normal>2863</span>
<span class=normal>2864</span>
<span class=normal>2865</span>
<span class=normal>2866</span>
<span class=normal>2867</span>
<span class=normal>2868</span>
<span class=normal>2869</span>
<span class=normal>2870</span>
<span class=normal>2871</span>
<span class=normal>2872</span>
<span class=normal>2873</span>
<span class=normal>2874</span>
<span class=normal>2875</span>
<span class=normal>2876</span>
<span class=normal>2877</span>
<span class=normal>2878</span>
<span class=normal>2879</span>
<span class=normal>2880</span>
<span class=normal>2881</span>
<span class=normal>2882</span>
<span class=normal>2883</span>
<span class=normal>2884</span>
<span class=normal>2885</span>
<span class=normal>2886</span>
<span class=normal>2887</span>
<span class=normal>2888</span>
<span class=normal>2889</span>
<span class=normal>2890</span>
<span class=normal>2891</span>
<span class=normal>2892</span>
<span class=normal>2893</span>
<span class=normal>2894</span>
<span class=normal>2895</span>
<span class=normal>2896</span>
<span class=normal>2897</span>
<span class=normal>2898</span>
<span class=normal>2899</span>
<span class=normal>2900</span>
<span class=normal>2901</span>
<span class=normal>2902</span>
<span class=normal>2903</span>
<span class=normal>2904</span>
<span class=normal>2905</span>
<span class=normal>2906</span>
<span class=normal>2907</span>
<span class=normal>2908</span>
<span class=normal>2909</span>
<span class=normal>2910</span>
<span class=normal>2911</span>
<span class=normal>2912</span>
<span class=normal>2913</span>
<span class=normal>2914</span>
<span class=normal>2915</span>
<span class=normal>2916</span>
<span class=normal>2917</span>
<span class=normal>2918</span>
<span class=normal>2919</span>
<span class=normal>2920</span>
<span class=normal>2921</span>
<span class=normal>2922</span>
<span class=normal>2923</span>
<span class=normal>2924</span>
<span class=normal>2925</span>
<span class=normal>2926</span>
<span class=normal>2927</span>
<span class=normal>2928</span>
<span class=normal>2929</span>
<span class=normal>2930</span>
<span class=normal>2931</span>
<span class=normal>2932</span>
<span class=normal>2933</span>
<span class=normal>2934</span>
<span class=normal>2935</span>
<span class=normal>2936</span>
<span class=normal>2937</span>
<span class=normal>2938</span>
<span class=normal>2939</span>
<span class=normal>2940</span>
<span class=normal>2941</span>
<span class=normal>2942</span>
<span class=normal>2943</span>
<span class=normal>2944</span>
<span class=normal>2945</span>
<span class=normal>2946</span>
<span class=normal>2947</span>
<span class=normal>2948</span>
<span class=normal>2949</span>
<span class=normal>2950</span>
<span class=normal>2951</span>
<span class=normal>2952</span>
<span class=normal>2953</span>
<span class=normal>2954</span>
<span class=normal>2955</span>
<span class=normal>2956</span>
<span class=normal>2957</span>
<span class=normal>2958</span>
<span class=normal>2959</span>
<span class=normal>2960</span>
<span class=normal>2961</span>
<span class=normal>2962</span>
<span class=normal>2963</span>
<span class=normal>2964</span>
<span class=normal>2965</span>
<span class=normal>2966</span>
<span class=normal>2967</span>
<span class=normal>2968</span>
<span class=normal>2969</span>
<span class=normal>2970</span>
<span class=normal>2971</span>
<span class=normal>2972</span>
<span class=normal>2973</span>
<span class=normal>2974</span>
<span class=normal>2975</span>
<span class=normal>2976</span>
<span class=normal>2977</span>
<span class=normal>2978</span>
<span class=normal>2979</span>
<span class=normal>2980</span>
<span class=normal>2981</span>
<span class=normal>2982</span>
<span class=normal>2983</span>
<span class=normal>2984</span>
<span class=normal>2985</span>
<span class=normal>2986</span>
<span class=normal>2987</span>
<span class=normal>2988</span>
<span class=normal>2989</span>
<span class=normal>2990</span>
<span class=normal>2991</span>
<span class=normal>2992</span>
<span class=normal>2993</span>
<span class=normal>2994</span>
<span class=normal>2995</span>
<span class=normal>2996</span>
<span class=normal>2997</span>
<span class=normal>2998</span>
<span class=normal>2999</span>
<span class=normal>3000</span>
<span class=normal>3001</span>
<span class=normal>3002</span>
<span class=normal>3003</span>
<span class=normal>3004</span>
<span class=normal>3005</span>
<span class=normal>3006</span>
<span class=normal>3007</span>
<span class=normal>3008</span>
<span class=normal>3009</span>
<span class=normal>3010</span>
<span class=normal>3011</span>
<span class=normal>3012</span>
<span class=normal>3013</span>
<span class=normal>3014</span>
<span class=normal>3015</span>
<span class=normal>3016</span>
<span class=normal>3017</span>
<span class=normal>3018</span>
<span class=normal>3019</span>
<span class=normal>3020</span>
<span class=normal>3021</span>
<span class=normal>3022</span>
<span class=normal>3023</span>
<span class=normal>3024</span>
<span class=normal>3025</span>
<span class=normal>3026</span>
<span class=normal>3027</span>
<span class=normal>3028</span>
<span class=normal>3029</span>
<span class=normal>3030</span>
<span class=normal>3031</span>
<span class=normal>3032</span>
<span class=normal>3033</span>
<span class=normal>3034</span>
<span class=normal>3035</span>
<span class=normal>3036</span>
<span class=normal>3037</span>
<span class=normal>3038</span>
<span class=normal>3039</span>
<span class=normal>3040</span>
<span class=normal>3041</span>
<span class=normal>3042</span>
<span class=normal>3043</span>
<span class=normal>3044</span>
<span class=normal>3045</span>
<span class=normal>3046</span>
<span class=normal>3047</span>
<span class=normal>3048</span>
<span class=normal>3049</span>
<span class=normal>3050</span>
<span class=normal>3051</span>
<span class=normal>3052</span>
<span class=normal>3053</span>
<span class=normal>3054</span>
<span class=normal>3055</span>
<span class=normal>3056</span>
<span class=normal>3057</span>
<span class=normal>3058</span>
<span class=normal>3059</span>
<span class=normal>3060</span>
<span class=normal>3061</span>
<span class=normal>3062</span>
<span class=normal>3063</span>
<span class=normal>3064</span>
<span class=normal>3065</span>
<span class=normal>3066</span>
<span class=normal>3067</span>
<span class=normal>3068</span>
<span class=normal>3069</span>
<span class=normal>3070</span>
<span class=normal>3071</span>
<span class=normal>3072</span>
<span class=normal>3073</span>
<span class=normal>3074</span>
<span class=normal>3075</span>
<span class=normal>3076</span>
<span class=normal>3077</span>
<span class=normal>3078</span>
<span class=normal>3079</span>
<span class=normal>3080</span>
<span class=normal>3081</span>
<span class=normal>3082</span>
<span class=normal>3083</span>
<span class=normal>3084</span>
<span class=normal>3085</span>
<span class=normal>3086</span>
<span class=normal>3087</span>
<span class=normal>3088</span>
<span class=normal>3089</span>
<span class=normal>3090</span>
<span class=normal>3091</span>
<span class=normal>3092</span>
<span class=normal>3093</span>
<span class=normal>3094</span>
<span class=normal>3095</span>
<span class=normal>3096</span>
<span class=normal>3097</span>
<span class=normal>3098</span>
<span class=normal>3099</span>
<span class=normal>3100</span>
<span class=normal>3101</span>
<span class=normal>3102</span>
<span class=normal>3103</span>
<span class=normal>3104</span>
<span class=normal>3105</span>
<span class=normal>3106</span>
<span class=normal>3107</span>
<span class=normal>3108</span>
<span class=normal>3109</span>
<span class=normal>3110</span>
<span class=normal>3111</span>
<span class=normal>3112</span>
<span class=normal>3113</span>
<span class=normal>3114</span>
<span class=normal>3115</span>
<span class=normal>3116</span>
<span class=normal>3117</span>
<span class=normal>3118</span>
<span class=normal>3119</span>
<span class=normal>3120</span>
<span class=normal>3121</span>
<span class=normal>3122</span>
<span class=normal>3123</span>
<span class=normal>3124</span>
<span class=normal>3125</span>
<span class=normal>3126</span>
<span class=normal>3127</span>
<span class=normal>3128</span>
<span class=normal>3129</span>
<span class=normal>3130</span>
<span class=normal>3131</span>
<span class=normal>3132</span>
<span class=normal>3133</span>
<span class=normal>3134</span>
<span class=normal>3135</span>
<span class=normal>3136</span>
<span class=normal>3137</span>
<span class=normal>3138</span>
<span class=normal>3139</span>
<span class=normal>3140</span>
<span class=normal>3141</span>
<span class=normal>3142</span>
<span class=normal>3143</span>
<span class=normal>3144</span>
<span class=normal>3145</span>
<span class=normal>3146</span>
<span class=normal>3147</span>
<span class=normal>3148</span>
<span class=normal>3149</span>
<span class=normal>3150</span>
<span class=normal>3151</span>
<span class=normal>3152</span>
<span class=normal>3153</span>
<span class=normal>3154</span>
<span class=normal>3155</span>
<span class=normal>3156</span>
<span class=normal>3157</span>
<span class=normal>3158</span>
<span class=normal>3159</span>
<span class=normal>3160</span>
<span class=normal>3161</span>
<span class=normal>3162</span>
<span class=normal>3163</span>
<span class=normal>3164</span>
<span class=normal>3165</span>
<span class=normal>3166</span>
<span class=normal>3167</span>
<span class=normal>3168</span>
<span class=normal>3169</span>
<span class=normal>3170</span>
<span class=normal>3171</span>
<span class=normal>3172</span>
<span class=normal>3173</span>
<span class=normal>3174</span>
<span class=normal>3175</span>
<span class=normal>3176</span>
<span class=normal>3177</span>
<span class=normal>3178</span>
<span class=normal>3179</span>
<span class=normal>3180</span>
<span class=normal>3181</span>
<span class=normal>3182</span>
<span class=normal>3183</span>
<span class=normal>3184</span>
<span class=normal>3185</span>
<span class=normal>3186</span>
<span class=normal>3187</span>
<span class=normal>3188</span>
<span class=normal>3189</span>
<span class=normal>3190</span>
<span class=normal>3191</span>
<span class=normal>3192</span>
<span class=normal>3193</span>
<span class=normal>3194</span>
<span class=normal>3195</span>
<span class=normal>3196</span>
<span class=normal>3197</span>
<span class=normal>3198</span>
<span class=normal>3199</span>
<span class=normal>3200</span>
<span class=normal>3201</span>
<span class=normal>3202</span>
<span class=normal>3203</span>
<span class=normal>3204</span>
<span class=normal>3205</span>
<span class=normal>3206</span>
<span class=normal>3207</span>
<span class=normal>3208</span>
<span class=normal>3209</span>
<span class=normal>3210</span>
<span class=normal>3211</span>
<span class=normal>3212</span>
<span class=normal>3213</span>
<span class=normal>3214</span>
<span class=normal>3215</span>
<span class=normal>3216</span>
<span class=normal>3217</span>
<span class=normal>3218</span>
<span class=normal>3219</span>
<span class=normal>3220</span>
<span class=normal>3221</span>
<span class=normal>3222</span>
<span class=normal>3223</span>
<span class=normal>3224</span>
<span class=normal>3225</span>
<span class=normal>3226</span>
<span class=normal>3227</span>
<span class=normal>3228</span>
<span class=normal>3229</span>
<span class=normal>3230</span>
<span class=normal>3231</span>
<span class=normal>3232</span>
<span class=normal>3233</span>
<span class=normal>3234</span>
<span class=normal>3235</span>
<span class=normal>3236</span>
<span class=normal>3237</span>
<span class=normal>3238</span>
<span class=normal>3239</span>
<span class=normal>3240</span>
<span class=normal>3241</span>
<span class=normal>3242</span>
<span class=normal>3243</span>
<span class=normal>3244</span>
<span class=normal>3245</span>
<span class=normal>3246</span>
<span class=normal>3247</span>
<span class=normal>3248</span>
<span class=normal>3249</span>
<span class=normal>3250</span>
<span class=normal>3251</span>
<span class=normal>3252</span>
<span class=normal>3253</span>
<span class=normal>3254</span>
<span class=normal>3255</span>
<span class=normal>3256</span>
<span class=normal>3257</span>
<span class=normal>3258</span>
<span class=normal>3259</span>
<span class=normal>3260</span>
<span class=normal>3261</span>
<span class=normal>3262</span>
<span class=normal>3263</span>
<span class=normal>3264</span>
<span class=normal>3265</span>
<span class=normal>3266</span>
<span class=normal>3267</span>
<span class=normal>3268</span>
<span class=normal>3269</span>
<span class=normal>3270</span>
<span class=normal>3271</span>
<span class=normal>3272</span>
<span class=normal>3273</span>
<span class=normal>3274</span>
<span class=normal>3275</span>
<span class=normal>3276</span>
<span class=normal>3277</span>
<span class=normal>3278</span>
<span class=normal>3279</span>
<span class=normal>3280</span>
<span class=normal>3281</span>
<span class=normal>3282</span>
<span class=normal>3283</span>
<span class=normal>3284</span>
<span class=normal>3285</span>
<span class=normal>3286</span>
<span class=normal>3287</span>
<span class=normal>3288</span>
<span class=normal>3289</span>
<span class=normal>3290</span>
<span class=normal>3291</span>
<span class=normal>3292</span>
<span class=normal>3293</span>
<span class=normal>3294</span>
<span class=normal>3295</span>
<span class=normal>3296</span>
<span class=normal>3297</span>
<span class=normal>3298</span>
<span class=normal>3299</span>
<span class=normal>3300</span>
<span class=normal>3301</span>
<span class=normal>3302</span>
<span class=normal>3303</span>
<span class=normal>3304</span>
<span class=normal>3305</span>
<span class=normal>3306</span>
<span class=normal>3307</span>
<span class=normal>3308</span>
<span class=normal>3309</span>
<span class=normal>3310</span>
<span class=normal>3311</span>
<span class=normal>3312</span>
<span class=normal>3313</span>
<span class=normal>3314</span>
<span class=normal>3315</span>
<span class=normal>3316</span>
<span class=normal>3317</span>
<span class=normal>3318</span>
<span class=normal>3319</span>
<span class=normal>3320</span>
<span class=normal>3321</span>
<span class=normal>3322</span>
<span class=normal>3323</span>
<span class=normal>3324</span>
<span class=normal>3325</span>
<span class=normal>3326</span>
<span class=normal>3327</span>
<span class=normal>3328</span>
<span class=normal>3329</span>
<span class=normal>3330</span>
<span class=normal>3331</span>
<span class=normal>3332</span>
<span class=normal>3333</span>
<span class=normal>3334</span>
<span class=normal>3335</span>
<span class=normal>3336</span>
<span class=normal>3337</span>
<span class=normal>3338</span>
<span class=normal>3339</span>
<span class=normal>3340</span>
<span class=normal>3341</span>
<span class=normal>3342</span>
<span class=normal>3343</span>
<span class=normal>3344</span>
<span class=normal>3345</span>
<span class=normal>3346</span>
<span class=normal>3347</span>
<span class=normal>3348</span>
<span class=normal>3349</span>
<span class=normal>3350</span>
<span class=normal>3351</span>
<span class=normal>3352</span>
<span class=normal>3353</span>
<span class=normal>3354</span>
<span class=normal>3355</span>
<span class=normal>3356</span>
<span class=normal>3357</span>
<span class=normal>3358</span>
<span class=normal>3359</span>
<span class=normal>3360</span>
<span class=normal>3361</span>
<span class=normal>3362</span>
<span class=normal>3363</span>
<span class=normal>3364</span>
<span class=normal>3365</span>
<span class=normal>3366</span>
<span class=normal>3367</span>
<span class=normal>3368</span>
<span class=normal>3369</span>
<span class=normal>3370</span>
<span class=normal>3371</span>
<span class=normal>3372</span>
<span class=normal>3373</span>
<span class=normal>3374</span>
<span class=normal>3375</span>
<span class=normal>3376</span>
<span class=normal>3377</span>
<span class=normal>3378</span>
<span class=normal>3379</span>
<span class=normal>3380</span>
<span class=normal>3381</span>
<span class=normal>3382</span>
<span class=normal>3383</span>
<span class=normal>3384</span>
<span class=normal>3385</span>
<span class=normal>3386</span>
<span class=normal>3387</span>
<span class=normal>3388</span>
<span class=normal>3389</span>
<span class=normal>3390</span>
<span class=normal>3391</span>
<span class=normal>3392</span>
<span class=normal>3393</span>
<span class=normal>3394</span>
<span class=normal>3395</span>
<span class=normal>3396</span>
<span class=normal>3397</span>
<span class=normal>3398</span>
<span class=normal>3399</span>
<span class=normal>3400</span>
<span class=normal>3401</span>
<span class=normal>3402</span>
<span class=normal>3403</span>
<span class=normal>3404</span>
<span class=normal>3405</span>
<span class=normal>3406</span>
<span class=normal>3407</span>
<span class=normal>3408</span>
<span class=normal>3409</span>
<span class=normal>3410</span>
<span class=normal>3411</span>
<span class=normal>3412</span>
<span class=normal>3413</span>
<span class=normal>3414</span>
<span class=normal>3415</span>
<span class=normal>3416</span>
<span class=normal>3417</span>
<span class=normal>3418</span>
<span class=normal>3419</span>
<span class=normal>3420</span>
<span class=normal>3421</span>
<span class=normal>3422</span>
<span class=normal>3423</span>
<span class=normal>3424</span>
<span class=normal>3425</span>
<span class=normal>3426</span>
<span class=normal>3427</span>
<span class=normal>3428</span>
<span class=normal>3429</span>
<span class=normal>3430</span>
<span class=normal>3431</span>
<span class=normal>3432</span>
<span class=normal>3433</span>
<span class=normal>3434</span>
<span class=normal>3435</span>
<span class=normal>3436</span>
<span class=normal>3437</span>
<span class=normal>3438</span>
<span class=normal>3439</span>
<span class=normal>3440</span>
<span class=normal>3441</span>
<span class=normal>3442</span>
<span class=normal>3443</span>
<span class=normal>3444</span>
<span class=normal>3445</span>
<span class=normal>3446</span>
<span class=normal>3447</span>
<span class=normal>3448</span>
<span class=normal>3449</span>
<span class=normal>3450</span>
<span class=normal>3451</span>
<span class=normal>3452</span>
<span class=normal>3453</span>
<span class=normal>3454</span>
<span class=normal>3455</span>
<span class=normal>3456</span>
<span class=normal>3457</span>
<span class=normal>3458</span>
<span class=normal>3459</span>
<span class=normal>3460</span>
<span class=normal>3461</span>
<span class=normal>3462</span>
<span class=normal>3463</span>
<span class=normal>3464</span>
<span class=normal>3465</span>
<span class=normal>3466</span>
<span class=normal>3467</span>
<span class=normal>3468</span>
<span class=normal>3469</span>
<span class=normal>3470</span>
<span class=normal>3471</span>
<span class=normal>3472</span>
<span class=normal>3473</span>
<span class=normal>3474</span>
<span class=normal>3475</span>
<span class=normal>3476</span>
<span class=normal>3477</span>
<span class=normal>3478</span>
<span class=normal>3479</span>
<span class=normal>3480</span>
<span class=normal>3481</span>
<span class=normal>3482</span>
<span class=normal>3483</span>
<span class=normal>3484</span>
<span class=normal>3485</span>
<span class=normal>3486</span>
<span class=normal>3487</span>
<span class=normal>3488</span>
<span class=normal>3489</span>
<span class=normal>3490</span>
<span class=normal>3491</span>
<span class=normal>3492</span>
<span class=normal>3493</span>
<span class=normal>3494</span>
<span class=normal>3495</span>
<span class=normal>3496</span>
<span class=normal>3497</span>
<span class=normal>3498</span>
<span class=normal>3499</span>
<span class=normal>3500</span>
<span class=normal>3501</span>
<span class=normal>3502</span>
<span class=normal>3503</span>
<span class=normal>3504</span>
<span class=normal>3505</span>
<span class=normal>3506</span>
<span class=normal>3507</span>
<span class=normal>3508</span>
<span class=normal>3509</span>
<span class=normal>3510</span>
<span class=normal>3511</span>
<span class=normal>3512</span>
<span class=normal>3513</span>
<span class=normal>3514</span>
<span class=normal>3515</span>
<span class=normal>3516</span>
<span class=normal>3517</span>
<span class=normal>3518</span>
<span class=normal>3519</span>
<span class=normal>3520</span>
<span class=normal>3521</span>
<span class=normal>3522</span>
<span class=normal>3523</span>
<span class=normal>3524</span>
<span class=normal>3525</span>
<span class=normal>3526</span>
<span class=normal>3527</span>
<span class=normal>3528</span>
<span class=normal>3529</span>
<span class=normal>3530</span>
<span class=normal>3531</span>
<span class=normal>3532</span>
<span class=normal>3533</span>
<span class=normal>3534</span>
<span class=normal>3535</span>
<span class=normal>3536</span>
<span class=normal>3537</span>
<span class=normal>3538</span>
<span class=normal>3539</span>
<span class=normal>3540</span>
<span class=normal>3541</span>
<span class=normal>3542</span>
<span class=normal>3543</span>
<span class=normal>3544</span>
<span class=normal>3545</span>
<span class=normal>3546</span>
<span class=normal>3547</span>
<span class=normal>3548</span>
<span class=normal>3549</span>
<span class=normal>3550</span>
<span class=normal>3551</span>
<span class=normal>3552</span>
<span class=normal>3553</span>
<span class=normal>3554</span>
<span class=normal>3555</span>
<span class=normal>3556</span>
<span class=normal>3557</span>
<span class=normal>3558</span>
<span class=normal>3559</span>
<span class=normal>3560</span>
<span class=normal>3561</span>
<span class=normal>3562</span>
<span class=normal>3563</span>
<span class=normal>3564</span>
<span class=normal>3565</span>
<span class=normal>3566</span>
<span class=normal>3567</span>
<span class=normal>3568</span>
<span class=normal>3569</span>
<span class=normal>3570</span>
<span class=normal>3571</span>
<span class=normal>3572</span>
<span class=normal>3573</span>
<span class=normal>3574</span>
<span class=normal>3575</span>
<span class=normal>3576</span>
<span class=normal>3577</span>
<span class=normal>3578</span>
<span class=normal>3579</span>
<span class=normal>3580</span>
<span class=normal>3581</span>
<span class=normal>3582</span>
<span class=normal>3583</span>
<span class=normal>3584</span>
<span class=normal>3585</span>
<span class=normal>3586</span>
<span class=normal>3587</span>
<span class=normal>3588</span>
<span class=normal>3589</span>
<span class=normal>3590</span>
<span class=normal>3591</span>
<span class=normal>3592</span>
<span class=normal>3593</span>
<span class=normal>3594</span>
<span class=normal>3595</span>
<span class=normal>3596</span>
<span class=normal>3597</span>
<span class=normal>3598</span>
<span class=normal>3599</span>
<span class=normal>3600</span>
<span class=normal>3601</span>
<span class=normal>3602</span>
<span class=normal>3603</span>
<span class=normal>3604</span>
<span class=normal>3605</span>
<span class=normal>3606</span>
<span class=normal>3607</span>
<span class=normal>3608</span>
<span class=normal>3609</span>
<span class=normal>3610</span>
<span class=normal>3611</span>
<span class=normal>3612</span>
<span class=normal>3613</span>
<span class=normal>3614</span>
<span class=normal>3615</span>
<span class=normal>3616</span>
<span class=normal>3617</span>
<span class=normal>3618</span>
<span class=normal>3619</span>
<span class=normal>3620</span>
<span class=normal>3621</span>
<span class=normal>3622</span>
<span class=normal>3623</span>
<span class=normal>3624</span>
<span class=normal>3625</span>
<span class=normal>3626</span>
<span class=normal>3627</span>
<span class=normal>3628</span>
<span class=normal>3629</span>
<span class=normal>3630</span>
<span class=normal>3631</span>
<span class=normal>3632</span>
<span class=normal>3633</span>
<span class=normal>3634</span>
<span class=normal>3635</span>
<span class=normal>3636</span>
<span class=normal>3637</span>
<span class=normal>3638</span>
<span class=normal>3639</span>
<span class=normal>3640</span>
<span class=normal>3641</span>
<span class=normal>3642</span>
<span class=normal>3643</span>
<span class=normal>3644</span>
<span class=normal>3645</span>
<span class=normal>3646</span>
<span class=normal>3647</span>
<span class=normal>3648</span>
<span class=normal>3649</span>
<span class=normal>3650</span>
<span class=normal>3651</span>
<span class=normal>3652</span>
<span class=normal>3653</span>
<span class=normal>3654</span>
<span class=normal>3655</span>
<span class=normal>3656</span>
<span class=normal>3657</span>
<span class=normal>3658</span>
<span class=normal>3659</span>
<span class=normal>3660</span>
<span class=normal>3661</span>
<span class=normal>3662</span>
<span class=normal>3663</span>
<span class=normal>3664</span>
<span class=normal>3665</span>
<span class=normal>3666</span>
<span class=normal>3667</span>
<span class=normal>3668</span>
<span class=normal>3669</span>
<span class=normal>3670</span>
<span class=normal>3671</span>
<span class=normal>3672</span>
<span class=normal>3673</span>
<span class=normal>3674</span>
<span class=normal>3675</span>
<span class=normal>3676</span>
<span class=normal>3677</span>
<span class=normal>3678</span>
<span class=normal>3679</span>
<span class=normal>3680</span>
<span class=normal>3681</span>
<span class=normal>3682</span>
<span class=normal>3683</span>
<span class=normal>3684</span>
<span class=normal>3685</span>
<span class=normal>3686</span>
<span class=normal>3687</span>
<span class=normal>3688</span>
<span class=normal>3689</span>
<span class=normal>3690</span>
<span class=normal>3691</span>
<span class=normal>3692</span>
<span class=normal>3693</span>
<span class=normal>3694</span>
<span class=normal>3695</span>
<span class=normal>3696</span>
<span class=normal>3697</span>
<span class=normal>3698</span>
<span class=normal>3699</span>
<span class=normal>3700</span>
<span class=normal>3701</span>
<span class=normal>3702</span>
<span class=normal>3703</span>
<span class=normal>3704</span>
<span class=normal>3705</span>
<span class=normal>3706</span>
<span class=normal>3707</span>
<span class=normal>3708</span>
<span class=normal>3709</span>
<span class=normal>3710</span>
<span class=normal>3711</span>
<span class=normal>3712</span>
<span class=normal>3713</span>
<span class=normal>3714</span>
<span class=normal>3715</span>
<span class=normal>3716</span>
<span class=normal>3717</span>
<span class=normal>3718</span>
<span class=normal>3719</span>
<span class=normal>3720</span>
<span class=normal>3721</span>
<span class=normal>3722</span>
<span class=normal>3723</span>
<span class=normal>3724</span>
<span class=normal>3725</span>
<span class=normal>3726</span>
<span class=normal>3727</span>
<span class=normal>3728</span>
<span class=normal>3729</span>
<span class=normal>3730</span>
<span class=normal>3731</span>
<span class=normal>3732</span>
<span class=normal>3733</span>
<span class=normal>3734</span>
<span class=normal>3735</span>
<span class=normal>3736</span>
<span class=normal>3737</span>
<span class=normal>3738</span>
<span class=normal>3739</span>
<span class=normal>3740</span>
<span class=normal>3741</span>
<span class=normal>3742</span>
<span class=normal>3743</span>
<span class=normal>3744</span>
<span class=normal>3745</span>
<span class=normal>3746</span>
<span class=normal>3747</span>
<span class=normal>3748</span>
<span class=normal>3749</span>
<span class=normal>3750</span>
<span class=normal>3751</span>
<span class=normal>3752</span>
<span class=normal>3753</span>
<span class=normal>3754</span>
<span class=normal>3755</span>
<span class=normal>3756</span>
<span class=normal>3757</span>
<span class=normal>3758</span>
<span class=normal>3759</span>
<span class=normal>3760</span>
<span class=normal>3761</span>
<span class=normal>3762</span>
<span class=normal>3763</span>
<span class=normal>3764</span>
<span class=normal>3765</span>
<span class=normal>3766</span>
<span class=normal>3767</span>
<span class=normal>3768</span>
<span class=normal>3769</span>
<span class=normal>3770</span>
<span class=normal>3771</span>
<span class=normal>3772</span>
<span class=normal>3773</span>
<span class=normal>3774</span>
<span class=normal>3775</span>
<span class=normal>3776</span>
<span class=normal>3777</span>
<span class=normal>3778</span>
<span class=normal>3779</span>
<span class=normal>3780</span>
<span class=normal>3781</span>
<span class=normal>3782</span>
<span class=normal>3783</span>
<span class=normal>3784</span>
<span class=normal>3785</span>
<span class=normal>3786</span>
<span class=normal>3787</span>
<span class=normal>3788</span>
<span class=normal>3789</span>
<span class=normal>3790</span>
<span class=normal>3791</span>
<span class=normal>3792</span>
<span class=normal>3793</span>
<span class=normal>3794</span>
<span class=normal>3795</span>
<span class=normal>3796</span>
<span class=normal>3797</span>
<span class=normal>3798</span>
<span class=normal>3799</span>
<span class=normal>3800</span>
<span class=normal>3801</span>
<span class=normal>3802</span>
<span class=normal>3803</span>
<span class=normal>3804</span>
<span class=normal>3805</span>
<span class=normal>3806</span>
<span class=normal>3807</span>
<span class=normal>3808</span>
<span class=normal>3809</span>
<span class=normal>3810</span>
<span class=normal>3811</span>
<span class=normal>3812</span>
<span class=normal>3813</span>
<span class=normal>3814</span>
<span class=normal>3815</span>
<span class=normal>3816</span>
<span class=normal>3817</span>
<span class=normal>3818</span>
<span class=normal>3819</span>
<span class=normal>3820</span>
<span class=normal>3821</span>
<span class=normal>3822</span>
<span class=normal>3823</span>
<span class=normal>3824</span>
<span class=normal>3825</span>
<span class=normal>3826</span>
<span class=normal>3827</span>
<span class=normal>3828</span>
<span class=normal>3829</span>
<span class=normal>3830</span>
<span class=normal>3831</span>
<span class=normal>3832</span>
<span class=normal>3833</span>
<span class=normal>3834</span>
<span class=normal>3835</span>
<span class=normal>3836</span>
<span class=normal>3837</span>
<span class=normal>3838</span>
<span class=normal>3839</span>
<span class=normal>3840</span>
<span class=normal>3841</span>
<span class=normal>3842</span>
<span class=normal>3843</span>
<span class=normal>3844</span>
<span class=normal>3845</span>
<span class=normal>3846</span>
<span class=normal>3847</span>
<span class=normal>3848</span>
<span class=normal>3849</span>
<span class=normal>3850</span>
<span class=normal>3851</span>
<span class=normal>3852</span>
<span class=normal>3853</span>
<span class=normal>3854</span>
<span class=normal>3855</span>
<span class=normal>3856</span>
<span class=normal>3857</span>
<span class=normal>3858</span>
<span class=normal>3859</span>
<span class=normal>3860</span>
<span class=normal>3861</span>
<span class=normal>3862</span>
<span class=normal>3863</span>
<span class=normal>3864</span>
<span class=normal>3865</span>
<span class=normal>3866</span>
<span class=normal>3867</span>
<span class=normal>3868</span>
<span class=normal>3869</span>
<span class=normal>3870</span>
<span class=normal>3871</span>
<span class=normal>3872</span>
<span class=normal>3873</span>
<span class=normal>3874</span>
<span class=normal>3875</span>
<span class=normal>3876</span>
<span class=normal>3877</span>
<span class=normal>3878</span>
<span class=normal>3879</span>
<span class=normal>3880</span>
<span class=normal>3881</span>
<span class=normal>3882</span>
<span class=normal>3883</span>
<span class=normal>3884</span>
<span class=normal>3885</span>
<span class=normal>3886</span>
<span class=normal>3887</span>
<span class=normal>3888</span>
<span class=normal>3889</span>
<span class=normal>3890</span>
<span class=normal>3891</span>
<span class=normal>3892</span>
<span class=normal>3893</span>
<span class=normal>3894</span>
<span class=normal>3895</span>
<span class=normal>3896</span>
<span class=normal>3897</span>
<span class=normal>3898</span>
<span class=normal>3899</span>
<span class=normal>3900</span>
<span class=normal>3901</span>
<span class=normal>3902</span>
<span class=normal>3903</span>
<span class=normal>3904</span>
<span class=normal>3905</span>
<span class=normal>3906</span>
<span class=normal>3907</span>
<span class=normal>3908</span>
<span class=normal>3909</span>
<span class=normal>3910</span>
<span class=normal>3911</span>
<span class=normal>3912</span>
<span class=normal>3913</span>
<span class=normal>3914</span>
<span class=normal>3915</span>
<span class=normal>3916</span>
<span class=normal>3917</span>
<span class=normal>3918</span>
<span class=normal>3919</span>
<span class=normal>3920</span>
<span class=normal>3921</span>
<span class=normal>3922</span>
<span class=normal>3923</span>
<span class=normal>3924</span>
<span class=normal>3925</span>
<span class=normal>3926</span>
<span class=normal>3927</span>
<span class=normal>3928</span>
<span class=normal>3929</span>
<span class=normal>3930</span>
<span class=normal>3931</span>
<span class=normal>3932</span>
<span class=normal>3933</span>
<span class=normal>3934</span>
<span class=normal>3935</span>
<span class=normal>3936</span>
<span class=normal>3937</span>
<span class=normal>3938</span>
<span class=normal>3939</span>
<span class=normal>3940</span>
<span class=normal>3941</span>
<span class=normal>3942</span>
<span class=normal>3943</span>
<span class=normal>3944</span>
<span class=normal>3945</span>
<span class=normal>3946</span>
<span class=normal>3947</span>
<span class=normal>3948</span>
<span class=normal>3949</span>
<span class=normal>3950</span>
<span class=normal>3951</span>
<span class=normal>3952</span>
<span class=normal>3953</span>
<span class=normal>3954</span>
<span class=normal>3955</span>
<span class=normal>3956</span>
<span class=normal>3957</span>
<span class=normal>3958</span>
<span class=normal>3959</span>
<span class=normal>3960</span>
<span class=normal>3961</span>
<span class=normal>3962</span>
<span class=normal>3963</span>
<span class=normal>3964</span>
<span class=normal>3965</span>
<span class=normal>3966</span>
<span class=normal>3967</span>
<span class=normal>3968</span>
<span class=normal>3969</span>
<span class=normal>3970</span>
<span class=normal>3971</span>
<span class=normal>3972</span>
<span class=normal>3973</span>
<span class=normal>3974</span>
<span class=normal>3975</span>
<span class=normal>3976</span>
<span class=normal>3977</span>
<span class=normal>3978</span>
<span class=normal>3979</span>
<span class=normal>3980</span>
<span class=normal>3981</span>
<span class=normal>3982</span>
<span class=normal>3983</span>
<span class=normal>3984</span>
<span class=normal>3985</span>
<span class=normal>3986</span>
<span class=normal>3987</span>
<span class=normal>3988</span>
<span class=normal>3989</span>
<span class=normal>3990</span>
<span class=normal>3991</span>
<span class=normal>3992</span>
<span class=normal>3993</span>
<span class=normal>3994</span>
<span class=normal>3995</span>
<span class=normal>3996</span>
<span class=normal>3997</span>
<span class=normal>3998</span>
<span class=normal>3999</span>
<span class=normal>4000</span>
<span class=normal>4001</span>
<span class=normal>4002</span>
<span class=normal>4003</span>
<span class=normal>4004</span>
<span class=normal>4005</span>
<span class=normal>4006</span>
<span class=normal>4007</span>
<span class=normal>4008</span>
<span class=normal>4009</span>
<span class=normal>4010</span>
<span class=normal>4011</span>
<span class=normal>4012</span>
<span class=normal>4013</span>
<span class=normal>4014</span>
<span class=normal>4015</span>
<span class=normal>4016</span>
<span class=normal>4017</span>
<span class=normal>4018</span>
<span class=normal>4019</span>
<span class=normal>4020</span>
<span class=normal>4021</span>
<span class=normal>4022</span>
<span class=normal>4023</span>
<span class=normal>4024</span>
<span class=normal>4025</span>
<span class=normal>4026</span>
<span class=normal>4027</span>
<span class=normal>4028</span>
<span class=normal>4029</span>
<span class=normal>4030</span>
<span class=normal>4031</span>
<span class=normal>4032</span>
<span class=normal>4033</span>
<span class=normal>4034</span>
<span class=normal>4035</span>
<span class=normal>4036</span>
<span class=normal>4037</span>
<span class=normal>4038</span>
<span class=normal>4039</span>
<span class=normal>4040</span>
<span class=normal>4041</span>
<span class=normal>4042</span>
<span class=normal>4043</span>
<span class=normal>4044</span>
<span class=normal>4045</span>
<span class=normal>4046</span>
<span class=normal>4047</span>
<span class=normal>4048</span>
<span class=normal>4049</span>
<span class=normal>4050</span>
<span class=normal>4051</span>
<span class=normal>4052</span>
<span class=normal>4053</span>
<span class=normal>4054</span>
<span class=normal>4055</span>
<span class=normal>4056</span>
<span class=normal>4057</span>
<span class=normal>4058</span>
<span class=normal>4059</span>
<span class=normal>4060</span>
<span class=normal>4061</span>
<span class=normal>4062</span>
<span class=normal>4063</span>
<span class=normal>4064</span>
<span class=normal>4065</span>
<span class=normal>4066</span>
<span class=normal>4067</span>
<span class=normal>4068</span>
<span class=normal>4069</span>
<span class=normal>4070</span>
<span class=normal>4071</span>
<span class=normal>4072</span>
<span class=normal>4073</span>
<span class=normal>4074</span>
<span class=normal>4075</span>
<span class=normal>4076</span>
<span class=normal>4077</span>
<span class=normal>4078</span>
<span class=normal>4079</span>
<span class=normal>4080</span>
<span class=normal>4081</span>
<span class=normal>4082</span>
<span class=normal>4083</span>
<span class=normal>4084</span>
<span class=normal>4085</span>
<span class=normal>4086</span>
<span class=normal>4087</span>
<span class=normal>4088</span>
<span class=normal>4089</span>
<span class=normal>4090</span>
<span class=normal>4091</span>
<span class=normal>4092</span>
<span class=normal>4093</span>
<span class=normal>4094</span>
<span class=normal>4095</span>
<span class=normal>4096</span>
<span class=normal>4097</span>
<span class=normal>4098</span>
<span class=normal>4099</span>
<span class=normal>4100</span>
<span class=normal>4101</span>
<span class=normal>4102</span>
<span class=normal>4103</span>
<span class=normal>4104</span>
<span class=normal>4105</span>
<span class=normal>4106</span>
<span class=normal>4107</span>
<span class=normal>4108</span>
<span class=normal>4109</span>
<span class=normal>4110</span>
<span class=normal>4111</span>
<span class=normal>4112</span>
<span class=normal>4113</span>
<span class=normal>4114</span>
<span class=normal>4115</span>
<span class=normal>4116</span>
<span class=normal>4117</span>
<span class=normal>4118</span>
<span class=normal>4119</span>
<span class=normal>4120</span>
<span class=normal>4121</span>
<span class=normal>4122</span>
<span class=normal>4123</span>
<span class=normal>4124</span>
<span class=normal>4125</span>
<span class=normal>4126</span>
<span class=normal>4127</span>
<span class=normal>4128</span>
<span class=normal>4129</span>
<span class=normal>4130</span>
<span class=normal>4131</span>
<span class=normal>4132</span>
<span class=normal>4133</span>
<span class=normal>4134</span>
<span class=normal>4135</span>
<span class=normal>4136</span>
<span class=normal>4137</span>
<span class=normal>4138</span>
<span class=normal>4139</span>
<span class=normal>4140</span>
<span class=normal>4141</span>
<span class=normal>4142</span>
<span class=normal>4143</span>
<span class=normal>4144</span>
<span class=normal>4145</span>
<span class=normal>4146</span>
<span class=normal>4147</span>
<span class=normal>4148</span>
<span class=normal>4149</span>
<span class=normal>4150</span>
<span class=normal>4151</span>
<span class=normal>4152</span>
<span class=normal>4153</span>
<span class=normal>4154</span>
<span class=normal>4155</span>
<span class=normal>4156</span>
<span class=normal>4157</span>
<span class=normal>4158</span>
<span class=normal>4159</span>
<span class=normal>4160</span>
<span class=normal>4161</span>
<span class=normal>4162</span>
<span class=normal>4163</span>
<span class=normal>4164</span>
<span class=normal>4165</span>
<span class=normal>4166</span>
<span class=normal>4167</span>
<span class=normal>4168</span>
<span class=normal>4169</span>
<span class=normal>4170</span>
<span class=normal>4171</span>
<span class=normal>4172</span>
<span class=normal>4173</span>
<span class=normal>4174</span>
<span class=normal>4175</span>
<span class=normal>4176</span>
<span class=normal>4177</span>
<span class=normal>4178</span>
<span class=normal>4179</span>
<span class=normal>4180</span>
<span class=normal>4181</span>
<span class=normal>4182</span>
<span class=normal>4183</span>
<span class=normal>4184</span>
<span class=normal>4185</span>
<span class=normal>4186</span>
<span class=normal>4187</span>
<span class=normal>4188</span>
<span class=normal>4189</span>
<span class=normal>4190</span>
<span class=normal>4191</span>
<span class=normal>4192</span>
<span class=normal>4193</span>
<span class=normal>4194</span>
<span class=normal>4195</span>
<span class=normal>4196</span>
<span class=normal>4197</span>
<span class=normal>4198</span>
<span class=normal>4199</span>
<span class=normal>4200</span>
<span class=normal>4201</span>
<span class=normal>4202</span>
<span class=normal>4203</span>
<span class=normal>4204</span>
<span class=normal>4205</span>
<span class=normal>4206</span>
<span class=normal>4207</span>
<span class=normal>4208</span>
<span class=normal>4209</span></pre></div></td><td class=code><div><pre><span></span><code><span class=k>class</span> <span class=nc>qi2labDataStore</span><span class=p>:</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;API to qi2lab MERFISH store.</span>

<span class=sd>    Parameters</span>
<span class=sd>    ----------</span>
<span class=sd>    datastore_path : Union[str, Path]</span>
<span class=sd>        Path to qi2lab MERFISH store</span>

<span class=sd>    &quot;&quot;&quot;</span>

    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>datastore_path</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Path</span><span class=p>]):</span>
        <span class=n>compressor</span> <span class=o>=</span> <span class=p>{</span>
            <span class=s2>&quot;id&quot;</span><span class=p>:</span> <span class=s2>&quot;blosc&quot;</span><span class=p>,</span>
            <span class=s2>&quot;cname&quot;</span><span class=p>:</span> <span class=s2>&quot;zstd&quot;</span><span class=p>,</span>
            <span class=s2>&quot;clevel&quot;</span><span class=p>:</span> <span class=mi>5</span><span class=p>,</span>
            <span class=s2>&quot;shuffle&quot;</span><span class=p>:</span> <span class=mi>2</span><span class=p>,</span>
        <span class=p>}</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_zarrv2_spec</span> <span class=o>=</span> <span class=p>{</span>
            <span class=s2>&quot;driver&quot;</span><span class=p>:</span> <span class=s2>&quot;zarr&quot;</span><span class=p>,</span>
            <span class=s2>&quot;kvstore&quot;</span><span class=p>:</span> <span class=kc>None</span><span class=p>,</span>
            <span class=s2>&quot;metadata&quot;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&quot;compressor&quot;</span><span class=p>:</span> <span class=n>compressor</span><span class=p>},</span>
            <span class=s2>&quot;open&quot;</span><span class=p>:</span> <span class=kc>True</span><span class=p>,</span>
            <span class=s2>&quot;assume_metadata&quot;</span><span class=p>:</span> <span class=kc>False</span><span class=p>,</span>
            <span class=s2>&quot;create&quot;</span><span class=p>:</span> <span class=kc>True</span><span class=p>,</span>
            <span class=s2>&quot;delete_existing&quot;</span><span class=p>:</span> <span class=kc>False</span><span class=p>,</span>
        <span class=p>}</span>

        <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_path</span> <span class=o>=</span> <span class=n>Path</span><span class=p>(</span><span class=n>datastore_path</span><span class=p>)</span>
        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_path</span><span class=o>.</span><span class=n>exists</span><span class=p>():</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_parse_datastore</span><span class=p>()</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_init_datastore</span><span class=p>()</span>

    <span class=nd>@property</span>
    <span class=k>def</span> <span class=nf>datastore_state</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>dict</span><span class=p>]:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Datastore state.</span>

<span class=sd>        Returns</span>
<span class=sd>        -------</span>
<span class=sd>        datastore_state : Optional[dict]</span>
<span class=sd>            Datastore state.</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=k>return</span> <span class=nb>getattr</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=s2>&quot;_datastore_state&quot;</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>

    <span class=nd>@datastore_state</span><span class=o>.</span><span class=n>setter</span>
    <span class=k>def</span> <span class=nf>datastore_state</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>value</span><span class=p>:</span> <span class=nb>dict</span><span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Set the datastore state.</span>

<span class=sd>        Parameters</span>
<span class=sd>        ----------</span>
<span class=sd>        value : dict</span>
<span class=sd>            New datastore state.</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=k>if</span> <span class=ow>not</span> <span class=nb>hasattr</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=s2>&quot;_datastore_state&quot;</span><span class=p>)</span> <span class=ow>or</span> <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_state</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_state</span> <span class=o>=</span> <span class=n>value</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_state</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=n>value</span><span class=p>)</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_save_to_json</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_datastore_state</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_state_json_path</span><span class=p>)</span>

    <span class=nd>@property</span>
    <span class=k>def</span> <span class=nf>microscope_type</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>str</span><span class=p>]:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Microscope type.</span>

<span class=sd>        Returns</span>
<span class=sd>        -------</span>
<span class=sd>        microscope_type : Optional[str]</span>
<span class=sd>            Microscope type.</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=k>return</span> <span class=nb>getattr</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=s2>&quot;_microscope_type&quot;</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>

    <span class=nd>@microscope_type</span><span class=o>.</span><span class=n>setter</span>
    <span class=k>def</span> <span class=nf>microscope_type</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>value</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Set the microscope type.</span>

<span class=sd>        Parameters</span>
<span class=sd>        ----------</span>
<span class=sd>        value : str</span>
<span class=sd>            New microscope type.</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=bp>self</span><span class=o>.</span><span class=n>_microscope_type</span> <span class=o>=</span> <span class=n>value</span>
        <span class=n>zattrs_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_calibrations_zarr_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;.zattrs&quot;</span><span class=p>)</span>
        <span class=n>calib_zattrs</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_json</span><span class=p>(</span><span class=n>zattrs_path</span><span class=p>)</span>
        <span class=n>calib_zattrs</span><span class=p>[</span><span class=s2>&quot;microscope_type&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>value</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_save_to_json</span><span class=p>(</span><span class=n>calib_zattrs</span><span class=p>,</span> <span class=n>zattrs_path</span><span class=p>)</span>

    <span class=nd>@property</span>
    <span class=k>def</span> <span class=nf>camera_model</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>str</span><span class=p>]:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Camera model.</span>

<span class=sd>        Returns</span>
<span class=sd>        -------</span>
<span class=sd>        camera_model : Optional[str]</span>
<span class=sd>            Camera model.</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=k>return</span> <span class=nb>getattr</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=s2>&quot;_camera_model&quot;</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>

    <span class=nd>@camera_model</span><span class=o>.</span><span class=n>setter</span>
    <span class=k>def</span> <span class=nf>camera_model</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>value</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Set the camera model.</span>

<span class=sd>        Parameters</span>
<span class=sd>        ----------</span>
<span class=sd>        value : str</span>
<span class=sd>            New camera model.</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_camera_model</span> <span class=o>=</span> <span class=n>value</span>
        <span class=n>zattrs_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_calibrations_zarr_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;.zattrs&quot;</span><span class=p>)</span>
        <span class=n>calib_zattrs</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_json</span><span class=p>(</span><span class=n>zattrs_path</span><span class=p>)</span>
        <span class=n>calib_zattrs</span><span class=p>[</span><span class=s2>&quot;camera_model&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>value</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_save_to_json</span><span class=p>(</span><span class=n>calib_zattrs</span><span class=p>,</span> <span class=n>zattrs_path</span><span class=p>)</span>

    <span class=nd>@property</span>
    <span class=k>def</span> <span class=nf>num_rounds</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>int</span><span class=p>]:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Number of rounds.</span>

<span class=sd>        Returns</span>
<span class=sd>        -------</span>
<span class=sd>        num_rounds : int</span>
<span class=sd>            Number of rounds.</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=k>return</span> <span class=nb>getattr</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=s2>&quot;_num_rounds&quot;</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>

    <span class=nd>@num_rounds</span><span class=o>.</span><span class=n>setter</span>
    <span class=k>def</span> <span class=nf>num_rounds</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>value</span><span class=p>:</span> <span class=nb>int</span><span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Set the number of rounds.</span>

<span class=sd>        Parameters</span>
<span class=sd>        ----------</span>
<span class=sd>        value : int</span>
<span class=sd>            New number of rounds.</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=bp>self</span><span class=o>.</span><span class=n>_num_rounds</span> <span class=o>=</span> <span class=n>value</span>
        <span class=n>zattrs_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_calibrations_zarr_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;.zattrs&quot;</span><span class=p>)</span>
        <span class=n>calib_zattrs</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_json</span><span class=p>(</span><span class=n>zattrs_path</span><span class=p>)</span>
        <span class=n>calib_zattrs</span><span class=p>[</span><span class=s2>&quot;num_rounds&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>value</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_save_to_json</span><span class=p>(</span><span class=n>calib_zattrs</span><span class=p>,</span> <span class=n>zattrs_path</span><span class=p>)</span>

    <span class=nd>@property</span>
    <span class=k>def</span> <span class=nf>num_bits</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>int</span><span class=p>:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Number of bits.</span>

<span class=sd>        Returns</span>
<span class=sd>        -------</span>
<span class=sd>        num_bits : int</span>
<span class=sd>            Number of bits.</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=k>return</span> <span class=nb>getattr</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=s2>&quot;_num_bits&quot;</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>

    <span class=nd>@property</span>
    <span class=k>def</span> <span class=nf>num_tiles</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>int</span><span class=p>]:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Number of tiles.</span>

<span class=sd>        Returns</span>
<span class=sd>        -------</span>
<span class=sd>        num_tiles : int</span>
<span class=sd>            Number of tiles.</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=k>return</span> <span class=nb>getattr</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=s2>&quot;_num_tiles&quot;</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>

    <span class=nd>@num_tiles</span><span class=o>.</span><span class=n>setter</span>
    <span class=k>def</span> <span class=nf>num_tiles</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>value</span><span class=p>:</span> <span class=nb>int</span><span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Set the number of tiles.</span>

<span class=sd>        Parameters</span>
<span class=sd>        ----------</span>
<span class=sd>        value : int</span>
<span class=sd>            New number of tiles.</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span> <span class=o>=</span> <span class=n>value</span>
        <span class=n>zattrs_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_calibrations_zarr_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;.zattrs&quot;</span><span class=p>)</span>
        <span class=n>calib_zattrs</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_json</span><span class=p>(</span><span class=n>zattrs_path</span><span class=p>)</span>
        <span class=n>calib_zattrs</span><span class=p>[</span><span class=s2>&quot;num_tiles&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>value</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_save_to_json</span><span class=p>(</span><span class=n>calib_zattrs</span><span class=p>,</span> <span class=n>zattrs_path</span><span class=p>)</span>

        <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span> <span class=o>=</span> <span class=p>[]</span>
        <span class=k>for</span> <span class=n>tile_idx</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>value</span><span class=p>):</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s2>&quot;tile&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=n>tile_idx</span><span class=p>)</span><span class=o>.</span><span class=n>zfill</span><span class=p>(</span><span class=mi>4</span><span class=p>))</span>

    <span class=nd>@property</span>
    <span class=k>def</span> <span class=nf>channels_in_data</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=n>Collection</span><span class=p>[</span><span class=nb>int</span><span class=p>]]:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Channel indices.</span>

<span class=sd>        Returns</span>
<span class=sd>        -------</span>
<span class=sd>        channels_in_data : Collection[int]</span>
<span class=sd>            Channel indices.</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=k>return</span> <span class=nb>getattr</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=s2>&quot;_channels_in_data&quot;</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>

    <span class=nd>@channels_in_data</span><span class=o>.</span><span class=n>setter</span>
    <span class=k>def</span> <span class=nf>channels_in_data</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>value</span><span class=p>:</span> <span class=n>Collection</span><span class=p>[</span><span class=nb>int</span><span class=p>]):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Set the channels in the data.</span>

<span class=sd>        Parameters</span>
<span class=sd>        ----------</span>
<span class=sd>        value : Collection[int]</span>
<span class=sd>            New channels in data (int values starting from zero).</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=bp>self</span><span class=o>.</span><span class=n>_channels_in_data</span> <span class=o>=</span> <span class=n>value</span>
        <span class=n>zattrs_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_calibrations_zarr_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;.zattrs&quot;</span><span class=p>)</span>
        <span class=n>calib_zattrs</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_json</span><span class=p>(</span><span class=n>zattrs_path</span><span class=p>)</span>
        <span class=n>calib_zattrs</span><span class=p>[</span><span class=s2>&quot;channels_in_data&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>value</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_save_to_json</span><span class=p>(</span><span class=n>calib_zattrs</span><span class=p>,</span> <span class=n>zattrs_path</span><span class=p>)</span>

    <span class=nd>@property</span>
    <span class=k>def</span> <span class=nf>tile_overlap</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>float</span><span class=p>]:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;XY tile overlap.</span>

<span class=sd>        Returns</span>
<span class=sd>        -------</span>
<span class=sd>        tile_overlap : float</span>
<span class=sd>            XY tile overlap.</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=k>return</span> <span class=nb>getattr</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=s2>&quot;_tile_overlap&quot;</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>

    <span class=nd>@tile_overlap</span><span class=o>.</span><span class=n>setter</span>
    <span class=k>def</span> <span class=nf>tile_overlap</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>value</span><span class=p>:</span> <span class=nb>float</span><span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Set the tile overlap.</span>

<span class=sd>        Parameters</span>
<span class=sd>        ----------</span>
<span class=sd>        value : float</span>
<span class=sd>            New tile overlap.</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=bp>self</span><span class=o>.</span><span class=n>_tile_overlap</span> <span class=o>=</span> <span class=n>value</span>
        <span class=n>zattrs_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_calibrations_zarr_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;.zattrs&quot;</span><span class=p>)</span>
        <span class=n>calib_zattrs</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_json</span><span class=p>(</span><span class=n>zattrs_path</span><span class=p>)</span>
        <span class=n>calib_zattrs</span><span class=p>[</span><span class=s2>&quot;tile_overlap&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>value</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_save_to_json</span><span class=p>(</span><span class=n>calib_zattrs</span><span class=p>,</span> <span class=n>zattrs_path</span><span class=p>)</span>

    <span class=nd>@property</span>
    <span class=k>def</span> <span class=nf>binning</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>int</span><span class=p>]:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Camera binning.</span>

<span class=sd>        Returns</span>
<span class=sd>        -------</span>
<span class=sd>        binning : int</span>
<span class=sd>            Camera binning.</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=k>return</span> <span class=nb>getattr</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=s2>&quot;_binning&quot;</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>

    <span class=nd>@binning</span><span class=o>.</span><span class=n>setter</span>
    <span class=k>def</span> <span class=nf>binning</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>value</span><span class=p>:</span> <span class=nb>int</span><span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Set the camera binning.</span>

<span class=sd>        Parameters</span>
<span class=sd>        ----------</span>
<span class=sd>        value : int</span>
<span class=sd>            New camera binning.</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=bp>self</span><span class=o>.</span><span class=n>_binning</span> <span class=o>=</span> <span class=n>value</span>
        <span class=n>zattrs_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_calibrations_zarr_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;.zattrs&quot;</span><span class=p>)</span>
        <span class=n>calib_zattrs</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_json</span><span class=p>(</span><span class=n>zattrs_path</span><span class=p>)</span>
        <span class=n>calib_zattrs</span><span class=p>[</span><span class=s2>&quot;binning&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>value</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_save_to_json</span><span class=p>(</span><span class=n>calib_zattrs</span><span class=p>,</span> <span class=n>zattrs_path</span><span class=p>)</span>

    <span class=nd>@property</span>
    <span class=k>def</span> <span class=nf>e_per_ADU</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>float</span><span class=p>]:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Electrons per camera ADU.</span>

<span class=sd>        Returns</span>
<span class=sd>        -------</span>
<span class=sd>        e_per_ADU : float</span>
<span class=sd>            Electrons per camera ADU.&quot;&quot;&quot;</span>

        <span class=k>return</span> <span class=nb>getattr</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=s2>&quot;_e_per_ADU&quot;</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>

    <span class=nd>@e_per_ADU</span><span class=o>.</span><span class=n>setter</span>
    <span class=k>def</span> <span class=nf>e_per_ADU</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>value</span><span class=p>:</span> <span class=nb>float</span><span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Set the camera conversion (e- per ADU).</span>

<span class=sd>        Parameters</span>
<span class=sd>        ----------</span>
<span class=sd>        value : float</span>
<span class=sd>            New camera conversion (e- per ADU).</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=bp>self</span><span class=o>.</span><span class=n>_e_per_ADU</span> <span class=o>=</span> <span class=n>value</span>
        <span class=n>zattrs_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_calibrations_zarr_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;.zattrs&quot;</span><span class=p>)</span>
        <span class=n>calib_zattrs</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_json</span><span class=p>(</span><span class=n>zattrs_path</span><span class=p>)</span>
        <span class=n>calib_zattrs</span><span class=p>[</span><span class=s2>&quot;e_per_ADU&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>value</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_save_to_json</span><span class=p>(</span><span class=n>calib_zattrs</span><span class=p>,</span> <span class=n>zattrs_path</span><span class=p>)</span>

    <span class=nd>@property</span>
    <span class=k>def</span> <span class=nf>na</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>float</span><span class=p>]:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Detection objective numerical aperture (NA).</span>

<span class=sd>        Returns</span>
<span class=sd>        -------</span>
<span class=sd>        na : float</span>
<span class=sd>            Detection objective numerical aperture (NA).</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=k>return</span> <span class=nb>getattr</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=s2>&quot;_na&quot;</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>

    <span class=nd>@na</span><span class=o>.</span><span class=n>setter</span>
    <span class=k>def</span> <span class=nf>na</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>value</span><span class=p>:</span> <span class=nb>float</span><span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Set detection objective numerical aperture (NA).</span>

<span class=sd>        Parameters</span>
<span class=sd>        ----------</span>
<span class=sd>        value: float</span>
<span class=sd>            New detection objective numerical aperture (NA)</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=bp>self</span><span class=o>.</span><span class=n>_na</span> <span class=o>=</span> <span class=n>value</span>
        <span class=n>zattrs_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_calibrations_zarr_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;.zattrs&quot;</span><span class=p>)</span>
        <span class=n>calib_zattrs</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_json</span><span class=p>(</span><span class=n>zattrs_path</span><span class=p>)</span>
        <span class=n>calib_zattrs</span><span class=p>[</span><span class=s2>&quot;na&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>value</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_save_to_json</span><span class=p>(</span><span class=n>calib_zattrs</span><span class=p>,</span> <span class=n>zattrs_path</span><span class=p>)</span>

    <span class=nd>@property</span>
    <span class=k>def</span> <span class=nf>ri</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>float</span><span class=p>]:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Detection objective refractive index (RI).</span>

<span class=sd>        Returns</span>
<span class=sd>        -------</span>
<span class=sd>        ri : float</span>
<span class=sd>            Detection objective refractive index (RI).</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=k>return</span> <span class=nb>getattr</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=s2>&quot;_ri&quot;</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>

    <span class=nd>@ri</span><span class=o>.</span><span class=n>setter</span>
    <span class=k>def</span> <span class=nf>ri</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>value</span><span class=p>:</span> <span class=nb>float</span><span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Set detection objective refractive index (RI).</span>

<span class=sd>        Parameters</span>
<span class=sd>        ----------</span>
<span class=sd>        value: float</span>
<span class=sd>            New detection objective refractive index (RI)</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=bp>self</span><span class=o>.</span><span class=n>_ri</span> <span class=o>=</span> <span class=n>value</span>
        <span class=n>zattrs_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_calibrations_zarr_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;.zattrs&quot;</span><span class=p>)</span>
        <span class=n>calib_zattrs</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_json</span><span class=p>(</span><span class=n>zattrs_path</span><span class=p>)</span>
        <span class=n>calib_zattrs</span><span class=p>[</span><span class=s2>&quot;ri&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>value</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_save_to_json</span><span class=p>(</span><span class=n>calib_zattrs</span><span class=p>,</span> <span class=n>zattrs_path</span><span class=p>)</span>

    <span class=nd>@property</span>
    <span class=k>def</span> <span class=nf>noise_map</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=n>ArrayLike</span><span class=p>]:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Camera noise image.</span>

<span class=sd>        Returns</span>
<span class=sd>        -------</span>
<span class=sd>        noise_map : ArrayLike</span>
<span class=sd>            Camera noise image.</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=k>return</span> <span class=nb>getattr</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=s2>&quot;_noise_map&quot;</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>

    <span class=nd>@noise_map</span><span class=o>.</span><span class=n>setter</span>
    <span class=k>def</span> <span class=nf>noise_map</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>value</span><span class=p>:</span> <span class=n>ArrayLike</span><span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Set the camera noise image.</span>

<span class=sd>        Parameters</span>
<span class=sd>        ----------</span>
<span class=sd>        value : ArrayLike</span>
<span class=sd>            New camera noise image.</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=bp>self</span><span class=o>.</span><span class=n>_noise_map</span> <span class=o>=</span> <span class=n>value</span>
        <span class=n>current_local_zarr_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_calibrations_zarr_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;noise_map&quot;</span><span class=p>))</span>

        <span class=k>try</span><span class=p>:</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_save_to_zarr_array</span><span class=p>(</span>
                <span class=n>value</span><span class=p>,</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_get_kvstore_key</span><span class=p>(</span><span class=n>current_local_zarr_path</span><span class=p>),</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_zarrv2_spec</span><span class=p>,</span>
                <span class=n>return_future</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
            <span class=p>)</span>
        <span class=k>except</span> <span class=p>(</span><span class=ne>IOError</span><span class=p>,</span> <span class=ne>OSError</span><span class=p>,</span> <span class=n>ZarrError</span><span class=p>):</span>
            <span class=nb>print</span><span class=p>(</span><span class=sa>r</span><span class=s2>&quot;Could not access calibrations.zarr/noise_map&quot;</span><span class=p>)</span>

    <span class=nd>@property</span>
    <span class=k>def</span> <span class=nf>channel_shading_maps</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=n>ArrayLike</span><span class=p>]:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Channel shaiding images.</span>

<span class=sd>        Returns</span>
<span class=sd>        -------</span>
<span class=sd>        channel_shading_maps : ArrayLike</span>
<span class=sd>            Channel shading images.</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=k>return</span> <span class=nb>getattr</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=s2>&quot;_shading_maps&quot;</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>

    <span class=nd>@channel_shading_maps</span><span class=o>.</span><span class=n>setter</span>
    <span class=k>def</span> <span class=nf>channel_shading_maps</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>value</span><span class=p>:</span> <span class=n>ArrayLike</span><span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Set the channel shading images.</span>

<span class=sd>        Parameters</span>
<span class=sd>        ----------</span>
<span class=sd>        value : ArrayLike</span>
<span class=sd>            New channel shading images.</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=bp>self</span><span class=o>.</span><span class=n>_shading_maps</span> <span class=o>=</span> <span class=n>value</span>
        <span class=n>current_local_zarr_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_calibrations_zarr_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;shading_maps&quot;</span><span class=p>)</span>
        <span class=p>)</span>

        <span class=k>try</span><span class=p>:</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_save_to_zarr_array</span><span class=p>(</span>
                <span class=n>value</span><span class=p>,</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_get_kvstore_key</span><span class=p>(</span><span class=n>current_local_zarr_path</span><span class=p>),</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_zarrv2_spec</span><span class=p>,</span>
                <span class=n>return_future</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
            <span class=p>)</span>
        <span class=k>except</span> <span class=p>(</span><span class=ne>IOError</span><span class=p>,</span> <span class=ne>OSError</span><span class=p>,</span> <span class=n>ZarrError</span><span class=p>):</span>
            <span class=nb>print</span><span class=p>(</span><span class=sa>r</span><span class=s2>&quot;Could not access calibrations.zarr/shading_maps&quot;</span><span class=p>)</span>

    <span class=nd>@property</span>
    <span class=k>def</span> <span class=nf>channel_psfs</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=n>ArrayLike</span><span class=p>]:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Channel point spread functions (PSF).</span>

<span class=sd>        Return</span>
<span class=sd>        ------</span>
<span class=sd>        channel_psfs : ArrayLike</span>
<span class=sd>            Channel point spread functions (PSF).</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=k>return</span> <span class=nb>getattr</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=s2>&quot;_psfs&quot;</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>

    <span class=nd>@channel_psfs</span><span class=o>.</span><span class=n>setter</span>
    <span class=k>def</span> <span class=nf>channel_psfs</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>value</span><span class=p>:</span> <span class=n>ArrayLike</span><span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Set the channel point spread functions (PSF).</span>

<span class=sd>        Parameters</span>
<span class=sd>        ----------</span>
<span class=sd>        value : ArrayLike</span>
<span class=sd>            New channel point spread functions (PSF).</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=bp>self</span><span class=o>.</span><span class=n>_psfs</span> <span class=o>=</span> <span class=n>value</span>
        <span class=n>current_local_zarr_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_calibrations_zarr_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;psf_data&quot;</span><span class=p>))</span>

        <span class=k>try</span><span class=p>:</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_save_to_zarr_array</span><span class=p>(</span>
                <span class=n>value</span><span class=p>,</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_get_kvstore_key</span><span class=p>(</span><span class=n>current_local_zarr_path</span><span class=p>),</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_zarrv2_spec</span><span class=o>.</span><span class=n>copy</span><span class=p>(),</span>
                <span class=n>return_future</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
            <span class=p>)</span>
        <span class=k>except</span> <span class=p>(</span><span class=ne>IOError</span><span class=p>,</span> <span class=ne>ValueError</span><span class=p>):</span>
            <span class=nb>print</span><span class=p>(</span><span class=sa>r</span><span class=s2>&quot;Could not access calibrations.zarr/psf_data&quot;</span><span class=p>)</span>

    <span class=nd>@property</span>
    <span class=k>def</span> <span class=nf>experiment_order</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>]:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Round and bit order.</span>

<span class=sd>        Returns</span>
<span class=sd>        -------</span>
<span class=sd>        experiment_order : pd.DataFrame</span>
<span class=sd>            Round and bit order.</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=k>return</span> <span class=nb>getattr</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=s2>&quot;_experiment_order&quot;</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>

    <span class=nd>@experiment_order</span><span class=o>.</span><span class=n>setter</span>
    <span class=k>def</span> <span class=nf>experiment_order</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>value</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=n>ArrayLike</span><span class=p>,</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>]):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Set the round and bit order.</span>

<span class=sd>        Parameters</span>
<span class=sd>        ----------</span>
<span class=sd>        value : Union[ArrayLike, pd.DataFrame]</span>
<span class=sd>            New round and bit order.</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>value</span><span class=p>,</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>):</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_experiment_order</span> <span class=o>=</span> <span class=n>value</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>channel_list</span> <span class=o>=</span> <span class=p>[]</span>
            <span class=k>for</span> <span class=n>idx</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_channels_in_data</span><span class=p>)):</span>
                <span class=n>channel_list</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_channels_in_data</span><span class=p>[</span><span class=n>idx</span><span class=p>]))</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_experiment_order</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>(</span>
                <span class=n>value</span><span class=p>,</span> <span class=n>columns</span><span class=o>=</span><span class=n>channel_list</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=s2>&quot;int64&quot;</span>
            <span class=p>)</span>

        <span class=n>zattrs_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_calibrations_zarr_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;.zattrs&quot;</span><span class=p>)</span>
        <span class=n>calib_zattrs</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_json</span><span class=p>(</span><span class=n>zattrs_path</span><span class=p>)</span>
        <span class=n>calib_zattrs</span><span class=p>[</span><span class=s2>&quot;exp_order&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_experiment_order</span><span class=o>.</span><span class=n>values</span><span class=o>.</span><span class=n>tolist</span><span class=p>()</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_save_to_json</span><span class=p>(</span><span class=n>calib_zattrs</span><span class=p>,</span> <span class=n>zattrs_path</span><span class=p>)</span>

        <span class=bp>self</span><span class=o>.</span><span class=n>_num_rounds</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>value</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>])</span>
        <span class=n>calib_zattrs</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_json</span><span class=p>(</span><span class=n>zattrs_path</span><span class=p>)</span>
        <span class=n>calib_zattrs</span><span class=p>[</span><span class=s2>&quot;num_round&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_num_rounds</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_save_to_json</span><span class=p>(</span><span class=n>calib_zattrs</span><span class=p>,</span> <span class=n>zattrs_path</span><span class=p>)</span>

        <span class=bp>self</span><span class=o>.</span><span class=n>_num_bits</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>max</span><span class=p>(</span><span class=n>value</span><span class=p>[:,</span> <span class=mi>1</span><span class=p>:]))</span>
        <span class=n>calib_zattrs</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_json</span><span class=p>(</span><span class=n>zattrs_path</span><span class=p>)</span>
        <span class=n>calib_zattrs</span><span class=p>[</span><span class=s2>&quot;num_bits&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_num_bits</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_save_to_json</span><span class=p>(</span><span class=n>calib_zattrs</span><span class=p>,</span> <span class=n>zattrs_path</span><span class=p>)</span>

        <span class=bp>self</span><span class=o>.</span><span class=n>_round_ids</span> <span class=o>=</span> <span class=p>[]</span>
        <span class=k>for</span> <span class=n>round_idx</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_num_rounds</span><span class=p>):</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_round_ids</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s2>&quot;round&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=n>round_idx</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span><span class=o>.</span><span class=n>zfill</span><span class=p>(</span><span class=mi>3</span><span class=p>))</span>

        <span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span> <span class=o>=</span> <span class=p>[]</span>
        <span class=k>for</span> <span class=n>bit_idx</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_num_bits</span><span class=p>):</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s2>&quot;bit&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=n>bit_idx</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span><span class=o>.</span><span class=n>zfill</span><span class=p>(</span><span class=mi>3</span><span class=p>))</span>

    <span class=nd>@property</span>
    <span class=k>def</span> <span class=nf>codebook</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>]:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Codebook.</span>

<span class=sd>        Returns</span>
<span class=sd>        -------</span>
<span class=sd>        codebook : pd.DataFrame</span>
<span class=sd>            Codebook.</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=n>data</span> <span class=o>=</span> <span class=nb>getattr</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=s2>&quot;_codebook&quot;</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>

        <span class=k>if</span> <span class=n>data</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=n>num_columns</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span> <span class=k>if</span> <span class=n>data</span> <span class=k>else</span> <span class=mi>0</span>
        <span class=n>columns</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&quot;gene_id&quot;</span><span class=p>]</span> <span class=o>+</span> <span class=p>[</span><span class=sa>f</span><span class=s2>&quot;bit</span><span class=si>{</span><span class=n>i</span><span class=si>:</span><span class=s2>02d</span><span class=si>}</span><span class=s2>&quot;</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=n>num_columns</span><span class=p>)]</span>

        <span class=k>return</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=n>columns</span><span class=o>=</span><span class=n>columns</span><span class=p>)</span>

    <span class=nd>@codebook</span><span class=o>.</span><span class=n>setter</span>
    <span class=k>def</span> <span class=nf>codebook</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>value</span><span class=p>:</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Set the codebook.</span>

<span class=sd>        Parameters</span>
<span class=sd>        ----------</span>
<span class=sd>        value : pd.DataFrame</span>
<span class=sd>            New codebook.</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=bp>self</span><span class=o>.</span><span class=n>_codebook</span> <span class=o>=</span> <span class=n>value</span>
        <span class=n>zattrs_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_calibrations_zarr_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;.zattrs&quot;</span><span class=p>)</span>
        <span class=n>calib_zattrs</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_json</span><span class=p>(</span><span class=n>zattrs_path</span><span class=p>)</span>
        <span class=n>calib_zattrs</span><span class=p>[</span><span class=s2>&quot;codebook&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_codebook</span><span class=o>.</span><span class=n>values</span><span class=o>.</span><span class=n>tolist</span><span class=p>()</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_save_to_json</span><span class=p>(</span><span class=n>calib_zattrs</span><span class=p>,</span> <span class=n>zattrs_path</span><span class=p>)</span>

    <span class=nd>@property</span>
    <span class=k>def</span> <span class=nf>voxel_size_zyx_um</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=n>ArrayLike</span><span class=p>]:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Voxel size, zyx order (microns).</span>

<span class=sd>        Returns</span>
<span class=sd>        -------</span>
<span class=sd>        voxel_size_zyx_um : ArrayLike</span>
<span class=sd>            Voxel size, zyx order (microns).</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=k>return</span> <span class=nb>getattr</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=s2>&quot;_voxel_size_zyx_um&quot;</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>

    <span class=nd>@voxel_size_zyx_um</span><span class=o>.</span><span class=n>setter</span>
    <span class=k>def</span> <span class=nf>voxel_size_zyx_um</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>value</span><span class=p>:</span> <span class=n>ArrayLike</span><span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Set the voxel size, zyx order (microns).</span>

<span class=sd>        Parameters</span>
<span class=sd>        ----------</span>
<span class=sd>        value : ArrayLike</span>
<span class=sd>            New voxel size, zyx order (microns).</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=bp>self</span><span class=o>.</span><span class=n>_voxel_size_zyx_um</span> <span class=o>=</span> <span class=n>value</span>
        <span class=n>zattrs_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_calibrations_zarr_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;.zattrs&quot;</span><span class=p>)</span>
        <span class=n>calib_zattrs</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_json</span><span class=p>(</span><span class=n>zattrs_path</span><span class=p>)</span>
        <span class=n>calib_zattrs</span><span class=p>[</span><span class=s2>&quot;voxel_size_zyx_um&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>value</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_save_to_json</span><span class=p>(</span><span class=n>calib_zattrs</span><span class=p>,</span> <span class=n>zattrs_path</span><span class=p>)</span>

    <span class=nd>@property</span>
    <span class=k>def</span> <span class=nf>baysor_path</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Union</span><span class=p>[</span><span class=n>Path</span><span class=p>,</span><span class=nb>str</span><span class=p>]:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Baysor path</span>

<span class=sd>        Returns</span>
<span class=sd>        -------</span>
<span class=sd>        baysor_path : Union[Path,str]</span>
<span class=sd>            Baysor path.</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=k>return</span> <span class=nb>getattr</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span><span class=s2>&quot;_baysor_path&quot;</span><span class=p>,</span><span class=kc>None</span><span class=p>)</span>

    <span class=nd>@baysor_path</span><span class=o>.</span><span class=n>setter</span>
    <span class=k>def</span> <span class=nf>baysor_path</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>value</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=n>Path</span><span class=p>,</span><span class=nb>str</span><span class=p>]):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Set the baysor path.</span>

<span class=sd>        Parameters</span>
<span class=sd>        ----------</span>
<span class=sd>        value : Union[Path,str]</span>
<span class=sd>            New baysor path.</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=k>if</span> <span class=n>value</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_baysor_path</span> <span class=o>=</span> <span class=kc>None</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_state</span><span class=p>[</span><span class=s2>&quot;BaysorPath&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_baysor_path</span> <span class=o>=</span> <span class=n>Path</span><span class=p>(</span><span class=n>value</span><span class=p>)</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_state</span><span class=p>[</span><span class=s2>&quot;BaysorPath&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_baysor_path</span><span class=p>)</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_save_to_json</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_datastore_state</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_state_json_path</span><span class=p>)</span>

    <span class=nd>@property</span>
    <span class=k>def</span> <span class=nf>baysor_options</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Union</span><span class=p>[</span><span class=n>Path</span><span class=p>,</span><span class=nb>str</span><span class=p>]:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Baysor options</span>

<span class=sd>        Returns</span>
<span class=sd>        -------</span>
<span class=sd>        baysor_options : Union[Path,str]</span>
<span class=sd>            Baysor options.</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=k>return</span> <span class=nb>getattr</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span><span class=s2>&quot;_baysor_options&quot;</span><span class=p>,</span><span class=kc>None</span><span class=p>)</span>

    <span class=nd>@baysor_options</span><span class=o>.</span><span class=n>setter</span>
    <span class=k>def</span> <span class=nf>baysor_options</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>value</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=n>Path</span><span class=p>,</span><span class=nb>str</span><span class=p>]):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Set the baysor options.</span>

<span class=sd>        Parameters</span>
<span class=sd>        ----------</span>
<span class=sd>        value : Union[Path,str]</span>
<span class=sd>            New baysor options.</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=k>if</span> <span class=n>value</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_baysor_path</span> <span class=o>=</span> <span class=kc>None</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_state</span><span class=p>[</span><span class=s2>&quot;BaysorPath&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_baysor_options</span> <span class=o>=</span> <span class=n>Path</span><span class=p>(</span><span class=n>value</span><span class=p>)</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_state</span><span class=p>[</span><span class=s2>&quot;BaysorOptions&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_baysor_options</span><span class=p>)</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_save_to_json</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_datastore_state</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_state_json_path</span><span class=p>)</span>

    <span class=nd>@property</span>
    <span class=k>def</span> <span class=nf>julia_threads</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>int</span><span class=p>:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Julia thread number</span>

<span class=sd>        Returns</span>
<span class=sd>        -------</span>
<span class=sd>        julia_threads : int</span>
<span class=sd>            Julia thread number.</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=k>return</span> <span class=nb>getattr</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span><span class=s2>&quot;_julia_threads&quot;</span><span class=p>,</span><span class=kc>None</span><span class=p>)</span>

    <span class=nd>@julia_threads</span><span class=o>.</span><span class=n>setter</span>
    <span class=k>def</span> <span class=nf>julia_threads</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>value</span><span class=p>:</span> <span class=nb>int</span><span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Set the julia thread number.</span>

<span class=sd>        Parameters</span>
<span class=sd>        ----------</span>
<span class=sd>        value : int</span>
<span class=sd>            New julia thread number.</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=bp>self</span><span class=o>.</span><span class=n>_julia_threads</span> <span class=o>=</span> <span class=n>value</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_state</span><span class=p>[</span><span class=s2>&quot;JuliaThreads&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_julia_threads</span><span class=p>)</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_save_to_json</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_datastore_state</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_state_json_path</span><span class=p>)</span>

    <span class=nd>@property</span>
    <span class=k>def</span> <span class=nf>global_normalization_vector</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=n>ArrayLike</span><span class=p>]:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Global normalization vector.</span>

<span class=sd>        Returns</span>
<span class=sd>        -------</span>
<span class=sd>        global_normalization_vector : ArrayLike</span>
<span class=sd>            Global normalization vector.</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=n>value</span> <span class=o>=</span> <span class=nb>getattr</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=s2>&quot;_global_normalization_vector&quot;</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>
        <span class=k>if</span> <span class=n>value</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
            <span class=n>zattrs_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_calibrations_zarr_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;.zattrs&quot;</span><span class=p>)</span>
            <span class=n>calib_zattrs</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_json</span><span class=p>(</span><span class=n>zattrs_path</span><span class=p>)</span>

            <span class=k>try</span><span class=p>:</span>
                <span class=n>value</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>asarray</span><span class=p>(</span>
                    <span class=n>calib_zattrs</span><span class=p>[</span><span class=s2>&quot;global_normalization_vector&quot;</span><span class=p>],</span> <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>float32</span>
                <span class=p>)</span>
                <span class=k>return</span> <span class=n>value</span>
            <span class=k>except</span> <span class=ne>KeyError</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Global normalization vector not calculated.&quot;</span><span class=p>)</span>
                <span class=k>return</span> <span class=kc>None</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=k>return</span> <span class=n>value</span>

    <span class=nd>@global_normalization_vector</span><span class=o>.</span><span class=n>setter</span>
    <span class=k>def</span> <span class=nf>global_normalization_vector</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>value</span><span class=p>:</span> <span class=n>ArrayLike</span><span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Set the global normalization vector.</span>

<span class=sd>        Parameters</span>
<span class=sd>        ----------</span>
<span class=sd>        value : ArrayLike</span>
<span class=sd>            New global normalization vector.</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=bp>self</span><span class=o>.</span><span class=n>_global_normalization_vector</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>asarray</span><span class=p>(</span><span class=n>value</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>float32</span><span class=p>)</span>
        <span class=n>zattrs_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_calibrations_zarr_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;.zattrs&quot;</span><span class=p>)</span>
        <span class=n>calib_zattrs</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_json</span><span class=p>(</span><span class=n>zattrs_path</span><span class=p>)</span>
        <span class=n>calib_zattrs</span><span class=p>[</span><span class=s2>&quot;global_normalization_vector&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_global_normalization_vector</span><span class=o>.</span><span class=n>tolist</span><span class=p>()</span>
        <span class=p>)</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_save_to_json</span><span class=p>(</span><span class=n>calib_zattrs</span><span class=p>,</span> <span class=n>zattrs_path</span><span class=p>)</span>

    <span class=nd>@property</span>
    <span class=k>def</span> <span class=nf>global_background_vector</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=n>ArrayLike</span><span class=p>]:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Global background vector.</span>

<span class=sd>        Returns</span>
<span class=sd>        -------</span>
<span class=sd>        global_background_vector : ArrayLike</span>
<span class=sd>            Global background vector.</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=n>value</span> <span class=o>=</span> <span class=nb>getattr</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=s2>&quot;_global_background_vector&quot;</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>
        <span class=k>if</span> <span class=n>value</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
            <span class=n>zattrs_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_calibrations_zarr_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;.zattrs&quot;</span><span class=p>)</span>
            <span class=n>calib_zattrs</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_json</span><span class=p>(</span><span class=n>zattrs_path</span><span class=p>)</span>
            <span class=k>try</span><span class=p>:</span>
                <span class=n>value</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>asarray</span><span class=p>(</span>
                    <span class=n>calib_zattrs</span><span class=p>[</span><span class=s2>&quot;global_background_vector&quot;</span><span class=p>],</span> <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>float32</span>
                <span class=p>)</span>
                <span class=k>return</span> <span class=n>value</span>
            <span class=k>except</span> <span class=ne>KeyError</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Global background vector not calculated.&quot;</span><span class=p>)</span>
                <span class=k>return</span> <span class=kc>None</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=k>return</span> <span class=n>value</span>

    <span class=nd>@global_background_vector</span><span class=o>.</span><span class=n>setter</span>
    <span class=k>def</span> <span class=nf>global_background_vector</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>value</span><span class=p>:</span> <span class=n>ArrayLike</span><span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Set the global background vector.</span>

<span class=sd>        Parameters</span>
<span class=sd>        ----------</span>
<span class=sd>        value : ArrayLike</span>
<span class=sd>            New global background vector.</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=bp>self</span><span class=o>.</span><span class=n>_global_background_vector</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>asarray</span><span class=p>(</span><span class=n>value</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>float32</span><span class=p>)</span>
        <span class=n>zattrs_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_calibrations_zarr_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;.zattrs&quot;</span><span class=p>)</span>
        <span class=n>calib_zattrs</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_json</span><span class=p>(</span><span class=n>zattrs_path</span><span class=p>)</span>
        <span class=n>calib_zattrs</span><span class=p>[</span><span class=s2>&quot;global_background_vector&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_global_background_vector</span><span class=o>.</span><span class=n>tolist</span><span class=p>()</span>
        <span class=p>)</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_save_to_json</span><span class=p>(</span><span class=n>calib_zattrs</span><span class=p>,</span> <span class=n>zattrs_path</span><span class=p>)</span>

    <span class=nd>@property</span>
    <span class=k>def</span> <span class=nf>iterative_normalization_vector</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=n>ArrayLike</span><span class=p>]:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Iterative normalization vector.</span>

<span class=sd>        Returns</span>
<span class=sd>        -------</span>
<span class=sd>        iterative_normalization_vector : ArrayLike</span>
<span class=sd>            Iterative normalization vector.</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=n>value</span> <span class=o>=</span> <span class=nb>getattr</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=s2>&quot;_iterative_normalization_vector&quot;</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>
        <span class=k>if</span> <span class=n>value</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
            <span class=n>zattrs_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_calibrations_zarr_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;.zattrs&quot;</span><span class=p>)</span>
            <span class=n>calib_zattrs</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_json</span><span class=p>(</span><span class=n>zattrs_path</span><span class=p>)</span>
            <span class=k>try</span><span class=p>:</span>
                <span class=n>value</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>asarray</span><span class=p>(</span>
                    <span class=n>calib_zattrs</span><span class=p>[</span><span class=s2>&quot;iterative_normalization_vector&quot;</span><span class=p>],</span> <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>float32</span>
                <span class=p>)</span>
            <span class=k>except</span> <span class=ne>KeyError</span><span class=p>:</span>
                <span class=n>value</span> <span class=o>=</span> <span class=kc>None</span>

            <span class=k>if</span> <span class=n>value</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Iterative normalization vector not calculated.&quot;</span><span class=p>)</span>
                <span class=k>return</span> <span class=kc>None</span>

            <span class=k>return</span> <span class=n>value</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=k>return</span> <span class=n>value</span>

    <span class=nd>@iterative_normalization_vector</span><span class=o>.</span><span class=n>setter</span>
    <span class=k>def</span> <span class=nf>iterative_normalization_vector</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>value</span><span class=p>:</span> <span class=n>ArrayLike</span><span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Set the iterative normalization vector.</span>

<span class=sd>        Parameters</span>
<span class=sd>        ----------</span>
<span class=sd>        value : ArrayLike</span>
<span class=sd>            New iterative normalization vector.</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=bp>self</span><span class=o>.</span><span class=n>_iterative_normalization_vector</span> <span class=o>=</span> <span class=n>value</span>
        <span class=n>zattrs_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_calibrations_zarr_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;.zattrs&quot;</span><span class=p>)</span>
        <span class=n>calib_zattrs</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_json</span><span class=p>(</span><span class=n>zattrs_path</span><span class=p>)</span>
        <span class=n>calib_zattrs</span><span class=p>[</span><span class=s2>&quot;iterative_normalization_vector&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_iterative_normalization_vector</span><span class=o>.</span><span class=n>tolist</span><span class=p>()</span>
        <span class=p>)</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_save_to_json</span><span class=p>(</span><span class=n>calib_zattrs</span><span class=p>,</span> <span class=n>zattrs_path</span><span class=p>)</span>

    <span class=nd>@property</span>
    <span class=k>def</span> <span class=nf>iterative_background_vector</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=n>ArrayLike</span><span class=p>]:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Iterative background vector.</span>

<span class=sd>        Returns</span>
<span class=sd>        -------</span>
<span class=sd>        iterative_background_vector : ArrayLike</span>
<span class=sd>            Iterative background vector.</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=n>value</span> <span class=o>=</span> <span class=nb>getattr</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=s2>&quot;_iterative_background_vector&quot;</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>
        <span class=k>if</span> <span class=n>value</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
            <span class=n>zattrs_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_calibrations_zarr_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;.zattrs&quot;</span><span class=p>)</span>
            <span class=n>calib_zattrs</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_json</span><span class=p>(</span><span class=n>zattrs_path</span><span class=p>)</span>
            <span class=k>try</span><span class=p>:</span>
                <span class=n>value</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>asarray</span><span class=p>(</span>
                    <span class=n>calib_zattrs</span><span class=p>[</span><span class=s2>&quot;iterative_background_vector&quot;</span><span class=p>],</span> <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>float32</span>
                <span class=p>)</span>
            <span class=k>except</span> <span class=ne>KeyError</span><span class=p>:</span>
                <span class=n>value</span> <span class=o>=</span> <span class=kc>None</span>
            <span class=k>if</span> <span class=n>value</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Iterative background vector not calculated.&quot;</span><span class=p>)</span>
                <span class=k>return</span> <span class=kc>None</span>

            <span class=k>return</span> <span class=n>value</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=k>return</span> <span class=n>value</span>

    <span class=nd>@iterative_background_vector</span><span class=o>.</span><span class=n>setter</span>
    <span class=k>def</span> <span class=nf>iterative_background_vector</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>value</span><span class=p>:</span> <span class=n>ArrayLike</span><span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Set the iterative background vector.</span>

<span class=sd>        Parameters</span>
<span class=sd>        ----------</span>
<span class=sd>        value : ArrayLike</span>
<span class=sd>            New iterative background vector.</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=bp>self</span><span class=o>.</span><span class=n>_iterative_background_vector</span> <span class=o>=</span> <span class=n>value</span>
        <span class=n>zattrs_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_calibrations_zarr_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;.zattrs&quot;</span><span class=p>)</span>
        <span class=n>calib_zattrs</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_json</span><span class=p>(</span><span class=n>zattrs_path</span><span class=p>)</span>
        <span class=n>calib_zattrs</span><span class=p>[</span><span class=s2>&quot;iterative_background_vector&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_iterative_background_vector</span><span class=o>.</span><span class=n>tolist</span><span class=p>()</span>
        <span class=p>)</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_save_to_json</span><span class=p>(</span><span class=n>calib_zattrs</span><span class=p>,</span> <span class=n>zattrs_path</span><span class=p>)</span>

    <span class=nd>@property</span>
    <span class=k>def</span> <span class=nf>tile_ids</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=n>Collection</span><span class=p>[</span><span class=nb>str</span><span class=p>]]:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Tile IDs.</span>

<span class=sd>        Returns</span>
<span class=sd>        -------</span>
<span class=sd>        tile_ids : Collection[str]</span>
<span class=sd>            Tile IDs.</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=k>return</span> <span class=nb>getattr</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=s2>&quot;_tile_ids&quot;</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>

    <span class=nd>@property</span>
    <span class=k>def</span> <span class=nf>round_ids</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=n>Collection</span><span class=p>[</span><span class=nb>str</span><span class=p>]]:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Round IDs.</span>

<span class=sd>        Returns</span>
<span class=sd>        -------</span>
<span class=sd>        round_ids : Collection[str]</span>
<span class=sd>            Round IDs.</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=k>return</span> <span class=nb>getattr</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=s2>&quot;_round_ids&quot;</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>

    <span class=nd>@property</span>
    <span class=k>def</span> <span class=nf>bit_ids</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=n>Collection</span><span class=p>[</span><span class=nb>str</span><span class=p>]]:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Bit IDs.</span>

<span class=sd>        Returns</span>
<span class=sd>        -------</span>
<span class=sd>        bit_ids : Collection[str]</span>
<span class=sd>            Bit IDs.</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=k>return</span> <span class=nb>getattr</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=s2>&quot;_bit_ids&quot;</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>

    <span class=k>def</span> <span class=nf>_init_datastore</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Initialize datastore.</span>

<span class=sd>        Create directory structure and initialize datastore state.</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_path</span><span class=o>.</span><span class=n>mkdir</span><span class=p>(</span><span class=n>parents</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_calibrations_zarr_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=sa>r</span><span class=s2>&quot;calibrations.zarr&quot;</span><span class=p>)</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_calibrations_zarr_path</span><span class=o>.</span><span class=n>mkdir</span><span class=p>()</span>
        <span class=n>calibrations_zattrs_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_calibrations_zarr_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=sa>r</span><span class=s2>&quot;.zattrs&quot;</span><span class=p>)</span>
        <span class=n>empty_zattrs</span> <span class=o>=</span> <span class=p>{}</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_save_to_json</span><span class=p>(</span><span class=n>empty_zattrs</span><span class=p>,</span> <span class=n>calibrations_zattrs_path</span><span class=p>)</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_polyDT_root_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=sa>r</span><span class=s2>&quot;polyDT&quot;</span><span class=p>)</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_polyDT_root_path</span><span class=o>.</span><span class=n>mkdir</span><span class=p>()</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_readouts_root_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=sa>r</span><span class=s2>&quot;readouts&quot;</span><span class=p>)</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_readouts_root_path</span><span class=o>.</span><span class=n>mkdir</span><span class=p>()</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_ufish_localizations_root_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span>
            <span class=sa>r</span><span class=s2>&quot;ufish_localizations&quot;</span>
        <span class=p>)</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_ufish_localizations_root_path</span><span class=o>.</span><span class=n>mkdir</span><span class=p>()</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_decoded_root_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=sa>r</span><span class=s2>&quot;decoded&quot;</span><span class=p>)</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_decoded_root_path</span><span class=o>.</span><span class=n>mkdir</span><span class=p>()</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_fused_root_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=sa>r</span><span class=s2>&quot;fused&quot;</span><span class=p>)</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_fused_root_path</span><span class=o>.</span><span class=n>mkdir</span><span class=p>()</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_segmentation_root_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=sa>r</span><span class=s2>&quot;segmentation&quot;</span><span class=p>)</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_segmentation_root_path</span><span class=o>.</span><span class=n>mkdir</span><span class=p>()</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_mtx_output_root_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=sa>r</span><span class=s2>&quot;mtx_output&quot;</span><span class=p>)</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_mtx_output_root_path</span><span class=o>.</span><span class=n>mkdir</span><span class=p>()</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_baysor_path</span> <span class=o>=</span> <span class=sa>r</span><span class=s2>&quot;&quot;</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_baysor_options</span> <span class=o>=</span> <span class=sa>r</span><span class=s2>&quot;&quot;</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_julia_threads</span> <span class=o>=</span> <span class=mi>0</span>

        <span class=c1># initialize datastore state</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_state_json_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span>
            <span class=sa>r</span><span class=s2>&quot;datastore_state.json&quot;</span>
        <span class=p>)</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_state</span> <span class=o>=</span> <span class=p>{</span>
            <span class=s2>&quot;Version&quot;</span><span class=p>:</span> <span class=mf>0.3</span><span class=p>,</span>
            <span class=s2>&quot;Initialized&quot;</span><span class=p>:</span> <span class=kc>True</span><span class=p>,</span>
            <span class=s2>&quot;Calibrations&quot;</span><span class=p>:</span> <span class=kc>False</span><span class=p>,</span>
            <span class=s2>&quot;Corrected&quot;</span><span class=p>:</span> <span class=kc>False</span><span class=p>,</span>
            <span class=s2>&quot;LocalRegistered&quot;</span><span class=p>:</span> <span class=kc>False</span><span class=p>,</span>
            <span class=s2>&quot;GlobalRegistered&quot;</span><span class=p>:</span> <span class=kc>False</span><span class=p>,</span>
            <span class=s2>&quot;Fused&quot;</span><span class=p>:</span> <span class=kc>False</span><span class=p>,</span>
            <span class=s2>&quot;SegmentedCells&quot;</span><span class=p>:</span> <span class=kc>False</span><span class=p>,</span>
            <span class=s2>&quot;DecodedSpots&quot;</span><span class=p>:</span> <span class=kc>False</span><span class=p>,</span>
            <span class=s2>&quot;FilteredSpots&quot;</span><span class=p>:</span> <span class=kc>False</span><span class=p>,</span>
            <span class=s2>&quot;RefinedSpots&quot;</span><span class=p>:</span> <span class=kc>False</span><span class=p>,</span>
            <span class=s2>&quot;mtxOutput&quot;</span><span class=p>:</span> <span class=kc>False</span><span class=p>,</span>
            <span class=s2>&quot;BaysorPath&quot;</span><span class=p>:</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_baysor_path</span><span class=p>),</span>
            <span class=s2>&quot;BaysorOptions&quot;</span><span class=p>:</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_baysor_options</span><span class=p>),</span>
            <span class=s2>&quot;JuliaThreads&quot;</span><span class=p>:</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_julia_threads</span><span class=p>)</span>
        <span class=p>}</span>

        <span class=bp>self</span><span class=o>.</span><span class=n>_save_to_json</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_datastore_state</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_state_json_path</span><span class=p>)</span>

    <span class=nd>@staticmethod</span>
    <span class=k>def</span> <span class=nf>_get_kvstore_key</span><span class=p>(</span><span class=n>path</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=n>Path</span><span class=p>,</span> <span class=nb>str</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=nb>dict</span><span class=p>:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Convert datastore location to tensorstore kvstore key.</span>

<span class=sd>        Parameters</span>
<span class=sd>        ----------</span>
<span class=sd>        path : Union[Path, str]</span>
<span class=sd>            Datastore location.</span>

<span class=sd>        Returns</span>
<span class=sd>        -------</span>
<span class=sd>        kvstore_key : dict</span>
<span class=sd>            Tensorstore kvstore key.</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=n>path_str</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span><span class=n>path</span><span class=p>)</span>
        <span class=k>if</span> <span class=n>path_str</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s2>&quot;s3://&quot;</span><span class=p>)</span> <span class=ow>or</span> <span class=s2>&quot;s3.amazonaws.com&quot;</span> <span class=ow>in</span> <span class=n>path_str</span><span class=p>:</span>
            <span class=k>return</span> <span class=p>{</span><span class=s2>&quot;driver&quot;</span><span class=p>:</span> <span class=s2>&quot;s3&quot;</span><span class=p>,</span> <span class=s2>&quot;path&quot;</span><span class=p>:</span> <span class=n>path_str</span><span class=p>}</span>
        <span class=k>elif</span> <span class=n>path_str</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s2>&quot;gs://&quot;</span><span class=p>)</span> <span class=ow>or</span> <span class=s2>&quot;storage.googleapis.com&quot;</span> <span class=ow>in</span> <span class=n>path_str</span><span class=p>:</span>
            <span class=k>return</span> <span class=p>{</span><span class=s2>&quot;driver&quot;</span><span class=p>:</span> <span class=s2>&quot;gcs&quot;</span><span class=p>,</span> <span class=s2>&quot;path&quot;</span><span class=p>:</span> <span class=n>path_str</span><span class=p>}</span>
        <span class=k>elif</span> <span class=n>path_str</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s2>&quot;azure://&quot;</span><span class=p>)</span> <span class=ow>or</span> <span class=s2>&quot;blob.core.windows.net&quot;</span> <span class=ow>in</span> <span class=n>path_str</span><span class=p>:</span>
            <span class=k>return</span> <span class=p>{</span><span class=s2>&quot;driver&quot;</span><span class=p>:</span> <span class=s2>&quot;azure&quot;</span><span class=p>,</span> <span class=s2>&quot;path&quot;</span><span class=p>:</span> <span class=n>path_str</span><span class=p>}</span>
        <span class=k>elif</span> <span class=n>path_str</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s2>&quot;http://&quot;</span><span class=p>)</span> <span class=ow>or</span> <span class=n>path_str</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s2>&quot;https://&quot;</span><span class=p>):</span>
            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&quot;Unsupported cloud storage provider in URL&quot;</span><span class=p>)</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=k>return</span> <span class=p>{</span><span class=s2>&quot;driver&quot;</span><span class=p>:</span> <span class=s2>&quot;file&quot;</span><span class=p>,</span> <span class=s2>&quot;path&quot;</span><span class=p>:</span> <span class=n>path_str</span><span class=p>}</span>

    <span class=nd>@staticmethod</span>
    <span class=k>def</span> <span class=nf>_load_from_json</span><span class=p>(</span><span class=n>dictionary_path</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=n>Path</span><span class=p>,</span> <span class=nb>str</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=nb>dict</span><span class=p>:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Load json as dictionary.</span>

<span class=sd>        Parameters</span>
<span class=sd>        ----------</span>
<span class=sd>        dictionary_path : Union[Path, str]</span>
<span class=sd>            Path to json file.</span>

<span class=sd>        Returns</span>
<span class=sd>        -------</span>
<span class=sd>        dictionary : dict</span>
<span class=sd>            Dictionary from json file.</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=k>try</span><span class=p>:</span>
            <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>dictionary_path</span><span class=p>,</span> <span class=s2>&quot;r&quot;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
                <span class=n>dictionary</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=n>f</span><span class=p>)</span>
        <span class=k>except</span> <span class=p>(</span><span class=ne>FileNotFoundError</span><span class=p>,</span> <span class=n>json</span><span class=o>.</span><span class=n>JSONDecodeError</span><span class=p>):</span>
            <span class=n>dictionary</span> <span class=o>=</span> <span class=p>{}</span>
        <span class=k>return</span> <span class=n>dictionary</span>

    <span class=nd>@staticmethod</span>
    <span class=k>def</span> <span class=nf>_save_to_json</span><span class=p>(</span><span class=n>dictionary</span><span class=p>:</span> <span class=nb>dict</span><span class=p>,</span> <span class=n>dictionary_path</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=n>Path</span><span class=p>,</span> <span class=nb>str</span><span class=p>]):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Save dictionary to json.</span>

<span class=sd>        Parameters</span>
<span class=sd>        ----------</span>
<span class=sd>        dictionary : dict</span>
<span class=sd>            The data to be saved.</span>
<span class=sd>        dictionary_path : Union[Path,str]</span>
<span class=sd>            The path to the JSON file where the data will be saved.</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>dictionary_path</span><span class=p>,</span> <span class=s2>&quot;w&quot;</span><span class=p>)</span> <span class=k>as</span> <span class=n>file</span><span class=p>:</span>
            <span class=n>json</span><span class=o>.</span><span class=n>dump</span><span class=p>(</span><span class=n>dictionary</span><span class=p>,</span> <span class=n>file</span><span class=p>,</span> <span class=n>indent</span><span class=o>=</span><span class=mi>4</span><span class=p>)</span>

    <span class=nd>@staticmethod</span>
    <span class=k>def</span> <span class=nf>_load_from_microjson</span><span class=p>(</span><span class=n>dictionary_path</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=n>Path</span><span class=p>,</span> <span class=nb>str</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=nb>dict</span><span class=p>:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Load cell outlines outlines microjson as dictionary.</span>

<span class=sd>        Parameters</span>
<span class=sd>        ----------</span>
<span class=sd>        dictionary_path : Union[Path, str]</span>
<span class=sd>            Path to microjson file.</span>

<span class=sd>        Returns</span>
<span class=sd>        -------</span>
<span class=sd>        outlines : dict</span>
<span class=sd>            Cell outlines dictionary.</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=k>try</span><span class=p>:</span>
            <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>dictionary_path</span><span class=p>,</span> <span class=s2>&quot;r&quot;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
                <span class=n>data</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=n>f</span><span class=p>)</span>
                <span class=n>outlines</span> <span class=o>=</span> <span class=p>{}</span>
                <span class=k>for</span> <span class=n>feature</span> <span class=ow>in</span> <span class=n>data</span><span class=p>[</span><span class=s2>&quot;features&quot;</span><span class=p>]:</span>
                    <span class=n>cell_id</span> <span class=o>=</span> <span class=n>feature</span><span class=p>[</span><span class=s2>&quot;properties&quot;</span><span class=p>][</span><span class=s2>&quot;cell_id&quot;</span><span class=p>]</span>
                    <span class=n>coordinates</span> <span class=o>=</span> <span class=n>feature</span><span class=p>[</span><span class=s2>&quot;geometry&quot;</span><span class=p>][</span><span class=s2>&quot;coordinates&quot;</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span>
                    <span class=n>outlines</span><span class=p>[</span><span class=n>cell_id</span><span class=p>]</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>(</span><span class=n>coordinates</span><span class=p>)</span>
        <span class=k>except</span> <span class=p>(</span><span class=ne>FileNotFoundError</span><span class=p>,</span> <span class=n>json</span><span class=o>.</span><span class=n>JSONDecodeError</span><span class=p>,</span> <span class=ne>KeyError</span><span class=p>,</span> <span class=ne>TypeError</span><span class=p>,</span> <span class=ne>ValueError</span><span class=p>):</span>
            <span class=n>outlines</span> <span class=o>=</span> <span class=p>{}</span>
        <span class=k>return</span> <span class=n>outlines</span>

    <span class=nd>@staticmethod</span>
    <span class=k>def</span> <span class=nf>_check_for_zarr_array</span><span class=p>(</span><span class=n>kvstore</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=n>Path</span><span class=p>,</span> <span class=nb>str</span><span class=p>],</span> <span class=n>spec</span><span class=p>:</span> <span class=nb>dict</span><span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Check if zarr array exists using Tensortore.</span>

<span class=sd>        Parameters</span>
<span class=sd>        ----------</span>
<span class=sd>        kvstore : Union[Path, str]</span>
<span class=sd>            Datastore location.</span>
<span class=sd>        spec : dict</span>
<span class=sd>            Zarr specification.</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=n>current_zarr</span> <span class=o>=</span> <span class=n>ts</span><span class=o>.</span><span class=n>open</span><span class=p>(</span>
            <span class=p>{</span>
                <span class=o>**</span><span class=n>spec</span><span class=p>,</span>
                <span class=s2>&quot;kvstore&quot;</span><span class=p>:</span> <span class=n>kvstore</span><span class=p>,</span>
            <span class=p>}</span>
        <span class=p>)</span><span class=o>.</span><span class=n>result</span><span class=p>()</span>

        <span class=k>del</span> <span class=n>current_zarr</span>

    <span class=nd>@staticmethod</span>
    <span class=k>def</span> <span class=nf>_load_from_zarr_array</span><span class=p>(</span>
        <span class=n>kvstore</span><span class=p>:</span> <span class=nb>dict</span><span class=p>,</span> <span class=n>spec</span><span class=p>:</span> <span class=nb>dict</span><span class=p>,</span> <span class=n>return_future</span><span class=o>=</span><span class=kc>True</span>
    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>ArrayLike</span><span class=p>:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Return tensorstore array from zarr</span>

<span class=sd>        Defaults to returning future result.</span>

<span class=sd>        Parameters</span>
<span class=sd>        ----------</span>
<span class=sd>        kvstore : dict</span>
<span class=sd>            Tensorstore kvstore specification.</span>
<span class=sd>        spec : dict</span>
<span class=sd>            Tensorstore zarr specification.</span>
<span class=sd>        return_future : bool</span>
<span class=sd>            Return future (True) or immediately read (False).</span>

<span class=sd>        Returns</span>
<span class=sd>        -------</span>
<span class=sd>        array : ArrayLike</span>
<span class=sd>            Delayed (future) or immediate array.</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=n>current_zarr</span> <span class=o>=</span> <span class=n>ts</span><span class=o>.</span><span class=n>open</span><span class=p>(</span>
            <span class=p>{</span>
                <span class=o>**</span><span class=n>spec</span><span class=p>,</span>
                <span class=s2>&quot;kvstore&quot;</span><span class=p>:</span> <span class=n>kvstore</span><span class=p>,</span>
            <span class=p>}</span>
        <span class=p>)</span><span class=o>.</span><span class=n>result</span><span class=p>()</span>

        <span class=n>read_future</span> <span class=o>=</span> <span class=n>current_zarr</span><span class=o>.</span><span class=n>read</span><span class=p>()</span>

        <span class=k>if</span> <span class=n>return_future</span><span class=p>:</span>
            <span class=k>return</span> <span class=n>read_future</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=k>return</span> <span class=n>read_future</span><span class=o>.</span><span class=n>result</span><span class=p>()</span>

    <span class=nd>@staticmethod</span>
    <span class=k>def</span> <span class=nf>_save_to_zarr_array</span><span class=p>(</span>
        <span class=n>array</span><span class=p>:</span> <span class=n>ArrayLike</span><span class=p>,</span>
        <span class=n>kvstore</span><span class=p>:</span> <span class=nb>dict</span><span class=p>,</span>
        <span class=n>spec</span><span class=p>:</span> <span class=nb>dict</span><span class=p>,</span>
        <span class=n>return_future</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>bool</span><span class=p>]</span> <span class=o>=</span> <span class=kc>False</span><span class=p>,</span>
    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=n>ArrayLike</span><span class=p>]:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Save array to zarr using tensorstore.</span>

<span class=sd>        Defaults to returning future result.</span>

<span class=sd>        Parameters</span>
<span class=sd>        ----------</span>
<span class=sd>        array : ArrayLike</span>
<span class=sd>            Array to save.</span>
<span class=sd>        kvstore : dict</span>
<span class=sd>            Tensorstore kvstore specification.</span>
<span class=sd>        spec : dict</span>
<span class=sd>            Tensorstore zarr specification.</span>
<span class=sd>        return_future : Optional[bool]</span>
<span class=sd>            Return future (True) or immediately write (False).</span>

<span class=sd>        Returns</span>
<span class=sd>        -------</span>
<span class=sd>        write_future : Optional[ArrayLike]</span>
<span class=sd>            Delayed (future) if return_future is True.</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=c1># check datatype</span>
        <span class=k>if</span> <span class=nb>str</span><span class=p>(</span><span class=n>array</span><span class=o>.</span><span class=n>dtype</span><span class=p>)</span> <span class=o>==</span> <span class=s2>&quot;uint8&quot;</span><span class=p>:</span>
            <span class=n>array_dtype</span> <span class=o>=</span> <span class=s2>&quot;&lt;u1&quot;</span>
        <span class=k>elif</span> <span class=nb>str</span><span class=p>(</span><span class=n>array</span><span class=o>.</span><span class=n>dtype</span><span class=p>)</span> <span class=o>==</span> <span class=s2>&quot;uint16&quot;</span><span class=p>:</span>
            <span class=n>array_dtype</span> <span class=o>=</span> <span class=s2>&quot;&lt;u2&quot;</span>
        <span class=k>elif</span> <span class=nb>str</span><span class=p>(</span><span class=n>array</span><span class=o>.</span><span class=n>dtype</span><span class=p>)</span> <span class=o>==</span> <span class=s2>&quot;float16&quot;</span><span class=p>:</span>
            <span class=n>array_dtype</span> <span class=o>=</span> <span class=s2>&quot;&lt;f2&quot;</span>
        <span class=k>elif</span> <span class=nb>str</span><span class=p>(</span><span class=n>array</span><span class=o>.</span><span class=n>dtype</span><span class=p>)</span> <span class=o>==</span> <span class=s2>&quot;float32&quot;</span><span class=p>:</span>
            <span class=n>array_dtype</span> <span class=o>=</span> <span class=s2>&quot;&lt;f4&quot;</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Unsupported data type: &quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=n>array</span><span class=o>.</span><span class=n>dtype</span><span class=p>))</span>
            <span class=k>return</span> <span class=kc>None</span>

        <span class=c1># check array dimension</span>
        <span class=n>spec</span><span class=p>[</span><span class=s2>&quot;metadata&quot;</span><span class=p>][</span><span class=s2>&quot;shape&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>array</span><span class=o>.</span><span class=n>shape</span>
        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>array</span><span class=o>.</span><span class=n>shape</span><span class=p>)</span> <span class=o>==</span> <span class=mi>2</span><span class=p>:</span>
            <span class=n>spec</span><span class=p>[</span><span class=s2>&quot;metadata&quot;</span><span class=p>][</span><span class=s2>&quot;chunks&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=p>[</span><span class=n>array</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>array</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>]]</span>
        <span class=k>elif</span> <span class=nb>len</span><span class=p>(</span><span class=n>array</span><span class=o>.</span><span class=n>shape</span><span class=p>)</span> <span class=o>==</span> <span class=mi>3</span><span class=p>:</span>
            <span class=n>spec</span><span class=p>[</span><span class=s2>&quot;metadata&quot;</span><span class=p>][</span><span class=s2>&quot;chunks&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=n>array</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>array</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>2</span><span class=p>]]</span>
        <span class=k>elif</span> <span class=nb>len</span><span class=p>(</span><span class=n>array</span><span class=o>.</span><span class=n>shape</span><span class=p>)</span> <span class=o>==</span> <span class=mi>4</span><span class=p>:</span>
            <span class=n>spec</span><span class=p>[</span><span class=s2>&quot;metadata&quot;</span><span class=p>][</span><span class=s2>&quot;chunks&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>array</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>array</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>2</span><span class=p>]]</span>
        <span class=n>spec</span><span class=p>[</span><span class=s2>&quot;metadata&quot;</span><span class=p>][</span><span class=s2>&quot;dtype&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>array_dtype</span>

        <span class=k>try</span><span class=p>:</span>
            <span class=n>current_zarr</span> <span class=o>=</span> <span class=n>ts</span><span class=o>.</span><span class=n>open</span><span class=p>(</span>
                <span class=p>{</span>
                    <span class=o>**</span><span class=n>spec</span><span class=p>,</span>
                    <span class=s2>&quot;kvstore&quot;</span><span class=p>:</span> <span class=n>kvstore</span><span class=p>,</span>
                <span class=p>}</span>
            <span class=p>)</span><span class=o>.</span><span class=n>result</span><span class=p>()</span>

            <span class=n>write_future</span> <span class=o>=</span> <span class=n>current_zarr</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>array</span><span class=p>)</span>

            <span class=k>if</span> <span class=n>return_future</span><span class=p>:</span>
                <span class=k>return</span> <span class=n>write_future</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>write_future</span><span class=o>.</span><span class=n>result</span><span class=p>()</span>
                <span class=k>return</span> <span class=kc>None</span>
        <span class=k>except</span> <span class=p>(</span><span class=ne>IOError</span><span class=p>,</span> <span class=ne>OSError</span><span class=p>,</span> <span class=ne>TimeoutError</span><span class=p>):</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Error writing zarr array.&quot;</span><span class=p>)</span>

    <span class=nd>@staticmethod</span>
    <span class=k>def</span> <span class=nf>_load_from_parquet</span><span class=p>(</span><span class=n>parquet_path</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=n>Path</span><span class=p>,</span> <span class=nb>str</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Load dataframe from parquet.</span>

<span class=sd>        Parameters</span>
<span class=sd>        ----------</span>
<span class=sd>        parquet_path : Union[Path, str]</span>
<span class=sd>            Path to parquet file.</span>

<span class=sd>        Returns</span>
<span class=sd>        -------</span>
<span class=sd>        df : pd.DataFrame</span>
<span class=sd>            Dataframe from parquet file.</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=k>return</span> <span class=n>pd</span><span class=o>.</span><span class=n>read_parquet</span><span class=p>(</span><span class=n>parquet_path</span><span class=p>)</span>

    <span class=nd>@staticmethod</span>
    <span class=k>def</span> <span class=nf>_save_to_parquet</span><span class=p>(</span><span class=n>df</span><span class=p>:</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>,</span> <span class=n>parquet_path</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=n>Path</span><span class=p>,</span> <span class=nb>str</span><span class=p>]):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Save dataframe to parquet.</span>

<span class=sd>        Parameters</span>
<span class=sd>        ----------</span>
<span class=sd>        df : pd.DataFrame</span>
<span class=sd>            Dataframe to save.</span>
<span class=sd>        parquet_path : Union[Path, str]</span>
<span class=sd>            Path to parquet file.</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=n>df</span><span class=o>.</span><span class=n>to_parquet</span><span class=p>(</span><span class=n>parquet_path</span><span class=p>)</span>

    <span class=k>def</span> <span class=nf>_parse_datastore</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Parse datastore to discover available components.&quot;&quot;&quot;</span>

        <span class=c1># directory structure as defined by qi2lab spec</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_calibrations_zarr_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=sa>r</span><span class=s2>&quot;calibrations.zarr&quot;</span><span class=p>)</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_polyDT_root_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=sa>r</span><span class=s2>&quot;polyDT&quot;</span><span class=p>)</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_readouts_root_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=sa>r</span><span class=s2>&quot;readouts&quot;</span><span class=p>)</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_ufish_localizations_root_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span>
            <span class=sa>r</span><span class=s2>&quot;ufish_localizations&quot;</span>
        <span class=p>)</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_decoded_root_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=sa>r</span><span class=s2>&quot;decoded&quot;</span><span class=p>)</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_fused_root_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=sa>r</span><span class=s2>&quot;fused&quot;</span><span class=p>)</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_segmentation_root_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=sa>r</span><span class=s2>&quot;segmentation&quot;</span><span class=p>)</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_mtx_output_root_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=sa>r</span><span class=s2>&quot;mtx_output&quot;</span><span class=p>)</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_state_json_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span>
            <span class=sa>r</span><span class=s2>&quot;datastore_state.json&quot;</span>
        <span class=p>)</span>

        <span class=c1># read in .json in root directory that indicates what steps have been run</span>
        <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_datastore_state_json_path</span><span class=p>,</span> <span class=s2>&quot;r&quot;</span><span class=p>)</span> <span class=k>as</span> <span class=n>json_file</span><span class=p>:</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_state</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=n>json_file</span><span class=p>)</span>

        <span class=c1># validate calibrations.zarr</span>
        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_state</span><span class=p>[</span><span class=s2>&quot;Calibrations&quot;</span><span class=p>]:</span>
            <span class=k>if</span> <span class=ow>not</span> <span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_calibrations_zarr_path</span><span class=o>.</span><span class=n>exists</span><span class=p>()):</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Calibration data error.&quot;</span><span class=p>)</span>
            <span class=k>try</span><span class=p>:</span>
                <span class=n>zattrs_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_calibrations_zarr_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;.zattrs&quot;</span><span class=p>)</span>
                <span class=n>attributes</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_json</span><span class=p>(</span><span class=n>zattrs_path</span><span class=p>)</span>
            <span class=k>except</span> <span class=p>(</span><span class=ne>FileNotFoundError</span><span class=p>,</span> <span class=n>json</span><span class=o>.</span><span class=n>JSONDecodeError</span><span class=p>):</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Calibration attributes not found&quot;</span><span class=p>)</span>

            <span class=n>keys_to_check</span> <span class=o>=</span> <span class=p>[</span>
                <span class=s2>&quot;num_rounds&quot;</span><span class=p>,</span>
                <span class=s2>&quot;num_tiles&quot;</span><span class=p>,</span>
                <span class=s2>&quot;channels_in_data&quot;</span><span class=p>,</span>
                <span class=s2>&quot;tile_overlap&quot;</span><span class=p>,</span>
                <span class=s2>&quot;binning&quot;</span><span class=p>,</span>
                <span class=s2>&quot;e_per_ADU&quot;</span><span class=p>,</span>
                <span class=s2>&quot;na&quot;</span><span class=p>,</span>
                <span class=s2>&quot;ri&quot;</span><span class=p>,</span>
                <span class=s2>&quot;exp_order&quot;</span><span class=p>,</span>
                <span class=s2>&quot;codebook&quot;</span><span class=p>,</span>
                <span class=s2>&quot;num_bits&quot;</span>
            <span class=p>]</span>
            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_state</span><span class=p>[</span><span class=s2>&quot;Version&quot;</span><span class=p>]</span> <span class=o>==</span> <span class=mf>0.3</span><span class=p>:</span>
                <span class=n>keys_to_check</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s2>&quot;microscope_type&quot;</span><span class=p>)</span>
                <span class=n>keys_to_check</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s2>&quot;camera_model&quot;</span><span class=p>)</span>
                <span class=n>keys_to_check</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s2>&quot;voxel_size_zyx_um&quot;</span><span class=p>)</span>
            <span class=k>for</span> <span class=n>key</span> <span class=ow>in</span> <span class=n>keys_to_check</span><span class=p>:</span>
                <span class=k>if</span> <span class=n>key</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>attributes</span><span class=o>.</span><span class=n>keys</span><span class=p>():</span>
                    <span class=k>raise</span> <span class=ne>KeyError</span><span class=p>(</span><span class=s2>&quot;Calibration attributes incomplete&quot;</span><span class=p>)</span>
                <span class=k>else</span><span class=p>:</span>
                    <span class=nb>setattr</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=s2>&quot;_&quot;</span> <span class=o>+</span> <span class=n>key</span><span class=p>,</span> <span class=n>attributes</span><span class=p>[</span><span class=n>key</span><span class=p>])</span>

            <span class=n>current_local_zarr_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_calibrations_zarr_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;psf_data&quot;</span><span class=p>)</span>
            <span class=p>)</span>

            <span class=k>try</span><span class=p>:</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_psfs</span> <span class=o>=</span> <span class=p>(</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_zarr_array</span><span class=p>(</span>
                        <span class=n>kvstore</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>_get_kvstore_key</span><span class=p>(</span><span class=n>current_local_zarr_path</span><span class=p>),</span>
                        <span class=n>spec</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>_zarrv2_spec</span><span class=o>.</span><span class=n>copy</span><span class=p>(),</span>
                    <span class=p>)</span>
                <span class=p>)</span><span class=o>.</span><span class=n>result</span><span class=p>()</span>
            <span class=k>except</span> <span class=p>(</span><span class=ne>IOError</span><span class=p>,</span> <span class=ne>OSError</span><span class=p>,</span> <span class=n>ZarrError</span><span class=p>):</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Calibration psfs missing.&quot;</span><span class=p>)</span>

            <span class=k>del</span> <span class=n>current_local_zarr_path</span>

            <span class=c1># current_local_zarr_path = str(</span>
            <span class=c1>#     self._calibrations_zarr_path / Path(&quot;noise_map&quot;)</span>
            <span class=c1># )</span>

            <span class=c1># try:</span>
            <span class=c1>#     self._noise_map = (</span>
            <span class=c1>#         self._load_from_zarr_array(</span>
            <span class=c1>#             kvstore=self._get_kvstore_key(current_local_zarr_path),</span>
            <span class=c1>#             spec=self._zarrv2_spec,</span>
            <span class=c1>#         )</span>
            <span class=c1>#     ).result()</span>
            <span class=c1># except Exception:</span>
            <span class=c1>#     print(&quot;Calibration noise map missing.&quot;)</span>

        <span class=c1># validate polyDT and readout bits data</span>
        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_state</span><span class=p>[</span><span class=s2>&quot;Corrected&quot;</span><span class=p>]:</span>
            <span class=k>if</span> <span class=ow>not</span> <span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_polyDT_root_path</span><span class=o>.</span><span class=n>exists</span><span class=p>()):</span>
                <span class=k>raise</span> <span class=ne>FileNotFoundError</span><span class=p>(</span><span class=s2>&quot;PolyDT directory not initialized&quot;</span><span class=p>)</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>polyDT_tile_ids</span> <span class=o>=</span> <span class=nb>sorted</span><span class=p>(</span>
                    <span class=p>[</span>
                        <span class=n>entry</span><span class=o>.</span><span class=n>name</span>
                        <span class=k>for</span> <span class=n>entry</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_polyDT_root_path</span><span class=o>.</span><span class=n>iterdir</span><span class=p>()</span>
                        <span class=k>if</span> <span class=n>entry</span><span class=o>.</span><span class=n>is_dir</span><span class=p>()</span>
                    <span class=p>],</span>
                    <span class=n>key</span><span class=o>=</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=nb>int</span><span class=p>(</span><span class=n>x</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&quot;tile&quot;</span><span class=p>)[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&quot;.zarr&quot;</span><span class=p>)[</span><span class=mi>0</span><span class=p>]),</span>
                <span class=p>)</span>
                <span class=n>current_tile_dir_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_polyDT_root_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span>
                    <span class=n>polyDT_tile_ids</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
                <span class=p>)</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_round_ids</span> <span class=o>=</span> <span class=nb>sorted</span><span class=p>(</span>
                    <span class=p>[</span>
                        <span class=n>entry</span><span class=o>.</span><span class=n>name</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&quot;.&quot;</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
                        <span class=k>for</span> <span class=n>entry</span> <span class=ow>in</span> <span class=n>current_tile_dir_path</span><span class=o>.</span><span class=n>iterdir</span><span class=p>()</span>
                        <span class=k>if</span> <span class=n>entry</span><span class=o>.</span><span class=n>is_dir</span><span class=p>()</span>
                    <span class=p>],</span>
                    <span class=n>key</span><span class=o>=</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=nb>int</span><span class=p>(</span><span class=n>x</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&quot;round&quot;</span><span class=p>)[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&quot;.zarr&quot;</span><span class=p>)[</span><span class=mi>0</span><span class=p>]),</span>
                <span class=p>)</span>
            <span class=k>if</span> <span class=ow>not</span> <span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_readouts_root_path</span><span class=o>.</span><span class=n>exists</span><span class=p>()):</span>
                <span class=k>raise</span> <span class=ne>FileNotFoundError</span><span class=p>(</span><span class=s2>&quot;Readout directory not initialized&quot;</span><span class=p>)</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>readout_tile_ids</span> <span class=o>=</span> <span class=nb>sorted</span><span class=p>(</span>
                    <span class=p>[</span>
                        <span class=n>entry</span><span class=o>.</span><span class=n>name</span>
                        <span class=k>for</span> <span class=n>entry</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_readouts_root_path</span><span class=o>.</span><span class=n>iterdir</span><span class=p>()</span>
                        <span class=k>if</span> <span class=n>entry</span><span class=o>.</span><span class=n>is_dir</span><span class=p>()</span>
                    <span class=p>],</span>
                    <span class=n>key</span><span class=o>=</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=nb>int</span><span class=p>(</span><span class=n>x</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&quot;tile&quot;</span><span class=p>)[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&quot;.zarr&quot;</span><span class=p>)[</span><span class=mi>0</span><span class=p>]),</span>
                <span class=p>)</span>
                <span class=n>current_tile_dir_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_readouts_root_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span>
                    <span class=n>readout_tile_ids</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
                <span class=p>)</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span> <span class=o>=</span> <span class=nb>sorted</span><span class=p>(</span>
                    <span class=p>[</span>
                        <span class=n>entry</span><span class=o>.</span><span class=n>name</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&quot;.&quot;</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
                        <span class=k>for</span> <span class=n>entry</span> <span class=ow>in</span> <span class=n>current_tile_dir_path</span><span class=o>.</span><span class=n>iterdir</span><span class=p>()</span>
                        <span class=k>if</span> <span class=n>entry</span><span class=o>.</span><span class=n>is_dir</span><span class=p>()</span>
                    <span class=p>],</span>
                    <span class=n>key</span><span class=o>=</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=nb>int</span><span class=p>(</span><span class=n>x</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&quot;bit&quot;</span><span class=p>)[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&quot;.zarr&quot;</span><span class=p>)[</span><span class=mi>0</span><span class=p>]),</span>
                <span class=p>)</span>
            <span class=k>assert</span> <span class=p>(</span>
                <span class=n>polyDT_tile_ids</span> <span class=o>==</span> <span class=n>readout_tile_ids</span>
            <span class=p>),</span> <span class=s2>&quot;polyDT and readout tile ids do not match. Conversion error.&quot;</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span> <span class=o>=</span> <span class=n>polyDT_tile_ids</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>
            <span class=k>del</span> <span class=n>polyDT_tile_ids</span><span class=p>,</span> <span class=n>readout_tile_ids</span>

            <span class=k>for</span> <span class=n>tile_id</span><span class=p>,</span> <span class=n>round_id</span> <span class=ow>in</span> <span class=n>product</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>_round_ids</span><span class=p>):</span>
                <span class=k>try</span><span class=p>:</span>
                    <span class=n>zattrs_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
                        <span class=bp>self</span><span class=o>.</span><span class=n>_polyDT_root_path</span>
                        <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
                        <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>round_id</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
                        <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;.zattrs&quot;</span><span class=p>)</span>
                    <span class=p>)</span>
                    <span class=n>attributes</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_json</span><span class=p>(</span><span class=n>zattrs_path</span><span class=p>)</span>
                <span class=k>except</span> <span class=p>(</span><span class=ne>FileNotFoundError</span><span class=p>,</span> <span class=n>json</span><span class=o>.</span><span class=n>JSONDecodeError</span><span class=p>):</span>
                    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;polyDT tile attributes not found&quot;</span><span class=p>)</span>

                <span class=n>keys_to_check</span> <span class=o>=</span> <span class=p>[</span>
                    <span class=s2>&quot;stage_zyx_um&quot;</span><span class=p>,</span>
                    <span class=s2>&quot;excitation_um&quot;</span><span class=p>,</span>
                    <span class=s2>&quot;emission_um&quot;</span><span class=p>,</span>
                    <span class=s2>&quot;bit_linker&quot;</span><span class=p>,</span>
                    <span class=c1># &quot;exposure_ms&quot;,</span>
                    <span class=s2>&quot;psf_idx&quot;</span><span class=p>,</span>
                <span class=p>]</span>

                <span class=k>for</span> <span class=n>key</span> <span class=ow>in</span> <span class=n>keys_to_check</span><span class=p>:</span>
                    <span class=k>if</span> <span class=n>key</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>attributes</span><span class=o>.</span><span class=n>keys</span><span class=p>():</span>
                        <span class=nb>print</span><span class=p>(</span><span class=n>tile_id</span><span class=p>,</span> <span class=n>round_id</span><span class=p>,</span> <span class=n>key</span><span class=p>)</span>
                        <span class=k>raise</span> <span class=ne>KeyError</span><span class=p>(</span><span class=s2>&quot;Corrected polyDT attributes incomplete&quot;</span><span class=p>)</span>

                <span class=n>current_local_zarr_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>_polyDT_root_path</span>
                    <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
                    <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>round_id</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
                    <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;corrected_data&quot;</span><span class=p>)</span>
                <span class=p>)</span>

                <span class=k>try</span><span class=p>:</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>_check_for_zarr_array</span><span class=p>(</span>
                        <span class=bp>self</span><span class=o>.</span><span class=n>_get_kvstore_key</span><span class=p>(</span><span class=n>current_local_zarr_path</span><span class=p>),</span>
                        <span class=bp>self</span><span class=o>.</span><span class=n>_zarrv2_spec</span><span class=o>.</span><span class=n>copy</span><span class=p>(),</span>
                    <span class=p>)</span>
                <span class=k>except</span> <span class=p>(</span><span class=ne>IOError</span><span class=p>,</span> <span class=ne>OSError</span><span class=p>,</span> <span class=n>ZarrError</span><span class=p>):</span>
                    <span class=nb>print</span><span class=p>(</span><span class=n>tile_id</span><span class=p>,</span> <span class=n>round_id</span><span class=p>)</span>
                    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Corrected polyDT data missing.&quot;</span><span class=p>)</span>

            <span class=k>for</span> <span class=n>tile_id</span><span class=p>,</span> <span class=n>bit_id</span> <span class=ow>in</span> <span class=n>product</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>):</span>
                <span class=k>try</span><span class=p>:</span>
                    <span class=n>zattrs_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
                        <span class=bp>self</span><span class=o>.</span><span class=n>_readouts_root_path</span>
                        <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
                        <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>bit_id</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
                        <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;.zattrs&quot;</span><span class=p>)</span>
                    <span class=p>)</span>
                    <span class=n>attributes</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_json</span><span class=p>(</span><span class=n>zattrs_path</span><span class=p>)</span>
                <span class=k>except</span> <span class=p>(</span><span class=ne>FileNotFoundError</span><span class=p>,</span> <span class=n>json</span><span class=o>.</span><span class=n>JSONDecodeError</span><span class=p>):</span>
                    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Readout tile attributes not found&quot;</span><span class=p>)</span>

                <span class=n>keys_to_check</span> <span class=o>=</span> <span class=p>[</span>
                    <span class=s2>&quot;excitation_um&quot;</span><span class=p>,</span>
                    <span class=s2>&quot;emission_um&quot;</span><span class=p>,</span>
                    <span class=s2>&quot;round_linker&quot;</span><span class=p>,</span>
                    <span class=c1># &quot;exposure_ms&quot;,</span>
                    <span class=s2>&quot;psf_idx&quot;</span><span class=p>,</span>
                <span class=p>]</span>
                <span class=k>for</span> <span class=n>key</span> <span class=ow>in</span> <span class=n>keys_to_check</span><span class=p>:</span>
                    <span class=k>if</span> <span class=n>key</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>attributes</span><span class=o>.</span><span class=n>keys</span><span class=p>():</span>
                        <span class=k>raise</span> <span class=ne>KeyError</span><span class=p>(</span><span class=s2>&quot;Corrected readout attributes incomplete&quot;</span><span class=p>)</span>

                <span class=n>current_local_zarr_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>_readouts_root_path</span>
                    <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
                    <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>bit_id</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
                    <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;corrected_data&quot;</span><span class=p>)</span>
                <span class=p>)</span>

                <span class=k>try</span><span class=p>:</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>_check_for_zarr_array</span><span class=p>(</span>
                        <span class=bp>self</span><span class=o>.</span><span class=n>_get_kvstore_key</span><span class=p>(</span><span class=n>current_local_zarr_path</span><span class=p>),</span>
                        <span class=bp>self</span><span class=o>.</span><span class=n>_zarrv2_spec</span><span class=o>.</span><span class=n>copy</span><span class=p>(),</span>
                    <span class=p>)</span>
                <span class=k>except</span> <span class=p>(</span><span class=ne>IOError</span><span class=p>,</span> <span class=ne>OSError</span><span class=p>,</span> <span class=n>ZarrError</span><span class=p>):</span>
                    <span class=nb>print</span><span class=p>(</span><span class=n>tile_id</span><span class=p>,</span> <span class=n>bit_id</span><span class=p>)</span>
                    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Corrected readout data missing.&quot;</span><span class=p>)</span>

        <span class=c1># check and validate local registered data</span>
        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_state</span><span class=p>[</span><span class=s2>&quot;LocalRegistered&quot;</span><span class=p>]:</span>
            <span class=k>for</span> <span class=n>tile_id</span><span class=p>,</span> <span class=n>round_id</span> <span class=ow>in</span> <span class=n>product</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>_round_ids</span><span class=p>):</span>
                <span class=k>if</span> <span class=n>round_id</span> <span class=ow>is</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>_round_ids</span><span class=p>[</span><span class=mi>0</span><span class=p>]:</span>
                    <span class=k>try</span><span class=p>:</span>
                        <span class=n>zattrs_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
                            <span class=bp>self</span><span class=o>.</span><span class=n>_polyDT_root_path</span>
                            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
                            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>round_id</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
                            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;.zattrs&quot;</span><span class=p>)</span>
                        <span class=p>)</span>
                        <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>zattrs_path</span><span class=p>,</span> <span class=s2>&quot;r&quot;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
                            <span class=n>attributes</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=n>f</span><span class=p>)</span>
                    <span class=k>except</span> <span class=p>(</span><span class=ne>FileNotFoundError</span><span class=p>,</span> <span class=n>json</span><span class=o>.</span><span class=n>JSONDecodeError</span><span class=p>):</span>
                        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;polyDT tile attributes not found&quot;</span><span class=p>)</span>

                    <span class=n>keys_to_check</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&quot;rigid_xform_xyz_px&quot;</span><span class=p>]</span>

                    <span class=k>for</span> <span class=n>key</span> <span class=ow>in</span> <span class=n>keys_to_check</span><span class=p>:</span>
                        <span class=k>if</span> <span class=n>key</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>attributes</span><span class=o>.</span><span class=n>keys</span><span class=p>():</span>
                            <span class=k>raise</span> <span class=ne>KeyError</span><span class=p>(</span><span class=s2>&quot;Rigid registration missing&quot;</span><span class=p>)</span>

                    <span class=n>current_local_zarr_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
                        <span class=bp>self</span><span class=o>.</span><span class=n>_polyDT_root_path</span>
                        <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
                        <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>round_id</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
                        <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;of_xform_px&quot;</span><span class=p>)</span>
                    <span class=p>)</span>

                    <span class=k>try</span><span class=p>:</span>
                        <span class=bp>self</span><span class=o>.</span><span class=n>_check_for_zarr_array</span><span class=p>(</span>
                            <span class=bp>self</span><span class=o>.</span><span class=n>_get_kvstore_key</span><span class=p>(</span><span class=n>current_local_zarr_path</span><span class=p>),</span>
                            <span class=bp>self</span><span class=o>.</span><span class=n>_zarrv2_spec</span><span class=o>.</span><span class=n>copy</span><span class=p>(),</span>
                        <span class=p>)</span>
                    <span class=k>except</span> <span class=p>(</span><span class=ne>IOError</span><span class=p>,</span> <span class=ne>OSError</span><span class=p>,</span> <span class=n>ZarrError</span><span class=p>):</span>
                        <span class=nb>print</span><span class=p>(</span><span class=n>tile_id</span><span class=p>,</span> <span class=n>round_id</span><span class=p>)</span>
                        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Optical flow registration data missing.&quot;</span><span class=p>)</span>

                <span class=n>current_local_zarr_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>_polyDT_root_path</span>
                    <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
                    <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>round_id</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
                    <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;registered_decon_data&quot;</span><span class=p>)</span>
                <span class=p>)</span>
                <span class=k>if</span> <span class=n>round_id</span> <span class=ow>is</span> <span class=bp>self</span><span class=o>.</span><span class=n>_round_ids</span><span class=p>[</span><span class=mi>0</span><span class=p>]:</span>
                    <span class=k>try</span><span class=p>:</span>
                        <span class=bp>self</span><span class=o>.</span><span class=n>_check_for_zarr_array</span><span class=p>(</span>
                            <span class=bp>self</span><span class=o>.</span><span class=n>_get_kvstore_key</span><span class=p>(</span><span class=n>current_local_zarr_path</span><span class=p>),</span>
                            <span class=bp>self</span><span class=o>.</span><span class=n>_zarrv2_spec</span><span class=o>.</span><span class=n>copy</span><span class=p>(),</span>
                        <span class=p>)</span>
                    <span class=k>except</span> <span class=p>(</span><span class=ne>IOError</span><span class=p>,</span> <span class=ne>OSError</span><span class=p>,</span> <span class=n>ZarrError</span><span class=p>):</span>
                        <span class=nb>print</span><span class=p>(</span><span class=n>tile_id</span><span class=p>,</span> <span class=n>round_id</span><span class=p>)</span>
                        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Registered polyDT data missing.&quot;</span><span class=p>)</span>

            <span class=k>for</span> <span class=n>tile_id</span><span class=p>,</span> <span class=n>bit_id</span> <span class=ow>in</span> <span class=n>product</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>):</span>
                <span class=n>current_local_zarr_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>_readouts_root_path</span>
                    <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
                    <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>bit_id</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
                    <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;registered_decon_data&quot;</span><span class=p>)</span>
                <span class=p>)</span>

                <span class=k>try</span><span class=p>:</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>_check_for_zarr_array</span><span class=p>(</span>
                        <span class=bp>self</span><span class=o>.</span><span class=n>_get_kvstore_key</span><span class=p>(</span><span class=n>current_local_zarr_path</span><span class=p>),</span>
                        <span class=bp>self</span><span class=o>.</span><span class=n>_zarrv2_spec</span><span class=o>.</span><span class=n>copy</span><span class=p>(),</span>
                    <span class=p>)</span>
                <span class=k>except</span> <span class=p>(</span><span class=ne>IOError</span><span class=p>,</span> <span class=ne>OSError</span><span class=p>,</span> <span class=n>ZarrError</span><span class=p>):</span>
                    <span class=nb>print</span><span class=p>(</span><span class=n>tile_id</span><span class=p>,</span> <span class=n>round_id</span><span class=p>)</span>
                    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Registered readout data missing.&quot;</span><span class=p>)</span>

                <span class=n>current_local_zarr_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>_readouts_root_path</span>
                    <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
                    <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>bit_id</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
                    <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;registered_ufish_data&quot;</span><span class=p>)</span>
                <span class=p>)</span>

                <span class=k>try</span><span class=p>:</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>_check_for_zarr_array</span><span class=p>(</span>
                        <span class=bp>self</span><span class=o>.</span><span class=n>_get_kvstore_key</span><span class=p>(</span><span class=n>current_local_zarr_path</span><span class=p>),</span>
                        <span class=bp>self</span><span class=o>.</span><span class=n>_zarrv2_spec</span><span class=o>.</span><span class=n>copy</span><span class=p>(),</span>
                    <span class=p>)</span>
                <span class=k>except</span> <span class=p>(</span><span class=ne>IOError</span><span class=p>,</span> <span class=ne>OSError</span><span class=p>,</span> <span class=n>ZarrError</span><span class=p>):</span>
                    <span class=nb>print</span><span class=p>(</span><span class=n>tile_id</span><span class=p>,</span> <span class=n>round_id</span><span class=p>)</span>
                    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Registered ufish prediction missing.&quot;</span><span class=p>)</span>

            <span class=k>for</span> <span class=n>tile_id</span><span class=p>,</span> <span class=n>bit_id</span> <span class=ow>in</span> <span class=n>product</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>):</span>
                <span class=n>current_ufish_path</span> <span class=o>=</span> <span class=p>(</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>_ufish_localizations_root_path</span>
                    <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
                    <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>bit_id</span> <span class=o>+</span> <span class=s2>&quot;.parquet&quot;</span><span class=p>)</span>
                <span class=p>)</span>
                <span class=k>if</span> <span class=ow>not</span> <span class=p>(</span><span class=n>current_ufish_path</span><span class=o>.</span><span class=n>exists</span><span class=p>()):</span>
                    <span class=k>raise</span> <span class=ne>FileNotFoundError</span><span class=p>(</span>
                        <span class=n>tile_id</span> <span class=o>+</span> <span class=s2>&quot; &quot;</span> <span class=o>+</span> <span class=n>bit_id</span> <span class=o>+</span> <span class=s2>&quot; ufish localization missing&quot;</span>
                    <span class=p>)</span>

        <span class=c1># check and validate global registered data</span>
        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_state</span><span class=p>[</span><span class=s2>&quot;GlobalRegistered&quot;</span><span class=p>]:</span>
            <span class=k>for</span> <span class=n>tile_id</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>:</span>
                <span class=k>try</span><span class=p>:</span>
                    <span class=n>zattrs_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
                        <span class=bp>self</span><span class=o>.</span><span class=n>_polyDT_root_path</span>
                        <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
                        <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_round_ids</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
                        <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;.zattrs&quot;</span><span class=p>)</span>
                    <span class=p>)</span>
                    <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>zattrs_path</span><span class=p>,</span> <span class=s2>&quot;r&quot;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
                        <span class=n>attributes</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=n>f</span><span class=p>)</span>
                <span class=k>except</span> <span class=p>(</span><span class=ne>FileNotFoundError</span><span class=p>,</span> <span class=n>json</span><span class=o>.</span><span class=n>JSONDecodeError</span><span class=p>):</span>
                    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;polyDT tile attributes not found&quot;</span><span class=p>)</span>

                <span class=n>keys_to_check</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&quot;affine_zyx_um&quot;</span><span class=p>,</span> <span class=s2>&quot;origin_zyx_um&quot;</span><span class=p>,</span> <span class=s2>&quot;spacing_zyx_um&quot;</span><span class=p>]</span>

                <span class=k>for</span> <span class=n>key</span> <span class=ow>in</span> <span class=n>keys_to_check</span><span class=p>:</span>
                    <span class=k>if</span> <span class=n>key</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>attributes</span><span class=o>.</span><span class=n>keys</span><span class=p>():</span>
                        <span class=k>raise</span> <span class=ne>KeyError</span><span class=p>(</span><span class=s2>&quot;Global registration missing&quot;</span><span class=p>)</span>

        <span class=c1># check and validate fused</span>
        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_state</span><span class=p>[</span><span class=s2>&quot;Fused&quot;</span><span class=p>]:</span>
            <span class=k>try</span><span class=p>:</span>
                <span class=n>zattrs_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>_fused_root_path</span>
                    <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;fused.zarr&quot;</span><span class=p>)</span>
                    <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;fused_polyDT_iso_zyx&quot;</span><span class=p>)</span>
                    <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;.zattrs&quot;</span><span class=p>)</span>
                <span class=p>)</span>
                <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>zattrs_path</span><span class=p>,</span> <span class=s2>&quot;r&quot;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
                    <span class=n>attributes</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=n>f</span><span class=p>)</span>
            <span class=k>except</span> <span class=p>(</span><span class=ne>FileNotFoundError</span><span class=p>,</span> <span class=n>json</span><span class=o>.</span><span class=n>JSONDecodeError</span><span class=p>):</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Fused image attributes not found&quot;</span><span class=p>)</span>

            <span class=n>keys_to_check</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&quot;affine_zyx_um&quot;</span><span class=p>,</span> <span class=s2>&quot;origin_zyx_um&quot;</span><span class=p>,</span> <span class=s2>&quot;spacing_zyx_um&quot;</span><span class=p>]</span>

            <span class=k>for</span> <span class=n>key</span> <span class=ow>in</span> <span class=n>keys_to_check</span><span class=p>:</span>
                <span class=k>if</span> <span class=n>key</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>attributes</span><span class=o>.</span><span class=n>keys</span><span class=p>():</span>
                    <span class=k>raise</span> <span class=ne>KeyError</span><span class=p>(</span><span class=s2>&quot;Fused image metadata missing&quot;</span><span class=p>)</span>

            <span class=n>current_local_zarr_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_fused_root_path</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;fused.zarr&quot;</span><span class=p>)</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;fused_polyDT_iso_zyx&quot;</span><span class=p>)</span>
            <span class=p>)</span>

            <span class=k>try</span><span class=p>:</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_check_for_zarr_array</span><span class=p>(</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>_get_kvstore_key</span><span class=p>(</span><span class=n>current_local_zarr_path</span><span class=p>),</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>_zarrv2_spec</span><span class=o>.</span><span class=n>copy</span><span class=p>(),</span>
                <span class=p>)</span>
            <span class=k>except</span> <span class=p>(</span><span class=ne>IOError</span><span class=p>,</span> <span class=ne>OSError</span><span class=p>,</span> <span class=n>ZarrError</span><span class=p>):</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Fused data missing.&quot;</span><span class=p>)</span>

        <span class=c1># check and validate cellpose segmentation</span>
        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_state</span><span class=p>[</span><span class=s2>&quot;SegmentedCells&quot;</span><span class=p>]:</span>
            <span class=n>current_local_zarr_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_segmentation_root_path</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;cellpose&quot;</span><span class=p>)</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;cellpose.zarr&quot;</span><span class=p>)</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;masks_polyDT_iso_zyx&quot;</span><span class=p>)</span>
            <span class=p>)</span>

            <span class=k>try</span><span class=p>:</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_check_for_zarr_array</span><span class=p>(</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>_get_kvstore_key</span><span class=p>(</span><span class=n>current_local_zarr_path</span><span class=p>),</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>_zarrv2_spec</span><span class=o>.</span><span class=n>copy</span><span class=p>(),</span>
                <span class=p>)</span>
            <span class=k>except</span> <span class=p>(</span><span class=ne>IOError</span><span class=p>,</span> <span class=ne>OSError</span><span class=p>,</span> <span class=n>ZarrError</span><span class=p>):</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Cellpose data missing.&quot;</span><span class=p>)</span>

            <span class=n>cell_outlines_path</span> <span class=o>=</span> <span class=p>(</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_segmentation_root_path</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;cellpose&quot;</span><span class=p>)</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;imagej_rois&quot;</span><span class=p>)</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;global_coords_rois.zip&quot;</span><span class=p>)</span>
            <span class=p>)</span>
            <span class=k>if</span> <span class=ow>not</span> <span class=p>(</span><span class=n>cell_outlines_path</span><span class=o>.</span><span class=n>exists</span><span class=p>()):</span>
                <span class=k>raise</span> <span class=ne>FileNotFoundError</span><span class=p>(</span><span class=s2>&quot;Cellpose cell outlines missing.&quot;</span><span class=p>)</span>

        <span class=c1># check and validate decoded spots</span>
        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_state</span><span class=p>[</span><span class=s2>&quot;DecodedSpots&quot;</span><span class=p>]:</span>
            <span class=k>for</span> <span class=n>tile_id</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>:</span>
                <span class=n>decoded_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_decoded_root_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span>
                    <span class=n>tile_id</span> <span class=o>+</span> <span class=s2>&quot;_decoded_features.parquet&quot;</span>
                <span class=p>)</span>

                <span class=k>if</span> <span class=ow>not</span> <span class=p>(</span><span class=n>decoded_path</span><span class=o>.</span><span class=n>exists</span><span class=p>()):</span>
                    <span class=k>raise</span> <span class=ne>FileNotFoundError</span><span class=p>(</span><span class=n>tile_id</span> <span class=o>+</span> <span class=s2>&quot; decoded spots missing.&quot;</span><span class=p>)</span>

        <span class=c1># check and validate filtered decoded spots</span>
        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_state</span><span class=p>[</span><span class=s2>&quot;FilteredSpots&quot;</span><span class=p>]:</span>
            <span class=n>filtered_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_decoded_root_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span>
                <span class=s2>&quot;all_tiles_filtered_decoded_features.parquet&quot;</span>
            <span class=p>)</span>

            <span class=k>if</span> <span class=ow>not</span> <span class=p>(</span><span class=n>filtered_path</span><span class=o>.</span><span class=n>exists</span><span class=p>()):</span>
                <span class=k>raise</span> <span class=ne>FileNotFoundError</span><span class=p>(</span><span class=s2>&quot;filtered decoded spots missing.&quot;</span><span class=p>)</span>

        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_state</span><span class=p>[</span><span class=s2>&quot;RefinedSpots&quot;</span><span class=p>]:</span>
            <span class=n>baysor_spots_path</span> <span class=o>=</span> <span class=p>(</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_segmentation_root_path</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;baysor&quot;</span><span class=p>)</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;segmentation.csv&quot;</span><span class=p>)</span>
            <span class=p>)</span>

            <span class=k>if</span> <span class=ow>not</span> <span class=p>(</span><span class=n>baysor_spots_path</span><span class=o>.</span><span class=n>exists</span><span class=p>()):</span>
                <span class=k>raise</span> <span class=ne>FileNotFoundError</span><span class=p>(</span><span class=s2>&quot;Baysor filtered decoded spots missing.&quot;</span><span class=p>)</span>

        <span class=c1># check and validate mtx</span>
        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_state</span><span class=p>[</span><span class=s2>&quot;mtxOutput&quot;</span><span class=p>]:</span>
            <span class=n>mtx_barcodes_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_mtx_output_root_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;barcodes.tsv.gz&quot;</span><span class=p>)</span>
            <span class=n>mtx_features_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_mtx_output_root_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;features.tsv.gz&quot;</span><span class=p>)</span>
            <span class=n>mtx_matrix_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_mtx_output_root_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;matrix.tsv.gz&quot;</span><span class=p>)</span>

            <span class=k>if</span> <span class=p>(</span>
                <span class=ow>not</span> <span class=p>(</span><span class=n>mtx_barcodes_path</span><span class=o>.</span><span class=n>exists</span><span class=p>())</span>
                <span class=ow>or</span> <span class=ow>not</span> <span class=p>(</span><span class=n>mtx_features_path</span><span class=o>.</span><span class=n>exists</span><span class=p>())</span>
                <span class=ow>or</span> <span class=ow>not</span> <span class=p>(</span><span class=n>mtx_matrix_path</span><span class=o>.</span><span class=n>exists</span><span class=p>())</span>
            <span class=p>):</span>
                <span class=k>raise</span> <span class=ne>FileNotFoundError</span><span class=p>(</span><span class=s2>&quot;mtx output missing.&quot;</span><span class=p>)</span>

        <span class=k>try</span><span class=p>:</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_baysor_path</span> <span class=o>=</span> <span class=n>Path</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_datastore_state</span><span class=p>[</span><span class=s2>&quot;BaysorPath&quot;</span><span class=p>]))</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_baysor_options</span> <span class=o>=</span> <span class=n>Path</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_datastore_state</span><span class=p>[</span><span class=s2>&quot;BaysorOptions&quot;</span><span class=p>]))</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_julia_threads</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_datastore_state</span><span class=p>[</span><span class=s2>&quot;JuliaThreads&quot;</span><span class=p>])</span>
        <span class=k>except</span> <span class=ne>KeyError</span><span class=p>:</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_baysor_path</span> <span class=o>=</span> <span class=sa>r</span><span class=s2>&quot;&quot;</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_baysor_options</span> <span class=o>=</span> <span class=sa>r</span><span class=s2>&quot;&quot;</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_julia_threads</span> <span class=o>=</span> <span class=mi>1</span>

    <span class=k>def</span> <span class=nf>load_codebook_parsed</span><span class=p>(</span>
        <span class=bp>self</span><span class=p>,</span>
    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>tuple</span><span class=p>[</span><span class=n>Collection</span><span class=p>[</span><span class=nb>str</span><span class=p>],</span> <span class=n>ArrayLike</span><span class=p>]]:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Load and split codebook into gene_ids and codebook matrix.</span>

<span class=sd>        Returns</span>
<span class=sd>        -------</span>
<span class=sd>        gene_ids : Collection[str]</span>
<span class=sd>            Gene IDs.</span>
<span class=sd>        codebook_matrix : ArrayLike</span>
<span class=sd>            Codebook matrix.</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=k>try</span><span class=p>:</span>
            <span class=n>data</span> <span class=o>=</span> <span class=nb>getattr</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=s2>&quot;_codebook&quot;</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>

            <span class=k>if</span> <span class=n>data</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=n>num_columns</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span> <span class=k>if</span> <span class=n>data</span> <span class=k>else</span> <span class=mi>0</span>
            <span class=n>columns</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&quot;gene_id&quot;</span><span class=p>]</span> <span class=o>+</span> <span class=p>[</span><span class=sa>f</span><span class=s2>&quot;bit</span><span class=si>{</span><span class=n>i</span><span class=si>:</span><span class=s2>02d</span><span class=si>}</span><span class=s2>&quot;</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=n>num_columns</span><span class=p>)]</span>
            <span class=n>codebook_df</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=n>columns</span><span class=o>=</span><span class=n>columns</span><span class=p>)</span>

            <span class=n>gene_ids</span> <span class=o>=</span> <span class=n>codebook_df</span><span class=o>.</span><span class=n>iloc</span><span class=p>[:,</span> <span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>tolist</span><span class=p>()</span>
            <span class=n>codebook_matrix</span> <span class=o>=</span> <span class=n>codebook_df</span><span class=o>.</span><span class=n>iloc</span><span class=p>[:,</span> <span class=mi>1</span><span class=p>:]</span><span class=o>.</span><span class=n>to_numpy</span><span class=p>()</span><span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=nb>int</span><span class=p>)</span>
            <span class=k>del</span> <span class=n>data</span><span class=p>,</span> <span class=n>codebook_df</span>
            <span class=k>return</span> <span class=n>gene_ids</span><span class=p>,</span> <span class=n>codebook_matrix</span>
        <span class=k>except</span> <span class=p>(</span><span class=ne>KeyError</span><span class=p>,</span> <span class=ne>ValueError</span><span class=p>,</span> <span class=ne>TypeError</span><span class=p>):</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Error parsing codebook.&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>

    <span class=k>def</span> <span class=nf>initialize_tile</span><span class=p>(</span>
        <span class=bp>self</span><span class=p>,</span>
        <span class=n>tile</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>],</span>
    <span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Initialize directory structure for a tile.</span>

<span class=sd>        Parameters</span>
<span class=sd>        ----------</span>
<span class=sd>        tile : Union[int, str]</span>
<span class=sd>            Tile index or tile id.</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=k>if</span> <span class=nb>getattr</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=s2>&quot;_experiment_order&quot;</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Assign experimental order before creating tiles.&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>

        <span class=k>if</span> <span class=nb>getattr</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=s2>&quot;_num_tiles&quot;</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Assign number of tiles before creating tiles.&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>

        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
            <span class=k>if</span> <span class=n>tile</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>tile</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set tile index &gt;=0 and &lt;&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>))</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>tile_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>[</span><span class=n>tile</span><span class=p>]</span>
        <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
            <span class=k>if</span> <span class=n>tile</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;set valid tile id.&quot;</span><span class=p>)</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>tile_id</span> <span class=o>=</span> <span class=n>tile</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;tile&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>

        <span class=k>try</span><span class=p>:</span>
            <span class=n>polyDT_tile_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_polyDT_root_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
            <span class=n>polyDT_tile_path</span><span class=o>.</span><span class=n>mkdir</span><span class=p>()</span>
            <span class=k>for</span> <span class=n>round_idx</span><span class=p>,</span> <span class=n>round_id</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_round_ids</span><span class=p>):</span>
                <span class=n>polyDT_round_path</span> <span class=o>=</span> <span class=n>polyDT_tile_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>round_id</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
                <span class=n>polyDT_round_path</span><span class=o>.</span><span class=n>mkdir</span><span class=p>()</span>
                <span class=n>polydt_round_attrs_path</span> <span class=o>=</span> <span class=n>polyDT_round_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;.zattrs&quot;</span><span class=p>)</span>
                <span class=n>round_attrs</span> <span class=o>=</span> <span class=p>{</span>
                    <span class=s2>&quot;bit_linker&quot;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>_experiment_order</span><span class=o>.</span><span class=n>to_numpy</span><span class=p>()[</span><span class=n>round_idx</span><span class=p>,</span> <span class=mi>1</span><span class=p>:]</span>
                    <span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=nb>int</span><span class=p>)</span>
                    <span class=o>.</span><span class=n>tolist</span><span class=p>(),</span>
                <span class=p>}</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_save_to_json</span><span class=p>(</span><span class=n>round_attrs</span><span class=p>,</span> <span class=n>polydt_round_attrs_path</span><span class=p>)</span>
        <span class=k>except</span> <span class=ne>FileExistsError</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Error creating polyDT tile. Does it exist already?&quot;</span><span class=p>)</span>

        <span class=k>try</span><span class=p>:</span>
            <span class=n>readout_tile_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_readouts_root_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
            <span class=n>readout_tile_path</span><span class=o>.</span><span class=n>mkdir</span><span class=p>()</span>
            <span class=k>for</span> <span class=n>bit_idx</span><span class=p>,</span> <span class=n>bit_id</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>):</span>
                <span class=n>readout_bit_path</span> <span class=o>=</span> <span class=n>readout_tile_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>bit_id</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
                <span class=n>readout_bit_path</span><span class=o>.</span><span class=n>mkdir</span><span class=p>()</span>
                <span class=n>readout_bit_attrs_path</span> <span class=o>=</span> <span class=n>readout_bit_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;.zattrs&quot;</span><span class=p>)</span>
                <span class=n>fiducial_channel</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_channels_in_data</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
                <span class=n>readout_one_channel</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_channels_in_data</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span>

                <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_channels_in_data</span><span class=p>)</span> <span class=o>==</span> <span class=mi>3</span><span class=p>:</span>
                    <span class=n>readout_two_channel</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_channels_in_data</span><span class=p>[</span><span class=mi>2</span><span class=p>])</span>
                    <span class=n>condition_one</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_experiment_order</span><span class=p>[</span><span class=n>readout_one_channel</span><span class=p>]</span> <span class=o>==</span> <span class=p>(</span>
                        <span class=n>bit_idx</span> <span class=o>+</span> <span class=mi>1</span>
                    <span class=p>)</span>
                    <span class=n>condition_two</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_experiment_order</span><span class=p>[</span><span class=n>readout_two_channel</span><span class=p>]</span> <span class=o>==</span> <span class=p>(</span>
                        <span class=n>bit_idx</span> <span class=o>+</span> <span class=mi>1</span>
                    <span class=p>)</span>
                    <span class=n>combined_condition</span> <span class=o>=</span> <span class=n>condition_one</span> <span class=o>|</span> <span class=n>condition_two</span>

                <span class=k>else</span><span class=p>:</span>
                    <span class=n>combined_condition</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_experiment_order</span><span class=p>[</span>
                        <span class=n>readout_one_channel</span>
                    <span class=p>]</span> <span class=o>==</span> <span class=p>(</span><span class=n>bit_idx</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span>
                <span class=n>matching_rows</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_experiment_order</span><span class=o>.</span><span class=n>loc</span><span class=p>[</span><span class=n>combined_condition</span><span class=p>]</span>

                <span class=n>bit_attrs</span> <span class=o>=</span> <span class=p>{</span>
                    <span class=s2>&quot;round_linker&quot;</span><span class=p>:</span> <span class=nb>int</span><span class=p>(</span><span class=n>matching_rows</span><span class=p>[</span><span class=n>fiducial_channel</span><span class=p>]</span><span class=o>.</span><span class=n>values</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
                <span class=p>}</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_save_to_json</span><span class=p>(</span><span class=n>bit_attrs</span><span class=p>,</span> <span class=n>readout_bit_attrs_path</span><span class=p>)</span>
        <span class=k>except</span> <span class=ne>FileExistsError</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Error creating readout tile. Does it exist already?&quot;</span><span class=p>)</span>

    <span class=k>def</span> <span class=nf>load_local_bit_linker</span><span class=p>(</span>
        <span class=bp>self</span><span class=p>,</span>
        <span class=n>tile</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>],</span>
        <span class=nb>round</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>],</span>
    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=n>Sequence</span><span class=p>[</span><span class=nb>int</span><span class=p>]]:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Load readout bits linked to fidicual round for one tile.</span>

<span class=sd>        Parameters</span>
<span class=sd>        ----------</span>
<span class=sd>        tile : Union[int, str]</span>
<span class=sd>            Tile index or tile id.</span>
<span class=sd>        round : Union[int, str]</span>
<span class=sd>            Round index or round id.</span>

<span class=sd>        Returns</span>
<span class=sd>        -------</span>
<span class=sd>        bit_linker : Optional[Sequence[int]]</span>
<span class=sd>            Readout bits linked to fidicual round for one tile.</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
            <span class=k>if</span> <span class=n>tile</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>tile</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set tile index &gt;=0 and &lt;&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>))</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>tile_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>[</span><span class=n>tile</span><span class=p>]</span>
        <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
            <span class=k>if</span> <span class=n>tile</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;set valid tiled id.&quot;</span><span class=p>)</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>tile_id</span> <span class=o>=</span> <span class=n>tile</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;tile&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>

        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=nb>round</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
            <span class=k>if</span> <span class=nb>round</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set round index &gt;=0 and &lt;&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_num_rounds</span><span class=p>))</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>round_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_round_ids</span><span class=p>[</span><span class=nb>round</span><span class=p>]</span>
        <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=nb>round</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
            <span class=k>if</span> <span class=nb>round</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_round_ids</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set valid round id.&quot;</span><span class=p>)</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>round_id</span> <span class=o>=</span> <span class=nb>round</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;round&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>

        <span class=k>try</span><span class=p>:</span>
            <span class=n>zattrs_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_polyDT_root_path</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>round_id</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;.zattrs&quot;</span><span class=p>)</span>
            <span class=p>)</span>
            <span class=n>attributes</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_json</span><span class=p>(</span><span class=n>zattrs_path</span><span class=p>)</span>
            <span class=k>return</span> <span class=n>attributes</span><span class=p>[</span><span class=s2>&quot;bits&quot;</span><span class=p>][</span><span class=mi>1</span><span class=p>:]</span>
        <span class=k>except</span> <span class=p>(</span><span class=ne>FileNotFoundError</span><span class=p>,</span> <span class=n>json</span><span class=o>.</span><span class=n>JSONDecodeError</span><span class=p>):</span>
            <span class=nb>print</span><span class=p>(</span><span class=n>tile_id</span><span class=p>,</span> <span class=n>round_id</span><span class=p>)</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Bit linker attribute not found.&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>

    <span class=k>def</span> <span class=nf>save_local_bit_linker</span><span class=p>(</span>
        <span class=bp>self</span><span class=p>,</span>
        <span class=n>bit_linker</span><span class=p>:</span> <span class=n>Sequence</span><span class=p>[</span><span class=nb>int</span><span class=p>],</span>
        <span class=n>tile</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>],</span>
        <span class=nb>round</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>],</span>
    <span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Save readout bits linked to fidicual round for one tile.</span>

<span class=sd>        Parameters</span>
<span class=sd>        ----------</span>
<span class=sd>        bit_linker : Sequence[int]</span>
<span class=sd>            Readout bits linked to fidicual round for one tile.</span>
<span class=sd>        tile : Union[int, str]</span>
<span class=sd>            Tile index or tile id.</span>
<span class=sd>        round : Union[int, str]</span>
<span class=sd>            Round index or round id.</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
            <span class=k>if</span> <span class=n>tile</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>tile</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set tile index &gt;=0 and &lt;&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>))</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>tile_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>[</span><span class=n>tile</span><span class=p>]</span>
        <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
            <span class=k>if</span> <span class=n>tile</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;set valid tiled id.&quot;</span><span class=p>)</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>tile_id</span> <span class=o>=</span> <span class=n>tile</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;tile&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>

        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=nb>round</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
            <span class=k>if</span> <span class=nb>round</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set round index &gt;=0 and &lt;&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_num_rounds</span><span class=p>))</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>round_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_round_ids</span><span class=p>[</span><span class=nb>round</span><span class=p>]</span>
        <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=nb>round</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
            <span class=k>if</span> <span class=nb>round</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_round_ids</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set valid round id.&quot;</span><span class=p>)</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>round_id</span> <span class=o>=</span> <span class=nb>round</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;round&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>

        <span class=k>try</span><span class=p>:</span>
            <span class=n>zattrs_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_polyDT_root_path</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>round_id</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;.zattrs&quot;</span><span class=p>)</span>
            <span class=p>)</span>
            <span class=n>attributes</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_json</span><span class=p>(</span><span class=n>zattrs_path</span><span class=p>)</span>
            <span class=n>attributes</span><span class=p>[</span><span class=s2>&quot;bits&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>bit_linker</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_save_to_json</span><span class=p>(</span><span class=n>attributes</span><span class=p>,</span> <span class=n>zattrs_path</span><span class=p>)</span>
        <span class=k>except</span> <span class=p>(</span><span class=ne>FileNotFoundError</span><span class=p>,</span> <span class=n>json</span><span class=o>.</span><span class=n>JSONDecodeError</span><span class=p>):</span>
            <span class=nb>print</span><span class=p>(</span><span class=n>tile_id</span><span class=p>,</span> <span class=n>round_id</span><span class=p>)</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Error writing bit linker attribute.&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>

    <span class=k>def</span> <span class=nf>load_local_round_linker</span><span class=p>(</span>
        <span class=bp>self</span><span class=p>,</span>
        <span class=n>tile</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>],</span>
        <span class=n>bit</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>],</span>
    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=n>Sequence</span><span class=p>[</span><span class=nb>int</span><span class=p>]]:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Load fidicual round linked to readout bit for one tile.</span>

<span class=sd>        Parameters</span>
<span class=sd>        ----------</span>
<span class=sd>        tile : Union[int, str]</span>
<span class=sd>            Tile index or tile id.</span>
<span class=sd>        bit : Union[int, str]</span>
<span class=sd>            Bit index or bit id.</span>

<span class=sd>        Returns</span>
<span class=sd>        -------</span>
<span class=sd>        round_linker : Optional[Sequence[int]]</span>
<span class=sd>            Fidicual round linked to readout bit for one tile.</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
            <span class=k>if</span> <span class=n>tile</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>tile</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set tile index &gt;=0 and &lt;=&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>))</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>tile_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>[</span><span class=n>tile</span><span class=p>]</span>
        <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
            <span class=k>if</span> <span class=n>tile</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;set valid tiled id.&quot;</span><span class=p>)</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>tile_id</span> <span class=o>=</span> <span class=n>tile</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;tile&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>

        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>bit</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
            <span class=k>if</span> <span class=n>bit</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>bit</span> <span class=o>&gt;</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>):</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set bit index &gt;=0 and &lt;=&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>)))</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>bit_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>[</span><span class=n>bit</span><span class=p>]</span>
        <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>bit</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
            <span class=k>if</span> <span class=n>bit</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set valid bit id.&quot;</span><span class=p>)</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>bit_id</span> <span class=o>=</span> <span class=n>bit</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;bit&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>

        <span class=k>try</span><span class=p>:</span>
            <span class=n>zattrs_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_readouts_root_path</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>bit_id</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;.zattrs&quot;</span><span class=p>)</span>
            <span class=p>)</span>
            <span class=n>attributes</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_json</span><span class=p>(</span><span class=n>zattrs_path</span><span class=p>)</span>
            <span class=k>return</span> <span class=nb>int</span><span class=p>(</span><span class=n>attributes</span><span class=p>[</span><span class=s2>&quot;round_linker&quot;</span><span class=p>])</span>
        <span class=k>except</span> <span class=ne>FileNotFoundError</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=n>tile_id</span><span class=p>,</span> <span class=n>bit_id</span><span class=p>)</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Round linker attribute not found.&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>

    <span class=k>def</span> <span class=nf>save_local_round_linker</span><span class=p>(</span>
        <span class=bp>self</span><span class=p>,</span>
        <span class=n>round_linker</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span>
        <span class=n>tile</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>],</span>
        <span class=n>bit</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>],</span>
    <span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Save fidicual round linker attribute to readout bit for one tile.</span>

<span class=sd>        Parameters</span>
<span class=sd>        ----------</span>
<span class=sd>        round_linker : int</span>
<span class=sd>            Fidicual round linked to readout bit for one tile.</span>
<span class=sd>        tile : Union[int, str]</span>
<span class=sd>            Tile index or tile id.</span>
<span class=sd>        bit : Union[int, str]</span>
<span class=sd>            Bit index or bit id.</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
            <span class=k>if</span> <span class=n>tile</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>tile</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set tile index &gt;=0 and &lt;=&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>))</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>tile_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>[</span><span class=n>tile</span><span class=p>]</span>
        <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
            <span class=k>if</span> <span class=n>tile</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;set valid tiled id.&quot;</span><span class=p>)</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>tile_id</span> <span class=o>=</span> <span class=n>tile</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;tile&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>

        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>bit</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
            <span class=k>if</span> <span class=n>bit</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>bit</span> <span class=o>&gt;</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>):</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set bit index &gt;=0 and &lt;=&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>)))</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>bit_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>[</span><span class=n>bit</span><span class=p>]</span>
        <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>bit</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
            <span class=k>if</span> <span class=n>bit</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set valid bit id.&quot;</span><span class=p>)</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>bit_id</span> <span class=o>=</span> <span class=n>bit</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;bit&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>

        <span class=k>try</span><span class=p>:</span>
            <span class=n>zattrs_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_readouts_root_path</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>bit_id</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;.zattrs&quot;</span><span class=p>)</span>
            <span class=p>)</span>
            <span class=n>attributes</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_json</span><span class=p>(</span><span class=n>zattrs_path</span><span class=p>)</span>
            <span class=n>attributes</span><span class=p>[</span><span class=s2>&quot;round&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>round_linker</span><span class=p>)</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_save_to_json</span><span class=p>(</span><span class=n>attributes</span><span class=p>,</span> <span class=n>zattrs_path</span><span class=p>)</span>
        <span class=k>except</span> <span class=p>(</span><span class=ne>FileNotFoundError</span><span class=p>,</span> <span class=n>json</span><span class=o>.</span><span class=n>JSONDecodeError</span><span class=p>):</span>
            <span class=nb>print</span><span class=p>(</span><span class=n>tile_id</span><span class=p>,</span> <span class=n>bit_id</span><span class=p>)</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Error writing round linker attribute.&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>

    <span class=k>def</span> <span class=nf>load_local_stage_position_zyx_um</span><span class=p>(</span>
        <span class=bp>self</span><span class=p>,</span>
        <span class=n>tile</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>],</span>
        <span class=nb>round</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>],</span>
    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=n>ArrayLike</span><span class=p>]:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Load tile stage position for one tile.</span>

<span class=sd>        Parameters</span>
<span class=sd>        ----------</span>
<span class=sd>        tile : Union[int, str]</span>
<span class=sd>            Tile index or tile id.</span>
<span class=sd>        round : Union[int, str]</span>
<span class=sd>            Round index or round id.</span>

<span class=sd>        Returns</span>
<span class=sd>        -------</span>
<span class=sd>        stage_zyx_um : Optional[ArrayLike]</span>
<span class=sd>            Tile stage position for one tile.</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
            <span class=k>if</span> <span class=n>tile</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>tile</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set tile index &gt;=0 and &lt;&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>))</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>tile_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>[</span><span class=n>tile</span><span class=p>]</span>
        <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
            <span class=k>if</span> <span class=n>tile</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;set valid tiled id.&quot;</span><span class=p>)</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>tile_id</span> <span class=o>=</span> <span class=n>tile</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;tile&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>

        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=nb>round</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
            <span class=k>if</span> <span class=nb>round</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set round index &gt;=0 and &lt;&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_num_rounds</span><span class=p>))</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>round_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_round_ids</span><span class=p>[</span><span class=nb>round</span><span class=p>]</span>
        <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=nb>round</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
            <span class=k>if</span> <span class=nb>round</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_round_ids</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set valid round id.&quot;</span><span class=p>)</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>round_id</span> <span class=o>=</span> <span class=nb>round</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;round&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>

        <span class=k>try</span><span class=p>:</span>
            <span class=n>zattrs_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_polyDT_root_path</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>round_id</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;.zattrs&quot;</span><span class=p>)</span>
            <span class=p>)</span>
            <span class=n>attributes</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_json</span><span class=p>(</span><span class=n>zattrs_path</span><span class=p>)</span>
            <span class=k>return</span> <span class=n>np</span><span class=o>.</span><span class=n>asarray</span><span class=p>(</span><span class=n>attributes</span><span class=p>[</span><span class=s2>&quot;stage_zyx_um&quot;</span><span class=p>],</span> <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>float32</span><span class=p>)</span>
        <span class=k>except</span> <span class=ne>FileNotFoundError</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=n>tile_id</span><span class=p>,</span> <span class=n>round_id</span><span class=p>)</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Stage position attribute not found.&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>

    <span class=k>def</span> <span class=nf>save_local_stage_position_zyx_um</span><span class=p>(</span>
        <span class=bp>self</span><span class=p>,</span>
        <span class=n>stage_zyx_um</span><span class=p>:</span> <span class=n>ArrayLike</span><span class=p>,</span>
        <span class=n>tile</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>],</span>
        <span class=nb>round</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>],</span>
    <span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Save tile stage position for one tile.</span>

<span class=sd>        Parameters</span>
<span class=sd>        ----------</span>
<span class=sd>        stage_zyx_um : ArrayLike</span>
<span class=sd>            Tile stage position for one tile.</span>
<span class=sd>        tile : Union[int, str]</span>
<span class=sd>            Tile index or tile id.</span>
<span class=sd>        round : Union[int, str]</span>
<span class=sd>            Round index or round id.</span>

<span class=sd>        Returns</span>
<span class=sd>        -------</span>
<span class=sd>        stage_zyx_um : Optional[ArrayLike]</span>
<span class=sd>            Tile stage position for one tile.</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
            <span class=k>if</span> <span class=n>tile</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>tile</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set tile index &gt;=0 and &lt;&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>))</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>tile_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>[</span><span class=n>tile</span><span class=p>]</span>
        <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
            <span class=k>if</span> <span class=n>tile</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;set valid tiled id.&quot;</span><span class=p>)</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>tile_id</span> <span class=o>=</span> <span class=n>tile</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;tile&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>

        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=nb>round</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
            <span class=k>if</span> <span class=nb>round</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set round index &gt;=0 and &lt;&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_num_rounds</span><span class=p>))</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>round_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_round_ids</span><span class=p>[</span><span class=nb>round</span><span class=p>]</span>
        <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=nb>round</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
            <span class=k>if</span> <span class=nb>round</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_round_ids</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set valid round id.&quot;</span><span class=p>)</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>round_id</span> <span class=o>=</span> <span class=nb>round</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;round&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>

        <span class=k>try</span><span class=p>:</span>
            <span class=n>zattrs_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_polyDT_root_path</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>round_id</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;.zattrs&quot;</span><span class=p>)</span>
            <span class=p>)</span>
            <span class=n>attributes</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_json</span><span class=p>(</span><span class=n>zattrs_path</span><span class=p>)</span>
            <span class=n>attributes</span><span class=p>[</span><span class=s2>&quot;stage_zyx_um&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>stage_zyx_um</span><span class=o>.</span><span class=n>tolist</span><span class=p>()</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_save_to_json</span><span class=p>(</span><span class=n>attributes</span><span class=p>,</span> <span class=n>zattrs_path</span><span class=p>)</span>
        <span class=k>except</span> <span class=p>(</span><span class=ne>FileNotFoundError</span><span class=p>,</span> <span class=n>json</span><span class=o>.</span><span class=n>JSONDecodeError</span><span class=p>):</span>
            <span class=nb>print</span><span class=p>(</span><span class=n>tile_id</span><span class=p>,</span> <span class=n>round_id</span><span class=p>)</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Error writing stage position attribute.&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>

    <span class=k>def</span> <span class=nf>load_local_wavelengths_um</span><span class=p>(</span>
        <span class=bp>self</span><span class=p>,</span>
        <span class=n>tile</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>],</span>
        <span class=nb>round</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>]]</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span>
        <span class=n>bit</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>]]</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span>
    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>tuple</span><span class=p>[</span><span class=nb>float</span><span class=p>,</span> <span class=nb>float</span><span class=p>]]:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Load wavelengths for fidicual OR readout bit for one tile.</span>

<span class=sd>        Parameters</span>
<span class=sd>        ----------</span>
<span class=sd>        tile : Union[int, str]</span>
<span class=sd>            Tile index or tile id.</span>
<span class=sd>        round : Optional[Union[int, str]]   </span>
<span class=sd>            Round index or round id.</span>
<span class=sd>        bit : Optional[Union[int, str]]</span>
<span class=sd>            Bit index or bit id.</span>

<span class=sd>        Returns</span>
<span class=sd>        -------</span>
<span class=sd>        wavelengths_um : Optional[tuple[float, float]]</span>
<span class=sd>            Wavelengths for fidicual OR readout bit for one tile.</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=k>if</span> <span class=p>(</span><span class=nb>round</span> <span class=ow>is</span> <span class=kc>None</span> <span class=ow>and</span> <span class=n>bit</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>)</span> <span class=ow>or</span> <span class=p>(</span><span class=nb>round</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span> <span class=ow>and</span> <span class=n>bit</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>):</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Provide either &#39;round&#39; or &#39;bit&#39;, but not both&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>

        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
            <span class=k>if</span> <span class=n>tile</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>tile</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set tile index &gt;=0 and &lt;=&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>))</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>tile_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>[</span><span class=n>tile</span><span class=p>]</span>
        <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
            <span class=k>if</span> <span class=n>tile</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;set valid tiled id&quot;</span><span class=p>)</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>tile_id</span> <span class=o>=</span> <span class=n>tile</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;tile&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>

        <span class=k>if</span> <span class=n>bit</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
            <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>bit</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
                <span class=k>if</span> <span class=n>bit</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>bit</span> <span class=o>&gt;</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>):</span>
                    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set bit index &gt;=0 and &lt;=&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>)))</span>
                    <span class=k>return</span> <span class=kc>None</span>
                <span class=k>else</span><span class=p>:</span>
                    <span class=n>local_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>[</span><span class=n>bit</span><span class=p>]</span>
            <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>bit</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
                <span class=k>if</span> <span class=n>bit</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>:</span>
                    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set valid bit id&quot;</span><span class=p>)</span>
                    <span class=k>return</span> <span class=kc>None</span>
                <span class=k>else</span><span class=p>:</span>
                    <span class=n>local_id</span> <span class=o>=</span> <span class=n>bit</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;bit&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=n>zattrs_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_readouts_root_path</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>local_id</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;.zattrs&quot;</span><span class=p>)</span>
            <span class=p>)</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=nb>round</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
                <span class=k>if</span> <span class=nb>round</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>:</span>
                    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set round index &gt;=0 and &lt;&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_num_rounds</span><span class=p>))</span>
                    <span class=k>return</span> <span class=kc>None</span>
                <span class=k>else</span><span class=p>:</span>
                    <span class=n>local_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_round_ids</span><span class=p>[</span><span class=nb>round</span><span class=p>]</span>
            <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=nb>round</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
                <span class=k>if</span> <span class=nb>round</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_round_ids</span><span class=p>:</span>
                    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set valid round id&quot;</span><span class=p>)</span>
                    <span class=k>return</span> <span class=kc>None</span>
                <span class=k>else</span><span class=p>:</span>
                    <span class=n>local_id</span> <span class=o>=</span> <span class=nb>round</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;round&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=n>zattrs_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_polyDT_root_path</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>local_id</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;.zattrs&quot;</span><span class=p>)</span>
            <span class=p>)</span>

        <span class=k>try</span><span class=p>:</span>
            <span class=n>attributes</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_json</span><span class=p>(</span><span class=n>zattrs_path</span><span class=p>)</span>
            <span class=n>ex_wavelength_um</span> <span class=o>=</span> <span class=n>attributes</span><span class=p>[</span><span class=s2>&quot;excitation_um&quot;</span><span class=p>]</span>
            <span class=n>em_wavelength_um</span> <span class=o>=</span> <span class=n>attributes</span><span class=p>[</span><span class=s2>&quot;emission_um&quot;</span><span class=p>]</span>
            <span class=k>return</span> <span class=p>(</span><span class=n>ex_wavelength_um</span><span class=p>,</span> <span class=n>em_wavelength_um</span><span class=p>)</span>
        <span class=k>except</span> <span class=ne>KeyError</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Wavelength attributes not found.&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>

    <span class=k>def</span> <span class=nf>save_local_wavelengths_um</span><span class=p>(</span>
        <span class=bp>self</span><span class=p>,</span>
        <span class=n>wavelengths_um</span><span class=p>:</span> <span class=nb>tuple</span><span class=p>[</span><span class=nb>float</span><span class=p>,</span> <span class=nb>float</span><span class=p>],</span>
        <span class=n>tile</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>],</span>
        <span class=nb>round</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>]]</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span>
        <span class=n>bit</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>]]</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span>
    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>tuple</span><span class=p>[</span><span class=nb>float</span><span class=p>,</span> <span class=nb>float</span><span class=p>]]:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Save wavelengths for fidicual OR readout bit for one tile.</span>

<span class=sd>        Parameters</span>
<span class=sd>        ----------</span>
<span class=sd>        wavelengths_um : tuple[float, float]</span>
<span class=sd>            Wavelengths for fidicual OR readout bit for one tile.</span>
<span class=sd>        tile : Union[int, str]</span>
<span class=sd>            Tile index or tile id.</span>
<span class=sd>        round : Optional[Union[int, str]]</span>
<span class=sd>            Round index or round id.</span>
<span class=sd>        bit : Optional[Union[int, str]]</span>
<span class=sd>            Bit index or bit id.</span>

<span class=sd>        Returns</span>
<span class=sd>        -------</span>
<span class=sd>        wavelengths_um : Optional[tuple[float, float]]</span>
<span class=sd>            Wavelengths for fidicual OR readout bit for one tile.</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=k>if</span> <span class=p>(</span><span class=nb>round</span> <span class=ow>is</span> <span class=kc>None</span> <span class=ow>and</span> <span class=n>bit</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>)</span> <span class=ow>or</span> <span class=p>(</span><span class=nb>round</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span> <span class=ow>and</span> <span class=n>bit</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>):</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Provide either &#39;round&#39; or &#39;bit&#39;, but not both&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>

        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
            <span class=k>if</span> <span class=n>tile</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>tile</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set tile index &gt;=0 and &lt;=&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>))</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>tile_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>[</span><span class=n>tile</span><span class=p>]</span>
        <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
            <span class=k>if</span> <span class=n>tile</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;set valid tiled id&quot;</span><span class=p>)</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>tile_id</span> <span class=o>=</span> <span class=n>tile</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;tile&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>

        <span class=k>if</span> <span class=n>bit</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
            <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>bit</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
                <span class=k>if</span> <span class=n>bit</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>bit</span> <span class=o>&gt;</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>):</span>
                    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set bit index &gt;=0 and &lt;=&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>)))</span>
                    <span class=k>return</span> <span class=kc>None</span>
                <span class=k>else</span><span class=p>:</span>
                    <span class=n>local_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>[</span><span class=n>bit</span><span class=p>]</span>
            <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>bit</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
                <span class=k>if</span> <span class=n>bit</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>:</span>
                    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set valid bit id&quot;</span><span class=p>)</span>
                    <span class=k>return</span> <span class=kc>None</span>
                <span class=k>else</span><span class=p>:</span>
                    <span class=n>local_id</span> <span class=o>=</span> <span class=n>bit</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;bit&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=n>zattrs_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_readouts_root_path</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>local_id</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;.zattrs&quot;</span><span class=p>)</span>
            <span class=p>)</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=nb>round</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
                <span class=k>if</span> <span class=nb>round</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>:</span>
                    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set round index &gt;=0 and &lt;&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_num_rounds</span><span class=p>))</span>
                    <span class=k>return</span> <span class=kc>None</span>
                <span class=k>else</span><span class=p>:</span>
                    <span class=n>local_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_round_ids</span><span class=p>[</span><span class=nb>round</span><span class=p>]</span>
            <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=nb>round</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
                <span class=k>if</span> <span class=nb>round</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_round_ids</span><span class=p>:</span>
                    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set valid round id&quot;</span><span class=p>)</span>
                    <span class=k>return</span> <span class=kc>None</span>
                <span class=k>else</span><span class=p>:</span>
                    <span class=n>local_id</span> <span class=o>=</span> <span class=nb>round</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;round&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=n>zattrs_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_polyDT_root_path</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>local_id</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;.zattrs&quot;</span><span class=p>)</span>
            <span class=p>)</span>

        <span class=k>try</span><span class=p>:</span>
            <span class=n>attributes</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_json</span><span class=p>(</span><span class=n>zattrs_path</span><span class=p>)</span>
            <span class=n>attributes</span><span class=p>[</span><span class=s2>&quot;excitation_um&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=nb>float</span><span class=p>(</span><span class=n>wavelengths_um</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
            <span class=n>attributes</span><span class=p>[</span><span class=s2>&quot;emission_um&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=nb>float</span><span class=p>(</span><span class=n>wavelengths_um</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_save_to_json</span><span class=p>(</span><span class=n>attributes</span><span class=p>,</span> <span class=n>zattrs_path</span><span class=p>)</span>
        <span class=k>except</span> <span class=p>(</span><span class=ne>FileNotFoundError</span><span class=p>,</span> <span class=n>json</span><span class=o>.</span><span class=n>JSONDecodeError</span><span class=p>):</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Error writing wavelength attributes.&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>

    <span class=k>def</span> <span class=nf>load_local_corrected_image</span><span class=p>(</span>
        <span class=bp>self</span><span class=p>,</span>
        <span class=n>tile</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>],</span>
        <span class=nb>round</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>]]</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span>
        <span class=n>bit</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>]]</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span>
        <span class=n>return_future</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>bool</span><span class=p>]</span> <span class=o>=</span> <span class=kc>True</span><span class=p>,</span>
    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=n>ArrayLike</span><span class=p>]:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Load gain and offset corrected image for fiducial OR readout bit for one tile.</span>

<span class=sd>        Parameters</span>
<span class=sd>        ----------</span>
<span class=sd>        tile : Union[int, str]</span>
<span class=sd>            Tile index or tile id.</span>
<span class=sd>        round : Optional[Union[int, str]]</span>
<span class=sd>            Round index or round id.</span>
<span class=sd>        bit : Optional[Union[int, str]]</span>
<span class=sd>            Bit index or bit id.</span>
<span class=sd>        return_future : Optional[bool]</span>
<span class=sd>            Return future array.</span>

<span class=sd>        Returns</span>
<span class=sd>        -------</span>
<span class=sd>        corrected_image : Optional[ArrayLike]</span>
<span class=sd>            Gain and offset corrected image for fiducial OR readout bit for one tile.</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=k>if</span> <span class=p>(</span><span class=nb>round</span> <span class=ow>is</span> <span class=kc>None</span> <span class=ow>and</span> <span class=n>bit</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>)</span> <span class=ow>or</span> <span class=p>(</span><span class=nb>round</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span> <span class=ow>and</span> <span class=n>bit</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>):</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Provide either &#39;round&#39; or &#39;bit&#39;, but not both&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>

        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
            <span class=k>if</span> <span class=n>tile</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>tile</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set tile index &gt;=0 and &lt;=&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>))</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>tile_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>[</span><span class=n>tile</span><span class=p>]</span>
        <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
            <span class=k>if</span> <span class=n>tile</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;set valid tiled id&quot;</span><span class=p>)</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>tile_id</span> <span class=o>=</span> <span class=n>tile</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;tile&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>

        <span class=k>if</span> <span class=n>bit</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
            <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>bit</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
                <span class=k>if</span> <span class=n>bit</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>bit</span> <span class=o>&gt;</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>):</span>
                    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set bit index &gt;=0 and &lt;=&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>)))</span>
                    <span class=k>return</span> <span class=kc>None</span>
                <span class=k>else</span><span class=p>:</span>
                    <span class=n>local_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>[</span><span class=n>bit</span><span class=p>]</span>
            <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>bit</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
                <span class=k>if</span> <span class=n>bit</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>:</span>
                    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set valid bit id&quot;</span><span class=p>)</span>
                    <span class=k>return</span> <span class=kc>None</span>
                <span class=k>else</span><span class=p>:</span>
                    <span class=n>local_id</span> <span class=o>=</span> <span class=n>bit</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;bit&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=n>current_local_zarr_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_readouts_root_path</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>local_id</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;corrected_data&quot;</span><span class=p>)</span>
            <span class=p>)</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=nb>round</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
                <span class=k>if</span> <span class=nb>round</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>:</span>
                    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set round index &gt;=0 and &lt;&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_num_rounds</span><span class=p>))</span>
                    <span class=k>return</span> <span class=kc>None</span>
                <span class=k>else</span><span class=p>:</span>
                    <span class=n>local_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_round_ids</span><span class=p>[</span><span class=nb>round</span><span class=p>]</span>
            <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=nb>round</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
                <span class=k>if</span> <span class=nb>round</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_round_ids</span><span class=p>:</span>
                    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set valid round id&quot;</span><span class=p>)</span>
                    <span class=k>return</span> <span class=kc>None</span>
                <span class=k>else</span><span class=p>:</span>
                    <span class=n>local_id</span> <span class=o>=</span> <span class=nb>round</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;round&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=n>current_local_zarr_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_polyDT_root_path</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>local_id</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;corrected_data&quot;</span><span class=p>)</span>
            <span class=p>)</span>

        <span class=k>if</span> <span class=ow>not</span> <span class=n>Path</span><span class=p>(</span><span class=n>current_local_zarr_path</span><span class=p>)</span><span class=o>.</span><span class=n>exists</span><span class=p>():</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Corrected image not found.&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>

        <span class=k>try</span><span class=p>:</span>
            <span class=n>spec</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_zarrv2_spec</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>
            <span class=n>spec</span><span class=p>[</span><span class=s2>&quot;metadata&quot;</span><span class=p>][</span><span class=s2>&quot;dtype&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&quot;&lt;u2&quot;</span>
            <span class=n>corrected_image</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_zarr_array</span><span class=p>(</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_get_kvstore_key</span><span class=p>(</span><span class=n>current_local_zarr_path</span><span class=p>),</span>
                <span class=n>spec</span><span class=p>,</span>
                <span class=n>return_future</span><span class=p>,</span>
            <span class=p>)</span>
            <span class=k>return</span> <span class=n>corrected_image</span>
        <span class=k>except</span> <span class=p>(</span><span class=ne>IOError</span><span class=p>,</span> <span class=ne>OSError</span><span class=p>,</span> <span class=n>ZarrError</span><span class=p>):</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Error loading corrected image.&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>

    <span class=k>def</span> <span class=nf>save_local_corrected_image</span><span class=p>(</span>
        <span class=bp>self</span><span class=p>,</span>
        <span class=n>image</span><span class=p>:</span> <span class=n>ArrayLike</span><span class=p>,</span>
        <span class=n>tile</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>],</span>
        <span class=n>gain_correction</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>True</span><span class=p>,</span>
        <span class=n>hotpixel_correction</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>True</span><span class=p>,</span>
        <span class=n>shading_correction</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>False</span><span class=p>,</span>
        <span class=n>psf_idx</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span>
        <span class=nb>round</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>]]</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span>
        <span class=n>bit</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>]]</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span>
        <span class=n>return_future</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>bool</span><span class=p>]</span> <span class=o>=</span> <span class=kc>False</span><span class=p>,</span>
    <span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Save gain and offset corrected image.</span>

<span class=sd>        Parameters</span>
<span class=sd>        ----------</span>
<span class=sd>        image : ArrayLike</span>
<span class=sd>            Local corrected image.</span>
<span class=sd>        tile : Union[int, str]</span>
<span class=sd>            Tile index or tile id.</span>
<span class=sd>        gain_correction : bool</span>
<span class=sd>            Gain correction applied (True) or not (False).</span>
<span class=sd>        hotpixel_correction : bool</span>
<span class=sd>            Hotpixel correction applied (True) or not (False).</span>
<span class=sd>        shading_correction : bool</span>
<span class=sd>            Shading correction applied (True) or not (False).</span>
<span class=sd>        psf_idx : int</span>
<span class=sd>            PSF index.</span>
<span class=sd>        round : Optional[Union[int, str]]</span>
<span class=sd>            Round index or round id.</span>
<span class=sd>        bit : Optional[Union[int, str]]</span>
<span class=sd>            Bit index or bit id.</span>
<span class=sd>        return_future : Optional[bool]</span>
<span class=sd>            Return future array.</span>
<span class=sd>   &quot;&quot;&quot;</span>

        <span class=k>if</span> <span class=p>(</span><span class=nb>round</span> <span class=ow>is</span> <span class=kc>None</span> <span class=ow>and</span> <span class=n>bit</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>)</span> <span class=ow>or</span> <span class=p>(</span><span class=nb>round</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span> <span class=ow>and</span> <span class=n>bit</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>):</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Provide either &#39;round&#39; or &#39;bit&#39;, but not both&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>

        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
            <span class=k>if</span> <span class=n>tile</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>tile</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set tile index &gt;=0 and &lt;=&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>))</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>tile_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>[</span><span class=n>tile</span><span class=p>]</span>
        <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
            <span class=k>if</span> <span class=n>tile</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;set valid tiled id&quot;</span><span class=p>)</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>tile_id</span> <span class=o>=</span> <span class=n>tile</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;tile&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>

        <span class=k>if</span> <span class=n>bit</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
            <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>bit</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
                <span class=k>if</span> <span class=n>bit</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>bit</span> <span class=o>&gt;</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>):</span>
                    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set bit index &gt;=0 and &lt;=&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>)))</span>
                    <span class=k>return</span> <span class=kc>None</span>
                <span class=k>else</span><span class=p>:</span>
                    <span class=n>local_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>[</span><span class=n>bit</span><span class=p>]</span>
            <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>bit</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
                <span class=k>if</span> <span class=n>bit</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>:</span>
                    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set valid bit id&quot;</span><span class=p>)</span>
                    <span class=k>return</span> <span class=kc>None</span>
                <span class=k>else</span><span class=p>:</span>
                    <span class=n>local_id</span> <span class=o>=</span> <span class=n>bit</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;bit&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=n>current_local_zarr_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_readouts_root_path</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>local_id</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;corrected_data&quot;</span><span class=p>)</span>
            <span class=p>)</span>
            <span class=n>current_local_zattrs_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_readouts_root_path</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>local_id</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;.zattrs&quot;</span><span class=p>)</span>
            <span class=p>)</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=nb>round</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
                <span class=k>if</span> <span class=nb>round</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>:</span>
                    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set round index &gt;=0 and &lt;&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_num_rounds</span><span class=p>))</span>
                    <span class=k>return</span> <span class=kc>None</span>
                <span class=k>else</span><span class=p>:</span>
                    <span class=n>local_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_round_ids</span><span class=p>[</span><span class=nb>round</span><span class=p>]</span>
            <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=nb>round</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
                <span class=k>if</span> <span class=nb>round</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_round_ids</span><span class=p>:</span>
                    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set valid round id&quot;</span><span class=p>)</span>
                    <span class=k>return</span> <span class=kc>None</span>
                <span class=k>else</span><span class=p>:</span>
                    <span class=n>local_id</span> <span class=o>=</span> <span class=nb>round</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;round&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=n>current_local_zarr_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_polyDT_root_path</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>local_id</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;corrected_data&quot;</span><span class=p>)</span>
            <span class=p>)</span>
            <span class=n>current_local_zattrs_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_polyDT_root_path</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>local_id</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;.zattrs&quot;</span><span class=p>)</span>
            <span class=p>)</span>

        <span class=k>try</span><span class=p>:</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_save_to_zarr_array</span><span class=p>(</span>
                <span class=n>image</span><span class=p>,</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_get_kvstore_key</span><span class=p>(</span><span class=n>current_local_zarr_path</span><span class=p>),</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_zarrv2_spec</span><span class=p>,</span>
                <span class=n>return_future</span><span class=p>,</span>
            <span class=p>)</span>
            <span class=n>attributes</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_json</span><span class=p>(</span><span class=n>current_local_zattrs_path</span><span class=p>)</span>
            <span class=n>attributes</span><span class=p>[</span><span class=s2>&quot;gain_correction&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=n>gain_correction</span><span class=p>,)</span>
            <span class=n>attributes</span><span class=p>[</span><span class=s2>&quot;hotpixel_correction&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=n>hotpixel_correction</span><span class=p>,)</span>
            <span class=n>attributes</span><span class=p>[</span><span class=s2>&quot;shading_correction&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=n>shading_correction</span><span class=p>,)</span>
            <span class=n>attributes</span><span class=p>[</span><span class=s2>&quot;psf_idx&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>psf_idx</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_save_to_json</span><span class=p>(</span><span class=n>attributes</span><span class=p>,</span> <span class=n>current_local_zattrs_path</span><span class=p>)</span>
        <span class=k>except</span> <span class=p>(</span><span class=ne>IOError</span><span class=p>,</span> <span class=ne>OSError</span><span class=p>,</span> <span class=ne>TimeoutError</span><span class=p>)</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=n>e</span><span class=p>)</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Error saving corrected image.&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>

    <span class=k>def</span> <span class=nf>load_local_rigid_xform_xyz_px</span><span class=p>(</span>
        <span class=bp>self</span><span class=p>,</span>
        <span class=n>tile</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>],</span>
        <span class=nb>round</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>],</span>
    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=n>ArrayLike</span><span class=p>]:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Load calculated rigid registration transform for one round and tile.</span>

<span class=sd>        Parameters</span>
<span class=sd>        ----------</span>
<span class=sd>        tile : Union[int, str]</span>
<span class=sd>            Tile index or tile id.</span>
<span class=sd>        round : Union[int, str]</span>
<span class=sd>            Round index or round id.</span>

<span class=sd>        Returns</span>
<span class=sd>        -------</span>
<span class=sd>        rigid_xform_xyz_px : Optional[ArrayLike]</span>
<span class=sd>            Local rigid registration transform for one round and tile.</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
            <span class=k>if</span> <span class=n>tile</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>tile</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set tile index &gt;=0 and &lt;=&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>))</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>tile_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>[</span><span class=n>tile</span><span class=p>]</span>
        <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
            <span class=k>if</span> <span class=n>tile</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;set valid tiled id&quot;</span><span class=p>)</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>tile_id</span> <span class=o>=</span> <span class=n>tile</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;tile&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>

        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=nb>round</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
            <span class=k>if</span> <span class=nb>round</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set round index &gt;=0 and &lt;&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_num_rounds</span><span class=p>))</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>round_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_round_ids</span><span class=p>[</span><span class=nb>round</span><span class=p>]</span>
        <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=nb>round</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
            <span class=k>if</span> <span class=nb>round</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_round_ids</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set valid round id&quot;</span><span class=p>)</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>round_id</span> <span class=o>=</span> <span class=nb>round</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;round&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=k>try</span><span class=p>:</span>
            <span class=n>zattrs_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_polyDT_root_path</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>round_id</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;.zattrs&quot;</span><span class=p>)</span>
            <span class=p>)</span>
            <span class=n>attributes</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_json</span><span class=p>(</span><span class=n>zattrs_path</span><span class=p>)</span>
            <span class=n>rigid_xform_xyz_px</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>asarray</span><span class=p>(</span>
                <span class=n>attributes</span><span class=p>[</span><span class=s2>&quot;rigid_xform_xyz_px&quot;</span><span class=p>],</span> <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>float32</span>
            <span class=p>)</span>
            <span class=k>return</span> <span class=n>rigid_xform_xyz_px</span>
        <span class=k>except</span> <span class=p>(</span><span class=ne>FileNotFoundError</span><span class=p>,</span> <span class=n>json</span><span class=o>.</span><span class=n>JSONDecodeError</span><span class=p>):</span>
            <span class=nb>print</span><span class=p>(</span><span class=n>tile_id</span><span class=p>,</span> <span class=n>round_id</span><span class=p>)</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Rigid transform mapping back to first round not found.&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>

    <span class=k>def</span> <span class=nf>save_local_rigid_xform_xyz_px</span><span class=p>(</span>
        <span class=bp>self</span><span class=p>,</span>
        <span class=n>rigid_xform_xyz_px</span><span class=p>:</span> <span class=n>ArrayLike</span><span class=p>,</span>
        <span class=n>tile</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>],</span>
        <span class=nb>round</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>],</span>
    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=n>ArrayLike</span><span class=p>]:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Save calculated rigid registration transform for one round and tile.</span>

<span class=sd>        Parameters</span>
<span class=sd>        ----------</span>
<span class=sd>        rigid_xform_xyz_px : ArrayLike</span>
<span class=sd>            Local rigid registration transform for one round and tile.</span>
<span class=sd>        tile : Union[int, str]</span>
<span class=sd>            Tile index or tile id.</span>
<span class=sd>        round : Union[int, str]</span>
<span class=sd>            Round index or round id.</span>

<span class=sd>        Returns</span>
<span class=sd>        -------</span>
<span class=sd>        rigid_xform_xyz_px : Optional[ArrayLike]</span>
<span class=sd>            Local rigid registration transform for one round and tile.</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
            <span class=k>if</span> <span class=n>tile</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>tile</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set tile index &gt;=0 and &lt;=&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>))</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>tile_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>[</span><span class=n>tile</span><span class=p>]</span>
        <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
            <span class=k>if</span> <span class=n>tile</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;set valid tiled id&quot;</span><span class=p>)</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>tile_id</span> <span class=o>=</span> <span class=n>tile</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;tile&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>

        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=nb>round</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
            <span class=k>if</span> <span class=nb>round</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set round index &gt;=0 and &lt;&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_num_rounds</span><span class=p>))</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>round_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_round_ids</span><span class=p>[</span><span class=nb>round</span><span class=p>]</span>
        <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=nb>round</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
            <span class=k>if</span> <span class=nb>round</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_round_ids</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set valid round id&quot;</span><span class=p>)</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>round_id</span> <span class=o>=</span> <span class=nb>round</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;round&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=k>try</span><span class=p>:</span>
            <span class=n>zattrs_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_polyDT_root_path</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>round_id</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;.zattrs&quot;</span><span class=p>)</span>
            <span class=p>)</span>
            <span class=n>attributes</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_json</span><span class=p>(</span><span class=n>zattrs_path</span><span class=p>)</span>
            <span class=n>attributes</span><span class=p>[</span><span class=s2>&quot;rigid_xform_xyz_px&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>rigid_xform_xyz_px</span><span class=o>.</span><span class=n>tolist</span><span class=p>()</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_save_to_json</span><span class=p>(</span><span class=n>attributes</span><span class=p>,</span> <span class=n>zattrs_path</span><span class=p>)</span>
        <span class=k>except</span> <span class=p>(</span><span class=ne>FileNotFoundError</span><span class=p>,</span> <span class=n>json</span><span class=o>.</span><span class=n>JSONDecodeError</span><span class=p>):</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Error writing rigid transform attribute.&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>

    <span class=k>def</span> <span class=nf>load_coord_of_xform_px</span><span class=p>(</span>
        <span class=bp>self</span><span class=p>,</span>
        <span class=n>tile</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>]],</span>
        <span class=nb>round</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>]],</span>
        <span class=n>return_future</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>bool</span><span class=p>]</span> <span class=o>=</span> <span class=kc>True</span><span class=p>,</span>
    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>tuple</span><span class=p>[</span><span class=n>ArrayLike</span><span class=p>,</span> <span class=n>ArrayLike</span><span class=p>]]:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Local fidicual optical flow matrix for one round and tile.</span>

<span class=sd>        Parameters</span>
<span class=sd>        ----------</span>
<span class=sd>        tile : Optional[Union[int, str]]</span>
<span class=sd>            Tile index or tile id.</span>
<span class=sd>        round : Optional[Union[int, str]]</span>
<span class=sd>            Round index or round id.</span>
<span class=sd>        return_future : Optional[bool]</span>
<span class=sd>            Return future array.</span>

<span class=sd>        Returns</span>
<span class=sd>        -------</span>
<span class=sd>        of_xform_px : Optional[ArrayLike]</span>
<span class=sd>            Local fidicual optical flow matrix for one round and tile.</span>
<span class=sd>        downsampling : Optional[ArrayLike]</span>
<span class=sd>            Downsampling factor.</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
            <span class=k>if</span> <span class=n>tile</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>tile</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set tile index &gt;=0 and &lt;=&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>))</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>tile_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>[</span><span class=n>tile</span><span class=p>]</span>
        <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
            <span class=k>if</span> <span class=n>tile</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;set valid tiled id&quot;</span><span class=p>)</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>tile_id</span> <span class=o>=</span> <span class=n>tile</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;tile&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>

        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=nb>round</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
            <span class=k>if</span> <span class=nb>round</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set round index &gt;=0 and &lt;&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_num_rounds</span><span class=p>))</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>round_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_round_ids</span><span class=p>[</span><span class=nb>round</span><span class=p>]</span>
        <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=nb>round</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
            <span class=k>if</span> <span class=nb>round</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_round_ids</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set valid round id&quot;</span><span class=p>)</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>round_id</span> <span class=o>=</span> <span class=nb>round</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;round&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>

        <span class=n>current_local_zarr_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_polyDT_root_path</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>round_id</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;of_xform_px&quot;</span><span class=p>)</span>
        <span class=p>)</span>
        <span class=n>zattrs_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_polyDT_root_path</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>round_id</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;.zattrs&quot;</span><span class=p>)</span>
        <span class=p>)</span>

        <span class=k>if</span> <span class=ow>not</span> <span class=n>Path</span><span class=p>(</span><span class=n>current_local_zarr_path</span><span class=p>)</span><span class=o>.</span><span class=n>exists</span><span class=p>():</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Optical flow transform mapping back to first round not found.&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>

        <span class=k>try</span><span class=p>:</span>
            <span class=n>compressor</span> <span class=o>=</span> <span class=p>{</span>
                <span class=s2>&quot;id&quot;</span><span class=p>:</span> <span class=s2>&quot;blosc&quot;</span><span class=p>,</span>
                <span class=s2>&quot;cname&quot;</span><span class=p>:</span> <span class=s2>&quot;zstd&quot;</span><span class=p>,</span>
                <span class=s2>&quot;clevel&quot;</span><span class=p>:</span> <span class=mi>5</span><span class=p>,</span>
                <span class=s2>&quot;shuffle&quot;</span><span class=p>:</span> <span class=mi>2</span><span class=p>,</span>
            <span class=p>}</span>
            <span class=n>spec_of</span> <span class=o>=</span> <span class=p>{</span>
                <span class=s2>&quot;driver&quot;</span><span class=p>:</span> <span class=s2>&quot;zarr&quot;</span><span class=p>,</span>
                <span class=s2>&quot;kvstore&quot;</span><span class=p>:</span> <span class=kc>None</span><span class=p>,</span>
                <span class=s2>&quot;metadata&quot;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&quot;compressor&quot;</span><span class=p>:</span> <span class=n>compressor</span><span class=p>},</span>
                <span class=s2>&quot;open&quot;</span><span class=p>:</span> <span class=kc>True</span><span class=p>,</span>
                <span class=s2>&quot;assume_metadata&quot;</span><span class=p>:</span> <span class=kc>False</span><span class=p>,</span>
                <span class=s2>&quot;create&quot;</span><span class=p>:</span> <span class=kc>True</span><span class=p>,</span>
                <span class=s2>&quot;delete_existing&quot;</span><span class=p>:</span> <span class=kc>False</span><span class=p>,</span>
            <span class=p>}</span>
            <span class=n>spec_of</span><span class=p>[</span><span class=s2>&quot;metadata&quot;</span><span class=p>][</span><span class=s2>&quot;dtype&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&quot;&lt;f4&quot;</span>
            <span class=n>of_xform_px</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_zarr_array</span><span class=p>(</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_get_kvstore_key</span><span class=p>(</span><span class=n>current_local_zarr_path</span><span class=p>),</span>
                <span class=n>spec_of</span><span class=o>.</span><span class=n>copy</span><span class=p>(),</span>
                <span class=n>return_future</span><span class=p>,</span>
            <span class=p>)</span>
            <span class=n>attributes</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_json</span><span class=p>(</span><span class=n>zattrs_path</span><span class=p>)</span>
            <span class=n>downsampling</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>asarray</span><span class=p>(</span>
                <span class=n>attributes</span><span class=p>[</span><span class=s2>&quot;opticalflow_downsampling&quot;</span><span class=p>],</span> <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>float32</span>
            <span class=p>)</span>

            <span class=k>return</span> <span class=n>of_xform_px</span><span class=p>,</span> <span class=n>downsampling</span>
        <span class=k>except</span> <span class=p>(</span><span class=ne>IOError</span><span class=p>,</span> <span class=ne>OSError</span><span class=p>,</span> <span class=n>ZarrError</span><span class=p>)</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=n>e</span><span class=p>)</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Error loading optical flow transform.&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>

    <span class=k>def</span> <span class=nf>save_coord_of_xform_px</span><span class=p>(</span>
        <span class=bp>self</span><span class=p>,</span>
        <span class=n>of_xform_px</span><span class=p>:</span> <span class=n>ArrayLike</span><span class=p>,</span>
        <span class=n>tile</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>],</span>
        <span class=n>downsampling</span><span class=p>:</span> <span class=n>Sequence</span><span class=p>[</span><span class=nb>float</span><span class=p>],</span>
        <span class=nb>round</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>],</span>
        <span class=n>return_future</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>bool</span><span class=p>]</span> <span class=o>=</span> <span class=kc>False</span><span class=p>,</span>
    <span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Save fidicual optical flow matrix for one round and tile.</span>

<span class=sd>        Parameters</span>
<span class=sd>        ----------</span>
<span class=sd>        of_xform_px : ArrayLike</span>
<span class=sd>            Local fidicual optical flow matrix for one round and tile.</span>
<span class=sd>        tile : Union[int, str]</span>
<span class=sd>            Tile index or tile id.</span>
<span class=sd>        downsampling : Sequence[float]</span>
<span class=sd>            Downsampling factor.</span>
<span class=sd>        round : Union[int, str] </span>
<span class=sd>            Round index or round id.</span>
<span class=sd>        return_future : Optional[bool]</span>
<span class=sd>            Return future array.</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
            <span class=k>if</span> <span class=n>tile</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>tile</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set tile index &gt;=0 and &lt;=&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>))</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>tile_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>[</span><span class=n>tile</span><span class=p>]</span>
        <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
            <span class=k>if</span> <span class=n>tile</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;set valid tiled id&quot;</span><span class=p>)</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>tile_id</span> <span class=o>=</span> <span class=n>tile</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;tile&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>

        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=nb>round</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
            <span class=k>if</span> <span class=nb>round</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set round index &gt;=0 and &lt;&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_num_rounds</span><span class=p>))</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>local_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_round_ids</span><span class=p>[</span><span class=nb>round</span><span class=p>]</span>
        <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=nb>round</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
            <span class=k>if</span> <span class=nb>round</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_round_ids</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set valid round id&quot;</span><span class=p>)</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>local_id</span> <span class=o>=</span> <span class=nb>round</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;round&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=n>current_local_zarr_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_polyDT_root_path</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>local_id</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;of_xform_px&quot;</span><span class=p>)</span>
        <span class=p>)</span>
        <span class=n>current_local_zattrs_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_polyDT_root_path</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>local_id</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;.zattrs&quot;</span><span class=p>)</span>
        <span class=p>)</span>

        <span class=k>try</span><span class=p>:</span>
            <span class=n>compressor</span> <span class=o>=</span> <span class=p>{</span>
                <span class=s2>&quot;id&quot;</span><span class=p>:</span> <span class=s2>&quot;blosc&quot;</span><span class=p>,</span>
                <span class=s2>&quot;cname&quot;</span><span class=p>:</span> <span class=s2>&quot;zstd&quot;</span><span class=p>,</span>
                <span class=s2>&quot;clevel&quot;</span><span class=p>:</span> <span class=mi>5</span><span class=p>,</span>
                <span class=s2>&quot;shuffle&quot;</span><span class=p>:</span> <span class=mi>2</span><span class=p>,</span>
            <span class=p>}</span>
            <span class=n>spec_of</span> <span class=o>=</span> <span class=p>{</span>
                <span class=s2>&quot;driver&quot;</span><span class=p>:</span> <span class=s2>&quot;zarr&quot;</span><span class=p>,</span>
                <span class=s2>&quot;kvstore&quot;</span><span class=p>:</span> <span class=kc>None</span><span class=p>,</span>
                <span class=s2>&quot;metadata&quot;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&quot;compressor&quot;</span><span class=p>:</span> <span class=n>compressor</span><span class=p>},</span>
                <span class=s2>&quot;open&quot;</span><span class=p>:</span> <span class=kc>True</span><span class=p>,</span>
                <span class=s2>&quot;assume_metadata&quot;</span><span class=p>:</span> <span class=kc>False</span><span class=p>,</span>
                <span class=s2>&quot;create&quot;</span><span class=p>:</span> <span class=kc>True</span><span class=p>,</span>
                <span class=s2>&quot;delete_existing&quot;</span><span class=p>:</span> <span class=kc>False</span><span class=p>,</span>
            <span class=p>}</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_save_to_zarr_array</span><span class=p>(</span>
                <span class=n>of_xform_px</span><span class=p>,</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_get_kvstore_key</span><span class=p>(</span><span class=n>current_local_zarr_path</span><span class=p>),</span>
                <span class=n>spec_of</span><span class=o>.</span><span class=n>copy</span><span class=p>(),</span>
                <span class=n>return_future</span><span class=p>,</span>
            <span class=p>)</span>
            <span class=n>attributes</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_json</span><span class=p>(</span><span class=n>current_local_zattrs_path</span><span class=p>)</span>
            <span class=n>attributes</span><span class=p>[</span><span class=s2>&quot;opticalflow_downsampling&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>downsampling</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_save_to_json</span><span class=p>(</span><span class=n>attributes</span><span class=p>,</span> <span class=n>current_local_zattrs_path</span><span class=p>)</span>
        <span class=k>except</span> <span class=p>(</span><span class=ne>IOError</span><span class=p>,</span> <span class=ne>OSError</span><span class=p>,</span> <span class=ne>TimeoutError</span><span class=p>):</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Error saving optical flow transform.&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>

    <span class=k>def</span> <span class=nf>load_local_registered_image</span><span class=p>(</span>
        <span class=bp>self</span><span class=p>,</span>
        <span class=n>tile</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>],</span>
        <span class=nb>round</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>]]</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span>
        <span class=n>bit</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>]]</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span>
        <span class=n>return_future</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>bool</span><span class=p>]</span> <span class=o>=</span> <span class=kc>True</span><span class=p>,</span>
    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=n>ArrayLike</span><span class=p>]:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Local registered, deconvolved image for fidiculial OR readout bit for one tile.</span>

<span class=sd>        Parameters</span>
<span class=sd>        ----------</span>
<span class=sd>        tile : Union[int, str]</span>
<span class=sd>            Tile index or tile id.</span>
<span class=sd>        round : Optional[Union[int, str]]</span>
<span class=sd>            Round index or round id.</span>
<span class=sd>        bit : Optional[Union[int, str]]</span>
<span class=sd>            Bit index or bit id.</span>
<span class=sd>        return_future : Optional[bool]</span>
<span class=sd>            Return future array.</span>

<span class=sd>        Returns</span>
<span class=sd>        -------</span>
<span class=sd>        registered_decon_image : Optional[ArrayLike]</span>
<span class=sd>            Registered, deconvolved image for fidiculial OR readout bit for one tile.</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=k>if</span> <span class=p>(</span><span class=nb>round</span> <span class=ow>is</span> <span class=kc>None</span> <span class=ow>and</span> <span class=n>bit</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>)</span> <span class=ow>or</span> <span class=p>(</span><span class=nb>round</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span> <span class=ow>and</span> <span class=n>bit</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>):</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Provide either &#39;round&#39; or &#39;bit&#39;, but not both&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>

        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
            <span class=k>if</span> <span class=n>tile</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>tile</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set tile index &gt;=0 and &lt;=&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>))</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>tile_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>[</span><span class=n>tile</span><span class=p>]</span>
        <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
            <span class=k>if</span> <span class=n>tile</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;set valid tiled id&quot;</span><span class=p>)</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>tile_id</span> <span class=o>=</span> <span class=n>tile</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;tile&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>

        <span class=k>if</span> <span class=n>bit</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
            <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>bit</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
                <span class=k>if</span> <span class=n>bit</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>bit</span> <span class=o>&gt;</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>):</span>
                    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set bit index &gt;=0 and &lt;=&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>)))</span>
                    <span class=k>return</span> <span class=kc>None</span>
                <span class=k>else</span><span class=p>:</span>
                    <span class=n>local_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>[</span><span class=n>bit</span><span class=p>]</span>
            <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>bit</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
                <span class=k>if</span> <span class=n>bit</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>:</span>
                    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set valid bit id&quot;</span><span class=p>)</span>
                    <span class=k>return</span> <span class=kc>None</span>
                <span class=k>else</span><span class=p>:</span>
                    <span class=n>local_id</span> <span class=o>=</span> <span class=n>bit</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;bit&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=n>current_local_zarr_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_readouts_root_path</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>local_id</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;registered_decon_data&quot;</span><span class=p>)</span>
            <span class=p>)</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=nb>round</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
                <span class=k>if</span> <span class=nb>round</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>:</span>
                    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set round index &gt;=0 and &lt;&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_num_rounds</span><span class=p>))</span>
                    <span class=k>return</span> <span class=kc>None</span>
                <span class=k>else</span><span class=p>:</span>
                    <span class=n>local_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_round_ids</span><span class=p>[</span><span class=nb>round</span><span class=p>]</span>
            <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=nb>round</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
                <span class=k>if</span> <span class=nb>round</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_round_ids</span><span class=p>:</span>
                    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set valid round id&quot;</span><span class=p>)</span>
                    <span class=k>return</span> <span class=kc>None</span>
                <span class=k>else</span><span class=p>:</span>
                    <span class=n>local_id</span> <span class=o>=</span> <span class=nb>round</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;round&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=n>current_local_zarr_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_polyDT_root_path</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>local_id</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;registered_decon_data&quot;</span><span class=p>)</span>
            <span class=p>)</span>

        <span class=k>if</span> <span class=ow>not</span> <span class=n>Path</span><span class=p>(</span><span class=n>current_local_zarr_path</span><span class=p>)</span><span class=o>.</span><span class=n>exists</span><span class=p>():</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Registered deconvolved image not found.&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>

        <span class=k>try</span><span class=p>:</span>
            <span class=n>spec</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_zarrv2_spec</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>
            <span class=n>spec</span><span class=p>[</span><span class=s2>&quot;metadata&quot;</span><span class=p>][</span><span class=s2>&quot;dtype&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&quot;&lt;u2&quot;</span>
            <span class=n>registered_decon_image</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_zarr_array</span><span class=p>(</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_get_kvstore_key</span><span class=p>(</span><span class=n>current_local_zarr_path</span><span class=p>),</span>
                <span class=n>spec</span><span class=p>,</span>
                <span class=n>return_future</span><span class=p>,</span>
            <span class=p>)</span>
            <span class=k>return</span> <span class=n>registered_decon_image</span>
        <span class=k>except</span> <span class=p>(</span><span class=ne>IOError</span><span class=p>,</span> <span class=ne>OSError</span><span class=p>,</span> <span class=n>ZarrError</span><span class=p>)</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=n>e</span><span class=p>)</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Error loading registered deconvolved image.&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>

    <span class=k>def</span> <span class=nf>save_local_registered_image</span><span class=p>(</span>
        <span class=bp>self</span><span class=p>,</span>
        <span class=n>registered_image</span><span class=p>:</span> <span class=n>ArrayLike</span><span class=p>,</span>
        <span class=n>tile</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>],</span>
        <span class=n>deconvolution</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>True</span><span class=p>,</span>
        <span class=nb>round</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>]]</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span>
        <span class=n>bit</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>]]</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span>
        <span class=n>return_future</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>bool</span><span class=p>]</span> <span class=o>=</span> <span class=kc>False</span><span class=p>,</span>
    <span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Save registered, deconvolved image.</span>

<span class=sd>        Parameters</span>
<span class=sd>        ----------</span>
<span class=sd>        registered_image : ArrayLike</span>
<span class=sd>            Registered, deconvolved image.</span>
<span class=sd>        tile : Union[int, str]</span>
<span class=sd>            Tile index or tile id.</span>
<span class=sd>        deconvolution : bool</span>
<span class=sd>            Deconvolution applied (True) or not (False).</span>
<span class=sd>        round : Optional[Union[int, str]]</span>
<span class=sd>            Round index or round id.</span>
<span class=sd>        bit : Optional[Union[int, str]]</span>
<span class=sd>            Bit index or bit id.</span>
<span class=sd>        return_future : Optional[bool]</span>
<span class=sd>            Return future array.</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=k>if</span> <span class=p>(</span><span class=nb>round</span> <span class=ow>is</span> <span class=kc>None</span> <span class=ow>and</span> <span class=n>bit</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>)</span> <span class=ow>or</span> <span class=p>(</span><span class=nb>round</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span> <span class=ow>and</span> <span class=n>bit</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>):</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Provide either &#39;round&#39; or &#39;bit&#39;, but not both&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>

        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
            <span class=k>if</span> <span class=n>tile</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>tile</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set tile index &gt;=0 and &lt;=&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>))</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>tile_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>[</span><span class=n>tile</span><span class=p>]</span>
        <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
            <span class=k>if</span> <span class=n>tile</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;set valid tiled id&quot;</span><span class=p>)</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>tile_id</span> <span class=o>=</span> <span class=n>tile</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;tile&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>

        <span class=k>if</span> <span class=n>bit</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
            <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>bit</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
                <span class=k>if</span> <span class=n>bit</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>bit</span> <span class=o>&gt;</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>):</span>
                    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set bit index &gt;=0 and &lt;=&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>)))</span>
                    <span class=k>return</span> <span class=kc>None</span>
                <span class=k>else</span><span class=p>:</span>
                    <span class=n>local_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>[</span><span class=n>bit</span><span class=p>]</span>
            <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>bit</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
                <span class=k>if</span> <span class=n>bit</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>:</span>
                    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set valid bit id&quot;</span><span class=p>)</span>
                    <span class=k>return</span> <span class=kc>None</span>
                <span class=k>else</span><span class=p>:</span>
                    <span class=n>local_id</span> <span class=o>=</span> <span class=n>bit</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;bit&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=n>current_local_zarr_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_readouts_root_path</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>local_id</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;registered_decon_data&quot;</span><span class=p>)</span>
            <span class=p>)</span>
            <span class=n>current_local_zattrs_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_readouts_root_path</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>local_id</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;.zattrs&quot;</span><span class=p>)</span>
            <span class=p>)</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=nb>round</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
                <span class=k>if</span> <span class=nb>round</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>:</span>
                    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set round index &gt;=0 and &lt;&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_num_rounds</span><span class=p>))</span>
                    <span class=k>return</span> <span class=kc>None</span>
                <span class=k>else</span><span class=p>:</span>
                    <span class=n>local_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_round_ids</span><span class=p>[</span><span class=nb>round</span><span class=p>]</span>
            <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=nb>round</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
                <span class=k>if</span> <span class=nb>round</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_round_ids</span><span class=p>:</span>
                    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set valid round id&quot;</span><span class=p>)</span>
                    <span class=k>return</span> <span class=kc>None</span>
                <span class=k>else</span><span class=p>:</span>
                    <span class=n>local_id</span> <span class=o>=</span> <span class=nb>round</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;round&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=n>current_local_zarr_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_polyDT_root_path</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>local_id</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;registered_decon_data&quot;</span><span class=p>)</span>
            <span class=p>)</span>
            <span class=n>current_local_zattrs_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_polyDT_root_path</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>local_id</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;.zattrs&quot;</span><span class=p>)</span>
            <span class=p>)</span>

        <span class=k>try</span><span class=p>:</span>
            <span class=n>spec</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_zarrv2_spec</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>
            <span class=n>spec</span><span class=p>[</span><span class=s2>&quot;metadata&quot;</span><span class=p>][</span><span class=s2>&quot;dtype&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&quot;&lt;u2&quot;</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_save_to_zarr_array</span><span class=p>(</span>
                <span class=n>registered_image</span><span class=p>,</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_get_kvstore_key</span><span class=p>(</span><span class=n>current_local_zarr_path</span><span class=p>),</span>
                <span class=n>spec</span><span class=p>,</span>
                <span class=n>return_future</span><span class=p>,</span>
            <span class=p>)</span>
            <span class=n>attributes</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_json</span><span class=p>(</span><span class=n>current_local_zattrs_path</span><span class=p>)</span>
            <span class=n>attributes</span><span class=p>[</span><span class=s2>&quot;deconvolution&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>deconvolution</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_save_to_json</span><span class=p>(</span><span class=n>attributes</span><span class=p>,</span> <span class=n>current_local_zattrs_path</span><span class=p>)</span>
        <span class=k>except</span> <span class=p>(</span><span class=ne>IOError</span><span class=p>,</span> <span class=ne>OSError</span><span class=p>,</span> <span class=ne>TimeoutError</span><span class=p>):</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Error saving corrected image.&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>

    <span class=k>def</span> <span class=nf>load_local_ufish_image</span><span class=p>(</span>
        <span class=bp>self</span><span class=p>,</span>
        <span class=n>tile</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>],</span>
        <span class=n>bit</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>],</span>
        <span class=n>return_future</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>bool</span><span class=p>]</span> <span class=o>=</span> <span class=kc>True</span><span class=p>,</span>
    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=n>ArrayLike</span><span class=p>]:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Load readout bit U-FISH prediction image for one tile.</span>

<span class=sd>        Parameters</span>
<span class=sd>        ----------</span>
<span class=sd>        tile : Union[int, str]</span>
<span class=sd>            Tile index or tile id.</span>
<span class=sd>        bit : Union[int, str]</span>
<span class=sd>            Bit index or bit id.</span>
<span class=sd>        return_future : Optional[bool]</span>

<span class=sd>        Returns</span>
<span class=sd>        -------</span>
<span class=sd>        registered_ufish_image : Optional[ArrayLike]</span>
<span class=sd>            U-FISH prediction image for one tile.</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
            <span class=k>if</span> <span class=n>tile</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>tile</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set tile index &gt;=0 and &lt;=&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>))</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>tile_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>[</span><span class=n>tile</span><span class=p>]</span>
        <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
            <span class=k>if</span> <span class=n>tile</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;set valid tiled id&quot;</span><span class=p>)</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>tile_id</span> <span class=o>=</span> <span class=n>tile</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;tile&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>

        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>bit</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
            <span class=k>if</span> <span class=n>bit</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>bit</span> <span class=o>&gt;</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>):</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set bit index &gt;=0 and &lt;=&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>)))</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>bit_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>[</span><span class=n>bit</span><span class=p>]</span>
        <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>bit</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
            <span class=k>if</span> <span class=n>bit</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set valid bit id&quot;</span><span class=p>)</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>bit_id</span> <span class=o>=</span> <span class=n>bit</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;bit&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>

        <span class=n>current_local_zarr_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_readouts_root_path</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>bit_id</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;registered_ufish_data&quot;</span><span class=p>)</span>
        <span class=p>)</span>

        <span class=k>if</span> <span class=ow>not</span> <span class=n>Path</span><span class=p>(</span><span class=n>current_local_zarr_path</span><span class=p>)</span><span class=o>.</span><span class=n>exists</span><span class=p>():</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;U-FISH prediction image not found.&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>

        <span class=k>try</span><span class=p>:</span>
            <span class=n>spec</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_zarrv2_spec</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>
            <span class=n>spec</span><span class=p>[</span><span class=s2>&quot;metadata&quot;</span><span class=p>][</span><span class=s2>&quot;dtype&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&quot;&lt;f4&quot;</span>
            <span class=n>registered_ufish_image</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_zarr_array</span><span class=p>(</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_get_kvstore_key</span><span class=p>(</span><span class=n>current_local_zarr_path</span><span class=p>),</span>
                <span class=n>spec</span><span class=p>,</span>
                <span class=n>return_future</span><span class=p>,</span>
            <span class=p>)</span>
            <span class=k>return</span> <span class=n>registered_ufish_image</span>
        <span class=k>except</span> <span class=p>(</span><span class=ne>IOError</span><span class=p>,</span> <span class=ne>OSError</span><span class=p>,</span> <span class=n>ZarrError</span><span class=p>)</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=n>e</span><span class=p>)</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Error loading U-FISH image.&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>

    <span class=k>def</span> <span class=nf>save_local_ufish_image</span><span class=p>(</span>
        <span class=bp>self</span><span class=p>,</span>
        <span class=n>ufish_image</span><span class=p>:</span> <span class=n>ArrayLike</span><span class=p>,</span>
        <span class=n>tile</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>],</span>
        <span class=n>bit</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>],</span>
        <span class=n>return_future</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>bool</span><span class=p>]</span> <span class=o>=</span> <span class=kc>False</span><span class=p>,</span>
    <span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Save U-FISH prediction image.</span>

<span class=sd>        Parameters</span>
<span class=sd>        ----------</span>
<span class=sd>        ufish_image : ArrayLike</span>
<span class=sd>            U-FISH prediction image.</span>
<span class=sd>        tile : Union[int, str]</span>
<span class=sd>            Tile index or tile id.</span>
<span class=sd>        bit : Union[int, str]</span>
<span class=sd>            Bit index or bit id.</span>
<span class=sd>        return_future : Optional[bool]</span>
<span class=sd>            Return future array.</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
            <span class=k>if</span> <span class=n>tile</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>tile</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set tile index &gt;=0 and &lt;=&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>))</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>tile_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>[</span><span class=n>tile</span><span class=p>]</span>
        <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
            <span class=k>if</span> <span class=n>tile</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;set valid tiled id&quot;</span><span class=p>)</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>tile_id</span> <span class=o>=</span> <span class=n>tile</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;tile&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>

        <span class=k>if</span> <span class=n>bit</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
            <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>bit</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
                <span class=k>if</span> <span class=n>bit</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>bit</span> <span class=o>&gt;</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>):</span>
                    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set bit index &gt;=0 and &lt;=&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>)))</span>
                    <span class=k>return</span> <span class=kc>None</span>
                <span class=k>else</span><span class=p>:</span>
                    <span class=n>local_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>[</span><span class=n>bit</span><span class=p>]</span>
            <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>bit</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
                <span class=k>if</span> <span class=n>bit</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>:</span>
                    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set valid bit id&quot;</span><span class=p>)</span>
                    <span class=k>return</span> <span class=kc>None</span>
                <span class=k>else</span><span class=p>:</span>
                    <span class=n>local_id</span> <span class=o>=</span> <span class=n>bit</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;bit&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=n>current_local_zarr_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_readouts_root_path</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>local_id</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;registered_ufish_data&quot;</span><span class=p>)</span>
            <span class=p>)</span>

        <span class=k>try</span><span class=p>:</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_save_to_zarr_array</span><span class=p>(</span>
                <span class=n>ufish_image</span><span class=p>,</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_get_kvstore_key</span><span class=p>(</span><span class=n>current_local_zarr_path</span><span class=p>),</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_zarrv2_spec</span><span class=o>.</span><span class=n>copy</span><span class=p>(),</span>
                <span class=n>return_future</span><span class=p>,</span>
            <span class=p>)</span>
        <span class=k>except</span> <span class=p>(</span><span class=ne>IOError</span><span class=p>,</span> <span class=ne>OSError</span><span class=p>,</span> <span class=n>ZarrError</span><span class=p>)</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=n>e</span><span class=p>)</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Error saving U-Fish image.&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>

    <span class=k>def</span> <span class=nf>load_local_ufish_spots</span><span class=p>(</span>
        <span class=bp>self</span><span class=p>,</span>
        <span class=n>tile</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>],</span>
        <span class=n>bit</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>],</span>
    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>]:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Load U-FISH spot localizations and features for one tile.</span>

<span class=sd>        Parameters</span>
<span class=sd>        ----------</span>
<span class=sd>        tile : Union[int, str]</span>
<span class=sd>            Tile index or tile id.</span>
<span class=sd>        bit : Union[int, str]</span>
<span class=sd>            Bit index or bit id.</span>

<span class=sd>        Returns</span>
<span class=sd>        -------</span>
<span class=sd>        ufish_localizations : Optional[pd.DataFrame]</span>
<span class=sd>            U-FISH localizations and features for one tile.</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
            <span class=k>if</span> <span class=n>tile</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>tile</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set tile index &gt;=0 and &lt;=&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>))</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>tile_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>[</span><span class=n>tile</span><span class=p>]</span>
        <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
            <span class=k>if</span> <span class=n>tile</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;set valid tiled id&quot;</span><span class=p>)</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>tile_id</span> <span class=o>=</span> <span class=n>tile</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;tile&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>

        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>bit</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
            <span class=k>if</span> <span class=n>bit</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>bit</span> <span class=o>&gt;</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>):</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set bit index &gt;=0 and &lt;=&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>)))</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>bit_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>[</span><span class=n>bit</span><span class=p>]</span>
        <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>bit</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
            <span class=k>if</span> <span class=n>bit</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set valid bit id&quot;</span><span class=p>)</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>bit_id</span> <span class=o>=</span> <span class=n>bit</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;bit&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>

        <span class=n>current_ufish_localizations_path</span> <span class=o>=</span> <span class=p>(</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_ufish_localizations_root_path</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>bit_id</span> <span class=o>+</span> <span class=s2>&quot;.parquet&quot;</span><span class=p>)</span>
        <span class=p>)</span>

        <span class=k>if</span> <span class=ow>not</span> <span class=n>current_ufish_localizations_path</span><span class=o>.</span><span class=n>exists</span><span class=p>():</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;U-FISH localizations not found.&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>ufish_localizations</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_parquet</span><span class=p>(</span>
                <span class=n>current_ufish_localizations_path</span>
            <span class=p>)</span>
            <span class=k>return</span> <span class=n>ufish_localizations</span>

    <span class=k>def</span> <span class=nf>save_local_ufish_spots</span><span class=p>(</span>
        <span class=bp>self</span><span class=p>,</span>
        <span class=n>spot_df</span><span class=p>:</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>,</span>
        <span class=n>tile</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>],</span>
        <span class=n>bit</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>],</span>
    <span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Save U-FISH localizations and features.</span>

<span class=sd>        Parameters</span>
<span class=sd>        ----------</span>
<span class=sd>        spot_df : pd.DataFrame</span>
<span class=sd>            U-FISH localizations and features.</span>
<span class=sd>        tile : Union[int, str]</span>
<span class=sd>            Tile index or tile id.</span>
<span class=sd>        bit : Union[int, str]</span>
<span class=sd>            Bit index or bit id.</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
            <span class=k>if</span> <span class=n>tile</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>tile</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set tile index &gt;=0 and &lt;=&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>))</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>tile_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>[</span><span class=n>tile</span><span class=p>]</span>
        <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
            <span class=k>if</span> <span class=n>tile</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;set valid tiled id&quot;</span><span class=p>)</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>tile_id</span> <span class=o>=</span> <span class=n>tile</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;tile&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>

        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>bit</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
            <span class=k>if</span> <span class=n>bit</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>bit</span> <span class=o>&gt;</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>):</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set bit index &gt;=0 and &lt;=&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>)))</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>bit_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>[</span><span class=n>bit</span><span class=p>]</span>
        <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>bit</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
            <span class=k>if</span> <span class=n>bit</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set valid bit id&quot;</span><span class=p>)</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>bit_id</span> <span class=o>=</span> <span class=n>bit</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;bit&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>

        <span class=k>if</span> <span class=ow>not</span> <span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_ufish_localizations_root_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>))</span><span class=o>.</span><span class=n>exists</span><span class=p>():</span>
            <span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_ufish_localizations_root_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>))</span><span class=o>.</span><span class=n>mkdir</span><span class=p>()</span>

        <span class=n>current_ufish_localizations_path</span> <span class=o>=</span> <span class=p>(</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_ufish_localizations_root_path</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>bit_id</span> <span class=o>+</span> <span class=s2>&quot;.parquet&quot;</span><span class=p>)</span>
        <span class=p>)</span>

        <span class=k>try</span><span class=p>:</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_save_to_parquet</span><span class=p>(</span><span class=n>spot_df</span><span class=p>,</span> <span class=n>current_ufish_localizations_path</span><span class=p>)</span>
        <span class=k>except</span> <span class=p>(</span><span class=ne>IOError</span><span class=p>,</span> <span class=ne>OSError</span><span class=p>)</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=n>e</span><span class=p>)</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Error saving U-FISH localizations.&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>

    <span class=k>def</span> <span class=nf>load_global_coord_xforms_um</span><span class=p>(</span>
        <span class=bp>self</span><span class=p>,</span>
        <span class=n>tile</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>],</span>
    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>tuple</span><span class=p>[</span><span class=n>ArrayLike</span><span class=p>,</span> <span class=n>ArrayLike</span><span class=p>,</span> <span class=n>ArrayLike</span><span class=p>]]:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Load global registration transform for one tile.</span>

<span class=sd>        Parameters</span>
<span class=sd>        ----------</span>
<span class=sd>        tile : Union[int, str]</span>
<span class=sd>            Tile index or tile id.</span>

<span class=sd>        Returns</span>
<span class=sd>        -------</span>
<span class=sd>        affine_zyx_um : Optional[ArrayLike]</span>
<span class=sd>            Global affine registration transform for one tile.</span>
<span class=sd>        origin_zyx_um : Optional[ArrayLike]</span>
<span class=sd>            Global origin registration transform for one tile.</span>
<span class=sd>        spacing_zyx_um : Optional[ArrayLike]</span>
<span class=sd>            Global spacing registration transform for one tile.</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
            <span class=k>if</span> <span class=n>tile</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>tile</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set tile index &gt;=0 and &lt;=&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>))</span>
                <span class=k>return</span> <span class=kc>None</span><span class=p>,</span> <span class=kc>None</span><span class=p>,</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>tile_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>[</span><span class=n>tile</span><span class=p>]</span>
        <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
            <span class=k>if</span> <span class=n>tile</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;set valid tiled id&quot;</span><span class=p>)</span>
                <span class=k>return</span> <span class=kc>None</span><span class=p>,</span> <span class=kc>None</span><span class=p>,</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>tile_id</span> <span class=o>=</span> <span class=n>tile</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;tile&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>

        <span class=k>try</span><span class=p>:</span>
            <span class=n>zattrs_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_polyDT_root_path</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_round_ids</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;.zattrs&quot;</span><span class=p>)</span>
            <span class=p>)</span>
            <span class=n>attributes</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_json</span><span class=p>(</span><span class=n>zattrs_path</span><span class=p>)</span>
            <span class=n>affine_zyx_um</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>asarray</span><span class=p>(</span><span class=n>attributes</span><span class=p>[</span><span class=s2>&quot;affine_zyx_um&quot;</span><span class=p>],</span> <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>float32</span><span class=p>)</span>
            <span class=n>origin_zyx_um</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>asarray</span><span class=p>(</span><span class=n>attributes</span><span class=p>[</span><span class=s2>&quot;origin_zyx_um&quot;</span><span class=p>],</span> <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>float32</span><span class=p>)</span>
            <span class=n>spacing_zyx_um</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>asarray</span><span class=p>(</span><span class=n>attributes</span><span class=p>[</span><span class=s2>&quot;spacing_zyx_um&quot;</span><span class=p>],</span> <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>float32</span><span class=p>)</span>
            <span class=k>return</span> <span class=p>(</span><span class=n>affine_zyx_um</span><span class=p>,</span> <span class=n>origin_zyx_um</span><span class=p>,</span> <span class=n>spacing_zyx_um</span><span class=p>)</span>
        <span class=k>except</span> <span class=p>(</span><span class=ne>FileNotFoundError</span><span class=p>,</span> <span class=n>json</span><span class=o>.</span><span class=n>JSONDecodeError</span><span class=p>):</span>
            <span class=nb>print</span><span class=p>(</span><span class=n>tile_id</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>_round_ids</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Global coordinate transforms not found&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span><span class=p>,</span> <span class=kc>None</span><span class=p>,</span> <span class=kc>None</span>

    <span class=k>def</span> <span class=nf>save_global_coord_xforms_um</span><span class=p>(</span>
        <span class=bp>self</span><span class=p>,</span>
        <span class=n>affine_zyx_um</span><span class=p>:</span> <span class=n>ArrayLike</span><span class=p>,</span>
        <span class=n>origin_zyx_um</span><span class=p>:</span> <span class=n>ArrayLike</span><span class=p>,</span>
        <span class=n>spacing_zyx_um</span><span class=p>:</span> <span class=n>ArrayLike</span><span class=p>,</span>
        <span class=n>tile</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>],</span>
    <span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Save global registration transform for one tile.</span>

<span class=sd>        Parameters</span>
<span class=sd>        ----------</span>
<span class=sd>        affine_zyx_um : ArrayLike</span>
<span class=sd>            Global affine registration transform for one tile.</span>
<span class=sd>        origin_zyx_um : ArrayLike</span>
<span class=sd>            Global origin registration transform for one tile.</span>
<span class=sd>        spacing_zyx_um : ArrayLike</span>
<span class=sd>            Global spacing registration transform for one tile.</span>
<span class=sd>        tile : Union[int, str]</span>
<span class=sd>            Tile index or tile id.</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
            <span class=k>if</span> <span class=n>tile</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>tile</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set tile index &gt;=0 and &lt;=&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>))</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>tile_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>[</span><span class=n>tile</span><span class=p>]</span>
        <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
            <span class=k>if</span> <span class=n>tile</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;set valid tiled id&quot;</span><span class=p>)</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>tile_id</span> <span class=o>=</span> <span class=n>tile</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;tile&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>

        <span class=k>try</span><span class=p>:</span>
            <span class=n>zattrs_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_polyDT_root_path</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_round_ids</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;.zattrs&quot;</span><span class=p>)</span>
            <span class=p>)</span>
            <span class=n>attributes</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_json</span><span class=p>(</span><span class=n>zattrs_path</span><span class=p>)</span>
            <span class=n>attributes</span><span class=p>[</span><span class=s2>&quot;affine_zyx_um&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>affine_zyx_um</span><span class=o>.</span><span class=n>tolist</span><span class=p>()</span>
            <span class=n>attributes</span><span class=p>[</span><span class=s2>&quot;origin_zyx_um&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>origin_zyx_um</span><span class=o>.</span><span class=n>tolist</span><span class=p>()</span>
            <span class=n>attributes</span><span class=p>[</span><span class=s2>&quot;spacing_zyx_um&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>spacing_zyx_um</span><span class=o>.</span><span class=n>tolist</span><span class=p>()</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_save_to_json</span><span class=p>(</span><span class=n>attributes</span><span class=p>,</span> <span class=n>zattrs_path</span><span class=p>)</span>
        <span class=k>except</span> <span class=p>(</span><span class=ne>FileNotFoundError</span><span class=p>,</span> <span class=n>json</span><span class=o>.</span><span class=n>JSONDecodeError</span><span class=p>)</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=n>e</span><span class=p>)</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Could not save global coordinate transforms.&quot;</span><span class=p>)</span>

    <span class=k>def</span> <span class=nf>load_global_fidicual_image</span><span class=p>(</span>
        <span class=bp>self</span><span class=p>,</span>
        <span class=n>return_future</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>bool</span><span class=p>]</span> <span class=o>=</span> <span class=kc>True</span><span class=p>,</span>
    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>tuple</span><span class=p>[</span><span class=n>ArrayLike</span><span class=p>,</span> <span class=n>ArrayLike</span><span class=p>,</span> <span class=n>ArrayLike</span><span class=p>,</span> <span class=n>ArrayLike</span><span class=p>]]:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Load downsampled, fused fidicual image.</span>

<span class=sd>        Parameters</span>
<span class=sd>        ----------</span>
<span class=sd>        return_future : Optional[bool]</span>
<span class=sd>            Return future array.</span>

<span class=sd>        Returns</span>
<span class=sd>        -------</span>
<span class=sd>        fused_image : Optional[ArrayLike]</span>
<span class=sd>            Downsampled, fused fidicual image.</span>
<span class=sd>        affine_zyx_um : Optional[ArrayLike]</span>
<span class=sd>            Global affine registration transform for fused image.</span>
<span class=sd>        origin_zyx_um : Optional[ArrayLike]</span>
<span class=sd>            Global origin registration transform for fused image.</span>
<span class=sd>        spacing_zyx_um : Optional[ArrayLike]</span>
<span class=sd>            Global spacing registration transform for fused image.</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=n>current_local_zarr_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_fused_root_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;fused.zarr&quot;</span><span class=p>)</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;fused_polyDT_iso_zyx&quot;</span><span class=p>)</span>
        <span class=p>)</span>

        <span class=k>if</span> <span class=ow>not</span> <span class=n>Path</span><span class=p>(</span><span class=n>current_local_zarr_path</span><span class=p>)</span><span class=o>.</span><span class=n>exists</span><span class=p>():</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Globally registered, fused image not found.&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>

        <span class=n>zattrs_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span><span class=n>current_local_zarr_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;.zattrs&quot;</span><span class=p>))</span>

        <span class=k>try</span><span class=p>:</span>
            <span class=n>fused_image</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_zarr_array</span><span class=p>(</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_get_kvstore_key</span><span class=p>(</span><span class=n>current_local_zarr_path</span><span class=p>),</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_zarrv2_spec</span><span class=o>.</span><span class=n>copy</span><span class=p>(),</span>
                <span class=n>return_future</span><span class=p>,</span>
            <span class=p>)</span>
            <span class=n>attributes</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_json</span><span class=p>(</span><span class=n>zattrs_path</span><span class=p>)</span>
            <span class=n>affine_zyx_um</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>asarray</span><span class=p>(</span><span class=n>attributes</span><span class=p>[</span><span class=s2>&quot;affine_zyx_um&quot;</span><span class=p>],</span> <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>float32</span><span class=p>)</span>
            <span class=n>origin_zyx_um</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>asarray</span><span class=p>(</span><span class=n>attributes</span><span class=p>[</span><span class=s2>&quot;origin_zyx_um&quot;</span><span class=p>],</span> <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>float32</span><span class=p>)</span>
            <span class=n>spacing_zyx_um</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>asarray</span><span class=p>(</span><span class=n>attributes</span><span class=p>[</span><span class=s2>&quot;spacing_zyx_um&quot;</span><span class=p>],</span> <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>float32</span><span class=p>)</span>
            <span class=k>return</span> <span class=n>fused_image</span><span class=p>,</span> <span class=n>affine_zyx_um</span><span class=p>,</span> <span class=n>origin_zyx_um</span><span class=p>,</span> <span class=n>spacing_zyx_um</span>
        <span class=k>except</span> <span class=p>(</span><span class=ne>IOError</span><span class=p>,</span> <span class=ne>OSError</span><span class=p>,</span> <span class=n>ZarrError</span><span class=p>):</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Error loading globally registered, fused image.&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>

    <span class=k>def</span> <span class=nf>save_global_fidicual_image</span><span class=p>(</span>
        <span class=bp>self</span><span class=p>,</span>
        <span class=n>fused_image</span><span class=p>:</span> <span class=n>ArrayLike</span><span class=p>,</span>
        <span class=n>affine_zyx_um</span><span class=p>:</span> <span class=n>ArrayLike</span><span class=p>,</span>
        <span class=n>origin_zyx_um</span><span class=p>:</span> <span class=n>ArrayLike</span><span class=p>,</span>
        <span class=n>spacing_zyx_um</span><span class=p>:</span> <span class=n>ArrayLike</span><span class=p>,</span>
        <span class=n>fusion_type</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s2>&quot;polyDT&quot;</span><span class=p>,</span>
        <span class=n>return_future</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>bool</span><span class=p>]</span> <span class=o>=</span> <span class=kc>False</span><span class=p>,</span>
    <span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Save downsampled, fused fidicual image.</span>

<span class=sd>        Parameters</span>
<span class=sd>        ----------</span>
<span class=sd>        fused_image : ArrayLike</span>
<span class=sd>            Downsampled, fused fidicual image.</span>
<span class=sd>        affine_zyx_um : ArrayLike</span>
<span class=sd>            Global affine registration transform for fused image.</span>
<span class=sd>        origin_zyx_um : ArrayLike</span>
<span class=sd>            Global origin registration transform for fused image.</span>
<span class=sd>        spacing_zyx_um : ArrayLike</span>
<span class=sd>            Global spacing registration transform for fused image.</span>
<span class=sd>        fusion_type : str</span>
<span class=sd>            Type of fusion (polyDT or all_channels).</span>
<span class=sd>        return_future : Optional[bool]</span>
<span class=sd>            Return future array.</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=k>if</span> <span class=n>fusion_type</span> <span class=o>==</span> <span class=s2>&quot;polyDT&quot;</span><span class=p>:</span>
            <span class=n>filename</span> <span class=o>=</span> <span class=s2>&quot;fused_polyDT_iso_zyx&quot;</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>filename</span> <span class=o>=</span> <span class=s2>&quot;fused_all_channels_zyx&quot;</span>
        <span class=n>current_local_zarr_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_fused_root_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;fused.zarr&quot;</span><span class=p>)</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>filename</span><span class=p>)</span>
        <span class=p>)</span>
        <span class=n>current_local_zattrs_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_fused_root_path</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;fused.zarr&quot;</span><span class=p>)</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>filename</span><span class=p>)</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;.zattrs&quot;</span><span class=p>)</span>
        <span class=p>)</span>

        <span class=n>attributes</span> <span class=o>=</span> <span class=p>{</span>
            <span class=s2>&quot;affine_zyx_um&quot;</span><span class=p>:</span> <span class=n>affine_zyx_um</span><span class=o>.</span><span class=n>tolist</span><span class=p>(),</span>
            <span class=s2>&quot;origin_zyx_um&quot;</span><span class=p>:</span> <span class=n>origin_zyx_um</span><span class=o>.</span><span class=n>tolist</span><span class=p>(),</span>
            <span class=s2>&quot;spacing_zyx_um&quot;</span><span class=p>:</span> <span class=n>spacing_zyx_um</span><span class=o>.</span><span class=n>tolist</span><span class=p>(),</span>
        <span class=p>}</span>
        <span class=k>try</span><span class=p>:</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_save_to_zarr_array</span><span class=p>(</span>
                <span class=n>fused_image</span><span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>uint16</span><span class=p>),</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_get_kvstore_key</span><span class=p>(</span><span class=n>current_local_zarr_path</span><span class=p>),</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_zarrv2_spec</span><span class=o>.</span><span class=n>copy</span><span class=p>(),</span>
                <span class=n>return_future</span><span class=p>,</span>
            <span class=p>)</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_save_to_json</span><span class=p>(</span><span class=n>attributes</span><span class=p>,</span> <span class=n>current_local_zattrs_path</span><span class=p>)</span>
        <span class=k>except</span> <span class=p>(</span><span class=ne>IOError</span><span class=p>,</span> <span class=ne>OSError</span><span class=p>,</span> <span class=ne>TimeoutError</span><span class=p>):</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Error saving fused image.&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>

    <span class=k>def</span> <span class=nf>load_local_decoded_spots</span><span class=p>(</span>
        <span class=bp>self</span><span class=p>,</span>
        <span class=n>tile</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>],</span>
    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>]:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Load decoded spots and features for one tile.</span>

<span class=sd>        Parameters</span>
<span class=sd>        ----------</span>
<span class=sd>        tile : Union[int, str]</span>
<span class=sd>            Tile index or tile id.</span>

<span class=sd>        Returns</span>
<span class=sd>        -------</span>
<span class=sd>        tile_features : Optional[pd.DataFrame]</span>
<span class=sd>            Decoded spots and features for one tile.</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
            <span class=k>if</span> <span class=n>tile</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>tile</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set tile index &gt;=0 and &lt;=&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>))</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>tile_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>[</span><span class=n>tile</span><span class=p>]</span>
        <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
            <span class=k>if</span> <span class=n>tile</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;set valid tiled id&quot;</span><span class=p>)</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>tile_id</span> <span class=o>=</span> <span class=n>tile</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;tile&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>

        <span class=n>current_tile_features_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_decoded_root_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span>
            <span class=n>tile_id</span> <span class=o>+</span> <span class=s2>&quot;_decoded_features.parquet&quot;</span>
        <span class=p>)</span>

        <span class=k>if</span> <span class=ow>not</span> <span class=n>current_tile_features_path</span><span class=o>.</span><span class=n>exists</span><span class=p>():</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Decoded spots not found.&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>tile_features</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_parquet</span><span class=p>(</span><span class=n>current_tile_features_path</span><span class=p>)</span>
            <span class=k>return</span> <span class=n>tile_features</span>

    <span class=k>def</span> <span class=nf>save_local_decoded_spots</span><span class=p>(</span>
        <span class=bp>self</span><span class=p>,</span>
        <span class=n>features_df</span><span class=p>:</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>,</span>
        <span class=n>tile</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>],</span>
    <span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Save decoded spots and features for one tile.</span>

<span class=sd>        Parameters</span>
<span class=sd>        ----------</span>
<span class=sd>        features_df : pd.DataFrame</span>
<span class=sd>            Decoded spots and features for one tile.</span>
<span class=sd>        tile : Union[int, str]</span>
<span class=sd>            Tile index or tile id.</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
            <span class=k>if</span> <span class=n>tile</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>tile</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set tile index &gt;=0 and &lt;=&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>))</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>tile_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>[</span><span class=n>tile</span><span class=p>]</span>
        <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
            <span class=k>if</span> <span class=n>tile</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;set valid tiled id&quot;</span><span class=p>)</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>tile_id</span> <span class=o>=</span> <span class=n>tile</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;tile&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>

        <span class=n>current_tile_features_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_decoded_root_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span>
            <span class=n>tile_id</span> <span class=o>+</span> <span class=s2>&quot;_decoded_features.parquet&quot;</span>
        <span class=p>)</span>

        <span class=bp>self</span><span class=o>.</span><span class=n>_save_to_parquet</span><span class=p>(</span><span class=n>features_df</span><span class=p>,</span> <span class=n>current_tile_features_path</span><span class=p>)</span>

    <span class=k>def</span> <span class=nf>load_global_filtered_decoded_spots</span><span class=p>(</span>
        <span class=bp>self</span><span class=p>,</span>
    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>]:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Load all decoded and filtered spots.</span>

<span class=sd>        Returns</span>
<span class=sd>        -------</span>
<span class=sd>        all_tiles_filtered : Optional[pd.DataFrame]</span>
<span class=sd>            All decoded and filtered spots.</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=n>current_global_filtered_decoded_dir_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span>
            <span class=s2>&quot;all_tiles_filtered_decoded_features&quot;</span>
        <span class=p>)</span>
        <span class=n>current_global_filtered_decoded_path</span> <span class=o>=</span> <span class=p>(</span>
            <span class=n>current_global_filtered_decoded_dir_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;decoded_features.parquet&quot;</span><span class=p>)</span>
        <span class=p>)</span>

        <span class=k>if</span> <span class=ow>not</span> <span class=n>current_global_filtered_decoded_path</span><span class=o>.</span><span class=n>exists</span><span class=p>():</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Global, filtered, decoded spots not found.&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>all_tiles_filtered</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_parquet</span><span class=p>(</span>
                <span class=n>current_global_filtered_decoded_path</span>
            <span class=p>)</span>
            <span class=k>return</span> <span class=n>all_tiles_filtered</span>

    <span class=k>def</span> <span class=nf>save_global_filtered_decoded_spots</span><span class=p>(</span>
        <span class=bp>self</span><span class=p>,</span>
        <span class=n>filtered_decoded_df</span><span class=p>:</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>,</span>
    <span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Save all decoded and filtered spots.</span>

<span class=sd>        Parameters</span>
<span class=sd>        ----------</span>
<span class=sd>        filtered_decoded_df : pd.DataFrame</span>
<span class=sd>            All decoded and filtered spots.</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=n>current_global_filtered_decoded_dir_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span>
            <span class=s2>&quot;all_tiles_filtered_decoded_features&quot;</span>
        <span class=p>)</span>

        <span class=k>if</span> <span class=ow>not</span> <span class=n>current_global_filtered_decoded_dir_path</span><span class=o>.</span><span class=n>exists</span><span class=p>():</span>
            <span class=n>current_global_filtered_decoded_dir_path</span><span class=o>.</span><span class=n>mkdir</span><span class=p>()</span>

        <span class=n>current_global_filtered_decoded_path</span> <span class=o>=</span> <span class=p>(</span>
            <span class=n>current_global_filtered_decoded_dir_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;decoded_features.parquet&quot;</span><span class=p>)</span>
        <span class=p>)</span>

        <span class=bp>self</span><span class=o>.</span><span class=n>_save_to_parquet</span><span class=p>(</span><span class=n>filtered_decoded_df</span><span class=p>,</span> <span class=n>current_global_filtered_decoded_path</span><span class=p>)</span>

    <span class=k>def</span> <span class=nf>load_global_cellpose_outlines</span><span class=p>(</span>
        <span class=bp>self</span><span class=p>,</span>
    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>dict</span><span class=p>]:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Load Cellpose max projection cell outlines.</span>

<span class=sd>        Returns</span>
<span class=sd>        -------</span>
<span class=sd>        cellpose_outlines : Optional[dict]</span>
<span class=sd>            Cellpose cell mask outlines.</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=n>current_cellpose_outlines_path</span> <span class=o>=</span> <span class=p>(</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_segmentation_root_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;cellpose&quot;</span><span class=p>)</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;cell_outlines.json&quot;</span><span class=p>)</span>
        <span class=p>)</span>

        <span class=k>if</span> <span class=ow>not</span> <span class=n>current_cellpose_outlines_path</span><span class=o>.</span><span class=n>exists</span><span class=p>():</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Cellpose cell mask outlines not found.&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>cellpose_outlines</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_microjson</span><span class=p>(</span>
                <span class=n>current_cellpose_outlines_path</span>
            <span class=p>)</span>
            <span class=k>return</span> <span class=n>cellpose_outlines</span>

    <span class=k>def</span> <span class=nf>load_global_cellpose_segmentation_image</span><span class=p>(</span>
        <span class=bp>self</span><span class=p>,</span>
        <span class=n>return_future</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>bool</span><span class=p>]</span> <span class=o>=</span> <span class=kc>True</span><span class=p>,</span>
    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=n>ArrayLike</span><span class=p>]:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Load Cellpose max projection, downsampled segmentation image.</span>

<span class=sd>        Parameters</span>
<span class=sd>        ----------</span>
<span class=sd>        return_future : Optional[bool]</span>
<span class=sd>            Return future array.</span>

<span class=sd>        Returns</span>
<span class=sd>        -------</span>
<span class=sd>        fused_image : Optional[ArrayLike]</span>
<span class=sd>            Cellpose max projection, downsampled segmentation image.</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=n>current_local_zarr_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_segmentation_root_path</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;cellpose&quot;</span><span class=p>)</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;cellpose.zarr&quot;</span><span class=p>)</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;masks_polyDT_iso_zyx&quot;</span><span class=p>)</span>
        <span class=p>)</span>

        <span class=k>if</span> <span class=ow>not</span> <span class=n>current_local_zarr_path</span><span class=o>.</span><span class=n>exists</span><span class=p>():</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Cellpose prediction on global fused image not found.&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>

        <span class=k>try</span><span class=p>:</span>
            <span class=n>fused_image</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_zarr_array</span><span class=p>(</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_get_kvstore_key</span><span class=p>(</span><span class=n>current_local_zarr_path</span><span class=p>),</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_zarrv2_spec</span><span class=o>.</span><span class=n>copy</span><span class=p>(),</span>
                <span class=n>return_future</span><span class=p>,</span>
            <span class=p>)</span>
            <span class=k>return</span> <span class=n>fused_image</span>
        <span class=k>except</span> <span class=p>(</span><span class=ne>IOError</span><span class=p>,</span> <span class=ne>OSError</span><span class=p>,</span> <span class=n>ZarrError</span><span class=p>):</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Error loading Cellpose image.&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>

    <span class=k>def</span> <span class=nf>save_global_cellpose_segmentation_image</span><span class=p>(</span>
        <span class=bp>self</span><span class=p>,</span>
        <span class=n>cellpose_image</span><span class=p>:</span> <span class=n>ArrayLike</span><span class=p>,</span>
        <span class=n>downsampling</span><span class=p>:</span> <span class=n>Sequence</span><span class=p>[</span><span class=nb>float</span><span class=p>],</span>
        <span class=n>return_future</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>bool</span><span class=p>]</span> <span class=o>=</span> <span class=kc>False</span><span class=p>,</span>
    <span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Save Cellpose max projection, downsampled segmentation image.</span>

<span class=sd>        Parameters</span>
<span class=sd>        ----------</span>
<span class=sd>        cellpose_image : ArrayLike</span>
<span class=sd>            Cellpose max projection, downsampled segmentation image.</span>
<span class=sd>        downsampling : Sequence[float]</span>
<span class=sd>            Downsample factors.</span>
<span class=sd>        return_future : Optional[bool]</span>
<span class=sd>            Return future array.</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=n>current_local_zarr_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_segmentation_root_path</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;cellpose&quot;</span><span class=p>)</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;cellpose.zarr&quot;</span><span class=p>)</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;masks_polyDT_iso_zyx&quot;</span><span class=p>)</span>
        <span class=p>)</span>
        <span class=n>current_local_zattrs_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_segmentation_root_path</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;cellpose&quot;</span><span class=p>)</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;cellpose.zarr&quot;</span><span class=p>)</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;masks_polyDT_iso_zyx&quot;</span><span class=p>)</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;.zattrs&quot;</span><span class=p>)</span>
        <span class=p>)</span>

        <span class=n>attributes</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&quot;downsampling&quot;</span><span class=p>:</span> <span class=n>downsampling</span><span class=p>}</span>

        <span class=k>try</span><span class=p>:</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_save_to_zarr_array</span><span class=p>(</span>
                <span class=n>cellpose_image</span><span class=p>,</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_get_kvstore_key</span><span class=p>(</span><span class=n>current_local_zarr_path</span><span class=p>),</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_zarrv2_spec</span><span class=o>.</span><span class=n>copy</span><span class=p>(),</span>
                <span class=n>return_future</span><span class=p>,</span>
            <span class=p>)</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_save_to_json</span><span class=p>(</span><span class=n>attributes</span><span class=p>,</span> <span class=n>current_local_zattrs_path</span><span class=p>)</span>
        <span class=k>except</span> <span class=p>(</span><span class=ne>IOError</span><span class=p>,</span> <span class=ne>OSError</span><span class=p>,</span> <span class=ne>TimeoutError</span><span class=p>):</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Error saving Cellpose image.&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>

    <span class=k>def</span> <span class=nf>save_spots_prepped_for_baysor</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>prepped_for_baysor_df</span><span class=p>:</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Save spots prepped for Baysor.</span>

<span class=sd>        Parameters</span>
<span class=sd>        ----------</span>
<span class=sd>        prepped_for_baysor_df : pd.DataFrame</span>
<span class=sd>            Spots prepped for Baysor.</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=n>current_global_filtered_decoded_dir_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span>
            <span class=s2>&quot;all_tiles_filtered_decoded_features&quot;</span>
        <span class=p>)</span>

        <span class=k>if</span> <span class=ow>not</span> <span class=n>current_global_filtered_decoded_dir_path</span><span class=o>.</span><span class=n>exists</span><span class=p>():</span>
            <span class=n>current_global_filtered_decoded_dir_path</span><span class=o>.</span><span class=n>mkdir</span><span class=p>()</span>

        <span class=n>current_global_filtered_decoded_path</span> <span class=o>=</span> <span class=p>(</span>
            <span class=n>current_global_filtered_decoded_dir_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;transcripts.parquet&quot;</span><span class=p>)</span>
        <span class=p>)</span>

        <span class=bp>self</span><span class=o>.</span><span class=n>_save_to_parquet</span><span class=p>(</span><span class=n>prepped_for_baysor_df</span><span class=p>,</span> <span class=n>current_global_filtered_decoded_path</span><span class=p>)</span>

    <span class=k>def</span> <span class=nf>run_baysor</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Run Baysor&quot;</span>

<span class=sd>        Assumes that spots are prepped for Baysor and the Baysor path and options are set.</span>
<span class=sd>        Reformats ROIs into ImageJ style ROIs for later use.</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=kn>import</span> <span class=nn>subprocess</span>

        <span class=n>baysor_input_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;all_tiles_filtered_decoded_features&quot;</span><span class=p>)</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;transcripts.parquet&quot;</span><span class=p>)</span>
        <span class=n>baysor_output_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_segmentation_root_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;baysor&quot;</span><span class=p>)</span>
        <span class=n>baysor_output_path</span><span class=o>.</span><span class=n>mkdir</span><span class=p>(</span><span class=n>exist_ok</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>

        <span class=n>julia_threading</span> <span class=o>=</span> <span class=sa>r</span><span class=s2>&quot;JULIA_NUM_THREADS=&quot;</span><span class=o>+</span><span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_julia_threads</span><span class=p>)</span><span class=o>+</span> <span class=s2>&quot; &quot;</span>
        <span class=n>preview_baysor_options</span> <span class=o>=</span> <span class=sa>r</span><span class=s2>&quot;preview -c &quot;</span> <span class=o>+</span><span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_baysor_options</span><span class=p>)</span>
        <span class=n>command</span> <span class=o>=</span> <span class=n>julia_threading</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_baysor_path</span><span class=p>)</span> <span class=o>+</span> <span class=s2>&quot; &quot;</span> <span class=o>+</span> <span class=n>preview_baysor_options</span> <span class=o>+</span> <span class=s2>&quot; &quot;</span> <span class=o>+</span>\
            <span class=nb>str</span><span class=p>(</span><span class=n>baysor_input_path</span><span class=p>)</span> <span class=o>+</span> <span class=s2>&quot; -o &quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=n>baysor_output_path</span><span class=p>)</span>

        <span class=k>try</span><span class=p>:</span>
            <span class=n>result</span> <span class=o>=</span> <span class=n>subprocess</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>command</span><span class=p>,</span> <span class=n>shell</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>check</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Baysor finished with return code:&quot;</span><span class=p>,</span> <span class=n>result</span><span class=o>.</span><span class=n>returncode</span><span class=p>)</span>
        <span class=k>except</span> <span class=n>subprocess</span><span class=o>.</span><span class=n>CalledProcessError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Baysor failed with:&quot;</span><span class=p>,</span> <span class=n>e</span><span class=p>)</span>

        <span class=c1># first try to run Baysor assuming that prior segmentations are present               </span>
        <span class=k>try</span><span class=p>:</span>
            <span class=n>run_baysor_options</span> <span class=o>=</span> <span class=sa>r</span><span class=s2>&quot;run -p -c &quot;</span> <span class=o>+</span><span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_baysor_options</span><span class=p>)</span>
            <span class=n>command</span> <span class=o>=</span> <span class=n>julia_threading</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_baysor_path</span><span class=p>)</span> <span class=o>+</span> <span class=s2>&quot; &quot;</span> <span class=o>+</span> <span class=n>run_baysor_options</span> <span class=o>+</span> <span class=s2>&quot; &quot;</span> <span class=o>+</span>\
                <span class=nb>str</span><span class=p>(</span><span class=n>baysor_input_path</span><span class=p>)</span> <span class=o>+</span> <span class=s2>&quot; -o &quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=n>baysor_output_path</span><span class=p>)</span> <span class=o>+</span> \
                <span class=s2>&quot; --polygon-format GeometryCollectionLegacy --count-matrix-format tsv :cell_id&quot;</span>
            <span class=n>result</span> <span class=o>=</span> <span class=n>subprocess</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>command</span><span class=p>,</span> <span class=n>shell</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>check</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Baysor finished with return code:&quot;</span><span class=p>,</span> <span class=n>result</span><span class=o>.</span><span class=n>returncode</span><span class=p>)</span>
        <span class=k>except</span> <span class=n>subprocess</span><span class=o>.</span><span class=n>CalledProcessError</span><span class=p>:</span>
            <span class=c1># then fall back and run without prior segmentations.</span>
            <span class=c1># IMPORTANT: the .toml file has to be defined correctly for this to work!</span>
            <span class=k>try</span><span class=p>:</span>
                <span class=n>run_baysor_options</span> <span class=o>=</span> <span class=sa>r</span><span class=s2>&quot;run -p -c &quot;</span> <span class=o>+</span><span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_baysor_options</span><span class=p>)</span>
                <span class=n>command</span> <span class=o>=</span> <span class=n>julia_threading</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_baysor_path</span><span class=p>)</span> <span class=o>+</span> <span class=s2>&quot; &quot;</span> <span class=o>+</span> <span class=n>run_baysor_options</span> <span class=o>+</span> <span class=s2>&quot; &quot;</span> <span class=o>+</span>\
                    <span class=nb>str</span><span class=p>(</span><span class=n>baysor_input_path</span><span class=p>)</span> <span class=o>+</span> <span class=s2>&quot; -o &quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=n>baysor_output_path</span><span class=p>)</span> <span class=o>+</span> <span class=s2>&quot; --count-matrix-format tsv&quot;</span>
                <span class=n>result</span> <span class=o>=</span> <span class=n>subprocess</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>command</span><span class=p>,</span> <span class=n>shell</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>check</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Baysor finished with return code:&quot;</span><span class=p>,</span> <span class=n>result</span><span class=o>.</span><span class=n>returncode</span><span class=p>)</span>
            <span class=k>except</span> <span class=n>subprocess</span><span class=o>.</span><span class=n>CalledProcessError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Baysor failed with:&quot;</span><span class=p>,</span> <span class=n>e</span><span class=p>)</span>

    <span class=k>def</span> <span class=nf>reformat_baysor_3D_oultines</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Reformat baysor 3D json file into ImageJ ROIs.&quot;&quot;&quot;</span>
        <span class=kn>import</span> <span class=nn>re</span>

        <span class=c1># Load the JSON file</span>
        <span class=n>baysor_output_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_segmentation_root_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;baysor&quot;</span><span class=p>)</span>
        <span class=n>baysor_segmentation</span> <span class=o>=</span> <span class=n>baysor_output_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=sa>r</span><span class=s2>&quot;segmentation_polygons_3d.json&quot;</span><span class=p>)</span>
        <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>baysor_segmentation</span><span class=p>,</span> <span class=s1>&#39;r&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>file</span><span class=p>:</span>
            <span class=n>data</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=n>file</span><span class=p>)</span>


        <span class=c1># Dictionary to group polygons by cell ID</span>
        <span class=n>cell_polygons</span> <span class=o>=</span> <span class=n>defaultdict</span><span class=p>(</span><span class=nb>list</span><span class=p>)</span>

        <span class=k>def</span> <span class=nf>parse_z_range</span><span class=p>(</span><span class=n>z_range</span><span class=p>):</span>
            <span class=n>cleaned_range</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>sub</span><span class=p>(</span><span class=sa>r</span><span class=s2>&quot;[^\d.,-]&quot;</span><span class=p>,</span> <span class=s2>&quot;&quot;</span><span class=p>,</span> <span class=n>z_range</span><span class=p>)</span>  <span class=c1># Remove non-numeric, non-period, non-comma, non-dash characters</span>
            <span class=k>return</span> <span class=nb>map</span><span class=p>(</span><span class=nb>float</span><span class=p>,</span> <span class=n>cleaned_range</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&quot;,&quot;</span><span class=p>))</span>

        <span class=c1># Iterate through each z-plane and corresponding polygons</span>
        <span class=k>for</span> <span class=n>z_range</span><span class=p>,</span> <span class=n>details</span> <span class=ow>in</span> <span class=n>data</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
            <span class=n>z_start</span><span class=p>,</span> <span class=n>z_end</span> <span class=o>=</span> <span class=n>parse_z_range</span><span class=p>(</span><span class=n>z_range</span><span class=p>)</span>

            <span class=k>for</span> <span class=n>geometry</span> <span class=ow>in</span> <span class=n>details</span><span class=p>[</span><span class=s2>&quot;geometries&quot;</span><span class=p>]:</span>
                <span class=n>coordinates</span> <span class=o>=</span> <span class=n>geometry</span><span class=p>[</span><span class=s2>&quot;coordinates&quot;</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span>  <span class=c1># Assuming the outer ring of the polygon</span>
                <span class=n>cell_id</span> <span class=o>=</span> <span class=n>geometry</span><span class=p>[</span><span class=s2>&quot;cell&quot;</span><span class=p>]</span>  <span class=c1># Get the cell ID</span>

                <span class=c1># Store the polygon with its z-range</span>
                <span class=n>cell_polygons</span><span class=p>[</span><span class=n>cell_id</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
                    <span class=s2>&quot;z_start&quot;</span><span class=p>:</span> <span class=n>z_start</span><span class=p>,</span>
                    <span class=s2>&quot;z_end&quot;</span><span class=p>:</span> <span class=n>z_end</span><span class=p>,</span>
                    <span class=s2>&quot;coordinates&quot;</span><span class=p>:</span> <span class=n>coordinates</span>
                <span class=p>})</span>

        <span class=n>rois</span> <span class=o>=</span> <span class=p>[]</span>

        <span class=c1># Process each cell ID to create 3D ROIs</span>
        <span class=k>for</span> <span class=n>cell_id</span><span class=p>,</span> <span class=n>polygons</span> <span class=ow>in</span> <span class=n>cell_polygons</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
            <span class=k>for</span> <span class=n>idx</span><span class=p>,</span> <span class=n>polygon</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>polygons</span><span class=p>):</span>
                <span class=n>x_coords</span> <span class=o>=</span> <span class=p>[</span><span class=n>point</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=k>for</span> <span class=n>point</span> <span class=ow>in</span> <span class=n>polygon</span><span class=p>[</span><span class=s2>&quot;coordinates&quot;</span><span class=p>]]</span>
                <span class=n>y_coords</span> <span class=o>=</span> <span class=p>[</span><span class=n>point</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=k>for</span> <span class=n>point</span> <span class=ow>in</span> <span class=n>polygon</span><span class=p>[</span><span class=s2>&quot;coordinates&quot;</span><span class=p>]]</span>


                <span class=n>z_start</span> <span class=o>=</span> <span class=n>polygon</span><span class=p>[</span><span class=s2>&quot;z_start&quot;</span><span class=p>]</span>
                <span class=n>z_end</span> <span class=o>=</span> <span class=n>polygon</span><span class=p>[</span><span class=s2>&quot;z_end&quot;</span><span class=p>]</span>

                <span class=k>try</span><span class=p>:</span>
                    <span class=c1># Create an ImageJRoi object for the polygon using frompoints</span>
                    <span class=n>coords</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=nb>zip</span><span class=p>(</span><span class=n>x_coords</span><span class=p>,</span> <span class=n>y_coords</span><span class=p>))</span>  <span class=c1># List of (x, y) tuples</span>
                    <span class=n>roi</span> <span class=o>=</span> <span class=n>ImagejRoi</span><span class=o>.</span><span class=n>frompoints</span><span class=p>(</span><span class=n>coords</span><span class=p>)</span>
                    <span class=n>roi</span><span class=o>.</span><span class=n>roitype</span> <span class=o>=</span> <span class=n>ROI_TYPE</span><span class=o>.</span><span class=n>POLYGON</span>  <span class=c1># Set the ROI type to Polygon</span>
                    <span class=n>roi</span><span class=o>.</span><span class=n>coordinates</span> <span class=o>=</span> <span class=n>coords</span>  <span class=c1># Explicitly assign coordinates to the ROI</span>
                    <span class=n>roi</span><span class=o>.</span><span class=n>name</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&quot;cell_</span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>cell_id</span><span class=p>)</span><span class=si>}</span><span class=s2>_zstart_</span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>z_start</span><span class=p>)</span><span class=si>}</span><span class=s2>_zend_</span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>z_end</span><span class=p>)</span><span class=si>}</span><span class=s2>&quot;</span>  <span class=c1># Ensure unique name</span>
                    <span class=n>rois</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>roi</span><span class=p>)</span>
                <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
                    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Error while creating ROI for cell ID </span><span class=si>{</span><span class=n>cell_id</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

        <span class=c1># Write all ROIs to a ZIP file   </span>
        <span class=n>output_file</span> <span class=o>=</span> <span class=n>baysor_output_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=sa>r</span><span class=s2>&quot;3d_cell_rois.zip&quot;</span><span class=p>)</span>
        <span class=n>roiwrite</span><span class=p>(</span><span class=n>output_file</span><span class=p>,</span> <span class=n>rois</span><span class=p>,</span><span class=n>mode</span><span class=o>=</span><span class=s1>&#39;w&#39;</span><span class=p>)</span>

    <span class=k>def</span> <span class=nf>load_global_baysor_filtered_spots</span><span class=p>(</span>
        <span class=bp>self</span><span class=p>,</span>
    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>]:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Load Baysor re-assigned decoded RNA.</span>

<span class=sd>        Assumes Baysor has been run.</span>

<span class=sd>        Returns</span>
<span class=sd>        -------</span>
<span class=sd>        baysor_filtered_genes : Optional[pd.DataFrame]</span>
<span class=sd>            Baysor re-assigned decoded RNA.</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=n>current_baysor_spots_path</span> <span class=o>=</span> <span class=p>(</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_segmentation_root_path</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;baysor&quot;</span><span class=p>)</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;segmentation.csv&quot;</span><span class=p>)</span>
        <span class=p>)</span>

        <span class=k>if</span> <span class=ow>not</span> <span class=n>current_baysor_spots_path</span><span class=o>.</span><span class=n>exists</span><span class=p>():</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Baysor filtered genes not found.&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>baysor_filtered_genes</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_csv</span><span class=p>(</span><span class=n>current_baysor_spots_path</span><span class=p>)</span>
            <span class=k>return</span> <span class=n>baysor_filtered_genes</span>

    <span class=k>def</span> <span class=nf>load_global_baysor_outlines</span><span class=p>(</span>
        <span class=bp>self</span><span class=p>,</span>
    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>dict</span><span class=p>]:</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Load Baysor cell outlines.</span>

<span class=sd>        Assumes Baysor has been run.</span>

<span class=sd>        Returns</span>
<span class=sd>        -------</span>
<span class=sd>        baysor_outlines : Optional[dict]</span>
<span class=sd>            Baysor cell outlines.</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=n>current_baysor_outlines_path</span> <span class=o>=</span> <span class=p>(</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_segmentation_root_path</span> 
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;baysor&quot;</span><span class=p>)</span> 
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=sa>r</span><span class=s2>&quot;3d_cell_rois.zip&quot;</span><span class=p>)</span>
        <span class=p>)</span>

        <span class=k>if</span> <span class=ow>not</span> <span class=n>current_baysor_outlines_path</span><span class=o>.</span><span class=n>exists</span><span class=p>():</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Baysor outlines not found.&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>baysor_rois</span> <span class=o>=</span> <span class=n>roiread</span><span class=p>(</span><span class=n>current_baysor_outlines_path</span><span class=p>)</span>
            <span class=k>return</span> <span class=n>baysor_rois</span>

    <span class=nd>@staticmethod</span>
    <span class=k>def</span> <span class=nf>_roi_to_shapely</span><span class=p>(</span><span class=n>roi</span><span class=p>):</span>
        <span class=k>return</span> <span class=n>Polygon</span><span class=p>(</span><span class=n>roi</span><span class=o>.</span><span class=n>subpixel_coordinates</span><span class=p>[:,</span> <span class=p>::</span><span class=o>-</span><span class=mi>1</span><span class=p>])</span>

    <span class=k>def</span> <span class=nf>reprocess_and_save_filtered_spots_with_baysor_outlines</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Reprocess filtered spots using baysor cell outlines, then save.</span>

<span class=sd>        Loads the 3D cell outlines from Baysor, checks all points to see what </span>
<span class=sd>        (if any) cell outline that the spot falls within, and then saves the</span>
<span class=sd>        data back to the datastore.</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=kn>from</span> <span class=nn>rtree</span> <span class=kn>import</span> <span class=n>index</span>
        <span class=kn>import</span> <span class=nn>re</span>

        <span class=n>rois</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>load_global_baysor_outlines</span><span class=p>()</span>
        <span class=n>filtered_spots_df</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>load_global_filtered_decoded_spots</span><span class=p>()</span>

        <span class=n>parsed_spots_df</span> <span class=o>=</span> <span class=n>filtered_spots_df</span><span class=p>[</span>
                <span class=p>[</span>
                    <span class=s2>&quot;gene_id&quot;</span><span class=p>,</span>
                    <span class=s2>&quot;global_z&quot;</span><span class=p>,</span>
                    <span class=s2>&quot;global_y&quot;</span><span class=p>,</span>
                    <span class=s2>&quot;global_x&quot;</span><span class=p>,</span>
                    <span class=s2>&quot;cell_id&quot;</span><span class=p>,</span>
                    <span class=s2>&quot;tile_idx&quot;</span><span class=p>,</span>
                <span class=p>]</span>
        <span class=p>]</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>
        <span class=n>parsed_spots_df</span><span class=o>.</span><span class=n>rename</span><span class=p>(</span>
            <span class=n>columns</span><span class=o>=</span><span class=p>{</span>
                <span class=s2>&quot;global_x&quot;</span><span class=p>:</span> <span class=s2>&quot;x&quot;</span><span class=p>,</span>
                <span class=s2>&quot;global_y&quot;</span><span class=p>:</span> <span class=s2>&quot;y&quot;</span><span class=p>,</span>
                <span class=s2>&quot;global_z&quot;</span><span class=p>:</span> <span class=s2>&quot;z&quot;</span><span class=p>,</span>
                <span class=s2>&quot;gene_id&quot;</span> <span class=p>:</span> <span class=s2>&quot;gene&quot;</span><span class=p>,</span>
                <span class=s2>&quot;cell_id&quot;</span> <span class=p>:</span> <span class=s2>&quot;cell&quot;</span><span class=p>,</span>
            <span class=p>},</span>
            <span class=n>inplace</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
        <span class=p>)</span>
        <span class=n>parsed_spots_df</span><span class=p>[</span><span class=s2>&quot;transcript_id&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>util</span><span class=o>.</span><span class=n>hash_pandas_object</span><span class=p>(</span>
            <span class=n>parsed_spots_df</span><span class=p>,</span> <span class=n>index</span><span class=o>=</span><span class=kc>False</span>
        <span class=p>)</span>

        <span class=n>parsed_spots_df</span><span class=p>[</span><span class=s2>&quot;assignment_confidence&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=mf>1.0</span>

        <span class=c1># Create spatial index for ROIs</span>
        <span class=n>roi_index</span> <span class=o>=</span> <span class=n>index</span><span class=o>.</span><span class=n>Index</span><span class=p>()</span>
        <span class=n>roi_map</span> <span class=o>=</span> <span class=p>{}</span>  <span class=c1># Map index IDs to ROIs</span>

        <span class=k>for</span> <span class=n>idx</span><span class=p>,</span> <span class=n>roi</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>rois</span><span class=p>):</span>
            <span class=c1># Ensure roi.coordinates contains the polygon points</span>
            <span class=n>coords</span> <span class=o>=</span> <span class=n>roi</span><span class=o>.</span><span class=n>coordinates</span><span class=p>()</span>

            <span class=c1># Insert the polygon bounds into the spatial index</span>
            <span class=n>polygon</span> <span class=o>=</span> <span class=n>Polygon</span><span class=p>(</span><span class=n>coords</span><span class=p>)</span>
            <span class=n>roi_index</span><span class=o>.</span><span class=n>insert</span><span class=p>(</span><span class=n>idx</span><span class=p>,</span> <span class=n>polygon</span><span class=o>.</span><span class=n>bounds</span><span class=p>)</span>  <span class=c1># Use polygon bounds for indexing</span>
            <span class=n>roi_map</span><span class=p>[</span><span class=n>idx</span><span class=p>]</span> <span class=o>=</span> <span class=n>roi</span>

        <span class=c1># Function to check a single point</span>
        <span class=k>def</span> <span class=nf>point_in_roi</span><span class=p>(</span><span class=n>row</span><span class=p>):</span>
            <span class=n>point</span> <span class=o>=</span> <span class=n>Point</span><span class=p>(</span><span class=n>row</span><span class=p>[</span><span class=s2>&quot;x&quot;</span><span class=p>],</span> <span class=n>row</span><span class=p>[</span><span class=s2>&quot;y&quot;</span><span class=p>])</span>
            <span class=n>candidate_indices</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=n>roi_index</span><span class=o>.</span><span class=n>intersection</span><span class=p>(</span><span class=n>point</span><span class=o>.</span><span class=n>bounds</span><span class=p>))</span>  <span class=c1># Search spatial index</span>
            <span class=k>for</span> <span class=n>idx</span> <span class=ow>in</span> <span class=n>candidate_indices</span><span class=p>:</span>
                <span class=n>roi</span> <span class=o>=</span> <span class=n>roi_map</span><span class=p>[</span><span class=n>idx</span><span class=p>]</span>
                <span class=n>match</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>search</span><span class=p>(</span><span class=sa>r</span><span class=s2>&quot;zstart_([-\d.]+)_zend_([-\d.]+)&quot;</span><span class=p>,</span> <span class=n>roi</span><span class=o>.</span><span class=n>name</span><span class=p>)</span>
                <span class=k>if</span> <span class=n>match</span><span class=p>:</span>
                    <span class=n>z_start</span> <span class=o>=</span> <span class=nb>float</span><span class=p>(</span><span class=n>match</span><span class=o>.</span><span class=n>group</span><span class=p>(</span><span class=mi>1</span><span class=p>))</span>
                    <span class=n>z_end</span> <span class=o>=</span> <span class=nb>float</span><span class=p>(</span><span class=n>match</span><span class=o>.</span><span class=n>group</span><span class=p>(</span><span class=mi>2</span><span class=p>))</span>
                    <span class=k>if</span> <span class=n>z_start</span> <span class=o>&lt;=</span> <span class=n>row</span><span class=p>[</span><span class=s2>&quot;z&quot;</span><span class=p>]</span> <span class=o>&lt;=</span> <span class=n>z_end</span><span class=p>:</span>
                        <span class=n>polygon</span> <span class=o>=</span> <span class=n>Polygon</span><span class=p>(</span><span class=n>roi</span><span class=o>.</span><span class=n>coordinates</span><span class=p>())</span>
                        <span class=k>if</span> <span class=n>polygon</span><span class=o>.</span><span class=n>contains</span><span class=p>(</span><span class=n>point</span><span class=p>):</span>
                            <span class=k>return</span> <span class=nb>str</span><span class=p>(</span><span class=n>roi</span><span class=o>.</span><span class=n>name</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&quot;_&quot;</span><span class=p>)[</span><span class=mi>1</span><span class=p>])</span> 
            <span class=k>return</span> <span class=o>-</span><span class=mi>1</span>

        <span class=c1># Apply optimized spatial lookup</span>
        <span class=n>parsed_spots_df</span><span class=p>[</span><span class=s2>&quot;cell&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>parsed_spots_df</span><span class=o>.</span><span class=n>apply</span><span class=p>(</span><span class=n>point_in_roi</span><span class=p>,</span> <span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
        <span class=n>parsed_spots_df</span> <span class=o>=</span> <span class=n>parsed_spots_df</span><span class=o>.</span><span class=n>loc</span><span class=p>[</span><span class=n>parsed_spots_df</span><span class=p>[</span><span class=s2>&quot;cell&quot;</span><span class=p>]</span> <span class=o>!=</span> <span class=o>-</span><span class=mi>1</span><span class=p>]</span>

        <span class=n>current_global_filtered_decoded_path</span> <span class=o>=</span> <span class=p>(</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_path</span> 
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;all_tiles_filtered_decoded_features&quot;</span><span class=p>)</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;refined_transcripts.parquet&quot;</span><span class=p>)</span>
        <span class=p>)</span>

        <span class=bp>self</span><span class=o>.</span><span class=n>_save_to_parquet</span><span class=p>(</span><span class=n>parsed_spots_df</span><span class=p>,</span> <span class=n>current_global_filtered_decoded_path</span><span class=p>)</span>

    <span class=k>def</span> <span class=nf>save_mtx</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>spots_source</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s2>&quot;&quot;</span><span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Save mtx file for downstream analysis. Assumes Baysor has been run.</span>

<span class=sd>        Parameters</span>
<span class=sd>        ----------</span>
<span class=sd>        spots_source: str, default &quot;baysor&quot;</span>
<span class=sd>            source of spots. &quot;baysor&quot; or &quot;resegmented&quot;.</span>
<span class=sd>        &quot;&quot;&quot;</span>

        <span class=kn>from</span> <span class=nn>merfish3danalysis.utils.dataio</span> <span class=kn>import</span> <span class=n>create_mtx</span>

        <span class=k>if</span> <span class=n>spots_source</span> <span class=o>==</span> <span class=s2>&quot;baysor&quot;</span><span class=p>:</span>
            <span class=n>spots_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;segmentation&quot;</span><span class=p>)</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;baysor&quot;</span><span class=p>)</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;segmentation.csv&quot;</span><span class=p>)</span>
        <span class=k>elif</span> <span class=n>spots_source</span> <span class=o>==</span> <span class=s2>&quot;resegmented&quot;</span><span class=p>:</span>
            <span class=n>spots_path</span> <span class=o>=</span> <span class=p>(</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_path</span> 
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;all_tiles_filtered_decoded_features&quot;</span><span class=p>)</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;refined_transcripts.parquet&quot;</span><span class=p>)</span>
            <span class=p>)</span>

        <span class=n>mtx_output_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;mtx_output&quot;</span><span class=p>)</span>

        <span class=n>create_mtx</span><span class=p>(</span>
            <span class=n>spots_path</span><span class=o>=</span><span class=n>spots_path</span><span class=p>,</span>
            <span class=n>output_dir_path</span><span class=o>=</span><span class=n>mtx_output_path</span><span class=p>,</span>
        <span class=p>)</span>
</code></pre></div></td></tr></table></div> </details> <div class="doc doc-children"> <div class="doc doc-object doc-attribute"> <h3 id=merfish3danalysis.qi2labDataStore.qi2labDataStore.baysor_options class="doc doc-heading"> <code class="highlight language-python"><span class=n>baysor_options</span></code> <span class="doc doc-labels"> <small class="doc doc-label doc-label-property"><code>property</code></small> <small class="doc doc-label doc-label-writable"><code>writable</code></small> </span> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.baysor_options class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-contents "> <p>Baysor options</p> <p><span class=doc-section-title>Returns:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td><code>baysor_options</code></td> <td> <code><span title="typing.Union">Union</span>[<span title="pathlib.Path">Path</span>, str]</code> </td> <td> <div class=doc-md-description> <p>Baysor options.</p> </div> </td> </tr> </tbody> </table> </div> </div> <div class="doc doc-object doc-attribute"> <h3 id=merfish3danalysis.qi2labDataStore.qi2labDataStore.baysor_path class="doc doc-heading"> <code class="highlight language-python"><span class=n>baysor_path</span></code> <span class="doc doc-labels"> <small class="doc doc-label doc-label-property"><code>property</code></small> <small class="doc doc-label doc-label-writable"><code>writable</code></small> </span> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.baysor_path class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-contents "> <p>Baysor path</p> <p><span class=doc-section-title>Returns:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td><code>baysor_path</code></td> <td> <code><span title="typing.Union">Union</span>[<span title="pathlib.Path">Path</span>, str]</code> </td> <td> <div class=doc-md-description> <p>Baysor path.</p> </div> </td> </tr> </tbody> </table> </div> </div> <div class="doc doc-object doc-attribute"> <h3 id=merfish3danalysis.qi2labDataStore.qi2labDataStore.binning class="doc doc-heading"> <code class="highlight language-python"><span class=n>binning</span></code> <span class="doc doc-labels"> <small class="doc doc-label doc-label-property"><code>property</code></small> <small class="doc doc-label doc-label-writable"><code>writable</code></small> </span> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.binning class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-contents "> <p>Camera binning.</p> <p><span class=doc-section-title>Returns:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td><code>binning</code></td> <td> <code>int</code> </td> <td> <div class=doc-md-description> <p>Camera binning.</p> </div> </td> </tr> </tbody> </table> </div> </div> <div class="doc doc-object doc-attribute"> <h3 id=merfish3danalysis.qi2labDataStore.qi2labDataStore.bit_ids class="doc doc-heading"> <code class="highlight language-python"><span class=n>bit_ids</span></code> <span class="doc doc-labels"> <small class="doc doc-label doc-label-property"><code>property</code></small> </span> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.bit_ids class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-contents "> <p>Bit IDs.</p> <p><span class=doc-section-title>Returns:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td><code>bit_ids</code></td> <td> <code><span title="typing.Collection">Collection</span>[str]</code> </td> <td> <div class=doc-md-description> <p>Bit IDs.</p> </div> </td> </tr> </tbody> </table> </div> </div> <div class="doc doc-object doc-attribute"> <h3 id=merfish3danalysis.qi2labDataStore.qi2labDataStore.camera_model class="doc doc-heading"> <code class="highlight language-python"><span class=n>camera_model</span></code> <span class="doc doc-labels"> <small class="doc doc-label doc-label-property"><code>property</code></small> <small class="doc doc-label doc-label-writable"><code>writable</code></small> </span> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.camera_model class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-contents "> <p>Camera model.</p> <p><span class=doc-section-title>Returns:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td><code>camera_model</code></td> <td> <code><span title="typing.Optional">Optional</span>[str]</code> </td> <td> <div class=doc-md-description> <p>Camera model.</p> </div> </td> </tr> </tbody> </table> </div> </div> <div class="doc doc-object doc-attribute"> <h3 id=merfish3danalysis.qi2labDataStore.qi2labDataStore.channel_psfs class="doc doc-heading"> <code class="highlight language-python"><span class=n>channel_psfs</span></code> <span class="doc doc-labels"> <small class="doc doc-label doc-label-property"><code>property</code></small> <small class="doc doc-label doc-label-writable"><code>writable</code></small> </span> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.channel_psfs class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-contents "> <p>Channel point spread functions (PSF).</p> <details class=return open> <summary>Return</summary> <p>channel_psfs : ArrayLike Channel point spread functions (PSF).</p> </details> </div> </div> <div class="doc doc-object doc-attribute"> <h3 id=merfish3danalysis.qi2labDataStore.qi2labDataStore.channel_shading_maps class="doc doc-heading"> <code class="highlight language-python"><span class=n>channel_shading_maps</span></code> <span class="doc doc-labels"> <small class="doc doc-label doc-label-property"><code>property</code></small> <small class="doc doc-label doc-label-writable"><code>writable</code></small> </span> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.channel_shading_maps class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-contents "> <p>Channel shaiding images.</p> <p><span class=doc-section-title>Returns:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td><code>channel_shading_maps</code></td> <td> <code><span title="numpy.typing.ArrayLike">ArrayLike</span></code> </td> <td> <div class=doc-md-description> <p>Channel shading images.</p> </div> </td> </tr> </tbody> </table> </div> </div> <div class="doc doc-object doc-attribute"> <h3 id=merfish3danalysis.qi2labDataStore.qi2labDataStore.channels_in_data class="doc doc-heading"> <code class="highlight language-python"><span class=n>channels_in_data</span></code> <span class="doc doc-labels"> <small class="doc doc-label doc-label-property"><code>property</code></small> <small class="doc doc-label doc-label-writable"><code>writable</code></small> </span> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.channels_in_data class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-contents "> <p>Channel indices.</p> <p><span class=doc-section-title>Returns:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td><code>channels_in_data</code></td> <td> <code><span title="typing.Collection">Collection</span>[int]</code> </td> <td> <div class=doc-md-description> <p>Channel indices.</p> </div> </td> </tr> </tbody> </table> </div> </div> <div class="doc doc-object doc-attribute"> <h3 id=merfish3danalysis.qi2labDataStore.qi2labDataStore.codebook class="doc doc-heading"> <code class="highlight language-python"><span class=n>codebook</span></code> <span class="doc doc-labels"> <small class="doc doc-label doc-label-property"><code>property</code></small> <small class="doc doc-label doc-label-writable"><code>writable</code></small> </span> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.codebook class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-contents "> <p>Codebook.</p> <p><span class=doc-section-title>Returns:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td><code>codebook</code></td> <td> <code><span title="pandas.DataFrame">DataFrame</span></code> </td> <td> <div class=doc-md-description> <p>Codebook.</p> </div> </td> </tr> </tbody> </table> </div> </div> <div class="doc doc-object doc-attribute"> <h3 id=merfish3danalysis.qi2labDataStore.qi2labDataStore.datastore_state class="doc doc-heading"> <code class="highlight language-python"><span class=n>datastore_state</span></code> <span class="doc doc-labels"> <small class="doc doc-label doc-label-property"><code>property</code></small> <small class="doc doc-label doc-label-writable"><code>writable</code></small> </span> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.datastore_state class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-contents "> <p>Datastore state.</p> <p><span class=doc-section-title>Returns:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td><code>datastore_state</code></td> <td> <code><span title="typing.Optional">Optional</span>[dict]</code> </td> <td> <div class=doc-md-description> <p>Datastore state.</p> </div> </td> </tr> </tbody> </table> </div> </div> <div class="doc doc-object doc-attribute"> <h3 id=merfish3danalysis.qi2labDataStore.qi2labDataStore.e_per_ADU class="doc doc-heading"> <code class="highlight language-python"><span class=n>e_per_ADU</span></code> <span class="doc doc-labels"> <small class="doc doc-label doc-label-property"><code>property</code></small> <small class="doc doc-label doc-label-writable"><code>writable</code></small> </span> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.e_per_ADU class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-contents "> <p>Electrons per camera ADU.</p> <p><span class=doc-section-title>Returns:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td><code>e_per_ADU</code></td> <td> <code>float</code> </td> <td> <div class=doc-md-description> <p>Electrons per camera ADU.</p> </div> </td> </tr> </tbody> </table> </div> </div> <div class="doc doc-object doc-attribute"> <h3 id=merfish3danalysis.qi2labDataStore.qi2labDataStore.experiment_order class="doc doc-heading"> <code class="highlight language-python"><span class=n>experiment_order</span></code> <span class="doc doc-labels"> <small class="doc doc-label doc-label-property"><code>property</code></small> <small class="doc doc-label doc-label-writable"><code>writable</code></small> </span> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.experiment_order class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-contents "> <p>Round and bit order.</p> <p><span class=doc-section-title>Returns:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td><code>experiment_order</code></td> <td> <code><span title="pandas.DataFrame">DataFrame</span></code> </td> <td> <div class=doc-md-description> <p>Round and bit order.</p> </div> </td> </tr> </tbody> </table> </div> </div> <div class="doc doc-object doc-attribute"> <h3 id=merfish3danalysis.qi2labDataStore.qi2labDataStore.global_background_vector class="doc doc-heading"> <code class="highlight language-python"><span class=n>global_background_vector</span></code> <span class="doc doc-labels"> <small class="doc doc-label doc-label-property"><code>property</code></small> <small class="doc doc-label doc-label-writable"><code>writable</code></small> </span> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.global_background_vector class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-contents "> <p>Global background vector.</p> <p><span class=doc-section-title>Returns:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td><code>global_background_vector</code></td> <td> <code><span title="numpy.typing.ArrayLike">ArrayLike</span></code> </td> <td> <div class=doc-md-description> <p>Global background vector.</p> </div> </td> </tr> </tbody> </table> </div> </div> <div class="doc doc-object doc-attribute"> <h3 id=merfish3danalysis.qi2labDataStore.qi2labDataStore.global_normalization_vector class="doc doc-heading"> <code class="highlight language-python"><span class=n>global_normalization_vector</span></code> <span class="doc doc-labels"> <small class="doc doc-label doc-label-property"><code>property</code></small> <small class="doc doc-label doc-label-writable"><code>writable</code></small> </span> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.global_normalization_vector class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-contents "> <p>Global normalization vector.</p> <p><span class=doc-section-title>Returns:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td><code>global_normalization_vector</code></td> <td> <code><span title="numpy.typing.ArrayLike">ArrayLike</span></code> </td> <td> <div class=doc-md-description> <p>Global normalization vector.</p> </div> </td> </tr> </tbody> </table> </div> </div> <div class="doc doc-object doc-attribute"> <h3 id=merfish3danalysis.qi2labDataStore.qi2labDataStore.iterative_background_vector class="doc doc-heading"> <code class="highlight language-python"><span class=n>iterative_background_vector</span></code> <span class="doc doc-labels"> <small class="doc doc-label doc-label-property"><code>property</code></small> <small class="doc doc-label doc-label-writable"><code>writable</code></small> </span> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.iterative_background_vector class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-contents "> <p>Iterative background vector.</p> <p><span class=doc-section-title>Returns:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td><code>iterative_background_vector</code></td> <td> <code><span title="numpy.typing.ArrayLike">ArrayLike</span></code> </td> <td> <div class=doc-md-description> <p>Iterative background vector.</p> </div> </td> </tr> </tbody> </table> </div> </div> <div class="doc doc-object doc-attribute"> <h3 id=merfish3danalysis.qi2labDataStore.qi2labDataStore.iterative_normalization_vector class="doc doc-heading"> <code class="highlight language-python"><span class=n>iterative_normalization_vector</span></code> <span class="doc doc-labels"> <small class="doc doc-label doc-label-property"><code>property</code></small> <small class="doc doc-label doc-label-writable"><code>writable</code></small> </span> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.iterative_normalization_vector class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-contents "> <p>Iterative normalization vector.</p> <p><span class=doc-section-title>Returns:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td><code>iterative_normalization_vector</code></td> <td> <code><span title="numpy.typing.ArrayLike">ArrayLike</span></code> </td> <td> <div class=doc-md-description> <p>Iterative normalization vector.</p> </div> </td> </tr> </tbody> </table> </div> </div> <div class="doc doc-object doc-attribute"> <h3 id=merfish3danalysis.qi2labDataStore.qi2labDataStore.julia_threads class="doc doc-heading"> <code class="highlight language-python"><span class=n>julia_threads</span></code> <span class="doc doc-labels"> <small class="doc doc-label doc-label-property"><code>property</code></small> <small class="doc doc-label doc-label-writable"><code>writable</code></small> </span> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.julia_threads class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-contents "> <p>Julia thread number</p> <p><span class=doc-section-title>Returns:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td><code>julia_threads</code></td> <td> <code>int</code> </td> <td> <div class=doc-md-description> <p>Julia thread number.</p> </div> </td> </tr> </tbody> </table> </div> </div> <div class="doc doc-object doc-attribute"> <h3 id=merfish3danalysis.qi2labDataStore.qi2labDataStore.microscope_type class="doc doc-heading"> <code class="highlight language-python"><span class=n>microscope_type</span></code> <span class="doc doc-labels"> <small class="doc doc-label doc-label-property"><code>property</code></small> <small class="doc doc-label doc-label-writable"><code>writable</code></small> </span> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.microscope_type class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-contents "> <p>Microscope type.</p> <p><span class=doc-section-title>Returns:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td><code>microscope_type</code></td> <td> <code><span title="typing.Optional">Optional</span>[str]</code> </td> <td> <div class=doc-md-description> <p>Microscope type.</p> </div> </td> </tr> </tbody> </table> </div> </div> <div class="doc doc-object doc-attribute"> <h3 id=merfish3danalysis.qi2labDataStore.qi2labDataStore.na class="doc doc-heading"> <code class="highlight language-python"><span class=n>na</span></code> <span class="doc doc-labels"> <small class="doc doc-label doc-label-property"><code>property</code></small> <small class="doc doc-label doc-label-writable"><code>writable</code></small> </span> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.na class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-contents "> <p>Detection objective numerical aperture (NA).</p> <p><span class=doc-section-title>Returns:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td><code>na</code></td> <td> <code>float</code> </td> <td> <div class=doc-md-description> <p>Detection objective numerical aperture (NA).</p> </div> </td> </tr> </tbody> </table> </div> </div> <div class="doc doc-object doc-attribute"> <h3 id=merfish3danalysis.qi2labDataStore.qi2labDataStore.noise_map class="doc doc-heading"> <code class="highlight language-python"><span class=n>noise_map</span></code> <span class="doc doc-labels"> <small class="doc doc-label doc-label-property"><code>property</code></small> <small class="doc doc-label doc-label-writable"><code>writable</code></small> </span> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.noise_map class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-contents "> <p>Camera noise image.</p> <p><span class=doc-section-title>Returns:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td><code>noise_map</code></td> <td> <code><span title="numpy.typing.ArrayLike">ArrayLike</span></code> </td> <td> <div class=doc-md-description> <p>Camera noise image.</p> </div> </td> </tr> </tbody> </table> </div> </div> <div class="doc doc-object doc-attribute"> <h3 id=merfish3danalysis.qi2labDataStore.qi2labDataStore.num_bits class="doc doc-heading"> <code class="highlight language-python"><span class=n>num_bits</span></code> <span class="doc doc-labels"> <small class="doc doc-label doc-label-property"><code>property</code></small> </span> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.num_bits class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-contents "> <p>Number of bits.</p> <p><span class=doc-section-title>Returns:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td><code>num_bits</code></td> <td> <code>int</code> </td> <td> <div class=doc-md-description> <p>Number of bits.</p> </div> </td> </tr> </tbody> </table> </div> </div> <div class="doc doc-object doc-attribute"> <h3 id=merfish3danalysis.qi2labDataStore.qi2labDataStore.num_rounds class="doc doc-heading"> <code class="highlight language-python"><span class=n>num_rounds</span></code> <span class="doc doc-labels"> <small class="doc doc-label doc-label-property"><code>property</code></small> <small class="doc doc-label doc-label-writable"><code>writable</code></small> </span> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.num_rounds class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-contents "> <p>Number of rounds.</p> <p><span class=doc-section-title>Returns:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td><code>num_rounds</code></td> <td> <code>int</code> </td> <td> <div class=doc-md-description> <p>Number of rounds.</p> </div> </td> </tr> </tbody> </table> </div> </div> <div class="doc doc-object doc-attribute"> <h3 id=merfish3danalysis.qi2labDataStore.qi2labDataStore.num_tiles class="doc doc-heading"> <code class="highlight language-python"><span class=n>num_tiles</span></code> <span class="doc doc-labels"> <small class="doc doc-label doc-label-property"><code>property</code></small> <small class="doc doc-label doc-label-writable"><code>writable</code></small> </span> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.num_tiles class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-contents "> <p>Number of tiles.</p> <p><span class=doc-section-title>Returns:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td><code>num_tiles</code></td> <td> <code>int</code> </td> <td> <div class=doc-md-description> <p>Number of tiles.</p> </div> </td> </tr> </tbody> </table> </div> </div> <div class="doc doc-object doc-attribute"> <h3 id=merfish3danalysis.qi2labDataStore.qi2labDataStore.ri class="doc doc-heading"> <code class="highlight language-python"><span class=n>ri</span></code> <span class="doc doc-labels"> <small class="doc doc-label doc-label-property"><code>property</code></small> <small class="doc doc-label doc-label-writable"><code>writable</code></small> </span> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.ri class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-contents "> <p>Detection objective refractive index (RI).</p> <p><span class=doc-section-title>Returns:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td><code>ri</code></td> <td> <code>float</code> </td> <td> <div class=doc-md-description> <p>Detection objective refractive index (RI).</p> </div> </td> </tr> </tbody> </table> </div> </div> <div class="doc doc-object doc-attribute"> <h3 id=merfish3danalysis.qi2labDataStore.qi2labDataStore.round_ids class="doc doc-heading"> <code class="highlight language-python"><span class=n>round_ids</span></code> <span class="doc doc-labels"> <small class="doc doc-label doc-label-property"><code>property</code></small> </span> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.round_ids class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-contents "> <p>Round IDs.</p> <p><span class=doc-section-title>Returns:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td><code>round_ids</code></td> <td> <code><span title="typing.Collection">Collection</span>[str]</code> </td> <td> <div class=doc-md-description> <p>Round IDs.</p> </div> </td> </tr> </tbody> </table> </div> </div> <div class="doc doc-object doc-attribute"> <h3 id=merfish3danalysis.qi2labDataStore.qi2labDataStore.tile_ids class="doc doc-heading"> <code class="highlight language-python"><span class=n>tile_ids</span></code> <span class="doc doc-labels"> <small class="doc doc-label doc-label-property"><code>property</code></small> </span> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.tile_ids class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-contents "> <p>Tile IDs.</p> <p><span class=doc-section-title>Returns:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td><code>tile_ids</code></td> <td> <code><span title="typing.Collection">Collection</span>[str]</code> </td> <td> <div class=doc-md-description> <p>Tile IDs.</p> </div> </td> </tr> </tbody> </table> </div> </div> <div class="doc doc-object doc-attribute"> <h3 id=merfish3danalysis.qi2labDataStore.qi2labDataStore.tile_overlap class="doc doc-heading"> <code class="highlight language-python"><span class=n>tile_overlap</span></code> <span class="doc doc-labels"> <small class="doc doc-label doc-label-property"><code>property</code></small> <small class="doc doc-label doc-label-writable"><code>writable</code></small> </span> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.tile_overlap class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-contents "> <p>XY tile overlap.</p> <p><span class=doc-section-title>Returns:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td><code>tile_overlap</code></td> <td> <code>float</code> </td> <td> <div class=doc-md-description> <p>XY tile overlap.</p> </div> </td> </tr> </tbody> </table> </div> </div> <div class="doc doc-object doc-attribute"> <h3 id=merfish3danalysis.qi2labDataStore.qi2labDataStore.voxel_size_zyx_um class="doc doc-heading"> <code class="highlight language-python"><span class=n>voxel_size_zyx_um</span></code> <span class="doc doc-labels"> <small class="doc doc-label doc-label-property"><code>property</code></small> <small class="doc doc-label doc-label-writable"><code>writable</code></small> </span> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.voxel_size_zyx_um class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-contents "> <p>Voxel size, zyx order (microns).</p> <p><span class=doc-section-title>Returns:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td><code>voxel_size_zyx_um</code></td> <td> <code><span title="numpy.typing.ArrayLike">ArrayLike</span></code> </td> <td> <div class=doc-md-description> <p>Voxel size, zyx order (microns).</p> </div> </td> </tr> </tbody> </table> </div> </div> <div class="doc doc-object doc-function"> <h3 id=merfish3danalysis.qi2labDataStore.qi2labDataStore._check_for_zarr_array class="doc doc-heading"> <code class="highlight language-python"><span class=n>_check_for_zarr_array</span><span class=p>(</span><span class=n>kvstore</span><span class=p>,</span> <span class=n>spec</span><span class=p>)</span></code> <span class="doc doc-labels"> <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small> </span> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore._check_for_zarr_array class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-contents "> <p>Check if zarr array exists using Tensortore.</p> <p><span class=doc-section-title>Parameters:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> <th>Default</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td> <code>kvstore</code> </td> <td> <code><span title="typing.Union">Union</span>[<span title="pathlib.Path">Path</span>, str]</code> </td> <td> <div class=doc-md-description> <p>Datastore location.</p> </div> </td> <td> <em>required</em> </td> </tr> <tr class=doc-section-item> <td> <code>spec</code> </td> <td> <code>dict</code> </td> <td> <div class=doc-md-description> <p>Zarr specification.</p> </div> </td> <td> <em>required</em> </td> </tr> </tbody> </table> <details class=quote> <summary>Source code in <code>src/merfish3danalysis/qi2labDataStore.py</code></summary> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1060</span>
<span class=normal>1061</span>
<span class=normal>1062</span>
<span class=normal>1063</span>
<span class=normal>1064</span>
<span class=normal>1065</span>
<span class=normal>1066</span>
<span class=normal>1067</span>
<span class=normal>1068</span>
<span class=normal>1069</span>
<span class=normal>1070</span>
<span class=normal>1071</span>
<span class=normal>1072</span>
<span class=normal>1073</span>
<span class=normal>1074</span>
<span class=normal>1075</span>
<span class=normal>1076</span>
<span class=normal>1077</span>
<span class=normal>1078</span>
<span class=normal>1079</span></pre></div></td><td class=code><div><pre><span></span><code><span class=nd>@staticmethod</span>
<span class=k>def</span> <span class=nf>_check_for_zarr_array</span><span class=p>(</span><span class=n>kvstore</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=n>Path</span><span class=p>,</span> <span class=nb>str</span><span class=p>],</span> <span class=n>spec</span><span class=p>:</span> <span class=nb>dict</span><span class=p>):</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Check if zarr array exists using Tensortore.</span>

<span class=sd>    Parameters</span>
<span class=sd>    ----------</span>
<span class=sd>    kvstore : Union[Path, str]</span>
<span class=sd>        Datastore location.</span>
<span class=sd>    spec : dict</span>
<span class=sd>        Zarr specification.</span>
<span class=sd>    &quot;&quot;&quot;</span>

    <span class=n>current_zarr</span> <span class=o>=</span> <span class=n>ts</span><span class=o>.</span><span class=n>open</span><span class=p>(</span>
        <span class=p>{</span>
            <span class=o>**</span><span class=n>spec</span><span class=p>,</span>
            <span class=s2>&quot;kvstore&quot;</span><span class=p>:</span> <span class=n>kvstore</span><span class=p>,</span>
        <span class=p>}</span>
    <span class=p>)</span><span class=o>.</span><span class=n>result</span><span class=p>()</span>

    <span class=k>del</span> <span class=n>current_zarr</span>
</code></pre></div></td></tr></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id=merfish3danalysis.qi2labDataStore.qi2labDataStore._get_kvstore_key class="doc doc-heading"> <code class="highlight language-python"><span class=n>_get_kvstore_key</span><span class=p>(</span><span class=n>path</span><span class=p>)</span></code> <span class="doc doc-labels"> <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small> </span> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore._get_kvstore_key class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-contents "> <p>Convert datastore location to tensorstore kvstore key.</p> <p><span class=doc-section-title>Parameters:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> <th>Default</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td> <code>path</code> </td> <td> <code><span title="typing.Union">Union</span>[<span title="pathlib.Path">Path</span>, str]</code> </td> <td> <div class=doc-md-description> <p>Datastore location.</p> </div> </td> <td> <em>required</em> </td> </tr> </tbody> </table> <p><span class=doc-section-title>Returns:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td><code>kvstore_key</code></td> <td> <code>dict</code> </td> <td> <div class=doc-md-description> <p>Tensorstore kvstore key.</p> </div> </td> </tr> </tbody> </table> <details class=quote> <summary>Source code in <code>src/merfish3danalysis/qi2labDataStore.py</code></summary> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>969</span>
<span class=normal>970</span>
<span class=normal>971</span>
<span class=normal>972</span>
<span class=normal>973</span>
<span class=normal>974</span>
<span class=normal>975</span>
<span class=normal>976</span>
<span class=normal>977</span>
<span class=normal>978</span>
<span class=normal>979</span>
<span class=normal>980</span>
<span class=normal>981</span>
<span class=normal>982</span>
<span class=normal>983</span>
<span class=normal>984</span>
<span class=normal>985</span>
<span class=normal>986</span>
<span class=normal>987</span>
<span class=normal>988</span>
<span class=normal>989</span>
<span class=normal>990</span>
<span class=normal>991</span>
<span class=normal>992</span>
<span class=normal>993</span>
<span class=normal>994</span></pre></div></td><td class=code><div><pre><span></span><code><span class=nd>@staticmethod</span>
<span class=k>def</span> <span class=nf>_get_kvstore_key</span><span class=p>(</span><span class=n>path</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=n>Path</span><span class=p>,</span> <span class=nb>str</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=nb>dict</span><span class=p>:</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Convert datastore location to tensorstore kvstore key.</span>

<span class=sd>    Parameters</span>
<span class=sd>    ----------</span>
<span class=sd>    path : Union[Path, str]</span>
<span class=sd>        Datastore location.</span>

<span class=sd>    Returns</span>
<span class=sd>    -------</span>
<span class=sd>    kvstore_key : dict</span>
<span class=sd>        Tensorstore kvstore key.</span>
<span class=sd>    &quot;&quot;&quot;</span>

    <span class=n>path_str</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span><span class=n>path</span><span class=p>)</span>
    <span class=k>if</span> <span class=n>path_str</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s2>&quot;s3://&quot;</span><span class=p>)</span> <span class=ow>or</span> <span class=s2>&quot;s3.amazonaws.com&quot;</span> <span class=ow>in</span> <span class=n>path_str</span><span class=p>:</span>
        <span class=k>return</span> <span class=p>{</span><span class=s2>&quot;driver&quot;</span><span class=p>:</span> <span class=s2>&quot;s3&quot;</span><span class=p>,</span> <span class=s2>&quot;path&quot;</span><span class=p>:</span> <span class=n>path_str</span><span class=p>}</span>
    <span class=k>elif</span> <span class=n>path_str</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s2>&quot;gs://&quot;</span><span class=p>)</span> <span class=ow>or</span> <span class=s2>&quot;storage.googleapis.com&quot;</span> <span class=ow>in</span> <span class=n>path_str</span><span class=p>:</span>
        <span class=k>return</span> <span class=p>{</span><span class=s2>&quot;driver&quot;</span><span class=p>:</span> <span class=s2>&quot;gcs&quot;</span><span class=p>,</span> <span class=s2>&quot;path&quot;</span><span class=p>:</span> <span class=n>path_str</span><span class=p>}</span>
    <span class=k>elif</span> <span class=n>path_str</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s2>&quot;azure://&quot;</span><span class=p>)</span> <span class=ow>or</span> <span class=s2>&quot;blob.core.windows.net&quot;</span> <span class=ow>in</span> <span class=n>path_str</span><span class=p>:</span>
        <span class=k>return</span> <span class=p>{</span><span class=s2>&quot;driver&quot;</span><span class=p>:</span> <span class=s2>&quot;azure&quot;</span><span class=p>,</span> <span class=s2>&quot;path&quot;</span><span class=p>:</span> <span class=n>path_str</span><span class=p>}</span>
    <span class=k>elif</span> <span class=n>path_str</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s2>&quot;http://&quot;</span><span class=p>)</span> <span class=ow>or</span> <span class=n>path_str</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s2>&quot;https://&quot;</span><span class=p>):</span>
        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&quot;Unsupported cloud storage provider in URL&quot;</span><span class=p>)</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=k>return</span> <span class=p>{</span><span class=s2>&quot;driver&quot;</span><span class=p>:</span> <span class=s2>&quot;file&quot;</span><span class=p>,</span> <span class=s2>&quot;path&quot;</span><span class=p>:</span> <span class=n>path_str</span><span class=p>}</span>
</code></pre></div></td></tr></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id=merfish3danalysis.qi2labDataStore.qi2labDataStore._init_datastore class="doc doc-heading"> <code class="highlight language-python"><span class=n>_init_datastore</span><span class=p>()</span></code> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore._init_datastore class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-contents "> <p>Initialize datastore.</p> <p>Create directory structure and initialize datastore state.</p> <details class=quote> <summary>Source code in <code>src/merfish3danalysis/qi2labDataStore.py</code></summary> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>913</span>
<span class=normal>914</span>
<span class=normal>915</span>
<span class=normal>916</span>
<span class=normal>917</span>
<span class=normal>918</span>
<span class=normal>919</span>
<span class=normal>920</span>
<span class=normal>921</span>
<span class=normal>922</span>
<span class=normal>923</span>
<span class=normal>924</span>
<span class=normal>925</span>
<span class=normal>926</span>
<span class=normal>927</span>
<span class=normal>928</span>
<span class=normal>929</span>
<span class=normal>930</span>
<span class=normal>931</span>
<span class=normal>932</span>
<span class=normal>933</span>
<span class=normal>934</span>
<span class=normal>935</span>
<span class=normal>936</span>
<span class=normal>937</span>
<span class=normal>938</span>
<span class=normal>939</span>
<span class=normal>940</span>
<span class=normal>941</span>
<span class=normal>942</span>
<span class=normal>943</span>
<span class=normal>944</span>
<span class=normal>945</span>
<span class=normal>946</span>
<span class=normal>947</span>
<span class=normal>948</span>
<span class=normal>949</span>
<span class=normal>950</span>
<span class=normal>951</span>
<span class=normal>952</span>
<span class=normal>953</span>
<span class=normal>954</span>
<span class=normal>955</span>
<span class=normal>956</span>
<span class=normal>957</span>
<span class=normal>958</span>
<span class=normal>959</span>
<span class=normal>960</span>
<span class=normal>961</span>
<span class=normal>962</span>
<span class=normal>963</span>
<span class=normal>964</span>
<span class=normal>965</span>
<span class=normal>966</span>
<span class=normal>967</span></pre></div></td><td class=code><div><pre><span></span><code><span class=k>def</span> <span class=nf>_init_datastore</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Initialize datastore.</span>

<span class=sd>    Create directory structure and initialize datastore state.</span>
<span class=sd>    &quot;&quot;&quot;</span>

    <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_path</span><span class=o>.</span><span class=n>mkdir</span><span class=p>(</span><span class=n>parents</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>_calibrations_zarr_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=sa>r</span><span class=s2>&quot;calibrations.zarr&quot;</span><span class=p>)</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>_calibrations_zarr_path</span><span class=o>.</span><span class=n>mkdir</span><span class=p>()</span>
    <span class=n>calibrations_zattrs_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_calibrations_zarr_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=sa>r</span><span class=s2>&quot;.zattrs&quot;</span><span class=p>)</span>
    <span class=n>empty_zattrs</span> <span class=o>=</span> <span class=p>{}</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>_save_to_json</span><span class=p>(</span><span class=n>empty_zattrs</span><span class=p>,</span> <span class=n>calibrations_zattrs_path</span><span class=p>)</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>_polyDT_root_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=sa>r</span><span class=s2>&quot;polyDT&quot;</span><span class=p>)</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>_polyDT_root_path</span><span class=o>.</span><span class=n>mkdir</span><span class=p>()</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>_readouts_root_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=sa>r</span><span class=s2>&quot;readouts&quot;</span><span class=p>)</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>_readouts_root_path</span><span class=o>.</span><span class=n>mkdir</span><span class=p>()</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>_ufish_localizations_root_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span>
        <span class=sa>r</span><span class=s2>&quot;ufish_localizations&quot;</span>
    <span class=p>)</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>_ufish_localizations_root_path</span><span class=o>.</span><span class=n>mkdir</span><span class=p>()</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>_decoded_root_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=sa>r</span><span class=s2>&quot;decoded&quot;</span><span class=p>)</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>_decoded_root_path</span><span class=o>.</span><span class=n>mkdir</span><span class=p>()</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>_fused_root_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=sa>r</span><span class=s2>&quot;fused&quot;</span><span class=p>)</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>_fused_root_path</span><span class=o>.</span><span class=n>mkdir</span><span class=p>()</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>_segmentation_root_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=sa>r</span><span class=s2>&quot;segmentation&quot;</span><span class=p>)</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>_segmentation_root_path</span><span class=o>.</span><span class=n>mkdir</span><span class=p>()</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>_mtx_output_root_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=sa>r</span><span class=s2>&quot;mtx_output&quot;</span><span class=p>)</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>_mtx_output_root_path</span><span class=o>.</span><span class=n>mkdir</span><span class=p>()</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>_baysor_path</span> <span class=o>=</span> <span class=sa>r</span><span class=s2>&quot;&quot;</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>_baysor_options</span> <span class=o>=</span> <span class=sa>r</span><span class=s2>&quot;&quot;</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>_julia_threads</span> <span class=o>=</span> <span class=mi>0</span>

    <span class=c1># initialize datastore state</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_state_json_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span>
        <span class=sa>r</span><span class=s2>&quot;datastore_state.json&quot;</span>
    <span class=p>)</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_state</span> <span class=o>=</span> <span class=p>{</span>
        <span class=s2>&quot;Version&quot;</span><span class=p>:</span> <span class=mf>0.3</span><span class=p>,</span>
        <span class=s2>&quot;Initialized&quot;</span><span class=p>:</span> <span class=kc>True</span><span class=p>,</span>
        <span class=s2>&quot;Calibrations&quot;</span><span class=p>:</span> <span class=kc>False</span><span class=p>,</span>
        <span class=s2>&quot;Corrected&quot;</span><span class=p>:</span> <span class=kc>False</span><span class=p>,</span>
        <span class=s2>&quot;LocalRegistered&quot;</span><span class=p>:</span> <span class=kc>False</span><span class=p>,</span>
        <span class=s2>&quot;GlobalRegistered&quot;</span><span class=p>:</span> <span class=kc>False</span><span class=p>,</span>
        <span class=s2>&quot;Fused&quot;</span><span class=p>:</span> <span class=kc>False</span><span class=p>,</span>
        <span class=s2>&quot;SegmentedCells&quot;</span><span class=p>:</span> <span class=kc>False</span><span class=p>,</span>
        <span class=s2>&quot;DecodedSpots&quot;</span><span class=p>:</span> <span class=kc>False</span><span class=p>,</span>
        <span class=s2>&quot;FilteredSpots&quot;</span><span class=p>:</span> <span class=kc>False</span><span class=p>,</span>
        <span class=s2>&quot;RefinedSpots&quot;</span><span class=p>:</span> <span class=kc>False</span><span class=p>,</span>
        <span class=s2>&quot;mtxOutput&quot;</span><span class=p>:</span> <span class=kc>False</span><span class=p>,</span>
        <span class=s2>&quot;BaysorPath&quot;</span><span class=p>:</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_baysor_path</span><span class=p>),</span>
        <span class=s2>&quot;BaysorOptions&quot;</span><span class=p>:</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_baysor_options</span><span class=p>),</span>
        <span class=s2>&quot;JuliaThreads&quot;</span><span class=p>:</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_julia_threads</span><span class=p>)</span>
    <span class=p>}</span>

    <span class=bp>self</span><span class=o>.</span><span class=n>_save_to_json</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_datastore_state</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_state_json_path</span><span class=p>)</span>
</code></pre></div></td></tr></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id=merfish3danalysis.qi2labDataStore.qi2labDataStore._load_from_json class="doc doc-heading"> <code class="highlight language-python"><span class=n>_load_from_json</span><span class=p>(</span><span class=n>dictionary_path</span><span class=p>)</span></code> <span class="doc doc-labels"> <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small> </span> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore._load_from_json class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-contents "> <p>Load json as dictionary.</p> <p><span class=doc-section-title>Parameters:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> <th>Default</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td> <code>dictionary_path</code> </td> <td> <code><span title="typing.Union">Union</span>[<span title="pathlib.Path">Path</span>, str]</code> </td> <td> <div class=doc-md-description> <p>Path to json file.</p> </div> </td> <td> <em>required</em> </td> </tr> </tbody> </table> <p><span class=doc-section-title>Returns:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td><code>dictionary</code></td> <td> <code>dict</code> </td> <td> <div class=doc-md-description> <p>Dictionary from json file.</p> </div> </td> </tr> </tbody> </table> <details class=quote> <summary>Source code in <code>src/merfish3danalysis/qi2labDataStore.py</code></summary> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 996</span>
<span class=normal> 997</span>
<span class=normal> 998</span>
<span class=normal> 999</span>
<span class=normal>1000</span>
<span class=normal>1001</span>
<span class=normal>1002</span>
<span class=normal>1003</span>
<span class=normal>1004</span>
<span class=normal>1005</span>
<span class=normal>1006</span>
<span class=normal>1007</span>
<span class=normal>1008</span>
<span class=normal>1009</span>
<span class=normal>1010</span>
<span class=normal>1011</span>
<span class=normal>1012</span>
<span class=normal>1013</span>
<span class=normal>1014</span>
<span class=normal>1015</span>
<span class=normal>1016</span></pre></div></td><td class=code><div><pre><span></span><code><span class=nd>@staticmethod</span>
<span class=k>def</span> <span class=nf>_load_from_json</span><span class=p>(</span><span class=n>dictionary_path</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=n>Path</span><span class=p>,</span> <span class=nb>str</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=nb>dict</span><span class=p>:</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Load json as dictionary.</span>

<span class=sd>    Parameters</span>
<span class=sd>    ----------</span>
<span class=sd>    dictionary_path : Union[Path, str]</span>
<span class=sd>        Path to json file.</span>

<span class=sd>    Returns</span>
<span class=sd>    -------</span>
<span class=sd>    dictionary : dict</span>
<span class=sd>        Dictionary from json file.</span>
<span class=sd>    &quot;&quot;&quot;</span>

    <span class=k>try</span><span class=p>:</span>
        <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>dictionary_path</span><span class=p>,</span> <span class=s2>&quot;r&quot;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
            <span class=n>dictionary</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=n>f</span><span class=p>)</span>
    <span class=k>except</span> <span class=p>(</span><span class=ne>FileNotFoundError</span><span class=p>,</span> <span class=n>json</span><span class=o>.</span><span class=n>JSONDecodeError</span><span class=p>):</span>
        <span class=n>dictionary</span> <span class=o>=</span> <span class=p>{}</span>
    <span class=k>return</span> <span class=n>dictionary</span>
</code></pre></div></td></tr></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id=merfish3danalysis.qi2labDataStore.qi2labDataStore._load_from_microjson class="doc doc-heading"> <code class="highlight language-python"><span class=n>_load_from_microjson</span><span class=p>(</span><span class=n>dictionary_path</span><span class=p>)</span></code> <span class="doc doc-labels"> <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small> </span> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore._load_from_microjson class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-contents "> <p>Load cell outlines outlines microjson as dictionary.</p> <p><span class=doc-section-title>Parameters:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> <th>Default</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td> <code>dictionary_path</code> </td> <td> <code><span title="typing.Union">Union</span>[<span title="pathlib.Path">Path</span>, str]</code> </td> <td> <div class=doc-md-description> <p>Path to microjson file.</p> </div> </td> <td> <em>required</em> </td> </tr> </tbody> </table> <p><span class=doc-section-title>Returns:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td><code>outlines</code></td> <td> <code>dict</code> </td> <td> <div class=doc-md-description> <p>Cell outlines dictionary.</p> </div> </td> </tr> </tbody> </table> <details class=quote> <summary>Source code in <code>src/merfish3danalysis/qi2labDataStore.py</code></summary> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1033</span>
<span class=normal>1034</span>
<span class=normal>1035</span>
<span class=normal>1036</span>
<span class=normal>1037</span>
<span class=normal>1038</span>
<span class=normal>1039</span>
<span class=normal>1040</span>
<span class=normal>1041</span>
<span class=normal>1042</span>
<span class=normal>1043</span>
<span class=normal>1044</span>
<span class=normal>1045</span>
<span class=normal>1046</span>
<span class=normal>1047</span>
<span class=normal>1048</span>
<span class=normal>1049</span>
<span class=normal>1050</span>
<span class=normal>1051</span>
<span class=normal>1052</span>
<span class=normal>1053</span>
<span class=normal>1054</span>
<span class=normal>1055</span>
<span class=normal>1056</span>
<span class=normal>1057</span>
<span class=normal>1058</span></pre></div></td><td class=code><div><pre><span></span><code><span class=nd>@staticmethod</span>
<span class=k>def</span> <span class=nf>_load_from_microjson</span><span class=p>(</span><span class=n>dictionary_path</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=n>Path</span><span class=p>,</span> <span class=nb>str</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=nb>dict</span><span class=p>:</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Load cell outlines outlines microjson as dictionary.</span>

<span class=sd>    Parameters</span>
<span class=sd>    ----------</span>
<span class=sd>    dictionary_path : Union[Path, str]</span>
<span class=sd>        Path to microjson file.</span>

<span class=sd>    Returns</span>
<span class=sd>    -------</span>
<span class=sd>    outlines : dict</span>
<span class=sd>        Cell outlines dictionary.</span>
<span class=sd>    &quot;&quot;&quot;</span>

    <span class=k>try</span><span class=p>:</span>
        <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>dictionary_path</span><span class=p>,</span> <span class=s2>&quot;r&quot;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
            <span class=n>data</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=n>f</span><span class=p>)</span>
            <span class=n>outlines</span> <span class=o>=</span> <span class=p>{}</span>
            <span class=k>for</span> <span class=n>feature</span> <span class=ow>in</span> <span class=n>data</span><span class=p>[</span><span class=s2>&quot;features&quot;</span><span class=p>]:</span>
                <span class=n>cell_id</span> <span class=o>=</span> <span class=n>feature</span><span class=p>[</span><span class=s2>&quot;properties&quot;</span><span class=p>][</span><span class=s2>&quot;cell_id&quot;</span><span class=p>]</span>
                <span class=n>coordinates</span> <span class=o>=</span> <span class=n>feature</span><span class=p>[</span><span class=s2>&quot;geometry&quot;</span><span class=p>][</span><span class=s2>&quot;coordinates&quot;</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span>
                <span class=n>outlines</span><span class=p>[</span><span class=n>cell_id</span><span class=p>]</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>(</span><span class=n>coordinates</span><span class=p>)</span>
    <span class=k>except</span> <span class=p>(</span><span class=ne>FileNotFoundError</span><span class=p>,</span> <span class=n>json</span><span class=o>.</span><span class=n>JSONDecodeError</span><span class=p>,</span> <span class=ne>KeyError</span><span class=p>,</span> <span class=ne>TypeError</span><span class=p>,</span> <span class=ne>ValueError</span><span class=p>):</span>
        <span class=n>outlines</span> <span class=o>=</span> <span class=p>{}</span>
    <span class=k>return</span> <span class=n>outlines</span>
</code></pre></div></td></tr></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id=merfish3danalysis.qi2labDataStore.qi2labDataStore._load_from_parquet class="doc doc-heading"> <code class="highlight language-python"><span class=n>_load_from_parquet</span><span class=p>(</span><span class=n>parquet_path</span><span class=p>)</span></code> <span class="doc doc-labels"> <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small> </span> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore._load_from_parquet class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-contents "> <p>Load dataframe from parquet.</p> <p><span class=doc-section-title>Parameters:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> <th>Default</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td> <code>parquet_path</code> </td> <td> <code><span title="typing.Union">Union</span>[<span title="pathlib.Path">Path</span>, str]</code> </td> <td> <div class=doc-md-description> <p>Path to parquet file.</p> </div> </td> <td> <em>required</em> </td> </tr> </tbody> </table> <p><span class=doc-section-title>Returns:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td><code>df</code></td> <td> <code><span title="pandas.DataFrame">DataFrame</span></code> </td> <td> <div class=doc-md-description> <p>Dataframe from parquet file.</p> </div> </td> </tr> </tbody> </table> <details class=quote> <summary>Source code in <code>src/merfish3danalysis/qi2labDataStore.py</code></summary> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1187</span>
<span class=normal>1188</span>
<span class=normal>1189</span>
<span class=normal>1190</span>
<span class=normal>1191</span>
<span class=normal>1192</span>
<span class=normal>1193</span>
<span class=normal>1194</span>
<span class=normal>1195</span>
<span class=normal>1196</span>
<span class=normal>1197</span>
<span class=normal>1198</span>
<span class=normal>1199</span>
<span class=normal>1200</span>
<span class=normal>1201</span>
<span class=normal>1202</span></pre></div></td><td class=code><div><pre><span></span><code><span class=nd>@staticmethod</span>
<span class=k>def</span> <span class=nf>_load_from_parquet</span><span class=p>(</span><span class=n>parquet_path</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=n>Path</span><span class=p>,</span> <span class=nb>str</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>:</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Load dataframe from parquet.</span>

<span class=sd>    Parameters</span>
<span class=sd>    ----------</span>
<span class=sd>    parquet_path : Union[Path, str]</span>
<span class=sd>        Path to parquet file.</span>

<span class=sd>    Returns</span>
<span class=sd>    -------</span>
<span class=sd>    df : pd.DataFrame</span>
<span class=sd>        Dataframe from parquet file.</span>
<span class=sd>    &quot;&quot;&quot;</span>

    <span class=k>return</span> <span class=n>pd</span><span class=o>.</span><span class=n>read_parquet</span><span class=p>(</span><span class=n>parquet_path</span><span class=p>)</span>
</code></pre></div></td></tr></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id=merfish3danalysis.qi2labDataStore.qi2labDataStore._load_from_zarr_array class="doc doc-heading"> <code class="highlight language-python"><span class=n>_load_from_zarr_array</span><span class=p>(</span><span class=n>kvstore</span><span class=p>,</span> <span class=n>spec</span><span class=p>,</span> <span class=n>return_future</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span></code> <span class="doc doc-labels"> <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small> </span> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore._load_from_zarr_array class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-contents "> <p>Return tensorstore array from zarr</p> <p>Defaults to returning future result.</p> <p><span class=doc-section-title>Parameters:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> <th>Default</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td> <code>kvstore</code> </td> <td> <code>dict</code> </td> <td> <div class=doc-md-description> <p>Tensorstore kvstore specification.</p> </div> </td> <td> <em>required</em> </td> </tr> <tr class=doc-section-item> <td> <code>spec</code> </td> <td> <code>dict</code> </td> <td> <div class=doc-md-description> <p>Tensorstore zarr specification.</p> </div> </td> <td> <em>required</em> </td> </tr> <tr class=doc-section-item> <td> <code>return_future</code> </td> <td> <code>bool</code> </td> <td> <div class=doc-md-description> <p>Return future (True) or immediately read (False).</p> </div> </td> <td> <code>True</code> </td> </tr> </tbody> </table> <p><span class=doc-section-title>Returns:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td><code>array</code></td> <td> <code><span title="numpy.typing.ArrayLike">ArrayLike</span></code> </td> <td> <div class=doc-md-description> <p>Delayed (future) or immediate array.</p> </div> </td> </tr> </tbody> </table> <details class=quote> <summary>Source code in <code>src/merfish3danalysis/qi2labDataStore.py</code></summary> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1081</span>
<span class=normal>1082</span>
<span class=normal>1083</span>
<span class=normal>1084</span>
<span class=normal>1085</span>
<span class=normal>1086</span>
<span class=normal>1087</span>
<span class=normal>1088</span>
<span class=normal>1089</span>
<span class=normal>1090</span>
<span class=normal>1091</span>
<span class=normal>1092</span>
<span class=normal>1093</span>
<span class=normal>1094</span>
<span class=normal>1095</span>
<span class=normal>1096</span>
<span class=normal>1097</span>
<span class=normal>1098</span>
<span class=normal>1099</span>
<span class=normal>1100</span>
<span class=normal>1101</span>
<span class=normal>1102</span>
<span class=normal>1103</span>
<span class=normal>1104</span>
<span class=normal>1105</span>
<span class=normal>1106</span>
<span class=normal>1107</span>
<span class=normal>1108</span>
<span class=normal>1109</span>
<span class=normal>1110</span>
<span class=normal>1111</span>
<span class=normal>1112</span>
<span class=normal>1113</span>
<span class=normal>1114</span>
<span class=normal>1115</span>
<span class=normal>1116</span></pre></div></td><td class=code><div><pre><span></span><code><span class=nd>@staticmethod</span>
<span class=k>def</span> <span class=nf>_load_from_zarr_array</span><span class=p>(</span>
    <span class=n>kvstore</span><span class=p>:</span> <span class=nb>dict</span><span class=p>,</span> <span class=n>spec</span><span class=p>:</span> <span class=nb>dict</span><span class=p>,</span> <span class=n>return_future</span><span class=o>=</span><span class=kc>True</span>
<span class=p>)</span> <span class=o>-&gt;</span> <span class=n>ArrayLike</span><span class=p>:</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Return tensorstore array from zarr</span>

<span class=sd>    Defaults to returning future result.</span>

<span class=sd>    Parameters</span>
<span class=sd>    ----------</span>
<span class=sd>    kvstore : dict</span>
<span class=sd>        Tensorstore kvstore specification.</span>
<span class=sd>    spec : dict</span>
<span class=sd>        Tensorstore zarr specification.</span>
<span class=sd>    return_future : bool</span>
<span class=sd>        Return future (True) or immediately read (False).</span>

<span class=sd>    Returns</span>
<span class=sd>    -------</span>
<span class=sd>    array : ArrayLike</span>
<span class=sd>        Delayed (future) or immediate array.</span>
<span class=sd>    &quot;&quot;&quot;</span>

    <span class=n>current_zarr</span> <span class=o>=</span> <span class=n>ts</span><span class=o>.</span><span class=n>open</span><span class=p>(</span>
        <span class=p>{</span>
            <span class=o>**</span><span class=n>spec</span><span class=p>,</span>
            <span class=s2>&quot;kvstore&quot;</span><span class=p>:</span> <span class=n>kvstore</span><span class=p>,</span>
        <span class=p>}</span>
    <span class=p>)</span><span class=o>.</span><span class=n>result</span><span class=p>()</span>

    <span class=n>read_future</span> <span class=o>=</span> <span class=n>current_zarr</span><span class=o>.</span><span class=n>read</span><span class=p>()</span>

    <span class=k>if</span> <span class=n>return_future</span><span class=p>:</span>
        <span class=k>return</span> <span class=n>read_future</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=k>return</span> <span class=n>read_future</span><span class=o>.</span><span class=n>result</span><span class=p>()</span>
</code></pre></div></td></tr></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id=merfish3danalysis.qi2labDataStore.qi2labDataStore._parse_datastore class="doc doc-heading"> <code class="highlight language-python"><span class=n>_parse_datastore</span><span class=p>()</span></code> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore._parse_datastore class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-contents "> <p>Parse datastore to discover available components.</p> <details class=quote> <summary>Source code in <code>src/merfish3danalysis/qi2labDataStore.py</code></summary> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1218</span>
<span class=normal>1219</span>
<span class=normal>1220</span>
<span class=normal>1221</span>
<span class=normal>1222</span>
<span class=normal>1223</span>
<span class=normal>1224</span>
<span class=normal>1225</span>
<span class=normal>1226</span>
<span class=normal>1227</span>
<span class=normal>1228</span>
<span class=normal>1229</span>
<span class=normal>1230</span>
<span class=normal>1231</span>
<span class=normal>1232</span>
<span class=normal>1233</span>
<span class=normal>1234</span>
<span class=normal>1235</span>
<span class=normal>1236</span>
<span class=normal>1237</span>
<span class=normal>1238</span>
<span class=normal>1239</span>
<span class=normal>1240</span>
<span class=normal>1241</span>
<span class=normal>1242</span>
<span class=normal>1243</span>
<span class=normal>1244</span>
<span class=normal>1245</span>
<span class=normal>1246</span>
<span class=normal>1247</span>
<span class=normal>1248</span>
<span class=normal>1249</span>
<span class=normal>1250</span>
<span class=normal>1251</span>
<span class=normal>1252</span>
<span class=normal>1253</span>
<span class=normal>1254</span>
<span class=normal>1255</span>
<span class=normal>1256</span>
<span class=normal>1257</span>
<span class=normal>1258</span>
<span class=normal>1259</span>
<span class=normal>1260</span>
<span class=normal>1261</span>
<span class=normal>1262</span>
<span class=normal>1263</span>
<span class=normal>1264</span>
<span class=normal>1265</span>
<span class=normal>1266</span>
<span class=normal>1267</span>
<span class=normal>1268</span>
<span class=normal>1269</span>
<span class=normal>1270</span>
<span class=normal>1271</span>
<span class=normal>1272</span>
<span class=normal>1273</span>
<span class=normal>1274</span>
<span class=normal>1275</span>
<span class=normal>1276</span>
<span class=normal>1277</span>
<span class=normal>1278</span>
<span class=normal>1279</span>
<span class=normal>1280</span>
<span class=normal>1281</span>
<span class=normal>1282</span>
<span class=normal>1283</span>
<span class=normal>1284</span>
<span class=normal>1285</span>
<span class=normal>1286</span>
<span class=normal>1287</span>
<span class=normal>1288</span>
<span class=normal>1289</span>
<span class=normal>1290</span>
<span class=normal>1291</span>
<span class=normal>1292</span>
<span class=normal>1293</span>
<span class=normal>1294</span>
<span class=normal>1295</span>
<span class=normal>1296</span>
<span class=normal>1297</span>
<span class=normal>1298</span>
<span class=normal>1299</span>
<span class=normal>1300</span>
<span class=normal>1301</span>
<span class=normal>1302</span>
<span class=normal>1303</span>
<span class=normal>1304</span>
<span class=normal>1305</span>
<span class=normal>1306</span>
<span class=normal>1307</span>
<span class=normal>1308</span>
<span class=normal>1309</span>
<span class=normal>1310</span>
<span class=normal>1311</span>
<span class=normal>1312</span>
<span class=normal>1313</span>
<span class=normal>1314</span>
<span class=normal>1315</span>
<span class=normal>1316</span>
<span class=normal>1317</span>
<span class=normal>1318</span>
<span class=normal>1319</span>
<span class=normal>1320</span>
<span class=normal>1321</span>
<span class=normal>1322</span>
<span class=normal>1323</span>
<span class=normal>1324</span>
<span class=normal>1325</span>
<span class=normal>1326</span>
<span class=normal>1327</span>
<span class=normal>1328</span>
<span class=normal>1329</span>
<span class=normal>1330</span>
<span class=normal>1331</span>
<span class=normal>1332</span>
<span class=normal>1333</span>
<span class=normal>1334</span>
<span class=normal>1335</span>
<span class=normal>1336</span>
<span class=normal>1337</span>
<span class=normal>1338</span>
<span class=normal>1339</span>
<span class=normal>1340</span>
<span class=normal>1341</span>
<span class=normal>1342</span>
<span class=normal>1343</span>
<span class=normal>1344</span>
<span class=normal>1345</span>
<span class=normal>1346</span>
<span class=normal>1347</span>
<span class=normal>1348</span>
<span class=normal>1349</span>
<span class=normal>1350</span>
<span class=normal>1351</span>
<span class=normal>1352</span>
<span class=normal>1353</span>
<span class=normal>1354</span>
<span class=normal>1355</span>
<span class=normal>1356</span>
<span class=normal>1357</span>
<span class=normal>1358</span>
<span class=normal>1359</span>
<span class=normal>1360</span>
<span class=normal>1361</span>
<span class=normal>1362</span>
<span class=normal>1363</span>
<span class=normal>1364</span>
<span class=normal>1365</span>
<span class=normal>1366</span>
<span class=normal>1367</span>
<span class=normal>1368</span>
<span class=normal>1369</span>
<span class=normal>1370</span>
<span class=normal>1371</span>
<span class=normal>1372</span>
<span class=normal>1373</span>
<span class=normal>1374</span>
<span class=normal>1375</span>
<span class=normal>1376</span>
<span class=normal>1377</span>
<span class=normal>1378</span>
<span class=normal>1379</span>
<span class=normal>1380</span>
<span class=normal>1381</span>
<span class=normal>1382</span>
<span class=normal>1383</span>
<span class=normal>1384</span>
<span class=normal>1385</span>
<span class=normal>1386</span>
<span class=normal>1387</span>
<span class=normal>1388</span>
<span class=normal>1389</span>
<span class=normal>1390</span>
<span class=normal>1391</span>
<span class=normal>1392</span>
<span class=normal>1393</span>
<span class=normal>1394</span>
<span class=normal>1395</span>
<span class=normal>1396</span>
<span class=normal>1397</span>
<span class=normal>1398</span>
<span class=normal>1399</span>
<span class=normal>1400</span>
<span class=normal>1401</span>
<span class=normal>1402</span>
<span class=normal>1403</span>
<span class=normal>1404</span>
<span class=normal>1405</span>
<span class=normal>1406</span>
<span class=normal>1407</span>
<span class=normal>1408</span>
<span class=normal>1409</span>
<span class=normal>1410</span>
<span class=normal>1411</span>
<span class=normal>1412</span>
<span class=normal>1413</span>
<span class=normal>1414</span>
<span class=normal>1415</span>
<span class=normal>1416</span>
<span class=normal>1417</span>
<span class=normal>1418</span>
<span class=normal>1419</span>
<span class=normal>1420</span>
<span class=normal>1421</span>
<span class=normal>1422</span>
<span class=normal>1423</span>
<span class=normal>1424</span>
<span class=normal>1425</span>
<span class=normal>1426</span>
<span class=normal>1427</span>
<span class=normal>1428</span>
<span class=normal>1429</span>
<span class=normal>1430</span>
<span class=normal>1431</span>
<span class=normal>1432</span>
<span class=normal>1433</span>
<span class=normal>1434</span>
<span class=normal>1435</span>
<span class=normal>1436</span>
<span class=normal>1437</span>
<span class=normal>1438</span>
<span class=normal>1439</span>
<span class=normal>1440</span>
<span class=normal>1441</span>
<span class=normal>1442</span>
<span class=normal>1443</span>
<span class=normal>1444</span>
<span class=normal>1445</span>
<span class=normal>1446</span>
<span class=normal>1447</span>
<span class=normal>1448</span>
<span class=normal>1449</span>
<span class=normal>1450</span>
<span class=normal>1451</span>
<span class=normal>1452</span>
<span class=normal>1453</span>
<span class=normal>1454</span>
<span class=normal>1455</span>
<span class=normal>1456</span>
<span class=normal>1457</span>
<span class=normal>1458</span>
<span class=normal>1459</span>
<span class=normal>1460</span>
<span class=normal>1461</span>
<span class=normal>1462</span>
<span class=normal>1463</span>
<span class=normal>1464</span>
<span class=normal>1465</span>
<span class=normal>1466</span>
<span class=normal>1467</span>
<span class=normal>1468</span>
<span class=normal>1469</span>
<span class=normal>1470</span>
<span class=normal>1471</span>
<span class=normal>1472</span>
<span class=normal>1473</span>
<span class=normal>1474</span>
<span class=normal>1475</span>
<span class=normal>1476</span>
<span class=normal>1477</span>
<span class=normal>1478</span>
<span class=normal>1479</span>
<span class=normal>1480</span>
<span class=normal>1481</span>
<span class=normal>1482</span>
<span class=normal>1483</span>
<span class=normal>1484</span>
<span class=normal>1485</span>
<span class=normal>1486</span>
<span class=normal>1487</span>
<span class=normal>1488</span>
<span class=normal>1489</span>
<span class=normal>1490</span>
<span class=normal>1491</span>
<span class=normal>1492</span>
<span class=normal>1493</span>
<span class=normal>1494</span>
<span class=normal>1495</span>
<span class=normal>1496</span>
<span class=normal>1497</span>
<span class=normal>1498</span>
<span class=normal>1499</span>
<span class=normal>1500</span>
<span class=normal>1501</span>
<span class=normal>1502</span>
<span class=normal>1503</span>
<span class=normal>1504</span>
<span class=normal>1505</span>
<span class=normal>1506</span>
<span class=normal>1507</span>
<span class=normal>1508</span>
<span class=normal>1509</span>
<span class=normal>1510</span>
<span class=normal>1511</span>
<span class=normal>1512</span>
<span class=normal>1513</span>
<span class=normal>1514</span>
<span class=normal>1515</span>
<span class=normal>1516</span>
<span class=normal>1517</span>
<span class=normal>1518</span>
<span class=normal>1519</span>
<span class=normal>1520</span>
<span class=normal>1521</span>
<span class=normal>1522</span>
<span class=normal>1523</span>
<span class=normal>1524</span>
<span class=normal>1525</span>
<span class=normal>1526</span>
<span class=normal>1527</span>
<span class=normal>1528</span>
<span class=normal>1529</span>
<span class=normal>1530</span>
<span class=normal>1531</span>
<span class=normal>1532</span>
<span class=normal>1533</span>
<span class=normal>1534</span>
<span class=normal>1535</span>
<span class=normal>1536</span>
<span class=normal>1537</span>
<span class=normal>1538</span>
<span class=normal>1539</span>
<span class=normal>1540</span>
<span class=normal>1541</span>
<span class=normal>1542</span>
<span class=normal>1543</span>
<span class=normal>1544</span>
<span class=normal>1545</span>
<span class=normal>1546</span>
<span class=normal>1547</span>
<span class=normal>1548</span>
<span class=normal>1549</span>
<span class=normal>1550</span>
<span class=normal>1551</span>
<span class=normal>1552</span>
<span class=normal>1553</span>
<span class=normal>1554</span>
<span class=normal>1555</span>
<span class=normal>1556</span>
<span class=normal>1557</span>
<span class=normal>1558</span>
<span class=normal>1559</span>
<span class=normal>1560</span>
<span class=normal>1561</span>
<span class=normal>1562</span>
<span class=normal>1563</span>
<span class=normal>1564</span>
<span class=normal>1565</span>
<span class=normal>1566</span>
<span class=normal>1567</span>
<span class=normal>1568</span>
<span class=normal>1569</span>
<span class=normal>1570</span>
<span class=normal>1571</span>
<span class=normal>1572</span>
<span class=normal>1573</span>
<span class=normal>1574</span>
<span class=normal>1575</span>
<span class=normal>1576</span>
<span class=normal>1577</span>
<span class=normal>1578</span>
<span class=normal>1579</span>
<span class=normal>1580</span>
<span class=normal>1581</span>
<span class=normal>1582</span>
<span class=normal>1583</span>
<span class=normal>1584</span>
<span class=normal>1585</span>
<span class=normal>1586</span>
<span class=normal>1587</span>
<span class=normal>1588</span>
<span class=normal>1589</span>
<span class=normal>1590</span>
<span class=normal>1591</span>
<span class=normal>1592</span>
<span class=normal>1593</span>
<span class=normal>1594</span>
<span class=normal>1595</span>
<span class=normal>1596</span>
<span class=normal>1597</span>
<span class=normal>1598</span>
<span class=normal>1599</span>
<span class=normal>1600</span>
<span class=normal>1601</span>
<span class=normal>1602</span>
<span class=normal>1603</span>
<span class=normal>1604</span>
<span class=normal>1605</span>
<span class=normal>1606</span>
<span class=normal>1607</span>
<span class=normal>1608</span>
<span class=normal>1609</span>
<span class=normal>1610</span>
<span class=normal>1611</span>
<span class=normal>1612</span>
<span class=normal>1613</span>
<span class=normal>1614</span>
<span class=normal>1615</span>
<span class=normal>1616</span>
<span class=normal>1617</span>
<span class=normal>1618</span>
<span class=normal>1619</span>
<span class=normal>1620</span>
<span class=normal>1621</span>
<span class=normal>1622</span>
<span class=normal>1623</span>
<span class=normal>1624</span>
<span class=normal>1625</span>
<span class=normal>1626</span>
<span class=normal>1627</span>
<span class=normal>1628</span>
<span class=normal>1629</span>
<span class=normal>1630</span>
<span class=normal>1631</span>
<span class=normal>1632</span>
<span class=normal>1633</span>
<span class=normal>1634</span>
<span class=normal>1635</span>
<span class=normal>1636</span>
<span class=normal>1637</span>
<span class=normal>1638</span>
<span class=normal>1639</span>
<span class=normal>1640</span>
<span class=normal>1641</span>
<span class=normal>1642</span>
<span class=normal>1643</span>
<span class=normal>1644</span>
<span class=normal>1645</span>
<span class=normal>1646</span>
<span class=normal>1647</span>
<span class=normal>1648</span>
<span class=normal>1649</span>
<span class=normal>1650</span>
<span class=normal>1651</span>
<span class=normal>1652</span>
<span class=normal>1653</span>
<span class=normal>1654</span>
<span class=normal>1655</span>
<span class=normal>1656</span>
<span class=normal>1657</span>
<span class=normal>1658</span>
<span class=normal>1659</span>
<span class=normal>1660</span>
<span class=normal>1661</span>
<span class=normal>1662</span>
<span class=normal>1663</span>
<span class=normal>1664</span></pre></div></td><td class=code><div><pre><span></span><code><span class=k>def</span> <span class=nf>_parse_datastore</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Parse datastore to discover available components.&quot;&quot;&quot;</span>

    <span class=c1># directory structure as defined by qi2lab spec</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>_calibrations_zarr_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=sa>r</span><span class=s2>&quot;calibrations.zarr&quot;</span><span class=p>)</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>_polyDT_root_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=sa>r</span><span class=s2>&quot;polyDT&quot;</span><span class=p>)</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>_readouts_root_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=sa>r</span><span class=s2>&quot;readouts&quot;</span><span class=p>)</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>_ufish_localizations_root_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span>
        <span class=sa>r</span><span class=s2>&quot;ufish_localizations&quot;</span>
    <span class=p>)</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>_decoded_root_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=sa>r</span><span class=s2>&quot;decoded&quot;</span><span class=p>)</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>_fused_root_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=sa>r</span><span class=s2>&quot;fused&quot;</span><span class=p>)</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>_segmentation_root_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=sa>r</span><span class=s2>&quot;segmentation&quot;</span><span class=p>)</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>_mtx_output_root_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=sa>r</span><span class=s2>&quot;mtx_output&quot;</span><span class=p>)</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_state_json_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span>
        <span class=sa>r</span><span class=s2>&quot;datastore_state.json&quot;</span>
    <span class=p>)</span>

    <span class=c1># read in .json in root directory that indicates what steps have been run</span>
    <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_datastore_state_json_path</span><span class=p>,</span> <span class=s2>&quot;r&quot;</span><span class=p>)</span> <span class=k>as</span> <span class=n>json_file</span><span class=p>:</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_state</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=n>json_file</span><span class=p>)</span>

    <span class=c1># validate calibrations.zarr</span>
    <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_state</span><span class=p>[</span><span class=s2>&quot;Calibrations&quot;</span><span class=p>]:</span>
        <span class=k>if</span> <span class=ow>not</span> <span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_calibrations_zarr_path</span><span class=o>.</span><span class=n>exists</span><span class=p>()):</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Calibration data error.&quot;</span><span class=p>)</span>
        <span class=k>try</span><span class=p>:</span>
            <span class=n>zattrs_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_calibrations_zarr_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;.zattrs&quot;</span><span class=p>)</span>
            <span class=n>attributes</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_json</span><span class=p>(</span><span class=n>zattrs_path</span><span class=p>)</span>
        <span class=k>except</span> <span class=p>(</span><span class=ne>FileNotFoundError</span><span class=p>,</span> <span class=n>json</span><span class=o>.</span><span class=n>JSONDecodeError</span><span class=p>):</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Calibration attributes not found&quot;</span><span class=p>)</span>

        <span class=n>keys_to_check</span> <span class=o>=</span> <span class=p>[</span>
            <span class=s2>&quot;num_rounds&quot;</span><span class=p>,</span>
            <span class=s2>&quot;num_tiles&quot;</span><span class=p>,</span>
            <span class=s2>&quot;channels_in_data&quot;</span><span class=p>,</span>
            <span class=s2>&quot;tile_overlap&quot;</span><span class=p>,</span>
            <span class=s2>&quot;binning&quot;</span><span class=p>,</span>
            <span class=s2>&quot;e_per_ADU&quot;</span><span class=p>,</span>
            <span class=s2>&quot;na&quot;</span><span class=p>,</span>
            <span class=s2>&quot;ri&quot;</span><span class=p>,</span>
            <span class=s2>&quot;exp_order&quot;</span><span class=p>,</span>
            <span class=s2>&quot;codebook&quot;</span><span class=p>,</span>
            <span class=s2>&quot;num_bits&quot;</span>
        <span class=p>]</span>
        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_state</span><span class=p>[</span><span class=s2>&quot;Version&quot;</span><span class=p>]</span> <span class=o>==</span> <span class=mf>0.3</span><span class=p>:</span>
            <span class=n>keys_to_check</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s2>&quot;microscope_type&quot;</span><span class=p>)</span>
            <span class=n>keys_to_check</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s2>&quot;camera_model&quot;</span><span class=p>)</span>
            <span class=n>keys_to_check</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s2>&quot;voxel_size_zyx_um&quot;</span><span class=p>)</span>
        <span class=k>for</span> <span class=n>key</span> <span class=ow>in</span> <span class=n>keys_to_check</span><span class=p>:</span>
            <span class=k>if</span> <span class=n>key</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>attributes</span><span class=o>.</span><span class=n>keys</span><span class=p>():</span>
                <span class=k>raise</span> <span class=ne>KeyError</span><span class=p>(</span><span class=s2>&quot;Calibration attributes incomplete&quot;</span><span class=p>)</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=nb>setattr</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=s2>&quot;_&quot;</span> <span class=o>+</span> <span class=n>key</span><span class=p>,</span> <span class=n>attributes</span><span class=p>[</span><span class=n>key</span><span class=p>])</span>

        <span class=n>current_local_zarr_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_calibrations_zarr_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;psf_data&quot;</span><span class=p>)</span>
        <span class=p>)</span>

        <span class=k>try</span><span class=p>:</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_psfs</span> <span class=o>=</span> <span class=p>(</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_zarr_array</span><span class=p>(</span>
                    <span class=n>kvstore</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>_get_kvstore_key</span><span class=p>(</span><span class=n>current_local_zarr_path</span><span class=p>),</span>
                    <span class=n>spec</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>_zarrv2_spec</span><span class=o>.</span><span class=n>copy</span><span class=p>(),</span>
                <span class=p>)</span>
            <span class=p>)</span><span class=o>.</span><span class=n>result</span><span class=p>()</span>
        <span class=k>except</span> <span class=p>(</span><span class=ne>IOError</span><span class=p>,</span> <span class=ne>OSError</span><span class=p>,</span> <span class=n>ZarrError</span><span class=p>):</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Calibration psfs missing.&quot;</span><span class=p>)</span>

        <span class=k>del</span> <span class=n>current_local_zarr_path</span>

        <span class=c1># current_local_zarr_path = str(</span>
        <span class=c1>#     self._calibrations_zarr_path / Path(&quot;noise_map&quot;)</span>
        <span class=c1># )</span>

        <span class=c1># try:</span>
        <span class=c1>#     self._noise_map = (</span>
        <span class=c1>#         self._load_from_zarr_array(</span>
        <span class=c1>#             kvstore=self._get_kvstore_key(current_local_zarr_path),</span>
        <span class=c1>#             spec=self._zarrv2_spec,</span>
        <span class=c1>#         )</span>
        <span class=c1>#     ).result()</span>
        <span class=c1># except Exception:</span>
        <span class=c1>#     print(&quot;Calibration noise map missing.&quot;)</span>

    <span class=c1># validate polyDT and readout bits data</span>
    <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_state</span><span class=p>[</span><span class=s2>&quot;Corrected&quot;</span><span class=p>]:</span>
        <span class=k>if</span> <span class=ow>not</span> <span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_polyDT_root_path</span><span class=o>.</span><span class=n>exists</span><span class=p>()):</span>
            <span class=k>raise</span> <span class=ne>FileNotFoundError</span><span class=p>(</span><span class=s2>&quot;PolyDT directory not initialized&quot;</span><span class=p>)</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>polyDT_tile_ids</span> <span class=o>=</span> <span class=nb>sorted</span><span class=p>(</span>
                <span class=p>[</span>
                    <span class=n>entry</span><span class=o>.</span><span class=n>name</span>
                    <span class=k>for</span> <span class=n>entry</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_polyDT_root_path</span><span class=o>.</span><span class=n>iterdir</span><span class=p>()</span>
                    <span class=k>if</span> <span class=n>entry</span><span class=o>.</span><span class=n>is_dir</span><span class=p>()</span>
                <span class=p>],</span>
                <span class=n>key</span><span class=o>=</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=nb>int</span><span class=p>(</span><span class=n>x</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&quot;tile&quot;</span><span class=p>)[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&quot;.zarr&quot;</span><span class=p>)[</span><span class=mi>0</span><span class=p>]),</span>
            <span class=p>)</span>
            <span class=n>current_tile_dir_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_polyDT_root_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span>
                <span class=n>polyDT_tile_ids</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
            <span class=p>)</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_round_ids</span> <span class=o>=</span> <span class=nb>sorted</span><span class=p>(</span>
                <span class=p>[</span>
                    <span class=n>entry</span><span class=o>.</span><span class=n>name</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&quot;.&quot;</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
                    <span class=k>for</span> <span class=n>entry</span> <span class=ow>in</span> <span class=n>current_tile_dir_path</span><span class=o>.</span><span class=n>iterdir</span><span class=p>()</span>
                    <span class=k>if</span> <span class=n>entry</span><span class=o>.</span><span class=n>is_dir</span><span class=p>()</span>
                <span class=p>],</span>
                <span class=n>key</span><span class=o>=</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=nb>int</span><span class=p>(</span><span class=n>x</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&quot;round&quot;</span><span class=p>)[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&quot;.zarr&quot;</span><span class=p>)[</span><span class=mi>0</span><span class=p>]),</span>
            <span class=p>)</span>
        <span class=k>if</span> <span class=ow>not</span> <span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_readouts_root_path</span><span class=o>.</span><span class=n>exists</span><span class=p>()):</span>
            <span class=k>raise</span> <span class=ne>FileNotFoundError</span><span class=p>(</span><span class=s2>&quot;Readout directory not initialized&quot;</span><span class=p>)</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>readout_tile_ids</span> <span class=o>=</span> <span class=nb>sorted</span><span class=p>(</span>
                <span class=p>[</span>
                    <span class=n>entry</span><span class=o>.</span><span class=n>name</span>
                    <span class=k>for</span> <span class=n>entry</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_readouts_root_path</span><span class=o>.</span><span class=n>iterdir</span><span class=p>()</span>
                    <span class=k>if</span> <span class=n>entry</span><span class=o>.</span><span class=n>is_dir</span><span class=p>()</span>
                <span class=p>],</span>
                <span class=n>key</span><span class=o>=</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=nb>int</span><span class=p>(</span><span class=n>x</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&quot;tile&quot;</span><span class=p>)[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&quot;.zarr&quot;</span><span class=p>)[</span><span class=mi>0</span><span class=p>]),</span>
            <span class=p>)</span>
            <span class=n>current_tile_dir_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_readouts_root_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span>
                <span class=n>readout_tile_ids</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
            <span class=p>)</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span> <span class=o>=</span> <span class=nb>sorted</span><span class=p>(</span>
                <span class=p>[</span>
                    <span class=n>entry</span><span class=o>.</span><span class=n>name</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&quot;.&quot;</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
                    <span class=k>for</span> <span class=n>entry</span> <span class=ow>in</span> <span class=n>current_tile_dir_path</span><span class=o>.</span><span class=n>iterdir</span><span class=p>()</span>
                    <span class=k>if</span> <span class=n>entry</span><span class=o>.</span><span class=n>is_dir</span><span class=p>()</span>
                <span class=p>],</span>
                <span class=n>key</span><span class=o>=</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=nb>int</span><span class=p>(</span><span class=n>x</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&quot;bit&quot;</span><span class=p>)[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&quot;.zarr&quot;</span><span class=p>)[</span><span class=mi>0</span><span class=p>]),</span>
            <span class=p>)</span>
        <span class=k>assert</span> <span class=p>(</span>
            <span class=n>polyDT_tile_ids</span> <span class=o>==</span> <span class=n>readout_tile_ids</span>
        <span class=p>),</span> <span class=s2>&quot;polyDT and readout tile ids do not match. Conversion error.&quot;</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span> <span class=o>=</span> <span class=n>polyDT_tile_ids</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>
        <span class=k>del</span> <span class=n>polyDT_tile_ids</span><span class=p>,</span> <span class=n>readout_tile_ids</span>

        <span class=k>for</span> <span class=n>tile_id</span><span class=p>,</span> <span class=n>round_id</span> <span class=ow>in</span> <span class=n>product</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>_round_ids</span><span class=p>):</span>
            <span class=k>try</span><span class=p>:</span>
                <span class=n>zattrs_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>_polyDT_root_path</span>
                    <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
                    <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>round_id</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
                    <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;.zattrs&quot;</span><span class=p>)</span>
                <span class=p>)</span>
                <span class=n>attributes</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_json</span><span class=p>(</span><span class=n>zattrs_path</span><span class=p>)</span>
            <span class=k>except</span> <span class=p>(</span><span class=ne>FileNotFoundError</span><span class=p>,</span> <span class=n>json</span><span class=o>.</span><span class=n>JSONDecodeError</span><span class=p>):</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;polyDT tile attributes not found&quot;</span><span class=p>)</span>

            <span class=n>keys_to_check</span> <span class=o>=</span> <span class=p>[</span>
                <span class=s2>&quot;stage_zyx_um&quot;</span><span class=p>,</span>
                <span class=s2>&quot;excitation_um&quot;</span><span class=p>,</span>
                <span class=s2>&quot;emission_um&quot;</span><span class=p>,</span>
                <span class=s2>&quot;bit_linker&quot;</span><span class=p>,</span>
                <span class=c1># &quot;exposure_ms&quot;,</span>
                <span class=s2>&quot;psf_idx&quot;</span><span class=p>,</span>
            <span class=p>]</span>

            <span class=k>for</span> <span class=n>key</span> <span class=ow>in</span> <span class=n>keys_to_check</span><span class=p>:</span>
                <span class=k>if</span> <span class=n>key</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>attributes</span><span class=o>.</span><span class=n>keys</span><span class=p>():</span>
                    <span class=nb>print</span><span class=p>(</span><span class=n>tile_id</span><span class=p>,</span> <span class=n>round_id</span><span class=p>,</span> <span class=n>key</span><span class=p>)</span>
                    <span class=k>raise</span> <span class=ne>KeyError</span><span class=p>(</span><span class=s2>&quot;Corrected polyDT attributes incomplete&quot;</span><span class=p>)</span>

            <span class=n>current_local_zarr_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_polyDT_root_path</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>round_id</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;corrected_data&quot;</span><span class=p>)</span>
            <span class=p>)</span>

            <span class=k>try</span><span class=p>:</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_check_for_zarr_array</span><span class=p>(</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>_get_kvstore_key</span><span class=p>(</span><span class=n>current_local_zarr_path</span><span class=p>),</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>_zarrv2_spec</span><span class=o>.</span><span class=n>copy</span><span class=p>(),</span>
                <span class=p>)</span>
            <span class=k>except</span> <span class=p>(</span><span class=ne>IOError</span><span class=p>,</span> <span class=ne>OSError</span><span class=p>,</span> <span class=n>ZarrError</span><span class=p>):</span>
                <span class=nb>print</span><span class=p>(</span><span class=n>tile_id</span><span class=p>,</span> <span class=n>round_id</span><span class=p>)</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Corrected polyDT data missing.&quot;</span><span class=p>)</span>

        <span class=k>for</span> <span class=n>tile_id</span><span class=p>,</span> <span class=n>bit_id</span> <span class=ow>in</span> <span class=n>product</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>):</span>
            <span class=k>try</span><span class=p>:</span>
                <span class=n>zattrs_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>_readouts_root_path</span>
                    <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
                    <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>bit_id</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
                    <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;.zattrs&quot;</span><span class=p>)</span>
                <span class=p>)</span>
                <span class=n>attributes</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_json</span><span class=p>(</span><span class=n>zattrs_path</span><span class=p>)</span>
            <span class=k>except</span> <span class=p>(</span><span class=ne>FileNotFoundError</span><span class=p>,</span> <span class=n>json</span><span class=o>.</span><span class=n>JSONDecodeError</span><span class=p>):</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Readout tile attributes not found&quot;</span><span class=p>)</span>

            <span class=n>keys_to_check</span> <span class=o>=</span> <span class=p>[</span>
                <span class=s2>&quot;excitation_um&quot;</span><span class=p>,</span>
                <span class=s2>&quot;emission_um&quot;</span><span class=p>,</span>
                <span class=s2>&quot;round_linker&quot;</span><span class=p>,</span>
                <span class=c1># &quot;exposure_ms&quot;,</span>
                <span class=s2>&quot;psf_idx&quot;</span><span class=p>,</span>
            <span class=p>]</span>
            <span class=k>for</span> <span class=n>key</span> <span class=ow>in</span> <span class=n>keys_to_check</span><span class=p>:</span>
                <span class=k>if</span> <span class=n>key</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>attributes</span><span class=o>.</span><span class=n>keys</span><span class=p>():</span>
                    <span class=k>raise</span> <span class=ne>KeyError</span><span class=p>(</span><span class=s2>&quot;Corrected readout attributes incomplete&quot;</span><span class=p>)</span>

            <span class=n>current_local_zarr_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_readouts_root_path</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>bit_id</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;corrected_data&quot;</span><span class=p>)</span>
            <span class=p>)</span>

            <span class=k>try</span><span class=p>:</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_check_for_zarr_array</span><span class=p>(</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>_get_kvstore_key</span><span class=p>(</span><span class=n>current_local_zarr_path</span><span class=p>),</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>_zarrv2_spec</span><span class=o>.</span><span class=n>copy</span><span class=p>(),</span>
                <span class=p>)</span>
            <span class=k>except</span> <span class=p>(</span><span class=ne>IOError</span><span class=p>,</span> <span class=ne>OSError</span><span class=p>,</span> <span class=n>ZarrError</span><span class=p>):</span>
                <span class=nb>print</span><span class=p>(</span><span class=n>tile_id</span><span class=p>,</span> <span class=n>bit_id</span><span class=p>)</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Corrected readout data missing.&quot;</span><span class=p>)</span>

    <span class=c1># check and validate local registered data</span>
    <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_state</span><span class=p>[</span><span class=s2>&quot;LocalRegistered&quot;</span><span class=p>]:</span>
        <span class=k>for</span> <span class=n>tile_id</span><span class=p>,</span> <span class=n>round_id</span> <span class=ow>in</span> <span class=n>product</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>_round_ids</span><span class=p>):</span>
            <span class=k>if</span> <span class=n>round_id</span> <span class=ow>is</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>_round_ids</span><span class=p>[</span><span class=mi>0</span><span class=p>]:</span>
                <span class=k>try</span><span class=p>:</span>
                    <span class=n>zattrs_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
                        <span class=bp>self</span><span class=o>.</span><span class=n>_polyDT_root_path</span>
                        <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
                        <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>round_id</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
                        <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;.zattrs&quot;</span><span class=p>)</span>
                    <span class=p>)</span>
                    <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>zattrs_path</span><span class=p>,</span> <span class=s2>&quot;r&quot;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
                        <span class=n>attributes</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=n>f</span><span class=p>)</span>
                <span class=k>except</span> <span class=p>(</span><span class=ne>FileNotFoundError</span><span class=p>,</span> <span class=n>json</span><span class=o>.</span><span class=n>JSONDecodeError</span><span class=p>):</span>
                    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;polyDT tile attributes not found&quot;</span><span class=p>)</span>

                <span class=n>keys_to_check</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&quot;rigid_xform_xyz_px&quot;</span><span class=p>]</span>

                <span class=k>for</span> <span class=n>key</span> <span class=ow>in</span> <span class=n>keys_to_check</span><span class=p>:</span>
                    <span class=k>if</span> <span class=n>key</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>attributes</span><span class=o>.</span><span class=n>keys</span><span class=p>():</span>
                        <span class=k>raise</span> <span class=ne>KeyError</span><span class=p>(</span><span class=s2>&quot;Rigid registration missing&quot;</span><span class=p>)</span>

                <span class=n>current_local_zarr_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>_polyDT_root_path</span>
                    <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
                    <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>round_id</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
                    <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;of_xform_px&quot;</span><span class=p>)</span>
                <span class=p>)</span>

                <span class=k>try</span><span class=p>:</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>_check_for_zarr_array</span><span class=p>(</span>
                        <span class=bp>self</span><span class=o>.</span><span class=n>_get_kvstore_key</span><span class=p>(</span><span class=n>current_local_zarr_path</span><span class=p>),</span>
                        <span class=bp>self</span><span class=o>.</span><span class=n>_zarrv2_spec</span><span class=o>.</span><span class=n>copy</span><span class=p>(),</span>
                    <span class=p>)</span>
                <span class=k>except</span> <span class=p>(</span><span class=ne>IOError</span><span class=p>,</span> <span class=ne>OSError</span><span class=p>,</span> <span class=n>ZarrError</span><span class=p>):</span>
                    <span class=nb>print</span><span class=p>(</span><span class=n>tile_id</span><span class=p>,</span> <span class=n>round_id</span><span class=p>)</span>
                    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Optical flow registration data missing.&quot;</span><span class=p>)</span>

            <span class=n>current_local_zarr_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_polyDT_root_path</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>round_id</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;registered_decon_data&quot;</span><span class=p>)</span>
            <span class=p>)</span>
            <span class=k>if</span> <span class=n>round_id</span> <span class=ow>is</span> <span class=bp>self</span><span class=o>.</span><span class=n>_round_ids</span><span class=p>[</span><span class=mi>0</span><span class=p>]:</span>
                <span class=k>try</span><span class=p>:</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>_check_for_zarr_array</span><span class=p>(</span>
                        <span class=bp>self</span><span class=o>.</span><span class=n>_get_kvstore_key</span><span class=p>(</span><span class=n>current_local_zarr_path</span><span class=p>),</span>
                        <span class=bp>self</span><span class=o>.</span><span class=n>_zarrv2_spec</span><span class=o>.</span><span class=n>copy</span><span class=p>(),</span>
                    <span class=p>)</span>
                <span class=k>except</span> <span class=p>(</span><span class=ne>IOError</span><span class=p>,</span> <span class=ne>OSError</span><span class=p>,</span> <span class=n>ZarrError</span><span class=p>):</span>
                    <span class=nb>print</span><span class=p>(</span><span class=n>tile_id</span><span class=p>,</span> <span class=n>round_id</span><span class=p>)</span>
                    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Registered polyDT data missing.&quot;</span><span class=p>)</span>

        <span class=k>for</span> <span class=n>tile_id</span><span class=p>,</span> <span class=n>bit_id</span> <span class=ow>in</span> <span class=n>product</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>):</span>
            <span class=n>current_local_zarr_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_readouts_root_path</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>bit_id</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;registered_decon_data&quot;</span><span class=p>)</span>
            <span class=p>)</span>

            <span class=k>try</span><span class=p>:</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_check_for_zarr_array</span><span class=p>(</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>_get_kvstore_key</span><span class=p>(</span><span class=n>current_local_zarr_path</span><span class=p>),</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>_zarrv2_spec</span><span class=o>.</span><span class=n>copy</span><span class=p>(),</span>
                <span class=p>)</span>
            <span class=k>except</span> <span class=p>(</span><span class=ne>IOError</span><span class=p>,</span> <span class=ne>OSError</span><span class=p>,</span> <span class=n>ZarrError</span><span class=p>):</span>
                <span class=nb>print</span><span class=p>(</span><span class=n>tile_id</span><span class=p>,</span> <span class=n>round_id</span><span class=p>)</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Registered readout data missing.&quot;</span><span class=p>)</span>

            <span class=n>current_local_zarr_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_readouts_root_path</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>bit_id</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;registered_ufish_data&quot;</span><span class=p>)</span>
            <span class=p>)</span>

            <span class=k>try</span><span class=p>:</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_check_for_zarr_array</span><span class=p>(</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>_get_kvstore_key</span><span class=p>(</span><span class=n>current_local_zarr_path</span><span class=p>),</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>_zarrv2_spec</span><span class=o>.</span><span class=n>copy</span><span class=p>(),</span>
                <span class=p>)</span>
            <span class=k>except</span> <span class=p>(</span><span class=ne>IOError</span><span class=p>,</span> <span class=ne>OSError</span><span class=p>,</span> <span class=n>ZarrError</span><span class=p>):</span>
                <span class=nb>print</span><span class=p>(</span><span class=n>tile_id</span><span class=p>,</span> <span class=n>round_id</span><span class=p>)</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Registered ufish prediction missing.&quot;</span><span class=p>)</span>

        <span class=k>for</span> <span class=n>tile_id</span><span class=p>,</span> <span class=n>bit_id</span> <span class=ow>in</span> <span class=n>product</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>):</span>
            <span class=n>current_ufish_path</span> <span class=o>=</span> <span class=p>(</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_ufish_localizations_root_path</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>bit_id</span> <span class=o>+</span> <span class=s2>&quot;.parquet&quot;</span><span class=p>)</span>
            <span class=p>)</span>
            <span class=k>if</span> <span class=ow>not</span> <span class=p>(</span><span class=n>current_ufish_path</span><span class=o>.</span><span class=n>exists</span><span class=p>()):</span>
                <span class=k>raise</span> <span class=ne>FileNotFoundError</span><span class=p>(</span>
                    <span class=n>tile_id</span> <span class=o>+</span> <span class=s2>&quot; &quot;</span> <span class=o>+</span> <span class=n>bit_id</span> <span class=o>+</span> <span class=s2>&quot; ufish localization missing&quot;</span>
                <span class=p>)</span>

    <span class=c1># check and validate global registered data</span>
    <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_state</span><span class=p>[</span><span class=s2>&quot;GlobalRegistered&quot;</span><span class=p>]:</span>
        <span class=k>for</span> <span class=n>tile_id</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>:</span>
            <span class=k>try</span><span class=p>:</span>
                <span class=n>zattrs_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>_polyDT_root_path</span>
                    <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
                    <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_round_ids</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
                    <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;.zattrs&quot;</span><span class=p>)</span>
                <span class=p>)</span>
                <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>zattrs_path</span><span class=p>,</span> <span class=s2>&quot;r&quot;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
                    <span class=n>attributes</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=n>f</span><span class=p>)</span>
            <span class=k>except</span> <span class=p>(</span><span class=ne>FileNotFoundError</span><span class=p>,</span> <span class=n>json</span><span class=o>.</span><span class=n>JSONDecodeError</span><span class=p>):</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;polyDT tile attributes not found&quot;</span><span class=p>)</span>

            <span class=n>keys_to_check</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&quot;affine_zyx_um&quot;</span><span class=p>,</span> <span class=s2>&quot;origin_zyx_um&quot;</span><span class=p>,</span> <span class=s2>&quot;spacing_zyx_um&quot;</span><span class=p>]</span>

            <span class=k>for</span> <span class=n>key</span> <span class=ow>in</span> <span class=n>keys_to_check</span><span class=p>:</span>
                <span class=k>if</span> <span class=n>key</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>attributes</span><span class=o>.</span><span class=n>keys</span><span class=p>():</span>
                    <span class=k>raise</span> <span class=ne>KeyError</span><span class=p>(</span><span class=s2>&quot;Global registration missing&quot;</span><span class=p>)</span>

    <span class=c1># check and validate fused</span>
    <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_state</span><span class=p>[</span><span class=s2>&quot;Fused&quot;</span><span class=p>]:</span>
        <span class=k>try</span><span class=p>:</span>
            <span class=n>zattrs_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_fused_root_path</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;fused.zarr&quot;</span><span class=p>)</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;fused_polyDT_iso_zyx&quot;</span><span class=p>)</span>
                <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;.zattrs&quot;</span><span class=p>)</span>
            <span class=p>)</span>
            <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>zattrs_path</span><span class=p>,</span> <span class=s2>&quot;r&quot;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
                <span class=n>attributes</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=n>f</span><span class=p>)</span>
        <span class=k>except</span> <span class=p>(</span><span class=ne>FileNotFoundError</span><span class=p>,</span> <span class=n>json</span><span class=o>.</span><span class=n>JSONDecodeError</span><span class=p>):</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Fused image attributes not found&quot;</span><span class=p>)</span>

        <span class=n>keys_to_check</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&quot;affine_zyx_um&quot;</span><span class=p>,</span> <span class=s2>&quot;origin_zyx_um&quot;</span><span class=p>,</span> <span class=s2>&quot;spacing_zyx_um&quot;</span><span class=p>]</span>

        <span class=k>for</span> <span class=n>key</span> <span class=ow>in</span> <span class=n>keys_to_check</span><span class=p>:</span>
            <span class=k>if</span> <span class=n>key</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>attributes</span><span class=o>.</span><span class=n>keys</span><span class=p>():</span>
                <span class=k>raise</span> <span class=ne>KeyError</span><span class=p>(</span><span class=s2>&quot;Fused image metadata missing&quot;</span><span class=p>)</span>

        <span class=n>current_local_zarr_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_fused_root_path</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;fused.zarr&quot;</span><span class=p>)</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;fused_polyDT_iso_zyx&quot;</span><span class=p>)</span>
        <span class=p>)</span>

        <span class=k>try</span><span class=p>:</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_check_for_zarr_array</span><span class=p>(</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_get_kvstore_key</span><span class=p>(</span><span class=n>current_local_zarr_path</span><span class=p>),</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_zarrv2_spec</span><span class=o>.</span><span class=n>copy</span><span class=p>(),</span>
            <span class=p>)</span>
        <span class=k>except</span> <span class=p>(</span><span class=ne>IOError</span><span class=p>,</span> <span class=ne>OSError</span><span class=p>,</span> <span class=n>ZarrError</span><span class=p>):</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Fused data missing.&quot;</span><span class=p>)</span>

    <span class=c1># check and validate cellpose segmentation</span>
    <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_state</span><span class=p>[</span><span class=s2>&quot;SegmentedCells&quot;</span><span class=p>]:</span>
        <span class=n>current_local_zarr_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_segmentation_root_path</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;cellpose&quot;</span><span class=p>)</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;cellpose.zarr&quot;</span><span class=p>)</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;masks_polyDT_iso_zyx&quot;</span><span class=p>)</span>
        <span class=p>)</span>

        <span class=k>try</span><span class=p>:</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_check_for_zarr_array</span><span class=p>(</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_get_kvstore_key</span><span class=p>(</span><span class=n>current_local_zarr_path</span><span class=p>),</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_zarrv2_spec</span><span class=o>.</span><span class=n>copy</span><span class=p>(),</span>
            <span class=p>)</span>
        <span class=k>except</span> <span class=p>(</span><span class=ne>IOError</span><span class=p>,</span> <span class=ne>OSError</span><span class=p>,</span> <span class=n>ZarrError</span><span class=p>):</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Cellpose data missing.&quot;</span><span class=p>)</span>

        <span class=n>cell_outlines_path</span> <span class=o>=</span> <span class=p>(</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_segmentation_root_path</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;cellpose&quot;</span><span class=p>)</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;imagej_rois&quot;</span><span class=p>)</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;global_coords_rois.zip&quot;</span><span class=p>)</span>
        <span class=p>)</span>
        <span class=k>if</span> <span class=ow>not</span> <span class=p>(</span><span class=n>cell_outlines_path</span><span class=o>.</span><span class=n>exists</span><span class=p>()):</span>
            <span class=k>raise</span> <span class=ne>FileNotFoundError</span><span class=p>(</span><span class=s2>&quot;Cellpose cell outlines missing.&quot;</span><span class=p>)</span>

    <span class=c1># check and validate decoded spots</span>
    <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_state</span><span class=p>[</span><span class=s2>&quot;DecodedSpots&quot;</span><span class=p>]:</span>
        <span class=k>for</span> <span class=n>tile_id</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>:</span>
            <span class=n>decoded_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_decoded_root_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span>
                <span class=n>tile_id</span> <span class=o>+</span> <span class=s2>&quot;_decoded_features.parquet&quot;</span>
            <span class=p>)</span>

            <span class=k>if</span> <span class=ow>not</span> <span class=p>(</span><span class=n>decoded_path</span><span class=o>.</span><span class=n>exists</span><span class=p>()):</span>
                <span class=k>raise</span> <span class=ne>FileNotFoundError</span><span class=p>(</span><span class=n>tile_id</span> <span class=o>+</span> <span class=s2>&quot; decoded spots missing.&quot;</span><span class=p>)</span>

    <span class=c1># check and validate filtered decoded spots</span>
    <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_state</span><span class=p>[</span><span class=s2>&quot;FilteredSpots&quot;</span><span class=p>]:</span>
        <span class=n>filtered_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_decoded_root_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span>
            <span class=s2>&quot;all_tiles_filtered_decoded_features.parquet&quot;</span>
        <span class=p>)</span>

        <span class=k>if</span> <span class=ow>not</span> <span class=p>(</span><span class=n>filtered_path</span><span class=o>.</span><span class=n>exists</span><span class=p>()):</span>
            <span class=k>raise</span> <span class=ne>FileNotFoundError</span><span class=p>(</span><span class=s2>&quot;filtered decoded spots missing.&quot;</span><span class=p>)</span>

    <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_state</span><span class=p>[</span><span class=s2>&quot;RefinedSpots&quot;</span><span class=p>]:</span>
        <span class=n>baysor_spots_path</span> <span class=o>=</span> <span class=p>(</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_segmentation_root_path</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;baysor&quot;</span><span class=p>)</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;segmentation.csv&quot;</span><span class=p>)</span>
        <span class=p>)</span>

        <span class=k>if</span> <span class=ow>not</span> <span class=p>(</span><span class=n>baysor_spots_path</span><span class=o>.</span><span class=n>exists</span><span class=p>()):</span>
            <span class=k>raise</span> <span class=ne>FileNotFoundError</span><span class=p>(</span><span class=s2>&quot;Baysor filtered decoded spots missing.&quot;</span><span class=p>)</span>

    <span class=c1># check and validate mtx</span>
    <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_state</span><span class=p>[</span><span class=s2>&quot;mtxOutput&quot;</span><span class=p>]:</span>
        <span class=n>mtx_barcodes_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_mtx_output_root_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;barcodes.tsv.gz&quot;</span><span class=p>)</span>
        <span class=n>mtx_features_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_mtx_output_root_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;features.tsv.gz&quot;</span><span class=p>)</span>
        <span class=n>mtx_matrix_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_mtx_output_root_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;matrix.tsv.gz&quot;</span><span class=p>)</span>

        <span class=k>if</span> <span class=p>(</span>
            <span class=ow>not</span> <span class=p>(</span><span class=n>mtx_barcodes_path</span><span class=o>.</span><span class=n>exists</span><span class=p>())</span>
            <span class=ow>or</span> <span class=ow>not</span> <span class=p>(</span><span class=n>mtx_features_path</span><span class=o>.</span><span class=n>exists</span><span class=p>())</span>
            <span class=ow>or</span> <span class=ow>not</span> <span class=p>(</span><span class=n>mtx_matrix_path</span><span class=o>.</span><span class=n>exists</span><span class=p>())</span>
        <span class=p>):</span>
            <span class=k>raise</span> <span class=ne>FileNotFoundError</span><span class=p>(</span><span class=s2>&quot;mtx output missing.&quot;</span><span class=p>)</span>

    <span class=k>try</span><span class=p>:</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_baysor_path</span> <span class=o>=</span> <span class=n>Path</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_datastore_state</span><span class=p>[</span><span class=s2>&quot;BaysorPath&quot;</span><span class=p>]))</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_baysor_options</span> <span class=o>=</span> <span class=n>Path</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_datastore_state</span><span class=p>[</span><span class=s2>&quot;BaysorOptions&quot;</span><span class=p>]))</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_julia_threads</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_datastore_state</span><span class=p>[</span><span class=s2>&quot;JuliaThreads&quot;</span><span class=p>])</span>
    <span class=k>except</span> <span class=ne>KeyError</span><span class=p>:</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_baysor_path</span> <span class=o>=</span> <span class=sa>r</span><span class=s2>&quot;&quot;</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_baysor_options</span> <span class=o>=</span> <span class=sa>r</span><span class=s2>&quot;&quot;</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_julia_threads</span> <span class=o>=</span> <span class=mi>1</span>
</code></pre></div></td></tr></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id=merfish3danalysis.qi2labDataStore.qi2labDataStore._save_to_json class="doc doc-heading"> <code class="highlight language-python"><span class=n>_save_to_json</span><span class=p>(</span><span class=n>dictionary</span><span class=p>,</span> <span class=n>dictionary_path</span><span class=p>)</span></code> <span class="doc doc-labels"> <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small> </span> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore._save_to_json class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-contents "> <p>Save dictionary to json.</p> <p><span class=doc-section-title>Parameters:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> <th>Default</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td> <code>dictionary</code> </td> <td> <code>dict</code> </td> <td> <div class=doc-md-description> <p>The data to be saved.</p> </div> </td> <td> <em>required</em> </td> </tr> <tr class=doc-section-item> <td> <code>dictionary_path</code> </td> <td> <code><span title="typing.Union">Union</span>[<span title="pathlib.Path">Path</span>, str]</code> </td> <td> <div class=doc-md-description> <p>The path to the JSON file where the data will be saved.</p> </div> </td> <td> <em>required</em> </td> </tr> </tbody> </table> <details class=quote> <summary>Source code in <code>src/merfish3danalysis/qi2labDataStore.py</code></summary> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1018</span>
<span class=normal>1019</span>
<span class=normal>1020</span>
<span class=normal>1021</span>
<span class=normal>1022</span>
<span class=normal>1023</span>
<span class=normal>1024</span>
<span class=normal>1025</span>
<span class=normal>1026</span>
<span class=normal>1027</span>
<span class=normal>1028</span>
<span class=normal>1029</span>
<span class=normal>1030</span>
<span class=normal>1031</span></pre></div></td><td class=code><div><pre><span></span><code><span class=nd>@staticmethod</span>
<span class=k>def</span> <span class=nf>_save_to_json</span><span class=p>(</span><span class=n>dictionary</span><span class=p>:</span> <span class=nb>dict</span><span class=p>,</span> <span class=n>dictionary_path</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=n>Path</span><span class=p>,</span> <span class=nb>str</span><span class=p>]):</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Save dictionary to json.</span>

<span class=sd>    Parameters</span>
<span class=sd>    ----------</span>
<span class=sd>    dictionary : dict</span>
<span class=sd>        The data to be saved.</span>
<span class=sd>    dictionary_path : Union[Path,str]</span>
<span class=sd>        The path to the JSON file where the data will be saved.</span>
<span class=sd>    &quot;&quot;&quot;</span>

    <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>dictionary_path</span><span class=p>,</span> <span class=s2>&quot;w&quot;</span><span class=p>)</span> <span class=k>as</span> <span class=n>file</span><span class=p>:</span>
        <span class=n>json</span><span class=o>.</span><span class=n>dump</span><span class=p>(</span><span class=n>dictionary</span><span class=p>,</span> <span class=n>file</span><span class=p>,</span> <span class=n>indent</span><span class=o>=</span><span class=mi>4</span><span class=p>)</span>
</code></pre></div></td></tr></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id=merfish3danalysis.qi2labDataStore.qi2labDataStore._save_to_parquet class="doc doc-heading"> <code class="highlight language-python"><span class=n>_save_to_parquet</span><span class=p>(</span><span class=n>df</span><span class=p>,</span> <span class=n>parquet_path</span><span class=p>)</span></code> <span class="doc doc-labels"> <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small> </span> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore._save_to_parquet class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-contents "> <p>Save dataframe to parquet.</p> <p><span class=doc-section-title>Parameters:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> <th>Default</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td> <code>df</code> </td> <td> <code><span title="pandas.DataFrame">DataFrame</span></code> </td> <td> <div class=doc-md-description> <p>Dataframe to save.</p> </div> </td> <td> <em>required</em> </td> </tr> <tr class=doc-section-item> <td> <code>parquet_path</code> </td> <td> <code><span title="typing.Union">Union</span>[<span title="pathlib.Path">Path</span>, str]</code> </td> <td> <div class=doc-md-description> <p>Path to parquet file.</p> </div> </td> <td> <em>required</em> </td> </tr> </tbody> </table> <details class=quote> <summary>Source code in <code>src/merfish3danalysis/qi2labDataStore.py</code></summary> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1204</span>
<span class=normal>1205</span>
<span class=normal>1206</span>
<span class=normal>1207</span>
<span class=normal>1208</span>
<span class=normal>1209</span>
<span class=normal>1210</span>
<span class=normal>1211</span>
<span class=normal>1212</span>
<span class=normal>1213</span>
<span class=normal>1214</span>
<span class=normal>1215</span>
<span class=normal>1216</span></pre></div></td><td class=code><div><pre><span></span><code><span class=nd>@staticmethod</span>
<span class=k>def</span> <span class=nf>_save_to_parquet</span><span class=p>(</span><span class=n>df</span><span class=p>:</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>,</span> <span class=n>parquet_path</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=n>Path</span><span class=p>,</span> <span class=nb>str</span><span class=p>]):</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Save dataframe to parquet.</span>

<span class=sd>    Parameters</span>
<span class=sd>    ----------</span>
<span class=sd>    df : pd.DataFrame</span>
<span class=sd>        Dataframe to save.</span>
<span class=sd>    parquet_path : Union[Path, str]</span>
<span class=sd>        Path to parquet file.</span>
<span class=sd>    &quot;&quot;&quot;</span>

    <span class=n>df</span><span class=o>.</span><span class=n>to_parquet</span><span class=p>(</span><span class=n>parquet_path</span><span class=p>)</span>
</code></pre></div></td></tr></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id=merfish3danalysis.qi2labDataStore.qi2labDataStore._save_to_zarr_array class="doc doc-heading"> <code class="highlight language-python"><span class=n>_save_to_zarr_array</span><span class=p>(</span><span class=n>array</span><span class=p>,</span> <span class=n>kvstore</span><span class=p>,</span> <span class=n>spec</span><span class=p>,</span> <span class=n>return_future</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span></code> <span class="doc doc-labels"> <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small> </span> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore._save_to_zarr_array class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-contents "> <p>Save array to zarr using tensorstore.</p> <p>Defaults to returning future result.</p> <p><span class=doc-section-title>Parameters:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> <th>Default</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td> <code>array</code> </td> <td> <code><span title="numpy.typing.ArrayLike">ArrayLike</span></code> </td> <td> <div class=doc-md-description> <p>Array to save.</p> </div> </td> <td> <em>required</em> </td> </tr> <tr class=doc-section-item> <td> <code>kvstore</code> </td> <td> <code>dict</code> </td> <td> <div class=doc-md-description> <p>Tensorstore kvstore specification.</p> </div> </td> <td> <em>required</em> </td> </tr> <tr class=doc-section-item> <td> <code>spec</code> </td> <td> <code>dict</code> </td> <td> <div class=doc-md-description> <p>Tensorstore zarr specification.</p> </div> </td> <td> <em>required</em> </td> </tr> <tr class=doc-section-item> <td> <code>return_future</code> </td> <td> <code><span title="typing.Optional">Optional</span>[bool]</code> </td> <td> <div class=doc-md-description> <p>Return future (True) or immediately write (False).</p> </div> </td> <td> <code>False</code> </td> </tr> </tbody> </table> <p><span class=doc-section-title>Returns:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td><code>write_future</code></td> <td> <code><span title="typing.Optional">Optional</span>[<span title="numpy.typing.ArrayLike">ArrayLike</span>]</code> </td> <td> <div class=doc-md-description> <p>Delayed (future) if return_future is True.</p> </div> </td> </tr> </tbody> </table> <details class=quote> <summary>Source code in <code>src/merfish3danalysis/qi2labDataStore.py</code></summary> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1118</span>
<span class=normal>1119</span>
<span class=normal>1120</span>
<span class=normal>1121</span>
<span class=normal>1122</span>
<span class=normal>1123</span>
<span class=normal>1124</span>
<span class=normal>1125</span>
<span class=normal>1126</span>
<span class=normal>1127</span>
<span class=normal>1128</span>
<span class=normal>1129</span>
<span class=normal>1130</span>
<span class=normal>1131</span>
<span class=normal>1132</span>
<span class=normal>1133</span>
<span class=normal>1134</span>
<span class=normal>1135</span>
<span class=normal>1136</span>
<span class=normal>1137</span>
<span class=normal>1138</span>
<span class=normal>1139</span>
<span class=normal>1140</span>
<span class=normal>1141</span>
<span class=normal>1142</span>
<span class=normal>1143</span>
<span class=normal>1144</span>
<span class=normal>1145</span>
<span class=normal>1146</span>
<span class=normal>1147</span>
<span class=normal>1148</span>
<span class=normal>1149</span>
<span class=normal>1150</span>
<span class=normal>1151</span>
<span class=normal>1152</span>
<span class=normal>1153</span>
<span class=normal>1154</span>
<span class=normal>1155</span>
<span class=normal>1156</span>
<span class=normal>1157</span>
<span class=normal>1158</span>
<span class=normal>1159</span>
<span class=normal>1160</span>
<span class=normal>1161</span>
<span class=normal>1162</span>
<span class=normal>1163</span>
<span class=normal>1164</span>
<span class=normal>1165</span>
<span class=normal>1166</span>
<span class=normal>1167</span>
<span class=normal>1168</span>
<span class=normal>1169</span>
<span class=normal>1170</span>
<span class=normal>1171</span>
<span class=normal>1172</span>
<span class=normal>1173</span>
<span class=normal>1174</span>
<span class=normal>1175</span>
<span class=normal>1176</span>
<span class=normal>1177</span>
<span class=normal>1178</span>
<span class=normal>1179</span>
<span class=normal>1180</span>
<span class=normal>1181</span>
<span class=normal>1182</span>
<span class=normal>1183</span>
<span class=normal>1184</span>
<span class=normal>1185</span></pre></div></td><td class=code><div><pre><span></span><code><span class=nd>@staticmethod</span>
<span class=k>def</span> <span class=nf>_save_to_zarr_array</span><span class=p>(</span>
    <span class=n>array</span><span class=p>:</span> <span class=n>ArrayLike</span><span class=p>,</span>
    <span class=n>kvstore</span><span class=p>:</span> <span class=nb>dict</span><span class=p>,</span>
    <span class=n>spec</span><span class=p>:</span> <span class=nb>dict</span><span class=p>,</span>
    <span class=n>return_future</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>bool</span><span class=p>]</span> <span class=o>=</span> <span class=kc>False</span><span class=p>,</span>
<span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=n>ArrayLike</span><span class=p>]:</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Save array to zarr using tensorstore.</span>

<span class=sd>    Defaults to returning future result.</span>

<span class=sd>    Parameters</span>
<span class=sd>    ----------</span>
<span class=sd>    array : ArrayLike</span>
<span class=sd>        Array to save.</span>
<span class=sd>    kvstore : dict</span>
<span class=sd>        Tensorstore kvstore specification.</span>
<span class=sd>    spec : dict</span>
<span class=sd>        Tensorstore zarr specification.</span>
<span class=sd>    return_future : Optional[bool]</span>
<span class=sd>        Return future (True) or immediately write (False).</span>

<span class=sd>    Returns</span>
<span class=sd>    -------</span>
<span class=sd>    write_future : Optional[ArrayLike]</span>
<span class=sd>        Delayed (future) if return_future is True.</span>
<span class=sd>    &quot;&quot;&quot;</span>

    <span class=c1># check datatype</span>
    <span class=k>if</span> <span class=nb>str</span><span class=p>(</span><span class=n>array</span><span class=o>.</span><span class=n>dtype</span><span class=p>)</span> <span class=o>==</span> <span class=s2>&quot;uint8&quot;</span><span class=p>:</span>
        <span class=n>array_dtype</span> <span class=o>=</span> <span class=s2>&quot;&lt;u1&quot;</span>
    <span class=k>elif</span> <span class=nb>str</span><span class=p>(</span><span class=n>array</span><span class=o>.</span><span class=n>dtype</span><span class=p>)</span> <span class=o>==</span> <span class=s2>&quot;uint16&quot;</span><span class=p>:</span>
        <span class=n>array_dtype</span> <span class=o>=</span> <span class=s2>&quot;&lt;u2&quot;</span>
    <span class=k>elif</span> <span class=nb>str</span><span class=p>(</span><span class=n>array</span><span class=o>.</span><span class=n>dtype</span><span class=p>)</span> <span class=o>==</span> <span class=s2>&quot;float16&quot;</span><span class=p>:</span>
        <span class=n>array_dtype</span> <span class=o>=</span> <span class=s2>&quot;&lt;f2&quot;</span>
    <span class=k>elif</span> <span class=nb>str</span><span class=p>(</span><span class=n>array</span><span class=o>.</span><span class=n>dtype</span><span class=p>)</span> <span class=o>==</span> <span class=s2>&quot;float32&quot;</span><span class=p>:</span>
        <span class=n>array_dtype</span> <span class=o>=</span> <span class=s2>&quot;&lt;f4&quot;</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Unsupported data type: &quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=n>array</span><span class=o>.</span><span class=n>dtype</span><span class=p>))</span>
        <span class=k>return</span> <span class=kc>None</span>

    <span class=c1># check array dimension</span>
    <span class=n>spec</span><span class=p>[</span><span class=s2>&quot;metadata&quot;</span><span class=p>][</span><span class=s2>&quot;shape&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>array</span><span class=o>.</span><span class=n>shape</span>
    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>array</span><span class=o>.</span><span class=n>shape</span><span class=p>)</span> <span class=o>==</span> <span class=mi>2</span><span class=p>:</span>
        <span class=n>spec</span><span class=p>[</span><span class=s2>&quot;metadata&quot;</span><span class=p>][</span><span class=s2>&quot;chunks&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=p>[</span><span class=n>array</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>array</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>]]</span>
    <span class=k>elif</span> <span class=nb>len</span><span class=p>(</span><span class=n>array</span><span class=o>.</span><span class=n>shape</span><span class=p>)</span> <span class=o>==</span> <span class=mi>3</span><span class=p>:</span>
        <span class=n>spec</span><span class=p>[</span><span class=s2>&quot;metadata&quot;</span><span class=p>][</span><span class=s2>&quot;chunks&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=n>array</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>array</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>2</span><span class=p>]]</span>
    <span class=k>elif</span> <span class=nb>len</span><span class=p>(</span><span class=n>array</span><span class=o>.</span><span class=n>shape</span><span class=p>)</span> <span class=o>==</span> <span class=mi>4</span><span class=p>:</span>
        <span class=n>spec</span><span class=p>[</span><span class=s2>&quot;metadata&quot;</span><span class=p>][</span><span class=s2>&quot;chunks&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>array</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>array</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>2</span><span class=p>]]</span>
    <span class=n>spec</span><span class=p>[</span><span class=s2>&quot;metadata&quot;</span><span class=p>][</span><span class=s2>&quot;dtype&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>array_dtype</span>

    <span class=k>try</span><span class=p>:</span>
        <span class=n>current_zarr</span> <span class=o>=</span> <span class=n>ts</span><span class=o>.</span><span class=n>open</span><span class=p>(</span>
            <span class=p>{</span>
                <span class=o>**</span><span class=n>spec</span><span class=p>,</span>
                <span class=s2>&quot;kvstore&quot;</span><span class=p>:</span> <span class=n>kvstore</span><span class=p>,</span>
            <span class=p>}</span>
        <span class=p>)</span><span class=o>.</span><span class=n>result</span><span class=p>()</span>

        <span class=n>write_future</span> <span class=o>=</span> <span class=n>current_zarr</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>array</span><span class=p>)</span>

        <span class=k>if</span> <span class=n>return_future</span><span class=p>:</span>
            <span class=k>return</span> <span class=n>write_future</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>write_future</span><span class=o>.</span><span class=n>result</span><span class=p>()</span>
            <span class=k>return</span> <span class=kc>None</span>
    <span class=k>except</span> <span class=p>(</span><span class=ne>IOError</span><span class=p>,</span> <span class=ne>OSError</span><span class=p>,</span> <span class=ne>TimeoutError</span><span class=p>):</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Error writing zarr array.&quot;</span><span class=p>)</span>
</code></pre></div></td></tr></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id=merfish3danalysis.qi2labDataStore.qi2labDataStore.initialize_tile class="doc doc-heading"> <code class="highlight language-python"><span class=n>initialize_tile</span><span class=p>(</span><span class=n>tile</span><span class=p>)</span></code> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.initialize_tile class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-contents "> <p>Initialize directory structure for a tile.</p> <p><span class=doc-section-title>Parameters:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> <th>Default</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td> <code>tile</code> </td> <td> <code><span title="typing.Union">Union</span>[int, str]</code> </td> <td> <div class=doc-md-description> <p>Tile index or tile id.</p> </div> </td> <td> <em>required</em> </td> </tr> </tbody> </table> <details class=quote> <summary>Source code in <code>src/merfish3danalysis/qi2labDataStore.py</code></summary> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1696</span>
<span class=normal>1697</span>
<span class=normal>1698</span>
<span class=normal>1699</span>
<span class=normal>1700</span>
<span class=normal>1701</span>
<span class=normal>1702</span>
<span class=normal>1703</span>
<span class=normal>1704</span>
<span class=normal>1705</span>
<span class=normal>1706</span>
<span class=normal>1707</span>
<span class=normal>1708</span>
<span class=normal>1709</span>
<span class=normal>1710</span>
<span class=normal>1711</span>
<span class=normal>1712</span>
<span class=normal>1713</span>
<span class=normal>1714</span>
<span class=normal>1715</span>
<span class=normal>1716</span>
<span class=normal>1717</span>
<span class=normal>1718</span>
<span class=normal>1719</span>
<span class=normal>1720</span>
<span class=normal>1721</span>
<span class=normal>1722</span>
<span class=normal>1723</span>
<span class=normal>1724</span>
<span class=normal>1725</span>
<span class=normal>1726</span>
<span class=normal>1727</span>
<span class=normal>1728</span>
<span class=normal>1729</span>
<span class=normal>1730</span>
<span class=normal>1731</span>
<span class=normal>1732</span>
<span class=normal>1733</span>
<span class=normal>1734</span>
<span class=normal>1735</span>
<span class=normal>1736</span>
<span class=normal>1737</span>
<span class=normal>1738</span>
<span class=normal>1739</span>
<span class=normal>1740</span>
<span class=normal>1741</span>
<span class=normal>1742</span>
<span class=normal>1743</span>
<span class=normal>1744</span>
<span class=normal>1745</span>
<span class=normal>1746</span>
<span class=normal>1747</span>
<span class=normal>1748</span>
<span class=normal>1749</span>
<span class=normal>1750</span>
<span class=normal>1751</span>
<span class=normal>1752</span>
<span class=normal>1753</span>
<span class=normal>1754</span>
<span class=normal>1755</span>
<span class=normal>1756</span>
<span class=normal>1757</span>
<span class=normal>1758</span>
<span class=normal>1759</span>
<span class=normal>1760</span>
<span class=normal>1761</span>
<span class=normal>1762</span>
<span class=normal>1763</span>
<span class=normal>1764</span>
<span class=normal>1765</span>
<span class=normal>1766</span>
<span class=normal>1767</span>
<span class=normal>1768</span>
<span class=normal>1769</span>
<span class=normal>1770</span>
<span class=normal>1771</span>
<span class=normal>1772</span>
<span class=normal>1773</span>
<span class=normal>1774</span>
<span class=normal>1775</span>
<span class=normal>1776</span>
<span class=normal>1777</span>
<span class=normal>1778</span>
<span class=normal>1779</span></pre></div></td><td class=code><div><pre><span></span><code><span class=k>def</span> <span class=nf>initialize_tile</span><span class=p>(</span>
    <span class=bp>self</span><span class=p>,</span>
    <span class=n>tile</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>],</span>
<span class=p>):</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Initialize directory structure for a tile.</span>

<span class=sd>    Parameters</span>
<span class=sd>    ----------</span>
<span class=sd>    tile : Union[int, str]</span>
<span class=sd>        Tile index or tile id.</span>
<span class=sd>    &quot;&quot;&quot;</span>

    <span class=k>if</span> <span class=nb>getattr</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=s2>&quot;_experiment_order&quot;</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Assign experimental order before creating tiles.&quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>None</span>

    <span class=k>if</span> <span class=nb>getattr</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=s2>&quot;_num_tiles&quot;</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Assign number of tiles before creating tiles.&quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>None</span>

    <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
        <span class=k>if</span> <span class=n>tile</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>tile</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set tile index &gt;=0 and &lt;&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>))</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>tile_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>[</span><span class=n>tile</span><span class=p>]</span>
    <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
        <span class=k>if</span> <span class=n>tile</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;set valid tile id.&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>tile_id</span> <span class=o>=</span> <span class=n>tile</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;tile&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>None</span>

    <span class=k>try</span><span class=p>:</span>
        <span class=n>polyDT_tile_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_polyDT_root_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
        <span class=n>polyDT_tile_path</span><span class=o>.</span><span class=n>mkdir</span><span class=p>()</span>
        <span class=k>for</span> <span class=n>round_idx</span><span class=p>,</span> <span class=n>round_id</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_round_ids</span><span class=p>):</span>
            <span class=n>polyDT_round_path</span> <span class=o>=</span> <span class=n>polyDT_tile_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>round_id</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
            <span class=n>polyDT_round_path</span><span class=o>.</span><span class=n>mkdir</span><span class=p>()</span>
            <span class=n>polydt_round_attrs_path</span> <span class=o>=</span> <span class=n>polyDT_round_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;.zattrs&quot;</span><span class=p>)</span>
            <span class=n>round_attrs</span> <span class=o>=</span> <span class=p>{</span>
                <span class=s2>&quot;bit_linker&quot;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>_experiment_order</span><span class=o>.</span><span class=n>to_numpy</span><span class=p>()[</span><span class=n>round_idx</span><span class=p>,</span> <span class=mi>1</span><span class=p>:]</span>
                <span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=nb>int</span><span class=p>)</span>
                <span class=o>.</span><span class=n>tolist</span><span class=p>(),</span>
            <span class=p>}</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_save_to_json</span><span class=p>(</span><span class=n>round_attrs</span><span class=p>,</span> <span class=n>polydt_round_attrs_path</span><span class=p>)</span>
    <span class=k>except</span> <span class=ne>FileExistsError</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Error creating polyDT tile. Does it exist already?&quot;</span><span class=p>)</span>

    <span class=k>try</span><span class=p>:</span>
        <span class=n>readout_tile_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_readouts_root_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
        <span class=n>readout_tile_path</span><span class=o>.</span><span class=n>mkdir</span><span class=p>()</span>
        <span class=k>for</span> <span class=n>bit_idx</span><span class=p>,</span> <span class=n>bit_id</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>):</span>
            <span class=n>readout_bit_path</span> <span class=o>=</span> <span class=n>readout_tile_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>bit_id</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
            <span class=n>readout_bit_path</span><span class=o>.</span><span class=n>mkdir</span><span class=p>()</span>
            <span class=n>readout_bit_attrs_path</span> <span class=o>=</span> <span class=n>readout_bit_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;.zattrs&quot;</span><span class=p>)</span>
            <span class=n>fiducial_channel</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_channels_in_data</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
            <span class=n>readout_one_channel</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_channels_in_data</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span>

            <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_channels_in_data</span><span class=p>)</span> <span class=o>==</span> <span class=mi>3</span><span class=p>:</span>
                <span class=n>readout_two_channel</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_channels_in_data</span><span class=p>[</span><span class=mi>2</span><span class=p>])</span>
                <span class=n>condition_one</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_experiment_order</span><span class=p>[</span><span class=n>readout_one_channel</span><span class=p>]</span> <span class=o>==</span> <span class=p>(</span>
                    <span class=n>bit_idx</span> <span class=o>+</span> <span class=mi>1</span>
                <span class=p>)</span>
                <span class=n>condition_two</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_experiment_order</span><span class=p>[</span><span class=n>readout_two_channel</span><span class=p>]</span> <span class=o>==</span> <span class=p>(</span>
                    <span class=n>bit_idx</span> <span class=o>+</span> <span class=mi>1</span>
                <span class=p>)</span>
                <span class=n>combined_condition</span> <span class=o>=</span> <span class=n>condition_one</span> <span class=o>|</span> <span class=n>condition_two</span>

            <span class=k>else</span><span class=p>:</span>
                <span class=n>combined_condition</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_experiment_order</span><span class=p>[</span>
                    <span class=n>readout_one_channel</span>
                <span class=p>]</span> <span class=o>==</span> <span class=p>(</span><span class=n>bit_idx</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span>
            <span class=n>matching_rows</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_experiment_order</span><span class=o>.</span><span class=n>loc</span><span class=p>[</span><span class=n>combined_condition</span><span class=p>]</span>

            <span class=n>bit_attrs</span> <span class=o>=</span> <span class=p>{</span>
                <span class=s2>&quot;round_linker&quot;</span><span class=p>:</span> <span class=nb>int</span><span class=p>(</span><span class=n>matching_rows</span><span class=p>[</span><span class=n>fiducial_channel</span><span class=p>]</span><span class=o>.</span><span class=n>values</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
            <span class=p>}</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_save_to_json</span><span class=p>(</span><span class=n>bit_attrs</span><span class=p>,</span> <span class=n>readout_bit_attrs_path</span><span class=p>)</span>
    <span class=k>except</span> <span class=ne>FileExistsError</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Error creating readout tile. Does it exist already?&quot;</span><span class=p>)</span>
</code></pre></div></td></tr></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id=merfish3danalysis.qi2labDataStore.qi2labDataStore.load_codebook_parsed class="doc doc-heading"> <code class="highlight language-python"><span class=n>load_codebook_parsed</span><span class=p>()</span></code> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.load_codebook_parsed class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-contents "> <p>Load and split codebook into gene_ids and codebook matrix.</p> <p><span class=doc-section-title>Returns:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td><code>gene_ids</code></td> <td> <code><span title="typing.Collection">Collection</span>[str]</code> </td> <td> <div class=doc-md-description> <p>Gene IDs.</p> </div> </td> </tr> <tr class=doc-section-item> <td><code>codebook_matrix</code></td> <td> <code><span title="numpy.typing.ArrayLike">ArrayLike</span></code> </td> <td> <div class=doc-md-description> <p>Codebook matrix.</p> </div> </td> </tr> </tbody> </table> <details class=quote> <summary>Source code in <code>src/merfish3danalysis/qi2labDataStore.py</code></summary> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1666</span>
<span class=normal>1667</span>
<span class=normal>1668</span>
<span class=normal>1669</span>
<span class=normal>1670</span>
<span class=normal>1671</span>
<span class=normal>1672</span>
<span class=normal>1673</span>
<span class=normal>1674</span>
<span class=normal>1675</span>
<span class=normal>1676</span>
<span class=normal>1677</span>
<span class=normal>1678</span>
<span class=normal>1679</span>
<span class=normal>1680</span>
<span class=normal>1681</span>
<span class=normal>1682</span>
<span class=normal>1683</span>
<span class=normal>1684</span>
<span class=normal>1685</span>
<span class=normal>1686</span>
<span class=normal>1687</span>
<span class=normal>1688</span>
<span class=normal>1689</span>
<span class=normal>1690</span>
<span class=normal>1691</span>
<span class=normal>1692</span>
<span class=normal>1693</span>
<span class=normal>1694</span></pre></div></td><td class=code><div><pre><span></span><code><span class=k>def</span> <span class=nf>load_codebook_parsed</span><span class=p>(</span>
    <span class=bp>self</span><span class=p>,</span>
<span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>tuple</span><span class=p>[</span><span class=n>Collection</span><span class=p>[</span><span class=nb>str</span><span class=p>],</span> <span class=n>ArrayLike</span><span class=p>]]:</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Load and split codebook into gene_ids and codebook matrix.</span>

<span class=sd>    Returns</span>
<span class=sd>    -------</span>
<span class=sd>    gene_ids : Collection[str]</span>
<span class=sd>        Gene IDs.</span>
<span class=sd>    codebook_matrix : ArrayLike</span>
<span class=sd>        Codebook matrix.</span>
<span class=sd>    &quot;&quot;&quot;</span>

    <span class=k>try</span><span class=p>:</span>
        <span class=n>data</span> <span class=o>=</span> <span class=nb>getattr</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=s2>&quot;_codebook&quot;</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>

        <span class=k>if</span> <span class=n>data</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=n>num_columns</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span> <span class=k>if</span> <span class=n>data</span> <span class=k>else</span> <span class=mi>0</span>
        <span class=n>columns</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&quot;gene_id&quot;</span><span class=p>]</span> <span class=o>+</span> <span class=p>[</span><span class=sa>f</span><span class=s2>&quot;bit</span><span class=si>{</span><span class=n>i</span><span class=si>:</span><span class=s2>02d</span><span class=si>}</span><span class=s2>&quot;</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=n>num_columns</span><span class=p>)]</span>
        <span class=n>codebook_df</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=n>columns</span><span class=o>=</span><span class=n>columns</span><span class=p>)</span>

        <span class=n>gene_ids</span> <span class=o>=</span> <span class=n>codebook_df</span><span class=o>.</span><span class=n>iloc</span><span class=p>[:,</span> <span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>tolist</span><span class=p>()</span>
        <span class=n>codebook_matrix</span> <span class=o>=</span> <span class=n>codebook_df</span><span class=o>.</span><span class=n>iloc</span><span class=p>[:,</span> <span class=mi>1</span><span class=p>:]</span><span class=o>.</span><span class=n>to_numpy</span><span class=p>()</span><span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=nb>int</span><span class=p>)</span>
        <span class=k>del</span> <span class=n>data</span><span class=p>,</span> <span class=n>codebook_df</span>
        <span class=k>return</span> <span class=n>gene_ids</span><span class=p>,</span> <span class=n>codebook_matrix</span>
    <span class=k>except</span> <span class=p>(</span><span class=ne>KeyError</span><span class=p>,</span> <span class=ne>ValueError</span><span class=p>,</span> <span class=ne>TypeError</span><span class=p>):</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Error parsing codebook.&quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>None</span>
</code></pre></div></td></tr></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id=merfish3danalysis.qi2labDataStore.qi2labDataStore.load_coord_of_xform_px class="doc doc-heading"> <code class="highlight language-python"><span class=n>load_coord_of_xform_px</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>round</span><span class=p>,</span> <span class=n>return_future</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span></code> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.load_coord_of_xform_px class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-contents "> <p>Local fidicual optical flow matrix for one round and tile.</p> <p><span class=doc-section-title>Parameters:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> <th>Default</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td> <code>tile</code> </td> <td> <code><span title="typing.Optional">Optional</span>[<span title="typing.Union">Union</span>[int, str]]</code> </td> <td> <div class=doc-md-description> <p>Tile index or tile id.</p> </div> </td> <td> <em>required</em> </td> </tr> <tr class=doc-section-item> <td> <code>round</code> </td> <td> <code><span title="typing.Optional">Optional</span>[<span title="typing.Union">Union</span>[int, str]]</code> </td> <td> <div class=doc-md-description> <p>Round index or round id.</p> </div> </td> <td> <em>required</em> </td> </tr> <tr class=doc-section-item> <td> <code>return_future</code> </td> <td> <code><span title="typing.Optional">Optional</span>[bool]</code> </td> <td> <div class=doc-md-description> <p>Return future array.</p> </div> </td> <td> <code>True</code> </td> </tr> </tbody> </table> <p><span class=doc-section-title>Returns:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td><code>of_xform_px</code></td> <td> <code><span title="typing.Optional">Optional</span>[<span title="numpy.typing.ArrayLike">ArrayLike</span>]</code> </td> <td> <div class=doc-md-description> <p>Local fidicual optical flow matrix for one round and tile.</p> </div> </td> </tr> <tr class=doc-section-item> <td><code>downsampling</code></td> <td> <code><span title="typing.Optional">Optional</span>[<span title="numpy.typing.ArrayLike">ArrayLike</span>]</code> </td> <td> <div class=doc-md-description> <p>Downsampling factor.</p> </div> </td> </tr> </tbody> </table> <details class=quote> <summary>Source code in <code>src/merfish3danalysis/qi2labDataStore.py</code></summary> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>2751</span>
<span class=normal>2752</span>
<span class=normal>2753</span>
<span class=normal>2754</span>
<span class=normal>2755</span>
<span class=normal>2756</span>
<span class=normal>2757</span>
<span class=normal>2758</span>
<span class=normal>2759</span>
<span class=normal>2760</span>
<span class=normal>2761</span>
<span class=normal>2762</span>
<span class=normal>2763</span>
<span class=normal>2764</span>
<span class=normal>2765</span>
<span class=normal>2766</span>
<span class=normal>2767</span>
<span class=normal>2768</span>
<span class=normal>2769</span>
<span class=normal>2770</span>
<span class=normal>2771</span>
<span class=normal>2772</span>
<span class=normal>2773</span>
<span class=normal>2774</span>
<span class=normal>2775</span>
<span class=normal>2776</span>
<span class=normal>2777</span>
<span class=normal>2778</span>
<span class=normal>2779</span>
<span class=normal>2780</span>
<span class=normal>2781</span>
<span class=normal>2782</span>
<span class=normal>2783</span>
<span class=normal>2784</span>
<span class=normal>2785</span>
<span class=normal>2786</span>
<span class=normal>2787</span>
<span class=normal>2788</span>
<span class=normal>2789</span>
<span class=normal>2790</span>
<span class=normal>2791</span>
<span class=normal>2792</span>
<span class=normal>2793</span>
<span class=normal>2794</span>
<span class=normal>2795</span>
<span class=normal>2796</span>
<span class=normal>2797</span>
<span class=normal>2798</span>
<span class=normal>2799</span>
<span class=normal>2800</span>
<span class=normal>2801</span>
<span class=normal>2802</span>
<span class=normal>2803</span>
<span class=normal>2804</span>
<span class=normal>2805</span>
<span class=normal>2806</span>
<span class=normal>2807</span>
<span class=normal>2808</span>
<span class=normal>2809</span>
<span class=normal>2810</span>
<span class=normal>2811</span>
<span class=normal>2812</span>
<span class=normal>2813</span>
<span class=normal>2814</span>
<span class=normal>2815</span>
<span class=normal>2816</span>
<span class=normal>2817</span>
<span class=normal>2818</span>
<span class=normal>2819</span>
<span class=normal>2820</span>
<span class=normal>2821</span>
<span class=normal>2822</span>
<span class=normal>2823</span>
<span class=normal>2824</span>
<span class=normal>2825</span>
<span class=normal>2826</span>
<span class=normal>2827</span>
<span class=normal>2828</span>
<span class=normal>2829</span>
<span class=normal>2830</span>
<span class=normal>2831</span>
<span class=normal>2832</span>
<span class=normal>2833</span>
<span class=normal>2834</span>
<span class=normal>2835</span>
<span class=normal>2836</span>
<span class=normal>2837</span>
<span class=normal>2838</span>
<span class=normal>2839</span>
<span class=normal>2840</span>
<span class=normal>2841</span>
<span class=normal>2842</span>
<span class=normal>2843</span>
<span class=normal>2844</span>
<span class=normal>2845</span>
<span class=normal>2846</span>
<span class=normal>2847</span>
<span class=normal>2848</span>
<span class=normal>2849</span>
<span class=normal>2850</span>
<span class=normal>2851</span>
<span class=normal>2852</span>
<span class=normal>2853</span>
<span class=normal>2854</span>
<span class=normal>2855</span>
<span class=normal>2856</span></pre></div></td><td class=code><div><pre><span></span><code><span class=k>def</span> <span class=nf>load_coord_of_xform_px</span><span class=p>(</span>
    <span class=bp>self</span><span class=p>,</span>
    <span class=n>tile</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>]],</span>
    <span class=nb>round</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>]],</span>
    <span class=n>return_future</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>bool</span><span class=p>]</span> <span class=o>=</span> <span class=kc>True</span><span class=p>,</span>
<span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>tuple</span><span class=p>[</span><span class=n>ArrayLike</span><span class=p>,</span> <span class=n>ArrayLike</span><span class=p>]]:</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Local fidicual optical flow matrix for one round and tile.</span>

<span class=sd>    Parameters</span>
<span class=sd>    ----------</span>
<span class=sd>    tile : Optional[Union[int, str]]</span>
<span class=sd>        Tile index or tile id.</span>
<span class=sd>    round : Optional[Union[int, str]]</span>
<span class=sd>        Round index or round id.</span>
<span class=sd>    return_future : Optional[bool]</span>
<span class=sd>        Return future array.</span>

<span class=sd>    Returns</span>
<span class=sd>    -------</span>
<span class=sd>    of_xform_px : Optional[ArrayLike]</span>
<span class=sd>        Local fidicual optical flow matrix for one round and tile.</span>
<span class=sd>    downsampling : Optional[ArrayLike]</span>
<span class=sd>        Downsampling factor.</span>
<span class=sd>    &quot;&quot;&quot;</span>

    <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
        <span class=k>if</span> <span class=n>tile</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>tile</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set tile index &gt;=0 and &lt;=&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>))</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>tile_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>[</span><span class=n>tile</span><span class=p>]</span>
    <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
        <span class=k>if</span> <span class=n>tile</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;set valid tiled id&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>tile_id</span> <span class=o>=</span> <span class=n>tile</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;tile&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>None</span>

    <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=nb>round</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
        <span class=k>if</span> <span class=nb>round</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set round index &gt;=0 and &lt;&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_num_rounds</span><span class=p>))</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>round_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_round_ids</span><span class=p>[</span><span class=nb>round</span><span class=p>]</span>
    <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=nb>round</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
        <span class=k>if</span> <span class=nb>round</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_round_ids</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set valid round id&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>round_id</span> <span class=o>=</span> <span class=nb>round</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;round&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>None</span>

    <span class=n>current_local_zarr_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_polyDT_root_path</span>
        <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
        <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>round_id</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
        <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;of_xform_px&quot;</span><span class=p>)</span>
    <span class=p>)</span>
    <span class=n>zattrs_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_polyDT_root_path</span>
        <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
        <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>round_id</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
        <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;.zattrs&quot;</span><span class=p>)</span>
    <span class=p>)</span>

    <span class=k>if</span> <span class=ow>not</span> <span class=n>Path</span><span class=p>(</span><span class=n>current_local_zarr_path</span><span class=p>)</span><span class=o>.</span><span class=n>exists</span><span class=p>():</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Optical flow transform mapping back to first round not found.&quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>None</span>

    <span class=k>try</span><span class=p>:</span>
        <span class=n>compressor</span> <span class=o>=</span> <span class=p>{</span>
            <span class=s2>&quot;id&quot;</span><span class=p>:</span> <span class=s2>&quot;blosc&quot;</span><span class=p>,</span>
            <span class=s2>&quot;cname&quot;</span><span class=p>:</span> <span class=s2>&quot;zstd&quot;</span><span class=p>,</span>
            <span class=s2>&quot;clevel&quot;</span><span class=p>:</span> <span class=mi>5</span><span class=p>,</span>
            <span class=s2>&quot;shuffle&quot;</span><span class=p>:</span> <span class=mi>2</span><span class=p>,</span>
        <span class=p>}</span>
        <span class=n>spec_of</span> <span class=o>=</span> <span class=p>{</span>
            <span class=s2>&quot;driver&quot;</span><span class=p>:</span> <span class=s2>&quot;zarr&quot;</span><span class=p>,</span>
            <span class=s2>&quot;kvstore&quot;</span><span class=p>:</span> <span class=kc>None</span><span class=p>,</span>
            <span class=s2>&quot;metadata&quot;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&quot;compressor&quot;</span><span class=p>:</span> <span class=n>compressor</span><span class=p>},</span>
            <span class=s2>&quot;open&quot;</span><span class=p>:</span> <span class=kc>True</span><span class=p>,</span>
            <span class=s2>&quot;assume_metadata&quot;</span><span class=p>:</span> <span class=kc>False</span><span class=p>,</span>
            <span class=s2>&quot;create&quot;</span><span class=p>:</span> <span class=kc>True</span><span class=p>,</span>
            <span class=s2>&quot;delete_existing&quot;</span><span class=p>:</span> <span class=kc>False</span><span class=p>,</span>
        <span class=p>}</span>
        <span class=n>spec_of</span><span class=p>[</span><span class=s2>&quot;metadata&quot;</span><span class=p>][</span><span class=s2>&quot;dtype&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&quot;&lt;f4&quot;</span>
        <span class=n>of_xform_px</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_zarr_array</span><span class=p>(</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_get_kvstore_key</span><span class=p>(</span><span class=n>current_local_zarr_path</span><span class=p>),</span>
            <span class=n>spec_of</span><span class=o>.</span><span class=n>copy</span><span class=p>(),</span>
            <span class=n>return_future</span><span class=p>,</span>
        <span class=p>)</span>
        <span class=n>attributes</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_json</span><span class=p>(</span><span class=n>zattrs_path</span><span class=p>)</span>
        <span class=n>downsampling</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>asarray</span><span class=p>(</span>
            <span class=n>attributes</span><span class=p>[</span><span class=s2>&quot;opticalflow_downsampling&quot;</span><span class=p>],</span> <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>float32</span>
        <span class=p>)</span>

        <span class=k>return</span> <span class=n>of_xform_px</span><span class=p>,</span> <span class=n>downsampling</span>
    <span class=k>except</span> <span class=p>(</span><span class=ne>IOError</span><span class=p>,</span> <span class=ne>OSError</span><span class=p>,</span> <span class=n>ZarrError</span><span class=p>)</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=n>e</span><span class=p>)</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Error loading optical flow transform.&quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>None</span>
</code></pre></div></td></tr></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id=merfish3danalysis.qi2labDataStore.qi2labDataStore.load_global_baysor_filtered_spots class="doc doc-heading"> <code class="highlight language-python"><span class=n>load_global_baysor_filtered_spots</span><span class=p>()</span></code> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.load_global_baysor_filtered_spots class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-contents "> <p>Load Baysor re-assigned decoded RNA.</p> <p>Assumes Baysor has been run.</p> <p><span class=doc-section-title>Returns:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td><code>baysor_filtered_genes</code></td> <td> <code><span title="typing.Optional">Optional</span>[<span title="pandas.DataFrame">DataFrame</span>]</code> </td> <td> <div class=doc-md-description> <p>Baysor re-assigned decoded RNA.</p> </div> </td> </tr> </tbody> </table> <details class=quote> <summary>Source code in <code>src/merfish3danalysis/qi2labDataStore.py</code></summary> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>4048</span>
<span class=normal>4049</span>
<span class=normal>4050</span>
<span class=normal>4051</span>
<span class=normal>4052</span>
<span class=normal>4053</span>
<span class=normal>4054</span>
<span class=normal>4055</span>
<span class=normal>4056</span>
<span class=normal>4057</span>
<span class=normal>4058</span>
<span class=normal>4059</span>
<span class=normal>4060</span>
<span class=normal>4061</span>
<span class=normal>4062</span>
<span class=normal>4063</span>
<span class=normal>4064</span>
<span class=normal>4065</span>
<span class=normal>4066</span>
<span class=normal>4067</span>
<span class=normal>4068</span>
<span class=normal>4069</span>
<span class=normal>4070</span>
<span class=normal>4071</span>
<span class=normal>4072</span></pre></div></td><td class=code><div><pre><span></span><code><span class=k>def</span> <span class=nf>load_global_baysor_filtered_spots</span><span class=p>(</span>
    <span class=bp>self</span><span class=p>,</span>
<span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>]:</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Load Baysor re-assigned decoded RNA.</span>

<span class=sd>    Assumes Baysor has been run.</span>

<span class=sd>    Returns</span>
<span class=sd>    -------</span>
<span class=sd>    baysor_filtered_genes : Optional[pd.DataFrame]</span>
<span class=sd>        Baysor re-assigned decoded RNA.</span>
<span class=sd>    &quot;&quot;&quot;</span>

    <span class=n>current_baysor_spots_path</span> <span class=o>=</span> <span class=p>(</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_segmentation_root_path</span>
        <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;baysor&quot;</span><span class=p>)</span>
        <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;segmentation.csv&quot;</span><span class=p>)</span>
    <span class=p>)</span>

    <span class=k>if</span> <span class=ow>not</span> <span class=n>current_baysor_spots_path</span><span class=o>.</span><span class=n>exists</span><span class=p>():</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Baysor filtered genes not found.&quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>None</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=n>baysor_filtered_genes</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_csv</span><span class=p>(</span><span class=n>current_baysor_spots_path</span><span class=p>)</span>
        <span class=k>return</span> <span class=n>baysor_filtered_genes</span>
</code></pre></div></td></tr></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id=merfish3danalysis.qi2labDataStore.qi2labDataStore.load_global_baysor_outlines class="doc doc-heading"> <code class="highlight language-python"><span class=n>load_global_baysor_outlines</span><span class=p>()</span></code> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.load_global_baysor_outlines class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-contents "> <p>Load Baysor cell outlines.</p> <p>Assumes Baysor has been run.</p> <p><span class=doc-section-title>Returns:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td><code>baysor_outlines</code></td> <td> <code><span title="typing.Optional">Optional</span>[dict]</code> </td> <td> <div class=doc-md-description> <p>Baysor cell outlines.</p> </div> </td> </tr> </tbody> </table> <details class=quote> <summary>Source code in <code>src/merfish3danalysis/qi2labDataStore.py</code></summary> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>4074</span>
<span class=normal>4075</span>
<span class=normal>4076</span>
<span class=normal>4077</span>
<span class=normal>4078</span>
<span class=normal>4079</span>
<span class=normal>4080</span>
<span class=normal>4081</span>
<span class=normal>4082</span>
<span class=normal>4083</span>
<span class=normal>4084</span>
<span class=normal>4085</span>
<span class=normal>4086</span>
<span class=normal>4087</span>
<span class=normal>4088</span>
<span class=normal>4089</span>
<span class=normal>4090</span>
<span class=normal>4091</span>
<span class=normal>4092</span>
<span class=normal>4093</span>
<span class=normal>4094</span>
<span class=normal>4095</span>
<span class=normal>4096</span>
<span class=normal>4097</span>
<span class=normal>4098</span></pre></div></td><td class=code><div><pre><span></span><code><span class=k>def</span> <span class=nf>load_global_baysor_outlines</span><span class=p>(</span>
    <span class=bp>self</span><span class=p>,</span>
<span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>dict</span><span class=p>]:</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Load Baysor cell outlines.</span>

<span class=sd>    Assumes Baysor has been run.</span>

<span class=sd>    Returns</span>
<span class=sd>    -------</span>
<span class=sd>    baysor_outlines : Optional[dict]</span>
<span class=sd>        Baysor cell outlines.</span>
<span class=sd>    &quot;&quot;&quot;</span>

    <span class=n>current_baysor_outlines_path</span> <span class=o>=</span> <span class=p>(</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_segmentation_root_path</span> 
        <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;baysor&quot;</span><span class=p>)</span> 
        <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=sa>r</span><span class=s2>&quot;3d_cell_rois.zip&quot;</span><span class=p>)</span>
    <span class=p>)</span>

    <span class=k>if</span> <span class=ow>not</span> <span class=n>current_baysor_outlines_path</span><span class=o>.</span><span class=n>exists</span><span class=p>():</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Baysor outlines not found.&quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>None</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=n>baysor_rois</span> <span class=o>=</span> <span class=n>roiread</span><span class=p>(</span><span class=n>current_baysor_outlines_path</span><span class=p>)</span>
        <span class=k>return</span> <span class=n>baysor_rois</span>
</code></pre></div></td></tr></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id=merfish3danalysis.qi2labDataStore.qi2labDataStore.load_global_cellpose_outlines class="doc doc-heading"> <code class="highlight language-python"><span class=n>load_global_cellpose_outlines</span><span class=p>()</span></code> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.load_global_cellpose_outlines class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-contents "> <p>Load Cellpose max projection cell outlines.</p> <p><span class=doc-section-title>Returns:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td><code>cellpose_outlines</code></td> <td> <code><span title="typing.Optional">Optional</span>[dict]</code> </td> <td> <div class=doc-md-description> <p>Cellpose cell mask outlines.</p> </div> </td> </tr> </tbody> </table> <details class=quote> <summary>Source code in <code>src/merfish3danalysis/qi2labDataStore.py</code></summary> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>3813</span>
<span class=normal>3814</span>
<span class=normal>3815</span>
<span class=normal>3816</span>
<span class=normal>3817</span>
<span class=normal>3818</span>
<span class=normal>3819</span>
<span class=normal>3820</span>
<span class=normal>3821</span>
<span class=normal>3822</span>
<span class=normal>3823</span>
<span class=normal>3824</span>
<span class=normal>3825</span>
<span class=normal>3826</span>
<span class=normal>3827</span>
<span class=normal>3828</span>
<span class=normal>3829</span>
<span class=normal>3830</span>
<span class=normal>3831</span>
<span class=normal>3832</span>
<span class=normal>3833</span>
<span class=normal>3834</span>
<span class=normal>3835</span></pre></div></td><td class=code><div><pre><span></span><code><span class=k>def</span> <span class=nf>load_global_cellpose_outlines</span><span class=p>(</span>
    <span class=bp>self</span><span class=p>,</span>
<span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>dict</span><span class=p>]:</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Load Cellpose max projection cell outlines.</span>

<span class=sd>    Returns</span>
<span class=sd>    -------</span>
<span class=sd>    cellpose_outlines : Optional[dict]</span>
<span class=sd>        Cellpose cell mask outlines.</span>
<span class=sd>    &quot;&quot;&quot;</span>

    <span class=n>current_cellpose_outlines_path</span> <span class=o>=</span> <span class=p>(</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_segmentation_root_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;cellpose&quot;</span><span class=p>)</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;cell_outlines.json&quot;</span><span class=p>)</span>
    <span class=p>)</span>

    <span class=k>if</span> <span class=ow>not</span> <span class=n>current_cellpose_outlines_path</span><span class=o>.</span><span class=n>exists</span><span class=p>():</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Cellpose cell mask outlines not found.&quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>None</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=n>cellpose_outlines</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_microjson</span><span class=p>(</span>
            <span class=n>current_cellpose_outlines_path</span>
        <span class=p>)</span>
        <span class=k>return</span> <span class=n>cellpose_outlines</span>
</code></pre></div></td></tr></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id=merfish3danalysis.qi2labDataStore.qi2labDataStore.load_global_cellpose_segmentation_image class="doc doc-heading"> <code class="highlight language-python"><span class=n>load_global_cellpose_segmentation_image</span><span class=p>(</span><span class=n>return_future</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span></code> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.load_global_cellpose_segmentation_image class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-contents "> <p>Load Cellpose max projection, downsampled segmentation image.</p> <p><span class=doc-section-title>Parameters:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> <th>Default</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td> <code>return_future</code> </td> <td> <code><span title="typing.Optional">Optional</span>[bool]</code> </td> <td> <div class=doc-md-description> <p>Return future array.</p> </div> </td> <td> <code>True</code> </td> </tr> </tbody> </table> <p><span class=doc-section-title>Returns:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td><code>fused_image</code></td> <td> <code><span title="typing.Optional">Optional</span>[<span title="numpy.typing.ArrayLike">ArrayLike</span>]</code> </td> <td> <div class=doc-md-description> <p>Cellpose max projection, downsampled segmentation image.</p> </div> </td> </tr> </tbody> </table> <details class=quote> <summary>Source code in <code>src/merfish3danalysis/qi2labDataStore.py</code></summary> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>3837</span>
<span class=normal>3838</span>
<span class=normal>3839</span>
<span class=normal>3840</span>
<span class=normal>3841</span>
<span class=normal>3842</span>
<span class=normal>3843</span>
<span class=normal>3844</span>
<span class=normal>3845</span>
<span class=normal>3846</span>
<span class=normal>3847</span>
<span class=normal>3848</span>
<span class=normal>3849</span>
<span class=normal>3850</span>
<span class=normal>3851</span>
<span class=normal>3852</span>
<span class=normal>3853</span>
<span class=normal>3854</span>
<span class=normal>3855</span>
<span class=normal>3856</span>
<span class=normal>3857</span>
<span class=normal>3858</span>
<span class=normal>3859</span>
<span class=normal>3860</span>
<span class=normal>3861</span>
<span class=normal>3862</span>
<span class=normal>3863</span>
<span class=normal>3864</span>
<span class=normal>3865</span>
<span class=normal>3866</span>
<span class=normal>3867</span>
<span class=normal>3868</span>
<span class=normal>3869</span>
<span class=normal>3870</span>
<span class=normal>3871</span>
<span class=normal>3872</span>
<span class=normal>3873</span>
<span class=normal>3874</span></pre></div></td><td class=code><div><pre><span></span><code><span class=k>def</span> <span class=nf>load_global_cellpose_segmentation_image</span><span class=p>(</span>
    <span class=bp>self</span><span class=p>,</span>
    <span class=n>return_future</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>bool</span><span class=p>]</span> <span class=o>=</span> <span class=kc>True</span><span class=p>,</span>
<span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=n>ArrayLike</span><span class=p>]:</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Load Cellpose max projection, downsampled segmentation image.</span>

<span class=sd>    Parameters</span>
<span class=sd>    ----------</span>
<span class=sd>    return_future : Optional[bool]</span>
<span class=sd>        Return future array.</span>

<span class=sd>    Returns</span>
<span class=sd>    -------</span>
<span class=sd>    fused_image : Optional[ArrayLike]</span>
<span class=sd>        Cellpose max projection, downsampled segmentation image.</span>
<span class=sd>    &quot;&quot;&quot;</span>

    <span class=n>current_local_zarr_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_segmentation_root_path</span>
        <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;cellpose&quot;</span><span class=p>)</span>
        <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;cellpose.zarr&quot;</span><span class=p>)</span>
        <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;masks_polyDT_iso_zyx&quot;</span><span class=p>)</span>
    <span class=p>)</span>

    <span class=k>if</span> <span class=ow>not</span> <span class=n>current_local_zarr_path</span><span class=o>.</span><span class=n>exists</span><span class=p>():</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Cellpose prediction on global fused image not found.&quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>None</span>

    <span class=k>try</span><span class=p>:</span>
        <span class=n>fused_image</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_zarr_array</span><span class=p>(</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_get_kvstore_key</span><span class=p>(</span><span class=n>current_local_zarr_path</span><span class=p>),</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_zarrv2_spec</span><span class=o>.</span><span class=n>copy</span><span class=p>(),</span>
            <span class=n>return_future</span><span class=p>,</span>
        <span class=p>)</span>
        <span class=k>return</span> <span class=n>fused_image</span>
    <span class=k>except</span> <span class=p>(</span><span class=ne>IOError</span><span class=p>,</span> <span class=ne>OSError</span><span class=p>,</span> <span class=n>ZarrError</span><span class=p>):</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Error loading Cellpose image.&quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>None</span>
</code></pre></div></td></tr></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id=merfish3danalysis.qi2labDataStore.qi2labDataStore.load_global_coord_xforms_um class="doc doc-heading"> <code class="highlight language-python"><span class=n>load_global_coord_xforms_um</span><span class=p>(</span><span class=n>tile</span><span class=p>)</span></code> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.load_global_coord_xforms_um class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-contents "> <p>Load global registration transform for one tile.</p> <p><span class=doc-section-title>Parameters:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> <th>Default</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td> <code>tile</code> </td> <td> <code><span title="typing.Union">Union</span>[int, str]</code> </td> <td> <div class=doc-md-description> <p>Tile index or tile id.</p> </div> </td> <td> <em>required</em> </td> </tr> </tbody> </table> <p><span class=doc-section-title>Returns:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td><code>affine_zyx_um</code></td> <td> <code><span title="typing.Optional">Optional</span>[<span title="numpy.typing.ArrayLike">ArrayLike</span>]</code> </td> <td> <div class=doc-md-description> <p>Global affine registration transform for one tile.</p> </div> </td> </tr> <tr class=doc-section-item> <td><code>origin_zyx_um</code></td> <td> <code><span title="typing.Optional">Optional</span>[<span title="numpy.typing.ArrayLike">ArrayLike</span>]</code> </td> <td> <div class=doc-md-description> <p>Global origin registration transform for one tile.</p> </div> </td> </tr> <tr class=doc-section-item> <td><code>spacing_zyx_um</code></td> <td> <code><span title="typing.Optional">Optional</span>[<span title="numpy.typing.ArrayLike">ArrayLike</span>]</code> </td> <td> <div class=doc-md-description> <p>Global spacing registration transform for one tile.</p> </div> </td> </tr> </tbody> </table> <details class=quote> <summary>Source code in <code>src/merfish3danalysis/qi2labDataStore.py</code></summary> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>3468</span>
<span class=normal>3469</span>
<span class=normal>3470</span>
<span class=normal>3471</span>
<span class=normal>3472</span>
<span class=normal>3473</span>
<span class=normal>3474</span>
<span class=normal>3475</span>
<span class=normal>3476</span>
<span class=normal>3477</span>
<span class=normal>3478</span>
<span class=normal>3479</span>
<span class=normal>3480</span>
<span class=normal>3481</span>
<span class=normal>3482</span>
<span class=normal>3483</span>
<span class=normal>3484</span>
<span class=normal>3485</span>
<span class=normal>3486</span>
<span class=normal>3487</span>
<span class=normal>3488</span>
<span class=normal>3489</span>
<span class=normal>3490</span>
<span class=normal>3491</span>
<span class=normal>3492</span>
<span class=normal>3493</span>
<span class=normal>3494</span>
<span class=normal>3495</span>
<span class=normal>3496</span>
<span class=normal>3497</span>
<span class=normal>3498</span>
<span class=normal>3499</span>
<span class=normal>3500</span>
<span class=normal>3501</span>
<span class=normal>3502</span>
<span class=normal>3503</span>
<span class=normal>3504</span>
<span class=normal>3505</span>
<span class=normal>3506</span>
<span class=normal>3507</span>
<span class=normal>3508</span>
<span class=normal>3509</span>
<span class=normal>3510</span>
<span class=normal>3511</span>
<span class=normal>3512</span>
<span class=normal>3513</span>
<span class=normal>3514</span>
<span class=normal>3515</span>
<span class=normal>3516</span>
<span class=normal>3517</span>
<span class=normal>3518</span>
<span class=normal>3519</span>
<span class=normal>3520</span></pre></div></td><td class=code><div><pre><span></span><code><span class=k>def</span> <span class=nf>load_global_coord_xforms_um</span><span class=p>(</span>
    <span class=bp>self</span><span class=p>,</span>
    <span class=n>tile</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>],</span>
<span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>tuple</span><span class=p>[</span><span class=n>ArrayLike</span><span class=p>,</span> <span class=n>ArrayLike</span><span class=p>,</span> <span class=n>ArrayLike</span><span class=p>]]:</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Load global registration transform for one tile.</span>

<span class=sd>    Parameters</span>
<span class=sd>    ----------</span>
<span class=sd>    tile : Union[int, str]</span>
<span class=sd>        Tile index or tile id.</span>

<span class=sd>    Returns</span>
<span class=sd>    -------</span>
<span class=sd>    affine_zyx_um : Optional[ArrayLike]</span>
<span class=sd>        Global affine registration transform for one tile.</span>
<span class=sd>    origin_zyx_um : Optional[ArrayLike]</span>
<span class=sd>        Global origin registration transform for one tile.</span>
<span class=sd>    spacing_zyx_um : Optional[ArrayLike]</span>
<span class=sd>        Global spacing registration transform for one tile.</span>
<span class=sd>    &quot;&quot;&quot;</span>

    <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
        <span class=k>if</span> <span class=n>tile</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>tile</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set tile index &gt;=0 and &lt;=&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>))</span>
            <span class=k>return</span> <span class=kc>None</span><span class=p>,</span> <span class=kc>None</span><span class=p>,</span> <span class=kc>None</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>tile_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>[</span><span class=n>tile</span><span class=p>]</span>
    <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
        <span class=k>if</span> <span class=n>tile</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;set valid tiled id&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span><span class=p>,</span> <span class=kc>None</span><span class=p>,</span> <span class=kc>None</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>tile_id</span> <span class=o>=</span> <span class=n>tile</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;tile&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>None</span>

    <span class=k>try</span><span class=p>:</span>
        <span class=n>zattrs_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_polyDT_root_path</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_round_ids</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;.zattrs&quot;</span><span class=p>)</span>
        <span class=p>)</span>
        <span class=n>attributes</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_json</span><span class=p>(</span><span class=n>zattrs_path</span><span class=p>)</span>
        <span class=n>affine_zyx_um</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>asarray</span><span class=p>(</span><span class=n>attributes</span><span class=p>[</span><span class=s2>&quot;affine_zyx_um&quot;</span><span class=p>],</span> <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>float32</span><span class=p>)</span>
        <span class=n>origin_zyx_um</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>asarray</span><span class=p>(</span><span class=n>attributes</span><span class=p>[</span><span class=s2>&quot;origin_zyx_um&quot;</span><span class=p>],</span> <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>float32</span><span class=p>)</span>
        <span class=n>spacing_zyx_um</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>asarray</span><span class=p>(</span><span class=n>attributes</span><span class=p>[</span><span class=s2>&quot;spacing_zyx_um&quot;</span><span class=p>],</span> <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>float32</span><span class=p>)</span>
        <span class=k>return</span> <span class=p>(</span><span class=n>affine_zyx_um</span><span class=p>,</span> <span class=n>origin_zyx_um</span><span class=p>,</span> <span class=n>spacing_zyx_um</span><span class=p>)</span>
    <span class=k>except</span> <span class=p>(</span><span class=ne>FileNotFoundError</span><span class=p>,</span> <span class=n>json</span><span class=o>.</span><span class=n>JSONDecodeError</span><span class=p>):</span>
        <span class=nb>print</span><span class=p>(</span><span class=n>tile_id</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>_round_ids</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Global coordinate transforms not found&quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>None</span><span class=p>,</span> <span class=kc>None</span><span class=p>,</span> <span class=kc>None</span>
</code></pre></div></td></tr></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id=merfish3danalysis.qi2labDataStore.qi2labDataStore.load_global_fidicual_image class="doc doc-heading"> <code class="highlight language-python"><span class=n>load_global_fidicual_image</span><span class=p>(</span><span class=n>return_future</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span></code> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.load_global_fidicual_image class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-contents "> <p>Load downsampled, fused fidicual image.</p> <p><span class=doc-section-title>Parameters:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> <th>Default</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td> <code>return_future</code> </td> <td> <code><span title="typing.Optional">Optional</span>[bool]</code> </td> <td> <div class=doc-md-description> <p>Return future array.</p> </div> </td> <td> <code>True</code> </td> </tr> </tbody> </table> <p><span class=doc-section-title>Returns:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td><code>fused_image</code></td> <td> <code><span title="typing.Optional">Optional</span>[<span title="numpy.typing.ArrayLike">ArrayLike</span>]</code> </td> <td> <div class=doc-md-description> <p>Downsampled, fused fidicual image.</p> </div> </td> </tr> <tr class=doc-section-item> <td><code>affine_zyx_um</code></td> <td> <code><span title="typing.Optional">Optional</span>[<span title="numpy.typing.ArrayLike">ArrayLike</span>]</code> </td> <td> <div class=doc-md-description> <p>Global affine registration transform for fused image.</p> </div> </td> </tr> <tr class=doc-section-item> <td><code>origin_zyx_um</code></td> <td> <code><span title="typing.Optional">Optional</span>[<span title="numpy.typing.ArrayLike">ArrayLike</span>]</code> </td> <td> <div class=doc-md-description> <p>Global origin registration transform for fused image.</p> </div> </td> </tr> <tr class=doc-section-item> <td><code>spacing_zyx_um</code></td> <td> <code><span title="typing.Optional">Optional</span>[<span title="numpy.typing.ArrayLike">ArrayLike</span>]</code> </td> <td> <div class=doc-md-description> <p>Global spacing registration transform for fused image.</p> </div> </td> </tr> </tbody> </table> <details class=quote> <summary>Source code in <code>src/merfish3danalysis/qi2labDataStore.py</code></summary> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>3574</span>
<span class=normal>3575</span>
<span class=normal>3576</span>
<span class=normal>3577</span>
<span class=normal>3578</span>
<span class=normal>3579</span>
<span class=normal>3580</span>
<span class=normal>3581</span>
<span class=normal>3582</span>
<span class=normal>3583</span>
<span class=normal>3584</span>
<span class=normal>3585</span>
<span class=normal>3586</span>
<span class=normal>3587</span>
<span class=normal>3588</span>
<span class=normal>3589</span>
<span class=normal>3590</span>
<span class=normal>3591</span>
<span class=normal>3592</span>
<span class=normal>3593</span>
<span class=normal>3594</span>
<span class=normal>3595</span>
<span class=normal>3596</span>
<span class=normal>3597</span>
<span class=normal>3598</span>
<span class=normal>3599</span>
<span class=normal>3600</span>
<span class=normal>3601</span>
<span class=normal>3602</span>
<span class=normal>3603</span>
<span class=normal>3604</span>
<span class=normal>3605</span>
<span class=normal>3606</span>
<span class=normal>3607</span>
<span class=normal>3608</span>
<span class=normal>3609</span>
<span class=normal>3610</span>
<span class=normal>3611</span>
<span class=normal>3612</span>
<span class=normal>3613</span>
<span class=normal>3614</span>
<span class=normal>3615</span>
<span class=normal>3616</span>
<span class=normal>3617</span>
<span class=normal>3618</span>
<span class=normal>3619</span>
<span class=normal>3620</span></pre></div></td><td class=code><div><pre><span></span><code><span class=k>def</span> <span class=nf>load_global_fidicual_image</span><span class=p>(</span>
    <span class=bp>self</span><span class=p>,</span>
    <span class=n>return_future</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>bool</span><span class=p>]</span> <span class=o>=</span> <span class=kc>True</span><span class=p>,</span>
<span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>tuple</span><span class=p>[</span><span class=n>ArrayLike</span><span class=p>,</span> <span class=n>ArrayLike</span><span class=p>,</span> <span class=n>ArrayLike</span><span class=p>,</span> <span class=n>ArrayLike</span><span class=p>]]:</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Load downsampled, fused fidicual image.</span>

<span class=sd>    Parameters</span>
<span class=sd>    ----------</span>
<span class=sd>    return_future : Optional[bool]</span>
<span class=sd>        Return future array.</span>

<span class=sd>    Returns</span>
<span class=sd>    -------</span>
<span class=sd>    fused_image : Optional[ArrayLike]</span>
<span class=sd>        Downsampled, fused fidicual image.</span>
<span class=sd>    affine_zyx_um : Optional[ArrayLike]</span>
<span class=sd>        Global affine registration transform for fused image.</span>
<span class=sd>    origin_zyx_um : Optional[ArrayLike]</span>
<span class=sd>        Global origin registration transform for fused image.</span>
<span class=sd>    spacing_zyx_um : Optional[ArrayLike]</span>
<span class=sd>        Global spacing registration transform for fused image.</span>
<span class=sd>    &quot;&quot;&quot;</span>

    <span class=n>current_local_zarr_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_fused_root_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;fused.zarr&quot;</span><span class=p>)</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;fused_polyDT_iso_zyx&quot;</span><span class=p>)</span>
    <span class=p>)</span>

    <span class=k>if</span> <span class=ow>not</span> <span class=n>Path</span><span class=p>(</span><span class=n>current_local_zarr_path</span><span class=p>)</span><span class=o>.</span><span class=n>exists</span><span class=p>():</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Globally registered, fused image not found.&quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>None</span>

    <span class=n>zattrs_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span><span class=n>current_local_zarr_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;.zattrs&quot;</span><span class=p>))</span>

    <span class=k>try</span><span class=p>:</span>
        <span class=n>fused_image</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_zarr_array</span><span class=p>(</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_get_kvstore_key</span><span class=p>(</span><span class=n>current_local_zarr_path</span><span class=p>),</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_zarrv2_spec</span><span class=o>.</span><span class=n>copy</span><span class=p>(),</span>
            <span class=n>return_future</span><span class=p>,</span>
        <span class=p>)</span>
        <span class=n>attributes</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_json</span><span class=p>(</span><span class=n>zattrs_path</span><span class=p>)</span>
        <span class=n>affine_zyx_um</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>asarray</span><span class=p>(</span><span class=n>attributes</span><span class=p>[</span><span class=s2>&quot;affine_zyx_um&quot;</span><span class=p>],</span> <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>float32</span><span class=p>)</span>
        <span class=n>origin_zyx_um</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>asarray</span><span class=p>(</span><span class=n>attributes</span><span class=p>[</span><span class=s2>&quot;origin_zyx_um&quot;</span><span class=p>],</span> <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>float32</span><span class=p>)</span>
        <span class=n>spacing_zyx_um</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>asarray</span><span class=p>(</span><span class=n>attributes</span><span class=p>[</span><span class=s2>&quot;spacing_zyx_um&quot;</span><span class=p>],</span> <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>float32</span><span class=p>)</span>
        <span class=k>return</span> <span class=n>fused_image</span><span class=p>,</span> <span class=n>affine_zyx_um</span><span class=p>,</span> <span class=n>origin_zyx_um</span><span class=p>,</span> <span class=n>spacing_zyx_um</span>
    <span class=k>except</span> <span class=p>(</span><span class=ne>IOError</span><span class=p>,</span> <span class=ne>OSError</span><span class=p>,</span> <span class=n>ZarrError</span><span class=p>):</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Error loading globally registered, fused image.&quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>None</span>
</code></pre></div></td></tr></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id=merfish3danalysis.qi2labDataStore.qi2labDataStore.load_global_filtered_decoded_spots class="doc doc-heading"> <code class="highlight language-python"><span class=n>load_global_filtered_decoded_spots</span><span class=p>()</span></code> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.load_global_filtered_decoded_spots class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-contents "> <p>Load all decoded and filtered spots.</p> <p><span class=doc-section-title>Returns:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td><code>all_tiles_filtered</code></td> <td> <code><span title="typing.Optional">Optional</span>[<span title="pandas.DataFrame">DataFrame</span>]</code> </td> <td> <div class=doc-md-description> <p>All decoded and filtered spots.</p> </div> </td> </tr> </tbody> </table> <details class=quote> <summary>Source code in <code>src/merfish3danalysis/qi2labDataStore.py</code></summary> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>3761</span>
<span class=normal>3762</span>
<span class=normal>3763</span>
<span class=normal>3764</span>
<span class=normal>3765</span>
<span class=normal>3766</span>
<span class=normal>3767</span>
<span class=normal>3768</span>
<span class=normal>3769</span>
<span class=normal>3770</span>
<span class=normal>3771</span>
<span class=normal>3772</span>
<span class=normal>3773</span>
<span class=normal>3774</span>
<span class=normal>3775</span>
<span class=normal>3776</span>
<span class=normal>3777</span>
<span class=normal>3778</span>
<span class=normal>3779</span>
<span class=normal>3780</span>
<span class=normal>3781</span>
<span class=normal>3782</span>
<span class=normal>3783</span>
<span class=normal>3784</span>
<span class=normal>3785</span>
<span class=normal>3786</span></pre></div></td><td class=code><div><pre><span></span><code><span class=k>def</span> <span class=nf>load_global_filtered_decoded_spots</span><span class=p>(</span>
    <span class=bp>self</span><span class=p>,</span>
<span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>]:</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Load all decoded and filtered spots.</span>

<span class=sd>    Returns</span>
<span class=sd>    -------</span>
<span class=sd>    all_tiles_filtered : Optional[pd.DataFrame]</span>
<span class=sd>        All decoded and filtered spots.</span>
<span class=sd>    &quot;&quot;&quot;</span>

    <span class=n>current_global_filtered_decoded_dir_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span>
        <span class=s2>&quot;all_tiles_filtered_decoded_features&quot;</span>
    <span class=p>)</span>
    <span class=n>current_global_filtered_decoded_path</span> <span class=o>=</span> <span class=p>(</span>
        <span class=n>current_global_filtered_decoded_dir_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;decoded_features.parquet&quot;</span><span class=p>)</span>
    <span class=p>)</span>

    <span class=k>if</span> <span class=ow>not</span> <span class=n>current_global_filtered_decoded_path</span><span class=o>.</span><span class=n>exists</span><span class=p>():</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Global, filtered, decoded spots not found.&quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>None</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=n>all_tiles_filtered</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_parquet</span><span class=p>(</span>
            <span class=n>current_global_filtered_decoded_path</span>
        <span class=p>)</span>
        <span class=k>return</span> <span class=n>all_tiles_filtered</span>
</code></pre></div></td></tr></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id=merfish3danalysis.qi2labDataStore.qi2labDataStore.load_local_bit_linker class="doc doc-heading"> <code class="highlight language-python"><span class=n>load_local_bit_linker</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>round</span><span class=p>)</span></code> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.load_local_bit_linker class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-contents "> <p>Load readout bits linked to fidicual round for one tile.</p> <p><span class=doc-section-title>Parameters:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> <th>Default</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td> <code>tile</code> </td> <td> <code><span title="typing.Union">Union</span>[int, str]</code> </td> <td> <div class=doc-md-description> <p>Tile index or tile id.</p> </div> </td> <td> <em>required</em> </td> </tr> <tr class=doc-section-item> <td> <code>round</code> </td> <td> <code><span title="typing.Union">Union</span>[int, str]</code> </td> <td> <div class=doc-md-description> <p>Round index or round id.</p> </div> </td> <td> <em>required</em> </td> </tr> </tbody> </table> <p><span class=doc-section-title>Returns:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td><code>bit_linker</code></td> <td> <code><span title="typing.Optional">Optional</span>[<span title="typing.Sequence">Sequence</span>[int]]</code> </td> <td> <div class=doc-md-description> <p>Readout bits linked to fidicual round for one tile.</p> </div> </td> </tr> </tbody> </table> <details class=quote> <summary>Source code in <code>src/merfish3danalysis/qi2labDataStore.py</code></summary> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1781</span>
<span class=normal>1782</span>
<span class=normal>1783</span>
<span class=normal>1784</span>
<span class=normal>1785</span>
<span class=normal>1786</span>
<span class=normal>1787</span>
<span class=normal>1788</span>
<span class=normal>1789</span>
<span class=normal>1790</span>
<span class=normal>1791</span>
<span class=normal>1792</span>
<span class=normal>1793</span>
<span class=normal>1794</span>
<span class=normal>1795</span>
<span class=normal>1796</span>
<span class=normal>1797</span>
<span class=normal>1798</span>
<span class=normal>1799</span>
<span class=normal>1800</span>
<span class=normal>1801</span>
<span class=normal>1802</span>
<span class=normal>1803</span>
<span class=normal>1804</span>
<span class=normal>1805</span>
<span class=normal>1806</span>
<span class=normal>1807</span>
<span class=normal>1808</span>
<span class=normal>1809</span>
<span class=normal>1810</span>
<span class=normal>1811</span>
<span class=normal>1812</span>
<span class=normal>1813</span>
<span class=normal>1814</span>
<span class=normal>1815</span>
<span class=normal>1816</span>
<span class=normal>1817</span>
<span class=normal>1818</span>
<span class=normal>1819</span>
<span class=normal>1820</span>
<span class=normal>1821</span>
<span class=normal>1822</span>
<span class=normal>1823</span>
<span class=normal>1824</span>
<span class=normal>1825</span>
<span class=normal>1826</span>
<span class=normal>1827</span>
<span class=normal>1828</span>
<span class=normal>1829</span>
<span class=normal>1830</span>
<span class=normal>1831</span>
<span class=normal>1832</span>
<span class=normal>1833</span>
<span class=normal>1834</span>
<span class=normal>1835</span>
<span class=normal>1836</span>
<span class=normal>1837</span>
<span class=normal>1838</span>
<span class=normal>1839</span>
<span class=normal>1840</span>
<span class=normal>1841</span>
<span class=normal>1842</span>
<span class=normal>1843</span>
<span class=normal>1844</span>
<span class=normal>1845</span></pre></div></td><td class=code><div><pre><span></span><code><span class=k>def</span> <span class=nf>load_local_bit_linker</span><span class=p>(</span>
    <span class=bp>self</span><span class=p>,</span>
    <span class=n>tile</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>],</span>
    <span class=nb>round</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>],</span>
<span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=n>Sequence</span><span class=p>[</span><span class=nb>int</span><span class=p>]]:</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Load readout bits linked to fidicual round for one tile.</span>

<span class=sd>    Parameters</span>
<span class=sd>    ----------</span>
<span class=sd>    tile : Union[int, str]</span>
<span class=sd>        Tile index or tile id.</span>
<span class=sd>    round : Union[int, str]</span>
<span class=sd>        Round index or round id.</span>

<span class=sd>    Returns</span>
<span class=sd>    -------</span>
<span class=sd>    bit_linker : Optional[Sequence[int]]</span>
<span class=sd>        Readout bits linked to fidicual round for one tile.</span>
<span class=sd>    &quot;&quot;&quot;</span>

    <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
        <span class=k>if</span> <span class=n>tile</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>tile</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set tile index &gt;=0 and &lt;&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>))</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>tile_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>[</span><span class=n>tile</span><span class=p>]</span>
    <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
        <span class=k>if</span> <span class=n>tile</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;set valid tiled id.&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>tile_id</span> <span class=o>=</span> <span class=n>tile</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;tile&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>None</span>

    <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=nb>round</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
        <span class=k>if</span> <span class=nb>round</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set round index &gt;=0 and &lt;&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_num_rounds</span><span class=p>))</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>round_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_round_ids</span><span class=p>[</span><span class=nb>round</span><span class=p>]</span>
    <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=nb>round</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
        <span class=k>if</span> <span class=nb>round</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_round_ids</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set valid round id.&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>round_id</span> <span class=o>=</span> <span class=nb>round</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;round&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>None</span>

    <span class=k>try</span><span class=p>:</span>
        <span class=n>zattrs_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_polyDT_root_path</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>round_id</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;.zattrs&quot;</span><span class=p>)</span>
        <span class=p>)</span>
        <span class=n>attributes</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_json</span><span class=p>(</span><span class=n>zattrs_path</span><span class=p>)</span>
        <span class=k>return</span> <span class=n>attributes</span><span class=p>[</span><span class=s2>&quot;bits&quot;</span><span class=p>][</span><span class=mi>1</span><span class=p>:]</span>
    <span class=k>except</span> <span class=p>(</span><span class=ne>FileNotFoundError</span><span class=p>,</span> <span class=n>json</span><span class=o>.</span><span class=n>JSONDecodeError</span><span class=p>):</span>
        <span class=nb>print</span><span class=p>(</span><span class=n>tile_id</span><span class=p>,</span> <span class=n>round_id</span><span class=p>)</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Bit linker attribute not found.&quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>None</span>
</code></pre></div></td></tr></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id=merfish3danalysis.qi2labDataStore.qi2labDataStore.load_local_corrected_image class="doc doc-heading"> <code class="highlight language-python"><span class=n>load_local_corrected_image</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>round</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>bit</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>return_future</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span></code> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.load_local_corrected_image class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-contents "> <p>Load gain and offset corrected image for fiducial OR readout bit for one tile.</p> <p><span class=doc-section-title>Parameters:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> <th>Default</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td> <code>tile</code> </td> <td> <code><span title="typing.Union">Union</span>[int, str]</code> </td> <td> <div class=doc-md-description> <p>Tile index or tile id.</p> </div> </td> <td> <em>required</em> </td> </tr> <tr class=doc-section-item> <td> <code>round</code> </td> <td> <code><span title="typing.Optional">Optional</span>[<span title="typing.Union">Union</span>[int, str]]</code> </td> <td> <div class=doc-md-description> <p>Round index or round id.</p> </div> </td> <td> <code>None</code> </td> </tr> <tr class=doc-section-item> <td> <code>bit</code> </td> <td> <code><span title="typing.Optional">Optional</span>[<span title="typing.Union">Union</span>[int, str]]</code> </td> <td> <div class=doc-md-description> <p>Bit index or bit id.</p> </div> </td> <td> <code>None</code> </td> </tr> <tr class=doc-section-item> <td> <code>return_future</code> </td> <td> <code><span title="typing.Optional">Optional</span>[bool]</code> </td> <td> <div class=doc-md-description> <p>Return future array.</p> </div> </td> <td> <code>True</code> </td> </tr> </tbody> </table> <p><span class=doc-section-title>Returns:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td><code>corrected_image</code></td> <td> <code><span title="typing.Optional">Optional</span>[<span title="numpy.typing.ArrayLike">ArrayLike</span>]</code> </td> <td> <div class=doc-md-description> <p>Gain and offset corrected image for fiducial OR readout bit for one tile.</p> </div> </td> </tr> </tbody> </table> <details class=quote> <summary>Source code in <code>src/merfish3danalysis/qi2labDataStore.py</code></summary> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>2376</span>
<span class=normal>2377</span>
<span class=normal>2378</span>
<span class=normal>2379</span>
<span class=normal>2380</span>
<span class=normal>2381</span>
<span class=normal>2382</span>
<span class=normal>2383</span>
<span class=normal>2384</span>
<span class=normal>2385</span>
<span class=normal>2386</span>
<span class=normal>2387</span>
<span class=normal>2388</span>
<span class=normal>2389</span>
<span class=normal>2390</span>
<span class=normal>2391</span>
<span class=normal>2392</span>
<span class=normal>2393</span>
<span class=normal>2394</span>
<span class=normal>2395</span>
<span class=normal>2396</span>
<span class=normal>2397</span>
<span class=normal>2398</span>
<span class=normal>2399</span>
<span class=normal>2400</span>
<span class=normal>2401</span>
<span class=normal>2402</span>
<span class=normal>2403</span>
<span class=normal>2404</span>
<span class=normal>2405</span>
<span class=normal>2406</span>
<span class=normal>2407</span>
<span class=normal>2408</span>
<span class=normal>2409</span>
<span class=normal>2410</span>
<span class=normal>2411</span>
<span class=normal>2412</span>
<span class=normal>2413</span>
<span class=normal>2414</span>
<span class=normal>2415</span>
<span class=normal>2416</span>
<span class=normal>2417</span>
<span class=normal>2418</span>
<span class=normal>2419</span>
<span class=normal>2420</span>
<span class=normal>2421</span>
<span class=normal>2422</span>
<span class=normal>2423</span>
<span class=normal>2424</span>
<span class=normal>2425</span>
<span class=normal>2426</span>
<span class=normal>2427</span>
<span class=normal>2428</span>
<span class=normal>2429</span>
<span class=normal>2430</span>
<span class=normal>2431</span>
<span class=normal>2432</span>
<span class=normal>2433</span>
<span class=normal>2434</span>
<span class=normal>2435</span>
<span class=normal>2436</span>
<span class=normal>2437</span>
<span class=normal>2438</span>
<span class=normal>2439</span>
<span class=normal>2440</span>
<span class=normal>2441</span>
<span class=normal>2442</span>
<span class=normal>2443</span>
<span class=normal>2444</span>
<span class=normal>2445</span>
<span class=normal>2446</span>
<span class=normal>2447</span>
<span class=normal>2448</span>
<span class=normal>2449</span>
<span class=normal>2450</span>
<span class=normal>2451</span>
<span class=normal>2452</span>
<span class=normal>2453</span>
<span class=normal>2454</span>
<span class=normal>2455</span>
<span class=normal>2456</span>
<span class=normal>2457</span>
<span class=normal>2458</span>
<span class=normal>2459</span>
<span class=normal>2460</span>
<span class=normal>2461</span>
<span class=normal>2462</span>
<span class=normal>2463</span>
<span class=normal>2464</span>
<span class=normal>2465</span>
<span class=normal>2466</span>
<span class=normal>2467</span>
<span class=normal>2468</span>
<span class=normal>2469</span>
<span class=normal>2470</span>
<span class=normal>2471</span>
<span class=normal>2472</span>
<span class=normal>2473</span>
<span class=normal>2474</span>
<span class=normal>2475</span>
<span class=normal>2476</span>
<span class=normal>2477</span>
<span class=normal>2478</span>
<span class=normal>2479</span>
<span class=normal>2480</span>
<span class=normal>2481</span>
<span class=normal>2482</span></pre></div></td><td class=code><div><pre><span></span><code><span class=k>def</span> <span class=nf>load_local_corrected_image</span><span class=p>(</span>
    <span class=bp>self</span><span class=p>,</span>
    <span class=n>tile</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>],</span>
    <span class=nb>round</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>]]</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span>
    <span class=n>bit</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>]]</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span>
    <span class=n>return_future</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>bool</span><span class=p>]</span> <span class=o>=</span> <span class=kc>True</span><span class=p>,</span>
<span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=n>ArrayLike</span><span class=p>]:</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Load gain and offset corrected image for fiducial OR readout bit for one tile.</span>

<span class=sd>    Parameters</span>
<span class=sd>    ----------</span>
<span class=sd>    tile : Union[int, str]</span>
<span class=sd>        Tile index or tile id.</span>
<span class=sd>    round : Optional[Union[int, str]]</span>
<span class=sd>        Round index or round id.</span>
<span class=sd>    bit : Optional[Union[int, str]]</span>
<span class=sd>        Bit index or bit id.</span>
<span class=sd>    return_future : Optional[bool]</span>
<span class=sd>        Return future array.</span>

<span class=sd>    Returns</span>
<span class=sd>    -------</span>
<span class=sd>    corrected_image : Optional[ArrayLike]</span>
<span class=sd>        Gain and offset corrected image for fiducial OR readout bit for one tile.</span>
<span class=sd>    &quot;&quot;&quot;</span>

    <span class=k>if</span> <span class=p>(</span><span class=nb>round</span> <span class=ow>is</span> <span class=kc>None</span> <span class=ow>and</span> <span class=n>bit</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>)</span> <span class=ow>or</span> <span class=p>(</span><span class=nb>round</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span> <span class=ow>and</span> <span class=n>bit</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>):</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Provide either &#39;round&#39; or &#39;bit&#39;, but not both&quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>None</span>

    <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
        <span class=k>if</span> <span class=n>tile</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>tile</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set tile index &gt;=0 and &lt;=&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>))</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>tile_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>[</span><span class=n>tile</span><span class=p>]</span>
    <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
        <span class=k>if</span> <span class=n>tile</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;set valid tiled id&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>tile_id</span> <span class=o>=</span> <span class=n>tile</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;tile&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>None</span>

    <span class=k>if</span> <span class=n>bit</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>bit</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
            <span class=k>if</span> <span class=n>bit</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>bit</span> <span class=o>&gt;</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>):</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set bit index &gt;=0 and &lt;=&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>)))</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>local_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>[</span><span class=n>bit</span><span class=p>]</span>
        <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>bit</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
            <span class=k>if</span> <span class=n>bit</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set valid bit id&quot;</span><span class=p>)</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>local_id</span> <span class=o>=</span> <span class=n>bit</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;bit&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=n>current_local_zarr_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_readouts_root_path</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>local_id</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;corrected_data&quot;</span><span class=p>)</span>
        <span class=p>)</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=nb>round</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
            <span class=k>if</span> <span class=nb>round</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set round index &gt;=0 and &lt;&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_num_rounds</span><span class=p>))</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>local_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_round_ids</span><span class=p>[</span><span class=nb>round</span><span class=p>]</span>
        <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=nb>round</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
            <span class=k>if</span> <span class=nb>round</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_round_ids</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set valid round id&quot;</span><span class=p>)</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>local_id</span> <span class=o>=</span> <span class=nb>round</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;round&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=n>current_local_zarr_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_polyDT_root_path</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>local_id</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;corrected_data&quot;</span><span class=p>)</span>
        <span class=p>)</span>

    <span class=k>if</span> <span class=ow>not</span> <span class=n>Path</span><span class=p>(</span><span class=n>current_local_zarr_path</span><span class=p>)</span><span class=o>.</span><span class=n>exists</span><span class=p>():</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Corrected image not found.&quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>None</span>

    <span class=k>try</span><span class=p>:</span>
        <span class=n>spec</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_zarrv2_spec</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>
        <span class=n>spec</span><span class=p>[</span><span class=s2>&quot;metadata&quot;</span><span class=p>][</span><span class=s2>&quot;dtype&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&quot;&lt;u2&quot;</span>
        <span class=n>corrected_image</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_zarr_array</span><span class=p>(</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_get_kvstore_key</span><span class=p>(</span><span class=n>current_local_zarr_path</span><span class=p>),</span>
            <span class=n>spec</span><span class=p>,</span>
            <span class=n>return_future</span><span class=p>,</span>
        <span class=p>)</span>
        <span class=k>return</span> <span class=n>corrected_image</span>
    <span class=k>except</span> <span class=p>(</span><span class=ne>IOError</span><span class=p>,</span> <span class=ne>OSError</span><span class=p>,</span> <span class=n>ZarrError</span><span class=p>):</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Error loading corrected image.&quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>None</span>
</code></pre></div></td></tr></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id=merfish3danalysis.qi2labDataStore.qi2labDataStore.load_local_decoded_spots class="doc doc-heading"> <code class="highlight language-python"><span class=n>load_local_decoded_spots</span><span class=p>(</span><span class=n>tile</span><span class=p>)</span></code> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.load_local_decoded_spots class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-contents "> <p>Load decoded spots and features for one tile.</p> <p><span class=doc-section-title>Parameters:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> <th>Default</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td> <code>tile</code> </td> <td> <code><span title="typing.Union">Union</span>[int, str]</code> </td> <td> <div class=doc-md-description> <p>Tile index or tile id.</p> </div> </td> <td> <em>required</em> </td> </tr> </tbody> </table> <p><span class=doc-section-title>Returns:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td><code>tile_features</code></td> <td> <code><span title="typing.Optional">Optional</span>[<span title="pandas.DataFrame">DataFrame</span>]</code> </td> <td> <div class=doc-md-description> <p>Decoded spots and features for one tile.</p> </div> </td> </tr> </tbody> </table> <details class=quote> <summary>Source code in <code>src/merfish3danalysis/qi2labDataStore.py</code></summary> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>3680</span>
<span class=normal>3681</span>
<span class=normal>3682</span>
<span class=normal>3683</span>
<span class=normal>3684</span>
<span class=normal>3685</span>
<span class=normal>3686</span>
<span class=normal>3687</span>
<span class=normal>3688</span>
<span class=normal>3689</span>
<span class=normal>3690</span>
<span class=normal>3691</span>
<span class=normal>3692</span>
<span class=normal>3693</span>
<span class=normal>3694</span>
<span class=normal>3695</span>
<span class=normal>3696</span>
<span class=normal>3697</span>
<span class=normal>3698</span>
<span class=normal>3699</span>
<span class=normal>3700</span>
<span class=normal>3701</span>
<span class=normal>3702</span>
<span class=normal>3703</span>
<span class=normal>3704</span>
<span class=normal>3705</span>
<span class=normal>3706</span>
<span class=normal>3707</span>
<span class=normal>3708</span>
<span class=normal>3709</span>
<span class=normal>3710</span>
<span class=normal>3711</span>
<span class=normal>3712</span>
<span class=normal>3713</span>
<span class=normal>3714</span>
<span class=normal>3715</span>
<span class=normal>3716</span>
<span class=normal>3717</span>
<span class=normal>3718</span>
<span class=normal>3719</span>
<span class=normal>3720</span>
<span class=normal>3721</span>
<span class=normal>3722</span></pre></div></td><td class=code><div><pre><span></span><code><span class=k>def</span> <span class=nf>load_local_decoded_spots</span><span class=p>(</span>
    <span class=bp>self</span><span class=p>,</span>
    <span class=n>tile</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>],</span>
<span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>]:</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Load decoded spots and features for one tile.</span>

<span class=sd>    Parameters</span>
<span class=sd>    ----------</span>
<span class=sd>    tile : Union[int, str]</span>
<span class=sd>        Tile index or tile id.</span>

<span class=sd>    Returns</span>
<span class=sd>    -------</span>
<span class=sd>    tile_features : Optional[pd.DataFrame]</span>
<span class=sd>        Decoded spots and features for one tile.</span>
<span class=sd>    &quot;&quot;&quot;</span>

    <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
        <span class=k>if</span> <span class=n>tile</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>tile</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set tile index &gt;=0 and &lt;=&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>))</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>tile_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>[</span><span class=n>tile</span><span class=p>]</span>
    <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
        <span class=k>if</span> <span class=n>tile</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;set valid tiled id&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>tile_id</span> <span class=o>=</span> <span class=n>tile</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;tile&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>None</span>

    <span class=n>current_tile_features_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_decoded_root_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span>
        <span class=n>tile_id</span> <span class=o>+</span> <span class=s2>&quot;_decoded_features.parquet&quot;</span>
    <span class=p>)</span>

    <span class=k>if</span> <span class=ow>not</span> <span class=n>current_tile_features_path</span><span class=o>.</span><span class=n>exists</span><span class=p>():</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Decoded spots not found.&quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>None</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=n>tile_features</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_parquet</span><span class=p>(</span><span class=n>current_tile_features_path</span><span class=p>)</span>
        <span class=k>return</span> <span class=n>tile_features</span>
</code></pre></div></td></tr></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id=merfish3danalysis.qi2labDataStore.qi2labDataStore.load_local_registered_image class="doc doc-heading"> <code class="highlight language-python"><span class=n>load_local_registered_image</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>round</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>bit</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>return_future</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span></code> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.load_local_registered_image class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-contents "> <p>Local registered, deconvolved image for fidiculial OR readout bit for one tile.</p> <p><span class=doc-section-title>Parameters:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> <th>Default</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td> <code>tile</code> </td> <td> <code><span title="typing.Union">Union</span>[int, str]</code> </td> <td> <div class=doc-md-description> <p>Tile index or tile id.</p> </div> </td> <td> <em>required</em> </td> </tr> <tr class=doc-section-item> <td> <code>round</code> </td> <td> <code><span title="typing.Optional">Optional</span>[<span title="typing.Union">Union</span>[int, str]]</code> </td> <td> <div class=doc-md-description> <p>Round index or round id.</p> </div> </td> <td> <code>None</code> </td> </tr> <tr class=doc-section-item> <td> <code>bit</code> </td> <td> <code><span title="typing.Optional">Optional</span>[<span title="typing.Union">Union</span>[int, str]]</code> </td> <td> <div class=doc-md-description> <p>Bit index or bit id.</p> </div> </td> <td> <code>None</code> </td> </tr> <tr class=doc-section-item> <td> <code>return_future</code> </td> <td> <code><span title="typing.Optional">Optional</span>[bool]</code> </td> <td> <div class=doc-md-description> <p>Return future array.</p> </div> </td> <td> <code>True</code> </td> </tr> </tbody> </table> <p><span class=doc-section-title>Returns:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td><code>registered_decon_image</code></td> <td> <code><span title="typing.Optional">Optional</span>[<span title="numpy.typing.ArrayLike">ArrayLike</span>]</code> </td> <td> <div class=doc-md-description> <p>Registered, deconvolved image for fidiculial OR readout bit for one tile.</p> </div> </td> </tr> </tbody> </table> <details class=quote> <summary>Source code in <code>src/merfish3danalysis/qi2labDataStore.py</code></summary> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>2955</span>
<span class=normal>2956</span>
<span class=normal>2957</span>
<span class=normal>2958</span>
<span class=normal>2959</span>
<span class=normal>2960</span>
<span class=normal>2961</span>
<span class=normal>2962</span>
<span class=normal>2963</span>
<span class=normal>2964</span>
<span class=normal>2965</span>
<span class=normal>2966</span>
<span class=normal>2967</span>
<span class=normal>2968</span>
<span class=normal>2969</span>
<span class=normal>2970</span>
<span class=normal>2971</span>
<span class=normal>2972</span>
<span class=normal>2973</span>
<span class=normal>2974</span>
<span class=normal>2975</span>
<span class=normal>2976</span>
<span class=normal>2977</span>
<span class=normal>2978</span>
<span class=normal>2979</span>
<span class=normal>2980</span>
<span class=normal>2981</span>
<span class=normal>2982</span>
<span class=normal>2983</span>
<span class=normal>2984</span>
<span class=normal>2985</span>
<span class=normal>2986</span>
<span class=normal>2987</span>
<span class=normal>2988</span>
<span class=normal>2989</span>
<span class=normal>2990</span>
<span class=normal>2991</span>
<span class=normal>2992</span>
<span class=normal>2993</span>
<span class=normal>2994</span>
<span class=normal>2995</span>
<span class=normal>2996</span>
<span class=normal>2997</span>
<span class=normal>2998</span>
<span class=normal>2999</span>
<span class=normal>3000</span>
<span class=normal>3001</span>
<span class=normal>3002</span>
<span class=normal>3003</span>
<span class=normal>3004</span>
<span class=normal>3005</span>
<span class=normal>3006</span>
<span class=normal>3007</span>
<span class=normal>3008</span>
<span class=normal>3009</span>
<span class=normal>3010</span>
<span class=normal>3011</span>
<span class=normal>3012</span>
<span class=normal>3013</span>
<span class=normal>3014</span>
<span class=normal>3015</span>
<span class=normal>3016</span>
<span class=normal>3017</span>
<span class=normal>3018</span>
<span class=normal>3019</span>
<span class=normal>3020</span>
<span class=normal>3021</span>
<span class=normal>3022</span>
<span class=normal>3023</span>
<span class=normal>3024</span>
<span class=normal>3025</span>
<span class=normal>3026</span>
<span class=normal>3027</span>
<span class=normal>3028</span>
<span class=normal>3029</span>
<span class=normal>3030</span>
<span class=normal>3031</span>
<span class=normal>3032</span>
<span class=normal>3033</span>
<span class=normal>3034</span>
<span class=normal>3035</span>
<span class=normal>3036</span>
<span class=normal>3037</span>
<span class=normal>3038</span>
<span class=normal>3039</span>
<span class=normal>3040</span>
<span class=normal>3041</span>
<span class=normal>3042</span>
<span class=normal>3043</span>
<span class=normal>3044</span>
<span class=normal>3045</span>
<span class=normal>3046</span>
<span class=normal>3047</span>
<span class=normal>3048</span>
<span class=normal>3049</span>
<span class=normal>3050</span>
<span class=normal>3051</span>
<span class=normal>3052</span>
<span class=normal>3053</span>
<span class=normal>3054</span>
<span class=normal>3055</span>
<span class=normal>3056</span>
<span class=normal>3057</span>
<span class=normal>3058</span>
<span class=normal>3059</span>
<span class=normal>3060</span>
<span class=normal>3061</span>
<span class=normal>3062</span></pre></div></td><td class=code><div><pre><span></span><code><span class=k>def</span> <span class=nf>load_local_registered_image</span><span class=p>(</span>
    <span class=bp>self</span><span class=p>,</span>
    <span class=n>tile</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>],</span>
    <span class=nb>round</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>]]</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span>
    <span class=n>bit</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>]]</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span>
    <span class=n>return_future</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>bool</span><span class=p>]</span> <span class=o>=</span> <span class=kc>True</span><span class=p>,</span>
<span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=n>ArrayLike</span><span class=p>]:</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Local registered, deconvolved image for fidiculial OR readout bit for one tile.</span>

<span class=sd>    Parameters</span>
<span class=sd>    ----------</span>
<span class=sd>    tile : Union[int, str]</span>
<span class=sd>        Tile index or tile id.</span>
<span class=sd>    round : Optional[Union[int, str]]</span>
<span class=sd>        Round index or round id.</span>
<span class=sd>    bit : Optional[Union[int, str]]</span>
<span class=sd>        Bit index or bit id.</span>
<span class=sd>    return_future : Optional[bool]</span>
<span class=sd>        Return future array.</span>

<span class=sd>    Returns</span>
<span class=sd>    -------</span>
<span class=sd>    registered_decon_image : Optional[ArrayLike]</span>
<span class=sd>        Registered, deconvolved image for fidiculial OR readout bit for one tile.</span>
<span class=sd>    &quot;&quot;&quot;</span>

    <span class=k>if</span> <span class=p>(</span><span class=nb>round</span> <span class=ow>is</span> <span class=kc>None</span> <span class=ow>and</span> <span class=n>bit</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>)</span> <span class=ow>or</span> <span class=p>(</span><span class=nb>round</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span> <span class=ow>and</span> <span class=n>bit</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>):</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Provide either &#39;round&#39; or &#39;bit&#39;, but not both&quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>None</span>

    <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
        <span class=k>if</span> <span class=n>tile</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>tile</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set tile index &gt;=0 and &lt;=&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>))</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>tile_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>[</span><span class=n>tile</span><span class=p>]</span>
    <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
        <span class=k>if</span> <span class=n>tile</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;set valid tiled id&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>tile_id</span> <span class=o>=</span> <span class=n>tile</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;tile&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>None</span>

    <span class=k>if</span> <span class=n>bit</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>bit</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
            <span class=k>if</span> <span class=n>bit</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>bit</span> <span class=o>&gt;</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>):</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set bit index &gt;=0 and &lt;=&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>)))</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>local_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>[</span><span class=n>bit</span><span class=p>]</span>
        <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>bit</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
            <span class=k>if</span> <span class=n>bit</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set valid bit id&quot;</span><span class=p>)</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>local_id</span> <span class=o>=</span> <span class=n>bit</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;bit&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=n>current_local_zarr_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_readouts_root_path</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>local_id</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;registered_decon_data&quot;</span><span class=p>)</span>
        <span class=p>)</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=nb>round</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
            <span class=k>if</span> <span class=nb>round</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set round index &gt;=0 and &lt;&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_num_rounds</span><span class=p>))</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>local_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_round_ids</span><span class=p>[</span><span class=nb>round</span><span class=p>]</span>
        <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=nb>round</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
            <span class=k>if</span> <span class=nb>round</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_round_ids</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set valid round id&quot;</span><span class=p>)</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>local_id</span> <span class=o>=</span> <span class=nb>round</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;round&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=n>current_local_zarr_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_polyDT_root_path</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>local_id</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;registered_decon_data&quot;</span><span class=p>)</span>
        <span class=p>)</span>

    <span class=k>if</span> <span class=ow>not</span> <span class=n>Path</span><span class=p>(</span><span class=n>current_local_zarr_path</span><span class=p>)</span><span class=o>.</span><span class=n>exists</span><span class=p>():</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Registered deconvolved image not found.&quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>None</span>

    <span class=k>try</span><span class=p>:</span>
        <span class=n>spec</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_zarrv2_spec</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>
        <span class=n>spec</span><span class=p>[</span><span class=s2>&quot;metadata&quot;</span><span class=p>][</span><span class=s2>&quot;dtype&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&quot;&lt;u2&quot;</span>
        <span class=n>registered_decon_image</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_zarr_array</span><span class=p>(</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_get_kvstore_key</span><span class=p>(</span><span class=n>current_local_zarr_path</span><span class=p>),</span>
            <span class=n>spec</span><span class=p>,</span>
            <span class=n>return_future</span><span class=p>,</span>
        <span class=p>)</span>
        <span class=k>return</span> <span class=n>registered_decon_image</span>
    <span class=k>except</span> <span class=p>(</span><span class=ne>IOError</span><span class=p>,</span> <span class=ne>OSError</span><span class=p>,</span> <span class=n>ZarrError</span><span class=p>)</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=n>e</span><span class=p>)</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Error loading registered deconvolved image.&quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>None</span>
</code></pre></div></td></tr></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id=merfish3danalysis.qi2labDataStore.qi2labDataStore.load_local_rigid_xform_xyz_px class="doc doc-heading"> <code class="highlight language-python"><span class=n>load_local_rigid_xform_xyz_px</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>round</span><span class=p>)</span></code> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.load_local_rigid_xform_xyz_px class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-contents "> <p>Load calculated rigid registration transform for one round and tile.</p> <p><span class=doc-section-title>Parameters:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> <th>Default</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td> <code>tile</code> </td> <td> <code><span title="typing.Union">Union</span>[int, str]</code> </td> <td> <div class=doc-md-description> <p>Tile index or tile id.</p> </div> </td> <td> <em>required</em> </td> </tr> <tr class=doc-section-item> <td> <code>round</code> </td> <td> <code><span title="typing.Union">Union</span>[int, str]</code> </td> <td> <div class=doc-md-description> <p>Round index or round id.</p> </div> </td> <td> <em>required</em> </td> </tr> </tbody> </table> <p><span class=doc-section-title>Returns:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td><code>rigid_xform_xyz_px</code></td> <td> <code><span title="typing.Optional">Optional</span>[<span title="numpy.typing.ArrayLike">ArrayLike</span>]</code> </td> <td> <div class=doc-md-description> <p>Local rigid registration transform for one round and tile.</p> </div> </td> </tr> </tbody> </table> <details class=quote> <summary>Source code in <code>src/merfish3danalysis/qi2labDataStore.py</code></summary> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>2615</span>
<span class=normal>2616</span>
<span class=normal>2617</span>
<span class=normal>2618</span>
<span class=normal>2619</span>
<span class=normal>2620</span>
<span class=normal>2621</span>
<span class=normal>2622</span>
<span class=normal>2623</span>
<span class=normal>2624</span>
<span class=normal>2625</span>
<span class=normal>2626</span>
<span class=normal>2627</span>
<span class=normal>2628</span>
<span class=normal>2629</span>
<span class=normal>2630</span>
<span class=normal>2631</span>
<span class=normal>2632</span>
<span class=normal>2633</span>
<span class=normal>2634</span>
<span class=normal>2635</span>
<span class=normal>2636</span>
<span class=normal>2637</span>
<span class=normal>2638</span>
<span class=normal>2639</span>
<span class=normal>2640</span>
<span class=normal>2641</span>
<span class=normal>2642</span>
<span class=normal>2643</span>
<span class=normal>2644</span>
<span class=normal>2645</span>
<span class=normal>2646</span>
<span class=normal>2647</span>
<span class=normal>2648</span>
<span class=normal>2649</span>
<span class=normal>2650</span>
<span class=normal>2651</span>
<span class=normal>2652</span>
<span class=normal>2653</span>
<span class=normal>2654</span>
<span class=normal>2655</span>
<span class=normal>2656</span>
<span class=normal>2657</span>
<span class=normal>2658</span>
<span class=normal>2659</span>
<span class=normal>2660</span>
<span class=normal>2661</span>
<span class=normal>2662</span>
<span class=normal>2663</span>
<span class=normal>2664</span>
<span class=normal>2665</span>
<span class=normal>2666</span>
<span class=normal>2667</span>
<span class=normal>2668</span>
<span class=normal>2669</span>
<span class=normal>2670</span>
<span class=normal>2671</span>
<span class=normal>2672</span>
<span class=normal>2673</span>
<span class=normal>2674</span>
<span class=normal>2675</span>
<span class=normal>2676</span>
<span class=normal>2677</span>
<span class=normal>2678</span>
<span class=normal>2679</span>
<span class=normal>2680</span>
<span class=normal>2681</span></pre></div></td><td class=code><div><pre><span></span><code><span class=k>def</span> <span class=nf>load_local_rigid_xform_xyz_px</span><span class=p>(</span>
    <span class=bp>self</span><span class=p>,</span>
    <span class=n>tile</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>],</span>
    <span class=nb>round</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>],</span>
<span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=n>ArrayLike</span><span class=p>]:</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Load calculated rigid registration transform for one round and tile.</span>

<span class=sd>    Parameters</span>
<span class=sd>    ----------</span>
<span class=sd>    tile : Union[int, str]</span>
<span class=sd>        Tile index or tile id.</span>
<span class=sd>    round : Union[int, str]</span>
<span class=sd>        Round index or round id.</span>

<span class=sd>    Returns</span>
<span class=sd>    -------</span>
<span class=sd>    rigid_xform_xyz_px : Optional[ArrayLike]</span>
<span class=sd>        Local rigid registration transform for one round and tile.</span>
<span class=sd>    &quot;&quot;&quot;</span>

    <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
        <span class=k>if</span> <span class=n>tile</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>tile</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set tile index &gt;=0 and &lt;=&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>))</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>tile_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>[</span><span class=n>tile</span><span class=p>]</span>
    <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
        <span class=k>if</span> <span class=n>tile</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;set valid tiled id&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>tile_id</span> <span class=o>=</span> <span class=n>tile</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;tile&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>None</span>

    <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=nb>round</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
        <span class=k>if</span> <span class=nb>round</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set round index &gt;=0 and &lt;&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_num_rounds</span><span class=p>))</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>round_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_round_ids</span><span class=p>[</span><span class=nb>round</span><span class=p>]</span>
    <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=nb>round</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
        <span class=k>if</span> <span class=nb>round</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_round_ids</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set valid round id&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>round_id</span> <span class=o>=</span> <span class=nb>round</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;round&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>None</span>
    <span class=k>try</span><span class=p>:</span>
        <span class=n>zattrs_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_polyDT_root_path</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>round_id</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;.zattrs&quot;</span><span class=p>)</span>
        <span class=p>)</span>
        <span class=n>attributes</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_json</span><span class=p>(</span><span class=n>zattrs_path</span><span class=p>)</span>
        <span class=n>rigid_xform_xyz_px</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>asarray</span><span class=p>(</span>
            <span class=n>attributes</span><span class=p>[</span><span class=s2>&quot;rigid_xform_xyz_px&quot;</span><span class=p>],</span> <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>float32</span>
        <span class=p>)</span>
        <span class=k>return</span> <span class=n>rigid_xform_xyz_px</span>
    <span class=k>except</span> <span class=p>(</span><span class=ne>FileNotFoundError</span><span class=p>,</span> <span class=n>json</span><span class=o>.</span><span class=n>JSONDecodeError</span><span class=p>):</span>
        <span class=nb>print</span><span class=p>(</span><span class=n>tile_id</span><span class=p>,</span> <span class=n>round_id</span><span class=p>)</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Rigid transform mapping back to first round not found.&quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>None</span>
</code></pre></div></td></tr></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id=merfish3danalysis.qi2labDataStore.qi2labDataStore.load_local_round_linker class="doc doc-heading"> <code class="highlight language-python"><span class=n>load_local_round_linker</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=n>bit</span><span class=p>)</span></code> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.load_local_round_linker class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-contents "> <p>Load fidicual round linked to readout bit for one tile.</p> <p><span class=doc-section-title>Parameters:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> <th>Default</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td> <code>tile</code> </td> <td> <code><span title="typing.Union">Union</span>[int, str]</code> </td> <td> <div class=doc-md-description> <p>Tile index or tile id.</p> </div> </td> <td> <em>required</em> </td> </tr> <tr class=doc-section-item> <td> <code>bit</code> </td> <td> <code><span title="typing.Union">Union</span>[int, str]</code> </td> <td> <div class=doc-md-description> <p>Bit index or bit id.</p> </div> </td> <td> <em>required</em> </td> </tr> </tbody> </table> <p><span class=doc-section-title>Returns:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td><code>round_linker</code></td> <td> <code><span title="typing.Optional">Optional</span>[<span title="typing.Sequence">Sequence</span>[int]]</code> </td> <td> <div class=doc-md-description> <p>Fidicual round linked to readout bit for one tile.</p> </div> </td> </tr> </tbody> </table> <details class=quote> <summary>Source code in <code>src/merfish3danalysis/qi2labDataStore.py</code></summary> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1912</span>
<span class=normal>1913</span>
<span class=normal>1914</span>
<span class=normal>1915</span>
<span class=normal>1916</span>
<span class=normal>1917</span>
<span class=normal>1918</span>
<span class=normal>1919</span>
<span class=normal>1920</span>
<span class=normal>1921</span>
<span class=normal>1922</span>
<span class=normal>1923</span>
<span class=normal>1924</span>
<span class=normal>1925</span>
<span class=normal>1926</span>
<span class=normal>1927</span>
<span class=normal>1928</span>
<span class=normal>1929</span>
<span class=normal>1930</span>
<span class=normal>1931</span>
<span class=normal>1932</span>
<span class=normal>1933</span>
<span class=normal>1934</span>
<span class=normal>1935</span>
<span class=normal>1936</span>
<span class=normal>1937</span>
<span class=normal>1938</span>
<span class=normal>1939</span>
<span class=normal>1940</span>
<span class=normal>1941</span>
<span class=normal>1942</span>
<span class=normal>1943</span>
<span class=normal>1944</span>
<span class=normal>1945</span>
<span class=normal>1946</span>
<span class=normal>1947</span>
<span class=normal>1948</span>
<span class=normal>1949</span>
<span class=normal>1950</span>
<span class=normal>1951</span>
<span class=normal>1952</span>
<span class=normal>1953</span>
<span class=normal>1954</span>
<span class=normal>1955</span>
<span class=normal>1956</span>
<span class=normal>1957</span>
<span class=normal>1958</span>
<span class=normal>1959</span>
<span class=normal>1960</span>
<span class=normal>1961</span>
<span class=normal>1962</span>
<span class=normal>1963</span>
<span class=normal>1964</span>
<span class=normal>1965</span>
<span class=normal>1966</span>
<span class=normal>1967</span>
<span class=normal>1968</span>
<span class=normal>1969</span>
<span class=normal>1970</span>
<span class=normal>1971</span>
<span class=normal>1972</span>
<span class=normal>1973</span>
<span class=normal>1974</span>
<span class=normal>1975</span>
<span class=normal>1976</span></pre></div></td><td class=code><div><pre><span></span><code><span class=k>def</span> <span class=nf>load_local_round_linker</span><span class=p>(</span>
    <span class=bp>self</span><span class=p>,</span>
    <span class=n>tile</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>],</span>
    <span class=n>bit</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>],</span>
<span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=n>Sequence</span><span class=p>[</span><span class=nb>int</span><span class=p>]]:</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Load fidicual round linked to readout bit for one tile.</span>

<span class=sd>    Parameters</span>
<span class=sd>    ----------</span>
<span class=sd>    tile : Union[int, str]</span>
<span class=sd>        Tile index or tile id.</span>
<span class=sd>    bit : Union[int, str]</span>
<span class=sd>        Bit index or bit id.</span>

<span class=sd>    Returns</span>
<span class=sd>    -------</span>
<span class=sd>    round_linker : Optional[Sequence[int]]</span>
<span class=sd>        Fidicual round linked to readout bit for one tile.</span>
<span class=sd>    &quot;&quot;&quot;</span>

    <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
        <span class=k>if</span> <span class=n>tile</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>tile</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set tile index &gt;=0 and &lt;=&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>))</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>tile_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>[</span><span class=n>tile</span><span class=p>]</span>
    <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
        <span class=k>if</span> <span class=n>tile</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;set valid tiled id.&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>tile_id</span> <span class=o>=</span> <span class=n>tile</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;tile&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>None</span>

    <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>bit</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
        <span class=k>if</span> <span class=n>bit</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>bit</span> <span class=o>&gt;</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>):</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set bit index &gt;=0 and &lt;=&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>)))</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>bit_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>[</span><span class=n>bit</span><span class=p>]</span>
    <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>bit</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
        <span class=k>if</span> <span class=n>bit</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set valid bit id.&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>bit_id</span> <span class=o>=</span> <span class=n>bit</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;bit&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>None</span>

    <span class=k>try</span><span class=p>:</span>
        <span class=n>zattrs_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_readouts_root_path</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>bit_id</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;.zattrs&quot;</span><span class=p>)</span>
        <span class=p>)</span>
        <span class=n>attributes</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_json</span><span class=p>(</span><span class=n>zattrs_path</span><span class=p>)</span>
        <span class=k>return</span> <span class=nb>int</span><span class=p>(</span><span class=n>attributes</span><span class=p>[</span><span class=s2>&quot;round_linker&quot;</span><span class=p>])</span>
    <span class=k>except</span> <span class=ne>FileNotFoundError</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=n>tile_id</span><span class=p>,</span> <span class=n>bit_id</span><span class=p>)</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Round linker attribute not found.&quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>None</span>
</code></pre></div></td></tr></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id=merfish3danalysis.qi2labDataStore.qi2labDataStore.load_local_stage_position_zyx_um class="doc doc-heading"> <code class="highlight language-python"><span class=n>load_local_stage_position_zyx_um</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>round</span><span class=p>)</span></code> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.load_local_stage_position_zyx_um class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-contents "> <p>Load tile stage position for one tile.</p> <p><span class=doc-section-title>Parameters:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> <th>Default</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td> <code>tile</code> </td> <td> <code><span title="typing.Union">Union</span>[int, str]</code> </td> <td> <div class=doc-md-description> <p>Tile index or tile id.</p> </div> </td> <td> <em>required</em> </td> </tr> <tr class=doc-section-item> <td> <code>round</code> </td> <td> <code><span title="typing.Union">Union</span>[int, str]</code> </td> <td> <div class=doc-md-description> <p>Round index or round id.</p> </div> </td> <td> <em>required</em> </td> </tr> </tbody> </table> <p><span class=doc-section-title>Returns:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td><code>stage_zyx_um</code></td> <td> <code><span title="typing.Optional">Optional</span>[<span title="numpy.typing.ArrayLike">ArrayLike</span>]</code> </td> <td> <div class=doc-md-description> <p>Tile stage position for one tile.</p> </div> </td> </tr> </tbody> </table> <details class=quote> <summary>Source code in <code>src/merfish3danalysis/qi2labDataStore.py</code></summary> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>2043</span>
<span class=normal>2044</span>
<span class=normal>2045</span>
<span class=normal>2046</span>
<span class=normal>2047</span>
<span class=normal>2048</span>
<span class=normal>2049</span>
<span class=normal>2050</span>
<span class=normal>2051</span>
<span class=normal>2052</span>
<span class=normal>2053</span>
<span class=normal>2054</span>
<span class=normal>2055</span>
<span class=normal>2056</span>
<span class=normal>2057</span>
<span class=normal>2058</span>
<span class=normal>2059</span>
<span class=normal>2060</span>
<span class=normal>2061</span>
<span class=normal>2062</span>
<span class=normal>2063</span>
<span class=normal>2064</span>
<span class=normal>2065</span>
<span class=normal>2066</span>
<span class=normal>2067</span>
<span class=normal>2068</span>
<span class=normal>2069</span>
<span class=normal>2070</span>
<span class=normal>2071</span>
<span class=normal>2072</span>
<span class=normal>2073</span>
<span class=normal>2074</span>
<span class=normal>2075</span>
<span class=normal>2076</span>
<span class=normal>2077</span>
<span class=normal>2078</span>
<span class=normal>2079</span>
<span class=normal>2080</span>
<span class=normal>2081</span>
<span class=normal>2082</span>
<span class=normal>2083</span>
<span class=normal>2084</span>
<span class=normal>2085</span>
<span class=normal>2086</span>
<span class=normal>2087</span>
<span class=normal>2088</span>
<span class=normal>2089</span>
<span class=normal>2090</span>
<span class=normal>2091</span>
<span class=normal>2092</span>
<span class=normal>2093</span>
<span class=normal>2094</span>
<span class=normal>2095</span>
<span class=normal>2096</span>
<span class=normal>2097</span>
<span class=normal>2098</span>
<span class=normal>2099</span>
<span class=normal>2100</span>
<span class=normal>2101</span>
<span class=normal>2102</span>
<span class=normal>2103</span>
<span class=normal>2104</span>
<span class=normal>2105</span>
<span class=normal>2106</span>
<span class=normal>2107</span></pre></div></td><td class=code><div><pre><span></span><code><span class=k>def</span> <span class=nf>load_local_stage_position_zyx_um</span><span class=p>(</span>
    <span class=bp>self</span><span class=p>,</span>
    <span class=n>tile</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>],</span>
    <span class=nb>round</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>],</span>
<span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=n>ArrayLike</span><span class=p>]:</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Load tile stage position for one tile.</span>

<span class=sd>    Parameters</span>
<span class=sd>    ----------</span>
<span class=sd>    tile : Union[int, str]</span>
<span class=sd>        Tile index or tile id.</span>
<span class=sd>    round : Union[int, str]</span>
<span class=sd>        Round index or round id.</span>

<span class=sd>    Returns</span>
<span class=sd>    -------</span>
<span class=sd>    stage_zyx_um : Optional[ArrayLike]</span>
<span class=sd>        Tile stage position for one tile.</span>
<span class=sd>    &quot;&quot;&quot;</span>

    <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
        <span class=k>if</span> <span class=n>tile</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>tile</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set tile index &gt;=0 and &lt;&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>))</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>tile_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>[</span><span class=n>tile</span><span class=p>]</span>
    <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
        <span class=k>if</span> <span class=n>tile</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;set valid tiled id.&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>tile_id</span> <span class=o>=</span> <span class=n>tile</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;tile&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>None</span>

    <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=nb>round</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
        <span class=k>if</span> <span class=nb>round</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set round index &gt;=0 and &lt;&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_num_rounds</span><span class=p>))</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>round_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_round_ids</span><span class=p>[</span><span class=nb>round</span><span class=p>]</span>
    <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=nb>round</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
        <span class=k>if</span> <span class=nb>round</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_round_ids</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set valid round id.&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>round_id</span> <span class=o>=</span> <span class=nb>round</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;round&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>None</span>

    <span class=k>try</span><span class=p>:</span>
        <span class=n>zattrs_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_polyDT_root_path</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>round_id</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;.zattrs&quot;</span><span class=p>)</span>
        <span class=p>)</span>
        <span class=n>attributes</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_json</span><span class=p>(</span><span class=n>zattrs_path</span><span class=p>)</span>
        <span class=k>return</span> <span class=n>np</span><span class=o>.</span><span class=n>asarray</span><span class=p>(</span><span class=n>attributes</span><span class=p>[</span><span class=s2>&quot;stage_zyx_um&quot;</span><span class=p>],</span> <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>float32</span><span class=p>)</span>
    <span class=k>except</span> <span class=ne>FileNotFoundError</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=n>tile_id</span><span class=p>,</span> <span class=n>round_id</span><span class=p>)</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Stage position attribute not found.&quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>None</span>
</code></pre></div></td></tr></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id=merfish3danalysis.qi2labDataStore.qi2labDataStore.load_local_ufish_image class="doc doc-heading"> <code class="highlight language-python"><span class=n>load_local_ufish_image</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=n>bit</span><span class=p>,</span> <span class=n>return_future</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span></code> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.load_local_ufish_image class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-contents "> <p>Load readout bit U-FISH prediction image for one tile.</p> <p><span class=doc-section-title>Parameters:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> <th>Default</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td> <code>tile</code> </td> <td> <code><span title="typing.Union">Union</span>[int, str]</code> </td> <td> <div class=doc-md-description> <p>Tile index or tile id.</p> </div> </td> <td> <em>required</em> </td> </tr> <tr class=doc-section-item> <td> <code>bit</code> </td> <td> <code><span title="typing.Union">Union</span>[int, str]</code> </td> <td> <div class=doc-md-description> <p>Bit index or bit id.</p> </div> </td> <td> <em>required</em> </td> </tr> <tr class=doc-section-item> <td> <code>return_future</code> </td> <td> <code><span title="typing.Optional">Optional</span>[bool]</code> </td> <td> <div class=doc-md-description> </div> </td> <td> <code>True</code> </td> </tr> </tbody> </table> <p><span class=doc-section-title>Returns:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td><code>registered_ufish_image</code></td> <td> <code><span title="typing.Optional">Optional</span>[<span title="numpy.typing.ArrayLike">ArrayLike</span>]</code> </td> <td> <div class=doc-md-description> <p>U-FISH prediction image for one tile.</p> </div> </td> </tr> </tbody> </table> <details class=quote> <summary>Source code in <code>src/merfish3danalysis/qi2labDataStore.py</code></summary> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>3184</span>
<span class=normal>3185</span>
<span class=normal>3186</span>
<span class=normal>3187</span>
<span class=normal>3188</span>
<span class=normal>3189</span>
<span class=normal>3190</span>
<span class=normal>3191</span>
<span class=normal>3192</span>
<span class=normal>3193</span>
<span class=normal>3194</span>
<span class=normal>3195</span>
<span class=normal>3196</span>
<span class=normal>3197</span>
<span class=normal>3198</span>
<span class=normal>3199</span>
<span class=normal>3200</span>
<span class=normal>3201</span>
<span class=normal>3202</span>
<span class=normal>3203</span>
<span class=normal>3204</span>
<span class=normal>3205</span>
<span class=normal>3206</span>
<span class=normal>3207</span>
<span class=normal>3208</span>
<span class=normal>3209</span>
<span class=normal>3210</span>
<span class=normal>3211</span>
<span class=normal>3212</span>
<span class=normal>3213</span>
<span class=normal>3214</span>
<span class=normal>3215</span>
<span class=normal>3216</span>
<span class=normal>3217</span>
<span class=normal>3218</span>
<span class=normal>3219</span>
<span class=normal>3220</span>
<span class=normal>3221</span>
<span class=normal>3222</span>
<span class=normal>3223</span>
<span class=normal>3224</span>
<span class=normal>3225</span>
<span class=normal>3226</span>
<span class=normal>3227</span>
<span class=normal>3228</span>
<span class=normal>3229</span>
<span class=normal>3230</span>
<span class=normal>3231</span>
<span class=normal>3232</span>
<span class=normal>3233</span>
<span class=normal>3234</span>
<span class=normal>3235</span>
<span class=normal>3236</span>
<span class=normal>3237</span>
<span class=normal>3238</span>
<span class=normal>3239</span>
<span class=normal>3240</span>
<span class=normal>3241</span>
<span class=normal>3242</span>
<span class=normal>3243</span>
<span class=normal>3244</span>
<span class=normal>3245</span>
<span class=normal>3246</span>
<span class=normal>3247</span>
<span class=normal>3248</span>
<span class=normal>3249</span>
<span class=normal>3250</span>
<span class=normal>3251</span>
<span class=normal>3252</span>
<span class=normal>3253</span>
<span class=normal>3254</span>
<span class=normal>3255</span>
<span class=normal>3256</span>
<span class=normal>3257</span>
<span class=normal>3258</span>
<span class=normal>3259</span>
<span class=normal>3260</span>
<span class=normal>3261</span></pre></div></td><td class=code><div><pre><span></span><code><span class=k>def</span> <span class=nf>load_local_ufish_image</span><span class=p>(</span>
    <span class=bp>self</span><span class=p>,</span>
    <span class=n>tile</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>],</span>
    <span class=n>bit</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>],</span>
    <span class=n>return_future</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>bool</span><span class=p>]</span> <span class=o>=</span> <span class=kc>True</span><span class=p>,</span>
<span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=n>ArrayLike</span><span class=p>]:</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Load readout bit U-FISH prediction image for one tile.</span>

<span class=sd>    Parameters</span>
<span class=sd>    ----------</span>
<span class=sd>    tile : Union[int, str]</span>
<span class=sd>        Tile index or tile id.</span>
<span class=sd>    bit : Union[int, str]</span>
<span class=sd>        Bit index or bit id.</span>
<span class=sd>    return_future : Optional[bool]</span>

<span class=sd>    Returns</span>
<span class=sd>    -------</span>
<span class=sd>    registered_ufish_image : Optional[ArrayLike]</span>
<span class=sd>        U-FISH prediction image for one tile.</span>
<span class=sd>    &quot;&quot;&quot;</span>

    <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
        <span class=k>if</span> <span class=n>tile</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>tile</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set tile index &gt;=0 and &lt;=&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>))</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>tile_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>[</span><span class=n>tile</span><span class=p>]</span>
    <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
        <span class=k>if</span> <span class=n>tile</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;set valid tiled id&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>tile_id</span> <span class=o>=</span> <span class=n>tile</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;tile&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>None</span>

    <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>bit</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
        <span class=k>if</span> <span class=n>bit</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>bit</span> <span class=o>&gt;</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>):</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set bit index &gt;=0 and &lt;=&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>)))</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>bit_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>[</span><span class=n>bit</span><span class=p>]</span>
    <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>bit</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
        <span class=k>if</span> <span class=n>bit</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set valid bit id&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>bit_id</span> <span class=o>=</span> <span class=n>bit</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;bit&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>None</span>

    <span class=n>current_local_zarr_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_readouts_root_path</span>
        <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
        <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>bit_id</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
        <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;registered_ufish_data&quot;</span><span class=p>)</span>
    <span class=p>)</span>

    <span class=k>if</span> <span class=ow>not</span> <span class=n>Path</span><span class=p>(</span><span class=n>current_local_zarr_path</span><span class=p>)</span><span class=o>.</span><span class=n>exists</span><span class=p>():</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;U-FISH prediction image not found.&quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>None</span>

    <span class=k>try</span><span class=p>:</span>
        <span class=n>spec</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_zarrv2_spec</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>
        <span class=n>spec</span><span class=p>[</span><span class=s2>&quot;metadata&quot;</span><span class=p>][</span><span class=s2>&quot;dtype&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&quot;&lt;f4&quot;</span>
        <span class=n>registered_ufish_image</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_zarr_array</span><span class=p>(</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_get_kvstore_key</span><span class=p>(</span><span class=n>current_local_zarr_path</span><span class=p>),</span>
            <span class=n>spec</span><span class=p>,</span>
            <span class=n>return_future</span><span class=p>,</span>
        <span class=p>)</span>
        <span class=k>return</span> <span class=n>registered_ufish_image</span>
    <span class=k>except</span> <span class=p>(</span><span class=ne>IOError</span><span class=p>,</span> <span class=ne>OSError</span><span class=p>,</span> <span class=n>ZarrError</span><span class=p>)</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=n>e</span><span class=p>)</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Error loading U-FISH image.&quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>None</span>
</code></pre></div></td></tr></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id=merfish3danalysis.qi2labDataStore.qi2labDataStore.load_local_ufish_spots class="doc doc-heading"> <code class="highlight language-python"><span class=n>load_local_ufish_spots</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=n>bit</span><span class=p>)</span></code> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.load_local_ufish_spots class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-contents "> <p>Load U-FISH spot localizations and features for one tile.</p> <p><span class=doc-section-title>Parameters:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> <th>Default</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td> <code>tile</code> </td> <td> <code><span title="typing.Union">Union</span>[int, str]</code> </td> <td> <div class=doc-md-description> <p>Tile index or tile id.</p> </div> </td> <td> <em>required</em> </td> </tr> <tr class=doc-section-item> <td> <code>bit</code> </td> <td> <code><span title="typing.Union">Union</span>[int, str]</code> </td> <td> <div class=doc-md-description> <p>Bit index or bit id.</p> </div> </td> <td> <em>required</em> </td> </tr> </tbody> </table> <p><span class=doc-section-title>Returns:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td><code>ufish_localizations</code></td> <td> <code><span title="typing.Optional">Optional</span>[<span title="pandas.DataFrame">DataFrame</span>]</code> </td> <td> <div class=doc-md-description> <p>U-FISH localizations and features for one tile.</p> </div> </td> </tr> </tbody> </table> <details class=quote> <summary>Source code in <code>src/merfish3danalysis/qi2labDataStore.py</code></summary> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>3335</span>
<span class=normal>3336</span>
<span class=normal>3337</span>
<span class=normal>3338</span>
<span class=normal>3339</span>
<span class=normal>3340</span>
<span class=normal>3341</span>
<span class=normal>3342</span>
<span class=normal>3343</span>
<span class=normal>3344</span>
<span class=normal>3345</span>
<span class=normal>3346</span>
<span class=normal>3347</span>
<span class=normal>3348</span>
<span class=normal>3349</span>
<span class=normal>3350</span>
<span class=normal>3351</span>
<span class=normal>3352</span>
<span class=normal>3353</span>
<span class=normal>3354</span>
<span class=normal>3355</span>
<span class=normal>3356</span>
<span class=normal>3357</span>
<span class=normal>3358</span>
<span class=normal>3359</span>
<span class=normal>3360</span>
<span class=normal>3361</span>
<span class=normal>3362</span>
<span class=normal>3363</span>
<span class=normal>3364</span>
<span class=normal>3365</span>
<span class=normal>3366</span>
<span class=normal>3367</span>
<span class=normal>3368</span>
<span class=normal>3369</span>
<span class=normal>3370</span>
<span class=normal>3371</span>
<span class=normal>3372</span>
<span class=normal>3373</span>
<span class=normal>3374</span>
<span class=normal>3375</span>
<span class=normal>3376</span>
<span class=normal>3377</span>
<span class=normal>3378</span>
<span class=normal>3379</span>
<span class=normal>3380</span>
<span class=normal>3381</span>
<span class=normal>3382</span>
<span class=normal>3383</span>
<span class=normal>3384</span>
<span class=normal>3385</span>
<span class=normal>3386</span>
<span class=normal>3387</span>
<span class=normal>3388</span>
<span class=normal>3389</span>
<span class=normal>3390</span>
<span class=normal>3391</span>
<span class=normal>3392</span>
<span class=normal>3393</span>
<span class=normal>3394</span>
<span class=normal>3395</span>
<span class=normal>3396</span>
<span class=normal>3397</span>
<span class=normal>3398</span>
<span class=normal>3399</span>
<span class=normal>3400</span></pre></div></td><td class=code><div><pre><span></span><code><span class=k>def</span> <span class=nf>load_local_ufish_spots</span><span class=p>(</span>
    <span class=bp>self</span><span class=p>,</span>
    <span class=n>tile</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>],</span>
    <span class=n>bit</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>],</span>
<span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>]:</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Load U-FISH spot localizations and features for one tile.</span>

<span class=sd>    Parameters</span>
<span class=sd>    ----------</span>
<span class=sd>    tile : Union[int, str]</span>
<span class=sd>        Tile index or tile id.</span>
<span class=sd>    bit : Union[int, str]</span>
<span class=sd>        Bit index or bit id.</span>

<span class=sd>    Returns</span>
<span class=sd>    -------</span>
<span class=sd>    ufish_localizations : Optional[pd.DataFrame]</span>
<span class=sd>        U-FISH localizations and features for one tile.</span>
<span class=sd>    &quot;&quot;&quot;</span>

    <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
        <span class=k>if</span> <span class=n>tile</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>tile</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set tile index &gt;=0 and &lt;=&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>))</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>tile_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>[</span><span class=n>tile</span><span class=p>]</span>
    <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
        <span class=k>if</span> <span class=n>tile</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;set valid tiled id&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>tile_id</span> <span class=o>=</span> <span class=n>tile</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;tile&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>None</span>

    <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>bit</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
        <span class=k>if</span> <span class=n>bit</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>bit</span> <span class=o>&gt;</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>):</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set bit index &gt;=0 and &lt;=&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>)))</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>bit_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>[</span><span class=n>bit</span><span class=p>]</span>
    <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>bit</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
        <span class=k>if</span> <span class=n>bit</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set valid bit id&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>bit_id</span> <span class=o>=</span> <span class=n>bit</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;bit&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>None</span>

    <span class=n>current_ufish_localizations_path</span> <span class=o>=</span> <span class=p>(</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_ufish_localizations_root_path</span>
        <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
        <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>bit_id</span> <span class=o>+</span> <span class=s2>&quot;.parquet&quot;</span><span class=p>)</span>
    <span class=p>)</span>

    <span class=k>if</span> <span class=ow>not</span> <span class=n>current_ufish_localizations_path</span><span class=o>.</span><span class=n>exists</span><span class=p>():</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;U-FISH localizations not found.&quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>None</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=n>ufish_localizations</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_parquet</span><span class=p>(</span>
            <span class=n>current_ufish_localizations_path</span>
        <span class=p>)</span>
        <span class=k>return</span> <span class=n>ufish_localizations</span>
</code></pre></div></td></tr></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id=merfish3danalysis.qi2labDataStore.qi2labDataStore.load_local_wavelengths_um class="doc doc-heading"> <code class="highlight language-python"><span class=n>load_local_wavelengths_um</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>round</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>bit</span><span class=o>=</span><span class=kc>None</span><span class=p>)</span></code> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.load_local_wavelengths_um class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-contents "> <p>Load wavelengths for fidicual OR readout bit for one tile.</p> <p><span class=doc-section-title>Parameters:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> <th>Default</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td> <code>tile</code> </td> <td> <code><span title="typing.Union">Union</span>[int, str]</code> </td> <td> <div class=doc-md-description> <p>Tile index or tile id.</p> </div> </td> <td> <em>required</em> </td> </tr> <tr class=doc-section-item> <td> <code>round</code> </td> <td> <code><span title="typing.Optional">Optional</span>[<span title="typing.Union">Union</span>[int, str]]</code> </td> <td> <div class=doc-md-description> <p>Round index or round id.</p> </div> </td> <td> <code>None</code> </td> </tr> <tr class=doc-section-item> <td> <code>bit</code> </td> <td> <code><span title="typing.Optional">Optional</span>[<span title="typing.Union">Union</span>[int, str]]</code> </td> <td> <div class=doc-md-description> <p>Bit index or bit id.</p> </div> </td> <td> <code>None</code> </td> </tr> </tbody> </table> <p><span class=doc-section-title>Returns:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td><code>wavelengths_um</code></td> <td> <code><span title="typing.Optional">Optional</span>[tuple[float, float]]</code> </td> <td> <div class=doc-md-description> <p>Wavelengths for fidicual OR readout bit for one tile.</p> </div> </td> </tr> </tbody> </table> <details class=quote> <summary>Source code in <code>src/merfish3danalysis/qi2labDataStore.py</code></summary> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>2179</span>
<span class=normal>2180</span>
<span class=normal>2181</span>
<span class=normal>2182</span>
<span class=normal>2183</span>
<span class=normal>2184</span>
<span class=normal>2185</span>
<span class=normal>2186</span>
<span class=normal>2187</span>
<span class=normal>2188</span>
<span class=normal>2189</span>
<span class=normal>2190</span>
<span class=normal>2191</span>
<span class=normal>2192</span>
<span class=normal>2193</span>
<span class=normal>2194</span>
<span class=normal>2195</span>
<span class=normal>2196</span>
<span class=normal>2197</span>
<span class=normal>2198</span>
<span class=normal>2199</span>
<span class=normal>2200</span>
<span class=normal>2201</span>
<span class=normal>2202</span>
<span class=normal>2203</span>
<span class=normal>2204</span>
<span class=normal>2205</span>
<span class=normal>2206</span>
<span class=normal>2207</span>
<span class=normal>2208</span>
<span class=normal>2209</span>
<span class=normal>2210</span>
<span class=normal>2211</span>
<span class=normal>2212</span>
<span class=normal>2213</span>
<span class=normal>2214</span>
<span class=normal>2215</span>
<span class=normal>2216</span>
<span class=normal>2217</span>
<span class=normal>2218</span>
<span class=normal>2219</span>
<span class=normal>2220</span>
<span class=normal>2221</span>
<span class=normal>2222</span>
<span class=normal>2223</span>
<span class=normal>2224</span>
<span class=normal>2225</span>
<span class=normal>2226</span>
<span class=normal>2227</span>
<span class=normal>2228</span>
<span class=normal>2229</span>
<span class=normal>2230</span>
<span class=normal>2231</span>
<span class=normal>2232</span>
<span class=normal>2233</span>
<span class=normal>2234</span>
<span class=normal>2235</span>
<span class=normal>2236</span>
<span class=normal>2237</span>
<span class=normal>2238</span>
<span class=normal>2239</span>
<span class=normal>2240</span>
<span class=normal>2241</span>
<span class=normal>2242</span>
<span class=normal>2243</span>
<span class=normal>2244</span>
<span class=normal>2245</span>
<span class=normal>2246</span>
<span class=normal>2247</span>
<span class=normal>2248</span>
<span class=normal>2249</span>
<span class=normal>2250</span>
<span class=normal>2251</span>
<span class=normal>2252</span>
<span class=normal>2253</span>
<span class=normal>2254</span>
<span class=normal>2255</span>
<span class=normal>2256</span>
<span class=normal>2257</span>
<span class=normal>2258</span>
<span class=normal>2259</span>
<span class=normal>2260</span>
<span class=normal>2261</span>
<span class=normal>2262</span>
<span class=normal>2263</span>
<span class=normal>2264</span>
<span class=normal>2265</span>
<span class=normal>2266</span>
<span class=normal>2267</span>
<span class=normal>2268</span>
<span class=normal>2269</span>
<span class=normal>2270</span>
<span class=normal>2271</span>
<span class=normal>2272</span>
<span class=normal>2273</span>
<span class=normal>2274</span></pre></div></td><td class=code><div><pre><span></span><code><span class=k>def</span> <span class=nf>load_local_wavelengths_um</span><span class=p>(</span>
    <span class=bp>self</span><span class=p>,</span>
    <span class=n>tile</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>],</span>
    <span class=nb>round</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>]]</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span>
    <span class=n>bit</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>]]</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span>
<span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>tuple</span><span class=p>[</span><span class=nb>float</span><span class=p>,</span> <span class=nb>float</span><span class=p>]]:</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Load wavelengths for fidicual OR readout bit for one tile.</span>

<span class=sd>    Parameters</span>
<span class=sd>    ----------</span>
<span class=sd>    tile : Union[int, str]</span>
<span class=sd>        Tile index or tile id.</span>
<span class=sd>    round : Optional[Union[int, str]]   </span>
<span class=sd>        Round index or round id.</span>
<span class=sd>    bit : Optional[Union[int, str]]</span>
<span class=sd>        Bit index or bit id.</span>

<span class=sd>    Returns</span>
<span class=sd>    -------</span>
<span class=sd>    wavelengths_um : Optional[tuple[float, float]]</span>
<span class=sd>        Wavelengths for fidicual OR readout bit for one tile.</span>
<span class=sd>    &quot;&quot;&quot;</span>

    <span class=k>if</span> <span class=p>(</span><span class=nb>round</span> <span class=ow>is</span> <span class=kc>None</span> <span class=ow>and</span> <span class=n>bit</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>)</span> <span class=ow>or</span> <span class=p>(</span><span class=nb>round</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span> <span class=ow>and</span> <span class=n>bit</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>):</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Provide either &#39;round&#39; or &#39;bit&#39;, but not both&quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>None</span>

    <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
        <span class=k>if</span> <span class=n>tile</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>tile</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set tile index &gt;=0 and &lt;=&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>))</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>tile_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>[</span><span class=n>tile</span><span class=p>]</span>
    <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
        <span class=k>if</span> <span class=n>tile</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;set valid tiled id&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>tile_id</span> <span class=o>=</span> <span class=n>tile</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;tile&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>None</span>

    <span class=k>if</span> <span class=n>bit</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>bit</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
            <span class=k>if</span> <span class=n>bit</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>bit</span> <span class=o>&gt;</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>):</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set bit index &gt;=0 and &lt;=&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>)))</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>local_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>[</span><span class=n>bit</span><span class=p>]</span>
        <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>bit</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
            <span class=k>if</span> <span class=n>bit</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set valid bit id&quot;</span><span class=p>)</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>local_id</span> <span class=o>=</span> <span class=n>bit</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;bit&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=n>zattrs_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_readouts_root_path</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>local_id</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;.zattrs&quot;</span><span class=p>)</span>
        <span class=p>)</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=nb>round</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
            <span class=k>if</span> <span class=nb>round</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set round index &gt;=0 and &lt;&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_num_rounds</span><span class=p>))</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>local_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_round_ids</span><span class=p>[</span><span class=nb>round</span><span class=p>]</span>
        <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=nb>round</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
            <span class=k>if</span> <span class=nb>round</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_round_ids</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set valid round id&quot;</span><span class=p>)</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>local_id</span> <span class=o>=</span> <span class=nb>round</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;round&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=n>zattrs_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_polyDT_root_path</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>local_id</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;.zattrs&quot;</span><span class=p>)</span>
        <span class=p>)</span>

    <span class=k>try</span><span class=p>:</span>
        <span class=n>attributes</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_json</span><span class=p>(</span><span class=n>zattrs_path</span><span class=p>)</span>
        <span class=n>ex_wavelength_um</span> <span class=o>=</span> <span class=n>attributes</span><span class=p>[</span><span class=s2>&quot;excitation_um&quot;</span><span class=p>]</span>
        <span class=n>em_wavelength_um</span> <span class=o>=</span> <span class=n>attributes</span><span class=p>[</span><span class=s2>&quot;emission_um&quot;</span><span class=p>]</span>
        <span class=k>return</span> <span class=p>(</span><span class=n>ex_wavelength_um</span><span class=p>,</span> <span class=n>em_wavelength_um</span><span class=p>)</span>
    <span class=k>except</span> <span class=ne>KeyError</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Wavelength attributes not found.&quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>None</span>
</code></pre></div></td></tr></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id=merfish3danalysis.qi2labDataStore.qi2labDataStore.reformat_baysor_3D_oultines class="doc doc-heading"> <code class="highlight language-python"><span class=n>reformat_baysor_3D_oultines</span><span class=p>()</span></code> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.reformat_baysor_3D_oultines class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-contents "> <p>Reformat baysor 3D json file into ImageJ ROIs.</p> <details class=quote> <summary>Source code in <code>src/merfish3danalysis/qi2labDataStore.py</code></summary> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>3988</span>
<span class=normal>3989</span>
<span class=normal>3990</span>
<span class=normal>3991</span>
<span class=normal>3992</span>
<span class=normal>3993</span>
<span class=normal>3994</span>
<span class=normal>3995</span>
<span class=normal>3996</span>
<span class=normal>3997</span>
<span class=normal>3998</span>
<span class=normal>3999</span>
<span class=normal>4000</span>
<span class=normal>4001</span>
<span class=normal>4002</span>
<span class=normal>4003</span>
<span class=normal>4004</span>
<span class=normal>4005</span>
<span class=normal>4006</span>
<span class=normal>4007</span>
<span class=normal>4008</span>
<span class=normal>4009</span>
<span class=normal>4010</span>
<span class=normal>4011</span>
<span class=normal>4012</span>
<span class=normal>4013</span>
<span class=normal>4014</span>
<span class=normal>4015</span>
<span class=normal>4016</span>
<span class=normal>4017</span>
<span class=normal>4018</span>
<span class=normal>4019</span>
<span class=normal>4020</span>
<span class=normal>4021</span>
<span class=normal>4022</span>
<span class=normal>4023</span>
<span class=normal>4024</span>
<span class=normal>4025</span>
<span class=normal>4026</span>
<span class=normal>4027</span>
<span class=normal>4028</span>
<span class=normal>4029</span>
<span class=normal>4030</span>
<span class=normal>4031</span>
<span class=normal>4032</span>
<span class=normal>4033</span>
<span class=normal>4034</span>
<span class=normal>4035</span>
<span class=normal>4036</span>
<span class=normal>4037</span>
<span class=normal>4038</span>
<span class=normal>4039</span>
<span class=normal>4040</span>
<span class=normal>4041</span>
<span class=normal>4042</span>
<span class=normal>4043</span>
<span class=normal>4044</span>
<span class=normal>4045</span>
<span class=normal>4046</span></pre></div></td><td class=code><div><pre><span></span><code><span class=k>def</span> <span class=nf>reformat_baysor_3D_oultines</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Reformat baysor 3D json file into ImageJ ROIs.&quot;&quot;&quot;</span>
    <span class=kn>import</span> <span class=nn>re</span>

    <span class=c1># Load the JSON file</span>
    <span class=n>baysor_output_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_segmentation_root_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;baysor&quot;</span><span class=p>)</span>
    <span class=n>baysor_segmentation</span> <span class=o>=</span> <span class=n>baysor_output_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=sa>r</span><span class=s2>&quot;segmentation_polygons_3d.json&quot;</span><span class=p>)</span>
    <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>baysor_segmentation</span><span class=p>,</span> <span class=s1>&#39;r&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>file</span><span class=p>:</span>
        <span class=n>data</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=n>file</span><span class=p>)</span>


    <span class=c1># Dictionary to group polygons by cell ID</span>
    <span class=n>cell_polygons</span> <span class=o>=</span> <span class=n>defaultdict</span><span class=p>(</span><span class=nb>list</span><span class=p>)</span>

    <span class=k>def</span> <span class=nf>parse_z_range</span><span class=p>(</span><span class=n>z_range</span><span class=p>):</span>
        <span class=n>cleaned_range</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>sub</span><span class=p>(</span><span class=sa>r</span><span class=s2>&quot;[^\d.,-]&quot;</span><span class=p>,</span> <span class=s2>&quot;&quot;</span><span class=p>,</span> <span class=n>z_range</span><span class=p>)</span>  <span class=c1># Remove non-numeric, non-period, non-comma, non-dash characters</span>
        <span class=k>return</span> <span class=nb>map</span><span class=p>(</span><span class=nb>float</span><span class=p>,</span> <span class=n>cleaned_range</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&quot;,&quot;</span><span class=p>))</span>

    <span class=c1># Iterate through each z-plane and corresponding polygons</span>
    <span class=k>for</span> <span class=n>z_range</span><span class=p>,</span> <span class=n>details</span> <span class=ow>in</span> <span class=n>data</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
        <span class=n>z_start</span><span class=p>,</span> <span class=n>z_end</span> <span class=o>=</span> <span class=n>parse_z_range</span><span class=p>(</span><span class=n>z_range</span><span class=p>)</span>

        <span class=k>for</span> <span class=n>geometry</span> <span class=ow>in</span> <span class=n>details</span><span class=p>[</span><span class=s2>&quot;geometries&quot;</span><span class=p>]:</span>
            <span class=n>coordinates</span> <span class=o>=</span> <span class=n>geometry</span><span class=p>[</span><span class=s2>&quot;coordinates&quot;</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span>  <span class=c1># Assuming the outer ring of the polygon</span>
            <span class=n>cell_id</span> <span class=o>=</span> <span class=n>geometry</span><span class=p>[</span><span class=s2>&quot;cell&quot;</span><span class=p>]</span>  <span class=c1># Get the cell ID</span>

            <span class=c1># Store the polygon with its z-range</span>
            <span class=n>cell_polygons</span><span class=p>[</span><span class=n>cell_id</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
                <span class=s2>&quot;z_start&quot;</span><span class=p>:</span> <span class=n>z_start</span><span class=p>,</span>
                <span class=s2>&quot;z_end&quot;</span><span class=p>:</span> <span class=n>z_end</span><span class=p>,</span>
                <span class=s2>&quot;coordinates&quot;</span><span class=p>:</span> <span class=n>coordinates</span>
            <span class=p>})</span>

    <span class=n>rois</span> <span class=o>=</span> <span class=p>[]</span>

    <span class=c1># Process each cell ID to create 3D ROIs</span>
    <span class=k>for</span> <span class=n>cell_id</span><span class=p>,</span> <span class=n>polygons</span> <span class=ow>in</span> <span class=n>cell_polygons</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
        <span class=k>for</span> <span class=n>idx</span><span class=p>,</span> <span class=n>polygon</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>polygons</span><span class=p>):</span>
            <span class=n>x_coords</span> <span class=o>=</span> <span class=p>[</span><span class=n>point</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=k>for</span> <span class=n>point</span> <span class=ow>in</span> <span class=n>polygon</span><span class=p>[</span><span class=s2>&quot;coordinates&quot;</span><span class=p>]]</span>
            <span class=n>y_coords</span> <span class=o>=</span> <span class=p>[</span><span class=n>point</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=k>for</span> <span class=n>point</span> <span class=ow>in</span> <span class=n>polygon</span><span class=p>[</span><span class=s2>&quot;coordinates&quot;</span><span class=p>]]</span>


            <span class=n>z_start</span> <span class=o>=</span> <span class=n>polygon</span><span class=p>[</span><span class=s2>&quot;z_start&quot;</span><span class=p>]</span>
            <span class=n>z_end</span> <span class=o>=</span> <span class=n>polygon</span><span class=p>[</span><span class=s2>&quot;z_end&quot;</span><span class=p>]</span>

            <span class=k>try</span><span class=p>:</span>
                <span class=c1># Create an ImageJRoi object for the polygon using frompoints</span>
                <span class=n>coords</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=nb>zip</span><span class=p>(</span><span class=n>x_coords</span><span class=p>,</span> <span class=n>y_coords</span><span class=p>))</span>  <span class=c1># List of (x, y) tuples</span>
                <span class=n>roi</span> <span class=o>=</span> <span class=n>ImagejRoi</span><span class=o>.</span><span class=n>frompoints</span><span class=p>(</span><span class=n>coords</span><span class=p>)</span>
                <span class=n>roi</span><span class=o>.</span><span class=n>roitype</span> <span class=o>=</span> <span class=n>ROI_TYPE</span><span class=o>.</span><span class=n>POLYGON</span>  <span class=c1># Set the ROI type to Polygon</span>
                <span class=n>roi</span><span class=o>.</span><span class=n>coordinates</span> <span class=o>=</span> <span class=n>coords</span>  <span class=c1># Explicitly assign coordinates to the ROI</span>
                <span class=n>roi</span><span class=o>.</span><span class=n>name</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&quot;cell_</span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>cell_id</span><span class=p>)</span><span class=si>}</span><span class=s2>_zstart_</span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>z_start</span><span class=p>)</span><span class=si>}</span><span class=s2>_zend_</span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>z_end</span><span class=p>)</span><span class=si>}</span><span class=s2>&quot;</span>  <span class=c1># Ensure unique name</span>
                <span class=n>rois</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>roi</span><span class=p>)</span>
            <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Error while creating ROI for cell ID </span><span class=si>{</span><span class=n>cell_id</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>

    <span class=c1># Write all ROIs to a ZIP file   </span>
    <span class=n>output_file</span> <span class=o>=</span> <span class=n>baysor_output_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=sa>r</span><span class=s2>&quot;3d_cell_rois.zip&quot;</span><span class=p>)</span>
    <span class=n>roiwrite</span><span class=p>(</span><span class=n>output_file</span><span class=p>,</span> <span class=n>rois</span><span class=p>,</span><span class=n>mode</span><span class=o>=</span><span class=s1>&#39;w&#39;</span><span class=p>)</span>
</code></pre></div></td></tr></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id=merfish3danalysis.qi2labDataStore.qi2labDataStore.reprocess_and_save_filtered_spots_with_baysor_outlines class="doc doc-heading"> <code class="highlight language-python"><span class=n>reprocess_and_save_filtered_spots_with_baysor_outlines</span><span class=p>()</span></code> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.reprocess_and_save_filtered_spots_with_baysor_outlines class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-contents "> <p>Reprocess filtered spots using baysor cell outlines, then save.</p> <p>Loads the 3D cell outlines from Baysor, checks all points to see what (if any) cell outline that the spot falls within, and then saves the data back to the datastore.</p> <details class=quote> <summary>Source code in <code>src/merfish3danalysis/qi2labDataStore.py</code></summary> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>4104</span>
<span class=normal>4105</span>
<span class=normal>4106</span>
<span class=normal>4107</span>
<span class=normal>4108</span>
<span class=normal>4109</span>
<span class=normal>4110</span>
<span class=normal>4111</span>
<span class=normal>4112</span>
<span class=normal>4113</span>
<span class=normal>4114</span>
<span class=normal>4115</span>
<span class=normal>4116</span>
<span class=normal>4117</span>
<span class=normal>4118</span>
<span class=normal>4119</span>
<span class=normal>4120</span>
<span class=normal>4121</span>
<span class=normal>4122</span>
<span class=normal>4123</span>
<span class=normal>4124</span>
<span class=normal>4125</span>
<span class=normal>4126</span>
<span class=normal>4127</span>
<span class=normal>4128</span>
<span class=normal>4129</span>
<span class=normal>4130</span>
<span class=normal>4131</span>
<span class=normal>4132</span>
<span class=normal>4133</span>
<span class=normal>4134</span>
<span class=normal>4135</span>
<span class=normal>4136</span>
<span class=normal>4137</span>
<span class=normal>4138</span>
<span class=normal>4139</span>
<span class=normal>4140</span>
<span class=normal>4141</span>
<span class=normal>4142</span>
<span class=normal>4143</span>
<span class=normal>4144</span>
<span class=normal>4145</span>
<span class=normal>4146</span>
<span class=normal>4147</span>
<span class=normal>4148</span>
<span class=normal>4149</span>
<span class=normal>4150</span>
<span class=normal>4151</span>
<span class=normal>4152</span>
<span class=normal>4153</span>
<span class=normal>4154</span>
<span class=normal>4155</span>
<span class=normal>4156</span>
<span class=normal>4157</span>
<span class=normal>4158</span>
<span class=normal>4159</span>
<span class=normal>4160</span>
<span class=normal>4161</span>
<span class=normal>4162</span>
<span class=normal>4163</span>
<span class=normal>4164</span>
<span class=normal>4165</span>
<span class=normal>4166</span>
<span class=normal>4167</span>
<span class=normal>4168</span>
<span class=normal>4169</span>
<span class=normal>4170</span>
<span class=normal>4171</span>
<span class=normal>4172</span>
<span class=normal>4173</span>
<span class=normal>4174</span>
<span class=normal>4175</span>
<span class=normal>4176</span>
<span class=normal>4177</span>
<span class=normal>4178</span>
<span class=normal>4179</span>
<span class=normal>4180</span>
<span class=normal>4181</span>
<span class=normal>4182</span></pre></div></td><td class=code><div><pre><span></span><code><span class=k>def</span> <span class=nf>reprocess_and_save_filtered_spots_with_baysor_outlines</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Reprocess filtered spots using baysor cell outlines, then save.</span>

<span class=sd>    Loads the 3D cell outlines from Baysor, checks all points to see what </span>
<span class=sd>    (if any) cell outline that the spot falls within, and then saves the</span>
<span class=sd>    data back to the datastore.</span>
<span class=sd>    &quot;&quot;&quot;</span>
    <span class=kn>from</span> <span class=nn>rtree</span> <span class=kn>import</span> <span class=n>index</span>
    <span class=kn>import</span> <span class=nn>re</span>

    <span class=n>rois</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>load_global_baysor_outlines</span><span class=p>()</span>
    <span class=n>filtered_spots_df</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>load_global_filtered_decoded_spots</span><span class=p>()</span>

    <span class=n>parsed_spots_df</span> <span class=o>=</span> <span class=n>filtered_spots_df</span><span class=p>[</span>
            <span class=p>[</span>
                <span class=s2>&quot;gene_id&quot;</span><span class=p>,</span>
                <span class=s2>&quot;global_z&quot;</span><span class=p>,</span>
                <span class=s2>&quot;global_y&quot;</span><span class=p>,</span>
                <span class=s2>&quot;global_x&quot;</span><span class=p>,</span>
                <span class=s2>&quot;cell_id&quot;</span><span class=p>,</span>
                <span class=s2>&quot;tile_idx&quot;</span><span class=p>,</span>
            <span class=p>]</span>
    <span class=p>]</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>
    <span class=n>parsed_spots_df</span><span class=o>.</span><span class=n>rename</span><span class=p>(</span>
        <span class=n>columns</span><span class=o>=</span><span class=p>{</span>
            <span class=s2>&quot;global_x&quot;</span><span class=p>:</span> <span class=s2>&quot;x&quot;</span><span class=p>,</span>
            <span class=s2>&quot;global_y&quot;</span><span class=p>:</span> <span class=s2>&quot;y&quot;</span><span class=p>,</span>
            <span class=s2>&quot;global_z&quot;</span><span class=p>:</span> <span class=s2>&quot;z&quot;</span><span class=p>,</span>
            <span class=s2>&quot;gene_id&quot;</span> <span class=p>:</span> <span class=s2>&quot;gene&quot;</span><span class=p>,</span>
            <span class=s2>&quot;cell_id&quot;</span> <span class=p>:</span> <span class=s2>&quot;cell&quot;</span><span class=p>,</span>
        <span class=p>},</span>
        <span class=n>inplace</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
    <span class=p>)</span>
    <span class=n>parsed_spots_df</span><span class=p>[</span><span class=s2>&quot;transcript_id&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>util</span><span class=o>.</span><span class=n>hash_pandas_object</span><span class=p>(</span>
        <span class=n>parsed_spots_df</span><span class=p>,</span> <span class=n>index</span><span class=o>=</span><span class=kc>False</span>
    <span class=p>)</span>

    <span class=n>parsed_spots_df</span><span class=p>[</span><span class=s2>&quot;assignment_confidence&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=mf>1.0</span>

    <span class=c1># Create spatial index for ROIs</span>
    <span class=n>roi_index</span> <span class=o>=</span> <span class=n>index</span><span class=o>.</span><span class=n>Index</span><span class=p>()</span>
    <span class=n>roi_map</span> <span class=o>=</span> <span class=p>{}</span>  <span class=c1># Map index IDs to ROIs</span>

    <span class=k>for</span> <span class=n>idx</span><span class=p>,</span> <span class=n>roi</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>rois</span><span class=p>):</span>
        <span class=c1># Ensure roi.coordinates contains the polygon points</span>
        <span class=n>coords</span> <span class=o>=</span> <span class=n>roi</span><span class=o>.</span><span class=n>coordinates</span><span class=p>()</span>

        <span class=c1># Insert the polygon bounds into the spatial index</span>
        <span class=n>polygon</span> <span class=o>=</span> <span class=n>Polygon</span><span class=p>(</span><span class=n>coords</span><span class=p>)</span>
        <span class=n>roi_index</span><span class=o>.</span><span class=n>insert</span><span class=p>(</span><span class=n>idx</span><span class=p>,</span> <span class=n>polygon</span><span class=o>.</span><span class=n>bounds</span><span class=p>)</span>  <span class=c1># Use polygon bounds for indexing</span>
        <span class=n>roi_map</span><span class=p>[</span><span class=n>idx</span><span class=p>]</span> <span class=o>=</span> <span class=n>roi</span>

    <span class=c1># Function to check a single point</span>
    <span class=k>def</span> <span class=nf>point_in_roi</span><span class=p>(</span><span class=n>row</span><span class=p>):</span>
        <span class=n>point</span> <span class=o>=</span> <span class=n>Point</span><span class=p>(</span><span class=n>row</span><span class=p>[</span><span class=s2>&quot;x&quot;</span><span class=p>],</span> <span class=n>row</span><span class=p>[</span><span class=s2>&quot;y&quot;</span><span class=p>])</span>
        <span class=n>candidate_indices</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=n>roi_index</span><span class=o>.</span><span class=n>intersection</span><span class=p>(</span><span class=n>point</span><span class=o>.</span><span class=n>bounds</span><span class=p>))</span>  <span class=c1># Search spatial index</span>
        <span class=k>for</span> <span class=n>idx</span> <span class=ow>in</span> <span class=n>candidate_indices</span><span class=p>:</span>
            <span class=n>roi</span> <span class=o>=</span> <span class=n>roi_map</span><span class=p>[</span><span class=n>idx</span><span class=p>]</span>
            <span class=n>match</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>search</span><span class=p>(</span><span class=sa>r</span><span class=s2>&quot;zstart_([-\d.]+)_zend_([-\d.]+)&quot;</span><span class=p>,</span> <span class=n>roi</span><span class=o>.</span><span class=n>name</span><span class=p>)</span>
            <span class=k>if</span> <span class=n>match</span><span class=p>:</span>
                <span class=n>z_start</span> <span class=o>=</span> <span class=nb>float</span><span class=p>(</span><span class=n>match</span><span class=o>.</span><span class=n>group</span><span class=p>(</span><span class=mi>1</span><span class=p>))</span>
                <span class=n>z_end</span> <span class=o>=</span> <span class=nb>float</span><span class=p>(</span><span class=n>match</span><span class=o>.</span><span class=n>group</span><span class=p>(</span><span class=mi>2</span><span class=p>))</span>
                <span class=k>if</span> <span class=n>z_start</span> <span class=o>&lt;=</span> <span class=n>row</span><span class=p>[</span><span class=s2>&quot;z&quot;</span><span class=p>]</span> <span class=o>&lt;=</span> <span class=n>z_end</span><span class=p>:</span>
                    <span class=n>polygon</span> <span class=o>=</span> <span class=n>Polygon</span><span class=p>(</span><span class=n>roi</span><span class=o>.</span><span class=n>coordinates</span><span class=p>())</span>
                    <span class=k>if</span> <span class=n>polygon</span><span class=o>.</span><span class=n>contains</span><span class=p>(</span><span class=n>point</span><span class=p>):</span>
                        <span class=k>return</span> <span class=nb>str</span><span class=p>(</span><span class=n>roi</span><span class=o>.</span><span class=n>name</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&quot;_&quot;</span><span class=p>)[</span><span class=mi>1</span><span class=p>])</span> 
        <span class=k>return</span> <span class=o>-</span><span class=mi>1</span>

    <span class=c1># Apply optimized spatial lookup</span>
    <span class=n>parsed_spots_df</span><span class=p>[</span><span class=s2>&quot;cell&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>parsed_spots_df</span><span class=o>.</span><span class=n>apply</span><span class=p>(</span><span class=n>point_in_roi</span><span class=p>,</span> <span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
    <span class=n>parsed_spots_df</span> <span class=o>=</span> <span class=n>parsed_spots_df</span><span class=o>.</span><span class=n>loc</span><span class=p>[</span><span class=n>parsed_spots_df</span><span class=p>[</span><span class=s2>&quot;cell&quot;</span><span class=p>]</span> <span class=o>!=</span> <span class=o>-</span><span class=mi>1</span><span class=p>]</span>

    <span class=n>current_global_filtered_decoded_path</span> <span class=o>=</span> <span class=p>(</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_path</span> 
        <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;all_tiles_filtered_decoded_features&quot;</span><span class=p>)</span>
        <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;refined_transcripts.parquet&quot;</span><span class=p>)</span>
    <span class=p>)</span>

    <span class=bp>self</span><span class=o>.</span><span class=n>_save_to_parquet</span><span class=p>(</span><span class=n>parsed_spots_df</span><span class=p>,</span> <span class=n>current_global_filtered_decoded_path</span><span class=p>)</span>
</code></pre></div></td></tr></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id=merfish3danalysis.qi2labDataStore.qi2labDataStore.run_baysor class="doc doc-heading"> <code class="highlight language-python"><span class=n>run_baysor</span><span class=p>()</span></code> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.run_baysor class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-contents "> <p>Run Baysor"</p> <p>Assumes that spots are prepped for Baysor and the Baysor path and options are set. Reformats ROIs into ImageJ style ROIs for later use.</p> <details class=quote> <summary>Source code in <code>src/merfish3danalysis/qi2labDataStore.py</code></summary> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>3944</span>
<span class=normal>3945</span>
<span class=normal>3946</span>
<span class=normal>3947</span>
<span class=normal>3948</span>
<span class=normal>3949</span>
<span class=normal>3950</span>
<span class=normal>3951</span>
<span class=normal>3952</span>
<span class=normal>3953</span>
<span class=normal>3954</span>
<span class=normal>3955</span>
<span class=normal>3956</span>
<span class=normal>3957</span>
<span class=normal>3958</span>
<span class=normal>3959</span>
<span class=normal>3960</span>
<span class=normal>3961</span>
<span class=normal>3962</span>
<span class=normal>3963</span>
<span class=normal>3964</span>
<span class=normal>3965</span>
<span class=normal>3966</span>
<span class=normal>3967</span>
<span class=normal>3968</span>
<span class=normal>3969</span>
<span class=normal>3970</span>
<span class=normal>3971</span>
<span class=normal>3972</span>
<span class=normal>3973</span>
<span class=normal>3974</span>
<span class=normal>3975</span>
<span class=normal>3976</span>
<span class=normal>3977</span>
<span class=normal>3978</span>
<span class=normal>3979</span>
<span class=normal>3980</span>
<span class=normal>3981</span>
<span class=normal>3982</span>
<span class=normal>3983</span>
<span class=normal>3984</span>
<span class=normal>3985</span>
<span class=normal>3986</span></pre></div></td><td class=code><div><pre><span></span><code><span class=k>def</span> <span class=nf>run_baysor</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Run Baysor&quot;</span>

<span class=sd>    Assumes that spots are prepped for Baysor and the Baysor path and options are set.</span>
<span class=sd>    Reformats ROIs into ImageJ style ROIs for later use.</span>
<span class=sd>    &quot;&quot;&quot;</span>

    <span class=kn>import</span> <span class=nn>subprocess</span>

    <span class=n>baysor_input_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;all_tiles_filtered_decoded_features&quot;</span><span class=p>)</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;transcripts.parquet&quot;</span><span class=p>)</span>
    <span class=n>baysor_output_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_segmentation_root_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;baysor&quot;</span><span class=p>)</span>
    <span class=n>baysor_output_path</span><span class=o>.</span><span class=n>mkdir</span><span class=p>(</span><span class=n>exist_ok</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>

    <span class=n>julia_threading</span> <span class=o>=</span> <span class=sa>r</span><span class=s2>&quot;JULIA_NUM_THREADS=&quot;</span><span class=o>+</span><span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_julia_threads</span><span class=p>)</span><span class=o>+</span> <span class=s2>&quot; &quot;</span>
    <span class=n>preview_baysor_options</span> <span class=o>=</span> <span class=sa>r</span><span class=s2>&quot;preview -c &quot;</span> <span class=o>+</span><span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_baysor_options</span><span class=p>)</span>
    <span class=n>command</span> <span class=o>=</span> <span class=n>julia_threading</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_baysor_path</span><span class=p>)</span> <span class=o>+</span> <span class=s2>&quot; &quot;</span> <span class=o>+</span> <span class=n>preview_baysor_options</span> <span class=o>+</span> <span class=s2>&quot; &quot;</span> <span class=o>+</span>\
        <span class=nb>str</span><span class=p>(</span><span class=n>baysor_input_path</span><span class=p>)</span> <span class=o>+</span> <span class=s2>&quot; -o &quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=n>baysor_output_path</span><span class=p>)</span>

    <span class=k>try</span><span class=p>:</span>
        <span class=n>result</span> <span class=o>=</span> <span class=n>subprocess</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>command</span><span class=p>,</span> <span class=n>shell</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>check</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Baysor finished with return code:&quot;</span><span class=p>,</span> <span class=n>result</span><span class=o>.</span><span class=n>returncode</span><span class=p>)</span>
    <span class=k>except</span> <span class=n>subprocess</span><span class=o>.</span><span class=n>CalledProcessError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Baysor failed with:&quot;</span><span class=p>,</span> <span class=n>e</span><span class=p>)</span>

    <span class=c1># first try to run Baysor assuming that prior segmentations are present               </span>
    <span class=k>try</span><span class=p>:</span>
        <span class=n>run_baysor_options</span> <span class=o>=</span> <span class=sa>r</span><span class=s2>&quot;run -p -c &quot;</span> <span class=o>+</span><span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_baysor_options</span><span class=p>)</span>
        <span class=n>command</span> <span class=o>=</span> <span class=n>julia_threading</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_baysor_path</span><span class=p>)</span> <span class=o>+</span> <span class=s2>&quot; &quot;</span> <span class=o>+</span> <span class=n>run_baysor_options</span> <span class=o>+</span> <span class=s2>&quot; &quot;</span> <span class=o>+</span>\
            <span class=nb>str</span><span class=p>(</span><span class=n>baysor_input_path</span><span class=p>)</span> <span class=o>+</span> <span class=s2>&quot; -o &quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=n>baysor_output_path</span><span class=p>)</span> <span class=o>+</span> \
            <span class=s2>&quot; --polygon-format GeometryCollectionLegacy --count-matrix-format tsv :cell_id&quot;</span>
        <span class=n>result</span> <span class=o>=</span> <span class=n>subprocess</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>command</span><span class=p>,</span> <span class=n>shell</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>check</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Baysor finished with return code:&quot;</span><span class=p>,</span> <span class=n>result</span><span class=o>.</span><span class=n>returncode</span><span class=p>)</span>
    <span class=k>except</span> <span class=n>subprocess</span><span class=o>.</span><span class=n>CalledProcessError</span><span class=p>:</span>
        <span class=c1># then fall back and run without prior segmentations.</span>
        <span class=c1># IMPORTANT: the .toml file has to be defined correctly for this to work!</span>
        <span class=k>try</span><span class=p>:</span>
            <span class=n>run_baysor_options</span> <span class=o>=</span> <span class=sa>r</span><span class=s2>&quot;run -p -c &quot;</span> <span class=o>+</span><span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_baysor_options</span><span class=p>)</span>
            <span class=n>command</span> <span class=o>=</span> <span class=n>julia_threading</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_baysor_path</span><span class=p>)</span> <span class=o>+</span> <span class=s2>&quot; &quot;</span> <span class=o>+</span> <span class=n>run_baysor_options</span> <span class=o>+</span> <span class=s2>&quot; &quot;</span> <span class=o>+</span>\
                <span class=nb>str</span><span class=p>(</span><span class=n>baysor_input_path</span><span class=p>)</span> <span class=o>+</span> <span class=s2>&quot; -o &quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=n>baysor_output_path</span><span class=p>)</span> <span class=o>+</span> <span class=s2>&quot; --count-matrix-format tsv&quot;</span>
            <span class=n>result</span> <span class=o>=</span> <span class=n>subprocess</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>command</span><span class=p>,</span> <span class=n>shell</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>check</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Baysor finished with return code:&quot;</span><span class=p>,</span> <span class=n>result</span><span class=o>.</span><span class=n>returncode</span><span class=p>)</span>
        <span class=k>except</span> <span class=n>subprocess</span><span class=o>.</span><span class=n>CalledProcessError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Baysor failed with:&quot;</span><span class=p>,</span> <span class=n>e</span><span class=p>)</span>
</code></pre></div></td></tr></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id=merfish3danalysis.qi2labDataStore.qi2labDataStore.save_coord_of_xform_px class="doc doc-heading"> <code class="highlight language-python"><span class=n>save_coord_of_xform_px</span><span class=p>(</span><span class=n>of_xform_px</span><span class=p>,</span> <span class=n>tile</span><span class=p>,</span> <span class=n>downsampling</span><span class=p>,</span> <span class=nb>round</span><span class=p>,</span> <span class=n>return_future</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span></code> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.save_coord_of_xform_px class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-contents "> <p>Save fidicual optical flow matrix for one round and tile.</p> <p><span class=doc-section-title>Parameters:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> <th>Default</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td> <code>of_xform_px</code> </td> <td> <code><span title="numpy.typing.ArrayLike">ArrayLike</span></code> </td> <td> <div class=doc-md-description> <p>Local fidicual optical flow matrix for one round and tile.</p> </div> </td> <td> <em>required</em> </td> </tr> <tr class=doc-section-item> <td> <code>tile</code> </td> <td> <code><span title="typing.Union">Union</span>[int, str]</code> </td> <td> <div class=doc-md-description> <p>Tile index or tile id.</p> </div> </td> <td> <em>required</em> </td> </tr> <tr class=doc-section-item> <td> <code>downsampling</code> </td> <td> <code><span title="typing.Sequence">Sequence</span>[float]</code> </td> <td> <div class=doc-md-description> <p>Downsampling factor.</p> </div> </td> <td> <em>required</em> </td> </tr> <tr class=doc-section-item> <td> <code>round</code> </td> <td> <code><span title="typing.Union">Union</span>[int, str]</code> </td> <td> <div class=doc-md-description> <p>Round index or round id.</p> </div> </td> <td> <em>required</em> </td> </tr> <tr class=doc-section-item> <td> <code>return_future</code> </td> <td> <code><span title="typing.Optional">Optional</span>[bool]</code> </td> <td> <div class=doc-md-description> <p>Return future array.</p> </div> </td> <td> <code>False</code> </td> </tr> </tbody> </table> <details class=quote> <summary>Source code in <code>src/merfish3danalysis/qi2labDataStore.py</code></summary> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>2858</span>
<span class=normal>2859</span>
<span class=normal>2860</span>
<span class=normal>2861</span>
<span class=normal>2862</span>
<span class=normal>2863</span>
<span class=normal>2864</span>
<span class=normal>2865</span>
<span class=normal>2866</span>
<span class=normal>2867</span>
<span class=normal>2868</span>
<span class=normal>2869</span>
<span class=normal>2870</span>
<span class=normal>2871</span>
<span class=normal>2872</span>
<span class=normal>2873</span>
<span class=normal>2874</span>
<span class=normal>2875</span>
<span class=normal>2876</span>
<span class=normal>2877</span>
<span class=normal>2878</span>
<span class=normal>2879</span>
<span class=normal>2880</span>
<span class=normal>2881</span>
<span class=normal>2882</span>
<span class=normal>2883</span>
<span class=normal>2884</span>
<span class=normal>2885</span>
<span class=normal>2886</span>
<span class=normal>2887</span>
<span class=normal>2888</span>
<span class=normal>2889</span>
<span class=normal>2890</span>
<span class=normal>2891</span>
<span class=normal>2892</span>
<span class=normal>2893</span>
<span class=normal>2894</span>
<span class=normal>2895</span>
<span class=normal>2896</span>
<span class=normal>2897</span>
<span class=normal>2898</span>
<span class=normal>2899</span>
<span class=normal>2900</span>
<span class=normal>2901</span>
<span class=normal>2902</span>
<span class=normal>2903</span>
<span class=normal>2904</span>
<span class=normal>2905</span>
<span class=normal>2906</span>
<span class=normal>2907</span>
<span class=normal>2908</span>
<span class=normal>2909</span>
<span class=normal>2910</span>
<span class=normal>2911</span>
<span class=normal>2912</span>
<span class=normal>2913</span>
<span class=normal>2914</span>
<span class=normal>2915</span>
<span class=normal>2916</span>
<span class=normal>2917</span>
<span class=normal>2918</span>
<span class=normal>2919</span>
<span class=normal>2920</span>
<span class=normal>2921</span>
<span class=normal>2922</span>
<span class=normal>2923</span>
<span class=normal>2924</span>
<span class=normal>2925</span>
<span class=normal>2926</span>
<span class=normal>2927</span>
<span class=normal>2928</span>
<span class=normal>2929</span>
<span class=normal>2930</span>
<span class=normal>2931</span>
<span class=normal>2932</span>
<span class=normal>2933</span>
<span class=normal>2934</span>
<span class=normal>2935</span>
<span class=normal>2936</span>
<span class=normal>2937</span>
<span class=normal>2938</span>
<span class=normal>2939</span>
<span class=normal>2940</span>
<span class=normal>2941</span>
<span class=normal>2942</span>
<span class=normal>2943</span>
<span class=normal>2944</span>
<span class=normal>2945</span>
<span class=normal>2946</span>
<span class=normal>2947</span>
<span class=normal>2948</span>
<span class=normal>2949</span>
<span class=normal>2950</span>
<span class=normal>2951</span>
<span class=normal>2952</span>
<span class=normal>2953</span></pre></div></td><td class=code><div><pre><span></span><code><span class=k>def</span> <span class=nf>save_coord_of_xform_px</span><span class=p>(</span>
    <span class=bp>self</span><span class=p>,</span>
    <span class=n>of_xform_px</span><span class=p>:</span> <span class=n>ArrayLike</span><span class=p>,</span>
    <span class=n>tile</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>],</span>
    <span class=n>downsampling</span><span class=p>:</span> <span class=n>Sequence</span><span class=p>[</span><span class=nb>float</span><span class=p>],</span>
    <span class=nb>round</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>],</span>
    <span class=n>return_future</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>bool</span><span class=p>]</span> <span class=o>=</span> <span class=kc>False</span><span class=p>,</span>
<span class=p>):</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Save fidicual optical flow matrix for one round and tile.</span>

<span class=sd>    Parameters</span>
<span class=sd>    ----------</span>
<span class=sd>    of_xform_px : ArrayLike</span>
<span class=sd>        Local fidicual optical flow matrix for one round and tile.</span>
<span class=sd>    tile : Union[int, str]</span>
<span class=sd>        Tile index or tile id.</span>
<span class=sd>    downsampling : Sequence[float]</span>
<span class=sd>        Downsampling factor.</span>
<span class=sd>    round : Union[int, str] </span>
<span class=sd>        Round index or round id.</span>
<span class=sd>    return_future : Optional[bool]</span>
<span class=sd>        Return future array.</span>
<span class=sd>    &quot;&quot;&quot;</span>

    <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
        <span class=k>if</span> <span class=n>tile</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>tile</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set tile index &gt;=0 and &lt;=&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>))</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>tile_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>[</span><span class=n>tile</span><span class=p>]</span>
    <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
        <span class=k>if</span> <span class=n>tile</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;set valid tiled id&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>tile_id</span> <span class=o>=</span> <span class=n>tile</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;tile&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>None</span>

    <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=nb>round</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
        <span class=k>if</span> <span class=nb>round</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set round index &gt;=0 and &lt;&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_num_rounds</span><span class=p>))</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>local_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_round_ids</span><span class=p>[</span><span class=nb>round</span><span class=p>]</span>
    <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=nb>round</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
        <span class=k>if</span> <span class=nb>round</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_round_ids</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set valid round id&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>local_id</span> <span class=o>=</span> <span class=nb>round</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;round&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>None</span>
    <span class=n>current_local_zarr_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_polyDT_root_path</span>
        <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
        <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>local_id</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
        <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;of_xform_px&quot;</span><span class=p>)</span>
    <span class=p>)</span>
    <span class=n>current_local_zattrs_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_polyDT_root_path</span>
        <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
        <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>local_id</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
        <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;.zattrs&quot;</span><span class=p>)</span>
    <span class=p>)</span>

    <span class=k>try</span><span class=p>:</span>
        <span class=n>compressor</span> <span class=o>=</span> <span class=p>{</span>
            <span class=s2>&quot;id&quot;</span><span class=p>:</span> <span class=s2>&quot;blosc&quot;</span><span class=p>,</span>
            <span class=s2>&quot;cname&quot;</span><span class=p>:</span> <span class=s2>&quot;zstd&quot;</span><span class=p>,</span>
            <span class=s2>&quot;clevel&quot;</span><span class=p>:</span> <span class=mi>5</span><span class=p>,</span>
            <span class=s2>&quot;shuffle&quot;</span><span class=p>:</span> <span class=mi>2</span><span class=p>,</span>
        <span class=p>}</span>
        <span class=n>spec_of</span> <span class=o>=</span> <span class=p>{</span>
            <span class=s2>&quot;driver&quot;</span><span class=p>:</span> <span class=s2>&quot;zarr&quot;</span><span class=p>,</span>
            <span class=s2>&quot;kvstore&quot;</span><span class=p>:</span> <span class=kc>None</span><span class=p>,</span>
            <span class=s2>&quot;metadata&quot;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&quot;compressor&quot;</span><span class=p>:</span> <span class=n>compressor</span><span class=p>},</span>
            <span class=s2>&quot;open&quot;</span><span class=p>:</span> <span class=kc>True</span><span class=p>,</span>
            <span class=s2>&quot;assume_metadata&quot;</span><span class=p>:</span> <span class=kc>False</span><span class=p>,</span>
            <span class=s2>&quot;create&quot;</span><span class=p>:</span> <span class=kc>True</span><span class=p>,</span>
            <span class=s2>&quot;delete_existing&quot;</span><span class=p>:</span> <span class=kc>False</span><span class=p>,</span>
        <span class=p>}</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_save_to_zarr_array</span><span class=p>(</span>
            <span class=n>of_xform_px</span><span class=p>,</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_get_kvstore_key</span><span class=p>(</span><span class=n>current_local_zarr_path</span><span class=p>),</span>
            <span class=n>spec_of</span><span class=o>.</span><span class=n>copy</span><span class=p>(),</span>
            <span class=n>return_future</span><span class=p>,</span>
        <span class=p>)</span>
        <span class=n>attributes</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_json</span><span class=p>(</span><span class=n>current_local_zattrs_path</span><span class=p>)</span>
        <span class=n>attributes</span><span class=p>[</span><span class=s2>&quot;opticalflow_downsampling&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>downsampling</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_save_to_json</span><span class=p>(</span><span class=n>attributes</span><span class=p>,</span> <span class=n>current_local_zattrs_path</span><span class=p>)</span>
    <span class=k>except</span> <span class=p>(</span><span class=ne>IOError</span><span class=p>,</span> <span class=ne>OSError</span><span class=p>,</span> <span class=ne>TimeoutError</span><span class=p>):</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Error saving optical flow transform.&quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>None</span>
</code></pre></div></td></tr></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id=merfish3danalysis.qi2labDataStore.qi2labDataStore.save_global_cellpose_segmentation_image class="doc doc-heading"> <code class="highlight language-python"><span class=n>save_global_cellpose_segmentation_image</span><span class=p>(</span><span class=n>cellpose_image</span><span class=p>,</span> <span class=n>downsampling</span><span class=p>,</span> <span class=n>return_future</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span></code> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.save_global_cellpose_segmentation_image class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-contents "> <p>Save Cellpose max projection, downsampled segmentation image.</p> <p><span class=doc-section-title>Parameters:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> <th>Default</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td> <code>cellpose_image</code> </td> <td> <code><span title="numpy.typing.ArrayLike">ArrayLike</span></code> </td> <td> <div class=doc-md-description> <p>Cellpose max projection, downsampled segmentation image.</p> </div> </td> <td> <em>required</em> </td> </tr> <tr class=doc-section-item> <td> <code>downsampling</code> </td> <td> <code><span title="typing.Sequence">Sequence</span>[float]</code> </td> <td> <div class=doc-md-description> <p>Downsample factors.</p> </div> </td> <td> <em>required</em> </td> </tr> <tr class=doc-section-item> <td> <code>return_future</code> </td> <td> <code><span title="typing.Optional">Optional</span>[bool]</code> </td> <td> <div class=doc-md-description> <p>Return future array.</p> </div> </td> <td> <code>False</code> </td> </tr> </tbody> </table> <details class=quote> <summary>Source code in <code>src/merfish3danalysis/qi2labDataStore.py</code></summary> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>3876</span>
<span class=normal>3877</span>
<span class=normal>3878</span>
<span class=normal>3879</span>
<span class=normal>3880</span>
<span class=normal>3881</span>
<span class=normal>3882</span>
<span class=normal>3883</span>
<span class=normal>3884</span>
<span class=normal>3885</span>
<span class=normal>3886</span>
<span class=normal>3887</span>
<span class=normal>3888</span>
<span class=normal>3889</span>
<span class=normal>3890</span>
<span class=normal>3891</span>
<span class=normal>3892</span>
<span class=normal>3893</span>
<span class=normal>3894</span>
<span class=normal>3895</span>
<span class=normal>3896</span>
<span class=normal>3897</span>
<span class=normal>3898</span>
<span class=normal>3899</span>
<span class=normal>3900</span>
<span class=normal>3901</span>
<span class=normal>3902</span>
<span class=normal>3903</span>
<span class=normal>3904</span>
<span class=normal>3905</span>
<span class=normal>3906</span>
<span class=normal>3907</span>
<span class=normal>3908</span>
<span class=normal>3909</span>
<span class=normal>3910</span>
<span class=normal>3911</span>
<span class=normal>3912</span>
<span class=normal>3913</span>
<span class=normal>3914</span>
<span class=normal>3915</span>
<span class=normal>3916</span>
<span class=normal>3917</span>
<span class=normal>3918</span>
<span class=normal>3919</span>
<span class=normal>3920</span></pre></div></td><td class=code><div><pre><span></span><code><span class=k>def</span> <span class=nf>save_global_cellpose_segmentation_image</span><span class=p>(</span>
    <span class=bp>self</span><span class=p>,</span>
    <span class=n>cellpose_image</span><span class=p>:</span> <span class=n>ArrayLike</span><span class=p>,</span>
    <span class=n>downsampling</span><span class=p>:</span> <span class=n>Sequence</span><span class=p>[</span><span class=nb>float</span><span class=p>],</span>
    <span class=n>return_future</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>bool</span><span class=p>]</span> <span class=o>=</span> <span class=kc>False</span><span class=p>,</span>
<span class=p>):</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Save Cellpose max projection, downsampled segmentation image.</span>

<span class=sd>    Parameters</span>
<span class=sd>    ----------</span>
<span class=sd>    cellpose_image : ArrayLike</span>
<span class=sd>        Cellpose max projection, downsampled segmentation image.</span>
<span class=sd>    downsampling : Sequence[float]</span>
<span class=sd>        Downsample factors.</span>
<span class=sd>    return_future : Optional[bool]</span>
<span class=sd>        Return future array.</span>
<span class=sd>    &quot;&quot;&quot;</span>

    <span class=n>current_local_zarr_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_segmentation_root_path</span>
        <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;cellpose&quot;</span><span class=p>)</span>
        <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;cellpose.zarr&quot;</span><span class=p>)</span>
        <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;masks_polyDT_iso_zyx&quot;</span><span class=p>)</span>
    <span class=p>)</span>
    <span class=n>current_local_zattrs_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_segmentation_root_path</span>
        <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;cellpose&quot;</span><span class=p>)</span>
        <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;cellpose.zarr&quot;</span><span class=p>)</span>
        <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;masks_polyDT_iso_zyx&quot;</span><span class=p>)</span>
        <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;.zattrs&quot;</span><span class=p>)</span>
    <span class=p>)</span>

    <span class=n>attributes</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&quot;downsampling&quot;</span><span class=p>:</span> <span class=n>downsampling</span><span class=p>}</span>

    <span class=k>try</span><span class=p>:</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_save_to_zarr_array</span><span class=p>(</span>
            <span class=n>cellpose_image</span><span class=p>,</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_get_kvstore_key</span><span class=p>(</span><span class=n>current_local_zarr_path</span><span class=p>),</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_zarrv2_spec</span><span class=o>.</span><span class=n>copy</span><span class=p>(),</span>
            <span class=n>return_future</span><span class=p>,</span>
        <span class=p>)</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_save_to_json</span><span class=p>(</span><span class=n>attributes</span><span class=p>,</span> <span class=n>current_local_zattrs_path</span><span class=p>)</span>
    <span class=k>except</span> <span class=p>(</span><span class=ne>IOError</span><span class=p>,</span> <span class=ne>OSError</span><span class=p>,</span> <span class=ne>TimeoutError</span><span class=p>):</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Error saving Cellpose image.&quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>None</span>
</code></pre></div></td></tr></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id=merfish3danalysis.qi2labDataStore.qi2labDataStore.save_global_coord_xforms_um class="doc doc-heading"> <code class="highlight language-python"><span class=n>save_global_coord_xforms_um</span><span class=p>(</span><span class=n>affine_zyx_um</span><span class=p>,</span> <span class=n>origin_zyx_um</span><span class=p>,</span> <span class=n>spacing_zyx_um</span><span class=p>,</span> <span class=n>tile</span><span class=p>)</span></code> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.save_global_coord_xforms_um class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-contents "> <p>Save global registration transform for one tile.</p> <p><span class=doc-section-title>Parameters:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> <th>Default</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td> <code>affine_zyx_um</code> </td> <td> <code><span title="numpy.typing.ArrayLike">ArrayLike</span></code> </td> <td> <div class=doc-md-description> <p>Global affine registration transform for one tile.</p> </div> </td> <td> <em>required</em> </td> </tr> <tr class=doc-section-item> <td> <code>origin_zyx_um</code> </td> <td> <code><span title="numpy.typing.ArrayLike">ArrayLike</span></code> </td> <td> <div class=doc-md-description> <p>Global origin registration transform for one tile.</p> </div> </td> <td> <em>required</em> </td> </tr> <tr class=doc-section-item> <td> <code>spacing_zyx_um</code> </td> <td> <code><span title="numpy.typing.ArrayLike">ArrayLike</span></code> </td> <td> <div class=doc-md-description> <p>Global spacing registration transform for one tile.</p> </div> </td> <td> <em>required</em> </td> </tr> <tr class=doc-section-item> <td> <code>tile</code> </td> <td> <code><span title="typing.Union">Union</span>[int, str]</code> </td> <td> <div class=doc-md-description> <p>Tile index or tile id.</p> </div> </td> <td> <em>required</em> </td> </tr> </tbody> </table> <details class=quote> <summary>Source code in <code>src/merfish3danalysis/qi2labDataStore.py</code></summary> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>3522</span>
<span class=normal>3523</span>
<span class=normal>3524</span>
<span class=normal>3525</span>
<span class=normal>3526</span>
<span class=normal>3527</span>
<span class=normal>3528</span>
<span class=normal>3529</span>
<span class=normal>3530</span>
<span class=normal>3531</span>
<span class=normal>3532</span>
<span class=normal>3533</span>
<span class=normal>3534</span>
<span class=normal>3535</span>
<span class=normal>3536</span>
<span class=normal>3537</span>
<span class=normal>3538</span>
<span class=normal>3539</span>
<span class=normal>3540</span>
<span class=normal>3541</span>
<span class=normal>3542</span>
<span class=normal>3543</span>
<span class=normal>3544</span>
<span class=normal>3545</span>
<span class=normal>3546</span>
<span class=normal>3547</span>
<span class=normal>3548</span>
<span class=normal>3549</span>
<span class=normal>3550</span>
<span class=normal>3551</span>
<span class=normal>3552</span>
<span class=normal>3553</span>
<span class=normal>3554</span>
<span class=normal>3555</span>
<span class=normal>3556</span>
<span class=normal>3557</span>
<span class=normal>3558</span>
<span class=normal>3559</span>
<span class=normal>3560</span>
<span class=normal>3561</span>
<span class=normal>3562</span>
<span class=normal>3563</span>
<span class=normal>3564</span>
<span class=normal>3565</span>
<span class=normal>3566</span>
<span class=normal>3567</span>
<span class=normal>3568</span>
<span class=normal>3569</span>
<span class=normal>3570</span>
<span class=normal>3571</span>
<span class=normal>3572</span></pre></div></td><td class=code><div><pre><span></span><code><span class=k>def</span> <span class=nf>save_global_coord_xforms_um</span><span class=p>(</span>
    <span class=bp>self</span><span class=p>,</span>
    <span class=n>affine_zyx_um</span><span class=p>:</span> <span class=n>ArrayLike</span><span class=p>,</span>
    <span class=n>origin_zyx_um</span><span class=p>:</span> <span class=n>ArrayLike</span><span class=p>,</span>
    <span class=n>spacing_zyx_um</span><span class=p>:</span> <span class=n>ArrayLike</span><span class=p>,</span>
    <span class=n>tile</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>],</span>
<span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Save global registration transform for one tile.</span>

<span class=sd>    Parameters</span>
<span class=sd>    ----------</span>
<span class=sd>    affine_zyx_um : ArrayLike</span>
<span class=sd>        Global affine registration transform for one tile.</span>
<span class=sd>    origin_zyx_um : ArrayLike</span>
<span class=sd>        Global origin registration transform for one tile.</span>
<span class=sd>    spacing_zyx_um : ArrayLike</span>
<span class=sd>        Global spacing registration transform for one tile.</span>
<span class=sd>    tile : Union[int, str]</span>
<span class=sd>        Tile index or tile id.</span>
<span class=sd>    &quot;&quot;&quot;</span>
    <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
        <span class=k>if</span> <span class=n>tile</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>tile</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set tile index &gt;=0 and &lt;=&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>))</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>tile_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>[</span><span class=n>tile</span><span class=p>]</span>
    <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
        <span class=k>if</span> <span class=n>tile</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;set valid tiled id&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>tile_id</span> <span class=o>=</span> <span class=n>tile</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;tile&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>None</span>

    <span class=k>try</span><span class=p>:</span>
        <span class=n>zattrs_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_polyDT_root_path</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_round_ids</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;.zattrs&quot;</span><span class=p>)</span>
        <span class=p>)</span>
        <span class=n>attributes</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_json</span><span class=p>(</span><span class=n>zattrs_path</span><span class=p>)</span>
        <span class=n>attributes</span><span class=p>[</span><span class=s2>&quot;affine_zyx_um&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>affine_zyx_um</span><span class=o>.</span><span class=n>tolist</span><span class=p>()</span>
        <span class=n>attributes</span><span class=p>[</span><span class=s2>&quot;origin_zyx_um&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>origin_zyx_um</span><span class=o>.</span><span class=n>tolist</span><span class=p>()</span>
        <span class=n>attributes</span><span class=p>[</span><span class=s2>&quot;spacing_zyx_um&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>spacing_zyx_um</span><span class=o>.</span><span class=n>tolist</span><span class=p>()</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_save_to_json</span><span class=p>(</span><span class=n>attributes</span><span class=p>,</span> <span class=n>zattrs_path</span><span class=p>)</span>
    <span class=k>except</span> <span class=p>(</span><span class=ne>FileNotFoundError</span><span class=p>,</span> <span class=n>json</span><span class=o>.</span><span class=n>JSONDecodeError</span><span class=p>)</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=n>e</span><span class=p>)</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Could not save global coordinate transforms.&quot;</span><span class=p>)</span>
</code></pre></div></td></tr></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id=merfish3danalysis.qi2labDataStore.qi2labDataStore.save_global_fidicual_image class="doc doc-heading"> <code class="highlight language-python"><span class=n>save_global_fidicual_image</span><span class=p>(</span><span class=n>fused_image</span><span class=p>,</span> <span class=n>affine_zyx_um</span><span class=p>,</span> <span class=n>origin_zyx_um</span><span class=p>,</span> <span class=n>spacing_zyx_um</span><span class=p>,</span> <span class=n>fusion_type</span><span class=o>=</span><span class=s1>&#39;polyDT&#39;</span><span class=p>,</span> <span class=n>return_future</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span></code> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.save_global_fidicual_image class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-contents "> <p>Save downsampled, fused fidicual image.</p> <p><span class=doc-section-title>Parameters:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> <th>Default</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td> <code>fused_image</code> </td> <td> <code><span title="numpy.typing.ArrayLike">ArrayLike</span></code> </td> <td> <div class=doc-md-description> <p>Downsampled, fused fidicual image.</p> </div> </td> <td> <em>required</em> </td> </tr> <tr class=doc-section-item> <td> <code>affine_zyx_um</code> </td> <td> <code><span title="numpy.typing.ArrayLike">ArrayLike</span></code> </td> <td> <div class=doc-md-description> <p>Global affine registration transform for fused image.</p> </div> </td> <td> <em>required</em> </td> </tr> <tr class=doc-section-item> <td> <code>origin_zyx_um</code> </td> <td> <code><span title="numpy.typing.ArrayLike">ArrayLike</span></code> </td> <td> <div class=doc-md-description> <p>Global origin registration transform for fused image.</p> </div> </td> <td> <em>required</em> </td> </tr> <tr class=doc-section-item> <td> <code>spacing_zyx_um</code> </td> <td> <code><span title="numpy.typing.ArrayLike">ArrayLike</span></code> </td> <td> <div class=doc-md-description> <p>Global spacing registration transform for fused image.</p> </div> </td> <td> <em>required</em> </td> </tr> <tr class=doc-section-item> <td> <code>fusion_type</code> </td> <td> <code>str</code> </td> <td> <div class=doc-md-description> <p>Type of fusion (polyDT or all_channels).</p> </div> </td> <td> <code>&#39;polyDT&#39;</code> </td> </tr> <tr class=doc-section-item> <td> <code>return_future</code> </td> <td> <code><span title="typing.Optional">Optional</span>[bool]</code> </td> <td> <div class=doc-md-description> <p>Return future array.</p> </div> </td> <td> <code>False</code> </td> </tr> </tbody> </table> <details class=quote> <summary>Source code in <code>src/merfish3danalysis/qi2labDataStore.py</code></summary> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>3622</span>
<span class=normal>3623</span>
<span class=normal>3624</span>
<span class=normal>3625</span>
<span class=normal>3626</span>
<span class=normal>3627</span>
<span class=normal>3628</span>
<span class=normal>3629</span>
<span class=normal>3630</span>
<span class=normal>3631</span>
<span class=normal>3632</span>
<span class=normal>3633</span>
<span class=normal>3634</span>
<span class=normal>3635</span>
<span class=normal>3636</span>
<span class=normal>3637</span>
<span class=normal>3638</span>
<span class=normal>3639</span>
<span class=normal>3640</span>
<span class=normal>3641</span>
<span class=normal>3642</span>
<span class=normal>3643</span>
<span class=normal>3644</span>
<span class=normal>3645</span>
<span class=normal>3646</span>
<span class=normal>3647</span>
<span class=normal>3648</span>
<span class=normal>3649</span>
<span class=normal>3650</span>
<span class=normal>3651</span>
<span class=normal>3652</span>
<span class=normal>3653</span>
<span class=normal>3654</span>
<span class=normal>3655</span>
<span class=normal>3656</span>
<span class=normal>3657</span>
<span class=normal>3658</span>
<span class=normal>3659</span>
<span class=normal>3660</span>
<span class=normal>3661</span>
<span class=normal>3662</span>
<span class=normal>3663</span>
<span class=normal>3664</span>
<span class=normal>3665</span>
<span class=normal>3666</span>
<span class=normal>3667</span>
<span class=normal>3668</span>
<span class=normal>3669</span>
<span class=normal>3670</span>
<span class=normal>3671</span>
<span class=normal>3672</span>
<span class=normal>3673</span>
<span class=normal>3674</span>
<span class=normal>3675</span>
<span class=normal>3676</span>
<span class=normal>3677</span>
<span class=normal>3678</span></pre></div></td><td class=code><div><pre><span></span><code><span class=k>def</span> <span class=nf>save_global_fidicual_image</span><span class=p>(</span>
    <span class=bp>self</span><span class=p>,</span>
    <span class=n>fused_image</span><span class=p>:</span> <span class=n>ArrayLike</span><span class=p>,</span>
    <span class=n>affine_zyx_um</span><span class=p>:</span> <span class=n>ArrayLike</span><span class=p>,</span>
    <span class=n>origin_zyx_um</span><span class=p>:</span> <span class=n>ArrayLike</span><span class=p>,</span>
    <span class=n>spacing_zyx_um</span><span class=p>:</span> <span class=n>ArrayLike</span><span class=p>,</span>
    <span class=n>fusion_type</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s2>&quot;polyDT&quot;</span><span class=p>,</span>
    <span class=n>return_future</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>bool</span><span class=p>]</span> <span class=o>=</span> <span class=kc>False</span><span class=p>,</span>
<span class=p>):</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Save downsampled, fused fidicual image.</span>

<span class=sd>    Parameters</span>
<span class=sd>    ----------</span>
<span class=sd>    fused_image : ArrayLike</span>
<span class=sd>        Downsampled, fused fidicual image.</span>
<span class=sd>    affine_zyx_um : ArrayLike</span>
<span class=sd>        Global affine registration transform for fused image.</span>
<span class=sd>    origin_zyx_um : ArrayLike</span>
<span class=sd>        Global origin registration transform for fused image.</span>
<span class=sd>    spacing_zyx_um : ArrayLike</span>
<span class=sd>        Global spacing registration transform for fused image.</span>
<span class=sd>    fusion_type : str</span>
<span class=sd>        Type of fusion (polyDT or all_channels).</span>
<span class=sd>    return_future : Optional[bool]</span>
<span class=sd>        Return future array.</span>
<span class=sd>    &quot;&quot;&quot;</span>

    <span class=k>if</span> <span class=n>fusion_type</span> <span class=o>==</span> <span class=s2>&quot;polyDT&quot;</span><span class=p>:</span>
        <span class=n>filename</span> <span class=o>=</span> <span class=s2>&quot;fused_polyDT_iso_zyx&quot;</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=n>filename</span> <span class=o>=</span> <span class=s2>&quot;fused_all_channels_zyx&quot;</span>
    <span class=n>current_local_zarr_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_fused_root_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;fused.zarr&quot;</span><span class=p>)</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>filename</span><span class=p>)</span>
    <span class=p>)</span>
    <span class=n>current_local_zattrs_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_fused_root_path</span>
        <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;fused.zarr&quot;</span><span class=p>)</span>
        <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>filename</span><span class=p>)</span>
        <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;.zattrs&quot;</span><span class=p>)</span>
    <span class=p>)</span>

    <span class=n>attributes</span> <span class=o>=</span> <span class=p>{</span>
        <span class=s2>&quot;affine_zyx_um&quot;</span><span class=p>:</span> <span class=n>affine_zyx_um</span><span class=o>.</span><span class=n>tolist</span><span class=p>(),</span>
        <span class=s2>&quot;origin_zyx_um&quot;</span><span class=p>:</span> <span class=n>origin_zyx_um</span><span class=o>.</span><span class=n>tolist</span><span class=p>(),</span>
        <span class=s2>&quot;spacing_zyx_um&quot;</span><span class=p>:</span> <span class=n>spacing_zyx_um</span><span class=o>.</span><span class=n>tolist</span><span class=p>(),</span>
    <span class=p>}</span>
    <span class=k>try</span><span class=p>:</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_save_to_zarr_array</span><span class=p>(</span>
            <span class=n>fused_image</span><span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>uint16</span><span class=p>),</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_get_kvstore_key</span><span class=p>(</span><span class=n>current_local_zarr_path</span><span class=p>),</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_zarrv2_spec</span><span class=o>.</span><span class=n>copy</span><span class=p>(),</span>
            <span class=n>return_future</span><span class=p>,</span>
        <span class=p>)</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_save_to_json</span><span class=p>(</span><span class=n>attributes</span><span class=p>,</span> <span class=n>current_local_zattrs_path</span><span class=p>)</span>
    <span class=k>except</span> <span class=p>(</span><span class=ne>IOError</span><span class=p>,</span> <span class=ne>OSError</span><span class=p>,</span> <span class=ne>TimeoutError</span><span class=p>):</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Error saving fused image.&quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>None</span>
</code></pre></div></td></tr></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id=merfish3danalysis.qi2labDataStore.qi2labDataStore.save_global_filtered_decoded_spots class="doc doc-heading"> <code class="highlight language-python"><span class=n>save_global_filtered_decoded_spots</span><span class=p>(</span><span class=n>filtered_decoded_df</span><span class=p>)</span></code> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.save_global_filtered_decoded_spots class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-contents "> <p>Save all decoded and filtered spots.</p> <p><span class=doc-section-title>Parameters:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> <th>Default</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td> <code>filtered_decoded_df</code> </td> <td> <code><span title="pandas.DataFrame">DataFrame</span></code> </td> <td> <div class=doc-md-description> <p>All decoded and filtered spots.</p> </div> </td> <td> <em>required</em> </td> </tr> </tbody> </table> <details class=quote> <summary>Source code in <code>src/merfish3danalysis/qi2labDataStore.py</code></summary> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>3788</span>
<span class=normal>3789</span>
<span class=normal>3790</span>
<span class=normal>3791</span>
<span class=normal>3792</span>
<span class=normal>3793</span>
<span class=normal>3794</span>
<span class=normal>3795</span>
<span class=normal>3796</span>
<span class=normal>3797</span>
<span class=normal>3798</span>
<span class=normal>3799</span>
<span class=normal>3800</span>
<span class=normal>3801</span>
<span class=normal>3802</span>
<span class=normal>3803</span>
<span class=normal>3804</span>
<span class=normal>3805</span>
<span class=normal>3806</span>
<span class=normal>3807</span>
<span class=normal>3808</span>
<span class=normal>3809</span>
<span class=normal>3810</span>
<span class=normal>3811</span></pre></div></td><td class=code><div><pre><span></span><code><span class=k>def</span> <span class=nf>save_global_filtered_decoded_spots</span><span class=p>(</span>
    <span class=bp>self</span><span class=p>,</span>
    <span class=n>filtered_decoded_df</span><span class=p>:</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>,</span>
<span class=p>):</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Save all decoded and filtered spots.</span>

<span class=sd>    Parameters</span>
<span class=sd>    ----------</span>
<span class=sd>    filtered_decoded_df : pd.DataFrame</span>
<span class=sd>        All decoded and filtered spots.</span>
<span class=sd>    &quot;&quot;&quot;</span>

    <span class=n>current_global_filtered_decoded_dir_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span>
        <span class=s2>&quot;all_tiles_filtered_decoded_features&quot;</span>
    <span class=p>)</span>

    <span class=k>if</span> <span class=ow>not</span> <span class=n>current_global_filtered_decoded_dir_path</span><span class=o>.</span><span class=n>exists</span><span class=p>():</span>
        <span class=n>current_global_filtered_decoded_dir_path</span><span class=o>.</span><span class=n>mkdir</span><span class=p>()</span>

    <span class=n>current_global_filtered_decoded_path</span> <span class=o>=</span> <span class=p>(</span>
        <span class=n>current_global_filtered_decoded_dir_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;decoded_features.parquet&quot;</span><span class=p>)</span>
    <span class=p>)</span>

    <span class=bp>self</span><span class=o>.</span><span class=n>_save_to_parquet</span><span class=p>(</span><span class=n>filtered_decoded_df</span><span class=p>,</span> <span class=n>current_global_filtered_decoded_path</span><span class=p>)</span>
</code></pre></div></td></tr></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id=merfish3danalysis.qi2labDataStore.qi2labDataStore.save_local_bit_linker class="doc doc-heading"> <code class="highlight language-python"><span class=n>save_local_bit_linker</span><span class=p>(</span><span class=n>bit_linker</span><span class=p>,</span> <span class=n>tile</span><span class=p>,</span> <span class=nb>round</span><span class=p>)</span></code> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.save_local_bit_linker class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-contents "> <p>Save readout bits linked to fidicual round for one tile.</p> <p><span class=doc-section-title>Parameters:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> <th>Default</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td> <code>bit_linker</code> </td> <td> <code><span title="typing.Sequence">Sequence</span>[int]</code> </td> <td> <div class=doc-md-description> <p>Readout bits linked to fidicual round for one tile.</p> </div> </td> <td> <em>required</em> </td> </tr> <tr class=doc-section-item> <td> <code>tile</code> </td> <td> <code><span title="typing.Union">Union</span>[int, str]</code> </td> <td> <div class=doc-md-description> <p>Tile index or tile id.</p> </div> </td> <td> <em>required</em> </td> </tr> <tr class=doc-section-item> <td> <code>round</code> </td> <td> <code><span title="typing.Union">Union</span>[int, str]</code> </td> <td> <div class=doc-md-description> <p>Round index or round id.</p> </div> </td> <td> <em>required</em> </td> </tr> </tbody> </table> <details class=quote> <summary>Source code in <code>src/merfish3danalysis/qi2labDataStore.py</code></summary> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1847</span>
<span class=normal>1848</span>
<span class=normal>1849</span>
<span class=normal>1850</span>
<span class=normal>1851</span>
<span class=normal>1852</span>
<span class=normal>1853</span>
<span class=normal>1854</span>
<span class=normal>1855</span>
<span class=normal>1856</span>
<span class=normal>1857</span>
<span class=normal>1858</span>
<span class=normal>1859</span>
<span class=normal>1860</span>
<span class=normal>1861</span>
<span class=normal>1862</span>
<span class=normal>1863</span>
<span class=normal>1864</span>
<span class=normal>1865</span>
<span class=normal>1866</span>
<span class=normal>1867</span>
<span class=normal>1868</span>
<span class=normal>1869</span>
<span class=normal>1870</span>
<span class=normal>1871</span>
<span class=normal>1872</span>
<span class=normal>1873</span>
<span class=normal>1874</span>
<span class=normal>1875</span>
<span class=normal>1876</span>
<span class=normal>1877</span>
<span class=normal>1878</span>
<span class=normal>1879</span>
<span class=normal>1880</span>
<span class=normal>1881</span>
<span class=normal>1882</span>
<span class=normal>1883</span>
<span class=normal>1884</span>
<span class=normal>1885</span>
<span class=normal>1886</span>
<span class=normal>1887</span>
<span class=normal>1888</span>
<span class=normal>1889</span>
<span class=normal>1890</span>
<span class=normal>1891</span>
<span class=normal>1892</span>
<span class=normal>1893</span>
<span class=normal>1894</span>
<span class=normal>1895</span>
<span class=normal>1896</span>
<span class=normal>1897</span>
<span class=normal>1898</span>
<span class=normal>1899</span>
<span class=normal>1900</span>
<span class=normal>1901</span>
<span class=normal>1902</span>
<span class=normal>1903</span>
<span class=normal>1904</span>
<span class=normal>1905</span>
<span class=normal>1906</span>
<span class=normal>1907</span>
<span class=normal>1908</span>
<span class=normal>1909</span>
<span class=normal>1910</span></pre></div></td><td class=code><div><pre><span></span><code><span class=k>def</span> <span class=nf>save_local_bit_linker</span><span class=p>(</span>
    <span class=bp>self</span><span class=p>,</span>
    <span class=n>bit_linker</span><span class=p>:</span> <span class=n>Sequence</span><span class=p>[</span><span class=nb>int</span><span class=p>],</span>
    <span class=n>tile</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>],</span>
    <span class=nb>round</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>],</span>
<span class=p>):</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Save readout bits linked to fidicual round for one tile.</span>

<span class=sd>    Parameters</span>
<span class=sd>    ----------</span>
<span class=sd>    bit_linker : Sequence[int]</span>
<span class=sd>        Readout bits linked to fidicual round for one tile.</span>
<span class=sd>    tile : Union[int, str]</span>
<span class=sd>        Tile index or tile id.</span>
<span class=sd>    round : Union[int, str]</span>
<span class=sd>        Round index or round id.</span>
<span class=sd>    &quot;&quot;&quot;</span>

    <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
        <span class=k>if</span> <span class=n>tile</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>tile</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set tile index &gt;=0 and &lt;&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>))</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>tile_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>[</span><span class=n>tile</span><span class=p>]</span>
    <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
        <span class=k>if</span> <span class=n>tile</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;set valid tiled id.&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>tile_id</span> <span class=o>=</span> <span class=n>tile</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;tile&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>None</span>

    <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=nb>round</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
        <span class=k>if</span> <span class=nb>round</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set round index &gt;=0 and &lt;&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_num_rounds</span><span class=p>))</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>round_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_round_ids</span><span class=p>[</span><span class=nb>round</span><span class=p>]</span>
    <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=nb>round</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
        <span class=k>if</span> <span class=nb>round</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_round_ids</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set valid round id.&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>round_id</span> <span class=o>=</span> <span class=nb>round</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;round&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>None</span>

    <span class=k>try</span><span class=p>:</span>
        <span class=n>zattrs_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_polyDT_root_path</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>round_id</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;.zattrs&quot;</span><span class=p>)</span>
        <span class=p>)</span>
        <span class=n>attributes</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_json</span><span class=p>(</span><span class=n>zattrs_path</span><span class=p>)</span>
        <span class=n>attributes</span><span class=p>[</span><span class=s2>&quot;bits&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>bit_linker</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_save_to_json</span><span class=p>(</span><span class=n>attributes</span><span class=p>,</span> <span class=n>zattrs_path</span><span class=p>)</span>
    <span class=k>except</span> <span class=p>(</span><span class=ne>FileNotFoundError</span><span class=p>,</span> <span class=n>json</span><span class=o>.</span><span class=n>JSONDecodeError</span><span class=p>):</span>
        <span class=nb>print</span><span class=p>(</span><span class=n>tile_id</span><span class=p>,</span> <span class=n>round_id</span><span class=p>)</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Error writing bit linker attribute.&quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>None</span>
</code></pre></div></td></tr></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id=merfish3danalysis.qi2labDataStore.qi2labDataStore.save_local_corrected_image class="doc doc-heading"> <code class="highlight language-python"><span class=n>save_local_corrected_image</span><span class=p>(</span><span class=n>image</span><span class=p>,</span> <span class=n>tile</span><span class=p>,</span> <span class=n>gain_correction</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>hotpixel_correction</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>shading_correction</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>psf_idx</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span> <span class=nb>round</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>bit</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>return_future</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span></code> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.save_local_corrected_image class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-contents "> <p>Save gain and offset corrected image.</p> <p><span class=doc-section-title>Parameters:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> <th>Default</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td> <code>image</code> </td> <td> <code><span title="numpy.typing.ArrayLike">ArrayLike</span></code> </td> <td> <div class=doc-md-description> <p>Local corrected image.</p> </div> </td> <td> <em>required</em> </td> </tr> <tr class=doc-section-item> <td> <code>tile</code> </td> <td> <code><span title="typing.Union">Union</span>[int, str]</code> </td> <td> <div class=doc-md-description> <p>Tile index or tile id.</p> </div> </td> <td> <em>required</em> </td> </tr> <tr class=doc-section-item> <td> <code>gain_correction</code> </td> <td> <code>bool</code> </td> <td> <div class=doc-md-description> <p>Gain correction applied (True) or not (False).</p> </div> </td> <td> <code>True</code> </td> </tr> <tr class=doc-section-item> <td> <code>hotpixel_correction</code> </td> <td> <code>bool</code> </td> <td> <div class=doc-md-description> <p>Hotpixel correction applied (True) or not (False).</p> </div> </td> <td> <code>True</code> </td> </tr> <tr class=doc-section-item> <td> <code>shading_correction</code> </td> <td> <code>bool</code> </td> <td> <div class=doc-md-description> <p>Shading correction applied (True) or not (False).</p> </div> </td> <td> <code>False</code> </td> </tr> <tr class=doc-section-item> <td> <code>psf_idx</code> </td> <td> <code>int</code> </td> <td> <div class=doc-md-description> <p>PSF index.</p> </div> </td> <td> <code>0</code> </td> </tr> <tr class=doc-section-item> <td> <code>round</code> </td> <td> <code><span title="typing.Optional">Optional</span>[<span title="typing.Union">Union</span>[int, str]]</code> </td> <td> <div class=doc-md-description> <p>Round index or round id.</p> </div> </td> <td> <code>None</code> </td> </tr> <tr class=doc-section-item> <td> <code>bit</code> </td> <td> <code><span title="typing.Optional">Optional</span>[<span title="typing.Union">Union</span>[int, str]]</code> </td> <td> <div class=doc-md-description> <p>Bit index or bit id.</p> </div> </td> <td> <code>None</code> </td> </tr> <tr class=doc-section-item> <td> <code>return_future</code> </td> <td> <code><span title="typing.Optional">Optional</span>[bool]</code> </td> <td> <div class=doc-md-description> <p>Return future array.</p> </div> </td> <td> <code>False</code> </td> </tr> </tbody> </table> <details class=quote> <summary>Source code in <code>src/merfish3danalysis/qi2labDataStore.py</code></summary> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>2484</span>
<span class=normal>2485</span>
<span class=normal>2486</span>
<span class=normal>2487</span>
<span class=normal>2488</span>
<span class=normal>2489</span>
<span class=normal>2490</span>
<span class=normal>2491</span>
<span class=normal>2492</span>
<span class=normal>2493</span>
<span class=normal>2494</span>
<span class=normal>2495</span>
<span class=normal>2496</span>
<span class=normal>2497</span>
<span class=normal>2498</span>
<span class=normal>2499</span>
<span class=normal>2500</span>
<span class=normal>2501</span>
<span class=normal>2502</span>
<span class=normal>2503</span>
<span class=normal>2504</span>
<span class=normal>2505</span>
<span class=normal>2506</span>
<span class=normal>2507</span>
<span class=normal>2508</span>
<span class=normal>2509</span>
<span class=normal>2510</span>
<span class=normal>2511</span>
<span class=normal>2512</span>
<span class=normal>2513</span>
<span class=normal>2514</span>
<span class=normal>2515</span>
<span class=normal>2516</span>
<span class=normal>2517</span>
<span class=normal>2518</span>
<span class=normal>2519</span>
<span class=normal>2520</span>
<span class=normal>2521</span>
<span class=normal>2522</span>
<span class=normal>2523</span>
<span class=normal>2524</span>
<span class=normal>2525</span>
<span class=normal>2526</span>
<span class=normal>2527</span>
<span class=normal>2528</span>
<span class=normal>2529</span>
<span class=normal>2530</span>
<span class=normal>2531</span>
<span class=normal>2532</span>
<span class=normal>2533</span>
<span class=normal>2534</span>
<span class=normal>2535</span>
<span class=normal>2536</span>
<span class=normal>2537</span>
<span class=normal>2538</span>
<span class=normal>2539</span>
<span class=normal>2540</span>
<span class=normal>2541</span>
<span class=normal>2542</span>
<span class=normal>2543</span>
<span class=normal>2544</span>
<span class=normal>2545</span>
<span class=normal>2546</span>
<span class=normal>2547</span>
<span class=normal>2548</span>
<span class=normal>2549</span>
<span class=normal>2550</span>
<span class=normal>2551</span>
<span class=normal>2552</span>
<span class=normal>2553</span>
<span class=normal>2554</span>
<span class=normal>2555</span>
<span class=normal>2556</span>
<span class=normal>2557</span>
<span class=normal>2558</span>
<span class=normal>2559</span>
<span class=normal>2560</span>
<span class=normal>2561</span>
<span class=normal>2562</span>
<span class=normal>2563</span>
<span class=normal>2564</span>
<span class=normal>2565</span>
<span class=normal>2566</span>
<span class=normal>2567</span>
<span class=normal>2568</span>
<span class=normal>2569</span>
<span class=normal>2570</span>
<span class=normal>2571</span>
<span class=normal>2572</span>
<span class=normal>2573</span>
<span class=normal>2574</span>
<span class=normal>2575</span>
<span class=normal>2576</span>
<span class=normal>2577</span>
<span class=normal>2578</span>
<span class=normal>2579</span>
<span class=normal>2580</span>
<span class=normal>2581</span>
<span class=normal>2582</span>
<span class=normal>2583</span>
<span class=normal>2584</span>
<span class=normal>2585</span>
<span class=normal>2586</span>
<span class=normal>2587</span>
<span class=normal>2588</span>
<span class=normal>2589</span>
<span class=normal>2590</span>
<span class=normal>2591</span>
<span class=normal>2592</span>
<span class=normal>2593</span>
<span class=normal>2594</span>
<span class=normal>2595</span>
<span class=normal>2596</span>
<span class=normal>2597</span>
<span class=normal>2598</span>
<span class=normal>2599</span>
<span class=normal>2600</span>
<span class=normal>2601</span>
<span class=normal>2602</span>
<span class=normal>2603</span>
<span class=normal>2604</span>
<span class=normal>2605</span>
<span class=normal>2606</span>
<span class=normal>2607</span>
<span class=normal>2608</span>
<span class=normal>2609</span>
<span class=normal>2610</span>
<span class=normal>2611</span>
<span class=normal>2612</span>
<span class=normal>2613</span></pre></div></td><td class=code><div><pre><span></span><code> <span class=k>def</span> <span class=nf>save_local_corrected_image</span><span class=p>(</span>
     <span class=bp>self</span><span class=p>,</span>
     <span class=n>image</span><span class=p>:</span> <span class=n>ArrayLike</span><span class=p>,</span>
     <span class=n>tile</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>],</span>
     <span class=n>gain_correction</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>True</span><span class=p>,</span>
     <span class=n>hotpixel_correction</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>True</span><span class=p>,</span>
     <span class=n>shading_correction</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>False</span><span class=p>,</span>
     <span class=n>psf_idx</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span>
     <span class=nb>round</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>]]</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span>
     <span class=n>bit</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>]]</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span>
     <span class=n>return_future</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>bool</span><span class=p>]</span> <span class=o>=</span> <span class=kc>False</span><span class=p>,</span>
 <span class=p>):</span>
<span class=w>     </span><span class=sd>&quot;&quot;&quot;Save gain and offset corrected image.</span>

<span class=sd>     Parameters</span>
<span class=sd>     ----------</span>
<span class=sd>     image : ArrayLike</span>
<span class=sd>         Local corrected image.</span>
<span class=sd>     tile : Union[int, str]</span>
<span class=sd>         Tile index or tile id.</span>
<span class=sd>     gain_correction : bool</span>
<span class=sd>         Gain correction applied (True) or not (False).</span>
<span class=sd>     hotpixel_correction : bool</span>
<span class=sd>         Hotpixel correction applied (True) or not (False).</span>
<span class=sd>     shading_correction : bool</span>
<span class=sd>         Shading correction applied (True) or not (False).</span>
<span class=sd>     psf_idx : int</span>
<span class=sd>         PSF index.</span>
<span class=sd>     round : Optional[Union[int, str]]</span>
<span class=sd>         Round index or round id.</span>
<span class=sd>     bit : Optional[Union[int, str]]</span>
<span class=sd>         Bit index or bit id.</span>
<span class=sd>     return_future : Optional[bool]</span>
<span class=sd>         Return future array.</span>
<span class=sd>&quot;&quot;&quot;</span>

     <span class=k>if</span> <span class=p>(</span><span class=nb>round</span> <span class=ow>is</span> <span class=kc>None</span> <span class=ow>and</span> <span class=n>bit</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>)</span> <span class=ow>or</span> <span class=p>(</span><span class=nb>round</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span> <span class=ow>and</span> <span class=n>bit</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>):</span>
         <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Provide either &#39;round&#39; or &#39;bit&#39;, but not both&quot;</span><span class=p>)</span>
         <span class=k>return</span> <span class=kc>None</span>

     <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
         <span class=k>if</span> <span class=n>tile</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>tile</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>:</span>
             <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set tile index &gt;=0 and &lt;=&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>))</span>
             <span class=k>return</span> <span class=kc>None</span>
         <span class=k>else</span><span class=p>:</span>
             <span class=n>tile_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>[</span><span class=n>tile</span><span class=p>]</span>
     <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
         <span class=k>if</span> <span class=n>tile</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>:</span>
             <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;set valid tiled id&quot;</span><span class=p>)</span>
             <span class=k>return</span> <span class=kc>None</span>
         <span class=k>else</span><span class=p>:</span>
             <span class=n>tile_id</span> <span class=o>=</span> <span class=n>tile</span>
     <span class=k>else</span><span class=p>:</span>
         <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;tile&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
         <span class=k>return</span> <span class=kc>None</span>

     <span class=k>if</span> <span class=n>bit</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
         <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>bit</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
             <span class=k>if</span> <span class=n>bit</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>bit</span> <span class=o>&gt;</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>):</span>
                 <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set bit index &gt;=0 and &lt;=&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>)))</span>
                 <span class=k>return</span> <span class=kc>None</span>
             <span class=k>else</span><span class=p>:</span>
                 <span class=n>local_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>[</span><span class=n>bit</span><span class=p>]</span>
         <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>bit</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
             <span class=k>if</span> <span class=n>bit</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>:</span>
                 <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set valid bit id&quot;</span><span class=p>)</span>
                 <span class=k>return</span> <span class=kc>None</span>
             <span class=k>else</span><span class=p>:</span>
                 <span class=n>local_id</span> <span class=o>=</span> <span class=n>bit</span>
         <span class=k>else</span><span class=p>:</span>
             <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;bit&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
             <span class=k>return</span> <span class=kc>None</span>
         <span class=n>current_local_zarr_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
             <span class=bp>self</span><span class=o>.</span><span class=n>_readouts_root_path</span>
             <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
             <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>local_id</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
             <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;corrected_data&quot;</span><span class=p>)</span>
         <span class=p>)</span>
         <span class=n>current_local_zattrs_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
             <span class=bp>self</span><span class=o>.</span><span class=n>_readouts_root_path</span>
             <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
             <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>local_id</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
             <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;.zattrs&quot;</span><span class=p>)</span>
         <span class=p>)</span>
     <span class=k>else</span><span class=p>:</span>
         <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=nb>round</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
             <span class=k>if</span> <span class=nb>round</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>:</span>
                 <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set round index &gt;=0 and &lt;&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_num_rounds</span><span class=p>))</span>
                 <span class=k>return</span> <span class=kc>None</span>
             <span class=k>else</span><span class=p>:</span>
                 <span class=n>local_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_round_ids</span><span class=p>[</span><span class=nb>round</span><span class=p>]</span>
         <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=nb>round</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
             <span class=k>if</span> <span class=nb>round</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_round_ids</span><span class=p>:</span>
                 <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set valid round id&quot;</span><span class=p>)</span>
                 <span class=k>return</span> <span class=kc>None</span>
             <span class=k>else</span><span class=p>:</span>
                 <span class=n>local_id</span> <span class=o>=</span> <span class=nb>round</span>
         <span class=k>else</span><span class=p>:</span>
             <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;round&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
             <span class=k>return</span> <span class=kc>None</span>
         <span class=n>current_local_zarr_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
             <span class=bp>self</span><span class=o>.</span><span class=n>_polyDT_root_path</span>
             <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
             <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>local_id</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
             <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;corrected_data&quot;</span><span class=p>)</span>
         <span class=p>)</span>
         <span class=n>current_local_zattrs_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
             <span class=bp>self</span><span class=o>.</span><span class=n>_polyDT_root_path</span>
             <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
             <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>local_id</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
             <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;.zattrs&quot;</span><span class=p>)</span>
         <span class=p>)</span>

     <span class=k>try</span><span class=p>:</span>
         <span class=bp>self</span><span class=o>.</span><span class=n>_save_to_zarr_array</span><span class=p>(</span>
             <span class=n>image</span><span class=p>,</span>
             <span class=bp>self</span><span class=o>.</span><span class=n>_get_kvstore_key</span><span class=p>(</span><span class=n>current_local_zarr_path</span><span class=p>),</span>
             <span class=bp>self</span><span class=o>.</span><span class=n>_zarrv2_spec</span><span class=p>,</span>
             <span class=n>return_future</span><span class=p>,</span>
         <span class=p>)</span>
         <span class=n>attributes</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_json</span><span class=p>(</span><span class=n>current_local_zattrs_path</span><span class=p>)</span>
         <span class=n>attributes</span><span class=p>[</span><span class=s2>&quot;gain_correction&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=n>gain_correction</span><span class=p>,)</span>
         <span class=n>attributes</span><span class=p>[</span><span class=s2>&quot;hotpixel_correction&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=n>hotpixel_correction</span><span class=p>,)</span>
         <span class=n>attributes</span><span class=p>[</span><span class=s2>&quot;shading_correction&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=n>shading_correction</span><span class=p>,)</span>
         <span class=n>attributes</span><span class=p>[</span><span class=s2>&quot;psf_idx&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>psf_idx</span>
         <span class=bp>self</span><span class=o>.</span><span class=n>_save_to_json</span><span class=p>(</span><span class=n>attributes</span><span class=p>,</span> <span class=n>current_local_zattrs_path</span><span class=p>)</span>
     <span class=k>except</span> <span class=p>(</span><span class=ne>IOError</span><span class=p>,</span> <span class=ne>OSError</span><span class=p>,</span> <span class=ne>TimeoutError</span><span class=p>)</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
         <span class=nb>print</span><span class=p>(</span><span class=n>e</span><span class=p>)</span>
         <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Error saving corrected image.&quot;</span><span class=p>)</span>
         <span class=k>return</span> <span class=kc>None</span>
</code></pre></div></td></tr></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id=merfish3danalysis.qi2labDataStore.qi2labDataStore.save_local_decoded_spots class="doc doc-heading"> <code class="highlight language-python"><span class=n>save_local_decoded_spots</span><span class=p>(</span><span class=n>features_df</span><span class=p>,</span> <span class=n>tile</span><span class=p>)</span></code> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.save_local_decoded_spots class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-contents "> <p>Save decoded spots and features for one tile.</p> <p><span class=doc-section-title>Parameters:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> <th>Default</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td> <code>features_df</code> </td> <td> <code><span title="pandas.DataFrame">DataFrame</span></code> </td> <td> <div class=doc-md-description> <p>Decoded spots and features for one tile.</p> </div> </td> <td> <em>required</em> </td> </tr> <tr class=doc-section-item> <td> <code>tile</code> </td> <td> <code><span title="typing.Union">Union</span>[int, str]</code> </td> <td> <div class=doc-md-description> <p>Tile index or tile id.</p> </div> </td> <td> <em>required</em> </td> </tr> </tbody> </table> <details class=quote> <summary>Source code in <code>src/merfish3danalysis/qi2labDataStore.py</code></summary> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>3724</span>
<span class=normal>3725</span>
<span class=normal>3726</span>
<span class=normal>3727</span>
<span class=normal>3728</span>
<span class=normal>3729</span>
<span class=normal>3730</span>
<span class=normal>3731</span>
<span class=normal>3732</span>
<span class=normal>3733</span>
<span class=normal>3734</span>
<span class=normal>3735</span>
<span class=normal>3736</span>
<span class=normal>3737</span>
<span class=normal>3738</span>
<span class=normal>3739</span>
<span class=normal>3740</span>
<span class=normal>3741</span>
<span class=normal>3742</span>
<span class=normal>3743</span>
<span class=normal>3744</span>
<span class=normal>3745</span>
<span class=normal>3746</span>
<span class=normal>3747</span>
<span class=normal>3748</span>
<span class=normal>3749</span>
<span class=normal>3750</span>
<span class=normal>3751</span>
<span class=normal>3752</span>
<span class=normal>3753</span>
<span class=normal>3754</span>
<span class=normal>3755</span>
<span class=normal>3756</span>
<span class=normal>3757</span>
<span class=normal>3758</span>
<span class=normal>3759</span></pre></div></td><td class=code><div><pre><span></span><code><span class=k>def</span> <span class=nf>save_local_decoded_spots</span><span class=p>(</span>
    <span class=bp>self</span><span class=p>,</span>
    <span class=n>features_df</span><span class=p>:</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>,</span>
    <span class=n>tile</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>],</span>
<span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Save decoded spots and features for one tile.</span>

<span class=sd>    Parameters</span>
<span class=sd>    ----------</span>
<span class=sd>    features_df : pd.DataFrame</span>
<span class=sd>        Decoded spots and features for one tile.</span>
<span class=sd>    tile : Union[int, str]</span>
<span class=sd>        Tile index or tile id.</span>
<span class=sd>    &quot;&quot;&quot;</span>

    <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
        <span class=k>if</span> <span class=n>tile</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>tile</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set tile index &gt;=0 and &lt;=&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>))</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>tile_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>[</span><span class=n>tile</span><span class=p>]</span>
    <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
        <span class=k>if</span> <span class=n>tile</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;set valid tiled id&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>tile_id</span> <span class=o>=</span> <span class=n>tile</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;tile&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>None</span>

    <span class=n>current_tile_features_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_decoded_root_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span>
        <span class=n>tile_id</span> <span class=o>+</span> <span class=s2>&quot;_decoded_features.parquet&quot;</span>
    <span class=p>)</span>

    <span class=bp>self</span><span class=o>.</span><span class=n>_save_to_parquet</span><span class=p>(</span><span class=n>features_df</span><span class=p>,</span> <span class=n>current_tile_features_path</span><span class=p>)</span>
</code></pre></div></td></tr></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id=merfish3danalysis.qi2labDataStore.qi2labDataStore.save_local_registered_image class="doc doc-heading"> <code class="highlight language-python"><span class=n>save_local_registered_image</span><span class=p>(</span><span class=n>registered_image</span><span class=p>,</span> <span class=n>tile</span><span class=p>,</span> <span class=n>deconvolution</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=nb>round</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>bit</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>return_future</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span></code> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.save_local_registered_image class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-contents "> <p>Save registered, deconvolved image.</p> <p><span class=doc-section-title>Parameters:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> <th>Default</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td> <code>registered_image</code> </td> <td> <code><span title="numpy.typing.ArrayLike">ArrayLike</span></code> </td> <td> <div class=doc-md-description> <p>Registered, deconvolved image.</p> </div> </td> <td> <em>required</em> </td> </tr> <tr class=doc-section-item> <td> <code>tile</code> </td> <td> <code><span title="typing.Union">Union</span>[int, str]</code> </td> <td> <div class=doc-md-description> <p>Tile index or tile id.</p> </div> </td> <td> <em>required</em> </td> </tr> <tr class=doc-section-item> <td> <code>deconvolution</code> </td> <td> <code>bool</code> </td> <td> <div class=doc-md-description> <p>Deconvolution applied (True) or not (False).</p> </div> </td> <td> <code>True</code> </td> </tr> <tr class=doc-section-item> <td> <code>round</code> </td> <td> <code><span title="typing.Optional">Optional</span>[<span title="typing.Union">Union</span>[int, str]]</code> </td> <td> <div class=doc-md-description> <p>Round index or round id.</p> </div> </td> <td> <code>None</code> </td> </tr> <tr class=doc-section-item> <td> <code>bit</code> </td> <td> <code><span title="typing.Optional">Optional</span>[<span title="typing.Union">Union</span>[int, str]]</code> </td> <td> <div class=doc-md-description> <p>Bit index or bit id.</p> </div> </td> <td> <code>None</code> </td> </tr> <tr class=doc-section-item> <td> <code>return_future</code> </td> <td> <code><span title="typing.Optional">Optional</span>[bool]</code> </td> <td> <div class=doc-md-description> <p>Return future array.</p> </div> </td> <td> <code>False</code> </td> </tr> </tbody> </table> <details class=quote> <summary>Source code in <code>src/merfish3danalysis/qi2labDataStore.py</code></summary> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>3064</span>
<span class=normal>3065</span>
<span class=normal>3066</span>
<span class=normal>3067</span>
<span class=normal>3068</span>
<span class=normal>3069</span>
<span class=normal>3070</span>
<span class=normal>3071</span>
<span class=normal>3072</span>
<span class=normal>3073</span>
<span class=normal>3074</span>
<span class=normal>3075</span>
<span class=normal>3076</span>
<span class=normal>3077</span>
<span class=normal>3078</span>
<span class=normal>3079</span>
<span class=normal>3080</span>
<span class=normal>3081</span>
<span class=normal>3082</span>
<span class=normal>3083</span>
<span class=normal>3084</span>
<span class=normal>3085</span>
<span class=normal>3086</span>
<span class=normal>3087</span>
<span class=normal>3088</span>
<span class=normal>3089</span>
<span class=normal>3090</span>
<span class=normal>3091</span>
<span class=normal>3092</span>
<span class=normal>3093</span>
<span class=normal>3094</span>
<span class=normal>3095</span>
<span class=normal>3096</span>
<span class=normal>3097</span>
<span class=normal>3098</span>
<span class=normal>3099</span>
<span class=normal>3100</span>
<span class=normal>3101</span>
<span class=normal>3102</span>
<span class=normal>3103</span>
<span class=normal>3104</span>
<span class=normal>3105</span>
<span class=normal>3106</span>
<span class=normal>3107</span>
<span class=normal>3108</span>
<span class=normal>3109</span>
<span class=normal>3110</span>
<span class=normal>3111</span>
<span class=normal>3112</span>
<span class=normal>3113</span>
<span class=normal>3114</span>
<span class=normal>3115</span>
<span class=normal>3116</span>
<span class=normal>3117</span>
<span class=normal>3118</span>
<span class=normal>3119</span>
<span class=normal>3120</span>
<span class=normal>3121</span>
<span class=normal>3122</span>
<span class=normal>3123</span>
<span class=normal>3124</span>
<span class=normal>3125</span>
<span class=normal>3126</span>
<span class=normal>3127</span>
<span class=normal>3128</span>
<span class=normal>3129</span>
<span class=normal>3130</span>
<span class=normal>3131</span>
<span class=normal>3132</span>
<span class=normal>3133</span>
<span class=normal>3134</span>
<span class=normal>3135</span>
<span class=normal>3136</span>
<span class=normal>3137</span>
<span class=normal>3138</span>
<span class=normal>3139</span>
<span class=normal>3140</span>
<span class=normal>3141</span>
<span class=normal>3142</span>
<span class=normal>3143</span>
<span class=normal>3144</span>
<span class=normal>3145</span>
<span class=normal>3146</span>
<span class=normal>3147</span>
<span class=normal>3148</span>
<span class=normal>3149</span>
<span class=normal>3150</span>
<span class=normal>3151</span>
<span class=normal>3152</span>
<span class=normal>3153</span>
<span class=normal>3154</span>
<span class=normal>3155</span>
<span class=normal>3156</span>
<span class=normal>3157</span>
<span class=normal>3158</span>
<span class=normal>3159</span>
<span class=normal>3160</span>
<span class=normal>3161</span>
<span class=normal>3162</span>
<span class=normal>3163</span>
<span class=normal>3164</span>
<span class=normal>3165</span>
<span class=normal>3166</span>
<span class=normal>3167</span>
<span class=normal>3168</span>
<span class=normal>3169</span>
<span class=normal>3170</span>
<span class=normal>3171</span>
<span class=normal>3172</span>
<span class=normal>3173</span>
<span class=normal>3174</span>
<span class=normal>3175</span>
<span class=normal>3176</span>
<span class=normal>3177</span>
<span class=normal>3178</span>
<span class=normal>3179</span>
<span class=normal>3180</span>
<span class=normal>3181</span>
<span class=normal>3182</span></pre></div></td><td class=code><div><pre><span></span><code><span class=k>def</span> <span class=nf>save_local_registered_image</span><span class=p>(</span>
    <span class=bp>self</span><span class=p>,</span>
    <span class=n>registered_image</span><span class=p>:</span> <span class=n>ArrayLike</span><span class=p>,</span>
    <span class=n>tile</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>],</span>
    <span class=n>deconvolution</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>True</span><span class=p>,</span>
    <span class=nb>round</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>]]</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span>
    <span class=n>bit</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>]]</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span>
    <span class=n>return_future</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>bool</span><span class=p>]</span> <span class=o>=</span> <span class=kc>False</span><span class=p>,</span>
<span class=p>):</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Save registered, deconvolved image.</span>

<span class=sd>    Parameters</span>
<span class=sd>    ----------</span>
<span class=sd>    registered_image : ArrayLike</span>
<span class=sd>        Registered, deconvolved image.</span>
<span class=sd>    tile : Union[int, str]</span>
<span class=sd>        Tile index or tile id.</span>
<span class=sd>    deconvolution : bool</span>
<span class=sd>        Deconvolution applied (True) or not (False).</span>
<span class=sd>    round : Optional[Union[int, str]]</span>
<span class=sd>        Round index or round id.</span>
<span class=sd>    bit : Optional[Union[int, str]]</span>
<span class=sd>        Bit index or bit id.</span>
<span class=sd>    return_future : Optional[bool]</span>
<span class=sd>        Return future array.</span>
<span class=sd>    &quot;&quot;&quot;</span>

    <span class=k>if</span> <span class=p>(</span><span class=nb>round</span> <span class=ow>is</span> <span class=kc>None</span> <span class=ow>and</span> <span class=n>bit</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>)</span> <span class=ow>or</span> <span class=p>(</span><span class=nb>round</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span> <span class=ow>and</span> <span class=n>bit</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>):</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Provide either &#39;round&#39; or &#39;bit&#39;, but not both&quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>None</span>

    <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
        <span class=k>if</span> <span class=n>tile</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>tile</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set tile index &gt;=0 and &lt;=&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>))</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>tile_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>[</span><span class=n>tile</span><span class=p>]</span>
    <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
        <span class=k>if</span> <span class=n>tile</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;set valid tiled id&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>tile_id</span> <span class=o>=</span> <span class=n>tile</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;tile&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>None</span>

    <span class=k>if</span> <span class=n>bit</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>bit</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
            <span class=k>if</span> <span class=n>bit</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>bit</span> <span class=o>&gt;</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>):</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set bit index &gt;=0 and &lt;=&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>)))</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>local_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>[</span><span class=n>bit</span><span class=p>]</span>
        <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>bit</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
            <span class=k>if</span> <span class=n>bit</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set valid bit id&quot;</span><span class=p>)</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>local_id</span> <span class=o>=</span> <span class=n>bit</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;bit&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=n>current_local_zarr_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_readouts_root_path</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>local_id</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;registered_decon_data&quot;</span><span class=p>)</span>
        <span class=p>)</span>
        <span class=n>current_local_zattrs_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_readouts_root_path</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>local_id</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;.zattrs&quot;</span><span class=p>)</span>
        <span class=p>)</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=nb>round</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
            <span class=k>if</span> <span class=nb>round</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set round index &gt;=0 and &lt;&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_num_rounds</span><span class=p>))</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>local_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_round_ids</span><span class=p>[</span><span class=nb>round</span><span class=p>]</span>
        <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=nb>round</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
            <span class=k>if</span> <span class=nb>round</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_round_ids</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set valid round id&quot;</span><span class=p>)</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>local_id</span> <span class=o>=</span> <span class=nb>round</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;round&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=n>current_local_zarr_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_polyDT_root_path</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>local_id</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;registered_decon_data&quot;</span><span class=p>)</span>
        <span class=p>)</span>
        <span class=n>current_local_zattrs_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_polyDT_root_path</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>local_id</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;.zattrs&quot;</span><span class=p>)</span>
        <span class=p>)</span>

    <span class=k>try</span><span class=p>:</span>
        <span class=n>spec</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_zarrv2_spec</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>
        <span class=n>spec</span><span class=p>[</span><span class=s2>&quot;metadata&quot;</span><span class=p>][</span><span class=s2>&quot;dtype&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&quot;&lt;u2&quot;</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_save_to_zarr_array</span><span class=p>(</span>
            <span class=n>registered_image</span><span class=p>,</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_get_kvstore_key</span><span class=p>(</span><span class=n>current_local_zarr_path</span><span class=p>),</span>
            <span class=n>spec</span><span class=p>,</span>
            <span class=n>return_future</span><span class=p>,</span>
        <span class=p>)</span>
        <span class=n>attributes</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_json</span><span class=p>(</span><span class=n>current_local_zattrs_path</span><span class=p>)</span>
        <span class=n>attributes</span><span class=p>[</span><span class=s2>&quot;deconvolution&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>deconvolution</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_save_to_json</span><span class=p>(</span><span class=n>attributes</span><span class=p>,</span> <span class=n>current_local_zattrs_path</span><span class=p>)</span>
    <span class=k>except</span> <span class=p>(</span><span class=ne>IOError</span><span class=p>,</span> <span class=ne>OSError</span><span class=p>,</span> <span class=ne>TimeoutError</span><span class=p>):</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Error saving corrected image.&quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>None</span>
</code></pre></div></td></tr></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id=merfish3danalysis.qi2labDataStore.qi2labDataStore.save_local_rigid_xform_xyz_px class="doc doc-heading"> <code class="highlight language-python"><span class=n>save_local_rigid_xform_xyz_px</span><span class=p>(</span><span class=n>rigid_xform_xyz_px</span><span class=p>,</span> <span class=n>tile</span><span class=p>,</span> <span class=nb>round</span><span class=p>)</span></code> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.save_local_rigid_xform_xyz_px class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-contents "> <p>Save calculated rigid registration transform for one round and tile.</p> <p><span class=doc-section-title>Parameters:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> <th>Default</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td> <code>rigid_xform_xyz_px</code> </td> <td> <code><span title="numpy.typing.ArrayLike">ArrayLike</span></code> </td> <td> <div class=doc-md-description> <p>Local rigid registration transform for one round and tile.</p> </div> </td> <td> <em>required</em> </td> </tr> <tr class=doc-section-item> <td> <code>tile</code> </td> <td> <code><span title="typing.Union">Union</span>[int, str]</code> </td> <td> <div class=doc-md-description> <p>Tile index or tile id.</p> </div> </td> <td> <em>required</em> </td> </tr> <tr class=doc-section-item> <td> <code>round</code> </td> <td> <code><span title="typing.Union">Union</span>[int, str]</code> </td> <td> <div class=doc-md-description> <p>Round index or round id.</p> </div> </td> <td> <em>required</em> </td> </tr> </tbody> </table> <p><span class=doc-section-title>Returns:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td><code>rigid_xform_xyz_px</code></td> <td> <code><span title="typing.Optional">Optional</span>[<span title="numpy.typing.ArrayLike">ArrayLike</span>]</code> </td> <td> <div class=doc-md-description> <p>Local rigid registration transform for one round and tile.</p> </div> </td> </tr> </tbody> </table> <details class=quote> <summary>Source code in <code>src/merfish3danalysis/qi2labDataStore.py</code></summary> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>2683</span>
<span class=normal>2684</span>
<span class=normal>2685</span>
<span class=normal>2686</span>
<span class=normal>2687</span>
<span class=normal>2688</span>
<span class=normal>2689</span>
<span class=normal>2690</span>
<span class=normal>2691</span>
<span class=normal>2692</span>
<span class=normal>2693</span>
<span class=normal>2694</span>
<span class=normal>2695</span>
<span class=normal>2696</span>
<span class=normal>2697</span>
<span class=normal>2698</span>
<span class=normal>2699</span>
<span class=normal>2700</span>
<span class=normal>2701</span>
<span class=normal>2702</span>
<span class=normal>2703</span>
<span class=normal>2704</span>
<span class=normal>2705</span>
<span class=normal>2706</span>
<span class=normal>2707</span>
<span class=normal>2708</span>
<span class=normal>2709</span>
<span class=normal>2710</span>
<span class=normal>2711</span>
<span class=normal>2712</span>
<span class=normal>2713</span>
<span class=normal>2714</span>
<span class=normal>2715</span>
<span class=normal>2716</span>
<span class=normal>2717</span>
<span class=normal>2718</span>
<span class=normal>2719</span>
<span class=normal>2720</span>
<span class=normal>2721</span>
<span class=normal>2722</span>
<span class=normal>2723</span>
<span class=normal>2724</span>
<span class=normal>2725</span>
<span class=normal>2726</span>
<span class=normal>2727</span>
<span class=normal>2728</span>
<span class=normal>2729</span>
<span class=normal>2730</span>
<span class=normal>2731</span>
<span class=normal>2732</span>
<span class=normal>2733</span>
<span class=normal>2734</span>
<span class=normal>2735</span>
<span class=normal>2736</span>
<span class=normal>2737</span>
<span class=normal>2738</span>
<span class=normal>2739</span>
<span class=normal>2740</span>
<span class=normal>2741</span>
<span class=normal>2742</span>
<span class=normal>2743</span>
<span class=normal>2744</span>
<span class=normal>2745</span>
<span class=normal>2746</span>
<span class=normal>2747</span>
<span class=normal>2748</span>
<span class=normal>2749</span></pre></div></td><td class=code><div><pre><span></span><code><span class=k>def</span> <span class=nf>save_local_rigid_xform_xyz_px</span><span class=p>(</span>
    <span class=bp>self</span><span class=p>,</span>
    <span class=n>rigid_xform_xyz_px</span><span class=p>:</span> <span class=n>ArrayLike</span><span class=p>,</span>
    <span class=n>tile</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>],</span>
    <span class=nb>round</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>],</span>
<span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=n>ArrayLike</span><span class=p>]:</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Save calculated rigid registration transform for one round and tile.</span>

<span class=sd>    Parameters</span>
<span class=sd>    ----------</span>
<span class=sd>    rigid_xform_xyz_px : ArrayLike</span>
<span class=sd>        Local rigid registration transform for one round and tile.</span>
<span class=sd>    tile : Union[int, str]</span>
<span class=sd>        Tile index or tile id.</span>
<span class=sd>    round : Union[int, str]</span>
<span class=sd>        Round index or round id.</span>

<span class=sd>    Returns</span>
<span class=sd>    -------</span>
<span class=sd>    rigid_xform_xyz_px : Optional[ArrayLike]</span>
<span class=sd>        Local rigid registration transform for one round and tile.</span>
<span class=sd>    &quot;&quot;&quot;</span>

    <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
        <span class=k>if</span> <span class=n>tile</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>tile</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set tile index &gt;=0 and &lt;=&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>))</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>tile_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>[</span><span class=n>tile</span><span class=p>]</span>
    <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
        <span class=k>if</span> <span class=n>tile</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;set valid tiled id&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>tile_id</span> <span class=o>=</span> <span class=n>tile</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;tile&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>None</span>

    <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=nb>round</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
        <span class=k>if</span> <span class=nb>round</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set round index &gt;=0 and &lt;&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_num_rounds</span><span class=p>))</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>round_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_round_ids</span><span class=p>[</span><span class=nb>round</span><span class=p>]</span>
    <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=nb>round</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
        <span class=k>if</span> <span class=nb>round</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_round_ids</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set valid round id&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>round_id</span> <span class=o>=</span> <span class=nb>round</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;round&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>None</span>
    <span class=k>try</span><span class=p>:</span>
        <span class=n>zattrs_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_polyDT_root_path</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>round_id</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;.zattrs&quot;</span><span class=p>)</span>
        <span class=p>)</span>
        <span class=n>attributes</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_json</span><span class=p>(</span><span class=n>zattrs_path</span><span class=p>)</span>
        <span class=n>attributes</span><span class=p>[</span><span class=s2>&quot;rigid_xform_xyz_px&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>rigid_xform_xyz_px</span><span class=o>.</span><span class=n>tolist</span><span class=p>()</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_save_to_json</span><span class=p>(</span><span class=n>attributes</span><span class=p>,</span> <span class=n>zattrs_path</span><span class=p>)</span>
    <span class=k>except</span> <span class=p>(</span><span class=ne>FileNotFoundError</span><span class=p>,</span> <span class=n>json</span><span class=o>.</span><span class=n>JSONDecodeError</span><span class=p>):</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Error writing rigid transform attribute.&quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>None</span>
</code></pre></div></td></tr></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id=merfish3danalysis.qi2labDataStore.qi2labDataStore.save_local_round_linker class="doc doc-heading"> <code class="highlight language-python"><span class=n>save_local_round_linker</span><span class=p>(</span><span class=n>round_linker</span><span class=p>,</span> <span class=n>tile</span><span class=p>,</span> <span class=n>bit</span><span class=p>)</span></code> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.save_local_round_linker class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-contents "> <p>Save fidicual round linker attribute to readout bit for one tile.</p> <p><span class=doc-section-title>Parameters:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> <th>Default</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td> <code>round_linker</code> </td> <td> <code>int</code> </td> <td> <div class=doc-md-description> <p>Fidicual round linked to readout bit for one tile.</p> </div> </td> <td> <em>required</em> </td> </tr> <tr class=doc-section-item> <td> <code>tile</code> </td> <td> <code><span title="typing.Union">Union</span>[int, str]</code> </td> <td> <div class=doc-md-description> <p>Tile index or tile id.</p> </div> </td> <td> <em>required</em> </td> </tr> <tr class=doc-section-item> <td> <code>bit</code> </td> <td> <code><span title="typing.Union">Union</span>[int, str]</code> </td> <td> <div class=doc-md-description> <p>Bit index or bit id.</p> </div> </td> <td> <em>required</em> </td> </tr> </tbody> </table> <details class=quote> <summary>Source code in <code>src/merfish3danalysis/qi2labDataStore.py</code></summary> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1978</span>
<span class=normal>1979</span>
<span class=normal>1980</span>
<span class=normal>1981</span>
<span class=normal>1982</span>
<span class=normal>1983</span>
<span class=normal>1984</span>
<span class=normal>1985</span>
<span class=normal>1986</span>
<span class=normal>1987</span>
<span class=normal>1988</span>
<span class=normal>1989</span>
<span class=normal>1990</span>
<span class=normal>1991</span>
<span class=normal>1992</span>
<span class=normal>1993</span>
<span class=normal>1994</span>
<span class=normal>1995</span>
<span class=normal>1996</span>
<span class=normal>1997</span>
<span class=normal>1998</span>
<span class=normal>1999</span>
<span class=normal>2000</span>
<span class=normal>2001</span>
<span class=normal>2002</span>
<span class=normal>2003</span>
<span class=normal>2004</span>
<span class=normal>2005</span>
<span class=normal>2006</span>
<span class=normal>2007</span>
<span class=normal>2008</span>
<span class=normal>2009</span>
<span class=normal>2010</span>
<span class=normal>2011</span>
<span class=normal>2012</span>
<span class=normal>2013</span>
<span class=normal>2014</span>
<span class=normal>2015</span>
<span class=normal>2016</span>
<span class=normal>2017</span>
<span class=normal>2018</span>
<span class=normal>2019</span>
<span class=normal>2020</span>
<span class=normal>2021</span>
<span class=normal>2022</span>
<span class=normal>2023</span>
<span class=normal>2024</span>
<span class=normal>2025</span>
<span class=normal>2026</span>
<span class=normal>2027</span>
<span class=normal>2028</span>
<span class=normal>2029</span>
<span class=normal>2030</span>
<span class=normal>2031</span>
<span class=normal>2032</span>
<span class=normal>2033</span>
<span class=normal>2034</span>
<span class=normal>2035</span>
<span class=normal>2036</span>
<span class=normal>2037</span>
<span class=normal>2038</span>
<span class=normal>2039</span>
<span class=normal>2040</span>
<span class=normal>2041</span></pre></div></td><td class=code><div><pre><span></span><code><span class=k>def</span> <span class=nf>save_local_round_linker</span><span class=p>(</span>
    <span class=bp>self</span><span class=p>,</span>
    <span class=n>round_linker</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span>
    <span class=n>tile</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>],</span>
    <span class=n>bit</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>],</span>
<span class=p>):</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Save fidicual round linker attribute to readout bit for one tile.</span>

<span class=sd>    Parameters</span>
<span class=sd>    ----------</span>
<span class=sd>    round_linker : int</span>
<span class=sd>        Fidicual round linked to readout bit for one tile.</span>
<span class=sd>    tile : Union[int, str]</span>
<span class=sd>        Tile index or tile id.</span>
<span class=sd>    bit : Union[int, str]</span>
<span class=sd>        Bit index or bit id.</span>
<span class=sd>    &quot;&quot;&quot;</span>

    <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
        <span class=k>if</span> <span class=n>tile</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>tile</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set tile index &gt;=0 and &lt;=&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>))</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>tile_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>[</span><span class=n>tile</span><span class=p>]</span>
    <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
        <span class=k>if</span> <span class=n>tile</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;set valid tiled id.&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>tile_id</span> <span class=o>=</span> <span class=n>tile</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;tile&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>None</span>

    <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>bit</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
        <span class=k>if</span> <span class=n>bit</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>bit</span> <span class=o>&gt;</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>):</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set bit index &gt;=0 and &lt;=&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>)))</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>bit_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>[</span><span class=n>bit</span><span class=p>]</span>
    <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>bit</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
        <span class=k>if</span> <span class=n>bit</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set valid bit id.&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>bit_id</span> <span class=o>=</span> <span class=n>bit</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;bit&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>None</span>

    <span class=k>try</span><span class=p>:</span>
        <span class=n>zattrs_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_readouts_root_path</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>bit_id</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;.zattrs&quot;</span><span class=p>)</span>
        <span class=p>)</span>
        <span class=n>attributes</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_json</span><span class=p>(</span><span class=n>zattrs_path</span><span class=p>)</span>
        <span class=n>attributes</span><span class=p>[</span><span class=s2>&quot;round&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>round_linker</span><span class=p>)</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_save_to_json</span><span class=p>(</span><span class=n>attributes</span><span class=p>,</span> <span class=n>zattrs_path</span><span class=p>)</span>
    <span class=k>except</span> <span class=p>(</span><span class=ne>FileNotFoundError</span><span class=p>,</span> <span class=n>json</span><span class=o>.</span><span class=n>JSONDecodeError</span><span class=p>):</span>
        <span class=nb>print</span><span class=p>(</span><span class=n>tile_id</span><span class=p>,</span> <span class=n>bit_id</span><span class=p>)</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Error writing round linker attribute.&quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>None</span>
</code></pre></div></td></tr></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id=merfish3danalysis.qi2labDataStore.qi2labDataStore.save_local_stage_position_zyx_um class="doc doc-heading"> <code class="highlight language-python"><span class=n>save_local_stage_position_zyx_um</span><span class=p>(</span><span class=n>stage_zyx_um</span><span class=p>,</span> <span class=n>tile</span><span class=p>,</span> <span class=nb>round</span><span class=p>)</span></code> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.save_local_stage_position_zyx_um class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-contents "> <p>Save tile stage position for one tile.</p> <p><span class=doc-section-title>Parameters:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> <th>Default</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td> <code>stage_zyx_um</code> </td> <td> <code><span title="numpy.typing.ArrayLike">ArrayLike</span></code> </td> <td> <div class=doc-md-description> <p>Tile stage position for one tile.</p> </div> </td> <td> <em>required</em> </td> </tr> <tr class=doc-section-item> <td> <code>tile</code> </td> <td> <code><span title="typing.Union">Union</span>[int, str]</code> </td> <td> <div class=doc-md-description> <p>Tile index or tile id.</p> </div> </td> <td> <em>required</em> </td> </tr> <tr class=doc-section-item> <td> <code>round</code> </td> <td> <code><span title="typing.Union">Union</span>[int, str]</code> </td> <td> <div class=doc-md-description> <p>Round index or round id.</p> </div> </td> <td> <em>required</em> </td> </tr> </tbody> </table> <p><span class=doc-section-title>Returns:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td><code>stage_zyx_um</code></td> <td> <code><span title="typing.Optional">Optional</span>[<span title="numpy.typing.ArrayLike">ArrayLike</span>]</code> </td> <td> <div class=doc-md-description> <p>Tile stage position for one tile.</p> </div> </td> </tr> </tbody> </table> <details class=quote> <summary>Source code in <code>src/merfish3danalysis/qi2labDataStore.py</code></summary> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>2109</span>
<span class=normal>2110</span>
<span class=normal>2111</span>
<span class=normal>2112</span>
<span class=normal>2113</span>
<span class=normal>2114</span>
<span class=normal>2115</span>
<span class=normal>2116</span>
<span class=normal>2117</span>
<span class=normal>2118</span>
<span class=normal>2119</span>
<span class=normal>2120</span>
<span class=normal>2121</span>
<span class=normal>2122</span>
<span class=normal>2123</span>
<span class=normal>2124</span>
<span class=normal>2125</span>
<span class=normal>2126</span>
<span class=normal>2127</span>
<span class=normal>2128</span>
<span class=normal>2129</span>
<span class=normal>2130</span>
<span class=normal>2131</span>
<span class=normal>2132</span>
<span class=normal>2133</span>
<span class=normal>2134</span>
<span class=normal>2135</span>
<span class=normal>2136</span>
<span class=normal>2137</span>
<span class=normal>2138</span>
<span class=normal>2139</span>
<span class=normal>2140</span>
<span class=normal>2141</span>
<span class=normal>2142</span>
<span class=normal>2143</span>
<span class=normal>2144</span>
<span class=normal>2145</span>
<span class=normal>2146</span>
<span class=normal>2147</span>
<span class=normal>2148</span>
<span class=normal>2149</span>
<span class=normal>2150</span>
<span class=normal>2151</span>
<span class=normal>2152</span>
<span class=normal>2153</span>
<span class=normal>2154</span>
<span class=normal>2155</span>
<span class=normal>2156</span>
<span class=normal>2157</span>
<span class=normal>2158</span>
<span class=normal>2159</span>
<span class=normal>2160</span>
<span class=normal>2161</span>
<span class=normal>2162</span>
<span class=normal>2163</span>
<span class=normal>2164</span>
<span class=normal>2165</span>
<span class=normal>2166</span>
<span class=normal>2167</span>
<span class=normal>2168</span>
<span class=normal>2169</span>
<span class=normal>2170</span>
<span class=normal>2171</span>
<span class=normal>2172</span>
<span class=normal>2173</span>
<span class=normal>2174</span>
<span class=normal>2175</span>
<span class=normal>2176</span>
<span class=normal>2177</span></pre></div></td><td class=code><div><pre><span></span><code><span class=k>def</span> <span class=nf>save_local_stage_position_zyx_um</span><span class=p>(</span>
    <span class=bp>self</span><span class=p>,</span>
    <span class=n>stage_zyx_um</span><span class=p>:</span> <span class=n>ArrayLike</span><span class=p>,</span>
    <span class=n>tile</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>],</span>
    <span class=nb>round</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>],</span>
<span class=p>):</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Save tile stage position for one tile.</span>

<span class=sd>    Parameters</span>
<span class=sd>    ----------</span>
<span class=sd>    stage_zyx_um : ArrayLike</span>
<span class=sd>        Tile stage position for one tile.</span>
<span class=sd>    tile : Union[int, str]</span>
<span class=sd>        Tile index or tile id.</span>
<span class=sd>    round : Union[int, str]</span>
<span class=sd>        Round index or round id.</span>

<span class=sd>    Returns</span>
<span class=sd>    -------</span>
<span class=sd>    stage_zyx_um : Optional[ArrayLike]</span>
<span class=sd>        Tile stage position for one tile.</span>
<span class=sd>    &quot;&quot;&quot;</span>

    <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
        <span class=k>if</span> <span class=n>tile</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>tile</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set tile index &gt;=0 and &lt;&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>))</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>tile_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>[</span><span class=n>tile</span><span class=p>]</span>
    <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
        <span class=k>if</span> <span class=n>tile</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;set valid tiled id.&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>tile_id</span> <span class=o>=</span> <span class=n>tile</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;tile&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>None</span>

    <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=nb>round</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
        <span class=k>if</span> <span class=nb>round</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set round index &gt;=0 and &lt;&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_num_rounds</span><span class=p>))</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>round_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_round_ids</span><span class=p>[</span><span class=nb>round</span><span class=p>]</span>
    <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=nb>round</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
        <span class=k>if</span> <span class=nb>round</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_round_ids</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set valid round id.&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>round_id</span> <span class=o>=</span> <span class=nb>round</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;round&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>None</span>

    <span class=k>try</span><span class=p>:</span>
        <span class=n>zattrs_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_polyDT_root_path</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>round_id</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;.zattrs&quot;</span><span class=p>)</span>
        <span class=p>)</span>
        <span class=n>attributes</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_json</span><span class=p>(</span><span class=n>zattrs_path</span><span class=p>)</span>
        <span class=n>attributes</span><span class=p>[</span><span class=s2>&quot;stage_zyx_um&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>stage_zyx_um</span><span class=o>.</span><span class=n>tolist</span><span class=p>()</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_save_to_json</span><span class=p>(</span><span class=n>attributes</span><span class=p>,</span> <span class=n>zattrs_path</span><span class=p>)</span>
    <span class=k>except</span> <span class=p>(</span><span class=ne>FileNotFoundError</span><span class=p>,</span> <span class=n>json</span><span class=o>.</span><span class=n>JSONDecodeError</span><span class=p>):</span>
        <span class=nb>print</span><span class=p>(</span><span class=n>tile_id</span><span class=p>,</span> <span class=n>round_id</span><span class=p>)</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Error writing stage position attribute.&quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>None</span>
</code></pre></div></td></tr></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id=merfish3danalysis.qi2labDataStore.qi2labDataStore.save_local_ufish_image class="doc doc-heading"> <code class="highlight language-python"><span class=n>save_local_ufish_image</span><span class=p>(</span><span class=n>ufish_image</span><span class=p>,</span> <span class=n>tile</span><span class=p>,</span> <span class=n>bit</span><span class=p>,</span> <span class=n>return_future</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span></code> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.save_local_ufish_image class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-contents "> <p>Save U-FISH prediction image.</p> <p><span class=doc-section-title>Parameters:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> <th>Default</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td> <code>ufish_image</code> </td> <td> <code><span title="numpy.typing.ArrayLike">ArrayLike</span></code> </td> <td> <div class=doc-md-description> <p>U-FISH prediction image.</p> </div> </td> <td> <em>required</em> </td> </tr> <tr class=doc-section-item> <td> <code>tile</code> </td> <td> <code><span title="typing.Union">Union</span>[int, str]</code> </td> <td> <div class=doc-md-description> <p>Tile index or tile id.</p> </div> </td> <td> <em>required</em> </td> </tr> <tr class=doc-section-item> <td> <code>bit</code> </td> <td> <code><span title="typing.Union">Union</span>[int, str]</code> </td> <td> <div class=doc-md-description> <p>Bit index or bit id.</p> </div> </td> <td> <em>required</em> </td> </tr> <tr class=doc-section-item> <td> <code>return_future</code> </td> <td> <code><span title="typing.Optional">Optional</span>[bool]</code> </td> <td> <div class=doc-md-description> <p>Return future array.</p> </div> </td> <td> <code>False</code> </td> </tr> </tbody> </table> <details class=quote> <summary>Source code in <code>src/merfish3danalysis/qi2labDataStore.py</code></summary> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>3263</span>
<span class=normal>3264</span>
<span class=normal>3265</span>
<span class=normal>3266</span>
<span class=normal>3267</span>
<span class=normal>3268</span>
<span class=normal>3269</span>
<span class=normal>3270</span>
<span class=normal>3271</span>
<span class=normal>3272</span>
<span class=normal>3273</span>
<span class=normal>3274</span>
<span class=normal>3275</span>
<span class=normal>3276</span>
<span class=normal>3277</span>
<span class=normal>3278</span>
<span class=normal>3279</span>
<span class=normal>3280</span>
<span class=normal>3281</span>
<span class=normal>3282</span>
<span class=normal>3283</span>
<span class=normal>3284</span>
<span class=normal>3285</span>
<span class=normal>3286</span>
<span class=normal>3287</span>
<span class=normal>3288</span>
<span class=normal>3289</span>
<span class=normal>3290</span>
<span class=normal>3291</span>
<span class=normal>3292</span>
<span class=normal>3293</span>
<span class=normal>3294</span>
<span class=normal>3295</span>
<span class=normal>3296</span>
<span class=normal>3297</span>
<span class=normal>3298</span>
<span class=normal>3299</span>
<span class=normal>3300</span>
<span class=normal>3301</span>
<span class=normal>3302</span>
<span class=normal>3303</span>
<span class=normal>3304</span>
<span class=normal>3305</span>
<span class=normal>3306</span>
<span class=normal>3307</span>
<span class=normal>3308</span>
<span class=normal>3309</span>
<span class=normal>3310</span>
<span class=normal>3311</span>
<span class=normal>3312</span>
<span class=normal>3313</span>
<span class=normal>3314</span>
<span class=normal>3315</span>
<span class=normal>3316</span>
<span class=normal>3317</span>
<span class=normal>3318</span>
<span class=normal>3319</span>
<span class=normal>3320</span>
<span class=normal>3321</span>
<span class=normal>3322</span>
<span class=normal>3323</span>
<span class=normal>3324</span>
<span class=normal>3325</span>
<span class=normal>3326</span>
<span class=normal>3327</span>
<span class=normal>3328</span>
<span class=normal>3329</span>
<span class=normal>3330</span>
<span class=normal>3331</span>
<span class=normal>3332</span>
<span class=normal>3333</span></pre></div></td><td class=code><div><pre><span></span><code><span class=k>def</span> <span class=nf>save_local_ufish_image</span><span class=p>(</span>
    <span class=bp>self</span><span class=p>,</span>
    <span class=n>ufish_image</span><span class=p>:</span> <span class=n>ArrayLike</span><span class=p>,</span>
    <span class=n>tile</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>],</span>
    <span class=n>bit</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>],</span>
    <span class=n>return_future</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>bool</span><span class=p>]</span> <span class=o>=</span> <span class=kc>False</span><span class=p>,</span>
<span class=p>):</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Save U-FISH prediction image.</span>

<span class=sd>    Parameters</span>
<span class=sd>    ----------</span>
<span class=sd>    ufish_image : ArrayLike</span>
<span class=sd>        U-FISH prediction image.</span>
<span class=sd>    tile : Union[int, str]</span>
<span class=sd>        Tile index or tile id.</span>
<span class=sd>    bit : Union[int, str]</span>
<span class=sd>        Bit index or bit id.</span>
<span class=sd>    return_future : Optional[bool]</span>
<span class=sd>        Return future array.</span>
<span class=sd>    &quot;&quot;&quot;</span>

    <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
        <span class=k>if</span> <span class=n>tile</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>tile</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set tile index &gt;=0 and &lt;=&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>))</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>tile_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>[</span><span class=n>tile</span><span class=p>]</span>
    <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
        <span class=k>if</span> <span class=n>tile</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;set valid tiled id&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>tile_id</span> <span class=o>=</span> <span class=n>tile</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;tile&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>None</span>

    <span class=k>if</span> <span class=n>bit</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>bit</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
            <span class=k>if</span> <span class=n>bit</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>bit</span> <span class=o>&gt;</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>):</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set bit index &gt;=0 and &lt;=&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>)))</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>local_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>[</span><span class=n>bit</span><span class=p>]</span>
        <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>bit</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
            <span class=k>if</span> <span class=n>bit</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set valid bit id&quot;</span><span class=p>)</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>local_id</span> <span class=o>=</span> <span class=n>bit</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;bit&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=n>current_local_zarr_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_readouts_root_path</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>local_id</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;registered_ufish_data&quot;</span><span class=p>)</span>
        <span class=p>)</span>

    <span class=k>try</span><span class=p>:</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_save_to_zarr_array</span><span class=p>(</span>
            <span class=n>ufish_image</span><span class=p>,</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_get_kvstore_key</span><span class=p>(</span><span class=n>current_local_zarr_path</span><span class=p>),</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_zarrv2_spec</span><span class=o>.</span><span class=n>copy</span><span class=p>(),</span>
            <span class=n>return_future</span><span class=p>,</span>
        <span class=p>)</span>
    <span class=k>except</span> <span class=p>(</span><span class=ne>IOError</span><span class=p>,</span> <span class=ne>OSError</span><span class=p>,</span> <span class=n>ZarrError</span><span class=p>)</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=n>e</span><span class=p>)</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Error saving U-Fish image.&quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>None</span>
</code></pre></div></td></tr></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id=merfish3danalysis.qi2labDataStore.qi2labDataStore.save_local_ufish_spots class="doc doc-heading"> <code class="highlight language-python"><span class=n>save_local_ufish_spots</span><span class=p>(</span><span class=n>spot_df</span><span class=p>,</span> <span class=n>tile</span><span class=p>,</span> <span class=n>bit</span><span class=p>)</span></code> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.save_local_ufish_spots class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-contents "> <p>Save U-FISH localizations and features.</p> <p><span class=doc-section-title>Parameters:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> <th>Default</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td> <code>spot_df</code> </td> <td> <code><span title="pandas.DataFrame">DataFrame</span></code> </td> <td> <div class=doc-md-description> <p>U-FISH localizations and features.</p> </div> </td> <td> <em>required</em> </td> </tr> <tr class=doc-section-item> <td> <code>tile</code> </td> <td> <code><span title="typing.Union">Union</span>[int, str]</code> </td> <td> <div class=doc-md-description> <p>Tile index or tile id.</p> </div> </td> <td> <em>required</em> </td> </tr> <tr class=doc-section-item> <td> <code>bit</code> </td> <td> <code><span title="typing.Union">Union</span>[int, str]</code> </td> <td> <div class=doc-md-description> <p>Bit index or bit id.</p> </div> </td> <td> <em>required</em> </td> </tr> </tbody> </table> <details class=quote> <summary>Source code in <code>src/merfish3danalysis/qi2labDataStore.py</code></summary> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>3402</span>
<span class=normal>3403</span>
<span class=normal>3404</span>
<span class=normal>3405</span>
<span class=normal>3406</span>
<span class=normal>3407</span>
<span class=normal>3408</span>
<span class=normal>3409</span>
<span class=normal>3410</span>
<span class=normal>3411</span>
<span class=normal>3412</span>
<span class=normal>3413</span>
<span class=normal>3414</span>
<span class=normal>3415</span>
<span class=normal>3416</span>
<span class=normal>3417</span>
<span class=normal>3418</span>
<span class=normal>3419</span>
<span class=normal>3420</span>
<span class=normal>3421</span>
<span class=normal>3422</span>
<span class=normal>3423</span>
<span class=normal>3424</span>
<span class=normal>3425</span>
<span class=normal>3426</span>
<span class=normal>3427</span>
<span class=normal>3428</span>
<span class=normal>3429</span>
<span class=normal>3430</span>
<span class=normal>3431</span>
<span class=normal>3432</span>
<span class=normal>3433</span>
<span class=normal>3434</span>
<span class=normal>3435</span>
<span class=normal>3436</span>
<span class=normal>3437</span>
<span class=normal>3438</span>
<span class=normal>3439</span>
<span class=normal>3440</span>
<span class=normal>3441</span>
<span class=normal>3442</span>
<span class=normal>3443</span>
<span class=normal>3444</span>
<span class=normal>3445</span>
<span class=normal>3446</span>
<span class=normal>3447</span>
<span class=normal>3448</span>
<span class=normal>3449</span>
<span class=normal>3450</span>
<span class=normal>3451</span>
<span class=normal>3452</span>
<span class=normal>3453</span>
<span class=normal>3454</span>
<span class=normal>3455</span>
<span class=normal>3456</span>
<span class=normal>3457</span>
<span class=normal>3458</span>
<span class=normal>3459</span>
<span class=normal>3460</span>
<span class=normal>3461</span>
<span class=normal>3462</span>
<span class=normal>3463</span>
<span class=normal>3464</span>
<span class=normal>3465</span>
<span class=normal>3466</span></pre></div></td><td class=code><div><pre><span></span><code><span class=k>def</span> <span class=nf>save_local_ufish_spots</span><span class=p>(</span>
    <span class=bp>self</span><span class=p>,</span>
    <span class=n>spot_df</span><span class=p>:</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>,</span>
    <span class=n>tile</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>],</span>
    <span class=n>bit</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>],</span>
<span class=p>):</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Save U-FISH localizations and features.</span>

<span class=sd>    Parameters</span>
<span class=sd>    ----------</span>
<span class=sd>    spot_df : pd.DataFrame</span>
<span class=sd>        U-FISH localizations and features.</span>
<span class=sd>    tile : Union[int, str]</span>
<span class=sd>        Tile index or tile id.</span>
<span class=sd>    bit : Union[int, str]</span>
<span class=sd>        Bit index or bit id.</span>
<span class=sd>    &quot;&quot;&quot;</span>

    <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
        <span class=k>if</span> <span class=n>tile</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>tile</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set tile index &gt;=0 and &lt;=&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>))</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>tile_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>[</span><span class=n>tile</span><span class=p>]</span>
    <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
        <span class=k>if</span> <span class=n>tile</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;set valid tiled id&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>tile_id</span> <span class=o>=</span> <span class=n>tile</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;tile&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>None</span>

    <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>bit</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
        <span class=k>if</span> <span class=n>bit</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>bit</span> <span class=o>&gt;</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>):</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set bit index &gt;=0 and &lt;=&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>)))</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>bit_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>[</span><span class=n>bit</span><span class=p>]</span>
    <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>bit</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
        <span class=k>if</span> <span class=n>bit</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set valid bit id&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>bit_id</span> <span class=o>=</span> <span class=n>bit</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;bit&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>None</span>

    <span class=k>if</span> <span class=ow>not</span> <span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_ufish_localizations_root_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>))</span><span class=o>.</span><span class=n>exists</span><span class=p>():</span>
        <span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_ufish_localizations_root_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>))</span><span class=o>.</span><span class=n>mkdir</span><span class=p>()</span>

    <span class=n>current_ufish_localizations_path</span> <span class=o>=</span> <span class=p>(</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_ufish_localizations_root_path</span>
        <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
        <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>bit_id</span> <span class=o>+</span> <span class=s2>&quot;.parquet&quot;</span><span class=p>)</span>
    <span class=p>)</span>

    <span class=k>try</span><span class=p>:</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_save_to_parquet</span><span class=p>(</span><span class=n>spot_df</span><span class=p>,</span> <span class=n>current_ufish_localizations_path</span><span class=p>)</span>
    <span class=k>except</span> <span class=p>(</span><span class=ne>IOError</span><span class=p>,</span> <span class=ne>OSError</span><span class=p>)</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=n>e</span><span class=p>)</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Error saving U-FISH localizations.&quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>None</span>
</code></pre></div></td></tr></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id=merfish3danalysis.qi2labDataStore.qi2labDataStore.save_local_wavelengths_um class="doc doc-heading"> <code class="highlight language-python"><span class=n>save_local_wavelengths_um</span><span class=p>(</span><span class=n>wavelengths_um</span><span class=p>,</span> <span class=n>tile</span><span class=p>,</span> <span class=nb>round</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>bit</span><span class=o>=</span><span class=kc>None</span><span class=p>)</span></code> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.save_local_wavelengths_um class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-contents "> <p>Save wavelengths for fidicual OR readout bit for one tile.</p> <p><span class=doc-section-title>Parameters:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> <th>Default</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td> <code>wavelengths_um</code> </td> <td> <code>tuple[float, float]</code> </td> <td> <div class=doc-md-description> <p>Wavelengths for fidicual OR readout bit for one tile.</p> </div> </td> <td> <em>required</em> </td> </tr> <tr class=doc-section-item> <td> <code>tile</code> </td> <td> <code><span title="typing.Union">Union</span>[int, str]</code> </td> <td> <div class=doc-md-description> <p>Tile index or tile id.</p> </div> </td> <td> <em>required</em> </td> </tr> <tr class=doc-section-item> <td> <code>round</code> </td> <td> <code><span title="typing.Optional">Optional</span>[<span title="typing.Union">Union</span>[int, str]]</code> </td> <td> <div class=doc-md-description> <p>Round index or round id.</p> </div> </td> <td> <code>None</code> </td> </tr> <tr class=doc-section-item> <td> <code>bit</code> </td> <td> <code><span title="typing.Optional">Optional</span>[<span title="typing.Union">Union</span>[int, str]]</code> </td> <td> <div class=doc-md-description> <p>Bit index or bit id.</p> </div> </td> <td> <code>None</code> </td> </tr> </tbody> </table> <p><span class=doc-section-title>Returns:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td><code>wavelengths_um</code></td> <td> <code><span title="typing.Optional">Optional</span>[tuple[float, float]]</code> </td> <td> <div class=doc-md-description> <p>Wavelengths for fidicual OR readout bit for one tile.</p> </div> </td> </tr> </tbody> </table> <details class=quote> <summary>Source code in <code>src/merfish3danalysis/qi2labDataStore.py</code></summary> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>2276</span>
<span class=normal>2277</span>
<span class=normal>2278</span>
<span class=normal>2279</span>
<span class=normal>2280</span>
<span class=normal>2281</span>
<span class=normal>2282</span>
<span class=normal>2283</span>
<span class=normal>2284</span>
<span class=normal>2285</span>
<span class=normal>2286</span>
<span class=normal>2287</span>
<span class=normal>2288</span>
<span class=normal>2289</span>
<span class=normal>2290</span>
<span class=normal>2291</span>
<span class=normal>2292</span>
<span class=normal>2293</span>
<span class=normal>2294</span>
<span class=normal>2295</span>
<span class=normal>2296</span>
<span class=normal>2297</span>
<span class=normal>2298</span>
<span class=normal>2299</span>
<span class=normal>2300</span>
<span class=normal>2301</span>
<span class=normal>2302</span>
<span class=normal>2303</span>
<span class=normal>2304</span>
<span class=normal>2305</span>
<span class=normal>2306</span>
<span class=normal>2307</span>
<span class=normal>2308</span>
<span class=normal>2309</span>
<span class=normal>2310</span>
<span class=normal>2311</span>
<span class=normal>2312</span>
<span class=normal>2313</span>
<span class=normal>2314</span>
<span class=normal>2315</span>
<span class=normal>2316</span>
<span class=normal>2317</span>
<span class=normal>2318</span>
<span class=normal>2319</span>
<span class=normal>2320</span>
<span class=normal>2321</span>
<span class=normal>2322</span>
<span class=normal>2323</span>
<span class=normal>2324</span>
<span class=normal>2325</span>
<span class=normal>2326</span>
<span class=normal>2327</span>
<span class=normal>2328</span>
<span class=normal>2329</span>
<span class=normal>2330</span>
<span class=normal>2331</span>
<span class=normal>2332</span>
<span class=normal>2333</span>
<span class=normal>2334</span>
<span class=normal>2335</span>
<span class=normal>2336</span>
<span class=normal>2337</span>
<span class=normal>2338</span>
<span class=normal>2339</span>
<span class=normal>2340</span>
<span class=normal>2341</span>
<span class=normal>2342</span>
<span class=normal>2343</span>
<span class=normal>2344</span>
<span class=normal>2345</span>
<span class=normal>2346</span>
<span class=normal>2347</span>
<span class=normal>2348</span>
<span class=normal>2349</span>
<span class=normal>2350</span>
<span class=normal>2351</span>
<span class=normal>2352</span>
<span class=normal>2353</span>
<span class=normal>2354</span>
<span class=normal>2355</span>
<span class=normal>2356</span>
<span class=normal>2357</span>
<span class=normal>2358</span>
<span class=normal>2359</span>
<span class=normal>2360</span>
<span class=normal>2361</span>
<span class=normal>2362</span>
<span class=normal>2363</span>
<span class=normal>2364</span>
<span class=normal>2365</span>
<span class=normal>2366</span>
<span class=normal>2367</span>
<span class=normal>2368</span>
<span class=normal>2369</span>
<span class=normal>2370</span>
<span class=normal>2371</span>
<span class=normal>2372</span>
<span class=normal>2373</span>
<span class=normal>2374</span></pre></div></td><td class=code><div><pre><span></span><code><span class=k>def</span> <span class=nf>save_local_wavelengths_um</span><span class=p>(</span>
    <span class=bp>self</span><span class=p>,</span>
    <span class=n>wavelengths_um</span><span class=p>:</span> <span class=nb>tuple</span><span class=p>[</span><span class=nb>float</span><span class=p>,</span> <span class=nb>float</span><span class=p>],</span>
    <span class=n>tile</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>],</span>
    <span class=nb>round</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>]]</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span>
    <span class=n>bit</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>str</span><span class=p>]]</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span>
<span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>tuple</span><span class=p>[</span><span class=nb>float</span><span class=p>,</span> <span class=nb>float</span><span class=p>]]:</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Save wavelengths for fidicual OR readout bit for one tile.</span>

<span class=sd>    Parameters</span>
<span class=sd>    ----------</span>
<span class=sd>    wavelengths_um : tuple[float, float]</span>
<span class=sd>        Wavelengths for fidicual OR readout bit for one tile.</span>
<span class=sd>    tile : Union[int, str]</span>
<span class=sd>        Tile index or tile id.</span>
<span class=sd>    round : Optional[Union[int, str]]</span>
<span class=sd>        Round index or round id.</span>
<span class=sd>    bit : Optional[Union[int, str]]</span>
<span class=sd>        Bit index or bit id.</span>

<span class=sd>    Returns</span>
<span class=sd>    -------</span>
<span class=sd>    wavelengths_um : Optional[tuple[float, float]]</span>
<span class=sd>        Wavelengths for fidicual OR readout bit for one tile.</span>
<span class=sd>    &quot;&quot;&quot;</span>

    <span class=k>if</span> <span class=p>(</span><span class=nb>round</span> <span class=ow>is</span> <span class=kc>None</span> <span class=ow>and</span> <span class=n>bit</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>)</span> <span class=ow>or</span> <span class=p>(</span><span class=nb>round</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span> <span class=ow>and</span> <span class=n>bit</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>):</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Provide either &#39;round&#39; or &#39;bit&#39;, but not both&quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>None</span>

    <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
        <span class=k>if</span> <span class=n>tile</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>tile</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set tile index &gt;=0 and &lt;=&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_num_tiles</span><span class=p>))</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>tile_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>[</span><span class=n>tile</span><span class=p>]</span>
    <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tile</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
        <span class=k>if</span> <span class=n>tile</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tile_ids</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;set valid tiled id&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>tile_id</span> <span class=o>=</span> <span class=n>tile</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;tile&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>None</span>

    <span class=k>if</span> <span class=n>bit</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>bit</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
            <span class=k>if</span> <span class=n>bit</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>bit</span> <span class=o>&gt;</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>):</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set bit index &gt;=0 and &lt;=&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>)))</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>local_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>[</span><span class=n>bit</span><span class=p>]</span>
        <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>bit</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
            <span class=k>if</span> <span class=n>bit</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_bit_ids</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set valid bit id&quot;</span><span class=p>)</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>local_id</span> <span class=o>=</span> <span class=n>bit</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;bit&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=n>zattrs_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_readouts_root_path</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>local_id</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;.zattrs&quot;</span><span class=p>)</span>
        <span class=p>)</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=nb>round</span><span class=p>,</span> <span class=nb>int</span><span class=p>):</span>
            <span class=k>if</span> <span class=nb>round</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set round index &gt;=0 and &lt;&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_num_rounds</span><span class=p>))</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>local_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_round_ids</span><span class=p>[</span><span class=nb>round</span><span class=p>]</span>
        <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=nb>round</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
            <span class=k>if</span> <span class=nb>round</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_round_ids</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Set valid round id&quot;</span><span class=p>)</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>local_id</span> <span class=o>=</span> <span class=nb>round</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;&#39;round&#39; must be integer index or string identifier&quot;</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=n>zattrs_path</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_polyDT_root_path</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>tile_id</span><span class=p>)</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=n>local_id</span> <span class=o>+</span> <span class=s2>&quot;.zarr&quot;</span><span class=p>)</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;.zattrs&quot;</span><span class=p>)</span>
        <span class=p>)</span>

    <span class=k>try</span><span class=p>:</span>
        <span class=n>attributes</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_from_json</span><span class=p>(</span><span class=n>zattrs_path</span><span class=p>)</span>
        <span class=n>attributes</span><span class=p>[</span><span class=s2>&quot;excitation_um&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=nb>float</span><span class=p>(</span><span class=n>wavelengths_um</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
        <span class=n>attributes</span><span class=p>[</span><span class=s2>&quot;emission_um&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=nb>float</span><span class=p>(</span><span class=n>wavelengths_um</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_save_to_json</span><span class=p>(</span><span class=n>attributes</span><span class=p>,</span> <span class=n>zattrs_path</span><span class=p>)</span>
    <span class=k>except</span> <span class=p>(</span><span class=ne>FileNotFoundError</span><span class=p>,</span> <span class=n>json</span><span class=o>.</span><span class=n>JSONDecodeError</span><span class=p>):</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Error writing wavelength attributes.&quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>None</span>
</code></pre></div></td></tr></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id=merfish3danalysis.qi2labDataStore.qi2labDataStore.save_mtx class="doc doc-heading"> <code class="highlight language-python"><span class=n>save_mtx</span><span class=p>(</span><span class=n>spots_source</span><span class=o>=</span><span class=s1>&#39;&#39;</span><span class=p>)</span></code> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.save_mtx class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-contents "> <p>Save mtx file for downstream analysis. Assumes Baysor has been run.</p> <p><span class=doc-section-title>Parameters:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> <th>Default</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td> <code>spots_source</code> </td> <td> <code>str</code> </td> <td> <div class=doc-md-description> <p>source of spots. "baysor" or "resegmented".</p> </div> </td> <td> <code>&#39;&#39;</code> </td> </tr> </tbody> </table> <details class=quote> <summary>Source code in <code>src/merfish3danalysis/qi2labDataStore.py</code></summary> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>4184</span>
<span class=normal>4185</span>
<span class=normal>4186</span>
<span class=normal>4187</span>
<span class=normal>4188</span>
<span class=normal>4189</span>
<span class=normal>4190</span>
<span class=normal>4191</span>
<span class=normal>4192</span>
<span class=normal>4193</span>
<span class=normal>4194</span>
<span class=normal>4195</span>
<span class=normal>4196</span>
<span class=normal>4197</span>
<span class=normal>4198</span>
<span class=normal>4199</span>
<span class=normal>4200</span>
<span class=normal>4201</span>
<span class=normal>4202</span>
<span class=normal>4203</span>
<span class=normal>4204</span>
<span class=normal>4205</span>
<span class=normal>4206</span>
<span class=normal>4207</span>
<span class=normal>4208</span>
<span class=normal>4209</span></pre></div></td><td class=code><div><pre><span></span><code><span class=k>def</span> <span class=nf>save_mtx</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>spots_source</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s2>&quot;&quot;</span><span class=p>):</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Save mtx file for downstream analysis. Assumes Baysor has been run.</span>

<span class=sd>    Parameters</span>
<span class=sd>    ----------</span>
<span class=sd>    spots_source: str, default &quot;baysor&quot;</span>
<span class=sd>        source of spots. &quot;baysor&quot; or &quot;resegmented&quot;.</span>
<span class=sd>    &quot;&quot;&quot;</span>

    <span class=kn>from</span> <span class=nn>merfish3danalysis.utils.dataio</span> <span class=kn>import</span> <span class=n>create_mtx</span>

    <span class=k>if</span> <span class=n>spots_source</span> <span class=o>==</span> <span class=s2>&quot;baysor&quot;</span><span class=p>:</span>
        <span class=n>spots_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;segmentation&quot;</span><span class=p>)</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;baysor&quot;</span><span class=p>)</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;segmentation.csv&quot;</span><span class=p>)</span>
    <span class=k>elif</span> <span class=n>spots_source</span> <span class=o>==</span> <span class=s2>&quot;resegmented&quot;</span><span class=p>:</span>
        <span class=n>spots_path</span> <span class=o>=</span> <span class=p>(</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_path</span> 
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;all_tiles_filtered_decoded_features&quot;</span><span class=p>)</span>
            <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;refined_transcripts.parquet&quot;</span><span class=p>)</span>
        <span class=p>)</span>

    <span class=n>mtx_output_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;mtx_output&quot;</span><span class=p>)</span>

    <span class=n>create_mtx</span><span class=p>(</span>
        <span class=n>spots_path</span><span class=o>=</span><span class=n>spots_path</span><span class=p>,</span>
        <span class=n>output_dir_path</span><span class=o>=</span><span class=n>mtx_output_path</span><span class=p>,</span>
    <span class=p>)</span>
</code></pre></div></td></tr></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id=merfish3danalysis.qi2labDataStore.qi2labDataStore.save_spots_prepped_for_baysor class="doc doc-heading"> <code class="highlight language-python"><span class=n>save_spots_prepped_for_baysor</span><span class=p>(</span><span class=n>prepped_for_baysor_df</span><span class=p>)</span></code> <a href=#merfish3danalysis.qi2labDataStore.qi2labDataStore.save_spots_prepped_for_baysor class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-contents "> <p>Save spots prepped for Baysor.</p> <p><span class=doc-section-title>Parameters:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> <th>Default</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td> <code>prepped_for_baysor_df</code> </td> <td> <code><span title="pandas.DataFrame">DataFrame</span></code> </td> <td> <div class=doc-md-description> <p>Spots prepped for Baysor.</p> </div> </td> <td> <em>required</em> </td> </tr> </tbody> </table> <details class=quote> <summary>Source code in <code>src/merfish3danalysis/qi2labDataStore.py</code></summary> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>3922</span>
<span class=normal>3923</span>
<span class=normal>3924</span>
<span class=normal>3925</span>
<span class=normal>3926</span>
<span class=normal>3927</span>
<span class=normal>3928</span>
<span class=normal>3929</span>
<span class=normal>3930</span>
<span class=normal>3931</span>
<span class=normal>3932</span>
<span class=normal>3933</span>
<span class=normal>3934</span>
<span class=normal>3935</span>
<span class=normal>3936</span>
<span class=normal>3937</span>
<span class=normal>3938</span>
<span class=normal>3939</span>
<span class=normal>3940</span>
<span class=normal>3941</span>
<span class=normal>3942</span></pre></div></td><td class=code><div><pre><span></span><code><span class=k>def</span> <span class=nf>save_spots_prepped_for_baysor</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>prepped_for_baysor_df</span><span class=p>:</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>):</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Save spots prepped for Baysor.</span>

<span class=sd>    Parameters</span>
<span class=sd>    ----------</span>
<span class=sd>    prepped_for_baysor_df : pd.DataFrame</span>
<span class=sd>        Spots prepped for Baysor.</span>
<span class=sd>    &quot;&quot;&quot;</span>

    <span class=n>current_global_filtered_decoded_dir_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_datastore_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span>
        <span class=s2>&quot;all_tiles_filtered_decoded_features&quot;</span>
    <span class=p>)</span>

    <span class=k>if</span> <span class=ow>not</span> <span class=n>current_global_filtered_decoded_dir_path</span><span class=o>.</span><span class=n>exists</span><span class=p>():</span>
        <span class=n>current_global_filtered_decoded_dir_path</span><span class=o>.</span><span class=n>mkdir</span><span class=p>()</span>

    <span class=n>current_global_filtered_decoded_path</span> <span class=o>=</span> <span class=p>(</span>
        <span class=n>current_global_filtered_decoded_dir_path</span> <span class=o>/</span> <span class=n>Path</span><span class=p>(</span><span class=s2>&quot;transcripts.parquet&quot;</span><span class=p>)</span>
    <span class=p>)</span>

    <span class=bp>self</span><span class=o>.</span><span class=n>_save_to_parquet</span><span class=p>(</span><span class=n>prepped_for_baysor_df</span><span class=p>,</span> <span class=n>current_global_filtered_decoded_path</span><span class=p>)</span>
</code></pre></div></td></tr></table></div> </details> </div> </div> </div> </div> </div> </div> </div> </div> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../../..", "features": [], "search": "../../../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script> <script src=../../../assets/javascripts/bundle.88dd0f4e.min.js></script> </body> </html>