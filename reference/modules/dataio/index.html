<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="GPU-accelerated 2D/3D MERFISH data processing"><meta name=author content="Quantitative Imaging and Inference Lab"><link href=https://qi2lab.github.io/merfish3d-analysis/reference/modules/dataio/ rel=canonical><link href=../../classes/qi2labDataStore/ rel=prev><link href=../imageprocessing/ rel=next><link rel=icon href=../../../assets/images/favicon.png><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.5.49"><title>dataio - merfish3d-analysis</title><link rel=stylesheet href=../../../assets/stylesheets/main.6f8fc17f.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../../assets/_mkdocstrings.css><script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#data-io-module class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--shadow" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../../.. title=merfish3d-analysis class="md-header__button md-logo" aria-label=merfish3d-analysis data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> merfish3d-analysis </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> dataio </span> </div> </div> </div> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../.. title=merfish3d-analysis class="md-nav__button md-logo" aria-label=merfish3d-analysis data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg> </a> merfish3d-analysis </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../.. class=md-nav__link> <span class=md-ellipsis> Home </span> </a> </li> <li class=md-nav__item> <a href=../../../installation/ class=md-nav__link> <span class=md-ellipsis> Installation </span> </a> </li> <li class=md-nav__item> <a href=../../../datastore/ class=md-nav__link> <span class=md-ellipsis> DataStore </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4> <label class=md-nav__link for=__nav_4 id=__nav_4_label tabindex=0> <span class=md-ellipsis> Examples </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=false> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Examples </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../examples/statphysbio_synthetic/ class=md-nav__link> <span class=md-ellipsis> Synthetic data </span> </a> </li> <li class=md-nav__item> <a href=../../../examples/zhuang_lab_mouse_brain/ class=md-nav__link> <span class=md-ellipsis> Zhuang laboratory mouse brain </span> </a> </li> <li class=md-nav__item> <a href=../../../examples/qi2lab_human_olfactory_bulb/ class=md-nav__link> <span class=md-ellipsis> qi2lab human olfactory bulb </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5 checked> <label class=md-nav__link for=__nav_5 id=__nav_5_label tabindex=0> <span class=md-ellipsis> Reference </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_5_label aria-expanded=true> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> Reference </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../ class=md-nav__link> <span class=md-ellipsis> Overview </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5_2> <label class=md-nav__link for=__nav_5_2 id=__nav_5_2_label tabindex=0> <span class=md-ellipsis> Classes </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_2_label aria-expanded=false> <label class=md-nav__title for=__nav_5_2> <span class="md-nav__icon md-icon"></span> Classes </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../classes/DataRegistration/ class=md-nav__link> <span class=md-ellipsis> DataRegistration </span> </a> </li> <li class=md-nav__item> <a href=../../classes/PixelDecoder/ class=md-nav__link> <span class=md-ellipsis> PixelDecoder </span> </a> </li> <li class=md-nav__item> <a href=../../classes/qi2labDataStore/ class=md-nav__link> <span class=md-ellipsis> qi2labDataStore </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5_3 checked> <label class=md-nav__link for=__nav_5_3 id=__nav_5_3_label tabindex=0> <span class=md-ellipsis> Modules </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_3_label aria-expanded=true> <label class=md-nav__title for=__nav_5_3> <span class="md-nav__icon md-icon"></span> Modules </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> dataio </span> <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> dataio </span> </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#merfish3danalysis.utils.dataio class=md-nav__link> <span class=md-ellipsis> dataio </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.utils.dataio.create_mtx class=md-nav__link> <span class=md-ellipsis> create_mtx </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.utils.dataio.read_config_file class=md-nav__link> <span class=md-ellipsis> read_config_file </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.utils.dataio.read_fluidics_program class=md-nav__link> <span class=md-ellipsis> read_fluidics_program </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.utils.dataio.read_metadatafile class=md-nav__link> <span class=md-ellipsis> read_metadatafile </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.utils.dataio.return_data_zarr class=md-nav__link> <span class=md-ellipsis> return_data_zarr </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.utils.dataio.time_stamp class=md-nav__link> <span class=md-ellipsis> time_stamp </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.utils.dataio.write_metadata class=md-nav__link> <span class=md-ellipsis> write_metadata </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.utils.dataio.write_sparse_mtx class=md-nav__link> <span class=md-ellipsis> write_sparse_mtx </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.utils.dataio.write_tsv class=md-nav__link> <span class=md-ellipsis> write_tsv </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../imageprocessing/ class=md-nav__link> <span class=md-ellipsis> imageprocessing </span> </a> </li> <li class=md-nav__item> <a href=../registration/ class=md-nav__link> <span class=md-ellipsis> registration </span> </a> </li> <li class=md-nav__item> <a href=../opmtools/ class=md-nav__link> <span class=md-ellipsis> opmtools </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../../contributing/ class=md-nav__link> <span class=md-ellipsis> Contributing </span> </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#merfish3danalysis.utils.dataio class=md-nav__link> <span class=md-ellipsis> dataio </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.utils.dataio.create_mtx class=md-nav__link> <span class=md-ellipsis> create_mtx </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.utils.dataio.read_config_file class=md-nav__link> <span class=md-ellipsis> read_config_file </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.utils.dataio.read_fluidics_program class=md-nav__link> <span class=md-ellipsis> read_fluidics_program </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.utils.dataio.read_metadatafile class=md-nav__link> <span class=md-ellipsis> read_metadatafile </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.utils.dataio.return_data_zarr class=md-nav__link> <span class=md-ellipsis> return_data_zarr </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.utils.dataio.time_stamp class=md-nav__link> <span class=md-ellipsis> time_stamp </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.utils.dataio.write_metadata class=md-nav__link> <span class=md-ellipsis> write_metadata </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.utils.dataio.write_sparse_mtx class=md-nav__link> <span class=md-ellipsis> write_sparse_mtx </span> </a> </li> <li class=md-nav__item> <a href=#merfish3danalysis.utils.dataio.write_tsv class=md-nav__link> <span class=md-ellipsis> write_tsv </span> </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=data-io-module>Data I/O Module<a class=headerlink href=#data-io-module title="Permanent link">&para;</a></h1> <div class="doc doc-object doc-module"> <a id=merfish3danalysis.utils.dataio></a> <div class="doc doc-contents first"> <p>Data I/O functions for qi2lab 3D MERFISH.</p> <p>This module provides utilities for reading and writing data in various formats used by qi2lab 3D MERFISH datasets.</p> <details class=history: open> <summary>History:</summary> <ul> <li><strong>2024/12</strong>: Refactored repo structure.</li> <li><strong>2024/12</strong>: Updated docstrings.</li> <li><strong>2024/07</strong>: Removed native NDTiff reading package; integrated tifffile/zarr. Reduced dask dependencies.</li> </ul> </details> <div class="doc doc-children"> <div class="doc doc-object doc-function"> <h2 id=merfish3danalysis.utils.dataio.create_mtx class="doc doc-heading"> <code class="highlight language-python"><span class=n>create_mtx</span><span class=p>(</span><span class=n>spots_path</span><span class=p>,</span> <span class=n>output_dir_path</span><span class=p>,</span> <span class=n>confidence_cutoff</span><span class=o>=</span><span class=mf>0.7</span><span class=p>)</span></code> <a href=#merfish3danalysis.utils.dataio.create_mtx class=headerlink title="Permanent link">&para;</a></h2> <div class="doc doc-contents "> <p>Create a sparse matrix in MTX format from Baysor output.</p> <p><span class=doc-section-title>Parameters:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> <th>Default</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td> <code>spots_path</code> </td> <td> <code><span title="typing.Union">Union</span>[<span title="pathlib.Path">Path</span>, str]</code> </td> <td> <div class=doc-md-description> <p>Path to spots file</p> </div> </td> <td> <em>required</em> </td> </tr> <tr class=doc-section-item> <td> <code>output_dir_path</code> </td> <td> <code><span title="typing.Union">Union</span>[<span title="pathlib.Path">Path</span>, str]</code> </td> <td> <div class=doc-md-description> <p>Path to output directory</p> </div> </td> <td> <em>required</em> </td> </tr> <tr class=doc-section-item> <td> <code>confidence_cutoff</code> </td> <td> <code>float</code> </td> <td> <div class=doc-md-description> <p>Confidence cutoff for transcript assignment</p> </div> </td> <td> <code>0.7</code> </td> </tr> </tbody> </table> <details class=quote> <summary>Source code in <code>src/merfish3danalysis/utils/dataio.py</code></summary> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>178</span>
<span class=normal>179</span>
<span class=normal>180</span>
<span class=normal>181</span>
<span class=normal>182</span>
<span class=normal>183</span>
<span class=normal>184</span>
<span class=normal>185</span>
<span class=normal>186</span>
<span class=normal>187</span>
<span class=normal>188</span>
<span class=normal>189</span>
<span class=normal>190</span>
<span class=normal>191</span>
<span class=normal>192</span>
<span class=normal>193</span>
<span class=normal>194</span>
<span class=normal>195</span>
<span class=normal>196</span>
<span class=normal>197</span>
<span class=normal>198</span>
<span class=normal>199</span>
<span class=normal>200</span>
<span class=normal>201</span>
<span class=normal>202</span>
<span class=normal>203</span>
<span class=normal>204</span>
<span class=normal>205</span>
<span class=normal>206</span>
<span class=normal>207</span>
<span class=normal>208</span>
<span class=normal>209</span>
<span class=normal>210</span>
<span class=normal>211</span>
<span class=normal>212</span>
<span class=normal>213</span>
<span class=normal>214</span>
<span class=normal>215</span>
<span class=normal>216</span>
<span class=normal>217</span>
<span class=normal>218</span>
<span class=normal>219</span>
<span class=normal>220</span>
<span class=normal>221</span>
<span class=normal>222</span>
<span class=normal>223</span>
<span class=normal>224</span>
<span class=normal>225</span>
<span class=normal>226</span>
<span class=normal>227</span>
<span class=normal>228</span>
<span class=normal>229</span>
<span class=normal>230</span>
<span class=normal>231</span>
<span class=normal>232</span>
<span class=normal>233</span>
<span class=normal>234</span>
<span class=normal>235</span>
<span class=normal>236</span>
<span class=normal>237</span>
<span class=normal>238</span>
<span class=normal>239</span>
<span class=normal>240</span>
<span class=normal>241</span>
<span class=normal>242</span></pre></div></td><td class=code><div><pre><span></span><code><span class=k>def</span> <span class=nf>create_mtx</span><span class=p>(</span>
    <span class=n>spots_path</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=n>Path</span><span class=p>,</span><span class=nb>str</span><span class=p>],</span> 
    <span class=n>output_dir_path</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=n>Path</span><span class=p>,</span><span class=nb>str</span><span class=p>],</span> 
    <span class=n>confidence_cutoff</span><span class=p>:</span> <span class=nb>float</span> <span class=o>=</span> <span class=mf>0.7</span>
<span class=p>):</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Create a sparse matrix in MTX format from Baysor output.</span>

<span class=sd>    Parameters</span>
<span class=sd>    ----------</span>
<span class=sd>    spots_path: Union[Path,str]</span>
<span class=sd>        Path to spots file</span>
<span class=sd>    output_dir_path: Union[Path,str]</span>
<span class=sd>        Path to output directory</span>
<span class=sd>    confidence_cutoff: float</span>
<span class=sd>        Confidence cutoff for transcript assignment</span>
<span class=sd>    &quot;&quot;&quot;</span>

    <span class=c1># Read 5 columns from transcripts Parquet file</span>
    <span class=k>if</span> <span class=n>spots_path</span><span class=o>.</span><span class=n>suffix</span> <span class=o>==</span> <span class=s2>&quot;.csv&quot;</span><span class=p>:</span>
        <span class=n>transcripts_df</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>read_csv</span><span class=p>(</span><span class=n>spots_path</span><span class=p>,</span>
                                    <span class=n>usecols</span><span class=o>=</span><span class=p>[</span><span class=s2>&quot;gene&quot;</span><span class=p>,</span>
                                            <span class=s2>&quot;cell&quot;</span><span class=p>,</span>
                                            <span class=s2>&quot;assignment_confidence&quot;</span><span class=p>])</span>
        <span class=n>transcripts_df</span><span class=p>[</span><span class=s1>&#39;cell&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>transcripts_df</span><span class=p>[</span><span class=s1>&#39;cell&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=n>pd</span><span class=o>.</span><span class=n>NA</span><span class=p>)</span><span class=o>.</span><span class=n>dropna</span><span class=p>()</span><span class=o>.</span><span class=n>str</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;-&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>str</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=n>transcripts_df</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>read_parquet</span><span class=p>(</span><span class=n>spots_path</span><span class=p>,</span>
                            <span class=n>columns</span><span class=o>=</span><span class=p>[</span><span class=s2>&quot;gene&quot;</span><span class=p>,</span>
                                    <span class=s2>&quot;cell&quot;</span><span class=p>,</span>
                                    <span class=s2>&quot;assignment_confidence&quot;</span><span class=p>])</span>


    <span class=n>transcripts_df</span><span class=p>[</span><span class=s1>&#39;cell&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>to_numeric</span><span class=p>(</span><span class=n>transcripts_df</span><span class=p>[</span><span class=s1>&#39;cell&#39;</span><span class=p>],</span> <span class=n>errors</span><span class=o>=</span><span class=s1>&#39;coerce&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>fillna</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=nb>int</span><span class=p>)</span>

    <span class=c1># Find distinct set of features.</span>
    <span class=n>features</span> <span class=o>=</span> <span class=n>transcripts_df</span><span class=p>[</span><span class=s2>&quot;gene&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>dropna</span><span class=p>()</span><span class=o>.</span><span class=n>unique</span><span class=p>()</span>

    <span class=c1># Create lookup dictionary</span>
    <span class=n>feature_to_index</span> <span class=o>=</span> <span class=nb>dict</span><span class=p>()</span>
    <span class=k>for</span> <span class=n>index</span><span class=p>,</span> <span class=n>val</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>features</span><span class=p>):</span>
        <span class=n>feature_to_index</span><span class=p>[</span><span class=nb>str</span><span class=p>(</span><span class=n>val</span><span class=p>)]</span> <span class=o>=</span> <span class=n>index</span>

    <span class=c1># Find distinct set of cells. Discard the first entry which is 0 (non-cell)</span>
    <span class=n>cells</span> <span class=o>=</span> <span class=n>transcripts_df</span><span class=p>[</span><span class=s2>&quot;cell&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>dropna</span><span class=p>()</span><span class=o>.</span><span class=n>unique</span><span class=p>()</span>
    <span class=n>cells</span> <span class=o>=</span> <span class=n>cells</span><span class=p>[</span><span class=n>cells</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>]</span>

    <span class=c1># Create a cells x features data frame, initialized with 0</span>
    <span class=n>matrix</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>index</span><span class=o>=</span><span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>features</span><span class=p>)),</span> <span class=n>columns</span><span class=o>=</span><span class=n>cells</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>int32</span><span class=p>)</span>

    <span class=c1># Iterate through all transcripts</span>
    <span class=k>for</span> <span class=n>index</span><span class=p>,</span> <span class=n>row</span> <span class=ow>in</span> <span class=n>transcripts_df</span><span class=o>.</span><span class=n>iterrows</span><span class=p>():</span>
        <span class=n>feature</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span><span class=n>row</span><span class=p>[</span><span class=s1>&#39;gene&#39;</span><span class=p>])</span>
        <span class=n>cell</span> <span class=o>=</span> <span class=n>row</span><span class=p>[</span><span class=s1>&#39;cell&#39;</span><span class=p>]</span>
        <span class=n>conf</span> <span class=o>=</span> <span class=n>row</span><span class=p>[</span><span class=s1>&#39;assignment_confidence&#39;</span><span class=p>]</span>

        <span class=c1># Ignore transcript below user-specified cutoff</span>
        <span class=k>if</span> <span class=n>conf</span> <span class=o>&lt;</span> <span class=n>confidence_cutoff</span><span class=p>:</span>
            <span class=k>continue</span>

        <span class=c1># If cell is not 0 at this point, it means the transcript is associated with a cell</span>
        <span class=k>if</span> <span class=n>cell</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>:</span>
            <span class=c1># Increment count in feature-cell matrix</span>
            <span class=n>matrix</span><span class=o>.</span><span class=n>at</span><span class=p>[</span><span class=n>feature_to_index</span><span class=p>[</span><span class=n>feature</span><span class=p>],</span> <span class=n>cell</span><span class=p>]</span> <span class=o>+=</span> <span class=mi>1</span>

    <span class=c1># Call a helper function to create Seurat and Scanpy compatible MTX output</span>
    <span class=n>write_sparse_mtx</span><span class=p>(</span><span class=n>output_dir_path</span><span class=p>,</span> <span class=n>matrix</span><span class=p>,</span> <span class=n>cells</span><span class=p>,</span> <span class=n>features</span><span class=p>)</span>
</code></pre></div></td></tr></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h2 id=merfish3danalysis.utils.dataio.read_config_file class="doc doc-heading"> <code class="highlight language-python"><span class=n>read_config_file</span><span class=p>(</span><span class=n>config_path</span><span class=p>)</span></code> <a href=#merfish3danalysis.utils.dataio.read_config_file class=headerlink title="Permanent link">&para;</a></h2> <div class="doc doc-contents "> <p>Read config data from csv file. </p> <p><span class=doc-section-title>Parameters:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> <th>Default</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td> <code>config_path</code> </td> <td> <code><span title="typing.Union">Union</span>[<span title="pathlib.Path">Path</span>, str]</code> </td> <td> <div class=doc-md-description> <p>Location of configuration file</p> </div> </td> <td> <em>required</em> </td> </tr> </tbody> </table> <p><span class=doc-section-title>Returns:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td><code>dict_from_csv</code></td> <td> <code>dict</code> </td> <td> <div class=doc-md-description> <p>instrument configuration metadata</p> </div> </td> </tr> </tbody> </table> <details class=quote> <summary>Source code in <code>src/merfish3danalysis/utils/dataio.py</code></summary> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>74</span>
<span class=normal>75</span>
<span class=normal>76</span>
<span class=normal>77</span>
<span class=normal>78</span>
<span class=normal>79</span>
<span class=normal>80</span>
<span class=normal>81</span>
<span class=normal>82</span>
<span class=normal>83</span>
<span class=normal>84</span>
<span class=normal>85</span>
<span class=normal>86</span>
<span class=normal>87</span>
<span class=normal>88</span>
<span class=normal>89</span>
<span class=normal>90</span></pre></div></td><td class=code><div><pre><span></span><code><span class=k>def</span> <span class=nf>read_config_file</span><span class=p>(</span><span class=n>config_path</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=n>Path</span><span class=p>,</span><span class=nb>str</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=nb>dict</span><span class=p>:</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Read config data from csv file. </span>

<span class=sd>    Parameters</span>
<span class=sd>    ----------</span>
<span class=sd>    config_path: Path</span>
<span class=sd>        Location of configuration file</span>

<span class=sd>    Returns</span>
<span class=sd>    -------</span>
<span class=sd>    dict_from_csv: dict</span>
<span class=sd>        instrument configuration metadata</span>
<span class=sd>    &quot;&quot;&quot;</span>

    <span class=n>dict_from_csv</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>read_csv</span><span class=p>(</span><span class=n>config_path</span><span class=p>,</span> <span class=n>header</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>index_col</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span><span class=o>.</span><span class=n>squeeze</span><span class=p>(</span><span class=s2>&quot;columns&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>to_dict</span><span class=p>()</span>

    <span class=k>return</span> <span class=n>dict_from_csv</span>
</code></pre></div></td></tr></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h2 id=merfish3danalysis.utils.dataio.read_fluidics_program class="doc doc-heading"> <code class="highlight language-python"><span class=n>read_fluidics_program</span><span class=p>(</span><span class=n>program_path</span><span class=p>)</span></code> <a href=#merfish3danalysis.utils.dataio.read_fluidics_program class=headerlink title="Permanent link">&para;</a></h2> <div class="doc doc-contents "> <p>Read fluidics program from CSV file as pandas dataframe.</p> <p><span class=doc-section-title>Parameters:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> <th>Default</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td> <code>program_path</code> </td> <td> <code><span title="typing.Union">Union</span>[<span title="pathlib.Path">Path</span>, str]</code> </td> <td> <div class=doc-md-description> <p>location of fluidics program</p> </div> </td> <td> <em>required</em> </td> </tr> </tbody> </table> <p><span class=doc-section-title>Returns:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td><code>df_fluidics</code></td> <td> <code>Dataframe</code> </td> <td> <div class=doc-md-description> <p>dataframe containing fluidics program</p> </div> </td> </tr> </tbody> </table> <details class=quote> <summary>Source code in <code>src/merfish3danalysis/utils/dataio.py</code></summary> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 92</span>
<span class=normal> 93</span>
<span class=normal> 94</span>
<span class=normal> 95</span>
<span class=normal> 96</span>
<span class=normal> 97</span>
<span class=normal> 98</span>
<span class=normal> 99</span>
<span class=normal>100</span>
<span class=normal>101</span>
<span class=normal>102</span>
<span class=normal>103</span>
<span class=normal>104</span>
<span class=normal>105</span>
<span class=normal>106</span>
<span class=normal>107</span>
<span class=normal>108</span>
<span class=normal>109</span>
<span class=normal>110</span>
<span class=normal>111</span>
<span class=normal>112</span>
<span class=normal>113</span>
<span class=normal>114</span>
<span class=normal>115</span>
<span class=normal>116</span>
<span class=normal>117</span></pre></div></td><td class=code><div><pre><span></span><code><span class=k>def</span> <span class=nf>read_fluidics_program</span><span class=p>(</span><span class=n>program_path</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=n>Path</span><span class=p>,</span><span class=nb>str</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>:</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Read fluidics program from CSV file as pandas dataframe.</span>

<span class=sd>    Parameters</span>
<span class=sd>    ----------</span>
<span class=sd>    program_path: Path</span>
<span class=sd>        location of fluidics program</span>

<span class=sd>    Returns</span>
<span class=sd>    -------</span>
<span class=sd>    df_fluidics: Dataframe</span>
<span class=sd>        dataframe containing fluidics program </span>
<span class=sd>    &quot;&quot;&quot;</span>

    <span class=k>try</span><span class=p>:</span>                
        <span class=n>df_fluidics</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>read_csv</span><span class=p>(</span><span class=n>program_path</span><span class=p>)</span>            
        <span class=n>df_fluidics</span> <span class=o>=</span> <span class=n>df_fluidics</span><span class=p>[[</span><span class=s2>&quot;round&quot;</span><span class=p>,</span> <span class=s2>&quot;source&quot;</span><span class=p>,</span> <span class=s2>&quot;time&quot;</span><span class=p>,</span> <span class=s2>&quot;pump&quot;</span><span class=p>]]</span>
        <span class=n>df_fluidics</span><span class=o>.</span><span class=n>dropna</span><span class=p>(</span><span class=n>axis</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span> <span class=n>how</span><span class=o>=</span><span class=s1>&#39;any&#39;</span><span class=p>,</span> <span class=n>inplace</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
        <span class=n>df_fluidics</span><span class=p>[</span><span class=s2>&quot;round&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>df_fluidics</span><span class=p>[</span><span class=s2>&quot;round&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=nb>int</span><span class=p>)</span>
        <span class=n>df_fluidics</span><span class=p>[</span><span class=s2>&quot;pump&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>df_fluidics</span><span class=p>[</span><span class=s2>&quot;pump&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=nb>int</span><span class=p>)</span>

        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Fluidics program loaded&quot;</span><span class=p>)</span>
    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
        <span class=k>raise</span> <span class=ne>Exception</span><span class=p>(</span><span class=s2>&quot;Error in loading fluidics file:</span><span class=se>\n</span><span class=s2>&quot;</span><span class=p>,</span> <span class=n>e</span><span class=p>)</span>

    <span class=k>return</span> <span class=n>df_fluidics</span>
</code></pre></div></td></tr></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h2 id=merfish3danalysis.utils.dataio.read_metadatafile class="doc doc-heading"> <code class="highlight language-python"><span class=n>read_metadatafile</span><span class=p>(</span><span class=n>fname</span><span class=p>)</span></code> <a href=#merfish3danalysis.utils.dataio.read_metadatafile class=headerlink title="Permanent link">&para;</a></h2> <div class="doc doc-contents "> <p>Read metadata from csv file. </p> <p><span class=doc-section-title>Parameters:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> <th>Default</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td> <code>fname</code> </td> <td> <code><span title="typing.Union">Union</span>[str, <span title="pathlib.Path">Path</span>]</code> </td> <td> <div class=doc-md-description> <p>filename</p> </div> </td> <td> <em>required</em> </td> </tr> </tbody> </table> <p><span class=doc-section-title>Returns:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td><code>metadata</code></td> <td> <code>Dict</code> </td> <td> <div class=doc-md-description> <p>metadata dictionary</p> </div> </td> </tr> </tbody> </table> <details class=quote> <summary>Source code in <code>src/merfish3danalysis/utils/dataio.py</code></summary> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>30</span>
<span class=normal>31</span>
<span class=normal>32</span>
<span class=normal>33</span>
<span class=normal>34</span>
<span class=normal>35</span>
<span class=normal>36</span>
<span class=normal>37</span>
<span class=normal>38</span>
<span class=normal>39</span>
<span class=normal>40</span>
<span class=normal>41</span>
<span class=normal>42</span>
<span class=normal>43</span>
<span class=normal>44</span>
<span class=normal>45</span>
<span class=normal>46</span>
<span class=normal>47</span>
<span class=normal>48</span>
<span class=normal>49</span>
<span class=normal>50</span>
<span class=normal>51</span>
<span class=normal>52</span>
<span class=normal>53</span>
<span class=normal>54</span>
<span class=normal>55</span>
<span class=normal>56</span>
<span class=normal>57</span>
<span class=normal>58</span>
<span class=normal>59</span>
<span class=normal>60</span>
<span class=normal>61</span>
<span class=normal>62</span>
<span class=normal>63</span>
<span class=normal>64</span>
<span class=normal>65</span>
<span class=normal>66</span>
<span class=normal>67</span>
<span class=normal>68</span>
<span class=normal>69</span>
<span class=normal>70</span>
<span class=normal>71</span>
<span class=normal>72</span></pre></div></td><td class=code><div><pre><span></span><code><span class=k>def</span> <span class=nf>read_metadatafile</span><span class=p>(</span><span class=n>fname</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span><span class=n>Path</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=nb>dict</span><span class=p>:</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Read metadata from csv file. </span>

<span class=sd>    Parameters</span>
<span class=sd>    ----------</span>
<span class=sd>    fname: Union[str,Path]</span>
<span class=sd>        filename</span>

<span class=sd>    Returns</span>
<span class=sd>    -------</span>
<span class=sd>    metadata: Dict</span>
<span class=sd>        metadata dictionary</span>
<span class=sd>    &quot;&quot;&quot;</span>

    <span class=n>scan_data_raw_lines</span> <span class=o>=</span> <span class=p>[]</span>

    <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>fname</span><span class=p>,</span> <span class=s2>&quot;r&quot;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
        <span class=k>for</span> <span class=n>line</span> <span class=ow>in</span> <span class=n>f</span><span class=p>:</span>
            <span class=n>scan_data_raw_lines</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>line</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>&quot;</span><span class=p>,</span> <span class=s2>&quot;&quot;</span><span class=p>))</span>

    <span class=n>titles</span> <span class=o>=</span> <span class=n>scan_data_raw_lines</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&quot;,&quot;</span><span class=p>)</span>

    <span class=c1># convert values to appropriate datatypes</span>
    <span class=n>vals</span> <span class=o>=</span> <span class=n>scan_data_raw_lines</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&quot;,&quot;</span><span class=p>)</span>
    <span class=k>for</span> <span class=n>ii</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>vals</span><span class=p>)):</span>
        <span class=k>if</span> <span class=n>re</span><span class=o>.</span><span class=n>fullmatch</span><span class=p>(</span><span class=sa>r</span><span class=s2>&quot;\d+&quot;</span><span class=p>,</span> <span class=n>vals</span><span class=p>[</span><span class=n>ii</span><span class=p>]):</span>
            <span class=n>vals</span><span class=p>[</span><span class=n>ii</span><span class=p>]</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>vals</span><span class=p>[</span><span class=n>ii</span><span class=p>])</span>
        <span class=k>elif</span> <span class=n>re</span><span class=o>.</span><span class=n>fullmatch</span><span class=p>(</span><span class=sa>r</span><span class=s2>&quot;\d*.\d+&quot;</span><span class=p>,</span> <span class=n>vals</span><span class=p>[</span><span class=n>ii</span><span class=p>]):</span>
            <span class=n>vals</span><span class=p>[</span><span class=n>ii</span><span class=p>]</span> <span class=o>=</span> <span class=nb>float</span><span class=p>(</span><span class=n>vals</span><span class=p>[</span><span class=n>ii</span><span class=p>])</span>
        <span class=k>elif</span> <span class=n>vals</span><span class=p>[</span><span class=n>ii</span><span class=p>]</span><span class=o>.</span><span class=n>lower</span><span class=p>()</span> <span class=o>==</span> <span class=s2>&quot;False&quot;</span><span class=o>.</span><span class=n>lower</span><span class=p>():</span>
            <span class=n>vals</span><span class=p>[</span><span class=n>ii</span><span class=p>]</span> <span class=o>=</span> <span class=kc>False</span>
        <span class=k>elif</span> <span class=n>vals</span><span class=p>[</span><span class=n>ii</span><span class=p>]</span><span class=o>.</span><span class=n>lower</span><span class=p>()</span> <span class=o>==</span> <span class=s2>&quot;True&quot;</span><span class=o>.</span><span class=n>lower</span><span class=p>():</span>
            <span class=n>vals</span><span class=p>[</span><span class=n>ii</span><span class=p>]</span> <span class=o>=</span> <span class=kc>True</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=c1># otherwise, leave as string</span>
            <span class=k>pass</span>

    <span class=c1># convert to dictionary</span>
    <span class=n>metadata</span> <span class=o>=</span> <span class=p>{}</span>
    <span class=k>for</span> <span class=n>t</span><span class=p>,</span> <span class=n>v</span> <span class=ow>in</span> <span class=nb>zip</span><span class=p>(</span><span class=n>titles</span><span class=p>,</span> <span class=n>vals</span><span class=p>):</span>
        <span class=n>metadata</span><span class=p>[</span><span class=n>t</span><span class=p>]</span> <span class=o>=</span> <span class=n>v</span>

    <span class=k>return</span> <span class=n>metadata</span>
</code></pre></div></td></tr></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h2 id=merfish3danalysis.utils.dataio.return_data_zarr class="doc doc-heading"> <code class="highlight language-python"><span class=n>return_data_zarr</span><span class=p>(</span><span class=n>dataset_path</span><span class=p>,</span> <span class=n>ch_idx</span><span class=p>,</span> <span class=n>ch_idx_offset</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span></code> <a href=#merfish3danalysis.utils.dataio.return_data_zarr class=headerlink title="Permanent link">&para;</a></h2> <div class="doc doc-contents "> <p>Return NDTIFF data as a numpy array via tiffile.</p> <p><span class=doc-section-title>Parameters:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> <th>Default</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td> <code>dataset_path</code> </td> <td> <code><span title="typing.Union">Union</span>[<span title="pathlib.Path">Path</span>, str]</code> </td> <td> <div class=doc-md-description> <p>pycromanager dataset object</p> </div> </td> <td> <em>required</em> </td> </tr> <tr class=doc-section-item> <td> <code>ch_idx</code> </td> <td> <code>int</code> </td> <td> <div class=doc-md-description> <p>channel index in ZarrTiffStore file</p> </div> </td> <td> <em>required</em> </td> </tr> <tr class=doc-section-item> <td> <code>ch_idx_offset</code> </td> <td> <code><span title="typing.Optional">Optional</span>[int]</code> </td> <td> <div class=doc-md-description> <p>channel index offset for unused phase channels</p> </div> </td> <td> <code>0</code> </td> </tr> </tbody> </table> <p><span class=doc-section-title>Returns:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td><code>data</code></td> <td> <code><span title="numpy.typing.ArrayLike">ArrayLike</span></code> </td> <td> <div class=doc-md-description> <p>data stack</p> </div> </td> </tr> </tbody> </table> <details class=quote> <summary>Source code in <code>src/merfish3danalysis/utils/dataio.py</code></summary> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>135</span>
<span class=normal>136</span>
<span class=normal>137</span>
<span class=normal>138</span>
<span class=normal>139</span>
<span class=normal>140</span>
<span class=normal>141</span>
<span class=normal>142</span>
<span class=normal>143</span>
<span class=normal>144</span>
<span class=normal>145</span>
<span class=normal>146</span>
<span class=normal>147</span>
<span class=normal>148</span>
<span class=normal>149</span>
<span class=normal>150</span>
<span class=normal>151</span>
<span class=normal>152</span>
<span class=normal>153</span>
<span class=normal>154</span>
<span class=normal>155</span>
<span class=normal>156</span>
<span class=normal>157</span>
<span class=normal>158</span>
<span class=normal>159</span>
<span class=normal>160</span>
<span class=normal>161</span>
<span class=normal>162</span>
<span class=normal>163</span>
<span class=normal>164</span>
<span class=normal>165</span></pre></div></td><td class=code><div><pre><span></span><code><span class=k>def</span> <span class=nf>return_data_zarr</span><span class=p>(</span><span class=n>dataset_path</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=n>Path</span><span class=p>,</span><span class=nb>str</span><span class=p>],</span>
                     <span class=n>ch_idx</span> <span class=p>:</span> <span class=nb>int</span><span class=p>,</span>
                     <span class=n>ch_idx_offset</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>int</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>ArrayLike</span><span class=p>:</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Return NDTIFF data as a numpy array via tiffile.</span>

<span class=sd>    Parameters</span>
<span class=sd>    ----------</span>
<span class=sd>    dataset_path: Dataset</span>
<span class=sd>        pycromanager dataset object</span>
<span class=sd>    ch_idx: int</span>
<span class=sd>        channel index in ZarrTiffStore file</span>
<span class=sd>    ch_idx_offset: int</span>
<span class=sd>        channel index offset for unused phase channels</span>

<span class=sd>    Returns</span>
<span class=sd>    -------</span>
<span class=sd>    data: ArrayLike</span>
<span class=sd>        data stack</span>
<span class=sd>    &quot;&quot;&quot;</span>

    <span class=n>ndtiff_zarr_store</span> <span class=o>=</span> <span class=n>imread</span><span class=p>(</span><span class=n>dataset_path</span><span class=p>,</span> <span class=n>mode</span><span class=o>=</span><span class=s1>&#39;r+&#39;</span><span class=p>,</span> <span class=n>aszarr</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
    <span class=n>ndtiff_zarr</span> <span class=o>=</span> <span class=n>zarr</span><span class=o>.</span><span class=n>open</span><span class=p>(</span><span class=n>ndtiff_zarr_store</span><span class=p>,</span> <span class=n>mode</span><span class=o>=</span><span class=s1>&#39;r+&#39;</span><span class=p>)</span>
    <span class=n>first_dim</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span><span class=n>ndtiff_zarr</span><span class=o>.</span><span class=n>attrs</span><span class=p>[</span><span class=s1>&#39;_ARRAY_DIMENSIONS&#39;</span><span class=p>][</span><span class=mi>0</span><span class=p>])</span>

    <span class=k>if</span> <span class=n>first_dim</span> <span class=o>==</span> <span class=s1>&#39;C&#39;</span><span class=p>:</span>
        <span class=n>data</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>asarray</span><span class=p>(</span><span class=n>ndtiff_zarr</span><span class=p>[</span><span class=n>ch_idx</span><span class=o>-</span><span class=n>ch_idx_offset</span><span class=p>,</span> <span class=p>:],</span><span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>uint16</span><span class=p>)</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=n>data</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>asarray</span><span class=p>(</span><span class=n>ndtiff_zarr</span><span class=p>[:,</span><span class=n>ch_idx</span><span class=o>-</span><span class=n>ch_idx_offset</span><span class=p>,:],</span><span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>uint16</span><span class=p>)</span>
    <span class=k>del</span> <span class=n>ndtiff_zarr_store</span><span class=p>,</span> <span class=n>ndtiff_zarr</span>

    <span class=k>return</span> <span class=n>np</span><span class=o>.</span><span class=n>squeeze</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</code></pre></div></td></tr></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h2 id=merfish3danalysis.utils.dataio.time_stamp class="doc doc-heading"> <code class="highlight language-python"><span class=n>time_stamp</span><span class=p>()</span></code> <a href=#merfish3danalysis.utils.dataio.time_stamp class=headerlink title="Permanent link">&para;</a></h2> <div class="doc doc-contents "> <p>Generate timestamp string.</p> <p><span class=doc-section-title>Returns:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td><code>timestamp</code></td> <td> <code>str</code> </td> <td> <div class=doc-md-description> <p>timestamp formatted as string</p> </div> </td> </tr> </tbody> </table> <details class=quote> <summary>Source code in <code>src/merfish3danalysis/utils/dataio.py</code></summary> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>167</span>
<span class=normal>168</span>
<span class=normal>169</span>
<span class=normal>170</span>
<span class=normal>171</span>
<span class=normal>172</span>
<span class=normal>173</span>
<span class=normal>174</span>
<span class=normal>175</span>
<span class=normal>176</span></pre></div></td><td class=code><div><pre><span></span><code><span class=k>def</span> <span class=nf>time_stamp</span><span class=p>():</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Generate timestamp string.</span>

<span class=sd>    Returns</span>
<span class=sd>    -------</span>
<span class=sd>    timestamp: str</span>
<span class=sd>        timestamp formatted as string</span>
<span class=sd>    &quot;&quot;&quot;</span>

    <span class=k>return</span> <span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>()</span><span class=o>.</span><span class=n>strftime</span><span class=p>(</span><span class=s2>&quot;%Y-%m-</span><span class=si>%d</span><span class=s2> %H:%M:%S&quot;</span><span class=p>)</span>
</code></pre></div></td></tr></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h2 id=merfish3danalysis.utils.dataio.write_metadata class="doc doc-heading"> <code class="highlight language-python"><span class=n>write_metadata</span><span class=p>(</span><span class=n>data_dict</span><span class=p>,</span> <span class=n>save_path</span><span class=p>)</span></code> <a href=#merfish3danalysis.utils.dataio.write_metadata class=headerlink title="Permanent link">&para;</a></h2> <div class="doc doc-contents "> <p>Write dictionary as CSV file.</p> <p><span class=doc-section-title>Parameters:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> <th>Default</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td> <code>data_dict</code> </td> <td> <code>dict</code> </td> <td> <div class=doc-md-description> <p>metadata dictionary</p> </div> </td> <td> <em>required</em> </td> </tr> <tr class=doc-section-item> <td> <code>save_path</code> </td> <td> <code><span title="typing.Union">Union</span>[str, <span title="pathlib.Path">Path</span>]</code> </td> <td> <div class=doc-md-description> <p>path for file</p> </div> </td> <td> <em>required</em> </td> </tr> </tbody> </table> <details class=quote> <summary>Source code in <code>src/merfish3danalysis/utils/dataio.py</code></summary> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>119</span>
<span class=normal>120</span>
<span class=normal>121</span>
<span class=normal>122</span>
<span class=normal>123</span>
<span class=normal>124</span>
<span class=normal>125</span>
<span class=normal>126</span>
<span class=normal>127</span>
<span class=normal>128</span>
<span class=normal>129</span>
<span class=normal>130</span>
<span class=normal>131</span>
<span class=normal>132</span>
<span class=normal>133</span></pre></div></td><td class=code><div><pre><span></span><code><span class=k>def</span> <span class=nf>write_metadata</span><span class=p>(</span>
    <span class=n>data_dict</span><span class=p>:</span> <span class=nb>dict</span><span class=p>,</span> 
    <span class=n>save_path</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span><span class=n>Path</span><span class=p>]</span>
<span class=p>):</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Write dictionary as CSV file.</span>

<span class=sd>    Parameters</span>
<span class=sd>    ----------</span>
<span class=sd>    data_dict: dict</span>
<span class=sd>        metadata dictionary</span>
<span class=sd>    save_path: Union[str,Path]</span>
<span class=sd>        path for file</span>
<span class=sd>    &quot;&quot;&quot;</span>

    <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>([</span><span class=n>data_dict</span><span class=p>])</span><span class=o>.</span><span class=n>to_csv</span><span class=p>(</span><span class=n>save_path</span><span class=p>)</span>
</code></pre></div></td></tr></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h2 id=merfish3danalysis.utils.dataio.write_sparse_mtx class="doc doc-heading"> <code class="highlight language-python"><span class=n>write_sparse_mtx</span><span class=p>(</span><span class=n>output_dir_path</span><span class=p>,</span> <span class=n>matrix</span><span class=p>,</span> <span class=n>cells</span><span class=p>,</span> <span class=n>features</span><span class=p>)</span></code> <a href=#merfish3danalysis.utils.dataio.write_sparse_mtx class=headerlink title="Permanent link">&para;</a></h2> <div class="doc doc-contents "> <p>Write sparse matrix in MTX format.</p> <p><span class=doc-section-title>Parameters:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> <th>Default</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td> <code>output_dir_path</code> </td> <td> <code><span title="typing.Union">Union</span>[<span title="pathlib.Path">Path</span>, str]</code> </td> <td> <div class=doc-md-description> <p>Path to output directory</p> </div> </td> <td> <em>required</em> </td> </tr> <tr class=doc-section-item> <td> <code>matrix</code> </td> <td> <code><span title="numpy.typing.ArrayLike">ArrayLike</span></code> </td> <td> <div class=doc-md-description> <p>Sparse matrix</p> </div> </td> <td> <em>required</em> </td> </tr> <tr class=doc-section-item> <td> <code>cells</code> </td> <td> <code><span title="typing.Sequence">Sequence</span>[str]</code> </td> <td> <div class=doc-md-description> <p>Cell names</p> </div> </td> <td> <em>required</em> </td> </tr> <tr class=doc-section-item> <td> <code>features</code> </td> <td> <code><span title="typing.Sequence">Sequence</span>[str]</code> </td> <td> <div class=doc-md-description> <p>Feature names</p> </div> </td> <td> <em>required</em> </td> </tr> </tbody> </table> <details class=quote> <summary>Source code in <code>src/merfish3danalysis/utils/dataio.py</code></summary> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>244</span>
<span class=normal>245</span>
<span class=normal>246</span>
<span class=normal>247</span>
<span class=normal>248</span>
<span class=normal>249</span>
<span class=normal>250</span>
<span class=normal>251</span>
<span class=normal>252</span>
<span class=normal>253</span>
<span class=normal>254</span>
<span class=normal>255</span>
<span class=normal>256</span>
<span class=normal>257</span>
<span class=normal>258</span>
<span class=normal>259</span>
<span class=normal>260</span>
<span class=normal>261</span>
<span class=normal>262</span>
<span class=normal>263</span>
<span class=normal>264</span>
<span class=normal>265</span>
<span class=normal>266</span></pre></div></td><td class=code><div><pre><span></span><code><span class=k>def</span> <span class=nf>write_sparse_mtx</span><span class=p>(</span><span class=n>output_dir_path</span> <span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=n>Path</span><span class=p>,</span><span class=nb>str</span><span class=p>],</span> 
                     <span class=n>matrix</span><span class=p>:</span> <span class=n>ArrayLike</span><span class=p>,</span> 
                     <span class=n>cells</span><span class=p>:</span> <span class=n>Sequence</span><span class=p>[</span><span class=nb>str</span><span class=p>],</span> 
                     <span class=n>features</span><span class=p>:</span> <span class=n>Sequence</span><span class=p>[</span><span class=nb>str</span><span class=p>]):</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Write sparse matrix in MTX format.</span>

<span class=sd>    Parameters</span>
<span class=sd>    ----------</span>
<span class=sd>    output_dir_path: Union[Path,str]</span>
<span class=sd>        Path to output directory</span>
<span class=sd>    matrix: ArrayLike</span>
<span class=sd>        Sparse matrix</span>
<span class=sd>    cells: Sequence[str]</span>
<span class=sd>        Cell names</span>
<span class=sd>    features: Sequence[str]</span>
<span class=sd>        Feature names</span>
<span class=sd>    &quot;&quot;&quot;</span>

    <span class=n>sparse_mat</span> <span class=o>=</span> <span class=n>sparse</span><span class=o>.</span><span class=n>coo_matrix</span><span class=p>(</span><span class=n>matrix</span><span class=o>.</span><span class=n>values</span><span class=p>)</span>
    <span class=n>sio</span><span class=o>.</span><span class=n>mmwrite</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>output_dir_path</span> <span class=o>/</span> <span class=s2>&quot;matrix.mtx&quot;</span><span class=p>),</span> <span class=n>sparse_mat</span><span class=p>)</span>
    <span class=n>write_tsv</span><span class=p>(</span><span class=n>output_dir_path</span> <span class=o>/</span> <span class=s2>&quot;barcodes.tsv&quot;</span><span class=p>,</span> <span class=p>[</span><span class=s2>&quot;cell_&quot;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=n>cell</span><span class=p>)</span> <span class=k>for</span> <span class=n>cell</span> <span class=ow>in</span> <span class=n>cells</span><span class=p>])</span>
    <span class=n>write_tsv</span><span class=p>(</span><span class=n>output_dir_path</span> <span class=o>/</span> <span class=s2>&quot;features.tsv&quot;</span><span class=p>,</span> <span class=p>[[</span><span class=nb>str</span><span class=p>(</span><span class=n>f</span><span class=p>),</span> <span class=nb>str</span><span class=p>(</span><span class=n>f</span><span class=p>),</span> <span class=s2>&quot;Blank Codeword&quot;</span> <span class=k>if</span> <span class=nb>str</span><span class=p>(</span><span class=n>f</span><span class=p>)</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s2>&quot;Blank&quot;</span><span class=p>)</span> <span class=k>else</span> <span class=s2>&quot;Gene Expression&quot;</span><span class=p>]</span> <span class=k>for</span> <span class=n>f</span> <span class=ow>in</span> <span class=n>features</span><span class=p>])</span>
    <span class=n>subprocess</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;gzip -f </span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>output_dir_path</span><span class=p>)</span><span class=si>}</span><span class=s2>/*&quot;</span><span class=p>,</span> <span class=n>shell</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</code></pre></div></td></tr></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h2 id=merfish3danalysis.utils.dataio.write_tsv class="doc doc-heading"> <code class="highlight language-python"><span class=n>write_tsv</span><span class=p>(</span><span class=n>filename</span><span class=p>,</span> <span class=n>data</span><span class=p>)</span></code> <a href=#merfish3danalysis.utils.dataio.write_tsv class=headerlink title="Permanent link">&para;</a></h2> <div class="doc doc-contents "> <p>Write data to TSV file.</p> <p><span class=doc-section-title>Parameters:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> <th>Default</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td> <code>filename</code> </td> <td> <code><span title="typing.Union">Union</span>[str, <span title="pathlib.Path">Path</span>]</code> </td> <td> <div class=doc-md-description> <p>Filename</p> </div> </td> <td> <em>required</em> </td> </tr> <tr class=doc-section-item> <td> <code>data</code> </td> <td> <code><span title="typing.Sequence">Sequence</span>[<span title="typing.Union">Union</span>[str, <span title="typing.Sequence">Sequence</span>[str]]]</code> </td> <td> <div class=doc-md-description> <p>Data to write</p> </div> </td> <td> <em>required</em> </td> </tr> </tbody> </table> <details class=quote> <summary>Source code in <code>src/merfish3danalysis/utils/dataio.py</code></summary> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>268</span>
<span class=normal>269</span>
<span class=normal>270</span>
<span class=normal>271</span>
<span class=normal>272</span>
<span class=normal>273</span>
<span class=normal>274</span>
<span class=normal>275</span>
<span class=normal>276</span>
<span class=normal>277</span>
<span class=normal>278</span>
<span class=normal>279</span>
<span class=normal>280</span>
<span class=normal>281</span>
<span class=normal>282</span>
<span class=normal>283</span>
<span class=normal>284</span>
<span class=normal>285</span></pre></div></td><td class=code><div><pre><span></span><code><span class=k>def</span> <span class=nf>write_tsv</span><span class=p>(</span>
    <span class=n>filename</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Path</span><span class=p>],</span> 
    <span class=n>data</span><span class=p>:</span> <span class=n>Sequence</span><span class=p>[</span><span class=n>Union</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Sequence</span><span class=p>[</span><span class=nb>str</span><span class=p>]]]</span>
<span class=p>):</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Write data to TSV file.</span>

<span class=sd>    Parameters</span>
<span class=sd>    ----------</span>
<span class=sd>    filename: Union[str, Path]</span>
<span class=sd>        Filename</span>
<span class=sd>    data: Sequence[Union[str, Sequence[str]]]</span>
<span class=sd>        Data to write</span>
<span class=sd>    &quot;&quot;&quot;</span>

    <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>filename</span><span class=p>,</span> <span class=s1>&#39;w&#39;</span><span class=p>,</span> <span class=n>newline</span><span class=o>=</span><span class=s1>&#39;&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>tsvfile</span><span class=p>:</span>
        <span class=n>writer</span> <span class=o>=</span> <span class=n>csv</span><span class=o>.</span><span class=n>writer</span><span class=p>(</span><span class=n>tsvfile</span><span class=p>,</span> <span class=n>delimiter</span><span class=o>=</span><span class=s1>&#39;</span><span class=se>\t</span><span class=s1>&#39;</span><span class=p>,</span> <span class=n>lineterminator</span><span class=o>=</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>
        <span class=k>for</span> <span class=n>item</span> <span class=ow>in</span> <span class=n>data</span><span class=p>:</span>
            <span class=n>writer</span><span class=o>.</span><span class=n>writerow</span><span class=p>([</span><span class=n>item</span><span class=p>]</span> <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>item</span><span class=p>,</span> <span class=nb>str</span><span class=p>)</span> <span class=k>else</span> <span class=n>item</span><span class=p>)</span>
</code></pre></div></td></tr></table></div> </details> </div> </div> </div> </div> </div> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../../..", "features": [], "search": "../../../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script> <script src=../../../assets/javascripts/bundle.88dd0f4e.min.js></script> </body> </html>