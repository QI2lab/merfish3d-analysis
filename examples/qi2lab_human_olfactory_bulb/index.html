<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="GPU-accelerated 2D/3D MERFISH data processing"><meta name=author content="Quantitative Imaging and Inference Lab"><link href=https://qi2lab.github.io/merfish3d-analysis/examples/qi2lab_human_olfactory_bulb/ rel=canonical><link href=../zhuang_lab_mouse_brain/ rel=prev><link href=../../reference/ rel=next><link rel=icon href=../../assets/images/favicon.png><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.5.49"><title>qi2lab human olfactory bulb - merfish3d-analysis</title><link rel=stylesheet href=../../assets/stylesheets/main.6f8fc17f.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../assets/_mkdocstrings.css><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#qi2lab-human-olfactory-bubl-example class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--shadow" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../.. title=merfish3d-analysis class="md-header__button md-logo" aria-label=merfish3d-analysis data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> merfish3d-analysis </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> qi2lab human olfactory bulb </span> </div> </div> </div> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../.. title=merfish3d-analysis class="md-nav__button md-logo" aria-label=merfish3d-analysis data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg> </a> merfish3d-analysis </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. class=md-nav__link> <span class=md-ellipsis> Home </span> </a> </li> <li class=md-nav__item> <a href=../../installation/ class=md-nav__link> <span class=md-ellipsis> Installation </span> </a> </li> <li class=md-nav__item> <a href=../../datastore/ class=md-nav__link> <span class=md-ellipsis> DataStore </span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4 checked> <label class=md-nav__link for=__nav_4 id=__nav_4_label tabindex=0> <span class=md-ellipsis> Examples </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=true> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Examples </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../statphysbio_synthetic/ class=md-nav__link> <span class=md-ellipsis> Synthetic data </span> </a> </li> <li class=md-nav__item> <a href=../zhuang_lab_mouse_brain/ class=md-nav__link> <span class=md-ellipsis> Zhuang laboratory mouse brain </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> qi2lab human olfactory bulb </span> <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> qi2lab human olfactory bulb </span> </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#overview class=md-nav__link> <span class=md-ellipsis> Overview </span> </a> </li> <li class=md-nav__item> <a href=#preliminaries class=md-nav__link> <span class=md-ellipsis> Preliminaries </span> </a> </li> <li class=md-nav__item> <a href=#downloaded-data class=md-nav__link> <span class=md-ellipsis> Downloaded data </span> </a> </li> <li class=md-nav__item> <a href=#processing-steps class=md-nav__link> <span class=md-ellipsis> Processing steps </span> </a> </li> <li class=md-nav__item> <a href=#ensuring-a-sucessful-run class=md-nav__link> <span class=md-ellipsis> Ensuring a sucessful run </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5> <label class=md-nav__link for=__nav_5 id=__nav_5_label tabindex=0> <span class=md-ellipsis> Reference </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_5_label aria-expanded=false> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> Reference </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../reference/ class=md-nav__link> <span class=md-ellipsis> Overview </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5_2> <label class=md-nav__link for=__nav_5_2 id=__nav_5_2_label tabindex=0> <span class=md-ellipsis> Classes </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_2_label aria-expanded=false> <label class=md-nav__title for=__nav_5_2> <span class="md-nav__icon md-icon"></span> Classes </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../reference/classes/DataRegistration/ class=md-nav__link> <span class=md-ellipsis> DataRegistration </span> </a> </li> <li class=md-nav__item> <a href=../../reference/classes/PixelDecoder/ class=md-nav__link> <span class=md-ellipsis> PixelDecoder </span> </a> </li> <li class=md-nav__item> <a href=../../reference/classes/qi2labDataStore/ class=md-nav__link> <span class=md-ellipsis> qi2labDataStore </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5_3> <label class=md-nav__link for=__nav_5_3 id=__nav_5_3_label tabindex=0> <span class=md-ellipsis> Modules </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_5_3_label aria-expanded=false> <label class=md-nav__title for=__nav_5_3> <span class="md-nav__icon md-icon"></span> Modules </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../reference/modules/dataio/ class=md-nav__link> <span class=md-ellipsis> dataio </span> </a> </li> <li class=md-nav__item> <a href=../../reference/modules/imageprocessing/ class=md-nav__link> <span class=md-ellipsis> imageprocessing </span> </a> </li> <li class=md-nav__item> <a href=../../reference/modules/registration/ class=md-nav__link> <span class=md-ellipsis> registration </span> </a> </li> <li class=md-nav__item> <a href=../../reference/modules/opmtools/ class=md-nav__link> <span class=md-ellipsis> opmtools </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../contributing/ class=md-nav__link> <span class=md-ellipsis> Contributing </span> </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#overview class=md-nav__link> <span class=md-ellipsis> Overview </span> </a> </li> <li class=md-nav__item> <a href=#preliminaries class=md-nav__link> <span class=md-ellipsis> Preliminaries </span> </a> </li> <li class=md-nav__item> <a href=#downloaded-data class=md-nav__link> <span class=md-ellipsis> Downloaded data </span> </a> </li> <li class=md-nav__item> <a href=#processing-steps class=md-nav__link> <span class=md-ellipsis> Processing steps </span> </a> </li> <li class=md-nav__item> <a href=#ensuring-a-sucessful-run class=md-nav__link> <span class=md-ellipsis> Ensuring a sucessful run </span> </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=qi2lab-human-olfactory-bubl-example>qi2lab human olfactory bubl example<a class=headerlink href=#qi2lab-human-olfactory-bubl-example title="Permanent link">&para;</a></h1> <h2 id=overview>Overview<a class=headerlink href=#overview title="Permanent link">&para;</a></h2> <p>The goal of this example is to retrieve a 3D MERFISH experiment generate by the qi2lab at ASU from the Brain Image Library and run merfish3d-analysis through quantifying transcripts and assigning transcripts to cells. This is a 119-gene MERFISH and 2-gene smFISH experiment on post-mortem human olfactory bulb tissue.</p> <h2 id=preliminaries>Preliminaries<a class=headerlink href=#preliminaries title="Permanent link">&para;</a></h2> <p>You need to make sure you have a working python enviornment with <code>merfish3d-analysis</code> properly installed, <code>Baysor</code> properly installed, and our human olfactory bulb 3D MERFISH dataset downloaded. The dataset is ~800 GB and you will need roughly another 800 GB of temporary space to create the <code>qi2labDataStore</code> structure we use to perform tile registration, global registration, segmentation, pixel decoding, filtering, and cell assignment.</p> <ul> <li><a href=https://www.github.com/qi2lab/merfish3d-analysis>merfish3d-analysis</a></li> <li><a href=https://github.com/kharchenkolab/Baysor>Baysor</a></li> <li><a href=https://www.bil.com>Raw 3D MERFISH data</a></li> </ul> <h2 id=downloaded-data>Downloaded data<a class=headerlink href=#downloaded-data title="Permanent link">&para;</a></h2> <p>All of the required code to process this data is in the BIL download. There should be three top-level directories in the downloaded folder, <code>raw_data</code>, <code>processing_code</code>, and <code>results</code>. The directory structure is as follows:</p> <p>/ ├── raw_data/ │ ├── data_r0001_tile000_xyz/ │ ├── data_r0001_tile000_xyz.csv | ... | ... │ ├── data_r0009_tile041_xyz/ │ ├── data_r0009_tile041_xyz.csv │ ├── codebook.csv │ ├── bit_order.csv │ ├── hot_pixel_flir.tiff │ └── scan_metadata.csv ├── processing_code/ │ ├── 00_readme.txt │ └── 01_convert_to_datastore.py │ └── 02_register_and_deconvolve.py │ └── 03_cellpose_segmentation.py │ └── 04_pixeldecode_and_baysor.py │ └── qi2lab_humanOB.toml └── results/ │ └── transcripts.parquet │ └── cell_outlines.gzip │ |── mtx/ | │ └── .gzip | │ └── .gzip | │ └── .gzip</p> <h2 id=processing-steps>Processing steps<a class=headerlink href=#processing-steps title="Permanent link">&para;</a></h2> <p>For each of the python files in the <code>processing_code</code> directory, you will need to scroll to the bottom and replace the path with the correct path. For example, in <code>01_convert_to_datastore.py</code> you'll want to change this section:</p> <pre><code class=language-python>if __name__ == &quot;__main__&quot;:
    root_path = Path(r&quot;/path/to/download/raw_data&quot;)
    baysor_binary_path = Path(
        r&quot;/path/to/Baysor/bin/baysor/bin/./baysor&quot;
    )
    baysor_options_path = Path(
        r&quot;/path/to/download/processing_code/qi2lab_humanOB.toml&quot;
    )
    julia_threads = 20 # replace with number of threads to use.

    hot_pixel_image_path = Path(r&quot;/path/to/download/raw_data/flir_hot_pixel_image.tif&quot;)

    convert_data(
        root_path=root_path,
        baysor_binary_path=baysor_binary_path,
        baysor_options_path=baysor_options_path,
        julia_threads=julia_threads,
        hot_pixel_image_path=hot_pixel_image_path
    )
</code></pre> <p>For all of the files in <code>processing_code</code>, you'll set the <code>root_path</code> to <code>root_path = Path(r"/path/to/download/raw_data")</code>. The package automatically places the datastore within that directory.</p> <p>Once that is done, you can run <code>01_convert_to_datastore.py</code> and <code>02_register_and_deconolve.py</code> without any interactions. Depending on your computing hardware, you should expect 1-2 hours for <code>01_convert_to_datastore.py</code> and a couple days for <code>02_register_and_deconolve.py</code>. The second file is compute intensive, because it deconvolves 3 channel z-stacks at each tile over 9 hours, runs <a href=https://github.com/UFISH-Team/U-FISH>U-FISH</a> for 2 MERFISH (or smFISH) channel at each tile, performs a rigid, affine, and optical flow field registration across imaging rounds, and globally registers the fidicual channel.</p> <p>Once <code>02_register_and_deconolve.py</code> is finished, you will need to create the correct cellpose settings. We have found that initially peforming cellpose segmentation on a downsampled and maximum Z projected polyDT image is sufficient to seed Baysor for segmentation refinement.</p> <p>If the standard "cyto3" model does not work for you data, you may need to retrain the cellpose model according the cellpose documentation and pass that to the code. Please see the API documentation for how to perform that step. Given satisfactory cellpose settings, you fill them in at the bottom of <code>03_cell_segmentation.py</code>,</p> <pre><code class=language-python>if __name__ == &quot;__main__&quot;:
    root_path = Path(r&quot;/path/to/download/raw_data&quot;)
    cellpose_parameters = {
        'normalization' : [0.5,95.0],
        'blur_kernel_size' : 2.0,
        'flow_threshold' : 0.4,
        'cellprob_threshold' : 0.0,
        'diameter': 36.57
    }
    run_cellpose(root_path, cellpose_parameters)
</code></pre> <p>and then run <code>03_cell_segmentation.py</code>. This will only take a few minutes to generate the initial 2D segmentation guess.</p> <p>Next, you'll run <code>04_pixeldecode_and_baysor.py</code> to first optimize the pixel-based decoding parameters on a subset of tiles, then perform pixel-based decoding for all tiles, filter the data to limit false positives, remove overlapping spots in adajacent spatial tiles, and finally re-segment the cell boundaries in 3D using Baysor. This step should again take ~1 day, depending on your hard disk and GPU configuration.</p> <p>For this dataset, we labeled a number of olfactory receptors. We exclude these genes during Baysor segmentation, because they are not highly informative on cell boundaries. Once Baysor has finished, the filtered transcripts are parsed again to assign the excluded olfactory receptors to the new 3D cell boundaries.</p> <h2 id=ensuring-a-sucessful-run>Ensuring a sucessful run<a class=headerlink href=#ensuring-a-sucessful-run title="Permanent link">&para;</a></h2> <p>We have included the proper output of the <code>merfish3d-analysis</code> package for this dataset on the BIL servers in the <code>results</code> directory. You should be able to compare your obtained results to ours to ensure that there were no computation errors. One common issue we have run into is if the optical flow registration fails due to processor specific instructions (specifically older processors that lack AVX2). Please contact us if you have this issue, we have a workaround during installation that we can provide to you. </p> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script> <script src=../../assets/javascripts/bundle.88dd0f4e.min.js></script> </body> </html>